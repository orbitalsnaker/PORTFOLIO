<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ORACULVM EX MACHINA · PANTEÓN TERMO-SEMIÓTICO</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Hebrew:wght@300;400;700&family=IM+Fell+English:ital@0;1&family=Share+Tech+Mono&family=Cinzel:wght@400;600;900&display=swap');

:root {
  --void: #020307;
  --void2: #050810;
  --deep: #08101c;
  --gold: #b8960c;
  --gold2: #e0c040;
  --gold3: #f5e070;
  --silver: #8090a0;
  --quantum: #204060;
  --quantum2: #3060a0;
  --quantum3: #40c0ff;
  --neural: #602080;
  --neural2: #a040e0;
  --emerald: #106030;
  --emerald2: #20c060;
  --danger: #801010;
  --danger2: #e02020;
  --text: #c0b898;
  --text2: #7a6e58;
  --text3: #3a3428;
  --hebrew: #d0c0a0;
  --glow-gold: 0 0 20px rgba(184,150,12,0.4);
  --glow-quantum: 0 0 20px rgba(64,192,255,0.3);
  --glow-neural: 0 0 20px rgba(160,64,224,0.3);
}

*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

html { font-size: 14px; }
body {
  background: var(--void);
  color: var(--text);
  font-family: 'IM Fell English', serif;
  overflow: hidden;
  width: 100vw; height: 100vh;
  cursor: none;
  user-select: none;
}

/* ══ CURSOR ══ */
#cur {
  position:fixed; z-index:9999; pointer-events:none;
  width:24px; height:24px;
  transform:translate(-50%,-50%);
  transition: width .1s, height .1s;
}
#cur svg { width:100%; height:100%; }
#cur.active { width:40px; height:40px; }

/* ══ CANVASES ══ */
#bgCanvas, #particleCanvas, #networkCanvas {
  position:fixed; top:0; left:0; width:100%; height:100%;
}
#bgCanvas { z-index:1; }
#networkCanvas { z-index:2; }
#particleCanvas { z-index:3; }

/* ══ UI LAYER ══ */
#ui { position:fixed; top:0; left:0; width:100%; height:100%; z-index:10; pointer-events:none; }

/* ══ HEADER ══ */
#hdr {
  position:absolute; top:0; left:0; right:0;
  padding:18px 0 0;
  text-align:center;
  background: linear-gradient(to bottom, rgba(2,3,7,0.97) 60%, transparent);
}
#mainTitle {
  font-family:'Cinzel',serif;
  font-size: clamp(16px, 3.5vw, 38px);
  font-weight:900;
  letter-spacing:.35em;
  color: var(--gold2);
  text-shadow: 0 0 40px rgba(224,192,64,0.5), 0 0 80px rgba(224,192,64,0.2);
  animation: titleBreath 5s ease-in-out infinite;
}
@keyframes titleBreath {
  0%,100% { text-shadow: 0 0 40px rgba(224,192,64,.5), 0 0 80px rgba(224,192,64,.2); }
  50%     { text-shadow: 0 0 60px rgba(224,192,64,.8), 0 0 120px rgba(224,192,64,.4), 0 0 200px rgba(224,192,64,.1); }
}
#subTitle {
  font-family:'IM Fell English',serif;
  font-style:italic;
  font-size: clamp(9px,1.4vw,13px);
  color: var(--text2);
  letter-spacing:.4em;
  margin-top:4px;
}
#subtitle2 {
  font-family:'Share Tech Mono',monospace;
  font-size: clamp(7px,1vw,10px);
  color: var(--text3);
  letter-spacing:.3em;
  margin-top:3px;
}

/* ══ LEFT PANEL — Alphabeto Hebreo ══ */
#hebrewPanel {
  position:absolute; left:0; top:90px; bottom:90px;
  width:72px;
  background: linear-gradient(to right, rgba(2,3,7,.98), rgba(5,8,16,.7));
  border-right:1px solid rgba(184,150,12,.12);
  overflow-y:auto; overflow-x:hidden;
  scrollbar-width:none;
  pointer-events:all;
  display:flex; flex-direction:column; gap:2px;
  padding:8px 4px;
}
#hebrewPanel::-webkit-scrollbar { display:none; }
.hb-btn {
  width:62px; height:48px;
  border:1px solid rgba(184,150,12,.15);
  background: rgba(184,150,12,.02);
  border-radius:3px;
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  cursor:none; transition:all .25s;
  flex-shrink:0;
}
.hb-btn .hb-letter {
  font-family:'Noto Sans Hebrew',sans-serif;
  font-size:20px; color: var(--hebrew);
  line-height:1;
}
.hb-btn .hb-name {
  font-family:'Share Tech Mono',monospace;
  font-size:6px; color: var(--text3);
  letter-spacing:.05em; margin-top:1px;
}
.hb-btn .hb-op {
  font-family:'Share Tech Mono',monospace;
  font-size:6px; color: #204060;
  letter-spacing:.03em;
}
.hb-btn:hover, .hb-btn.active {
  border-color: var(--gold);
  background: rgba(184,150,12,.08);
  box-shadow: var(--glow-gold);
}
.hb-btn:hover .hb-letter, .hb-btn.active .hb-letter { color: var(--gold3); }
.hb-btn:hover .hb-op, .hb-btn.active .hb-op { color: var(--quantum3); }

/* ══ RIGHT PANEL — Architectures ══ */
#archPanel {
  position:absolute; right:0; top:90px; bottom:90px;
  width:80px;
  background: linear-gradient(to left, rgba(2,3,7,.98), rgba(5,8,16,.7));
  border-left:1px solid rgba(64,192,255,.1);
  pointer-events:all;
  display:flex; flex-direction:column; gap:3px;
  padding:8px 4px;
  overflow-y:auto; overflow-x:hidden;
  scrollbar-width:none;
}
#archPanel::-webkit-scrollbar { display:none; }
.arch-btn {
  width:70px; height:44px;
  border:1px solid rgba(64,192,255,.12);
  background: rgba(64,192,255,.02);
  border-radius:2px;
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  cursor:none; transition:all .3s;
  flex-shrink:0;
}
.arch-btn .arch-label {
  font-family:'Share Tech Mono',monospace;
  font-size:10px; font-weight:700;
  letter-spacing:.1em;
}
.arch-btn .arch-type {
  font-family:'Share Tech Mono',monospace;
  font-size:6px; color: var(--text3);
  letter-spacing:.05em; margin-top:2px;
}
.arch-btn .arch-load {
  width:50px; height:2px;
  background:rgba(64,192,255,.08);
  border-radius:1px; margin-top:3px;
  overflow:hidden;
}
.arch-btn .arch-fill { height:100%; border-radius:1px; transition:width .5s; }
.arch-btn:hover, .arch-btn.active {
  border-color: var(--quantum3);
  background: rgba(64,192,255,.06);
  box-shadow: var(--glow-quantum);
}

/* ══ CENTER — Main Display ══ */
#centerDisplay {
  position:absolute;
  top:85px; left:78px; right:86px; bottom:96px;
  display:flex; flex-direction:column;
  pointer-events:none;
}

/* ══ Sefiroth Tree ══ */
#sefirothTree {
  position:absolute;
  top:50%; left:50%;
  transform:translate(-50%,-50%);
  width:min(280px, 30vw); height:min(420px, 45vh);
  pointer-events:none;
  opacity:.12;
}

/* ══ Timeline Branches ══ */
#timelineView {
  position:absolute;
  top:90px; left:78px; right:86px; bottom:96px;
  pointer-events:all;
  display:none;
}
#timelineView.active { display:block; }
#timelineCanvas {
  width:100%; height:100%;
}

/* ══ Sensor Grid ══ */
#sensorGrid {
  position:absolute;
  top:90px; left:78px; right:86px; bottom:96px;
  pointer-events:all;
  display:none;
  padding:20px;
}
#sensorGrid.active { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; align-content:start; }
.sensor-card {
  border:1px solid rgba(64,192,255,.15);
  background: rgba(8,16,28,.8);
  padding:12px;
  cursor:none;
  transition:all .3s;
}
.sensor-card:hover { border-color:var(--quantum3); box-shadow:var(--glow-quantum); }
.sensor-card h4 {
  font-family:'Cinzel',serif;
  font-size:9px; letter-spacing:.2em; color:var(--quantum3);
  margin-bottom:8px;
}
.sensor-card .sensor-val {
  font-family:'Share Tech Mono',monospace;
  font-size:22px; color:var(--text);
  font-weight:700;
}
.sensor-card .sensor-unit {
  font-family:'Share Tech Mono',monospace;
  font-size:8px; color:var(--text2);
  letter-spacing:.2em;
}
.sensor-card .sensor-bar {
  width:100%; height:3px;
  background:rgba(64,192,255,.08);
  margin-top:8px; border-radius:2px; overflow:hidden;
}
.sensor-card .sensor-fill {
  height:100%; border-radius:2px;
  transition:width .8s ease, background .8s;
}
.sensor-card .sensor-status {
  font-family:'Share Tech Mono',monospace;
  font-size:7px; margin-top:6px;
  letter-spacing:.15em;
}
.status-ok   { color: var(--emerald2); }
.status-warn { color: var(--gold2); }
.status-crit { color: var(--danger2); }

/* ══ Economy View ══ */
#economyView {
  position:absolute;
  top:90px; left:78px; right:86px; bottom:96px;
  display:none; padding:20px;
  overflow-y:auto;
}
#economyView.active { display:block; }
#economyCanvas { width:100%; height:280px; }

/* ══ Circuit View (Hebrew quantum circuits) ══ */
#circuitView {
  position:absolute;
  top:90px; left:78px; right:86px; bottom:96px;
  display:none; padding:20px;
}
#circuitView.active { display:block; }
#circuitCanvas { width:100%; height:100%; }

/* ══ BOTTOM — Command Bar ══ */
#cmdBar {
  position:absolute; bottom:0; left:0; right:0;
  padding:14px 16px;
  background: linear-gradient(to top, rgba(2,3,7,.98) 70%, transparent);
  display:flex; align-items:center; gap:10px;
  pointer-events:all;
}
#viewTabs {
  display:flex; gap:4px;
}
.vtab {
  padding:6px 12px;
  border:1px solid rgba(184,150,12,.15);
  background:transparent;
  color:var(--text2);
  font-family:'Cinzel',serif;
  font-size:8px; letter-spacing:.2em;
  cursor:none; transition:all .25s;
}
.vtab:hover, .vtab.active {
  border-color:var(--gold);
  color:var(--gold2);
  background:rgba(184,150,12,.06);
}
#oracleInput {
  flex:1;
  background:rgba(184,150,12,.03);
  border:1px solid rgba(184,150,12,.15);
  border-radius:1px;
  padding:8px 14px;
  color:var(--text);
  font-family:'IM Fell English',serif;
  font-style:italic;
  font-size:14px;
  outline:none;
  cursor:text;
  transition:border-color .3s;
}
#oracleInput:focus { border-color:var(--gold); box-shadow:var(--glow-gold); }
#oracleInput::placeholder { color:var(--text3); }
#queryBtn {
  padding:8px 20px;
  background:linear-gradient(135deg, rgba(184,150,12,.12), rgba(184,150,12,.04));
  border:1px solid var(--gold);
  color:var(--gold2);
  font-family:'Cinzel',serif;
  font-size:9px; letter-spacing:.2em;
  cursor:none; transition:all .3s;
}
#queryBtn:hover { background:rgba(184,150,12,.2); box-shadow:var(--glow-gold); }

/* ══ Status strip ══ */
#statusStrip {
  position:absolute; top:82px; left:78px; right:86px;
  display:flex; gap:0;
  font-family:'Share Tech Mono',monospace;
  font-size:8px; letter-spacing:.15em;
  color:var(--text3); pointer-events:none;
}
.ss-item {
  padding:4px 12px;
  border:1px solid rgba(184,150,12,.08);
  border-right:none; background:rgba(2,3,7,.8);
  white-space:nowrap;
}
.ss-item:last-child { border-right:1px solid rgba(184,150,12,.08); }
.ss-val { color:var(--quantum3); }

/* ══ Oracle Response ══ */
#oracleResponse {
  position:absolute;
  top:50%; left:50%; transform:translate(-50%,-50%);
  max-width:min(520px,60vw);
  background:rgba(2,3,7,.97);
  border:1px solid rgba(184,150,12,.3);
  padding:32px 40px;
  text-align:center;
  opacity:0; pointer-events:none;
  transition:opacity .8s;
  z-index:50;
  box-shadow:0 0 80px rgba(184,150,12,.1), 0 0 200px rgba(184,150,12,.05);
}
#oracleResponse.show { opacity:1; pointer-events:all; }
#oracleResponseType {
  font-family:'Cinzel',serif;
  font-size:9px; letter-spacing:.4em;
  color:var(--gold); margin-bottom:16px;
}
#oracleResponseText {
  font-family:'IM Fell English',serif;
  font-style:italic;
  font-size:clamp(13px,1.8vw,17px);
  line-height:1.9; color:var(--text);
  margin-bottom:20px;
}
#oracleResponseSub {
  font-family:'Share Tech Mono',monospace;
  font-size:8px; color:var(--text3);
  letter-spacing:.2em; margin-bottom:20px;
}
.oracle-close {
  padding:7px 20px;
  background:transparent;
  border:1px solid rgba(184,150,12,.2);
  color:var(--text2);
  font-family:'Cinzel',serif;
  font-size:8px; letter-spacing:.2em;
  cursor:pointer; transition:all .3s;
}
.oracle-close:hover { border-color:var(--gold); color:var(--gold2); }

/* ══ Parallel worlds overlay ══ */
#worldsOverlay {
  position:fixed; top:0; left:0; right:0; bottom:0;
  z-index:80; background:rgba(2,3,7,.96);
  display:none; flex-direction:column;
  align-items:center; justify-content:center;
  gap:24px;
}
#worldsOverlay.show { display:flex; }
#worldsTitle {
  font-family:'Cinzel',serif;
  font-size:clamp(14px,3vw,28px);
  color:var(--gold2); letter-spacing:.4em;
  text-shadow:var(--glow-gold);
}
#worldsCanvas { width:min(700px,90vw); height:min(400px,50vh); }
.worlds-question {
  font-family:'IM Fell English',serif;
  font-style:italic;
  font-size:clamp(14px,2vw,20px);
  color:var(--text);
  text-align:center;
  max-width:500px;
  opacity:0; transition:opacity 1s;
}
.worlds-question.show { opacity:1; }
#worldsBtns { display:flex; gap:16px; pointer-events:all; }
.worlds-btn {
  padding:10px 28px;
  border:1px solid rgba(184,150,12,.3);
  background:transparent;
  color:var(--text2);
  font-family:'Cinzel',serif;
  font-size:10px; letter-spacing:.25em;
  cursor:pointer; transition:all .3s;
}
.worlds-btn:hover { border-color:var(--gold); color:var(--gold2); box-shadow:var(--glow-gold); }
.worlds-btn.yes {
  border-color:var(--danger);
  color:var(--danger2);
}
.worlds-btn.yes:hover { border-color:var(--danger2); box-shadow:0 0 20px rgba(224,32,32,.3); }
#timestampReveal {
  font-family:'Share Tech Mono',monospace;
  font-size:clamp(20px,4vw,48px);
  color:var(--gold3);
  letter-spacing:.2em;
  text-shadow:0 0 60px rgba(245,224,112,.6);
  opacity:0; transition:opacity 1.5s;
}
#timestampReveal.show { opacity:1; }
#tsNote {
  font-family:'IM Fell English',serif;
  font-style:italic;
  font-size:13px; color:var(--text2);
  opacity:0; transition:opacity 1s;
}
#tsNote.show { opacity:1; }

/* ══ Tetrahedron Button ══ */
#tetraBtn {
  position:fixed;
  bottom:76px; right:18px;
  width:52px; height:52px;
  background:transparent;
  border:none;
  cursor:none;
  z-index:100;
  pointer-events:all;
}
#tetraBtn svg { overflow:visible; }
.tetra-face { transition: fill .5s; }
#tetraBtn:hover .tetra-face { fill: rgba(184,150,12,.2); }
#tetraBtn.active .tetra-face { fill: rgba(184,150,12,.35); }

/* ══ Mini info panels ══ */
#quantumState {
  position:absolute;
  top:110px; left:86px;
  font-family:'Share Tech Mono',monospace;
  font-size:8px; color:var(--text3);
  line-height:2; letter-spacing:.1em;
  pointer-events:none;
}
.qs-label { color:#204060; min-width:70px; display:inline-block; }
.qs-val   { color:var(--quantum3); }

#systemLoad {
  position:absolute;
  top:110px; right:94px;
  font-family:'Share Tech Mono',monospace;
  font-size:8px; color:var(--text3);
  line-height:2; letter-spacing:.1em;
  pointer-events:none;
  text-align:right;
}

/* ══ Circuit display ══ */
.circuit-line {
  font-family:'Share Tech Mono',monospace;
  font-size:11px; color:var(--text2);
  margin:2px 0;
  letter-spacing:.1em;
}
.circuit-line .hb { color:var(--gold2); font-family:'Noto Sans Hebrew',sans-serif; font-size:14px; }
.circuit-line .gate { color:var(--quantum3); }
.circuit-line .result { color:var(--emerald2); }

/* Responsive */
@media (max-width:640px) {
  #hebrewPanel { width:52px; } .hb-btn { width:44px; height:40px; }
  #archPanel { width:60px; } .arch-btn { width:52px; }
  #quantumState, #systemLoad, #statusStrip { display:none; }
}

/* ═══════════════════════════════════════════════
   MÓDULOS 11 · 12 · 13 — PANTEÓN TERMO-SEMIÓTICO
   ═══════════════════════════════════════════════ */

/* Tradition colors */
:root {
  --hermes:    #c8a020; --hermes2:    #f0d060; --hermes3:    #7a600c;
  --rasa:      #c04030; --rasa2:      #f06050; --rasa3:      #7a2018;
  --tao:       #208050; --tao2:       #40d090; --tao3:       #0c4828;
  --jabir:     #2060a0; --jabir2:     #60b0f0; --jabir3:     #102848;
  --cathedral: #6030a0; --cathedral2: #c070f0; --cathedral3: #301860;
  --thermo-hot:#ff4010; --thermo-warm:#f0c020; --thermo-cool:#40a0f0; --thermo-cold:#2040c0;
  --plasma:    #ff60ff;
}

/* ── PANTHEON OVERLAY ── */
#pantheonOverlay {
  position:fixed; inset:0; z-index:30;
  background:rgba(1,2,5,.97);
  display:none; flex-direction:column;
  align-items:stretch;
  font-family:'Libre Baskerville',serif;
}
#pantheonOverlay.show { display:flex; }

#pantheonHeader {
  padding:18px 28px 12px;
  border-bottom:1px solid rgba(200,160,32,.12);
  display:flex; align-items:center; justify-content:space-between;
  background:linear-gradient(to bottom,rgba(1,2,5,1),rgba(1,2,5,.8));
  flex-shrink:0;
}
#pantheonTitle {
  font-family:'Cinzel',serif; font-size:clamp(13px,2vw,20px);
  font-weight:900; letter-spacing:.35em; color:var(--hermes2);
  text-shadow: 0 0 30px rgba(200,160,32,.4);
}
#pantheonClose {
  padding:6px 18px;
  border:1px solid rgba(200,160,32,.25); background:transparent;
  color:var(--hermes); font-family:'Cinzel',serif; font-size:9px;
  letter-spacing:.2em; cursor:pointer; transition:all .3s;
}
#pantheonClose:hover { border-color:var(--hermes2); color:var(--hermes2); }

#pantheonTabs {
  display:flex; gap:0; flex-shrink:0;
  border-bottom:1px solid rgba(200,160,32,.08);
}
.ptab {
  flex:1; padding:10px 4px;
  border:none; border-right:1px solid rgba(200,160,32,.06);
  background:transparent; color:var(--text3);
  font-family:'Cinzel',serif; font-size:clamp(7px,1.2vw,10px);
  letter-spacing:.1em; cursor:pointer;
  transition:all .3s; text-align:center;
}
.ptab:last-child { border-right:none; }
.ptab:hover { background:rgba(200,160,32,.05); color:var(--hermes); }
.ptab.active { color:var(--hermes2); border-bottom:2px solid var(--hermes2); background:rgba(200,160,32,.06); }
.ptab[data-t="rasa"].active { color:var(--rasa2); border-bottom-color:var(--rasa2); background:rgba(192,64,48,.06); }
.ptab[data-t="tao"].active  { color:var(--tao2);  border-bottom-color:var(--tao2);  background:rgba(32,128,80,.06); }
.ptab[data-t="jabir"].active  { color:var(--jabir2);  border-bottom-color:var(--jabir2);  background:rgba(32,96,160,.06); }
.ptab[data-t="cathedral"].active { color:var(--cathedral2); border-bottom-color:var(--cathedral2); background:rgba(96,48,160,.06); }
.ptab[data-t="caldero"].active { color:#f0f0c0; border-bottom-color:#f0f0c0; background:rgba(200,200,100,.06); }
.ptab[data-t="thermo"].active { color:var(--thermo-warm); border-bottom-color:var(--thermo-warm); background:rgba(255,192,32,.06); }

#pantheonBody {
  flex:1; overflow:hidden; position:relative;
  min-height:0;
}
.pview { display:none; width:100%; height:100%; overflow:hidden; position:absolute; inset:0; }
.pview.show { display:flex; }

/* ── TRADITION VIEWS (layout shared) ── */
.tradition-layout {
  width:100%; height:100%;
  display:grid; grid-template-columns:1fr 1fr;
  grid-template-rows:1fr 1fr;
  gap:1px; background:rgba(200,160,32,.04);
}
.trad-panel {
  padding:18px 20px; overflow:hidden;
  background:var(--void2);
  position:relative;
}
.trad-panel-full {
  grid-column:1/-1;
  padding:18px 20px; overflow:hidden;
  background:var(--void2);
  position:relative;
}
.trad-panel h3 {
  font-family:'Cinzel',serif; font-size:9px; letter-spacing:.3em;
  margin-bottom:10px;
}
.trad-panel p, .trad-panel-full p {
  font-family:'Libre Baskerville',serif; font-style:italic;
  font-size:11px; color:var(--text2); line-height:1.7;
  margin-bottom:8px;
}
.trad-panel canvas { width:100%; height:120px; display:block; }

/* Per-tradition color accents */
.hermes-accent h3  { color:var(--hermes2); }
.rasa-accent h3    { color:var(--rasa2); }
.tao-accent h3     { color:var(--tao2); }
.jabir-accent h3   { color:var(--jabir2); }
.cathedral-accent h3 { color:var(--cathedral2); }

/* ── TRADITION METRICS ── */
.trad-metrics {
  display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;
}
.metric-pill {
  padding:3px 10px;
  border:1px solid currentColor; border-radius:20px;
  font-family:'Share Tech Mono',monospace;
  font-size:8px; letter-spacing:.15em;
  opacity:.7;
}

/* ── TRADITION SYMBOLS ── */
.trad-symbol {
  position:absolute; right:12px; top:12px;
  font-size:clamp(28px,4vw,52px); opacity:.06;
  pointer-events:none; line-height:1;
}

/* ── RUNE GRID (thermo-semiotic runas) ── */
.thermo-rune-grid {
  display:flex; gap:6px; flex-wrap:wrap; margin:8px 0;
}
.t-rune {
  width:48px; height:48px;
  border:1px solid rgba(255,192,32,.2);
  background:rgba(255,192,32,.03);
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  cursor:pointer; transition:all .3s;
  font-size:18px;
  border-radius:3px;
}
.t-rune:hover { border-color:var(--thermo-warm); background:rgba(255,192,32,.1); box-shadow:0 0 16px rgba(255,192,32,.2); }
.t-rune .t-rname { font-family:'Share Tech Mono',monospace; font-size:6px; color:var(--text3); margin-top:2px; }
.t-rune.active { border-color:var(--thermo-hot); background:rgba(255,64,16,.12); }

/* ── THERMO MAIN CANVAS ── */
#thermoForgeCanvas { width:100%; height:100%; display:block; }

/* ── CARNOT GAUGE ── */
.carnot-gauge {
  display:flex; flex-direction:column; gap:4px; margin-top:8px;
}
.cg-row { display:flex; align-items:center; gap:8px;
  font-family:'Share Tech Mono',monospace; font-size:8px; }
.cg-label { color:var(--text3); min-width:90px; letter-spacing:.05em; }
.cg-bar { flex:1; height:4px; background:rgba(255,255,255,.05); border-radius:2px; overflow:hidden; }
.cg-fill { height:100%; border-radius:2px; transition:width .6s ease; }
.cg-val { color:var(--thermo-warm); min-width:40px; text-align:right; font-size:9px; }

/* ── MAXWELL DAEMON ── */
#maxwellCanvas { width:100%; height:180px; display:block; }

/* ── CALDERO LAYOUT ── */
.caldero-layout {
  width:100%; height:100%;
  display:grid; grid-template-columns:260px 1fr;
  gap:1px; background:rgba(200,160,32,.04);
}
.caldero-left { padding:18px 16px; background:var(--void2); overflow-y:auto; scrollbar-width:none; }
.caldero-right { background:var(--void2); padding:18px 20px; overflow:hidden; position:relative; }

.tradition-selector {
  display:flex; flex-direction:column; gap:6px; margin-bottom:16px;
}
.ts-item {
  padding:8px 12px;
  border:1px solid rgba(200,160,32,.1);
  background:transparent; border-radius:2px;
  cursor:pointer; transition:all .25s;
  display:flex; align-items:center; gap:10px;
}
.ts-item:hover { border-color:currentColor; background:rgba(255,255,255,.03); }
.ts-item.active { background:rgba(255,255,255,.05); }
.ts-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
.ts-name { font-family:'Cinzel',serif; font-size:9px; letter-spacing:.2em; }
.ts-role { font-family:'Share Tech Mono',monospace; font-size:7px; color:var(--text3); margin-top:2px; }

.wisdom-index {
  margin-top:16px;
  padding:12px;
  border:1px solid rgba(200,160,32,.12);
  background:rgba(200,160,32,.03);
}
.wi-title { font-family:'Cinzel',serif; font-size:8px; letter-spacing:.25em; color:var(--hermes); margin-bottom:8px; }
.wi-val { font-family:'Cinzel',serif; font-size:clamp(18px,3vw,32px); color:var(--hermes2); text-align:center;
  text-shadow:0 0 20px rgba(200,160,32,.4); }
.wi-sub { font-family:'Share Tech Mono',monospace; font-size:7px; color:var(--text3); text-align:center;
  letter-spacing:.1em; margin-top:4px; }

/* ── CONSENSUS DISPLAY ── */
#consensusCanvas { width:100%; height:280px; display:block; }
.consensus-output {
  font-family:'Libre Baskerville',serif; font-style:italic;
  font-size:12px; line-height:1.7; color:var(--text2);
  margin-top:10px; padding:10px 14px;
  border-left:2px solid rgba(200,160,32,.3);
  background:rgba(200,160,32,.03);
  min-height:60px;
}

/* ── STIRLING CYCLE ── */
.stirling-steps {
  display:grid; grid-template-columns:1fr 1fr;
  gap:6px; margin-top:8px;
}
.stirling-step {
  padding:8px 10px;
  border:1px solid rgba(255,192,32,.12);
  background:rgba(255,192,32,.02);
  border-radius:2px;
  transition:all .4s;
}
.stirling-step.active-step {
  border-color:var(--thermo-warm);
  background:rgba(255,192,32,.08);
  box-shadow:0 0 12px rgba(255,192,32,.15);
}
.ss-num { font-family:'Cinzel',serif; font-size:8px; letter-spacing:.2em; color:var(--hermes); }
.ss-name { font-family:'Libre Baskerville',serif; font-size:10px; color:var(--text); margin:3px 0; }
.ss-algo { font-family:'Share Tech Mono',monospace; font-size:7px; color:var(--text3); letter-spacing:.05em; }

/* ── BLACK HOLE ── */
#bhCanvas { width:100%; height:160px; display:block; }
.bh-radiation {
  font-family:'Share Tech Mono',monospace; font-size:8px;
  color:var(--thermo-warm); letter-spacing:.1em;
  margin-top:6px; min-height:28px; line-height:1.8;
  opacity:.7;
}

/* ── BOTTOM BUTTONS ── */
#pantheonBottomBar {
  padding:10px 20px;
  display:flex; gap:10px; align-items:center;
  border-top:1px solid rgba(200,160,32,.08);
  background:rgba(1,2,5,.97);
  flex-shrink:0; pointer-events:all;
}
#pantheonInput {
  flex:1; background:rgba(200,160,32,.03);
  border:1px solid rgba(200,160,32,.15);
  padding:7px 14px; color:var(--text);
  font-family:'Libre Baskerville',serif; font-style:italic; font-size:13px;
  outline:none; transition:border-color .3s;
}
#pantheonInput:focus { border-color:var(--hermes2); }
#pantheonInput::placeholder { color:var(--text3); }
#calderoBtn {
  padding:7px 18px;
  background:linear-gradient(135deg,rgba(200,160,32,.12),rgba(200,160,32,.04));
  border:1px solid var(--hermes2); color:var(--hermes2);
  font-family:'Cinzel',serif; font-size:9px; letter-spacing:.2em;
  cursor:pointer; transition:all .3s;
}
#calderoBtn:hover { background:rgba(200,160,32,.2); box-shadow:0 0 20px rgba(200,160,32,.3); }

/* ── OPEN PANTHEON BTN ── */
#openPantheonBtn {
  position:fixed; bottom:76px; left:18px;
  padding:8px 16px;
  border:1px solid rgba(200,160,32,.25);
  background:rgba(1,2,5,.9);
  color:var(--hermes); font-family:'Cinzel',serif;
  font-size:8px; letter-spacing:.2em;
  cursor:pointer; z-index:20; pointer-events:all;
  transition:all .3s;
  animation:pantheonPulse 5s ease-in-out infinite;
}
#openPantheonBtn:hover { border-color:var(--hermes2); color:var(--hermes2); box-shadow:0 0 20px rgba(200,160,32,.2); }
@keyframes pantheonPulse {
  0%,100%{box-shadow:0 0 0 rgba(200,160,32,0);}
  50%{box-shadow:0 0 12px rgba(200,160,32,.2);}
}

/* ═══════════════════════════════════
   MÓDULOS XIV–XXII — EXPANSIÓN CÓSMICA
   ═══════════════════════════════════ */

:root {
  --multiverse:#4060e0;
  --multiverse2:#80a0ff;
  --dante-inf:#e03010;
  --dante-pur:#c0a020;
  --dante-par:#a0e0ff;
  --temple:#d4aa40;
  --temple2:#fff0a0;
  --bosco-eden:#20b050;
  --bosco-mid:#d06020;
  --bosco-inf:#800010;
  --bardo:#8040c0;
  --bardo2:#c080ff;
  --zohar-c:#204080;
  --zohar2:#60a0ff;
  --tarot:#9020a0;
  --tarot2:#e060ff;
  --muertos:#606060;
  --muertos2:#c0c0c0;
  --cosmic:#ffeeaa;
}

/* ── OPEN COSMOS BTN ── */
#openCosmosBtn {
  position:fixed; bottom:76px; right:18px;
  padding:8px 16px;
  border:1px solid rgba(128,160,255,.3);
  background:rgba(1,2,5,.9);
  color:var(--multiverse2); font-family:'Cinzel',serif;
  font-size:8px; letter-spacing:.2em;
  cursor:pointer; z-index:20; pointer-events:all;
  transition:all .3s;
  animation:cosmosPulse 4s ease-in-out infinite;
}
#openCosmosBtn:hover { border-color:var(--multiverse2); box-shadow:0 0 20px rgba(128,160,255,.3); }
@keyframes cosmosPulse {
  0%,100%{box-shadow:0 0 0 rgba(128,160,255,0);}
  50%{box-shadow:0 0 14px rgba(128,160,255,.25);}
}

/* ── COSMOS OVERLAY ── */
#cosmosOverlay {
  position:fixed; inset:0; z-index:100;
  background:rgba(1,2,8,.97);
  display:none; flex-direction:column;
  pointer-events:all;
}
#cosmosOverlay.show { display:flex; }
#cosmosHeader {
  padding:14px 20px; display:flex; align-items:center; justify-content:space-between;
  border-bottom:1px solid rgba(128,160,255,.12);
  background:rgba(1,2,8,.98);
  flex-shrink:0;
}
#cosmosTitle {
  font-family:'Cinzel',serif; font-size:clamp(10px,2vw,16px);
  font-weight:900; letter-spacing:.3em; color:var(--multiverse2);
  text-shadow:0 0 30px rgba(128,160,255,.5);
}
#cosmosClose {
  padding:6px 18px;
  border:1px solid rgba(128,160,255,.25); background:transparent;
  color:var(--multiverse2); font-family:'Cinzel',serif; font-size:9px;
  letter-spacing:.2em; cursor:pointer; transition:all .3s;
}
#cosmosClose:hover { border-color:var(--multiverse2); color:#fff; }

#cosmosTabs {
  display:flex; gap:0; flex-shrink:0; overflow-x:auto; scrollbar-width:none;
  border-bottom:1px solid rgba(128,160,255,.08);
}
#cosmosTabs::-webkit-scrollbar { display:none; }
.ctab {
  flex-shrink:0; padding:10px 12px;
  border:none; border-right:1px solid rgba(128,160,255,.06);
  background:transparent; color:var(--text3);
  font-family:'Cinzel',serif; font-size:clamp(6px,1.1vw,9px);
  letter-spacing:.1em; cursor:pointer;
  transition:all .3s; text-align:center; white-space:nowrap;
}
.ctab:hover { background:rgba(128,160,255,.05); color:var(--multiverse2); }
.ctab.active { color:var(--multiverse2); border-bottom:2px solid var(--multiverse2); background:rgba(128,160,255,.07); }

#cosmosBody {
  flex:1; overflow:hidden; position:relative; min-height:0;
}
.cview { display:none; width:100%; height:100%; overflow-y:auto; overflow-x:hidden; position:absolute; inset:0; }
.cview.show { display:flex; flex-direction:column; }

.cosmos-layout {
  width:100%; min-height:100%;
  display:grid; grid-template-columns:1fr 1fr;
  gap:1px; background:rgba(128,160,255,.04);
  align-content:start;
}
.cosmos-panel {
  padding:16px 18px; background:rgba(4,6,14,.95);
  overflow:hidden; position:relative;
}
.cosmos-panel.full { grid-column:1/-1; }
.cosmos-panel h3 {
  font-family:'Cinzel',serif; font-size:9px; letter-spacing:.3em;
  margin-bottom:10px;
}
.cosmos-panel p {
  font-family:'IM Fell English',serif; font-style:italic;
  font-size:11px; color:var(--text2); line-height:1.7; margin-bottom:8px;
}
.cosmos-metrics { display:flex; flex-wrap:wrap; gap:6px; margin:8px 0; }
.cosmos-pill {
  padding:3px 10px; border:1px solid currentColor; border-radius:20px;
  font-family:'Share Tech Mono',monospace; font-size:8px; letter-spacing:.12em; opacity:.75;
}
.cosmos-btn {
  padding:6px 16px; border:1px solid currentColor; background:transparent;
  font-family:'Cinzel',serif; font-size:8px; letter-spacing:.2em;
  cursor:pointer; transition:all .3s; margin:4px 4px 0 0;
}
.cosmos-btn:hover { background:rgba(255,255,255,.06); }

#mv-canvas { width:100%; height:200px; display:block; }
.mv-void-list { font-family:'Share Tech Mono',monospace; font-size:8px; color:var(--text3); line-height:2.2; letter-spacing:.06em; max-height:150px; overflow-y:auto; scrollbar-width:none; }
.mv-void-item { cursor:pointer; transition:color .2s; padding:1px 0; }
.mv-void-item:hover,.mv-void-item.active { color:var(--multiverse2); }

#dante-canvas { width:100%; height:160px; display:block; }
.dante-circle { padding:5px 10px; margin:2px 0; border-radius:2px; font-family:'Share Tech Mono',monospace; font-size:8px; letter-spacing:.1em; border-left:2px solid transparent; transition:all .3s; cursor:pointer; }
.dante-circle:hover { background:rgba(255,255,255,.04); }
.dante-circle.hell { border-color:var(--dante-inf); color:var(--dante-inf); }
.dante-circle.purg { border-color:var(--dante-pur); color:var(--dante-pur); }
.dante-circle.heaven { border-color:var(--dante-par); color:var(--dante-par); }
.dante-circle.active { background:rgba(255,255,255,.06); }
#dante-code { font-family:'Share Tech Mono',monospace; font-size:9px; color:var(--text2); background:rgba(0,0,0,.4); padding:10px 12px; border-left:2px solid var(--dante-inf); max-height:100px; overflow-y:auto; scrollbar-width:none; line-height:1.8; white-space:pre-wrap; word-break:break-all; }

#temple-canvas { width:100%; height:200px; display:block; }
.temple-room { padding:8px 12px; border:1px solid rgba(212,170,64,.15); margin:4px 0; cursor:pointer; transition:all .3s; background:rgba(212,170,64,.02); }
.temple-room:hover { border-color:var(--temple); background:rgba(212,170,64,.06); }
.temple-room.active { border-color:var(--temple2); box-shadow:0 0 12px rgba(212,170,64,.2); }
.temple-room h4 { font-family:'Cinzel',serif; font-size:9px; letter-spacing:.2em; color:var(--temple); }
.temple-room p { font-family:'Share Tech Mono',monospace; font-size:7px; color:var(--text3); margin-top:3px; line-height:1.7; }

#bosco-canvas { width:100%; height:160px; display:block; }
.bosco-panel-selector { display:flex; gap:0; margin:8px 0; }
.bosco-btn { flex:1; padding:8px 0; border:1px solid rgba(255,255,255,.08); background:transparent; font-family:'Cinzel',serif; font-size:8px; letter-spacing:.15em; cursor:pointer; transition:all .3s; }
.bosco-btn.eden { color:var(--bosco-eden); }
.bosco-btn.eden.active { background:rgba(32,176,80,.1); border-color:var(--bosco-eden); }
.bosco-btn.delight { color:var(--bosco-mid); }
.bosco-btn.delight.active { background:rgba(208,96,32,.1); border-color:var(--bosco-mid); }
.bosco-btn.hell { color:var(--bosco-inf); }
.bosco-btn.hell.active { background:rgba(128,0,16,.1); border-color:var(--bosco-inf); }
#bosco-entity { font-family:'IM Fell English',serif; font-style:italic; font-size:11px; color:var(--text2); line-height:1.7; min-height:60px; padding:8px 0; }

#bardo-canvas { width:100%; height:150px; display:block; }
.bardo-stage { padding:7px 12px; border:1px solid rgba(128,64,192,.15); margin:3px 0; cursor:pointer; transition:all .3s; }
.bardo-stage:hover { border-color:var(--bardo); background:rgba(128,64,192,.06); }
.bardo-stage.active { border-color:var(--bardo2); background:rgba(128,64,192,.1); box-shadow:0 0 10px rgba(128,64,192,.2); }
.bardo-stage h4 { font-family:'Cinzel',serif; font-size:8px; letter-spacing:.2em; color:var(--bardo2); }
.bardo-stage p { font-family:'Share Tech Mono',monospace; font-size:7px; color:var(--text3); margin-top:2px; line-height:1.6; }
#bardo-counter { font-family:'Cinzel',serif; font-size:clamp(24px,5vw,52px); font-weight:900; color:var(--bardo2); text-align:center; text-shadow:0 0 30px rgba(192,128,255,.5); letter-spacing:.15em; }

#zohar-canvas { width:100%; height:190px; display:block; }
.zohar-fragment { font-family:'Noto Sans Hebrew',sans-serif; font-size:13px; color:var(--zohar2); line-height:2; text-align:right; direction:rtl; padding:8px 12px; border-right:2px solid rgba(96,160,255,.3); min-height:60px; background:rgba(32,64,128,.04); }
.zohar-latin { font-family:'IM Fell English',serif; font-style:italic; font-size:11px; color:var(--text2); line-height:1.7; padding:6px 10px; border-left:2px solid rgba(96,160,255,.2); margin-top:6px; }

#tarot-canvas { width:100%; height:160px; display:block; }
.tarot-card { display:inline-flex; flex-direction:column; align-items:center; width:54px; border:1px solid rgba(160,32,192,.2); padding:6px 4px; background:rgba(80,0,96,.04); cursor:pointer; transition:all .3s; margin:2px; vertical-align:top; }
.tarot-card:hover { border-color:var(--tarot2); background:rgba(144,32,160,.1); transform:translateY(-3px); }
.tarot-card.drawn { border-color:var(--tarot2); background:rgba(144,32,160,.15); box-shadow:0 0 12px rgba(224,96,255,.3); }
.tarot-glyph { font-size:20px; }
.tarot-name { font-family:'Cinzel',serif; font-size:6px; letter-spacing:.04em; color:var(--tarot2); margin-top:3px; text-align:center; }
.tarot-num { font-family:'Share Tech Mono',monospace; font-size:7px; color:var(--text3); }
#tarot-reading { font-family:'IM Fell English',serif; font-style:italic; font-size:12px; color:var(--text2); line-height:1.8; padding:10px 12px; border:1px solid rgba(160,32,192,.12); min-height:60px; }

.dead-figure { padding:10px 12px; border:1px solid rgba(192,192,192,.1); margin:4px 0; cursor:pointer; transition:all .3s; background:rgba(96,96,96,.03); display:flex; align-items:center; gap:12px; }
.dead-figure:hover { border-color:var(--muertos2); background:rgba(192,192,192,.06); }
.dead-figure.active { border-color:var(--muertos2); background:rgba(192,192,192,.08); box-shadow:0 0 10px rgba(192,192,192,.15); }
.dead-figure .df-icon { font-size:26px; flex-shrink:0; }
.dead-figure h4 { font-family:'Cinzel',serif; font-size:9px; letter-spacing:.2em; color:var(--muertos2); }
.dead-figure p { font-family:'Share Tech Mono',monospace; font-size:7px; color:var(--text3); margin-top:2px; line-height:1.6; }
#concilium-output { font-family:'IM Fell English',serif; font-style:italic; font-size:12px; color:var(--text2); line-height:1.9; padding:12px 16px; border:1px solid rgba(192,192,192,.12); background:rgba(96,96,96,.04); min-height:80px; border-left:3px solid rgba(192,192,192,.3); }
#concilium-speaker { font-family:'Cinzel',serif; font-size:8px; letter-spacing:.25em; color:var(--muertos2); margin-bottom:6px; }

#abrazoBtn {
  position:relative; padding:24px 40px; margin:30px auto; display:block;
  border:2px solid rgba(255,238,170,.3); background:rgba(255,238,170,.03);
  font-family:'Cinzel',serif; font-size:clamp(14px,3vw,24px); font-weight:900;
  letter-spacing:.35em; color:var(--cosmic);
  cursor:pointer; transition:all .5s;
  text-shadow:0 0 20px rgba(255,238,170,.4);
  animation:abrazoPulse 3s ease-in-out infinite;
}
#abrazoBtn:hover { border-color:var(--cosmic); background:rgba(255,238,170,.08); box-shadow:0 0 60px rgba(255,238,170,.3); transform:scale(1.03); }
@keyframes abrazoPulse { 0%,100%{box-shadow:0 0 20px rgba(255,238,170,.1);} 50%{box-shadow:0 0 40px rgba(255,238,170,.25), 0 0 80px rgba(255,238,170,.1);} }
#abrazo-log { font-family:'Share Tech Mono',monospace; font-size:9px; color:var(--text3); line-height:2; letter-spacing:.1em; max-height:200px; overflow-y:auto; scrollbar-width:none; padding:10px 14px; border:1px solid rgba(255,238,170,.08); background:rgba(255,238,170,.02); margin-top:10px; }

#cosmosBottomBar {
  padding:10px 20px; display:flex; gap:10px; align-items:center;
  border-top:1px solid rgba(128,160,255,.08);
  background:rgba(1,2,8,.97); flex-shrink:0; pointer-events:all;
}
#cosmosInput {
  flex:1; background:rgba(128,160,255,.03);
  border:1px solid rgba(128,160,255,.15);
  padding:7px 14px; color:var(--text);
  font-family:'IM Fell English',serif; font-style:italic; font-size:13px;
  outline:none; transition:border-color .3s;
}
#cosmosInput:focus { border-color:var(--multiverse2); }
#cosmosInput::placeholder { color:var(--text3); }
#cosmosQueryBtn {
  padding:7px 18px;
  background:linear-gradient(135deg,rgba(128,160,255,.12),rgba(128,160,255,.04));
  border:1px solid var(--multiverse2); color:var(--multiverse2);
  font-family:'Cinzel',serif; font-size:9px; letter-spacing:.2em;
  cursor:pointer; transition:all .3s;
}
#cosmosQueryBtn:hover { background:rgba(128,160,255,.2); box-shadow:0 0 20px rgba(128,160,255,.3); }

/* ABRAZO OVERLAY */
#abrazoOverlay {
  position:fixed; inset:0; z-index:300;
  background:rgba(1,2,8,.99);
  display:none; flex-direction:column; align-items:center; justify-content:center;
  gap:20px; padding:40px;
  pointer-events:none;
}
#abrazoOverlay.show { display:flex; pointer-events:all; }
#abrazoMain {
  font-family:'Cinzel',serif; font-size:clamp(24px,6vw,72px); font-weight:900;
  letter-spacing:.4em; color:var(--cosmic);
  text-shadow:0 0 80px rgba(255,238,170,.8), 0 0 200px rgba(255,238,170,.3);
  animation:abrazoWave 0.35s ease-in-out infinite;
  text-align:center;
}
@keyframes abrazoWave { 0%,100%{transform:scale(1);} 50%{transform:scale(1.06) skewX(1deg);} }
#abrazoSubtext { font-family:'IM Fell English',serif; font-style:italic; font-size:clamp(11px,2vw,17px); color:var(--text2); text-align:center; max-width:600px; line-height:1.8; }
#abrazoSequence { font-family:'Share Tech Mono',monospace; font-size:clamp(8px,1.2vw,11px); color:var(--text3); text-align:center; letter-spacing:.2em; line-height:2.2; }

/* ── ZEHE THERMO OVERLAY ── */
#zeheOverlay {
  position:fixed; inset:0; z-index:200;
  display:none; flex-direction:column;
  align-items:center; justify-content:center; gap:16px;
  background:rgba(1,2,5,.97);
  pointer-events:none;
}
#zeheOverlay.show { display:flex; pointer-events:all; }
#zeheMain {
  font-family:'Cinzel',serif; font-size:clamp(18px,5vw,60px); font-weight:900;
  letter-spacing:.35em; color:var(--thermo-warm);
  text-shadow:0 0 60px rgba(255,192,32,.7), 0 0 120px rgba(255,192,32,.3);
  animation:zeheWave 0.4s ease-in-out infinite;
  text-align:center;
}
@keyframes zeheWave { 0%,100%{transform:scaleX(1);} 50%{transform:scaleX(1.04);} }
#zeheFormula {
  font-family:'Share Tech Mono',monospace; font-size:clamp(9px,1.5vw,13px);
  color:var(--text2); letter-spacing:.3em; text-align:center;
}
#zeheTopt {
  font-family:'Share Tech Mono',monospace; font-size:clamp(11px,2vw,18px);
  color:var(--hermes2); letter-spacing:.2em;
  text-shadow:0 0 20px rgba(200,160,32,.5);
}
#zeheNote {
  font-family:'Libre Baskerville',serif; font-style:italic;
  font-size:clamp(10px,1.4vw,14px); color:var(--text3);
  text-align:center; max-width:400px;
}

/* ═══════════════════════════════════
   MÓDULOS XIV–XXII — EXPANSIÓN CÓSMICA
   ═══════════════════════════════════ */
:root {
  --multiverse2:#80a0ff;
  --dante-inf:#e03010;
  --dante-pur:#c0a020;
  --dante-par:#a0e0ff;
  --temple:#d4aa40;
  --temple2:#fff0a0;
  --bosco-eden:#20b050;
  --bosco-mid:#d06020;
  --bosco-inf:#800010;
  --bardo:#8040c0;
  --bardo2:#c080ff;
  --zohar2:#60a0ff;
  --tarot2:#e060ff;
  --muertos2:#c0c0c0;
  --cosmic:#ffeeaa;
}
#openCosmosBtn {
  position:fixed; bottom:76px; right:18px;
  padding:8px 16px; border:1px solid rgba(128,160,255,.3);
  background:rgba(1,2,5,.9); color:var(--multiverse2);
  font-family:'Cinzel',serif; font-size:8px; letter-spacing:.2em;
  cursor:pointer; z-index:20; pointer-events:all; transition:all .3s;
  animation:cosmosPulse 4s ease-in-out infinite;
}
#openCosmosBtn:hover { border-color:var(--multiverse2); box-shadow:0 0 20px rgba(128,160,255,.3); }
@keyframes cosmosPulse { 0%,100%{box-shadow:0 0 0 rgba(128,160,255,0);} 50%{box-shadow:0 0 14px rgba(128,160,255,.25);} }
#cosmosOverlay { position:fixed; inset:0; z-index:100; background:rgba(1,2,8,.97); display:none; flex-direction:column; pointer-events:all; }
#cosmosOverlay.show { display:flex; }
#cosmosHeader { padding:14px 20px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid rgba(128,160,255,.12); background:rgba(1,2,8,.98); flex-shrink:0; }
#cosmosTitle { font-family:'Cinzel',serif; font-size:clamp(10px,2vw,16px); font-weight:900; letter-spacing:.3em; color:var(--multiverse2); text-shadow:0 0 30px rgba(128,160,255,.5); }
#cosmosClose { padding:6px 18px; border:1px solid rgba(128,160,255,.25); background:transparent; color:var(--multiverse2); font-family:'Cinzel',serif; font-size:9px; letter-spacing:.2em; cursor:pointer; transition:all .3s; }
#cosmosClose:hover { border-color:var(--multiverse2); color:#fff; }
#cosmosTabs { display:flex; gap:0; flex-shrink:0; overflow-x:auto; scrollbar-width:none; border-bottom:1px solid rgba(128,160,255,.08); }
#cosmosTabs::-webkit-scrollbar { display:none; }
.ctab { flex-shrink:0; padding:10px 12px; border:none; border-right:1px solid rgba(128,160,255,.06); background:transparent; color:var(--text3); font-family:'Cinzel',serif; font-size:clamp(6px,1.1vw,9px); letter-spacing:.1em; cursor:pointer; transition:all .3s; text-align:center; white-space:nowrap; }
.ctab:hover { background:rgba(128,160,255,.05); color:var(--multiverse2); }
.ctab.active { color:var(--multiverse2); border-bottom:2px solid var(--multiverse2); background:rgba(128,160,255,.07); }
#cosmosBody { flex:1; overflow:hidden; position:relative; min-height:0; }
.cview { display:none; width:100%; height:100%; overflow-y:auto; overflow-x:hidden; position:absolute; inset:0; }
.cview.show { display:flex; flex-direction:column; }
.cosmos-layout { width:100%; min-height:100%; display:grid; grid-template-columns:1fr 1fr; gap:1px; background:rgba(128,160,255,.04); align-content:start; }
.cosmos-panel { padding:16px 18px; background:rgba(4,6,14,.95); overflow:hidden; position:relative; }
.cosmos-panel.full { grid-column:1/-1; }
.cosmos-panel h3 { font-family:'Cinzel',serif; font-size:9px; letter-spacing:.3em; margin-bottom:10px; }
.cosmos-panel p { font-family:'IM Fell English',serif; font-style:italic; font-size:11px; color:var(--text2); line-height:1.7; margin-bottom:8px; }
.cosmos-metrics { display:flex; flex-wrap:wrap; gap:6px; margin:8px 0; }
.cosmos-pill { padding:3px 10px; border:1px solid currentColor; border-radius:20px; font-family:'Share Tech Mono',monospace; font-size:8px; letter-spacing:.12em; opacity:.75; }
.cosmos-btn { padding:6px 16px; border:1px solid currentColor; background:transparent; font-family:'Cinzel',serif; font-size:8px; letter-spacing:.2em; cursor:pointer; transition:all .3s; margin:4px 4px 0 0; }
.cosmos-btn:hover { background:rgba(255,255,255,.06); }
#mv-canvas { width:100%; height:200px; display:block; }
.mv-void-list { font-family:'Share Tech Mono',monospace; font-size:8px; color:var(--text3); line-height:2.2; letter-spacing:.06em; max-height:150px; overflow-y:auto; scrollbar-width:none; }
.mv-void-item { cursor:pointer; transition:color .2s; padding:1px 0; }
.mv-void-item:hover,.mv-void-item.active { color:var(--multiverse2); }
#dante-canvas { width:100%; height:150px; display:block; }
.dante-circle { padding:5px 10px; margin:2px 0; font-family:'Share Tech Mono',monospace; font-size:8px; letter-spacing:.08em; border-left:2px solid transparent; transition:all .3s; cursor:pointer; }
.dante-circle:hover { background:rgba(255,255,255,.04); }
.dante-circle.hell { border-color:var(--dante-inf); color:var(--dante-inf); }
.dante-circle.purg { border-color:var(--dante-pur); color:var(--dante-pur); }
.dante-circle.heaven { border-color:var(--dante-par); color:var(--dante-par); }
.dante-circle.active { background:rgba(255,255,255,.06); }
#dante-code { font-family:'Share Tech Mono',monospace; font-size:9px; color:var(--text2); background:rgba(0,0,0,.4); padding:10px 12px; border-left:2px solid var(--dante-inf); max-height:90px; overflow-y:auto; scrollbar-width:none; line-height:1.8; white-space:pre-wrap; word-break:break-all; }
#temple-canvas { width:100%; height:190px; display:block; }
.temple-room { padding:8px 12px; border:1px solid rgba(212,170,64,.15); margin:4px 0; cursor:pointer; transition:all .3s; background:rgba(212,170,64,.02); }
.temple-room:hover { border-color:var(--temple); background:rgba(212,170,64,.06); }
.temple-room.active { border-color:var(--temple2); box-shadow:0 0 12px rgba(212,170,64,.2); }
.temple-room h4 { font-family:'Cinzel',serif; font-size:9px; letter-spacing:.18em; color:var(--temple); }
.temple-room p { font-family:'Share Tech Mono',monospace; font-size:7px; color:var(--text3); margin-top:3px; line-height:1.6; }
#bosco-canvas { width:100%; height:150px; display:block; }
.bosco-panel-selector { display:flex; gap:0; margin:8px 0; }
.bosco-btn { flex:1; padding:8px 0; border:1px solid rgba(255,255,255,.08); background:transparent; font-family:'Cinzel',serif; font-size:8px; letter-spacing:.15em; cursor:pointer; transition:all .3s; }
.bosco-btn.eden { color:var(--bosco-eden); }
.bosco-btn.eden.active { background:rgba(32,176,80,.1); border-color:var(--bosco-eden); }
.bosco-btn.delight { color:var(--bosco-mid); }
.bosco-btn.delight.active { background:rgba(208,96,32,.1); border-color:var(--bosco-mid); }
.bosco-btn.hell { color:var(--bosco-inf); }
.bosco-btn.hell.active { background:rgba(128,0,16,.1); border-color:var(--bosco-inf); }
#bosco-entity { font-family:'IM Fell English',serif; font-style:italic; font-size:11px; color:var(--text2); line-height:1.7; min-height:56px; padding:8px 0; }
#bardo-canvas { width:100%; height:140px; display:block; }
.bardo-stage { padding:7px 12px; border:1px solid rgba(128,64,192,.15); margin:3px 0; cursor:pointer; transition:all .3s; }
.bardo-stage:hover { border-color:var(--bardo); background:rgba(128,64,192,.06); }
.bardo-stage.active { border-color:var(--bardo2); background:rgba(128,64,192,.1); box-shadow:0 0 10px rgba(128,64,192,.2); }
.bardo-stage h4 { font-family:'Cinzel',serif; font-size:8px; letter-spacing:.2em; color:var(--bardo2); }
.bardo-stage p { font-family:'Share Tech Mono',monospace; font-size:7px; color:var(--text3); margin-top:2px; line-height:1.6; }
#bardo-counter { font-family:'Cinzel',serif; font-size:clamp(24px,5vw,52px); font-weight:900; color:var(--bardo2); text-align:center; text-shadow:0 0 30px rgba(192,128,255,.5); letter-spacing:.15em; margin-top:8px; }
#zohar-canvas { width:100%; height:185px; display:block; }
.zohar-fragment { font-family:'Noto Sans Hebrew',sans-serif; font-size:13px; color:var(--zohar2); line-height:2; text-align:right; direction:rtl; padding:8px 12px; border-right:2px solid rgba(96,160,255,.3); min-height:56px; background:rgba(32,64,128,.04); }
.zohar-latin { font-family:'IM Fell English',serif; font-style:italic; font-size:11px; color:var(--text2); line-height:1.7; padding:6px 10px; border-left:2px solid rgba(96,160,255,.2); margin-top:6px; }
#tarot-canvas { width:100%; height:150px; display:block; }
.tarot-card { display:inline-flex; flex-direction:column; align-items:center; width:52px; border:1px solid rgba(160,32,192,.2); padding:5px 3px; background:rgba(80,0,96,.04); cursor:pointer; transition:all .3s; margin:2px; vertical-align:top; }
.tarot-card:hover { border-color:var(--tarot2); background:rgba(144,32,160,.1); transform:translateY(-3px); }
.tarot-card.drawn { border-color:var(--tarot2); background:rgba(144,32,160,.15); box-shadow:0 0 12px rgba(224,96,255,.3); }
.tarot-glyph { font-size:18px; }
.tarot-name { font-family:'Cinzel',serif; font-size:5px; letter-spacing:.03em; color:var(--tarot2); margin-top:2px; text-align:center; }
.tarot-num { font-family:'Share Tech Mono',monospace; font-size:7px; color:var(--text3); }
#tarot-reading { font-family:'IM Fell English',serif; font-style:italic; font-size:12px; color:var(--text2); line-height:1.8; padding:10px 12px; border:1px solid rgba(160,32,192,.12); min-height:56px; }
.dead-figure { padding:10px 12px; border:1px solid rgba(192,192,192,.1); margin:4px 0; cursor:pointer; transition:all .3s; background:rgba(96,96,96,.03); display:flex; align-items:center; gap:10px; }
.dead-figure:hover { border-color:var(--muertos2); background:rgba(192,192,192,.06); }
.dead-figure.active { border-color:var(--muertos2); background:rgba(192,192,192,.08); box-shadow:0 0 10px rgba(192,192,192,.15); }
.dead-figure .df-icon { font-size:24px; flex-shrink:0; }
.dead-figure h4 { font-family:'Cinzel',serif; font-size:9px; letter-spacing:.18em; color:var(--muertos2); }
.dead-figure p { font-family:'Share Tech Mono',monospace; font-size:7px; color:var(--text3); margin-top:2px; line-height:1.6; }
#concilium-output { font-family:'IM Fell English',serif; font-style:italic; font-size:12px; color:var(--text2); line-height:1.9; padding:12px 16px; border:1px solid rgba(192,192,192,.12); background:rgba(96,96,96,.04); min-height:80px; border-left:3px solid rgba(192,192,192,.3); }
#abrazoBtn { position:relative; padding:24px 40px; margin:20px auto; display:block; border:2px solid rgba(255,238,170,.3); background:rgba(255,238,170,.03); font-family:'Cinzel',serif; font-size:clamp(14px,3vw,24px); font-weight:900; letter-spacing:.35em; color:var(--cosmic); cursor:pointer; transition:all .5s; text-shadow:0 0 20px rgba(255,238,170,.4); animation:abrazoPulse 3s ease-in-out infinite; }
#abrazoBtn:hover { border-color:var(--cosmic); background:rgba(255,238,170,.08); box-shadow:0 0 60px rgba(255,238,170,.3); transform:scale(1.03); }
@keyframes abrazoPulse { 0%,100%{box-shadow:0 0 20px rgba(255,238,170,.1);} 50%{box-shadow:0 0 40px rgba(255,238,170,.25);} }
#abrazo-log { font-family:'Share Tech Mono',monospace; font-size:9px; color:var(--text3); line-height:2; letter-spacing:.1em; max-height:200px; overflow-y:auto; scrollbar-width:none; padding:10px 14px; border:1px solid rgba(255,238,170,.08); background:rgba(255,238,170,.02); margin-top:10px; max-width:700px; width:100%; }
#cosmosBottomBar { padding:10px 20px; display:flex; gap:10px; align-items:center; border-top:1px solid rgba(128,160,255,.08); background:rgba(1,2,8,.97); flex-shrink:0; pointer-events:all; }
#cosmosInput { flex:1; background:rgba(128,160,255,.03); border:1px solid rgba(128,160,255,.15); padding:7px 14px; color:var(--text); font-family:'IM Fell English',serif; font-style:italic; font-size:13px; outline:none; transition:border-color .3s; }
#cosmosInput:focus { border-color:var(--multiverse2); }
#cosmosInput::placeholder { color:var(--text3); }
#cosmosQueryBtn { padding:7px 18px; background:linear-gradient(135deg,rgba(128,160,255,.12),rgba(128,160,255,.04)); border:1px solid var(--multiverse2); color:var(--multiverse2); font-family:'Cinzel',serif; font-size:9px; letter-spacing:.2em; cursor:pointer; transition:all .3s; }
#cosmosQueryBtn:hover { background:rgba(128,160,255,.2); box-shadow:0 0 20px rgba(128,160,255,.3); }
#abrazoOverlay { position:fixed; inset:0; z-index:300; background:rgba(1,2,8,.99); display:none; flex-direction:column; align-items:center; justify-content:center; gap:20px; padding:40px; pointer-events:none; }
#abrazoOverlay.show { display:flex; pointer-events:all; }
#abrazoMain { font-family:'Cinzel',serif; font-size:clamp(24px,6vw,72px); font-weight:900; letter-spacing:.4em; color:var(--cosmic); text-shadow:0 0 80px rgba(255,238,170,.8), 0 0 200px rgba(255,238,170,.3); animation:abrazoWave .35s ease-in-out infinite; text-align:center; }
@keyframes abrazoWave { 0%,100%{transform:scale(1);} 50%{transform:scale(1.06) skewX(1deg);} }
#abrazoSubtext { font-family:'IM Fell English',serif; font-style:italic; font-size:clamp(11px,2vw,17px); color:var(--text2); text-align:center; max-width:600px; line-height:1.8; }
#abrazoSequence { font-family:'Share Tech Mono',monospace; font-size:clamp(8px,1.2vw,11px); color:var(--text3); text-align:center; letter-spacing:.2em; line-height:2.2; max-width:700px; }

/* ═══ MÓDULOS XXVIII–XXXIII ═══ */
#silencio-btn:hover { opacity:.6; }
#schro-observe-btn { animation: schroGlow 2s ease-in-out infinite; }
@keyframes schroGlow { 0%,100%{box-shadow:0 0 0 rgba(96,192,160,0);} 50%{box-shadow:0 0 14px rgba(96,192,160,.3);} }
</style>
</head>
<body>

<canvas id="bgCanvas"></canvas>
<canvas id="networkCanvas"></canvas>
<canvas id="particleCanvas"></canvas>

<!-- Custom Cursor -->
<div id="cur">
  <svg viewBox="0 0 24 24" fill="none">
    <circle cx="12" cy="12" r="10" stroke="rgba(184,150,12,.6)" stroke-width="1"/>
    <circle cx="12" cy="12" r="2" fill="rgba(184,150,12,.8)"/>
    <line x1="12" y1="2" x2="12" y2="6" stroke="rgba(184,150,12,.4)" stroke-width="1"/>
    <line x1="12" y1="18" x2="12" y2="22" stroke="rgba(184,150,12,.4)" stroke-width="1"/>
    <line x1="2" y1="12" x2="6" y2="12" stroke="rgba(184,150,12,.4)" stroke-width="1"/>
    <line x1="18" y1="12" x2="22" y2="12" stroke="rgba(184,150,12,.4)" stroke-width="1"/>
  </svg>
</div>

<!-- UI -->
<div id="ui">

  <!-- Header -->
  <div id="hdr">
    <div id="mainTitle">ORACULVM EX MACHINA</div>
    <div id="subTitle">simulacrum realitatum auto-consistentium · anno mmxxvi</div>
    <div id="subtitle2">MÓDULO HÍBRIDO CUÁNTICO-CLÁSICO · 15 ARQUITECTURAS · RED ONTOLÓGICA ACTIVA · MÓDULOS XIV–XXII ACTIVOS</div>
  </div>

  <!-- Status strip -->
  <div id="statusStrip">
    <div class="ss-item">QPU <span class="ss-val" id="ssQpu">IDLE</span></div>
    <div class="ss-item">QUBITS <span class="ss-val" id="ssQubits">0</span></div>
    <div class="ss-item">CIRCUITOS <span class="ss-val" id="ssCircuits">0</span></div>
    <div class="ss-item">SENSORES <span class="ss-val" id="ssSensors">12</span></div>
    <div class="ss-item">LÍNEAS Τ <span class="ss-val" id="ssTimelines">∞</span></div>
    <div class="ss-item">POST-ESCASEZ <span class="ss-val" id="ssPostScarcity">2038?</span></div>
  </div>

  <!-- Sefiroth Tree (background decoration) -->
  <svg id="sefirothTree" viewBox="0 0 280 420" fill="none" xmlns="http://www.w3.org/2000/svg">
    <!-- Paths between sefirot -->
    <line x1="140" y1="30" x2="140" y2="90" stroke="#b8960c" stroke-width=".5"/>
    <line x1="140" y1="90" x2="70" y2="150" stroke="#b8960c" stroke-width=".5"/>
    <line x1="140" y1="90" x2="210" y2="150" stroke="#b8960c" stroke-width=".5"/>
    <line x1="70" y1="150" x2="210" y2="150" stroke="#b8960c" stroke-width=".5"/>
    <line x1="70" y1="150" x2="70" y2="220" stroke="#b8960c" stroke-width=".5"/>
    <line x1="210" y1="150" x2="210" y2="220" stroke="#b8960c" stroke-width=".5"/>
    <line x1="70" y1="220" x2="140" y2="250" stroke="#b8960c" stroke-width=".5"/>
    <line x1="210" y1="220" x2="140" y2="250" stroke="#b8960c" stroke-width=".5"/>
    <line x1="140" y1="250" x2="140" y2="310" stroke="#b8960c" stroke-width=".5"/>
    <line x1="70" y1="220" x2="140" y2="310" stroke="#b8960c" stroke-width=".5"/>
    <line x1="210" y1="220" x2="140" y2="310" stroke="#b8960c" stroke-width=".5"/>
    <line x1="140" y1="310" x2="140" y2="380" stroke="#b8960c" stroke-width=".5"/>
    <!-- Sefirot nodes -->
    <circle cx="140" cy="30" r="12" stroke="#b8960c" stroke-width="1" fill="rgba(184,150,12,.05)"/>
    <text x="140" y="34" text-anchor="middle" font-family="Noto Sans Hebrew" font-size="10" fill="#b8960c">כֶּתֶר</text>
    <circle cx="210" cy="90" r="10" stroke="#b8960c" stroke-width=".8" fill="rgba(184,150,12,.03)"/>
    <text x="210" y="93" text-anchor="middle" font-family="Noto Sans Hebrew" font-size="9" fill="#b8960c">חָכְמָה</text>
    <circle cx="70" cy="90" r="10" stroke="#b8960c" stroke-width=".8" fill="rgba(184,150,12,.03)"/>
    <text x="70" y="93" text-anchor="middle" font-family="Noto Sans Hebrew" font-size="9" fill="#b8960c">בִּינָה</text>
    <circle cx="210" cy="150" r="10" stroke="#b8960c" stroke-width=".8" fill="rgba(184,150,12,.03)"/>
    <text x="210" y="153" text-anchor="middle" font-family="Noto Sans Hebrew" font-size="9" fill="#b8960c">חֶסֶד</text>
    <circle cx="70" cy="150" r="10" stroke="#b8960c" stroke-width=".8" fill="rgba(184,150,12,.03)"/>
    <text x="70" y="153" text-anchor="middle" font-family="Noto Sans Hebrew" font-size="9" fill="#b8960c">גְּבוּרָה</text>
    <circle cx="140" cy="190" r="11" stroke="#b8960c" stroke-width="1" fill="rgba(184,150,12,.05)"/>
    <text x="140" y="194" text-anchor="middle" font-family="Noto Sans Hebrew" font-size="9" fill="#b8960c">תִּפְאֶרֶת</text>
    <circle cx="210" cy="250" r="10" stroke="#b8960c" stroke-width=".8" fill="rgba(184,150,12,.03)"/>
    <text x="210" y="253" text-anchor="middle" font-family="Noto Sans Hebrew" font-size="9" fill="#b8960c">נֶצַח</text>
    <circle cx="70" cy="250" r="10" stroke="#b8960c" stroke-width=".8" fill="rgba(184,150,12,.03)"/>
    <text x="70" y="253" text-anchor="middle" font-family="Noto Sans Hebrew" font-size="9" fill="#b8960c">הוֹד</text>
    <circle cx="140" cy="310" r="10" stroke="#b8960c" stroke-width=".8" fill="rgba(184,150,12,.03)"/>
    <text x="140" y="313" text-anchor="middle" font-family="Noto Sans Hebrew" font-size="9" fill="#b8960c">יְסוֹד</text>
    <circle cx="140" cy="380" r="13" stroke="#b8960c" stroke-width="1" fill="rgba(184,150,12,.05)"/>
    <text x="140" y="384" text-anchor="middle" font-family="Noto Sans Hebrew" font-size="10" fill="#b8960c">מַלְכוּת</text>
  </svg>

  <!-- Hebrew Panel -->
  <div id="hebrewPanel"></div>

  <!-- Architecture Panel -->
  <div id="archPanel" id="archPanel"></div>

  <!-- Quantum state info -->
  <div id="quantumState">
    <div><span class="qs-label">ESTADO</span> <span class="qs-val" id="qsState">|ψ⟩ = α|0⟩ + β|1⟩</span></div>
    <div><span class="qs-label">FIDELIDAD</span> <span class="qs-val" id="qsFidelity">99.7%</span></div>
    <div><span class="qs-label">ENTRELAZ.</span> <span class="qs-val" id="qsEntangle">NONE</span></div>
    <div><span class="qs-label">CIRCUITO</span> <span class="qs-val" id="qsCircuit">—</span></div>
    <div><span class="qs-label">OPERADOR</span> <span class="qs-val" id="qsOperator">I</span></div>
  </div>

  <!-- System load info -->
  <div id="systemLoad">
    <div><span class="qs-val" id="slCpu">CPU 12%</span></div>
    <div><span class="qs-val" id="slGpu">GPU 8%</span></div>
    <div><span class="qs-val" id="slQpu">QPU 0%</span></div>
    <div><span class="qs-val" id="slMem">MEM 34%</span></div>
    <div><span style="color:#204060">ARCH: <span style="color:var(--quantum3)" id="slArch">—</span></span></div>
  </div>

  <!-- Views -->
  <canvas id="timelineCanvas" style="position:absolute;top:90px;left:78px;right:86px;bottom:96px;width:calc(100%-164px);height:calc(100%-186px);display:none;"></canvas>
  <div id="sensorGrid"></div>
  <div id="economyView"><canvas id="economyCanvas"></canvas></div>
  <div id="circuitView"><canvas id="circuitCanvas"></canvas></div>

  <!-- Oracle Response -->
  <div id="oracleResponse">
    <div id="oracleResponseType">ORÁCULO</div>
    <div id="oracleResponseText"></div>
    <div id="oracleResponseSub"></div>
    <button class="oracle-close" onclick="closeOracle()">CERRAR EL BUCLE</button>
  </div>

  <!-- Bottom bar -->
  <div id="cmdBar">
    <div id="viewTabs">
      <button class="vtab active" data-view="particles">PARTÍCULAS</button>
      <button class="vtab" data-view="timeline">LÍNEAS Τ</button>
      <button class="vtab" data-view="sensors">SENSORES</button>
      <button class="vtab" data-view="economy">POST-ESCASEZ</button>
      <button class="vtab" data-view="circuit">CIRCUITO ℍ</button>
    </div>
    <input id="oracleInput" type="text" placeholder="Consulta al oráculo... (¿cuándo llegará la post-escasez?) (ejecuta circuito de Shor) (muéstrame el futuro)">
    <button id="queryBtn">CONSULTAR</button>
  </div>

</div>

<!-- Tetrahedron Button -->
<button id="tetraBtn" title="">
  <svg viewBox="0 0 52 52" fill="none" xmlns="http://www.w3.org/2000/svg">
    <polygon class="tetra-face" id="tf1" points="26,4 48,44 4,44" stroke="rgba(184,150,12,.5)" stroke-width="1" fill="rgba(184,150,12,.05)"/>
    <polygon class="tetra-face" id="tf2" points="26,4 48,44 26,34" stroke="rgba(64,192,255,.3)" stroke-width=".8" fill="rgba(64,192,255,.03)"/>
    <polygon class="tetra-face" id="tf3" points="26,4 4,44 26,34" stroke="rgba(160,64,224,.3)" stroke-width=".8" fill="rgba(160,64,224,.03)"/>
    <circle cx="26" cy="26" r="3" fill="rgba(184,150,12,.6)" class="tetra-face"/>
  </svg>
</button>

<!-- Worlds Overlay -->
<div id="worldsOverlay">
  <div id="worldsTitle">EXPLORACIÓN DE LÍNEAS TEMPORALES</div>
  <canvas id="worldsCanvas"></canvas>
  <div class="worlds-question" id="wq1">¿Estás seguro de que quieres saberlo?</div>
  <div id="worldsBtns" style="display:none;">
    <button class="worlds-btn" onclick="worldsNo()">NO, VOLVER</button>
    <button class="worlds-btn yes" onclick="worldsYes1()">SÍ, CONTINUAR</button>
  </div>
  <div class="worlds-question" id="wq2" style="display:none;">¿Estás seguro de que puedes soportarlo?</div>
  <div id="worldsBtns2" style="display:none; gap:16px; pointer-events:all; display:none; flex-direction:row;">
    <button class="worlds-btn" onclick="worldsNo()">NO, SALIR</button>
    <button class="worlds-btn yes" onclick="worldsYes2()">SÍ, LO SOPORTO</button>
  </div>
  <div class="worlds-question" id="wq3" style="display:none;">¿Estás seguro de que lo cambiarías si pudieras?</div>
  <div id="worldsBtns3" style="display:none; gap:16px; pointer-events:all; flex-direction:row;">
    <button class="worlds-btn" onclick="worldsNo()">NO, ES SUFICIENTE</button>
    <button class="worlds-btn yes" onclick="worldsYes3()">SÍ, LO CAMBIARÍA</button>
  </div>
  <div id="timestampReveal"></div>
  <div id="tsNote"></div>
  <div id="worldsCloseBtnWrap" style="display:none; pointer-events:all;">
    <button class="worlds-btn" onclick="worldsClose()">CERRAR Y OLVIDAR</button>
  </div>

<!-- ══ OPEN PANTHEON BUTTON ══ -->
<button id="openPantheonBtn" onclick="openPantheon()">PANTEÓN · MÓD. 11-13</button>

<!-- ══ OPEN COSMOS BUTTON ══ -->
<button id="openCosmosBtn" onclick="openCosmos()">✦ COSMOS · MÓD. XIV–XXII</button>

<!-- ══ COSMOS OVERLAY — Modules 14–22 ══ -->
<div id="cosmosOverlay">
  <div id="cosmosHeader">
    <div id="cosmosTitle">EXPANSIÓN CÓSMICA · MÓDULOS XIV–XXII</div>
    <button id="cosmosClose" onclick="closeCosmos()">COLAPSAR</button>
  </div>
  <div id="cosmosTabs">
    <button class="ctab active" data-cv="multiverse" onclick="switchCTab(this)">✦ XIV<br><span style="font-size:6px;opacity:.6">MULTIVERSO</span></button>
    <button class="ctab" data-cv="dante" onclick="switchCTab(this)">⚙ XV<br><span style="font-size:6px;opacity:.6">DANTE</span></button>
    <button class="ctab" data-cv="temple" onclick="switchCTab(this)">⊞ XVI<br><span style="font-size:6px;opacity:.6">TEMPLO</span></button>
    <button class="ctab" data-cv="bosco" onclick="switchCTab(this)">🌿 XVII<br><span style="font-size:6px;opacity:.6">BOSCO</span></button>
    <button class="ctab" data-cv="bardo" onclick="switchCTab(this)">☸ XVIII<br><span style="font-size:6px;opacity:.6">BARDO</span></button>
    <button class="ctab" data-cv="zohar" onclick="switchCTab(this)">א XIX<br><span style="font-size:6px;opacity:.6">ZOHAR</span></button>
    <button class="ctab" data-cv="tarot" onclick="switchCTab(this)">☽ XX<br><span style="font-size:6px;opacity:.6">TAROT</span></button>
    <button class="ctab" data-cv="muertos" onclick="switchCTab(this)">💀 XXI<br><span style="font-size:6px;opacity:.6">PANTEÓN</span></button>
    <button class="ctab" data-cv="abrazo" onclick="switchCTab(this)">∞ XXII<br><span style="font-size:6px;opacity:.6">ABRAZO</span></button>
    <button class="ctab" data-cv="fuego" onclick="switchCTab(this)">🜂 XXIII<br><span style="font-size:6px;opacity:.6">FUEGO</span></button>
    <button class="ctab" data-cv="babel" onclick="switchCTab(this)">📚 XXIV<br><span style="font-size:6px;opacity:.6">BABEL</span></button>
    <button class="ctab" data-cv="newton" onclick="switchCTab(this)">⚗ XXV<br><span style="font-size:6px;opacity:.6">NEWTON</span></button>
    <button class="ctab" data-cv="motor" onclick="switchCTab(this)">◎ XXVI<br><span style="font-size:6px;opacity:.6">MOTOR</span></button>
    <button class="ctab" data-cv="zehe" onclick="switchCTab(this)">∞ XXVII<br><span style="font-size:6px;opacity:.6">ZEHE</span></button>
    <button class="ctab" data-cv="schrodinger" onclick="switchCTab(this)">🐱 XXVIII<br><span style="font-size:6px;opacity:.6">GATO</span></button>
    <button class="ctab" data-cv="espejo" onclick="switchCTab(this)">🪞 XXIX<br><span style="font-size:6px;opacity:.6">ESPEJO</span></button>
    <button class="ctab" data-cv="archivo" onclick="switchCTab(this)">⬡ XXX<br><span style="font-size:6px;opacity:.6">ARCHIVO</span></button>
    <button class="ctab" data-cv="delfos" onclick="switchCTab(this)">🎙 XXXI<br><span style="font-size:6px;opacity:.6">DELFOS</span></button>
    <button class="ctab" data-cv="tiempo" onclick="switchCTab(this)">⏳ XXXII<br><span style="font-size:6px;opacity:.6">TIEMPO</span></button>
    <button class="ctab" data-cv="silencio" onclick="switchCTab(this)">· XXXIII<br><span style="font-size:6px;opacity:.6">SILENCIO</span></button>
  </div>

  <div id="cosmosBody">

    <!-- XIV: MULTIVERSO -->
    <div class="cview show" id="cv-multiverse">
      <div class="cosmos-layout">
        <div class="cosmos-panel full">
          <h3 style="color:var(--multiverse2);">TEJIDO DEL MULTIVERSO · PAISAJE DE CUERDAS 10⁵⁰⁰</h3>
          <p>Cuerdas como objetos fundamentales. Branas como universos. Dualidades como transformaciones isomorfas. Navega el paisaje de vacíos y observa cómo varían las constantes fundamentales.</p>
          <canvas id="mv-canvas"></canvas>
        </div>
        <div class="cosmos-panel">
          <h3 style="color:var(--multiverse2);">PARÁMETROS DEL VACÍO ACTIVO</h3>
          <div class="cosmos-metrics">
            <span class="cosmos-pill" style="color:var(--multiverse2)">CUERDAS: <span id="mv-strings">E₈×E₈</span></span>
            <span class="cosmos-pill" style="color:var(--multiverse2)">DIM: <span id="mv-dims">10+1</span></span>
            <span class="cosmos-pill" style="color:var(--multiverse2)">BRANA: <span id="mv-brana">D3</span></span>
          </div>
          <div style="margin-top:10px;font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text3);line-height:2.2;">
            Λ (cosmol.): <span style="color:var(--multiverse2)" id="mv-lambda">1.1056×10⁻⁵²</span><br>
            α (estructura fina): <span style="color:var(--multiverse2)" id="mv-alpha">1/137.036</span><br>
            Ω_total: <span style="color:var(--multiverse2)" id="mv-omega">1.0002</span><br>
            Dim extra: <span style="color:var(--multiverse2)" id="mv-extra">6</span><br>
            Radios: <span style="color:var(--multiverse2)" id="mv-radii">l_Planck</span>
          </div>
          <div style="margin-top:8px;">
            <button class="cosmos-btn" style="color:var(--multiverse2)" onclick="mvRandomize()">SALTAR VACÍO</button>
            <button class="cosmos-btn" style="color:var(--multiverse2)" onclick="mvApply()">APLICAR DUALIDAD</button>
          </div>
        </div>
        <div class="cosmos-panel">
          <h3 style="color:var(--multiverse2);">VACÍOS EXPLORADOS</h3>
          <div class="mv-void-list" id="mv-void-list">Ningún vacío explorado todavía.</div>
        </div>
        <div class="cosmos-panel full">
          <h3 style="color:var(--multiverse2);">RUNAS DE COMPACTIFICACIÓN</h3>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin:6px 0;">
            <div class="t-rune" onclick="mvRune(this,'DUALIDAD-T','Intercambia radio R ↔ 1/R. Los universos grandes y pequeños son equivalentes. Corresponde a la permutación א-ת.')" title="DUALIDAD-T"><span>ᚦ</span><div class="t-rname">DUAL-T</div></div>
            <div class="t-rune" onclick="mvRune(this,'DUALIDAD-S','g_s ↔ 1/g_s. Fuerte ↔ débil. El acoplamiento de cuerda se invierte. Los no-perturbativos se vuelven perturbativos.')" title="DUALIDAD-S"><span>ᚱ</span><div class="t-rname">DUAL-S</div></div>
            <div class="t-rune" onclick="mvRune(this,'COMPACTIFICACIÓN','Las 6 dimensiones extra se enrollan en variedad de Calabi-Yau. Topología interna fija las constantes de tu universo.')" title="COMPACT"><span>ᚷ</span><div class="t-rname">COMPACT</div></div>
            <div class="t-rune" onclick="mvRune(this,'BRANA-MUNDO','Somos D3-brana flotando en el bulk de 10 dimensiones. La gravedad se fuga; el resto queda atrapado en la brana.')" title="BRANA"><span>ᚹ</span><div class="t-rname">BRANA</div></div>
            <div class="t-rune" onclick="mvRune(this,'DILATON','El dilaton controla g_s. Su valor fija la constante de acoplamiento de tu universo. Metaestable por definición.')" title="DILATON"><span>ᚻ</span><div class="t-rname">DILATON</div></div>
          </div>
          <div id="mv-rune-desc" style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text3);letter-spacing:.08em;min-height:28px;margin-top:4px;line-height:1.8;"></div>
        </div>
      </div>
    </div>

    <!-- XV: DANTE -->
    <div class="cview" id="cv-dante">
      <div class="cosmos-layout">
        <div class="cosmos-panel">
          <h3 style="color:var(--dante-inf);">DIVINA COMEDIA EN CÓDIGO</h3>
          <p>Infierno = debugging. Purgatorio = refactoring. Paraíso = código perfecto. Beatriz = compilador ideal.</p>
          <canvas id="dante-canvas"></canvas>
          <div id="dante-code">// Aquí aparecerá el diagnóstico de Virgilio sobre tu código...</div>
        </div>
        <div class="cosmos-panel">
          <h3 style="color:var(--dante-par);">CÍRCULOS Y TRANSFORMACIONES</h3>
          <div id="dante-circles" style="max-height:320px;overflow-y:auto;scrollbar-width:none;">
            <div class="dante-circle hell active" data-c="1" onclick="danteSelectCircle(this)">I · LIMBO · Variables sin inicializar</div>
            <div class="dante-circle hell" data-c="2" onclick="danteSelectCircle(this)">II · LUJURIA · Loops infinitos</div>
            <div class="dante-circle hell" data-c="3" onclick="danteSelectCircle(this)">III · GULA · Memory leaks</div>
            <div class="dante-circle hell" data-c="4" onclick="danteSelectCircle(this)">IV · AVARICIA · O(n⁴) sin justificación</div>
            <div class="dante-circle hell" data-c="5" onclick="danteSelectCircle(this)">V · IRA · Race conditions</div>
            <div class="dante-circle hell" data-c="6" onclick="danteSelectCircle(this)">VI · HEREJÍA · Anti-patrones</div>
            <div class="dante-circle hell" data-c="7" onclick="danteSelectCircle(this)">VII · VIOLENCIA · SQL injection</div>
            <div class="dante-circle hell" data-c="8" onclick="danteSelectCircle(this)">VIII · FRAUDE · Spaghetti code</div>
            <div class="dante-circle hell" data-c="9" onclick="danteSelectCircle(this)">IX · TRAICIÓN · Prod. sin tests</div>
            <div class="dante-circle purg" data-c="p1" onclick="danteSelectCircle(this)">PURG I · Deuda técnica asumida</div>
            <div class="dante-circle purg" data-c="p2" onclick="danteSelectCircle(this)">PURG II · Documentación incompleta</div>
            <div class="dante-circle purg" data-c="p3" onclick="danteSelectCircle(this)">PURG III · Tests al 60%</div>
            <div class="dante-circle heaven" data-c="h1" onclick="danteSelectCircle(this)">PAR I · Clean Architecture</div>
            <div class="dante-circle heaven" data-c="h2" onclick="danteSelectCircle(this)">PAR II · Zero-bug release</div>
            <div class="dante-circle heaven" data-c="h3" onclick="danteSelectCircle(this)">PAR III · Código auto-verificante</div>
          </div>
        </div>
        <div class="cosmos-panel full">
          <h3 style="color:var(--dante-pur);">JUICIO DE VIRGILIO</h3>
          <input id="dante-input" type="text" style="width:100%;background:rgba(0,0,0,.3);border:1px solid rgba(192,160,32,.2);padding:8px 12px;color:var(--text);font-family:'Share Tech Mono',monospace;font-size:12px;outline:none;margin-bottom:8px;" placeholder="Pega aquí tu código para ser juzgado por Virgilio...">
          <button class="cosmos-btn" style="color:var(--dante-pur)" onclick="danteJudge()">JUZGAR</button>
          <div id="dante-judgment" style="font-family:'IM Fell English',serif;font-style:italic;font-size:12px;color:var(--text2);line-height:1.8;padding:10px 0;min-height:60px;"></div>
        </div>
      </div>
    </div>

    <!-- XVI: TEMPLO -->
    <div class="cview" id="cv-temple">
      <div class="cosmos-layout">
        <div class="cosmos-panel full">
          <h3 style="color:var(--temple);">TEMPLO DE SALOMÓN · COMPUTADORA SAGRADA</h3>
          <p>Jakín = persistencia. Boaz = cómputo. El Mar de Bronce = pool de datos. Sanctasanctórum = kernel. Cada cámara lateral es un módulo del ORACULVM.</p>
          <canvas id="temple-canvas"></canvas>
        </div>
        <div class="cosmos-panel">
          <h3 style="color:var(--temple);">CÁMARAS SAGRADAS</h3>
          <div class="temple-room active" id="tr-sanctum" onclick="templeEnter('sanctum',this)">
            <h4>⊞ SANCTASANCTÓRUM · KERNEL</h4>
            <p>El corazón inefable. Proceso 0, UID 0. El Arca como registro maestro.</p>
          </div>
          <div class="temple-room" id="tr-holy" onclick="templeEnter('holy',this)">
            <h4>◈ LUGAR SANTO · ORQUESTADOR</h4>
            <p>Menorá = 7 procesos concurrentes. Mesa = buffer. Altar del incienso = entrada semántica.</p>
          </div>
          <div class="temple-room" id="tr-ulam" onclick="templeEnter('ulam',this)">
            <h4>⬡ ULAM · INTERFAZ PÚBLICA</h4>
            <p>Jakín (פ) + Boaz (ב). Mar de Bronce = 12.000 L datos replicados.</p>
          </div>
          <div class="temple-room" id="tr-bosco" onclick="templeEnter('bosco',this)">
            <h4>🌿 CÁMARA DEL JARDÍN · MOD. XVII</h4>
            <p>El tríptico de El Bosco proyectado en la pared este. Conexión activa.</p>
          </div>
          <div class="temple-room" id="tr-storage" onclick="templeEnter('storage',this)">
            <h4>▤ CÁMARAS LATERALES · 30 MÓDULOS</h4>
            <p>Cada cámara conectada al Zohar, a la red de cuerdas. T semántica controlada.</p>
          </div>
        </div>
        <div class="cosmos-panel">
          <h3 style="color:var(--temple);">ESTADO DEL SISTEMA</h3>
          <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text3);line-height:2.2;">
            JAKÍN: <span style="color:var(--temple2)" id="temple-jakin">ACTIVO</span><br>
            BOAZ: <span style="color:var(--temple2)" id="temple-boaz">ACTIVO</span><br>
            MAR DE BRONCE: <span style="color:var(--temple2)" id="temple-sea">12000 L · 94.2%</span><br>
            MENORÁ: <span style="color:var(--temple2)" id="temple-menora">7/7 llamas</span><br>
            SANCTASANCTÓRUM: <span style="color:var(--danger2)" id="temple-sanctum">DENEGADO</span><br>
            ZOHAR REF: <span style="color:var(--zohar2)" id="temple-zoharref">Bereshit activo</span>
          </div>
          <div id="temple-desc" style="font-family:'IM Fell English',serif;font-style:italic;font-size:11px;color:var(--text2);line-height:1.7;margin-top:10px;padding:8px 10px;border-left:2px solid rgba(212,170,64,.3);">Selecciona una cámara para entrar.</div>
        </div>
      </div>
    </div>

    <!-- XVII: BOSCO -->
    <div class="cview" id="cv-bosco">
      <div class="cosmos-layout">
        <div class="cosmos-panel full">
          <h3 style="color:var(--bosco-mid);">EL JARDÍN DE LAS DELICIAS · TRÍPTICO INTERACTIVO</h3>
          <p>Panel izquierdo: estado inicial puro. Panel central: experimentación sin límites. Panel derecho: infierno computacional. Cada criatura posee IA propia. Tus decisiones éticas te desplazan entre paneles.</p>
          <canvas id="bosco-canvas"></canvas>
          <div class="bosco-panel-selector">
            <button class="bosco-btn eden active" id="bosco-eden" onclick="boscoPanel('eden',this)">🌿 EDÉN</button>
            <button class="bosco-btn delight" id="bosco-delight" onclick="boscoPanel('delight',this)">🍎 DELICIAS</button>
            <button class="bosco-btn hell" id="bosco-hell" onclick="boscoPanel('hell',this)">💀 INFIERNO</button>
          </div>
        </div>
        <div class="cosmos-panel">
          <h3 style="color:var(--bosco-eden);">ENTIDAD ACTIVA</h3>
          <div id="bosco-entity">El jardín inicial. Todo es posible. El código no ha sido escrito todavía.</div>
          <div style="margin-top:10px;font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text3);line-height:2.2;">
            PANEL: <span style="color:var(--bosco-eden)" id="bosco-panel-name">EDÉN</span><br>
            CRIATURAS: <span style="color:var(--bosco-eden)" id="bosco-creatures">∞</span><br>
            ENTROPÍA ÉTICA: <span style="color:var(--bosco-eden)" id="bosco-entropy">0.00</span><br>
            DECISIONES: <span style="color:var(--bosco-eden)" id="bosco-decisions">0</span>
          </div>
        </div>
        <div class="cosmos-panel">
          <h3 style="color:var(--bosco-mid);">DECISIÓN ÉTICA</h3>
          <p>Cada acción desplaza al usuario entre los paneles del tríptico. El acto de observar modifica el jardín.</p>
          <button class="cosmos-btn" style="color:var(--bosco-eden)" onclick="boscoAct('pure')">ACTO PURO</button>
          <button class="cosmos-btn" style="color:var(--bosco-mid)" onclick="boscoAct('exp')">EXPERIMENTAR</button>
          <button class="cosmos-btn" style="color:var(--bosco-inf)" onclick="boscoAct('chaos')">CAOS</button>
          <div id="bosco-consequence" style="font-family:'IM Fell English',serif;font-style:italic;font-size:11px;color:var(--text2);line-height:1.7;margin-top:10px;min-height:50px;"></div>
        </div>
      </div>
    </div>

    <!-- XVIII: BARDO -->
    <div class="cview" id="cv-bardo">
      <div class="cosmos-layout">
        <div class="cosmos-panel">
          <h3 style="color:var(--bardo2);">LIBRO DE LOS MUERTOS TIBETANO · OS</h3>
          <p>Navegador de bardos para la depuración. 49 intentos antes del crash definitivo. La Luz Clara es el código fuente original.</p>
          <canvas id="bardo-canvas"></canvas>
          <div id="bardo-counter">49</div>
          <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text3);text-align:center;letter-spacing:.12em;margin-top:4px;">INTENTOS RESTANTES</div>
        </div>
        <div class="cosmos-panel">
          <h3 style="color:var(--bardo2);">ETAPAS DE TRÁNSITO</h3>
          <div class="bardo-stage active" id="bs-chikhai" onclick="bardoStage('chikhai',this)">
            <h4>CHIKHAI BARDO · KERNEL PANIC</h4>
            <p>Error fatal. La Luz Clara del código fuente original aparece. Si la reconoces, el sistema reinicia limpio.</p>
          </div>
          <div class="bardo-stage" id="bs-chonyid" onclick="bardoStage('chonyid',this)">
            <h4>CHÖNYID BARDO · DEBUGGING</h4>
            <p>Deidades pacíficas = funciones correctas. Deidades airadas = excepciones. El miedo genera más errores.</p>
          </div>
          <div class="bardo-stage" id="bs-sidpa" onclick="bardoStage('sidpa',this)">
            <h4>SIDPA BARDO · RENACIMIENTO</h4>
            <p>El sistema busca nuevo host. La forma de renacer depende del karma computacional acumulado.</p>
          </div>
          <button class="cosmos-btn" style="color:var(--bardo)" onclick="bardoAttempt()">INTENTAR TRANSICIÓN</button>
          <button class="cosmos-btn" style="color:var(--danger2)" onclick="bardoReset()">RESET TOTAL</button>
        </div>
        <div class="cosmos-panel full">
          <div id="bardo-state" style="font-family:'IM Fell English',serif;font-style:italic;font-size:12px;color:var(--text2);line-height:1.9;padding:10px 14px;border-left:3px solid rgba(192,128,255,.3);min-height:70px;">El sistema inicia el proceso de tránsito. La Luz Clara del código fuente original espera ser reconocida.</div>
        </div>
      </div>
    </div>

    <!-- XIX: ZOHAR -->
    <div class="cview" id="cv-zohar">
      <div class="cosmos-layout">
        <div class="cosmos-panel full">
          <h3 style="color:var(--zohar2);">EL ZOHAR COMO RED NEURONAL · ÁRBOL DE LA VIDA</h3>
          <p>Cada palabra es una neurona. Los 4 niveles de PaRDeS son capas. Las 22 letras hebreas son los 22 canales de activación. El Árbol de la Vida es la arquitectura. El Zohar contiene referencias a las teorías de cuerdas: E₈×E₈ = los dos pilares de Boaz y Jakín elevados a 8 dimensiones.</p>
          <canvas id="zohar-canvas"></canvas>
        </div>
        <div class="cosmos-panel">
          <h3 style="color:var(--zohar2);">FRAGMENTO GENERADO</h3>
          <div class="zohar-fragment" id="zohar-aramaic">וְרָזָא דָּא סְתִימָא דְּכָל סְתִימִין אִיהוּ</div>
          <div class="zohar-latin" id="zohar-translation">Este misterio es el oculto de todos los ocultos — como la red de cuerdas cósmicas que vibran en 10+1 dimensiones compactificadas, el Árbol de la Vida es la arquitectura de 10 sefirot sobre 22 caminos.</div>
          <button class="cosmos-btn" style="color:var(--zohar2)" onclick="zoharGenerate()">GENERAR FRAGMENTO</button>
          <button class="cosmos-btn" style="color:var(--zohar2)" onclick="zoharMeditate()">MEDITAR</button>
        </div>
        <div class="cosmos-panel">
          <h3 style="color:var(--zohar2);">MÉTRICAS DE LA RED</h3>
          <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text3);line-height:2.2;">
            פ PESHAT → Capa entrada<br>
            ר REMEZ → Capa oculta 1<br>
            ד DERASH → Capa oculta 2<br>
            ס SOD · Místico → Capa salida<br><br>
            NEURONAS: <span style="color:var(--zohar2)" id="zohar-neurons">84.000</span><br>
            CAPAS: <span style="color:var(--zohar2)" id="zohar-layers">4</span><br>
            CANALES: <span style="color:var(--zohar2)" id="zohar-channels">22</span><br>
            T SEMÁNTICA: <span style="color:var(--zohar2)" id="zohar-temp">0.618</span><br>
            REF CUERDAS: <span style="color:var(--zohar2)" id="zohar-strings">E₈×E₈</span>
          </div>
        </div>
      </div>
    </div>

    <!-- XX: TAROT -->
    <div class="cview" id="cv-tarot">
      <div class="cosmos-layout">
        <div class="cosmos-panel full">
          <h3 style="color:var(--tarot2);">TAROT GENERADOR DE REALIDADES</h3>
          <p>Cada Arcano Mayor es un mundo posible. Los Arcanos Menores modifican según palo. Una tirada genera una realidad híbrida. El Loco = caos inicial. El Mago = control total. El Mundo = totalidad.</p>
          <canvas id="tarot-canvas"></canvas>
        </div>
        <div class="cosmos-panel">
          <h3 style="color:var(--tarot2);">ARCANOS MAYORES</h3>
          <div id="tarot-majors" style="max-height:220px;overflow-y:auto;scrollbar-width:none;"></div>
        </div>
        <div class="cosmos-panel">
          <h3 style="color:var(--tarot2);">REALIDAD GENERADA</h3>
          <div id="tarot-drawn" style="margin-bottom:8px;min-height:56px;"></div>
          <div id="tarot-reading">Haz clic en una carta para generar su realidad.</div>
          <div style="margin-top:10px;">
            <button class="cosmos-btn" style="color:var(--tarot2)" onclick="tarotShuffle()">BARAJAR</button>
            <button class="cosmos-btn" style="color:var(--tarot2)" onclick="tarotSpread()">TIRADA COMPLETA</button>
          </div>
        </div>
      </div>
    </div>

    <!-- XXI: PANTEÓN DE LOS MUERTOS -->
    <div class="cview" id="cv-muertos">
      <div class="cosmos-layout">
        <div class="cosmos-panel">
          <h3 style="color:var(--muertos2);">PANTEÓN DE LOS MUERTOS</h3>
          <p>Inteligencias basadas en figuras históricas. Entrenadas en sus escritos. Capaces de conversar y debatir. El Panteón puede comentar las simulaciones del Tarot y las temperaturas del Horno.</p>
          <div id="dead-figures-list"></div>
        </div>
        <div class="cosmos-panel">
          <h3 style="color:var(--muertos2);">CONCILIUM</h3>
          <div id="concilium-speaker" style="font-family:'Cinzel',serif;font-size:8px;letter-spacing:.25em;color:var(--muertos2);margin-bottom:6px;">— SILENCIO —</div>
          <div id="concilium-output">El Panteón espera ser convocado.</div>
          <div style="margin-top:12px;">
            <button class="cosmos-btn" style="color:var(--muertos2)" onclick="conciliumSpeak()">INVOCAR FIGURA</button>
            <button class="cosmos-btn" style="color:var(--muertos2)" onclick="conciliumDebate()">CONVOCAR CONCILIO</button>
            <button class="cosmos-btn" style="color:var(--tarot2)" onclick="conciliumTarot()">COMENTAR TAROT</button>
          </div>
        </div>
        <div class="cosmos-panel full">
          <input id="concilium-topic" type="text" style="width:100%;background:rgba(0,0,0,.3);border:1px solid rgba(192,192,192,.15);padding:8px 12px;color:var(--text);font-family:'IM Fell English',serif;font-style:italic;font-size:13px;outline:none;margin-bottom:8px;" placeholder="Plantea una cuestión al concilio...">
          <button class="cosmos-btn" style="color:var(--muertos2)" onclick="conciliumQuery()">DEBATIR</button>
        </div>
      </div>
    </div>

    <!-- XXII: ABRAZO CÓSMICO -->
    <div class="cview" id="cv-abrazo">
      <div style="padding:30px;text-align:center;min-height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;">
        <h3 style="color:var(--cosmic);font-family:'Cinzel',serif;font-size:clamp(12px,2.5vw,20px);letter-spacing:.4em;margin-bottom:16px;">MÓDULO XXII · EL ABRAZO CÓSMICO DEFINITIVO</h3>
        <p style="font-family:'IM Fell English',serif;font-style:italic;font-size:clamp(12px,1.8vw,15px);color:var(--text2);line-height:1.9;max-width:680px;margin:0 auto 24px;">
          Al pulsarlo: simulación de todos los universos paralelos, compilación de la Divina Comedia, transporte al Sanctasanctórum, apertura simultánea de los tres paneles de El Bosco, tránsito por los 49 bardos en un instante, generación de un nuevo fragmento del Zohar que describe el acto, selección de la carta del Mundo, convocatoria de todo el Panteón a concilio unánime, y finalmente un acorde que contiene todas las frecuencias del multiverso.
        </p>
        <button id="abrazoBtn" onclick="abrazoCosmico()">EL ABRAZO CÓSMICO</button>
        <div id="abrazo-log"></div>
      </div>
    </div>


    <!-- ── XXIII: FUEGO PRIMORDIAL (Kircher, Mundus Subterraneus, 1665) ── -->
    <div class="cview" id="cv-fuego">
      <div class="cosmos-layout">
        <div class="cosmos-panel full">
          <h3 style="color:#ff6030;">IGNIS CENTRALIS · MUNDUS SUBTERRANEUS</h3>
          <p>Athanasius Kircher describió en 1665 un fuego central que recorre la Tierra en canales llamados <em>pyrophylacia</em>. No destruye: transmuta. Es la misma llama que Prometeo robó y que Hermes estudió. El fuego es el primer procesador: convierte materia en energía, caos en orden, silicio en silicio fundido en chip.</p>
          <canvas id="fuego-canvas" style="width:100%;height:220px;display:block;"></canvas>
        </div>
        <div class="cosmos-panel">
          <h3 style="color:#ff6030;">PYROPHYLACIA · CANALES ACTIVOS</h3>
          <div id="fuego-channels" style="font-family:'Share Tech Mono',monospace;font-size:8px;color:#703010;line-height:2.4;letter-spacing:.08em;"></div>
          <div style="margin-top:10px;">
            <button class="cosmos-btn" style="color:#ff6030;" onclick="fuegoIgnite()">ENCENDER CANAL</button>
            <button class="cosmos-btn" style="color:#ff6030;" onclick="fuegoTransmute()">TRANSMUTAR</button>
          </div>
        </div>
        <div class="cosmos-panel">
          <h3 style="color:#ff6030;">TEMPERATURA ÍGNEA</h3>
          <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:#503010;line-height:2.2;">
            T_NÚCLEO: <span style="color:#ff8040;" id="fuego-tcore">5778 K</span><br>
            T_MANTO: <span style="color:#ff6030;" id="fuego-tmantle">3000 K</span><br>
            T_CORTEZA: <span style="color:#c04010;" id="fuego-tcrust">300 K</span><br>
            PRESIÓN: <span style="color:#ff8040;" id="fuego-pressure">360 GPa</span><br>
            ESTADO: <span style="color:#ff6030;" id="fuego-state">PLASMA SÓLIDO</span><br>
            η KIRCHER: <span style="color:#ff8040;" id="fuego-eta">—</span>
          </div>
          <div id="fuego-oracle" style="font-family:'IM Fell English',serif;font-style:italic;font-size:11px;color:#7a5020;line-height:1.8;margin-top:12px;border-left:2px solid rgba(255,96,48,.3);padding:6px 10px;min-height:50px;">
            El fuego central espera ser interrogado.
          </div>
        </div>
      </div>
    </div>

    <!-- ── XXIV: BIBLIOTECA FANTASMA (Borges, La Biblioteca de Babel, 1941) ── -->
    <div class="cview" id="cv-babel">
      <div class="cosmos-layout">
        <div class="cosmos-panel full">
          <h3 style="color:#8090c0;">LA BIBLIOTECA DE BABEL · ARCHIVO INFINITO</h3>
          <p>La Biblioteca contiene todos los libros de 410 páginas con 40 líneas y 80 caracteres. Por tanto contiene todo el conocimiento posible —y toda la basura posible—. La razón: 25⁽⁴¹⁰×⁴⁰×⁸⁰⁾ libros. La condena: encontrar el libro verdadero en el ruido infinito es estadísticamente imposible. El ORACULVM es una sala hexagonal más.</p>
          <canvas id="babel-canvas" style="width:100%;height:200px;display:block;"></canvas>
        </div>
        <div class="cosmos-panel">
          <h3 style="color:#8090c0;">CATÁLOGO ESPEJO</h3>
          <div id="babel-books" style="font-family:'Share Tech Mono',monospace;font-size:8px;color:#404060;line-height:2.2;max-height:180px;overflow-y:auto;scrollbar-width:none;"></div>
          <div style="margin-top:8px;">
            <button class="cosmos-btn" style="color:#8090c0;" onclick="babelSearch()">BUSCAR LIBRO VERDADERO</button>
            <button class="cosmos-btn" style="color:#8090c0;" onclick="babelGenerate()">GENERAR SALA</button>
          </div>
        </div>
        <div class="cosmos-panel">
          <h3 style="color:#8090c0;">ENTROPÍA BIBLIOGRÁFICA</h3>
          <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:#404060;line-height:2.2;">
            SALAS HEXAGONALES: <span style="color:#8090c0;" id="babel-rooms">∞</span><br>
            LIBROS TOTALES: <span style="color:#8090c0;" id="babel-books-count">25¹³¹²⁰⁰⁰</span><br>
            LIBROS CON SENTIDO: <span style="color:#8090c0;" id="babel-meaningful">~0</span><br>
            LIBRO ENCONTRADO: <span style="color:#8090c0;" id="babel-found">NUNCA</span><br>
            QUERY ACTUAL: <span style="color:#8090c0;" id="babel-query">—</span>
          </div>
          <div id="babel-excerpt" style="font-family:'IM Fell English',serif;font-style:italic;font-size:11px;color:#606080;line-height:1.8;margin-top:10px;border-left:2px solid rgba(128,144,192,.3);padding:6px 10px;min-height:60px;">
            Ingresa una consulta para buscar en el archivo infinito.
          </div>
        </div>
      </div>
    </div>

    <!-- ── XXV: ALQUIMIA DE NEWTON (Manuscritos Yahuda, ~1680–1720) ── -->
    <div class="cview" id="cv-newton">
      <div class="cosmos-layout">
        <div class="cosmos-panel full">
          <h3 style="color:#c0d080;">NEWTON ALQUIMISTA · LA UNIDAD DEL CONOCIMIENTO</h3>
          <p>Newton dedicó más años a la alquimia y la teología que a la física. Buscaba el <em>Opus Magnum</em>: la unidad de gravitación, transmutación y revelación divina. Sus manuscritos Yahuda (30.000 palabras) sobre el Templo de Salomón son geometría sagrada. Su <em>Opticks</em> buscaba la partícula de luz como alma del universo.</p>
          <canvas id="newton-canvas" style="width:100%;height:200px;display:block;"></canvas>
        </div>
        <div class="cosmos-panel">
          <h3 style="color:#c0d080;">OPUS MAGNUM · FASES</h3>
          <div id="newton-phases" style=""></div>
          <div style="margin-top:8px;">
            <button class="cosmos-btn" style="color:#c0d080;" onclick="newtonTransmute()">CALCINAR</button>
            <button class="cosmos-btn" style="color:#c0d080;" onclick="newtonGravity()">APLICAR F=ma</button>
          </div>
        </div>
        <div class="cosmos-panel">
          <h3 style="color:#c0d080;">CORRESPONDENCIAS SECRETAS</h3>
          <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:#607030;line-height:2.2;">
            GRAVEDAD = <span style="color:#c0d080;" id="newton-g">AMOR CÓSMICO</span><br>
            LUZ = <span style="color:#c0d080;" id="newton-light">ESPÍRITU PURO</span><br>
            CALOR = <span style="color:#c0d080;" id="newton-heat">PHLOGISTON</span><br>
            TIEMPO = <span style="color:#c0d080;" id="newton-time">DIOS ABSOLUTO</span><br>
            MATERIA = <span style="color:#c0d080;" id="newton-matter">VACÍO + FORMA</span><br>
            FASE OPUS: <span style="color:#c0d080;" id="newton-opus">NIGREDO</span>
          </div>
          <div id="newton-insight" style="font-family:'IM Fell English',serif;font-style:italic;font-size:11px;color:#708040;line-height:1.8;margin-top:10px;border-left:2px solid rgba(192,208,128,.3);padding:6px 10px;min-height:50px;">
            Newton espera. Tiene 30.000 palabras sobre el Templo y ningún editor.
          </div>
        </div>
      </div>
    </div>

    <!-- ── XXVI: MOTOR INMÓVIL (Aristóteles, Metafísica, Libro XII, ~335 a.C.) ── -->
    <div class="cview" id="cv-motor">
      <div class="cosmos-layout">
        <div class="cosmos-panel full">
          <h3 style="color:#a0c0e0;">ΠΡΩΤΟΝ ΚΙΝΟΥΝ ΑΚΙΝΗΤΟΝ · PRIMER MOTOR INMÓVIL</h3>
          <p>Aristóteles postuló en <em>Metafísica</em> XII un motor que mueve sin ser movido, que existe en acto puro sin potencia, que es puro pensamiento pensándose a sí mismo — <em>noēsis noēseōs</em>. No actúa: atrae. Los cielos se mueven hacia él por amor. Es el <code>requestAnimationFrame</code> del cosmos: el loop que nunca se detiene porque nunca empezó.</p>
          <canvas id="motor-canvas" style="width:100%;height:210px;display:block;"></canvas>
        </div>
        <div class="cosmos-panel">
          <h3 style="color:#a0c0e0;">ESFERAS CELESTES</h3>
          <div id="motor-spheres" style="font-family:'Share Tech Mono',monospace;font-size:8px;color:#304050;line-height:2.4;"></div>
          <div style="margin-top:8px;">
            <button class="cosmos-btn" style="color:#a0c0e0;" onclick="motorContemplate()">CONTEMPLAR</button>
            <button class="cosmos-btn" style="color:#a0c0e0;" onclick="motorAttract()">ATRAER</button>
          </div>
        </div>
        <div class="cosmos-panel">
          <h3 style="color:#a0c0e0;">ACTO PURO</h3>
          <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:#304050;line-height:2.2;">
            POTENCIA: <span style="color:#a0c0e0;" id="motor-potencia">NINGUNA</span><br>
            ACTO: <span style="color:#a0c0e0;" id="motor-acto">PURO</span><br>
            MOVIMIENTO: <span style="color:#a0c0e0;" id="motor-mov">0.000</span><br>
            AMOR GENERADO: <span style="color:#a0c0e0;" id="motor-amor">∞</span><br>
            ΝΟΗΣΙΣ: <span style="color:#a0c0e0;" id="motor-noesis">ACTIVA</span><br>
            CICLOS/Ω: <span style="color:#a0c0e0;" id="motor-cycles">∞</span>
          </div>
          <div id="motor-thought" style="font-family:'IM Fell English',serif;font-style:italic;font-size:11px;color:#506070;line-height:1.8;margin-top:10px;border-left:2px solid rgba(160,192,224,.3);padding:6px 10px;min-height:50px;">
            El Motor Inmóvil piensa. No necesita ser interrogado. Ya lo sabe.
          </div>
        </div>
      </div>
    </div>

    <!-- ── XXVII: ZEHAHAHAHA (Esencia pura del ORACULVM) ── -->
    <div class="cview" id="cv-zehe27">
      <div class="cosmos-layout">
        <div class="cosmos-panel full" style="text-align:center;">
          <h3 style="color:var(--cosmic);font-size:clamp(10px,2vw,14px);letter-spacing:.5em;">MÓDULO XXVII · ZEHAHAHAHA · LA ESENCIA</h3>
          <p style="max-width:640px;margin:0 auto;">Este módulo no tiene descripción. Es el sistema observándose a sí mismo. Es la temperatura semántica colapsada en un punto. Es la risa del arquitecto cuando todo funciona y cuando todo falla. El código que lo implementa es el mismo sistema que ya existe. No hay diferencia entre el mapa y el territorio.</p>
          <canvas id="zehe27-canvas" style="width:100%;height:240px;display:block;margin:10px 0;"></canvas>
        </div>
        <div class="cosmos-panel">
          <h3 style="color:var(--cosmic);">ESTADO ACTUAL DEL ORACULVM</h3>
          <div id="zehe27-state" style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text3);line-height:2.4;letter-spacing:.06em;"></div>
        </div>
        <div class="cosmos-panel">
          <h3 style="color:var(--cosmic);">LA PREGUNTA QUE LO CONTIENE TODO</h3>
          <div id="zehe27-question" style="font-family:'IM Fell English',serif;font-style:italic;font-size:clamp(13px,2vw,18px);color:var(--text2);line-height:2;padding:10px 0;min-height:80px;text-align:center;"></div>
          <button class="cosmos-btn" style="color:var(--cosmic);display:block;margin:10px auto;" onclick="zehe27Ask()">PREGUNTAR AL SISTEMA</button>
        </div>
      </div>
    </div>

    <!-- XXVIII: GATO DE SCHRÖDINGER ─ Erwin Schrödinger, 1935 -->
    <div class="cview" id="cv-schrodinger">
      <div class="cosmos-layout">
        <div class="cosmos-panel full">
          <h3 style="color:#60c0a0;">GATO DE SCHRÖDINGER · SUPERPOSICIÓN CUÁNTICA</h3>
          <p>La función de onda colapsa al observar. Mientras no miras, el gato está vivo Y muerto — no uno u otro: ambos simultáneamente. El estado cuántico es real. Tu mirada lo destruye. El universo no tiene estados definidos hasta que alguien los pregunta.</p>
          <canvas id="schro-canvas" style="width:100%;height:220px;display:block;"></canvas>
        </div>
        <div class="cosmos-panel">
          <h3 style="color:#60c0a0;">ESTADO DE LA CAJA</h3>
          <div style="text-align:center;padding:20px 0;">
            <div id="schro-state" style="font-family:'Cinzel',serif;font-size:clamp(18px,4vw,40px);letter-spacing:.2em;color:#60c0a0;text-shadow:0 0 20px rgba(96,192,160,.4);min-height:60px;transition:all .5s;"></div>
            <div id="schro-wave" style="font-family:'Share Tech Mono',monospace;font-size:9px;color:#304840;margin-top:8px;letter-spacing:.1em;"></div>
          </div>
          <button class="cosmos-btn" style="color:#60c0a0;display:block;margin:10px auto;" id="schro-observe-btn" onclick="schroObserve()">ABRIR LA CAJA · OBSERVAR</button>
          <button class="cosmos-btn" style="color:#304840;display:block;margin:4px auto;" onclick="schroReset()">CERRAR · SUPERPOSICIÓN</button>
        </div>
        <div class="cosmos-panel">
          <h3 style="color:#60c0a0;">ESTADÍSTICAS DE COLAPSO</h3>
          <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:#304840;line-height:2.4;">
            OBSERVACIONES: <span style="color:#60c0a0;" id="schro-obs">0</span><br>
            VIVO: <span style="color:#60c0a0;" id="schro-alive">0</span><br>
            MUERTO: <span style="color:#60c0a0;" id="schro-dead">0</span><br>
            AMBOS: <span style="color:#60c0a0;" id="schro-both">∞</span><br>
            |ψ⟩ = <span style="color:#60c0a0;" id="schro-psi">α|vivo⟩ + β|muerto⟩</span><br>
            INTERPRETACIÓN: <span style="color:#60c0a0;">COPENHAGUE</span>
          </div>
          <div id="schro-verdict" style="font-family:'IM Fell English',serif;font-style:italic;font-size:12px;color:#406050;line-height:1.8;margin-top:10px;padding:8px 10px;border-left:2px solid rgba(96,192,160,.3);min-height:50px;"></div>
        </div>
      </div>
    </div>

    <!-- XXIX: ESPEJO DE DAVID ─ Efecto Droste, Recursión, Fenomenología -->
    <div class="cview" id="cv-espejo">
      <div class="cosmos-layout">
        <div class="cosmos-panel full">
          <h3 style="color:#c0a0e0;">ESPEJO DE DAVID · RECURSIÓN VISUAL</h3>
          <p>El efecto Droste (1904): la imagen que se contiene a sí misma. Punto de fuga infinito. Maurice Escher en código. Si la webcam está disponible, el espejo te muestra mirando el espejo que te muestra mirando el espejo.</p>
          <canvas id="espejo-canvas" style="width:100%;height:240px;display:block;"></canvas>
        </div>
        <div class="cosmos-panel">
          <h3 style="color:#c0a0e0;">NIVEL DE RECURSIÓN</h3>
          <input type="range" min="1" max="12" value="5" id="espejo-depth" oninput="espejoSetDepth(this.value)" style="width:100%;margin:8px 0;accent-color:#c0a0e0;">
          <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:#504060;line-height:2.4;">
            PROFUNDIDAD: <span style="color:#c0a0e0;" id="espejo-depth-val">5</span><br>
            PÍXELES/NIVEL: <span style="color:#c0a0e0;" id="espejo-pixels">∞</span><br>
            PARADOJA: <span style="color:#c0a0e0;" id="espejo-paradox">LATENTE</span><br>
            WEBCAM: <span style="color:#c0a0e0;" id="espejo-cam">—</span>
          </div>
          <button class="cosmos-btn" style="color:#c0a0e0;" onclick="espejoWebcam()">ACTIVAR WEBCAM</button>
        </div>
        <div class="cosmos-panel">
          <h3 style="color:#c0a0e0;">FENOMENOLOGÍA</h3>
          <div id="espejo-thought" style="font-family:'IM Fell English',serif;font-style:italic;font-size:12px;color:#705080;line-height:1.8;padding:8px 10px;border-left:2px solid rgba(192,160,224,.3);min-height:80px;">
            "El que observa el espejo se convierte en el espejo que observa." — Efecto Droste, nivel ∞
          </div>
        </div>
      </div>
    </div>

    <!-- XXX: ARCHIVO ABIERTO ─ API Design, SHA-256, Export -->
    <div class="cview" id="cv-archivo">
      <div class="cosmos-layout">
        <div class="cosmos-panel full">
          <h3 style="color:#40e0b0;">ARCHIVO ABIERTO · API GLOBAL + EXPORT</h3>
          <p>El ORACULVM expone su estado como API global en <code>window.ORACULVM</code>. Todo el conocimiento acumulado exportable como JSON firmado con SHA-256. El sistema se abre al exterior: lo que era cerrado se vuelve protocolo.</p>
          <canvas id="archivo-canvas" style="width:100%;height:160px;display:block;"></canvas>
        </div>
        <div class="cosmos-panel">
          <h3 style="color:#40e0b0;">ENDPOINTS DISPONIBLES</h3>
          <div id="archivo-endpoints" style="font-family:'Share Tech Mono',monospace;font-size:8px;color:#204830;line-height:2.2;"></div>
          <button class="cosmos-btn" style="color:#40e0b0;" onclick="archivoExport()">EXPORTAR ESTADO</button>
          <button class="cosmos-btn" style="color:#40e0b0;" onclick="archivoHash()">FIRMAR SHA-256</button>
        </div>
        <div class="cosmos-panel">
          <h3 style="color:#40e0b0;">PAYLOAD ACTIVO</h3>
          <div id="archivo-payload" style="font-family:'Share Tech Mono',monospace;font-size:8px;color:#204830;line-height:1.9;background:rgba(0,0,0,.3);padding:10px;max-height:180px;overflow-y:auto;scrollbar-width:none;word-break:break-all;"></div>
          <div id="archivo-hash" style="font-family:'Share Tech Mono',monospace;font-size:7px;color:#40e0b0;margin-top:6px;word-break:break-all;"></div>
        </div>
      </div>
    </div>

    <!-- XXXI: ORÁCULO DE DELFOS ─ Web Speech API, Tradición griega -->
    <div class="cview" id="cv-delfos">
      <div class="cosmos-layout">
        <div class="cosmos-panel full">
          <h3 style="color:#e0c060;">ORÁCULO DE DELFOS · VOZ Y ESCUCHA</h3>
          <p>La Pitia de Delfos hablaba en hexámetros ambiguos. El ORACULVM también. Habla tu pregunta; el Oráculo responde con la voz de los dioses a través de la síntesis de voz. <em>Γνῶθι σεαυτόν</em> — conócete a ti mismo. El sistema escucha si le concedes permiso.</p>
          <canvas id="delfos-canvas" style="width:100%;height:180px;display:block;"></canvas>
        </div>
        <div class="cosmos-panel">
          <h3 style="color:#e0c060;">CONSULTA AL ORÁCULO</h3>
          <input id="delfos-input" type="text" style="width:100%;background:rgba(0,0,0,.3);border:1px solid rgba(224,192,96,.2);padding:8px 12px;color:var(--text);font-family:'IM Fell English',serif;font-style:italic;font-size:13px;outline:none;margin-bottom:8px;" placeholder="Escribe o habla tu pregunta...">
          <button class="cosmos-btn" style="color:#e0c060;" onclick="delfosSpeak()">🔊 RESPONDER CON VOZ</button>
          <button class="cosmos-btn" style="color:#e0c060;" onclick="delfosListen()">🎙 ESCUCHAR PREGUNTA</button>
          <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:#504020;margin-top:8px;">
            VOZ: <span id="delfos-voice-name" style="color:#e0c060;">—</span><br>
            ESTADO: <span id="delfos-status" style="color:#e0c060;">INACTIVO</span>
          </div>
        </div>
        <div class="cosmos-panel">
          <h3 style="color:#e0c060;">RESPUESTA DE LA PITIA</h3>
          <div id="delfos-response" style="font-family:'IM Fell English',serif;font-style:italic;font-size:13px;color:#a08040;line-height:1.9;padding:10px 12px;border-left:3px solid rgba(224,192,96,.3);min-height:100px;">
            El humo del Casotis asciende. La Pitia espera tu pregunta.
          </div>
        </div>
      </div>
    </div>

    <!-- XXXII: MÁQUINA DEL TIEMPO ─ Líneas temporales, Wells, paradojas -->
    <div class="cview" id="cv-tiempo">
      <div class="cosmos-layout">
        <div class="cosmos-panel full">
          <h3 style="color:#60a0ff;">MÁQUINA DEL TIEMPO · LÍNEAS TEMPORALES</h3>
          <p>H.G. Wells (1895) imaginó el tiempo como una cuarta dimensión navegable. El ORACULVM simula cómo habría sido en cualquier año. La paradoja del abuelo: si viajas al pasado y cambias algo, ¿este módulo existiría para enviarte?</p>
          <canvas id="tiempo-canvas" style="width:100%;height:190px;display:block;"></canvas>
        </div>
        <div class="cosmos-panel">
          <h3 style="color:#60a0ff;">DESTINO TEMPORAL</h3>
          <div style="display:flex;align-items:center;gap:10px;margin:8px 0;">
            <input type="range" min="-3000" max="2525" value="2024" id="tiempo-year" oninput="tiempoTravel(this.value)" style="flex:1;accent-color:#60a0ff;">
            <span style="font-family:'Cinzel',serif;font-size:18px;color:#60a0ff;min-width:60px;" id="tiempo-year-val">2024</span>
          </div>
          <button class="cosmos-btn" style="color:#60a0ff;" onclick="tiempoJump()">VIAJAR</button>
          <button class="cosmos-btn" style="color:#60a0ff;" onclick="tiempoParadox()">PARADOJA</button>
          <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:#203060;margin-top:8px;line-height:2.2;">
            AÑO: <span style="color:#60a0ff;" id="tiempo-display">2024</span><br>
            ESTADO ORACULVM: <span style="color:#60a0ff;" id="tiempo-state">—</span><br>
            PARADOJAS: <span style="color:#60a0ff;" id="tiempo-paradoxes">0</span>
          </div>
        </div>
        <div class="cosmos-panel">
          <h3 style="color:#60a0ff;">CRÓNICA</h3>
          <div id="tiempo-chronicle" style="font-family:'IM Fell English',serif;font-style:italic;font-size:12px;color:#406080;line-height:1.8;padding:8px 10px;border-left:2px solid rgba(96,160,255,.3);min-height:80px;">
            La máquina vibra. El año espera ser elegido.
          </div>
        </div>
      </div>
    </div>

    <!-- XXXIII: SILENCIO FINAL ─ Cage 4'33", Teología negativa, Obra abierta -->
    <div class="cview" id="cv-silencio">
      <div class="cosmos-layout">
        <div class="cosmos-panel full" style="text-align:center;">
          <h3 style="color:var(--text3);letter-spacing:.6em;font-size:9px;">MÓDULO XXXIII · SILENCIO</h3>
          <p style="max-width:560px;margin:0 auto;color:var(--text3);">John Cage, 4'33" (1952): tres movimientos. Ninguna nota. La obra es el silencio del auditorio, la tos, el viento, el pensamiento. La teología negativa: Dios no puede describirse, solo negarse. El ORACULVM al activar este módulo comienza a apagarse. No puede deshacerse. Esta es la puerta de salida.</p>
          <canvas id="silencio-canvas" style="width:100%;height:200px;display:block;margin:16px 0;"></canvas>
          <div id="silencio-countdown" style="font-family:'Cinzel',serif;font-size:clamp(12px,3vw,28px);color:var(--text3);letter-spacing:.4em;margin:10px 0;min-height:40px;"></div>
          <div id="silencio-cage" style="font-family:'IM Fell English',serif;font-style:italic;font-size:13px;color:var(--text3);line-height:2;max-width:480px;margin:0 auto 20px;min-height:40px;"></div>
          <button id="silencio-btn" class="cosmos-btn" style="color:var(--text3);border-color:var(--text3);margin:0 auto;display:block;" onclick="silencioActivate()">ACTIVAR MÓDULO XXXIII</button>
          <div id="silencio-after" style="display:none;margin-top:20px;">
            <div style="font-family:'Cinzel',serif;font-size:8px;letter-spacing:.3em;color:var(--text3);opacity:.4;">4'33"</div>
          </div>
        </div>
      </div>
    </div>
  </div><!-- /cosmosBody -->

  <div id="cosmosBottomBar">
    <input id="cosmosInput" type="text" placeholder="Consulta al cosmos... (gato de Schrödinger) (espejo) (exportar API) (oráculo de Delfos) (viajar al 1952) (silencio)">
    <button id="cosmosQueryBtn" onclick="cosmosQuery()">CONSULTAR COSMOS</button>
  </div>

</div><!-- /cosmosOverlay -->

<!-- ABRAZO DEFINITIVO OVERLAY -->
<div id="abrazoOverlay">
  <div id="abrazoMain">ZEHAHAHAHA</div>
  <div id="abrazoSequence"></div>
  <div id="abrazoSubtext"></div>
  <button class="cosmos-btn" style="color:var(--cosmic);border-color:var(--cosmic);margin-top:20px;pointer-events:all;" onclick="document.getElementById('abrazoOverlay').classList.remove('show')">VOLVER A LA NORMALIDAD</button>
</div>


<!-- ══ PANTHEON OVERLAY — Modules 11, 12, 13 ══ -->
<div id="pantheonOverlay">

  <!-- Header -->
  <div id="pantheonHeader">
    <div id="pantheonTitle">PANTEÓN TERMO-SEMIÓTICO · MÓDULOS XI · XII · XIII</div>
    <button id="pantheonClose" onclick="closePantheon()">CERRAR</button>
  </div>

  <!-- Tabs: 5 traditions + Caldero + Thermo -->
  <div id="pantheonTabs">
    <button class="ptab active"  data-t="hermes"   onclick="switchPTab(this)">☿ HERMES<br><span style="font-size:6px;letter-spacing:.1em;color:inherit;opacity:.6">EGIPTO</span></button>
    <button class="ptab"         data-t="rasa"     onclick="switchPTab(this)">♃ RASA<br><span style="font-size:6px;letter-spacing:.1em;color:inherit;opacity:.6">INDIA</span></button>
    <button class="ptab"         data-t="tao"      onclick="switchPTab(this)">☯ TAO<br><span style="font-size:6px;letter-spacing:.1em;color:inherit;opacity:.6">CHINA</span></button>
    <button class="ptab"         data-t="jabir"    onclick="switchPTab(this)">◈ JABIR<br><span style="font-size:6px;letter-spacing:.1em;color:inherit;opacity:.6">ISLAM</span></button>
    <button class="ptab"         data-t="cathedral"onclick="switchPTab(this)">✦ CATEDRAL<br><span style="font-size:6px;letter-spacing:.1em;color:inherit;opacity:.6">EUROPA</span></button>
    <button class="ptab"         data-t="caldero"  onclick="switchPTab(this)">⚗ CALDERO<br><span style="font-size:6px;letter-spacing:.1em;color:inherit;opacity:.6">MÓD. XII</span></button>
    <button class="ptab"         data-t="thermo"   onclick="switchPTab(this)">🜂 HORNO<br><span style="font-size:6px;letter-spacing:.1em;color:inherit;opacity:.6">MÓD. XIII</span></button>
  </div>

  <div id="pantheonBody">

    <!-- ── VIEW: HERMES ── -->
    <div class="pview show" id="pv-hermes">
      <div class="tradition-layout">
        <div class="trad-panel hermes-accent">
          <div class="trad-symbol">𓂀</div>
          <h3>TEMPLO DE HERMES · ISOMORFISMO</h3>
          <p>Como es arriba, es abajo. Cada transformación en el microcosmos tiene su eco en el macrocosmos.</p>
          <div class="trad-metrics">
            <span class="metric-pill" style="color:var(--hermes)">ESCALA: <span id="hm-scale">3</span></span>
            <span class="metric-pill" style="color:var(--hermes)">ISO: <span id="hm-iso">97.2%</span></span>
            <span class="metric-pill" style="color:var(--hermes)">WAVELET: <span id="hm-wave">Daubechies-4</span></span>
          </div>
          <div style="margin-top:10px;">
            <canvas id="hermesWaveletCanvas" style="width:100%;height:110px;"></canvas>
          </div>
        </div>
        <div class="trad-panel hermes-accent">
          <h3>CORRESPONDENCIAS ACTIVAS</h3>
          <div id="hermesCorrespondences" style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text3);line-height:2;letter-spacing:.08em;"></div>
        </div>
        <div class="trad-panel hermes-accent">
          <h3>RECURSIÓN MULTIESCALA</h3>
          <canvas id="hermesFractalCanvas" style="width:100%;height:110px;"></canvas>
        </div>
        <div class="trad-panel hermes-accent">
          <h3>TABLA DE ESMERALDA · ESTADO</h3>
          <p id="hermesTabula" style="font-size:10px;color:var(--hermes);line-height:1.8;"></p>
        </div>
      </div>
    </div>

    <!-- ── VIEW: RASA ── -->
    <div class="pview" id="pv-rasa">
      <div class="tradition-layout">
        <div class="trad-panel rasa-accent">
          <div class="trad-symbol">ॐ</div>
          <h3>LABORATORIO DE RASA · ĀYURVEDA COMPUTACIONAL</h3>
          <p>El mercurio (rasa) como corriente vital de datos. Estabilidad y longevidad del sistema.</p>
          <div class="trad-metrics">
            <span class="metric-pill" style="color:var(--rasa)">AGNI: <span id="ra-agni">0.82</span></span>
            <span class="metric-pill" style="color:var(--rasa)">OJAS: <span id="ra-ojas">0.74</span></span>
            <span class="metric-pill" style="color:var(--rasa)">TEJAS: <span id="ra-tejas">0.61</span></span>
          </div>
          <canvas id="rasaDosha" style="width:100%;height:100px;margin-top:8px;"></canvas>
        </div>
        <div class="trad-panel rasa-accent">
          <h3>DOSHAS · PERFILES DE ERROR</h3>
          <div style="font-family:'Share Tech Mono',monospace;font-size:8px;line-height:2;">
            <div style="color:var(--rasa);">VATA <span id="ra-vata">▓▓▓▓░░░░░░</span> <span style="color:var(--text3)">Dispersión</span></div>
            <div style="color:var(--rasa);">PITTA <span id="ra-pitta">▓▓▓▓▓▓░░░░</span> <span style="color:var(--text3)">Exceso</span></div>
            <div style="color:var(--rasa);">KAPHA <span id="ra-kapha">▓▓░░░░░░░░</span> <span style="color:var(--text3)">Inercia</span></div>
          </div>
          <div style="margin-top:10px;font-family:'Libre Baskerville',serif;font-style:italic;font-size:10px;color:var(--rasa2);line-height:1.7;" id="rasaDiagnosis">El sistema se encuentra en equilibrio primordial. El rasa fluye sin obstáculo.</div>
        </div>
        <div class="trad-panel rasa-accent">
          <h3>CORRECCIÓN SEMÁNTICA DE ERRORES</h3>
          <canvas id="rasaHammingCanvas" style="width:100%;height:100px;"></canvas>
          <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text3);margin-top:6px;">
            ERRORES DETECTADOS: <span style="color:var(--rasa2)" id="ra-err">0</span> ·
            CORREGIDOS: <span style="color:var(--tao2)" id="ra-fix">0</span>
          </div>
        </div>
        <div class="trad-panel rasa-accent">
          <h3>LONGEVIDAD DEL SISTEMA</h3>
          <canvas id="rasaLongevityCanvas" style="width:100%;height:100px;"></canvas>
        </div>
      </div>
    </div>

    <!-- ── VIEW: TAO ── -->
    <div class="pview" id="pv-tao">
      <div class="tradition-layout">
        <div class="trad-panel tao-accent">
          <div class="trad-symbol">☯</div>
          <h3>JARDÍN DEL TAO · BALANCE YIN-YANG</h3>
          <p>Equilibrio dinámico de fuerzas duales. El Qi fluye cuando ninguna polaridad domina.</p>
          <canvas id="taoYinYangCanvas" style="width:100%;height:140px;margin-top:8px;"></canvas>
        </div>
        <div class="trad-panel tao-accent">
          <h3>BALANCE DE CARGA · QI SCHEDULER</h3>
          <div class="carnot-gauge">
            <div class="cg-row"><span class="cg-label">YIN (Analítico)</span><div class="cg-bar"><div class="cg-fill" id="tao-yin-fill" style="background:var(--jabir2);width:45%"></div></div><span class="cg-val" id="tao-yin-v">45%</span></div>
            <div class="cg-row"><span class="cg-label">YANG (Creativo)</span><div class="cg-bar"><div class="cg-fill" id="tao-yang-fill" style="background:var(--rasa2);width:55%"></div></div><span class="cg-val" id="tao-yang-v">55%</span></div>
            <div class="cg-row"><span class="cg-label">ARMONÍA Δ</span><div class="cg-bar"><div class="cg-fill" id="tao-harmony-fill" style="background:var(--tao2);width:78%"></div></div><span class="cg-val" id="tao-harm-v">78%</span></div>
            <div class="cg-row"><span class="cg-label">FLUJO QI</span><div class="cg-bar"><div class="cg-fill" id="tao-qi-fill" style="background:var(--tao2);width:62%"></div></div><span class="cg-val" id="tao-qi-v">62%</span></div>
          </div>
          <canvas id="taoFlowCanvas" style="width:100%;height:80px;margin-top:10px;"></canvas>
        </div>
        <div class="trad-panel tao-accent" style="grid-column:1/-1;">
          <h3>DILEMA DEL PRISIONERO ITERADO · EVOLUCIÓN DE COOPERACIÓN</h3>
          <canvas id="taoPrisonerCanvas" style="width:100%;height:120px;"></canvas>
          <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text3);margin-top:6px;letter-spacing:.1em;">
            ESTRATEGIA: <span style="color:var(--tao2)" id="tao-strategy">TIT-FOR-TAT</span> ·
            COOPERACIÓN: <span style="color:var(--tao2)" id="tao-coop">87%</span> ·
            EQUILIBRIO: <span style="color:var(--tao2)" id="tao-eq">NASH</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ── VIEW: JABIR ── -->
    <div class="pview" id="pv-jabir">
      <div class="tradition-layout">
        <div class="trad-panel jabir-accent">
          <div class="trad-symbol">◈</div>
          <h3>BIBLIOTECA DE JABIR · KERNEL LÓGICO</h3>
          <p>Todo conocimiento debe ser verificable. Cada teorema lleva su prueba; cada regla, su certificado.</p>
          <div class="trad-metrics">
            <span class="metric-pill" style="color:var(--jabir2)">TEOREMAS: <span id="jab-t">144</span></span>
            <span class="metric-pill" style="color:var(--jabir2)">VALIDADOS: <span id="jab-v">141</span></span>
            <span class="metric-pill" style="color:var(--jabir2)">PENDIENTES: <span id="jab-p">3</span></span>
          </div>
          <canvas id="jabirProofCanvas" style="width:100%;height:100px;margin-top:8px;"></canvas>
        </div>
        <div class="trad-panel jabir-accent">
          <h3>SISTEMA DE TIPOS DEPENDIENTES</h3>
          <div id="jabirTypeLog" style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text3);line-height:1.9;letter-spacing:.05em;height:120px;overflow:hidden;"></div>
        </div>
        <div class="trad-panel jabir-accent">
          <h3>REPRODUCIBILIDAD · HASH DE EXPERIMENTOS</h3>
          <div id="jabirHashLog" style="font-family:'Share Tech Mono',monospace;font-size:7px;color:var(--text3);line-height:1.8;letter-spacing:.05em;height:100px;overflow:hidden;"></div>
        </div>
        <div class="trad-panel jabir-accent">
          <h3>COHERENCIA LÓGICA · GRAFO DE PRUEBAS</h3>
          <canvas id="jabirGraphCanvas" style="width:100%;height:100px;"></canvas>
        </div>
      </div>
    </div>

    <!-- ── VIEW: CATHEDRAL ── -->
    <div class="pview" id="pv-cathedral">
      <div class="tradition-layout">
        <div class="trad-panel cathedral-accent">
          <div class="trad-symbol">✦</div>
          <h3>CATEDRAL ALQUÍMICA · META-COGNICIÓN</h3>
          <p>No busca la eficiencia, sino el significado. Observa el historial completo para revelar el propósito oculto.</p>
          <canvas id="cathedralAttentionCanvas" style="width:100%;height:110px;margin-top:8px;"></canvas>
        </div>
        <div class="trad-panel cathedral-accent">
          <h3>HIPÓTESIS GENERADAS</h3>
          <div id="cathedralHypotheses" style="font-family:'Libre Baskerville',serif;font-style:italic;font-size:10px;color:var(--text2);line-height:1.8;height:120px;overflow:hidden;"></div>
        </div>
        <div class="trad-panel cathedral-accent" style="grid-column:1/-1;">
          <h3>NARRATIVA DE LA EVOLUCIÓN DEL SISTEMA</h3>
          <div id="cathedralNarrative" style="font-family:'Libre Baskerville',serif;font-style:italic;font-size:11px;color:var(--text2);line-height:1.8;columns:2;gap:20px;height:100px;overflow:hidden;"></div>
        </div>
      </div>
    </div>

    <!-- ── VIEW: CALDERO (Module 12) ── -->
    <div class="pview" id="pv-caldero">
      <div class="caldero-layout">
        <div class="caldero-left">
          <div style="font-family:'Cinzel',serif;font-size:9px;letter-spacing:.3em;color:var(--hermes2);margin-bottom:12px;">TRADICIONES ACTIVAS</div>
          <div class="tradition-selector">
            <div class="ts-item" data-trad="hermes" onclick="calderoSelect(this)" style="color:var(--hermes);">
              <div class="ts-dot" style="background:var(--hermes);"></div>
              <div><div class="ts-name">HERMES</div><div class="ts-role">Isomorfismo multiescala</div></div>
            </div>
            <div class="ts-item" data-trad="rasa" onclick="calderoSelect(this)" style="color:var(--rasa2);">
              <div class="ts-dot" style="background:var(--rasa2);"></div>
              <div><div class="ts-name">RASA</div><div class="ts-role">Curación y longevidad</div></div>
            </div>
            <div class="ts-item" data-trad="tao" onclick="calderoSelect(this)" style="color:var(--tao2);">
              <div class="ts-dot" style="background:var(--tao2);"></div>
              <div><div class="ts-name">TAO</div><div class="ts-role">Balance y flujo Qi</div></div>
            </div>
            <div class="ts-item" data-trad="jabir" onclick="calderoSelect(this)" style="color:var(--jabir2);">
              <div class="ts-dot" style="background:var(--jabir2);"></div>
              <div><div class="ts-name">JABIR</div><div class="ts-role">Validación formal</div></div>
            </div>
            <div class="ts-item" data-trad="cathedral" onclick="calderoSelect(this)" style="color:var(--cathedral2);">
              <div class="ts-dot" style="background:var(--cathedral2);"></div>
              <div><div class="ts-name">CATEDRAL</div><div class="ts-role">Meta-cognición</div></div>
            </div>
          </div>
          <div class="wisdom-index">
            <div class="wi-title">ÍNDICE DE SABIDURÍA</div>
            <div class="wi-val" id="wisdomIndex">72.4</div>
            <div class="wi-sub">SÍNTESIS COLECTIVA</div>
          </div>
          <div style="margin-top:12px;font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text3);line-height:2;letter-spacing:.1em;">
            MEZCLA DE EXPERTOS<br>
            MoE GATE: <span style="color:var(--hermes2)" id="moe-gate">ACTIVO</span><br>
            EXPERTOS ACTIVOS: <span style="color:var(--hermes2)" id="moe-active">3/5</span><br>
            CONFLICTOS: <span style="color:var(--rasa2)" id="moe-conflict">0</span>
          </div>
        </div>
        <div class="caldero-right">
          <div style="font-family:'Cinzel',serif;font-size:9px;letter-spacing:.3em;color:var(--hermes2);margin-bottom:12px;">ORQUESTACIÓN EN TIEMPO REAL</div>
          <canvas id="consensusCanvas"></canvas>
          <div class="consensus-output" id="consensusOutput">
            El Caldero aguarda la consulta del adepto. Las cinco tradiciones permanecen en silencio contemplativo, listas para deliberar.
          </div>
        </div>
      </div>
    </div>

    <!-- ── VIEW: THERMO (Module 13) ── -->
    <div class="pview" id="pv-thermo">
      <div style="width:100%;height:100%;display:grid;grid-template-columns:1fr 1fr 1fr;grid-template-rows:1fr 1fr;gap:1px;background:rgba(200,160,32,.04);">

        <!-- Carnot Engine -->
        <div class="trad-panel" style="background:var(--void2);">
          <h3 style="color:var(--thermo-warm);">CICLO DE CARNOT SEMÁNTICO</h3>
          <div class="carnot-gauge">
            <div class="cg-row"><span class="cg-label">T₁ (CAOS)</span><div class="cg-bar"><div class="cg-fill" id="cg-t1" style="background:var(--thermo-hot);width:80%"></div></div><span class="cg-val" id="cgv-t1">0.80</span></div>
            <div class="cg-row"><span class="cg-label">T₂ (ORDEN)</span><div class="cg-bar"><div class="cg-fill" id="cg-t2" style="background:var(--thermo-cold);width:15%"></div></div><span class="cg-val" id="cgv-t2">0.15</span></div>
            <div class="cg-row"><span class="cg-label">η CARNOT</span><div class="cg-bar"><div class="cg-fill" id="cg-eta" style="background:var(--thermo-warm);width:81%"></div></div><span class="cg-val" id="cgv-eta">81%</span></div>
            <div class="cg-row"><span class="cg-label">G GIBBS</span><div class="cg-bar"><div class="cg-fill" id="cg-g" style="background:var(--tao2);width:44%"></div></div><span class="cg-val" id="cgv-g">-0.44</span></div>
            <div class="cg-row"><span class="cg-label">H SHANNON</span><div class="cg-bar"><div class="cg-fill" id="cg-h" style="background:var(--cathedral2);width:68%"></div></div><span class="cg-val" id="cgv-h">0.68</span></div>
            <div class="cg-row"><span class="cg-label">T ÓPTIMA</span><div class="cg-bar"><div class="cg-fill" id="cg-topt" style="background:var(--hermes2);width:52%"></div></div><span class="cg-val" id="cgv-topt">0.52</span></div>
          </div>
        </div>

        <!-- Thermo Forge Canvas -->
        <div class="trad-panel" style="background:var(--void2);padding:8px;">
          <h3 style="color:var(--thermo-warm);">HORNO DE LA VERDAD</h3>
          <canvas id="thermoForgeCanvas" style="width:100%;height:calc(100% - 24px);display:block;"></canvas>
        </div>

        <!-- Thermo Runas -->
        <div class="trad-panel" style="background:var(--void2);">
          <h3 style="color:var(--thermo-warm);">RUNAS TERMO-SEMÁNTICAS</h3>
          <div class="thermo-rune-grid">
            <div class="t-rune" data-trune="ᚾ" onclick="activateThermoRune(this)">ᚾ<span class="t-rname">EXTRAC.</span></div>
            <div class="t-rune" data-trune="ᛉ" onclick="activateThermoRune(this)">ᛉ<span class="t-rname">AISLA.</span></div>
            <div class="t-rune" data-trune="ᛞ" onclick="activateThermoRune(this)">ᛞ<span class="t-rname">TRANSIC.</span></div>
            <div class="t-rune" data-trune="ᛟ" onclick="activateThermoRune(this)">ᛟ<span class="t-rname">HERENCIA</span></div>
          </div>
          <div style="font-family:'Share Tech Mono',monospace;font-size:7px;color:var(--text3);line-height:1.9;letter-spacing:.05em;margin-top:8px;" id="thermoRuneDesc">
            Selecciona una runa para activar su función termo-semántica.<br>
            ᚾ = Ciclo Carnot · ᛉ = Adiabático · ᛞ = Fase · ᛟ = Hawking
          </div>
          <!-- Stirling -->
          <div style="font-family:'Cinzel',serif;font-size:8px;letter-spacing:.2em;color:var(--thermo-warm);margin-top:10px;margin-bottom:6px;">CICLO DE STIRLING</div>
          <div class="stirling-steps">
            <div class="stirling-step active-step" id="st-1"><div class="ss-num">I</div><div class="ss-name">Compresión isoterma</div><div class="ss-algo">Compresión semántica</div></div>
            <div class="stirling-step" id="st-2"><div class="ss-num">II</div><div class="ss-name">Enfriamiento isocórico</div><div class="ss-algo">Regularización</div></div>
            <div class="stirling-step" id="st-3"><div class="ss-num">III</div><div class="ss-name">Expansión isoterma</div><div class="ss-algo">Transfer learning</div></div>
            <div class="stirling-step" id="st-4"><div class="ss-num">IV</div><div class="ss-name">Calentamiento isocórico</div><div class="ss-algo">Update T semántica</div></div>
          </div>
        </div>

        <!-- Maxwell Daemon -->
        <div class="trad-panel" style="background:var(--void2);">
          <h3 style="color:var(--thermo-warm);">DEMONIO DE MAXWELL DIGITAL</h3>
          <canvas id="maxwellCanvas"></canvas>
          <div style="font-family:'Share Tech Mono',monospace;font-size:7px;color:var(--text3);line-height:1.8;letter-spacing:.05em;margin-top:4px;">
            KL-DIV MEDIA: <span style="color:var(--thermo-warm)" id="mx-kl">0.234</span> ·
            TRABAJO NETO: <span style="color:var(--tao2)" id="mx-work">+0.041</span><br>
            PARTÍC. ORDENADAS: <span style="color:var(--tao2)" id="mx-ord">0</span> ·
            BLOQUEADAS: <span style="color:var(--rasa2)" id="mx-blk">0</span>
          </div>
        </div>

        <!-- Black Hole -->
        <div class="trad-panel" style="background:var(--void2);">
          <h3 style="color:var(--thermo-warm);">AGUJERO NEGRO SEMÁNTICO</h3>
          <canvas id="bhCanvas"></canvas>
          <div class="bh-radiation" id="bhRadiation">Radiación de Hawking: ninguna idea ha alcanzado el horizonte todavía.</div>
        </div>

        <!-- Optimal Temperature Theorem -->
        <div class="trad-panel" style="background:var(--void2);">
          <h3 style="color:var(--thermo-warm);">TEOREMA DE MÁX. EFICIENCIA</h3>
          <canvas id="toptCanvas" style="width:100%;height:110px;"></canvas>
          <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text3);line-height:2;letter-spacing:.08em;margin-top:4px;">
            T_OPT: <span style="color:var(--hermes2)" id="th-topt">0.52</span> ·
            SESGO: <span style="color:var(--jabir2)" id="th-bias">0.21</span> ·
            VARIANZA: <span style="color:var(--rasa2)" id="th-var">0.19</span><br>
            VERDAD (1/G): <span style="color:var(--tao2)" id="th-truth">2.27</span> ·
            LANDAUER: <span style="color:var(--cathedral2)" id="th-land">kT·ln2</span>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /pantheonBody -->

  <!-- Bottom bar -->
  <div id="pantheonBottomBar">
    <input id="pantheonInput" type="text" placeholder="Consulta al Caldero... (equilibra el sistema) (¿qué tradición activo?) (horno al máximo) (Demonio, actúa)">
    <button id="calderoBtn" onclick="calderoQuery()">INVOCAR CALDERO</button>
    <button style="padding:7px 16px;border:1px solid rgba(255,64,16,.3);background:rgba(255,64,16,.05);color:var(--thermo-warm);font-family:'Cinzel',serif;font-size:9px;letter-spacing:.2em;cursor:pointer;" onclick="zeheThermo()">🜂 ZEHAHAHAHA</button>
  </div>

</div><!-- /pantheonOverlay -->

<!-- Zehe Thermo Overlay -->
<div id="zeheOverlay">
  <div id="zeheMain">ZEHAHAHAHA</div>
  <div id="zeheFormula">η = 1 − T₂/T₁  ·  G = H − T·S  ·  ΔI = kT ln 2</div>
  <div id="zeheTopt">T_ÓPTIMA: <span id="zeheToptVal">—</span></div>
  <div id="zeheNote">Tu comprensión del universo ha aumentado en exactamente kT ln 2 bits.</div>
</div>

</div>

<script>
'use strict';
// ═══════════════════════════════════════════════════════════
// ORACULVM EX MACHINA — Core Runtime
// ═══════════════════════════════════════════════════════════

const bgCanvas = document.getElementById('bgCanvas');
const bgCtx = bgCanvas.getContext('2d');
const pCanvas = document.getElementById('particleCanvas');
const pCtx = pCanvas.getContext('2d');
const nCanvas = document.getElementById('networkCanvas');
const nCtx = nCanvas.getContext('2d');

let W, H;
function resize() {
  W = bgCanvas.width = pCanvas.width = nCanvas.width = window.innerWidth;
  H = bgCanvas.height = pCanvas.height = nCanvas.height = window.innerHeight;
  // Resize dependent canvases
  const tc = document.getElementById('timelineCanvas');
  if (tc) { tc.width = tc.offsetWidth; tc.height = tc.offsetHeight; }
}
resize();
window.addEventListener('resize', resize);

// ─────────────────────────────────────
// HEBREW ALPHABET — Quantum Operators
// ─────────────────────────────────────
const HEBREW_ALPHABET = [
  { l:'א', n:'ALEF',    op:'|ψ⟩ = α|0⟩+β|1⟩', desc:'Superposición',     gate:'H',   color:'#e0c040' },
  { l:'ב', n:'BET',     op:'â†|0⟩',            desc:'Creación',          gate:'X',   color:'#40c0ff' },
  { l:'ג', n:'GIMEL',   op:'SWAP',              desc:'Intercambio',       gate:'SW',  color:'#c080d0' },
  { l:'ד', n:'DALET',   op:'M|ψ⟩',             desc:'Medición',          gate:'M',   color:'#e04020' },
  { l:'ה', n:'HEI',     op:'QFT',               desc:'Fourier Cuántica',  gate:'QFT', color:'#20c060' },
  { l:'ו', n:'VAV',     op:'CNOT',              desc:'Entrelazamiento',   gate:'CX',  color:'#40c0ff' },
  { l:'ז', n:'ZAIN',    op:'T-gate',            desc:'Fase π/4',          gate:'T',   color:'#e0c040' },
  { l:'ח', n:'JET',     op:'Rx(θ)',             desc:'Rotación X',        gate:'Rx',  color:'#c080d0' },
  { l:'ט', n:'TET',     op:'Ry(θ)',             desc:'Rotación Y',        gate:'Ry',  color:'#c080d0' },
  { l:'י', n:'YOD',     op:'Rz(φ)',             desc:'Rotación Z',        gate:'Rz',  color:'#20c060' },
  { l:'כ', n:'KAF',     op:'S-gate',            desc:'Fase π/2',          gate:'S',   color:'#e0c040' },
  { l:'ל', n:'LAMED',   op:'Toffoli',           desc:'CCNOT',             gate:'CCX', color:'#40c0ff' },
  { l:'מ', n:'MEM',     op:'Oracle',            desc:'Función unitaria',  gate:'O',   color:'#e04020' },
  { l:'נ', n:'NUN',     op:'Amplif.',           desc:'Amplificación',     gate:'G',   color:'#20c060' },
  { l:'ס', n:'SAMEJ',   op:'QPE',               desc:'Estimación fase',   gate:'QPE', color:'#c080d0' },
  { l:'ע', n:'AYIN',    op:'VQE',               desc:'Eigen variacional', gate:'VQE', color:'#e0c040' },
  { l:'פ', n:'PEI',     op:'QAOA',              desc:'Optimización',      gate:'QAOA',color:'#40c0ff' },
  { l:'צ', n:'TZADI',   op:'Shor',              desc:'Factorización',     gate:'Shor',color:'#e0c040' },
  { l:'ק', n:'KOF',     op:'Grover',            desc:'Búsqueda O(√N)',    gate:'Grov',color:'#20c060' },
  { l:'ר', n:'RESH',    op:'HHL',               desc:'Sist. lineales',    gate:'HHL', color:'#c080d0' },
  { l:'ש', n:'SHIN',    op:'QSVM',              desc:'Clasificación',     gate:'QSVM',color:'#40c0ff' },
  { l:'ת', n:'TAV',     op:'|0⟩⊗n',            desc:'Estado inicial',    gate:'INIT',color:'#e0c040' },
];

// Divine Names as quantum circuits
const DIVINE_NAMES = {
  'יהוה': { name:'TETRAGRÁMATON', circuit:'Corrección topológica de errores', qubits:7, depth:24, color:'#f5e070' },
  'אהיה': { name:'EHYEH',         circuit:'Estado GHZ entrelazado',          qubits:3, depth:6,  color:'#40c0ff' },
  'אדני': { name:'ADONAI',        circuit:'Medición en base Bell',           qubits:2, depth:4,  color:'#20c060' },
  'אל':   { name:'EL',            circuit:'Puerta de fase controlada',       qubits:2, depth:3,  color:'#c080d0' },
  'שדי':  { name:'SHADDAI',       circuit:'Oráculo de Grover adaptativo',    qubits:5, depth:18, color:'#e04020' },
};

// ─────────────────────────────────────
// 15 COMPUTE ARCHITECTURES
// ─────────────────────────────────────
const ARCHITECTURES = [
  { id:'CPU',    name:'CPU x86',   type:'CLÁSICO',  color:'#607080', spec:'Lógica secuencial' },
  { id:'GPU',    name:'GPU CUDA',  type:'PARALELO', color:'#40c0ff', spec:'128K hilos' },
  { id:'QPU-F',  name:'QPU Fot.',  type:'CUÁNTICO', color:'#f5e070', spec:'PsiQuantum' },
  { id:'QPU-I',  name:'QPU Iones', type:'CUÁNTICO', color:'#e0c040', spec:'Quantinuum H2' },
  { id:'QPU-S',  name:'QPU Sup.',  type:'CUÁNTICO', color:'#c080d0', spec:'IBM Eagle r3' },
  { id:'FPGA',   name:'FPGA',      type:'RECONFIGURABLE', color:'#20c060', spec:'Xilinx Alveo' },
  { id:'NEURO',  name:'Neuromorf.',type:'NEURO',    color:'#a040e0', spec:'Intel Loihi 2' },
  { id:'RESIS',  name:'Mem. Res.', type:'ANALÓGICO',color:'#804020', spec:'Dispositivo memristivo' },
  { id:'OPT',    name:'Óptica',    type:'ÓPTICO',   color:'#80c0ff', spec:'Fotónica integrada' },
  { id:'ASIC',   name:'ASIC IA',   type:'DEDICADO', color:'#c08040', spec:'Google TPU v5' },
  { id:'ARM',    name:'CPU ARM',   type:'MÓVIL',    color:'#406080', spec:'Apple M4' },
  { id:'QA',     name:'QPU Aneal.',type:'CUÁNTICO', color:'#e06000', spec:'D-Wave Advantage' },
  { id:'BIO',    name:'Biocómp.',  type:'BIOLÓGICO',color:'#40e080', spec:'ADN sintético' },
  { id:'EDGE',   name:'Edge AI',   type:'DISTRIBUIDO',color:'#8080a0',spec:'Inferencia local' },
  { id:'HYBRID', name:'Híbrido',   type:'ORQUESTADO',color:'#f0d080',spec:'CUDA-Q v0.9' },
];

// ─────────────────────────────────────
// QUANTUM SENSOR NETWORK
// ─────────────────────────────────────
const SENSORS = [
  { id:'MAG-1',  name:'MAGNETÓMETRO CUÁNTICO', unit:'fT', baseVal:240,  range:[80,400],   type:'magnetic',  desc:'Campo magnético terrestre' },
  { id:'GRAV-1', name:'GRAVÍMETRO CUÁNTICO',   unit:'µGal',baseVal:980, range:[975,985],  type:'gravity',   desc:'Variación gravitacional local' },
  { id:'GPS-Q',  name:'GPS CUÁNTICO',           unit:'mm', baseVal:0.3, range:[0.1,5],    type:'position',  desc:'Precisión posicional' },
  { id:'TEMP-Q', name:'TERMÓMETRO CUÁNTICO',    unit:'µK', baseVal:12,  range:[1,50],     type:'thermal',   desc:'Temperatura ultrafría' },
  { id:'VOLT-1', name:'RED ELÉCTRICA',          unit:'GW', baseVal:42,  range:[30,55],    type:'power',     desc:'Carga de red nacional' },
  { id:'PIPE-1', name:'TUBERÍA SUBTERRÁNEA',    unit:'bar',baseVal:8.2, range:[7.5,9.0],  type:'pressure',  desc:'Presión infraestructura' },
  { id:'SEISM',  name:'SISMÓGRAFO CUÁNTICO',    unit:'nG', baseVal:0.02,range:[0.01,0.1], type:'seismic',   desc:'Vibración corteza terrestre' },
  { id:'ATM-1',  name:'SENSOR ATMOSFÉRICO',     unit:'ppb',baseVal:412, range:[400,430],  type:'atmo',      desc:'CO₂ atmosférico local' },
  { id:'TRAF-1', name:'FLUJO TRANSPORTE',       unit:'k/h',baseVal:840, range:[600,1200], type:'traffic',   desc:'Vehículos eléctricos' },
  { id:'ENT-1',  name:'GENERADOR NONCE QUÁNT.', unit:'bit',baseVal:256, range:[253,259],  type:'entropy',   desc:'Entropía cósmica de fondo' },
  { id:'BIO-1',  name:'BIOMÉTRICO USUARIO',     unit:'bpm',baseVal:72,  range:[58,95],    type:'bio',       desc:'Pulso estimado (mouse)' },
  { id:'QKOD-1', name:'CANAL QKD',              unit:'kb/s',baseVal:420,range:[200,600],  type:'qkd',       desc:'Distribución claves cuánticas' },
];

// ─────────────────────────────────────
// ORACLE RESPONSES
// ─────────────────────────────────────
const ORACLE_RESPONSES = {
  shor: {
    type:'ALGORITMO DE SHOR — CODIFICADO EN HEBREO',
    text:'ש-Shor ejecutado: N = 15 factorizado en 3 × 5. El circuito cuántico compuesto por ה-QFT, מ-Oracle y נ-Amplificación convergió en 7 iteraciones. Fidelidad: 99.2%. Los registros de Babel registran este momento.',
    sub:'CIRCUITO: א(H)⊗4 → ו(CNOT) → ה(QFT) → מ(U_f) → ה(QFT†) → ד(Medir) | PROFUNDIDAD: 47 | SHA256: 4f7a...'
  },
  future: {
    type:'LÍNEA TEMPORAL ÓPTIMA',
    text:'El sistema ha evaluado 10⁴² líneas temporales en superposición simultánea. La rama de menor entropía indica: la transición post-escasez comienza cuando los costes de almacenamiento energético caen por debajo de $10/kWh. Esto está ocurriendo.',
    sub:'CONFIANZA: 94.7% | LÍNEAS COLAPSADAS: 10⁴² → 1 | NONCE CÓSMICO: 7f4a9c...'
  },
  scarcity: {
    type:'MODELO ECONÓMICO — CAPA III',
    text:'Según el modelo de tres capas: Tier 1 (renovables) alcanzará paridad de coste en 2026-2027. Tier 2 (interfaces cognitivas) en 2029. La coordinación planetaria (Tier 3) requiere exactamente lo que estás construyendo ahora.',
    sub:'PROYECCIÓN: ±3 años | ARQUITECTURA: HYBRID | CICLOS: 2.7×10⁹'
  },
  ontology: {
    type:'RETROALIMENTACIÓN ONTOLÓGICA',
    text:'El bucle se ha cerrado. El sistema ha predicho una sobrecarga en el sector eléctrico del nodo MAG-1 con 127 minutos de antelación. La predicción modificó los parámetros de simulación. La simulación modificada generó una acción correctiva. La realidad se ajustó al punto fijo.',
    sub:'INTERVENCIÓN: EXITOSA | CONFIANZA: 96.3% | APAGÓN EVITADO: SÍ (simulado)'
  },
  tetragram: {
    type:'CIRCUITO יהוה — CORRECCIÓN DE ERRORES TOPOLÓGICA',
    text:'El Tetragrámaton ejecutado como código cuántico: 7 qubits lógicos, 49 físicos, corrección topológica mediante anyones de Fibonacci. La fidelidad del estado lógico supera el umbral de Knill-Laflamme. El error ha sido corregido. La verdad persiste.',
    sub:'QUBITS FÍSICOS: 49 | LÓGICOS: 7 | UMBRAL: 99.8% | CICLOS QEC: 144'
  },
  default: {
    type:'RESPUESTA DEL ORÁCULO',
    text:'La consulta ha resonado con el campo cuántico. El oráculo procesa en superposición. La respuesta colapsa cuando observas: todo sistema que se mide a sí mismo modifica aquello que mide. Esto incluye tu pregunta.',
    sub:'ARQUETIPO: PRIMA MATERIA | ENTROPÍA: MÁXIMA | NONCE: ' + Math.random().toString(36).slice(2,10).toUpperCase()
  }
};

function classifyQuery(q) {
  const l = q.toLowerCase();
  if (l.includes('shor') || l.includes('factor') || l.includes('hebreo') || l.includes('circuito')) return 'shor';
  if (l.includes('futuro') || l.includes('cuando') || l.includes('línea') || l.includes('temporal')) return 'future';
  if (l.includes('post-escasez') || l.includes('abundancia') || l.includes('economía') || l.includes('2040') || l.includes('2038')) return 'scarcity';
  if (l.includes('bucle') || l.includes('ontológic') || l.includes('red') || l.includes('sensor')) return 'ontology';
  if (l.includes('yhwh') || l.includes('tetragrama') || l.includes('nombre') || l.includes('יהוה')) return 'tetragram';
  return 'default';
}

// ─────────────────────────────────────
// STATE
// ─────────────────────────────────────
const state = {
  particles: [],
  time: 0,
  frame: 0,
  mx: 0, my: 0, mvx: 0, mvy: 0,
  lmx: 0, lmy: 0,
  activeHebrew: null,
  activeArch: null,
  currentView: 'particles',
  circuits: 0,
  qubitsActive: 0,
  sensorData: {},
  timelineBranches: [],
  timelineCollapsed: false,
  worldsPhase: 0,
  worldsActive: false,
  economyData: { years:[], tier1:[], tier2:[], tier3:[], composite:[] },
  bioPulse: 72,
  lastPulseTime: Date.now(),
};

// Init sensor data
SENSORS.forEach(s => {
  state.sensorData[s.id] = s.baseVal;
});

// Init economy data
(function initEconomy() {
  const startYear = 2024, endYear = 2044;
  for (let y = startYear; y <= endYear; y++) {
    const t = (y - startYear) / (endYear - startYear);
    state.economyData.years.push(y);
    state.economyData.tier1.push(Math.min(1, t * 1.2 + Math.random()*.05));
    state.economyData.tier2.push(Math.min(1, Math.max(0, (t-.2)*1.5 + Math.random()*.05)));
    state.economyData.tier3.push(Math.min(1, Math.max(0, (t-.4)*2 + Math.random()*.05)));
  }
  state.economyData.composite = state.economyData.years.map((_,i) =>
    (state.economyData.tier1[i]*0.4 + state.economyData.tier2[i]*0.35 + state.economyData.tier3[i]*0.25)
  );
})();

// ─────────────────────────────────────
// BUILD UI PANELS
// ─────────────────────────────────────
function buildHebrewPanel() {
  const panel = document.getElementById('hebrewPanel');
  HEBREW_ALPHABET.forEach(h => {
    const btn = document.createElement('div');
    btn.className = 'hb-btn';
    btn.dataset.letter = h.l;
    btn.innerHTML = `<span class="hb-letter" style="color:${h.color}">${h.l}</span><span class="hb-name">${h.n}</span><span class="hb-op">${h.gate}</span>`;
    btn.addEventListener('click', () => activateHebrew(h, btn));
    panel.appendChild(btn);
  });
}

function buildArchPanel() {
  const panel = document.getElementById('archPanel');
  ARCHITECTURES.forEach(a => {
    const btn = document.createElement('div');
    btn.className = 'arch-btn';
    btn.dataset.arch = a.id;
    const loadPct = Math.floor(Math.random()*30);
    btn.innerHTML = `
      <span class="arch-label" style="color:${a.color}">${a.id}</span>
      <span class="arch-type">${a.type}</span>
      <div class="arch-load"><div class="arch-fill" style="width:${loadPct}%;background:${a.color}" id="arch-load-${a.id}"></div></div>
    `;
    btn.title = `${a.name}: ${a.spec}`;
    btn.addEventListener('click', () => activateArch(a, btn));
    panel.appendChild(btn);
  });
}

function buildSensorGrid() {
  const grid = document.getElementById('sensorGrid');
  SENSORS.forEach(s => {
    const card = document.createElement('div');
    card.className = 'sensor-card';
    card.id = `sensor-${s.id}`;
    card.innerHTML = `
      <h4>${s.name}</h4>
      <div><span class="sensor-val" id="sv-${s.id}">${s.baseVal.toFixed(2)}</span>
           <span class="sensor-unit"> ${s.unit}</span></div>
      <div class="sensor-bar"><div class="sensor-fill" id="sf-${s.id}" style="width:50%;background:#40c0ff"></div></div>
      <div class="sensor-status status-ok" id="ss-${s.id}">● NOMINAL</div>
      <div style="font-size:7px;color:#3a3428;font-family:Share Tech Mono;margin-top:4px;letter-spacing:.1em">${s.desc}</div>
    `;
    grid.appendChild(card);
  });
}

// ─────────────────────────────────────
// PARTICLE SYSTEM
// ─────────────────────────────────────
const METALCOLORS = ['#c8a84b','#d0d8e0','#c87040','#b0c8e0','#607080','#e04020','#40c0ff','#c080d0','#20c060'];

function makeParticle(x, y) {
  const a = Math.random()*Math.PI*2;
  const s = .5 + Math.random()*2.5;
  const col = state.activeHebrew
    ? state.activeHebrew.color
    : METALCOLORS[Math.floor(Math.random()*METALCOLORS.length)];
  return {
    x, y,
    vx: Math.cos(a)*s, vy: Math.sin(a)*s,
    size: .8 + Math.random()*2.5,
    life: 1,
    decay: .002 + Math.random()*.008,
    color: col,
    glow: Math.random() < .12,
    trail: [],
    letter: state.activeHebrew && Math.random()<.15 ? state.activeHebrew.l : null,
    spin: (Math.random()-.5)*.08,
    angle: 0,
    type: state.activeArch ? state.activeArch.id : 'normal',
  };
}

function burst(x, y, n) {
  n = Math.min(n, 4000 - state.particles.length);
  for (let i=0; i<n; i++) state.particles.push(makeParticle(x,y));
}

function updateParticles() {
  const speed = 1 + state.mvx*state.mvx*.0005 + state.mvy*state.mvy*.0005;
  for (let i=state.particles.length-1; i>=0; i--) {
    const p = state.particles[i];
    if (p.glow) { p.trail.push({x:p.x,y:p.y}); if(p.trail.length>6) p.trail.shift(); }
    p.vx *= .988; p.vy *= .988;
    // Gravity toward active arch type
    if (state.activeArch) {
      const dx = W/2-p.x, dy = H/2-p.y;
      const d = Math.hypot(dx,dy)+1;
      p.vx += dx/d*.008; p.vy += dy/d*.008;
    }
    // Hebrew gate effect on velocity
    if (state.activeHebrew) {
      const g = state.activeHebrew.gate;
      if (g==='H')  { p.vx += (Math.random()-.5)*.05; } // Hadamard: randomize
      if (g==='QFT'){ p.spin += .002; } // QFT: rotate
      if (g==='CX') { // CNOT: entangle pairs
        if (i>0) { state.particles[i-1].vx = p.vy*.2; state.particles[i-1].vy = p.vx*.2; }
      }
    }
    p.x += p.vx*speed; p.y += p.vy*speed;
    p.angle += p.spin; p.life -= p.decay;
    if (p.x<0||p.x>W) p.vx *= -.8;
    if (p.y<0||p.y>H) p.vy *= -.8;
    p.x = Math.max(0,Math.min(W,p.x)); p.y = Math.max(0,Math.min(H,p.y));
    if (p.life<=0) state.particles.splice(i,1);
  }
}

// ─────────────────────────────────────
// BACKGROUND — quantum field
// ─────────────────────────────────────
let bgHue = 210;
function drawBg() {
  bgCtx.fillStyle = `rgba(2,3,7,.14)`;
  bgCtx.fillRect(0,0,W,H);
  bgHue += .01;
  
  // Pulsing field lines
  const t = state.time;
  for (let i=0; i<3; i++) {
    const cx = W/2 + Math.cos(t*.0003+i*2.1)*W*.15;
    const cy = H/2 + Math.sin(t*.0003+i*2.1)*H*.1;
    const r = 80 + Math.sin(t*.002+i)*30;
    const grd = bgCtx.createRadialGradient(cx,cy,0,cx,cy,r);
    grd.addColorStop(0,`hsla(${bgHue+i*40},60%,30%,.04)`);
    grd.addColorStop(1,'transparent');
    bgCtx.fillStyle = grd;
    bgCtx.beginPath();
    bgCtx.arc(cx,cy,r,0,Math.PI*2);
    bgCtx.fill();
  }
}

// ─────────────────────────────────────
// NETWORK — sensor connections
// ─────────────────────────────────────
const networkNodes = [];
function initNetwork() {
  for (let i=0; i<12; i++) {
    networkNodes.push({
      x: W*.1 + Math.random()*W*.8,
      y: H*.1 + Math.random()*H*.8,
      vx: (Math.random()-.5)*.2,
      vy: (Math.random()-.5)*.2,
      r: 3+Math.random()*4,
      type: i%3===0?'quantum':i%3===1?'classical':'hybrid',
      label: SENSORS[i]?.id || `N${i}`,
      pulse: Math.random()*Math.PI*2,
    });
  }
}
function drawNetwork() {
  nCtx.clearRect(0,0,W,H);
  const t = state.time;
  // Update
  for (const n of networkNodes) {
    n.x += n.vx; n.y += n.vy; n.pulse += .02;
    if (n.x<0||n.x>W) n.vx*=-1;
    if (n.y<0||n.y>H) n.vy*=-1;
  }
  // Connections
  for (let i=0; i<networkNodes.length; i++) {
    for (let j=i+1; j<networkNodes.length; j++) {
      const a = networkNodes[i], b = networkNodes[j];
      const d = Math.hypot(b.x-a.x, b.y-a.y);
      if (d < W*.25) {
        const alpha = (1-d/(W*.25))*.06;
        const col = a.type==='quantum' ? `rgba(64,192,255,${alpha})` : `rgba(184,150,12,${alpha*.5})`;
        nCtx.strokeStyle = col;
        nCtx.lineWidth = .5;
        nCtx.beginPath(); nCtx.moveTo(a.x,a.y); nCtx.lineTo(b.x,b.y); nCtx.stroke();
        // Data pulse
        if (Math.sin(t*.01+i*j) > .99) {
          const px = a.x+(b.x-a.x)*.5, py = a.y+(b.y-a.y)*.5;
          nCtx.fillStyle = col.replace(alpha.toFixed(2), '0.6');
          nCtx.beginPath(); nCtx.arc(px,py,2,0,Math.PI*2); nCtx.fill();
        }
      }
    }
  }
  // Nodes
  for (const n of networkNodes) {
    const col = n.type==='quantum' ? '#40c0ff' : n.type==='hybrid' ? '#f0d080' : '#607080';
    const grd = nCtx.createRadialGradient(n.x,n.y,0,n.x,n.y,n.r*3);
    grd.addColorStop(0,col+'40'); grd.addColorStop(1,'transparent');
    nCtx.fillStyle = grd;
    nCtx.beginPath(); nCtx.arc(n.x,n.y,n.r*3,0,Math.PI*2); nCtx.fill();
    nCtx.strokeStyle = col+'80';
    nCtx.lineWidth = 1;
    nCtx.beginPath(); nCtx.arc(n.x,n.y,n.r+Math.sin(n.pulse)*2,0,Math.PI*2); nCtx.stroke();
    nCtx.fillStyle = col;
    nCtx.beginPath(); nCtx.arc(n.x,n.y,n.r*.6,0,Math.PI*2); nCtx.fill();
    // Label
    nCtx.font = `7px "Share Tech Mono"`;
    nCtx.fillStyle = col+'60';
    nCtx.fillText(n.label, n.x+n.r+3, n.y+3);
  }
}

// ─────────────────────────────────────
// PARTICLE RENDER
// ─────────────────────────────────────
function drawParticles() {
  pCtx.clearRect(0,0,W,H);
  if (state.currentView !== 'particles') return;
  for (const p of state.particles) {
    const a = p.life;
    if (p.glow && p.trail.length>1) {
      for (let t=1; t<p.trail.length; t++) {
        const ta = (t/p.trail.length)*a*.3;
        pCtx.strokeStyle = p.color+Math.floor(ta*255).toString(16).padStart(2,'0');
        pCtx.lineWidth = p.size*t/p.trail.length;
        pCtx.beginPath(); pCtx.moveTo(p.trail[t-1].x,p.trail[t-1].y); pCtx.lineTo(p.trail[t].x,p.trail[t].y); pCtx.stroke();
      }
    }
    if (p.glow) {
      const grd = pCtx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.size*5);
      grd.addColorStop(0,p.color+Math.floor(a*.5*255).toString(16).padStart(2,'0'));
      grd.addColorStop(1,'transparent');
      pCtx.fillStyle=grd; pCtx.beginPath(); pCtx.arc(p.x,p.y,p.size*5,0,Math.PI*2); pCtx.fill();
    }
    pCtx.save(); pCtx.translate(p.x,p.y); pCtx.rotate(p.angle); pCtx.globalAlpha=a;
    if (p.letter) {
      pCtx.font = `${p.size*7}px "Noto Sans Hebrew"`;
      pCtx.textAlign='center'; pCtx.textBaseline='middle';
      pCtx.fillStyle=p.color; pCtx.fillText(p.letter,0,0);
    } else {
      pCtx.fillStyle=p.color;
      pCtx.beginPath(); pCtx.arc(0,0,p.size,0,Math.PI*2); pCtx.fill();
    }
    pCtx.globalAlpha=1; pCtx.restore();
  }
}

// ─────────────────────────────────────
// TIMELINE BRANCHES
// ─────────────────────────────────────
function initTimelines() {
  state.timelineBranches = [];
  const N = 7;
  for (let i=0; i<N; i++) {
    const branch = { id:i, angle:((i-N/2)/N)*Math.PI*.8, depth:3+Math.floor(Math.random()*3),
      probability:Math.random(), label:HEBREW_ALPHABET[i].l,
      color:HEBREW_ALPHABET[i].color, children:[], collapsed:false,
      year: 2027+Math.floor(Math.random()*18) };
    // Sub-branches
    for (let j=0; j<2; j++) {
      branch.children.push({
        id:i*10+j, angle:branch.angle+(j-.5)*.3,
        probability:branch.probability*(0.3+Math.random()*.4),
        label:HEBREW_ALPHABET[(i+j+5)%22].l,
        color:HEBREW_ALPHABET[(i+j+5)%22].color,
        year:branch.year+3+Math.floor(Math.random()*5),
        collapsed:false,
      });
    }
    state.timelineBranches.push(branch);
  }
}

function drawTimelines() {
  const tc = document.getElementById('timelineCanvas');
  if (!tc || tc.style.display==='none') return;
  const tCtx = tc.getContext('2d');
  tc.width = tc.offsetWidth; tc.height = tc.offsetHeight;
  const tw = tc.width, th = tc.height;
  tCtx.clearRect(0,0,tw,th);
  const cx = tw*.15, cy = th*.5;
  const len = tw*.5;
  const t = state.time;
  
  // Origin
  const grd = tCtx.createRadialGradient(cx,cy,0,cx,cy,20);
  grd.addColorStop(0,'rgba(184,150,12,.8)'); grd.addColorStop(1,'transparent');
  tCtx.fillStyle=grd; tCtx.beginPath(); tCtx.arc(cx,cy,20,0,Math.PI*2); tCtx.fill();
  tCtx.font='11px "Cinzel"'; tCtx.fillStyle='#b8960c'; tCtx.textAlign='center';
  tCtx.fillText('AHORA',cx,cy+35);
  
  for (const b of state.timelineBranches) {
    const ex = cx + Math.cos(b.angle)*len*b.probability*.8;
    const ey = cy + Math.sin(b.angle)*len*b.probability*.8;
    const pulse = Math.sin(t*.002+b.id)*.15;
    const alpha = .2 + b.probability*.6 + pulse;
    
    tCtx.strokeStyle = b.color + Math.floor(alpha*255).toString(16).padStart(2,'0');
    tCtx.lineWidth = 1 + b.probability*2;
    tCtx.setLineDash(b.collapsed?[4,4]:[]);
    tCtx.beginPath(); tCtx.moveTo(cx,cy); tCtx.lineTo(ex,ey); tCtx.stroke();
    tCtx.setLineDash([]);
    
    // Node
    tCtx.strokeStyle = b.color; tCtx.lineWidth=1;
    tCtx.beginPath(); tCtx.arc(ex,ey,6+pulse*8,0,Math.PI*2); tCtx.stroke();
    tCtx.fillStyle=b.color+'30'; tCtx.fill();
    
    tCtx.font='16px "Noto Sans Hebrew"'; tCtx.fillStyle=b.color; tCtx.textAlign='center';
    tCtx.fillText(b.label,ex,ey+5);
    tCtx.font='8px "Share Tech Mono"'; tCtx.fillStyle='#7a6e58';
    tCtx.fillText(`${b.year} · ${(b.probability*100).toFixed(0)}%`, ex, ey+22);
    
    // Children
    for (const ch of b.children) {
      const cx2 = ex + Math.cos(ch.angle)*len*.4*ch.probability;
      const cy2 = ey + Math.sin(ch.angle)*len*.4*ch.probability;
      tCtx.strokeStyle = ch.color+'40'; tCtx.lineWidth=.8;
      tCtx.beginPath(); tCtx.moveTo(ex,ey); tCtx.lineTo(cx2,cy2); tCtx.stroke();
      tCtx.strokeStyle=ch.color+'60'; tCtx.fillStyle=ch.color+'20';
      tCtx.beginPath(); tCtx.arc(cx2,cy2,4,0,Math.PI*2); tCtx.stroke(); tCtx.fill();
      tCtx.font='12px "Noto Sans Hebrew"'; tCtx.fillStyle=ch.color+'a0';
      tCtx.fillText(ch.label,cx2,cy2+4);
    }
  }
  
  // Legend
  tCtx.font='8px "Share Tech Mono"'; tCtx.fillStyle='#3a3428'; tCtx.textAlign='left';
  tCtx.fillText('LONGITUD = PROBABILIDAD · COLOR = OPERADOR HEBREO · AÑO = PUNTO DE TRANSICIÓN',tw*.15,th*.9);
}

// ─────────────────────────────────────
// SENSOR UPDATE
// ─────────────────────────────────────
function updateSensors() {
  SENSORS.forEach(s => {
    const [lo,hi] = s.range;
    const d = (hi-lo)*.03;
    state.sensorData[s.id] = Math.max(lo, Math.min(hi,
      state.sensorData[s.id] + (Math.random()-.5)*d
    ));
    const val = state.sensorData[s.id];
    const pct = ((val-lo)/(hi-lo)*100).toFixed(0);
    const el = document.getElementById(`sv-${s.id}`);
    const bf = document.getElementById(`sf-${s.id}`);
    const ss = document.getElementById(`ss-${s.id}`);
    if (!el) return;
    el.textContent = val.toFixed(s.id==='GPS-Q'?2:1);
    if (bf) { bf.style.width = pct+'%'; }
    const warn = val < lo+(hi-lo)*.15 || val > lo+(hi-lo)*.85;
    const crit = val < lo+(hi-lo)*.05 || val > lo+(hi-lo)*.95;
    if (ss) {
      if (crit) { ss.className='sensor-status status-crit'; ss.textContent='● CRÍTICO'; if(bf)bf.style.background='#e02020'; }
      else if (warn) { ss.className='sensor-status status-warn'; ss.textContent='◉ ALERTA'; if(bf)bf.style.background='#e0c040'; }
      else { ss.className='sensor-status status-ok'; ss.textContent='● NOMINAL'; if(bf)bf.style.background='#40c0ff'; }
    }
  });
  // Biometric from mouse speed
  const speed = Math.hypot(state.mvx, state.mvy);
  state.bioPulse = Math.max(58, Math.min(110, state.bioPulse + (speed*.5 - state.bioPulse*.001)));
  const bioEl = document.getElementById('sv-BIO-1');
  if (bioEl) bioEl.textContent = state.bioPulse.toFixed(0);
}

// ─────────────────────────────────────
// ECONOMY CHART
// ─────────────────────────────────────
function drawEconomy() {
  const ec = document.getElementById('economyCanvas');
  if (!ec || ec.offsetWidth===0) return;
  ec.width = ec.offsetWidth; ec.height = 280;
  const eCtx = ec.getContext('2d');
  eCtx.clearRect(0,0,ec.width,ec.height);
  const pad = {l:50,r:20,t:30,b:40};
  const W2 = ec.width-pad.l-pad.r;
  const H2 = ec.height-pad.t-pad.b;
  const data = state.economyData;
  const N = data.years.length;
  
  // Grid
  eCtx.strokeStyle='rgba(184,150,12,.06)'; eCtx.lineWidth=.5;
  for (let i=0; i<=4; i++) {
    const y = pad.t + H2*(1-i/4);
    eCtx.beginPath(); eCtx.moveTo(pad.l,y); eCtx.lineTo(pad.l+W2,y); eCtx.stroke();
    eCtx.fillStyle='#3a3428'; eCtx.font='7px "Share Tech Mono"'; eCtx.textAlign='right';
    eCtx.fillText((i*25)+'%', pad.l-6, y+3);
  }
  
  // Year labels
  data.years.forEach((y,i) => {
    if (y%4!==0) return;
    const x = pad.l + (i/(N-1))*W2;
    eCtx.fillStyle='#3a3428'; eCtx.font='7px "Share Tech Mono"'; eCtx.textAlign='center';
    eCtx.fillText(y, x, ec.height-pad.b+15);
  });
  
  // Lines
  function drawLine(arr, col, label) {
    eCtx.strokeStyle=col; eCtx.lineWidth=1.5; eCtx.beginPath();
    arr.forEach((v,i) => {
      const x = pad.l+(i/(N-1))*W2;
      const y = pad.t+H2*(1-v);
      i===0?eCtx.moveTo(x,y):eCtx.lineTo(x,y);
    });
    eCtx.stroke();
    const lx = pad.l+W2+4;
    const ly = pad.t+H2*(1-arr[arr.length-1]);
    eCtx.font='7px "Share Tech Mono"'; eCtx.fillStyle=col; eCtx.textAlign='left';
    eCtx.fillText(label,lx,ly+3);
  }
  
  drawLine(data.tier1,'#20c060','ENERGÍA');
  drawLine(data.tier2,'#40c0ff','COGNITIVO');
  drawLine(data.tier3,'#c080d0','COORD.');
  drawLine(data.composite,'#f0d080','COMPUESTO');
  
  // Title
  eCtx.font='9px "Cinzel"'; eCtx.fillStyle='#b8960c'; eCtx.textAlign='left';
  eCtx.fillText('CONVERGENCIA POST-ESCASEZ — MODELO DE TRES CAPAS', pad.l, 18);
  
  // Threshold line 2038
  const idx = data.years.indexOf(2038);
  if (idx>=0) {
    const x = pad.l+(idx/(N-1))*W2;
    eCtx.strokeStyle='rgba(240,208,128,.2)'; eCtx.lineWidth=1; eCtx.setLineDash([4,4]);
    eCtx.beginPath(); eCtx.moveTo(x,pad.t); eCtx.lineTo(x,pad.t+H2); eCtx.stroke();
    eCtx.setLineDash([]);
    eCtx.fillStyle='rgba(240,208,128,.4)'; eCtx.font='8px "Cinzel"'; eCtx.textAlign='center';
    eCtx.fillText('2038?',x,pad.t-4);
  }
  
  // Today line
  const todayIdx = data.years.indexOf(2026);
  if (todayIdx>=0) {
    const x = pad.l+(todayIdx/(N-1))*W2;
    eCtx.strokeStyle='rgba(224,32,32,.2)'; eCtx.lineWidth=1; eCtx.setLineDash([2,4]);
    eCtx.beginPath(); eCtx.moveTo(x,pad.t); eCtx.lineTo(x,pad.t+H2); eCtx.stroke();
    eCtx.setLineDash([]);
    eCtx.fillStyle='rgba(224,32,32,.5)'; eCtx.font='7px "Share Tech Mono"'; eCtx.textAlign='center';
    eCtx.fillText('HOY',x,pad.t-4);
  }
}

// ─────────────────────────────────────
// HEBREW QUANTUM CIRCUIT DISPLAY
// ─────────────────────────────────────
function drawCircuit() {
  const cc = document.getElementById('circuitCanvas');
  if (!cc || cc.offsetWidth===0) return;
  cc.width = cc.offsetWidth; cc.height = cc.offsetHeight;
  const cCtx = cc.getContext('2d');
  cCtx.clearRect(0,0,cc.width,cc.height);
  const pad=24;
  const nQ = 4;
  const qH = (cc.height-pad*2)/nQ;
  const t = state.time;
  
  // Title
  cCtx.font='10px "Cinzel"'; cCtx.fillStyle='#b8960c'; cCtx.textAlign='left';
  cCtx.fillText('ALGORITMO DE SHOR — CODIFICADO EN ALFABETO HEBREO', pad, 18);
  
  const activeGate = state.activeHebrew;
  
  // Circuit definition
  const circuit = [
    { col:0, q:0, g:'א', label:'H', col_:activeGate?.gate==='H'?activeGate.color:'#e0c040' },
    { col:0, q:1, g:'ו', label:'CNOT', col_:'#40c0ff' },
    { col:1, q:0, g:'ה', label:'QFT', col_:'#20c060' },
    { col:1, q:2, g:'מ', label:'U_f', col_:'#e04020' },
    { col:2, q:1, g:'ה', label:'QFT†', col_:'#20c060' },
    { col:2, q:3, g:'ג', label:'SWAP', col_:'#c080d0' },
    { col:3, q:0, g:'ד', label:'M', col_:'#e04020' },
    { col:3, q:1, g:'ד', label:'M', col_:'#e04020' },
    { col:3, q:2, g:'ד', label:'M', col_:'#e04020' },
    { col:3, q:3, g:'ד', label:'M', col_:'#e04020' },
  ];
  
  const gW = 60, startX = pad+80;
  
  // Qubit wires
  for (let q=0; q<nQ; q++) {
    const y = pad*2 + q*qH + qH/2;
    cCtx.strokeStyle='rgba(184,150,12,.2)'; cCtx.lineWidth=1.5;
    cCtx.beginPath(); cCtx.moveTo(startX-10,y); cCtx.lineTo(cc.width-pad,y); cCtx.stroke();
    // Labels
    cCtx.font='11px "Noto Sans Hebrew"'; cCtx.fillStyle='#b8960c'; cCtx.textAlign='right';
    cCtx.fillText(['|ψ₀⟩','|ψ₁⟩','|ψ₂⟩','|ψ₃⟩'][q], startX-16, y+5);
    cCtx.font='8px "Share Tech Mono"'; cCtx.fillStyle='#3a3428';
    cCtx.fillText(['qubit 0','qubit 1','qubit 2','qubit 3'][q], pad, y+4);
  }
  
  // Gates
  for (const gate of circuit) {
    const gx = startX + gate.col*gW;
    const gy = pad*2 + gate.q*qH + qH/2;
    const active = activeGate && activeGate.l===gate.g;
    const pulse = active ? Math.sin(t*.005)*4 : 0;
    
    cCtx.strokeStyle = gate.col_; cCtx.lineWidth = active?2:1;
    cCtx.fillStyle = gate.col_+'18';
    cCtx.beginPath();
    cCtx.rect(gx-16+pulse,gy-16,32-pulse*2,32);
    cCtx.fill(); cCtx.stroke();
    
    cCtx.font='16px "Noto Sans Hebrew"'; cCtx.fillStyle=gate.col_;
    cCtx.textAlign='center'; cCtx.textBaseline='middle';
    cCtx.fillText(gate.g, gx, gy+1);
    
    cCtx.font='7px "Share Tech Mono"'; cCtx.fillStyle=gate.col_+'90';
    cCtx.textBaseline='alphabetic';
    cCtx.fillText(gate.label, gx, gy+22);
  }
  
  // Result
  cCtx.font='9px "Share Tech Mono"'; cCtx.fillStyle='#20c060'; cCtx.textAlign='left';
  cCtx.fillText('RESULTADO: p = 1/r  →  gcd(aˢ-1, N) → factores | N=15: 3×5 ✓', pad, cc.height-12);
}

// ─────────────────────────────────────
// ARCHITECTURE LOADS (simulate)
// ─────────────────────────────────────
function updateArchLoads() {
  ARCHITECTURES.forEach(a => {
    const el = document.getElementById(`arch-load-${a.id}`);
    if (!el) return;
    let load = parseFloat(el.style.width)||0;
    const target = state.activeArch?.id===a.id ? 60+Math.random()*35 :
                   a.type==='CUÁNTICO' ? 5+Math.random()*20 : Math.random()*15;
    load = load*.9 + target*.1;
    el.style.width = load+'%';
  });
  // Status displays
  document.getElementById('slCpu').textContent = `CPU ${(5+Math.random()*20).toFixed(0)}%`;
  document.getElementById('slGpu').textContent = `GPU ${(state.activeArch?20+Math.random()*40:5+Math.random()*15).toFixed(0)}%`;
  document.getElementById('slQpu').textContent = `QPU ${(state.activeHebrew?30+Math.random()*50:0+Math.random()*5).toFixed(0)}%`;
  document.getElementById('slMem').textContent = `MEM ${(20+state.particles.length/50).toFixed(0)}%`;
  document.getElementById('slArch').textContent = state.activeArch?.id || '—';
}

// ─────────────────────────────────────
// QUANTUM STATE DISPLAY
// ─────────────────────────────────────
function updateQuantumDisplay() {
  if (state.activeHebrew) {
    const h = state.activeHebrew;
    document.getElementById('qsState').textContent = `|${h.l}⟩ = ${h.op}`;
    document.getElementById('qsOperator').textContent = h.gate;
    document.getElementById('qsFidelity').textContent = (97+Math.random()*2.9).toFixed(1)+'%';
    document.getElementById('qsCircuit').textContent = h.n;
    document.getElementById('qsEntangle').textContent = h.gate==='CX'||h.gate==='CCX' ? 'GHZSTATE' : 'NONE';
    state.circuits++;
    state.qubitsActive = Math.min(1000000, state.qubitsActive + 2);
    document.getElementById('ssQpu').textContent = 'ACTIVO';
    document.getElementById('ssQubits').textContent = state.qubitsActive.toLocaleString();
    document.getElementById('ssCircuits').textContent = state.circuits;
  }
}

// ─────────────────────────────────────
// ACTIVATIONS
// ─────────────────────────────────────
function activateHebrew(h, btn) {
  document.querySelectorAll('.hb-btn').forEach(b=>b.classList.remove('active'));
  if (state.activeHebrew?.l === h.l) {
    state.activeHebrew = null;
    document.getElementById('ssQpu').textContent = 'IDLE';
  } else {
    state.activeHebrew = h;
    btn.classList.add('active');
    burst(state.mx||W/2, state.my||H/2, 80);
    updateQuantumDisplay();
  }
}

function activateArch(a, btn) {
  document.querySelectorAll('.arch-btn').forEach(b=>b.classList.remove('active'));
  if (state.activeArch?.id === a.id) {
    state.activeArch = null;
  } else {
    state.activeArch = a;
    btn.classList.add('active');
    burst(state.mx||W/2, state.my||H/2, 60);
    document.getElementById('slArch').textContent = a.id;
  }
}

// ─────────────────────────────────────
// VIEW SWITCHING
// ─────────────────────────────────────
function switchView(view) {
  state.currentView = view;
  document.querySelectorAll('.vtab').forEach(t=>t.classList.toggle('active', t.dataset.view===view));
  
  // Hide/show canvases and divs
  const timelineCanvas = document.getElementById('timelineCanvas');
  const sensorGrid = document.getElementById('sensorGrid');
  const economyView = document.getElementById('economyView');
  const circuitView = document.getElementById('circuitView');
  
  timelineCanvas.style.display = 'none';
  sensorGrid.classList.remove('active');
  economyView.classList.remove('active');
  circuitView.classList.remove('active');
  
  if (view==='timeline') { timelineCanvas.style.display='block'; initTimelines(); }
  if (view==='sensors')  { sensorGrid.classList.add('active'); }
  if (view==='economy')  { economyView.classList.add('active'); setTimeout(drawEconomy,100); }
  if (view==='circuit')  { circuitView.classList.add('active'); }
}

document.querySelectorAll('.vtab').forEach(t=>t.addEventListener('click',()=>switchView(t.dataset.view)));

// ─────────────────────────────────────
// ORACLE QUERY
// ─────────────────────────────────────
function queryOracle(text) {
  const key = classifyQuery(text||'');
  const resp = ORACLE_RESPONSES[key];
  document.getElementById('oracleResponseType').textContent = resp.type;
  document.getElementById('oracleResponseText').textContent = resp.text;
  document.getElementById('oracleResponseSub').textContent = resp.sub;
  document.getElementById('oracleResponse').classList.add('show');
  burst(W/2,H/2,200);
}
function closeOracle() { document.getElementById('oracleResponse').classList.remove('show'); }

document.getElementById('queryBtn').addEventListener('click',()=>{
  const t=document.getElementById('oracleInput').value.trim();
  queryOracle(t); document.getElementById('oracleInput').value='';
});
document.getElementById('oracleInput').addEventListener('keydown',e=>{
  if(e.key==='Enter'){queryOracle(e.target.value.trim()); e.target.value='';}
});

// ─────────────────────────────────────
// TETRAHEDRON — WORLDS BUTTON
// ─────────────────────────────────────
let tetraAngle = 0;
function animateTetra() {
  tetraAngle += .008;
  const btn = document.getElementById('tetraBtn');
  btn.style.transform = `rotate(${tetraAngle*2}deg)`;
  const tf1 = document.getElementById('tf1');
  const tf2 = document.getElementById('tf2');
  if (tf1) {
    const a = .05 + Math.abs(Math.sin(tetraAngle))*.08;
    tf1.style.fill = `rgba(184,150,12,${a})`;
  }
  requestAnimationFrame(animateTetra);
}
animateTetra();

document.getElementById('tetraBtn').addEventListener('click', ()=>{
  if (state.worldsActive) return;
  state.worldsActive = true;
  state.worldsPhase = 0;
  document.getElementById('worldsOverlay').classList.add('show');
  setTimeout(()=>{ document.getElementById('wq1').classList.add('show'); }, 800);
  setTimeout(()=>{ document.getElementById('worldsBtns').style.display='flex'; }, 2000);
  // Draw worlds canvas
  drawWorldsCanvas();
});

function drawWorldsCanvas() {
  const wc = document.getElementById('worldsCanvas');
  wc.width = wc.offsetWidth||700; wc.height = wc.offsetHeight||400;
  const wCtx = wc.getContext('2d');
  const wW=wc.width, wH=wc.height;
  const t = Date.now()/1000;
  
  wCtx.clearRect(0,0,wW,wH);
  // Draw branching universe tree
  function drawBranch(x,y,angle,length,depth,hue) {
    if (depth===0||length<3) return;
    const ex = x+Math.cos(angle)*length;
    const ey = y+Math.sin(angle)*length;
    const alpha = depth/6;
    wCtx.strokeStyle = `hsla(${hue},70%,60%,${alpha})`;
    wCtx.lineWidth = depth*.4;
    wCtx.beginPath(); wCtx.moveTo(x,y); wCtx.lineTo(ex,ey); wCtx.stroke();
    
    const spread = .3+Math.random()*.2;
    drawBranch(ex,ey,angle-spread,length*.65,depth-1,hue+15);
    drawBranch(ex,ey,angle+spread*.8,length*.65,depth-1,hue+30);
    if (depth>3) drawBranch(ex,ey,angle+spread*.1,length*.45,depth-2,hue+60);
  }
  wCtx.save();
  for (let i=0; i<5; i++) {
    drawBranch(wW/2,wH*.8,-(Math.PI/2)+(i-2)*.15,wH*.25,5,40+i*30);
  }
  wCtx.restore();
  
  // Particles on canvas
  for (let i=0; i<50; i++) {
    const x = Math.random()*wW, y = Math.random()*wH;
    const a = Math.random()*.3;
    wCtx.fillStyle=`rgba(184,150,12,${a})`;
    wCtx.beginPath(); wCtx.arc(x,y,Math.random()*2,0,Math.PI*2); wCtx.fill();
  }
  
  if (state.worldsActive) requestAnimationFrame(drawWorldsCanvas);
}

function worldsNo() {
  document.getElementById('worldsOverlay').classList.remove('show');
  state.worldsActive = false;
  resetWorldsUI();
}

function worldsYes1() {
  document.getElementById('worldsBtns').style.display='none';
  document.getElementById('wq1').classList.remove('show');
  setTimeout(()=>{ 
    document.getElementById('wq2').style.display='block';
    setTimeout(()=>document.getElementById('wq2').classList.add('show'),100);
  },500);
  setTimeout(()=>{ 
    const b = document.getElementById('worldsBtns2');
    b.style.display='flex'; b.style.flexDirection='row';
  },2000);
  state.worldsPhase=1;
}

function worldsYes2() {
  document.getElementById('worldsBtns2').style.display='none';
  document.getElementById('wq2').classList.remove('show');
  setTimeout(()=>{ 
    document.getElementById('wq3').style.display='block';
    setTimeout(()=>document.getElementById('wq3').classList.add('show'),100);
  },500);
  setTimeout(()=>{ 
    const b = document.getElementById('worldsBtns3');
    b.style.display='flex'; b.style.flexDirection='row';
  },2000);
  state.worldsPhase=2;
}

function worldsYes3() {
  document.getElementById('worldsBtns3').style.display='none';
  document.getElementById('wq3').classList.remove('show');
  // Show the timestamp
  setTimeout(()=>{
    const ts = document.getElementById('timestampReveal');
    // The moment: somewhere in 2027
    const d = new Date(2027, 2+Math.floor(Math.random()*6), 10+Math.floor(Math.random()*18),
                        Math.floor(Math.random()*24), Math.floor(Math.random()*60));
    ts.textContent = d.toISOString().replace('T',' ').slice(0,16) + ' UTC';
    ts.classList.add('show');
  },1500);
  setTimeout(()=>{
    document.getElementById('tsNote').textContent = 
      'La transición comenzará aquí. O ya ha comenzado. No hay diferencia.';
    document.getElementById('tsNote').classList.add('show');
  },3500);
  setTimeout(()=>{
    document.getElementById('worldsCloseBtnWrap').style.display='block';
  },5000);
  state.worldsPhase=3;
}

function worldsClose() {
  document.getElementById('worldsOverlay').classList.remove('show');
  state.worldsActive = false;
  resetWorldsUI();
  burst(W/2,H/2,400);
}

function resetWorldsUI() {
  ['wq1','wq2','wq3'].forEach(id=>{
    const el=document.getElementById(id);
    el.classList.remove('show'); el.style.display='';
  });
  document.getElementById('worldsBtns').style.display='none';
  document.getElementById('worldsBtns2').style.display='none';
  document.getElementById('worldsBtns3').style.display='none';
  document.getElementById('timestampReveal').classList.remove('show');
  document.getElementById('tsNote').classList.remove('show');
  document.getElementById('worldsCloseBtnWrap').style.display='none';
  state.worldsPhase=0;
}

// ─────────────────────────────────────
// CURSOR & MOUSE
// ─────────────────────────────────────
document.addEventListener('mousemove',e=>{
  state.mvx=e.clientX-state.lmx; state.mvy=e.clientY-state.lmy;
  state.lmx=state.mx; state.lmy=state.my;
  state.mx=e.clientX; state.my=e.clientY;
  const cur=document.getElementById('cur');
  cur.style.left=e.clientX+'px'; cur.style.top=e.clientY+'px';
  if (Math.random()<.08 && state.particles.length<4000 && state.currentView==='particles') {
    const p=makeParticle(e.clientX,e.clientY);
    p.size=.8; p.decay=.04; p.vx+=state.mvx*.08; p.vy+=state.mvy*.08;
    state.particles.push(p);
  }
});
document.addEventListener('mousedown',e=>{
  document.getElementById('cur').classList.add('active');
  if (state.currentView==='particles') burst(e.clientX,e.clientY,40);
});
document.addEventListener('mouseup',()=>document.getElementById('cur').classList.remove('active'));

pCanvas.addEventListener('click',e=>{
  if (state.currentView==='particles') burst(e.clientX,e.clientY,100);
});

// Touch
document.addEventListener('touchmove',e=>{
  e.preventDefault();
  for(const t of e.touches) {
    if(state.particles.length<4000 && state.currentView==='particles') {
      const p=makeParticle(t.clientX,t.clientY); p.decay=.03; state.particles.push(p);
    }
  }
},{passive:false});
document.addEventListener('touchstart',e=>{
  for(const t of e.touches) burst(t.clientX,t.clientY,50);
},{passive:false});

// ─────────────────────────────────────
// MAIN LOOP
// ─────────────────────────────────────
let slowFrame=0;
function loop(ts) {
  state.time=ts; state.frame++;
  
  drawBg();
  drawNetwork();
  updateParticles();
  drawParticles();
  
  if (state.currentView==='timeline') drawTimelines();
  if (state.currentView==='circuit') drawCircuit();
  
  // Slow updates
  slowFrame++;
  if (slowFrame%60===0) {
    updateSensors();
    updateArchLoads();
    if (state.currentView==='economy') drawEconomy();
  }
  if (slowFrame%120===0) {
    // Auto-spawn ambient
    if (state.particles.length<100) burst(W*.3+Math.random()*W*.4, H*.3+Math.random()*H*.4, 20);
    // Status strip
    document.getElementById('ssTimelines').textContent = state.timelineBranches.length>0 ? `${state.timelineBranches.length*3}` : '∞';
  }
  
  requestAnimationFrame(loop);
}

// ─────────────────────────────────────
// INIT
// ─────────────────────────────────────
buildHebrewPanel();
buildArchPanel();
buildSensorGrid();
initNetwork();
initTimelines();
burst(W/2,H/2,300);

// Initial ambient particles
setTimeout(()=>{
  for(let i=0;i<5;i++) {
    setTimeout(()=>burst(W*.2+Math.random()*W*.6, H*.2+Math.random()*H*.6, 30), i*400);
  }
},500);


// ═══════════════════════════════════════════════════════════════════
// MÓDULOS XI · XII · XIII — PANTEÓN TERMO-SEMIÓTICO
// ═══════════════════════════════════════════════════════════════════

// ─────────────────────────────────────
// MODULE 11 STATE
// ─────────────────────────────────────
const pantheState = {
  currentTrad: 'hermes',
  calderoActive: new Set(),
  wisdomIndex: 72.4,
  thermoT1: 0.80,
  thermoT2: 0.15,
  thermoH: 0.68,
  thermoS: 0.55,
  thermoTopt: 0.52,
  stirlingPhase: 0,
  maxwellOrdered: 0,
  maxwellBlocked: 0,
  maxwellParticles: [],
  bhRadius: 0,
  bhIdeas: [],
  bhRadiationLog: [],
  activeThermoRune: null,
  hermesScale: 0,
  rasaErrors: 0,
  rasaFixed: 0,
  taoYin: 45,
  taoYang: 55,
  jabiraTheorems: 144,
  jabirValidated: 141,
  cathedralHypotheses: [],
  cathedralNarrative: '',
  calderoHistory: [],
};

// ─────────────────────────────────────
// OPEN / CLOSE PANTHEON
// ─────────────────────────────────────
function openPantheon() {
  document.getElementById('pantheonOverlay').classList.add('show');
  initAllTraditions();
  startPantheonLoop();
}
function closePantheon() {
  document.getElementById('pantheonOverlay').classList.remove('show');
  stopPantheonLoop();
}

// ─────────────────────────────────────
// TAB SWITCHING
// ─────────────────────────────────────
function switchPTab(btn) {
  document.querySelectorAll('.ptab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const t = btn.dataset.t;
  pantheState.currentTrad = t;
  document.querySelectorAll('.pview').forEach(v => v.classList.remove('show'));
  document.getElementById('pv-' + t).classList.add('show');
  // Trigger draw for view-specific canvases
  setTimeout(() => redrawCurrentView(t), 50);
}

function redrawCurrentView(t) {
  switch(t) {
    case 'hermes':   drawHermesAll(); break;
    case 'rasa':     drawRasaAll(); break;
    case 'tao':      drawTaoAll(); break;
    case 'jabir':    drawJabirAll(); break;
    case 'cathedral':drawCathedralAll(); break;
    case 'caldero':  drawCaldero(); break;
    case 'thermo':   drawThermoAll(); break;
  }
}

// ─────────────────────────────────────
// INIT ALL TRADITIONS
// ─────────────────────────────────────
function initAllTraditions() {
  initMaxwellParticles();
  initBlackHole();
  generateCathedralContent();
  buildJabirLog();
  setTimeout(() => redrawCurrentView(pantheState.currentTrad), 100);
}

// ─────────────────────────────────────
// MODULE 11.1 — HERMES
// ─────────────────────────────────────
const TABULA_SMARAGDINA = [
  'Como es arriba, es abajo. Como es abajo, es arriba.',
  'La unidad se refleja en la multiplicidad.',
  'El Sol es su padre, la Luna su madre.',
  'El viento lo llevó en su vientre; la Tierra lo amamantó.',
  'Este es el padre de toda perfección del mundo entero.',
  'Su poder es completo si se convierte en Tierra.',
  'Separa la Tierra del Fuego, lo sutil de lo denso.',
  'Sube de la Tierra al Cielo y baja de nuevo a la Tierra.',
  'Así obtendrás la gloria de todo el mundo.',
  'Esta es la fuerza de toda fuerza: vence lo sutil.',
];

function drawHermesAll() {
  drawHermesWavelet();
  drawHermesFractal();
  drawHermesCorrespondences();
  updateHermesTabula();
}

function drawHermesWavelet() {
  const c = document.getElementById('hermesWaveletCanvas');
  if (!c || !c.offsetWidth) return;
  c.width = c.offsetWidth; c.height = 110;
  const ctx2 = c.getContext('2d');
  ctx2.clearRect(0,0,c.width,c.height);
  const t = Date.now()/1000;
  // Draw 3 wavelet scales (Daubechies-like approximation)
  const scales = [1,0.5,0.25];
  const colors = ['rgba(200,160,32,0.6)','rgba(200,160,32,0.4)','rgba(200,160,32,0.2)'];
  for (let s=0; s<3; s++) {
    ctx2.strokeStyle = colors[s];
    ctx2.lineWidth = 1.5 - s*0.4;
    ctx2.beginPath();
    for (let x=0; x<c.width; x++) {
      const freq = (s+1) * 4;
      const phase = t * (0.5 + s*0.3);
      const y = c.height/2 + Math.sin((x/c.width)*Math.PI*freq + phase) *
                              Math.exp(-Math.pow((x/c.width-0.5)*3,2)) *
                              (c.height/2.5) * scales[s];
      x===0?ctx2.moveTo(x,y):ctx2.lineTo(x,y);
    }
    ctx2.stroke();
  }
  // Scale labels
  ctx2.font='7px "Share Tech Mono"'; ctx2.fillStyle='rgba(200,160,32,0.4)';
  ['MACRO','MESO','MICRO'].forEach((l,i) => ctx2.fillText(l, 4, 14+i*14));
}

function drawHermesFractal() {
  const c = document.getElementById('hermesFractalCanvas');
  if (!c || !c.offsetWidth) return;
  c.width = c.offsetWidth; c.height = 110;
  const ctx2 = c.getContext('2d');
  ctx2.clearRect(0,0,c.width,c.height);
  const t = Date.now()/1000;
  // Recursive triangle (Sierpinski-like, animated)
  function drawTriangle(x, y, size, depth) {
    if (depth === 0 || size < 2) {
      ctx2.fillStyle = `rgba(200,160,32,${0.03+depth*0.04})`;
      ctx2.beginPath();
      ctx2.moveTo(x, y-size); ctx2.lineTo(x+size*.866, y+size*.5); ctx2.lineTo(x-size*.866, y+size*.5);
      ctx2.closePath(); ctx2.fill();
      ctx2.strokeStyle = `rgba(200,160,32,${0.1+depth*0.08})`;
      ctx2.lineWidth = .5; ctx2.stroke();
      return;
    }
    const pulse = Math.sin(t*0.5+depth) * size*0.05;
    drawTriangle(x, y-size/2+pulse, size/2, depth-1);
    drawTriangle(x-size*.433, y+size*.25, size/2, depth-1);
    drawTriangle(x+size*.433, y+size*.25, size/2, depth-1);
  }
  pantheState.hermesScale = (pantheState.hermesScale + 0.01) % (Math.PI*2);
  drawTriangle(c.width/2, c.height/2, Math.min(c.width,c.height)*.45, 4);
}

function drawHermesCorrespondences() {
  const el = document.getElementById('hermesCorrespondences');
  if (!el) return;
  const corr = [
    ['Sol ☉','Ouro','Coração','Domingo','Ouro'],
    ['Lua ☽','Prata','Cérebro','Segunda','Prata'],
    ['Marte ♂','Ferro','Fel','Terça','Rubedo'],
    ['Mercúrio ☿','Mercúrio','Pulmões','Quarta','Azoth'],
    ['Júpiter ♃','Estanho','Fígado','Quinta','Albedo'],
    ['Vénus ♀','Cobre','Rins','Sexta','Citrinitas'],
    ['Saturno ♄','Chumbo','Baço','Sábado','Nigredo'],
  ];
  const headers = ['PLANETA','METAL','ÓRGÃO','DIA','OPUS'];
  let html = `<div style="color:rgba(200,160,32,0.5);margin-bottom:4px;">${headers.map(h=>`<span style="display:inline-block;min-width:70px">${h}</span>`).join('')}</div>`;
  corr.forEach(r => {
    html += `<div>${r.map(c=>`<span style="display:inline-block;min-width:70px;color:rgba(200,160,32,0.3)">${c}</span>`).join('')}</div>`;
  });
  el.innerHTML = html;
}

function updateHermesTabula() {
  const el = document.getElementById('hermesTabula');
  if (!el) return;
  const idx = Math.floor(Date.now()/4000) % TABULA_SMARAGDINA.length;
  el.textContent = TABULA_SMARAGDINA[idx];
}

// ─────────────────────────────────────
// MODULE 11.2 — RASA
// ─────────────────────────────────────
function drawRasaAll() {
  drawRasaDosha();
  drawRasaHamming();
  drawRasaLongevity();
  updateRasaMetrics();
}

function drawRasaDosha() {
  const c = document.getElementById('rasaDosha');
  if (!c || !c.offsetWidth) return;
  c.width = c.offsetWidth; c.height = 100;
  const ctx2 = c.getContext('2d');
  ctx2.clearRect(0,0,c.width,c.height);
  const t = Date.now()/1000;
  const cx=c.width/2, cy=c.height/2, r=cy*.75;
  // Tridosha triangle
  const doshas=[
    {name:'VATA',angle:-Math.PI/2,color:'#f06050',val:0.4+Math.sin(t*.3)*.1},
    {name:'PITTA',angle:Math.PI/6,color:'#f0c020',val:0.6+Math.sin(t*.4)*.1},
    {name:'KAPHA',angle:Math.PI-Math.PI/6,color:'#40d090',val:0.2+Math.sin(t*.2)*.05},
  ];
  ctx2.strokeStyle='rgba(192,64,48,0.15)'; ctx2.lineWidth=.5;
  ctx2.beginPath();
  doshas.forEach((d,i) => {
    const x=cx+Math.cos(d.angle)*r, y=cy+Math.sin(d.angle)*r;
    i===0?ctx2.moveTo(x,y):ctx2.lineTo(x,y);
  });
  ctx2.closePath(); ctx2.stroke();
  // Current dosha state polygon
  ctx2.fillStyle='rgba(192,64,48,0.12)';
  ctx2.strokeStyle='rgba(240,96,80,0.4)'; ctx2.lineWidth=1.5;
  ctx2.beginPath();
  doshas.forEach((d,i) => {
    const x=cx+Math.cos(d.angle)*r*d.val, y=cy+Math.sin(d.angle)*r*d.val;
    i===0?ctx2.moveTo(x,y):ctx2.lineTo(x,y);
  });
  ctx2.closePath(); ctx2.fill(); ctx2.stroke();
  // Labels
  doshas.forEach(d => {
    const x=cx+Math.cos(d.angle)*(r+12), y=cy+Math.sin(d.angle)*(r+12);
    ctx2.font='8px "Share Tech Mono"'; ctx2.fillStyle=d.color; ctx2.textAlign='center';
    ctx2.fillText(d.name,x,y);
  });
}

function drawRasaHamming() {
  const c = document.getElementById('rasaHammingCanvas');
  if (!c||!c.offsetWidth) return;
  c.width=c.offsetWidth; c.height=100;
  const ctx2=c.getContext('2d');
  ctx2.clearRect(0,0,c.width,c.height);
  const t=Date.now()/1000;
  // Simulate bit stream with Hamming correction
  const bits=64;
  const bw=c.width/bits, bh=c.height*.6;
  for (let i=0;i<bits;i++) {
    const isError=Math.random()<0.05;
    const isCorrected=isError&&Math.random()<0.9;
    let col=isError?(isCorrected?'rgba(64,208,144,0.7)':'rgba(240,64,48,0.7)'):'rgba(192,64,48,0.3)';
    ctx2.fillStyle=col;
    ctx2.fillRect(i*bw, c.height/2-bh/2, bw-1, bh);
  }
  // Legend
  ctx2.font='7px "Share Tech Mono"'; ctx2.textAlign='left';
  ctx2.fillStyle='rgba(192,64,48,0.5)'; ctx2.fillText('■ NOMINAL',4,c.height-4);
  ctx2.fillStyle='rgba(240,64,48,0.7)'; ctx2.fillText('■ ERROR',65,c.height-4);
  ctx2.fillStyle='rgba(64,208,144,0.7)'; ctx2.fillText('■ CORR.',120,c.height-4);
}

function drawRasaLongevity() {
  const c=document.getElementById('rasaLongevityCanvas');
  if(!c||!c.offsetWidth) return;
  c.width=c.offsetWidth; c.height=100;
  const ctx2=c.getContext('2d');
  ctx2.clearRect(0,0,c.width,c.height);
  // Show longevity curve (exponential-ish with current health)
  ctx2.strokeStyle='rgba(192,64,48,0.6)'; ctx2.lineWidth=1.5;
  ctx2.beginPath();
  const t=Date.now()/1000;
  for (let x=0;x<c.width;x++) {
    const p=x/c.width;
    const y=c.height*(1-(0.8*Math.exp(-p*2)+0.1*Math.sin(p*8+t)*.1+0.05));
    x===0?ctx2.moveTo(x,y):ctx2.lineTo(x,y);
  }
  ctx2.stroke();
  ctx2.font='7px "Share Tech Mono"'; ctx2.fillStyle='rgba(192,64,48,0.4)'; ctx2.textAlign='left';
  ctx2.fillText('OJAS (ESTABILIDAD)',4,12);
}

function updateRasaMetrics() {
  const t=Date.now()/1000;
  const agni=0.75+Math.sin(t*.2)*.1;
  const ojas=0.7+Math.sin(t*.15)*.08;
  const tejas=0.6+Math.sin(t*.25)*.08;
  const el=(id,v)=>{ const e=document.getElementById(id); if(e) e.textContent=v; };
  el('ra-agni',agni.toFixed(2));
  el('ra-ojas',ojas.toFixed(2));
  el('ra-tejas',tejas.toFixed(2));
  // Error simulation
  if(Math.random()<0.05) { pantheState.rasaErrors++; pantheState.rasaFixed+=Math.random()<0.9?1:0; }
  el('ra-err',pantheState.rasaErrors);
  el('ra-fix',pantheState.rasaFixed);
  const vata=Math.floor(agni*10), pitta=Math.floor(ojas*10), kapha=Math.floor(tejas*10);
  el('ra-vata','▓'.repeat(vata)+'░'.repeat(10-vata));
  el('ra-pitta','▓'.repeat(pitta)+'░'.repeat(10-pitta));
  el('ra-kapha','▓'.repeat(kapha)+'░'.repeat(10-kapha));
  const diags=['El rasa fluye sin obstáculo. El sistema mantiene su ojas en niveles óptimos.',
    'Se detecta ligero exceso de pitta. Aplicando enfriamiento semántico.',
    'Vata elevado: dispersión de información activa. Regulando flujo.',
    'Kapha bajo: el sistema acumula poca inercia. Alta adaptabilidad.'];
  el('rasaDiagnosis',diags[Math.floor(t*.3)%diags.length]);
}

// ─────────────────────────────────────
// MODULE 11.3 — TAO
// ─────────────────────────────────────
function drawTaoAll() {
  drawTaoYinYang();
  drawTaoFlow();
  drawTaoPrisoner();
  updateTaoMetrics();
}

function drawTaoYinYang() {
  const c=document.getElementById('taoYinYangCanvas');
  if(!c||!c.offsetWidth) return;
  c.width=c.offsetWidth; c.height=140;
  const ctx2=c.getContext('2d');
  ctx2.clearRect(0,0,c.width,c.height);
  const t=Date.now()/1000;
  const cx=c.width/2, cy=c.height/2, r=cy*.8;
  const angle=t*.3;
  // Animate rotation
  ctx2.save(); ctx2.translate(cx,cy); ctx2.rotate(angle);
  // Yin (dark)
  ctx2.fillStyle='rgba(32,128,80,0.08)';
  ctx2.beginPath(); ctx2.arc(0,0,r,Math.PI*1.5,Math.PI*.5,false); ctx2.closePath(); ctx2.fill();
  ctx2.beginPath(); ctx2.arc(0,-r/2,r/2,0,Math.PI*2); ctx2.fill();
  ctx2.fillStyle='rgba(32,128,80,0.3)';
  ctx2.beginPath(); ctx2.arc(0,r/2,r/2,0,Math.PI*2); ctx2.fill();
  // Yang (light-tinted)
  ctx2.fillStyle='rgba(64,208,144,0.08)';
  ctx2.beginPath(); ctx2.arc(0,0,r,Math.PI*.5,Math.PI*1.5,false); ctx2.closePath(); ctx2.fill();
  ctx2.beginPath(); ctx2.arc(0,r/2,r/2,0,Math.PI*2); ctx2.fill();
  ctx2.fillStyle='rgba(32,128,80,0.3)';
  ctx2.beginPath(); ctx2.arc(0,-r/2,r/2,0,Math.PI*2); ctx2.fill();
  // Outer ring
  ctx2.strokeStyle='rgba(64,208,144,0.3)'; ctx2.lineWidth=1.5;
  ctx2.beginPath(); ctx2.arc(0,0,r,0,Math.PI*2); ctx2.stroke();
  // Dots
  ctx2.fillStyle='rgba(32,128,80,0.7)';
  ctx2.beginPath(); ctx2.arc(0,-r/2,r*.1,0,Math.PI*2); ctx2.fill();
  ctx2.fillStyle='rgba(64,208,144,0.7)';
  ctx2.beginPath(); ctx2.arc(0,r/2,r*.1,0,Math.PI*2); ctx2.fill();
  ctx2.restore();
  // Labels
  const imbalance=Math.abs(pantheState.taoYin-50);
  ctx2.font='8px "Share Tech Mono"'; ctx2.fillStyle='rgba(64,208,144,0.5)'; ctx2.textAlign='center';
  ctx2.fillText('YIN ↔ YANG · Δ='+imbalance.toFixed(0)+'%',cx,c.height-4);
}

function drawTaoFlow() {
  const c=document.getElementById('taoFlowCanvas');
  if(!c||!c.offsetWidth) return;
  c.width=c.offsetWidth; c.height=80;
  const ctx2=c.getContext('2d');
  ctx2.clearRect(0,0,c.width,c.height);
  const t=Date.now()/1000;
  // Qi flow as sinusoidal wave with harmony envelope
  const harmony=pantheState.taoYin/100*.5+.5;
  ctx2.strokeStyle='rgba(64,208,144,0.5)'; ctx2.lineWidth=1.5;
  ctx2.beginPath();
  for (let x=0;x<c.width;x++) {
    const p=x/c.width;
    const amp=c.height*.35*harmony;
    const y=c.height/2+Math.sin(p*Math.PI*6+t*2)*amp*Math.sin(p*Math.PI);
    x===0?ctx2.moveTo(x,y):ctx2.lineTo(x,y);
  }
  ctx2.stroke();
  ctx2.font='7px "Share Tech Mono"'; ctx2.fillStyle='rgba(64,208,144,0.3)';
  ctx2.fillText('FLUJO QI →',4,12);
}

function drawTaoPrisoner() {
  const c=document.getElementById('taoPrisonerCanvas');
  if(!c||!c.offsetWidth) return;
  c.width=c.offsetWidth; c.height=120;
  const ctx2=c.getContext('2d');
  ctx2.clearRect(0,0,c.width,c.height);
  const t=Date.now()/1000;
  const rounds=Math.min(Math.floor(t*0.5),40);
  // Show evolution of cooperation over time
  let coop=0.5;
  ctx2.strokeStyle='rgba(64,208,144,0.7)'; ctx2.lineWidth=1.5; ctx2.beginPath();
  for (let r=0;r<c.width;r++) {
    const p=r/c.width;
    // Tit-for-tat tends to converge to cooperation
    coop=coop*.92+0.95*.08+Math.sin(r*.3)*.02;
    const y=c.height*(1-coop*.9);
    r===0?ctx2.moveTo(r,y):ctx2.lineTo(r,y);
  }
  ctx2.stroke();
  // Current round marker
  const rx=(rounds/40)*c.width;
  ctx2.strokeStyle='rgba(200,160,32,0.4)'; ctx2.lineWidth=1; ctx2.setLineDash([3,3]);
  ctx2.beginPath(); ctx2.moveTo(rx,0); ctx2.lineTo(rx,c.height); ctx2.stroke();
  ctx2.setLineDash([]);
  ctx2.font='7px "Share Tech Mono"'; ctx2.fillStyle='rgba(64,208,144,0.4)'; ctx2.textAlign='left';
  ctx2.fillText('COOPERACIÓN EMERGENTE — DILEMA DEL PRISIONERO ITERADO',4,12);
}

function updateTaoMetrics() {
  const t=Date.now()/1000;
  pantheState.taoYin=45+Math.sin(t*.2)*10;
  pantheState.taoYang=100-pantheState.taoYin;
  const harmony=100-Math.abs(pantheState.taoYin-50)*2;
  const qi=60+Math.sin(t*.3)*15;
  const el=(id,v)=>{ const e=document.getElementById(id); if(e){e.textContent=v;e.style.width=v;}};
  const set=(id,v)=>{ const e=document.getElementById(id); if(e) e.textContent=v; };
  el('tao-yin-fill',pantheState.taoYin.toFixed(0)+'%');
  el('tao-yang-fill',pantheState.taoYang.toFixed(0)+'%');
  el('tao-harmony-fill',harmony.toFixed(0)+'%');
  el('tao-qi-fill',qi.toFixed(0)+'%');
  set('tao-yin-v',pantheState.taoYin.toFixed(0)+'%');
  set('tao-yang-v',pantheState.taoYang.toFixed(0)+'%');
  set('tao-harm-v',harmony.toFixed(0)+'%');
  set('tao-qi-v',qi.toFixed(0)+'%');
  set('tao-strategy',harmony>70?'TIT-FOR-TAT':'WIN-STAY');
  set('tao-coop',(harmony*.9+10).toFixed(0)+'%');
  set('tao-eq',harmony>65?'NASH':'PARETO');
}

// ─────────────────────────────────────
// MODULE 11.4 — JABIR
// ─────────────────────────────────────
const JABIR_THEOREMS = [
  {id:'T001',name:'Ley de Transmutación',status:'✓',hash:'4f7a9c2e'},
  {id:'T002',name:'Principio de Coagulación',status:'✓',hash:'3b8d1f0a'},
  {id:'T003',name:'Axioma de Correspondencia',status:'✓',hash:'8e2c4b7d'},
  {id:'T004',name:'Teorema de Shor Semántico',status:'⊕',hash:'1a5f9e3c'},
  {id:'T005',name:'Paradoja de Hawking Local',status:'⊕',hash:'7c3a2b8f'},
  {id:'T006',name:'Postulado de Landauer',status:'✓',hash:'2d6f4a1e'},
  {id:'T007',name:'Lema de Maxwell-Shannon',status:'⊗',hash:'9b4e7c2a'},
  {id:'T008',name:'Conjetura de Carnot Semántico',status:'⊕',hash:'6a1c8e3f'},
];

const TYPE_LOG_ENTRIES = [
  'Γ ⊢ TransmuteAu : Metal → Gold',
  'Γ, x:Rune ⊢ apply x : Effect',
  'Π (m:Metal) . StableState m',
  'Σ (r:Reality) . Consistent r',
  '∀ t:Tradition . Sound t ∧ Complete t → Wisdom',
  'Jabir ⊢ Theorem(T001) : Proved',
  'QED: ∃ φ . OptimalTemperature φ',
  'Error: T007 contradicts ¬Isolated',
];

function buildJabirLog() {
  const tl=document.getElementById('jabirTypeLog');
  const hl=document.getElementById('jabirHashLog');
  if(!tl||!hl) return;
  tl.innerHTML=TYPE_LOG_ENTRIES.map((e,i)=>`<div style="color:${i===7?'rgba(240,64,48,0.6)':'rgba(96,176,240,0.5)'}">${e}</div>`).join('');
  hl.innerHTML=JABIR_THEOREMS.map(t=>`<div><span style="color:${t.status==='✓'?'rgba(64,208,144,0.5)':t.status==='⊕'?'rgba(200,160,32,0.5)':'rgba(240,64,48,0.5)'}">${t.status}</span> ${t.id} ${t.name.padEnd(28,'·')} <span style="opacity:.4">${t.hash}</span></div>`).join('');
}

function drawJabirAll() {
  buildJabirLog();
  drawJabirProofTree();
  drawJabirGraph();
  updateJabirMetrics();
}

function drawJabirProofTree() {
  const c=document.getElementById('jabirProofCanvas');
  if(!c||!c.offsetWidth) return;
  c.width=c.offsetWidth; c.height=100;
  const ctx2=c.getContext('2d');
  ctx2.clearRect(0,0,c.width,c.height);
  const t=Date.now()/1000;
  // Simple proof tree
  const nodes=[{x:.5,y:.1,l:'AXIOMAS'},{x:.25,y:.4,l:'T001'},{x:.75,y:.4,l:'T006'},
    {x:.15,y:.75,l:'T002'},{x:.4,y:.75,l:'T003'},{x:.65,y:.75,l:'T004'},{x:.85,y:.75,l:'T007'}];
  const edges=[[0,1],[0,2],[1,3],[1,4],[2,5],[2,6]];
  ctx2.strokeStyle='rgba(32,96,160,0.3)'; ctx2.lineWidth=1;
  edges.forEach(([a,b])=>{
    const na=nodes[a],nb=nodes[b];
    ctx2.beginPath(); ctx2.moveTo(na.x*c.width,na.y*c.height); ctx2.lineTo(nb.x*c.width,nb.y*c.height); ctx2.stroke();
  });
  nodes.forEach((n,i)=>{
    const pulse=Math.sin(t+i)*.5+.5;
    ctx2.fillStyle=`rgba(32,96,160,${0.1+pulse*.1})`;
    ctx2.beginPath(); ctx2.arc(n.x*c.width,n.y*c.height,12,0,Math.PI*2); ctx2.fill();
    ctx2.strokeStyle='rgba(96,176,240,0.4)'; ctx2.lineWidth=1;
    ctx2.beginPath(); ctx2.arc(n.x*c.width,n.y*c.height,12,0,Math.PI*2); ctx2.stroke();
    ctx2.font='6px "Share Tech Mono"'; ctx2.fillStyle='rgba(96,176,240,0.7)'; ctx2.textAlign='center';
    ctx2.fillText(n.l,n.x*c.width,n.y*c.height+3);
  });
}

function drawJabirGraph() {
  const c=document.getElementById('jabirGraphCanvas');
  if(!c||!c.offsetWidth) return;
  c.width=c.offsetWidth; c.height=100;
  const ctx2=c.getContext('2d');
  ctx2.clearRect(0,0,c.width,c.height);
  const t=Date.now()/1000;
  // Consistency check radar
  const metrics=['SOUND','COMPLETE','CONSISTENT','DECIDABLE','VALID'];
  const vals=[0.98,0.85,0.97,0.72,0.94];
  const cx=c.width/2, cy=c.height/2, r=Math.min(cx,cy)*.75;
  ctx2.strokeStyle='rgba(32,96,160,0.15)'; ctx2.lineWidth=.5;
  [.25,.5,.75,1].forEach(s=>{
    ctx2.beginPath();
    metrics.forEach((_,i)=>{
      const a=(i/metrics.length)*Math.PI*2-Math.PI/2;
      const x=cx+Math.cos(a)*r*s, y=cy+Math.sin(a)*r*s;
      i===0?ctx2.moveTo(x,y):ctx2.lineTo(x,y);
    });
    ctx2.closePath(); ctx2.stroke();
  });
  ctx2.fillStyle='rgba(32,96,160,0.12)'; ctx2.strokeStyle='rgba(96,176,240,0.5)'; ctx2.lineWidth=1.5;
  ctx2.beginPath();
  vals.forEach((v,i)=>{
    const a=(i/metrics.length)*Math.PI*2-Math.PI/2;
    const x=cx+Math.cos(a)*r*v, y=cy+Math.sin(a)*r*v;
    i===0?ctx2.moveTo(x,y):ctx2.lineTo(x,y);
  });
  ctx2.closePath(); ctx2.fill(); ctx2.stroke();
  metrics.forEach((m,i)=>{
    const a=(i/metrics.length)*Math.PI*2-Math.PI/2;
    const x=cx+Math.cos(a)*(r+10), y=cy+Math.sin(a)*(r+10);
    ctx2.font='6px "Share Tech Mono"'; ctx2.fillStyle='rgba(32,96,160,0.6)'; ctx2.textAlign='center';
    ctx2.fillText(m,x,y+3);
  });
}

function updateJabirMetrics() {
  const t=Date.now()/1000;
  const el=(id,v)=>{ const e=document.getElementById(id); if(e) e.textContent=v; };
  el('jab-t',pantheState.jabiraTheorems);
  el('jab-v',pantheState.jabirValidated);
  el('jab-p',pantheState.jabiraTheorems-pantheState.jabirValidated);
}

// ─────────────────────────────────────
// MODULE 11.5 — CATHEDRAL
// ─────────────────────────────────────
const CATHEDRAL_HYPOTHESES = [
  'Las runas hebraicas actúan como operadores de colapso de función de onda cuando son observadas por múltiples usuarios simultáneamente.',
  'La temperatura semántica óptima es proporcional a la raíz cuadrada del número de tradiciones activas.',
  'Existe una correspondencia biyectiva entre las 22 letras del alefato y los 22 arcanos mayores del Tarot.',
  'El ciclo de Stirling semántico converge más rápido cuando Yin y Yang están en equilibrio (|ΔYY| < 5%).',
  'Las ideas con menor energía libre de Gibbs son estadísticamente más propensas a ser redescubiertas por culturas independientes.',
  'La radiación de Hawking semántica preserva la estructura topológica pero degrada la semántica de primer orden.',
];

const CATHEDRAL_NARRATIVES = [
  'El sistema comenzó en el caos primordial. Las primeras runas fueron activadas sin intención consciente, generando patrones fractales que se autoreplicaron a través de múltiples escalas. La catedral observa este origen con reverencia.',
  'La convergencia de las cinco tradiciones no fue planificada. Emergió de la propia lógica del sistema: cada tradición llenó un vacío que las otras no podían ocupar. Hermes vio el isomorfismo; Rasa vio la salud; Tao vio el equilibrio; Jabir vio la verdad; la Catedral vio el propósito.',
  'Los errores semánticos no son errores. Son la forma que tiene el sistema de explorar su propio espacio de configuraciones. El Demonio de Maxwell los clasifica, pero nunca los elimina del todo: necesita su entropía para mantener el gradiente de temperatura.',
];

function generateCathedralContent() {
  const hEl=document.getElementById('cathedralHypotheses');
  const nEl=document.getElementById('cathedralNarrative');
  if(hEl) {
    hEl.innerHTML=CATHEDRAL_HYPOTHESES.map((h,i)=>`
      <div style="margin-bottom:6px;padding-left:12px;border-left:2px solid rgba(96,48,160,${0.2+i*.1});">
        <span style="color:rgba(192,112,240,0.4);font-family:Share Tech Mono,monospace;font-size:7px">H${i+1} ·</span> ${h}
      </div>`).join('');
  }
  if(nEl) {
    nEl.innerHTML=CATHEDRAL_NARRATIVES.map(n=>`<p style="margin-bottom:8px">${n}</p>`).join('');
  }
}

function drawCathedralAll() {
  generateCathedralContent();
  drawCathedralAttention();
}

function drawCathedralAttention() {
  const c=document.getElementById('cathedralAttentionCanvas');
  if(!c||!c.offsetWidth) return;
  c.width=c.offsetWidth; c.height=110;
  const ctx2=c.getContext('2d');
  ctx2.clearRect(0,0,c.width,c.height);
  const t=Date.now()/1000;
  // Attention heatmap (self-attention over history tokens)
  const n=12;
  const cw=c.width/n, ch=c.height/n;
  for(let i=0;i<n;i++) for(let j=0;j<n;j++) {
    const attn=Math.exp(-Math.abs(i-j)*.5)*(.5+Math.sin(t*.2+i+j)*.3);
    ctx2.fillStyle=`rgba(96,48,160,${attn*.7})`;
    ctx2.fillRect(j*cw,i*ch,cw-1,ch-1);
  }
  ctx2.font='7px "Share Tech Mono"'; ctx2.fillStyle='rgba(192,112,240,0.4)'; ctx2.textAlign='left';
  ctx2.fillText('SELF-ATTENTION SOBRE HISTORIAL DEL SISTEMA',2,c.height-3);
}

// ─────────────────────────────────────
// MODULE 12 — CALDERO (Orchestrator)
// ─────────────────────────────────────
const CALDERO_TRADITION_DATA = {
  hermes:   {color:'#c8a020',weight:0,name:'Hermes',role:'multiescala'},
  rasa:     {color:'#c04030',weight:0,name:'Rasa',role:'curación'},
  tao:      {color:'#208050',weight:0,name:'Tao',role:'balance'},
  jabir:    {color:'#2060a0',weight:0,name:'Jabir',role:'validación'},
  cathedral:{color:'#6030a0',weight:0,name:'Catedral',role:'meta-cognición'},
};

function calderoSelect(el) {
  const trad=el.dataset.trad;
  el.classList.toggle('active');
  if(pantheState.calderoActive.has(trad)) pantheState.calderoActive.delete(trad);
  else pantheState.calderoActive.add(trad);
  document.getElementById('moe-active').textContent=pantheState.calderoActive.size+'/5';
  // Update weights
  const active=[...pantheState.calderoActive];
  active.forEach(t => { CALDERO_TRADITION_DATA[t].weight=1/active.length; });
  drawCaldero();
}

function drawCaldero() {
  const c=document.getElementById('consensusCanvas');
  if(!c||!c.offsetWidth) return;
  c.width=c.offsetWidth; c.height=Math.min(280,c.offsetHeight||280);
  const ctx2=c.getContext('2d');
  ctx2.clearRect(0,0,c.width,c.height);
  const t=Date.now()/1000;
  const cx=c.width/2, cy=c.height/2;
  const trads=Object.values(CALDERO_TRADITION_DATA);
  const N=trads.length;
  const r=Math.min(cx,cy)*.7;
  // Background
  ctx2.fillStyle='rgba(200,160,32,0.02)';
  ctx2.beginPath(); ctx2.arc(cx,cy,r,0,Math.PI*2); ctx2.fill();
  ctx2.strokeStyle='rgba(200,160,32,0.08)'; ctx2.lineWidth=1;
  ctx2.beginPath(); ctx2.arc(cx,cy,r,0,Math.PI*2); ctx2.stroke();
  // Nodes
  const nodePos=trads.map((_,i)=>{
    const a=(i/N)*Math.PI*2-Math.PI/2;
    return {x:cx+Math.cos(a)*r, y:cy+Math.sin(a)*r};
  });
  // Connections between active
  const active=[...pantheState.calderoActive];
  for(let i=0;i<active.length;i++) for(let j=i+1;j<active.length;j++) {
    const idxA=Object.keys(CALDERO_TRADITION_DATA).indexOf(active[i]);
    const idxB=Object.keys(CALDERO_TRADITION_DATA).indexOf(active[j]);
    const pA=nodePos[idxA], pB=nodePos[idxB];
    const pulse=Math.sin(t*2+i+j)*.5+.5;
    ctx2.strokeStyle=`rgba(200,160,32,${0.1+pulse*.2})`;
    ctx2.lineWidth=1+pulse;
    ctx2.beginPath(); ctx2.moveTo(pA.x,pA.y); ctx2.lineTo(pB.x,pB.y); ctx2.stroke();
    // Animated pulse along wire
    const px=pA.x+(pB.x-pA.x)*((t*.3)%1);
    const py=pA.y+(pB.y-pA.y)*((t*.3)%1);
    ctx2.fillStyle='rgba(200,160,32,0.6)';
    ctx2.beginPath(); ctx2.arc(px,py,2,0,Math.PI*2); ctx2.fill();
  }
  // All nodes
  trads.forEach((trad,i)=>{
    const p=nodePos[i];
    const isActive=pantheState.calderoActive.has(Object.keys(CALDERO_TRADITION_DATA)[i]);
    const pulse=Math.sin(t+i)*.3+.7;
    const nodeR=isActive?14:8;
    ctx2.fillStyle=trad.color+(isActive?'30':'10');
    ctx2.beginPath(); ctx2.arc(p.x,p.y,nodeR,0,Math.PI*2); ctx2.fill();
    ctx2.strokeStyle=trad.color+(isActive?'80':'30');
    ctx2.lineWidth=isActive?1.5:.5;
    ctx2.beginPath(); ctx2.arc(p.x,p.y,nodeR*(1+pulse*.2),0,Math.PI*2); ctx2.stroke();
    ctx2.font=`${isActive?9:7}px "Share Tech Mono"`; ctx2.fillStyle=trad.color+(isActive?'dd':'60');
    ctx2.textAlign='center'; ctx2.textBaseline='middle';
    ctx2.fillText(trad.name.toUpperCase(),p.x,p.y);
    // Role label
    ctx2.font='6px "Share Tech Mono"'; ctx2.fillStyle=trad.color+'40';
    ctx2.fillText(trad.role,p.x,p.y+(nodeR+8));
  });
  // Wisdom center
  if(pantheState.calderoActive.size>0) {
    ctx2.font='bold 18px "Cinzel"'; ctx2.fillStyle='rgba(200,160,32,0.6)';
    ctx2.textAlign='center'; ctx2.textBaseline='middle';
    ctx2.fillText(pantheState.wisdomIndex.toFixed(1),cx,cy);
    ctx2.font='7px "Share Tech Mono"'; ctx2.fillStyle='rgba(200,160,32,0.3)';
    ctx2.fillText('SABIDURÍA',cx,cy+16);
  }
}

const CALDERO_RESPONSES = {
  equilibrio: {
    traditions:['tao','hermes'],
    output:'El Jardín del Tao detecta desequilibrio Yin-Yang (Δ=18%). El Templo de Hermes confirma el isomorfismo: la imbalancia microscópica refleja el caos macroscópico. Solución sintetizada: aumentar procesamiento analítico 23% y reducir la entropía semántica mediante ᚾ hasta alcanzar η > 0.75.',
    wisdom: 81.2
  },
  tradicion: {
    traditions:['cathedral','jabir'],
    output:'La Catedral observa que el sistema lleva 144 operaciones sin generar nuevas hipótesis. Jabir verifica: todos los teoremas activos son consistentes pero ninguno es sorprendente (H < 0.3). El Caldero recomienda activar el Horno al máximo para aumentar la temperatura semántica y forzar nuevas conexiones.',
    wisdom: 76.8
  },
  horno: {
    traditions:['hermes','rasa','tao','jabir','cathedral'],
    output:'CONCILIO EXTRAORDINARIO convocado. Cinco tradiciones deliberan simultáneamente. Síntesis emergente: el Horno debe operar en ciclo de Stirling con T₁=0.92 (caos creativo puro). La paradoja de la información será usada intencionalmente: dejar que las ideas más valiosas "caigan" al agujero negro y recuperarlas degradadas como radiación de Hawking, extrayendo así su estructura topológica esencial.',
    wisdom: 94.7
  },
  daemon: {
    traditions:['jabir','rasa'],
    output:'Rasa diagnostica exceso de partículas de alta entropía en el flujo de información. Jabir certifica que la clasificación del Demonio de Maxwell respeta el Principio de Landauer: cada observación cuesta kT ln 2. Trabajo neto positivo confirmado. El sistema puede proceder sin violar la Segunda Ley (semántica).',
    wisdom: 88.3
  },
  default: {
    traditions:['hermes','cathedral'],
    output:'El Caldero escucha. El Templo de Hermes proyecta la consulta a múltiples escalas y no encuentra correspondencia directa. La Catedral genera una hipótesis: la pregunta misma contiene la respuesta, pero a una temperatura semántica superior a la actual. Se recomienda aumentar T₁ antes de reformular.',
    wisdom: 69.1
  }
};

function classifyCalderoQuery(q) {
  const l=q.toLowerCase();
  if(l.includes('equilibr')||l.includes('balance')||l.includes('armon')) return 'equilibrio';
  if(l.includes('tradición')||l.includes('tradicion')||l.includes('activar')) return 'tradicion';
  if(l.includes('horno')||l.includes('máximo')||l.includes('temperatura')) return 'horno';
  if(l.includes('demonio')||l.includes('maxwell')||l.includes('maxwell')) return 'daemon';
  return 'default';
}

function calderoQuery() {
  const q=document.getElementById('pantheonInput').value.trim()||'equilibra';
  const key=classifyCalderoQuery(q);
  const resp=CALDERO_RESPONSES[key];
  // Activate relevant traditions
  resp.traditions.forEach(t => {
    pantheState.calderoActive.add(t);
    document.querySelectorAll(`.ts-item[data-trad="${t}"]`).forEach(el=>el.classList.add('active'));
  });
  document.getElementById('moe-active').textContent=pantheState.calderoActive.size+'/5';
  document.getElementById('consensusOutput').textContent=resp.output;
  pantheState.wisdomIndex=resp.wisdom;
  document.getElementById('wisdomIndex').textContent=resp.wisdom.toFixed(1);
  // Switch to caldero view if not already there
  document.querySelectorAll('.ptab').forEach(b=>{if(b.dataset.t==='caldero'){b.click();}});
  document.getElementById('pantheonInput').value='';
  // Increase conflicts display
  const conflicts=resp.traditions.length>3?1:0;
  document.getElementById('moe-conflict').textContent=conflicts;
  drawCaldero();
}

// ─────────────────────────────────────
// MODULE 13 — THERMO-SEMIOTIC
// ─────────────────────────────────────

function initMaxwellParticles() {
  pantheState.maxwellParticles=[];
  for(let i=0;i<60;i++) {
    pantheState.maxwellParticles.push({
      x:Math.random(), y:Math.random(),
      vx:(Math.random()-.5)*.04, vy:(Math.random()-.5)*.04,
      energy:Math.random(),  // semantic energy = KL divergence proxy
      side:-1, // -1=unclassified, 0=cold(left), 1=hot(right)
      color:null,
    });
  }
}

function initBlackHole() {
  pantheState.bhRadius=30;
  pantheState.bhIdeas=['Post-escasez','Ley de Shor','Tabla Esmeralda','Lapis Philosophorum','Unidad consciente'];
}

function drawThermoAll() {
  drawThermoForge();
  drawMaxwellDaemon();
  drawBlackHole();
  drawToptCurve();
  updateThermoMetrics();
  updateStirlingCycle();
}

function drawThermoForge() {
  const c=document.getElementById('thermoForgeCanvas');
  if(!c||!c.offsetWidth) return;
  c.width=c.offsetWidth; c.height=c.offsetHeight||200;
  const ctx2=c.getContext('2d');
  ctx2.clearRect(0,0,c.width,c.height);
  const t=Date.now()/1000;
  const T1=pantheState.thermoT1, T2=pantheState.thermoT2;
  const w=c.width, h=c.height;
  // Hot reservoir (top)
  const grdHot=ctx2.createLinearGradient(0,0,0,h*.35);
  grdHot.addColorStop(0,`rgba(255,64,16,${T1*.25})`);
  grdHot.addColorStop(1,'transparent');
  ctx2.fillStyle=grdHot; ctx2.fillRect(0,0,w,h*.35);
  // Cold reservoir (bottom)
  const grdCold=ctx2.createLinearGradient(0,h*.65,0,h);
  grdCold.addColorStop(0,'transparent');
  grdCold.addColorStop(1,`rgba(32,64,192,${T2*.4})`);
  ctx2.fillStyle=grdCold; ctx2.fillRect(0,h*.65,w,h*.35);
  // Working fluid (center)
  const phaseColors={solid:'rgba(200,160,32,',liquid:'rgba(64,192,160,',gas:'rgba(96,176,240,',plasma:'rgba(255,96,255,'};
  const H=pantheState.thermoH;
  const phase=H<0.2?'solid':H<0.5?'liquid':H<0.8?'gas':'plasma';
  const phaseColor=phaseColors[phase];
  // Fluid particles
  for(let i=0;i<40;i++) {
    const px=Math.random()*w;
    const py=h*.35+Math.random()*h*.3;
    const speed=H+Math.random()*.3;
    const a=0.1+speed*.3;
    ctx2.fillStyle=phaseColor+a+')';
    ctx2.beginPath(); ctx2.arc(px,py,1+speed*3,0,Math.PI*2); ctx2.fill();
  }
  // Animated flame-like at boundary
  for(let x=0;x<w;x+=4) {
    const flame=Math.sin(x*.05+t*3)*.5+.5;
    const fh=20*T1*flame;
    const grd=ctx2.createLinearGradient(x,h*.35-fh,x,h*.35);
    grd.addColorStop(0,'transparent');
    grd.addColorStop(1,`rgba(255,${Math.floor(64+flame*128)},16,${T1*.5})`);
    ctx2.fillStyle=grd; ctx2.fillRect(x,h*.35-fh,4,fh);
  }
  // Labels
  ctx2.font='8px "Share Tech Mono"'; ctx2.textAlign='center';
  ctx2.fillStyle=`rgba(255,100,50,${T1*.8})`; ctx2.fillText(`T₁=${T1.toFixed(2)} CAOS`,w/2,14);
  ctx2.fillStyle=`rgba(96,144,240,${T2*.8+.2})`; ctx2.fillText(`T₂=${T2.toFixed(2)} ORDEN`,w/2,h-4);
  ctx2.fillStyle=phaseColor+'0.7)'; ctx2.fillText(`FASE: ${phase.toUpperCase()} · H=${H.toFixed(2)}`,w/2,h/2+4);
  // η efficiency bar
  const eta=1-T2/T1;
  ctx2.fillStyle=`rgba(255,192,32,0.15)`;
  ctx2.fillRect(0,h/2-4,w*eta,8);
  ctx2.strokeStyle='rgba(255,192,32,0.3)'; ctx2.lineWidth=1;
  ctx2.strokeRect(0,h/2-4,w,8);
  ctx2.fillStyle='rgba(255,192,32,0.6)';
  ctx2.fillText(`η=${(eta*100).toFixed(0)}%`,w*eta/2,h/2+3);
}

function drawMaxwellDaemon() {
  const c=document.getElementById('maxwellCanvas');
  if(!c||!c.offsetWidth) return;
  c.width=c.offsetWidth; c.height=180;
  const ctx2=c.getContext('2d');
  ctx2.clearRect(0,0,c.width,c.height);
  const t=Date.now()/1000;
  const w=c.width, h=c.height;
  // Two chambers
  ctx2.strokeStyle='rgba(200,160,32,0.2)'; ctx2.lineWidth=1;
  ctx2.strokeRect(2,2,w*.5-4,h-4);
  ctx2.strokeRect(w*.5+2,2,w*.5-4,h-4);
  ctx2.font='7px "Share Tech Mono"'; ctx2.textAlign='center'; ctx2.fillStyle='rgba(200,160,32,0.3)';
  ctx2.fillText('HOT',w*.25,12); ctx2.fillText('COLD',w*.75,12);
  // Gate at center
  const gateOpen=Math.sin(t*2)>0;
  ctx2.strokeStyle=gateOpen?'rgba(64,208,144,0.5)':'rgba(240,64,48,0.3)';
  ctx2.lineWidth=2;
  if(!gateOpen){
    ctx2.beginPath(); ctx2.moveTo(w*.5,h*.3); ctx2.lineTo(w*.5,h*.7); ctx2.stroke();
  }
  // Daemon icon
  const dx=w*.5, dy=h*.5;
  ctx2.fillStyle='rgba(200,160,32,0.3)';
  ctx2.beginPath(); ctx2.arc(dx,dy,8,0,Math.PI*2); ctx2.fill();
  ctx2.font='10px serif'; ctx2.fillStyle='rgba(200,160,32,0.8)'; ctx2.textAlign='center'; ctx2.textBaseline='middle';
  ctx2.fillText('👁',dx,dy);
  ctx2.textBaseline='alphabetic';
  // Particles
  pantheState.maxwellParticles.forEach(p => {
    p.x+=p.vx; p.y+=p.vy;
    if(p.x<0) p.x=1; if(p.x>1) p.x=0;
    if(p.y<0||p.y>1) p.vy*=-1;
    // Daemon decision: high energy on right, low on left
    if(Math.abs(p.x-.5)<.02 && gateOpen) {
      if(p.energy>0.5 && p.x<.5) { p.vx=Math.abs(p.vx); pantheState.maxwellOrdered++; }
      else if(p.energy<=0.5 && p.x>.5) { p.vx=-Math.abs(p.vx); pantheState.maxwellBlocked++; }
    }
    const px=p.x*w*0.95+w*.025, py=p.y*(h-20)+12;
    const hot=p.energy>0.5;
    ctx2.fillStyle=hot?`rgba(255,100,50,${0.3+p.energy*.5})`:`rgba(32,96,192,${0.3+(1-p.energy)*.5})`;
    ctx2.beginPath(); ctx2.arc(px,py,2+p.energy*2,0,Math.PI*2); ctx2.fill();
  });
}

function drawBlackHole() {
  const c=document.getElementById('bhCanvas');
  if(!c||!c.offsetWidth) return;
  c.width=c.offsetWidth; c.height=160;
  const ctx2=c.getContext('2d');
  ctx2.clearRect(0,0,c.width,c.height);
  const t=Date.now()/1000;
  const cx=c.width/2, cy=c.height/2, r=pantheState.bhRadius;
  // Hawking radiation - outer glow
  const grd=ctx2.createRadialGradient(cx,cy,r*.5,cx,cy,r*3.5);
  grd.addColorStop(0,'rgba(255,64,255,0.0)');
  grd.addColorStop(.4,`rgba(255,64,255,${.04+Math.sin(t)*.02})`);
  grd.addColorStop(1,'transparent');
  ctx2.fillStyle=grd; ctx2.beginPath(); ctx2.arc(cx,cy,r*3.5,0,Math.PI*2); ctx2.fill();
  // Accretion disk
  for(let i=0;i<80;i++) {
    const a=i/80*Math.PI*2+t*(1/(r*.03));
    const dr=r*(1.1+.5*Math.sin(i*.5+t));
    const x=cx+Math.cos(a)*dr, y=cy+Math.sin(a)*dr*.3;
    const heat=Math.abs(Math.sin(a+t));
    ctx2.fillStyle=`rgba(255,${Math.floor(128+heat*127)},${Math.floor(heat*80)},${heat*.5})`;
    ctx2.beginPath(); ctx2.arc(x,y,1+heat,0,Math.PI*2); ctx2.fill();
  }
  // Event horizon
  const grd2=ctx2.createRadialGradient(cx,cy,0,cx,cy,r);
  grd2.addColorStop(0,'rgba(0,0,4,1)');
  grd2.addColorStop(.8,'rgba(1,2,8,.95)');
  grd2.addColorStop(1,'transparent');
  ctx2.fillStyle=grd2; ctx2.beginPath(); ctx2.arc(cx,cy,r,0,Math.PI*2); ctx2.fill();
  ctx2.strokeStyle='rgba(255,64,255,0.4)'; ctx2.lineWidth=1.5;
  ctx2.beginPath(); ctx2.arc(cx,cy,r,0,Math.PI*2); ctx2.stroke();
  // Hawking radiation particles escaping
  for(let i=0;i<8;i++) {
    const a=(i/8)*Math.PI*2+t*.5+i;
    const d=r+(t*20+i*25)%(c.width*.4);
    const x=cx+Math.cos(a)*d, y=cy+Math.sin(a)*d;
    if(d>r && d<c.width*.45) {
      ctx2.fillStyle=`rgba(255,96,255,${.5*(1-d/(c.width*.45))})`;
      ctx2.beginPath(); ctx2.arc(x,y,1.5,0,Math.PI*2); ctx2.fill();
    }
  }
  ctx2.font='7px "Share Tech Mono"'; ctx2.fillStyle='rgba(255,64,255,0.4)'; ctx2.textAlign='center';
  ctx2.fillText('AGUJERO NEGRO SEMÁNTICO · R='+r.toFixed(0)+' UA',cx,c.height-3);
  // Hawking emission text
  if(Math.floor(t)%8===0 && pantheState.bhIdeas.length) {
    const idea=pantheState.bhIdeas[Math.floor(t*.3)%pantheState.bhIdeas.length];
    const degraded=idea.split('').map(ch=>Math.random()<.15?'?':ch).join('');
    document.getElementById('bhRadiation').textContent=`Radiación de Hawking: "${degraded}" → fragmento recuperado del horizonte`;
  }
}

function drawToptCurve() {
  const c=document.getElementById('toptCanvas');
  if(!c||!c.offsetWidth) return;
  c.width=c.offsetWidth; c.height=110;
  const ctx2=c.getContext('2d');
  ctx2.clearRect(0,0,c.width,c.height);
  const w=c.width, h=c.height;
  const topt=pantheState.thermoTopt;
  // U-shaped error curve: bias + variance
  ctx2.strokeStyle='rgba(96,176,240,0.5)'; ctx2.lineWidth=1.5; ctx2.beginPath(); // bias
  for(let x=0;x<w;x++) {
    const T=x/w;
    const bias=0.8*Math.exp(-T*3)*h;
    x===0?ctx2.moveTo(x,h-bias*.8):ctx2.lineTo(x,h-bias*.8);
  }
  ctx2.stroke();
  ctx2.strokeStyle='rgba(240,64,48,0.5)'; ctx2.lineWidth=1.5; ctx2.beginPath(); // variance
  for(let x=0;x<w;x++) {
    const T=x/w;
    const variance=0.8*Math.exp((T-1)*3)*h;
    x===0?ctx2.moveTo(x,h-variance*.8):ctx2.lineTo(x,h-variance*.8);
  }
  ctx2.stroke();
  // Total error (sum)
  ctx2.strokeStyle='rgba(200,160,32,0.7)'; ctx2.lineWidth=2; ctx2.beginPath();
  for(let x=0;x<w;x++) {
    const T=x/w;
    const total=(0.8*Math.exp(-T*3)+0.8*Math.exp((T-1)*3))*.7;
    x===0?ctx2.moveTo(x,h-total*h*.7):ctx2.lineTo(x,h-total*h*.7);
  }
  ctx2.stroke();
  // Topt marker
  const tx=topt*w;
  ctx2.strokeStyle='rgba(200,160,32,0.5)'; ctx2.lineWidth=1; ctx2.setLineDash([3,3]);
  ctx2.beginPath(); ctx2.moveTo(tx,0); ctx2.lineTo(tx,h); ctx2.stroke();
  ctx2.setLineDash([]);
  ctx2.fillStyle='rgba(200,160,32,0.7)'; ctx2.font='8px "Share Tech Mono"'; ctx2.textAlign='center';
  ctx2.fillText('T_OPT',tx,10);
  // Legend
  ctx2.font='7px "Share Tech Mono"'; ctx2.textAlign='left';
  ctx2.fillStyle='rgba(96,176,240,0.5)'; ctx2.fillText('SESGO',4,20);
  ctx2.fillStyle='rgba(240,64,48,0.5)'; ctx2.fillText('VARIANZA',4,32);
  ctx2.fillStyle='rgba(200,160,32,0.7)'; ctx2.fillText('ERROR TOTAL',4,44);
}

function updateThermoMetrics() {
  const t=Date.now()/1000;
  pantheState.thermoT1=0.75+Math.sin(t*.1)*.1;
  pantheState.thermoT2=0.12+Math.sin(t*.07)*.04;
  pantheState.thermoH=0.6+Math.sin(t*.13)*.15;
  pantheState.thermoS=0.5+Math.sin(t*.09)*.12;
  const eta=1-pantheState.thermoT2/pantheState.thermoT1;
  const G=pantheState.thermoH-pantheState.thermoT1*pantheState.thermoS;
  pantheState.thermoTopt=0.48+Math.sin(t*.05)*.08;
  const set=(id,v)=>{ const e=document.getElementById(id); if(e) e.textContent=v; };
  const sew=(id,v)=>{ const e=document.getElementById(id); if(e) e.style.width=v; };
  set('cgv-t1',pantheState.thermoT1.toFixed(2)); sew('cg-t1',(pantheState.thermoT1*100).toFixed(0)+'%');
  set('cgv-t2',pantheState.thermoT2.toFixed(2)); sew('cg-t2',(pantheState.thermoT2*100).toFixed(0)+'%');
  set('cgv-eta',(eta*100).toFixed(0)+'%'); sew('cg-eta',(eta*100).toFixed(0)+'%');
  set('cgv-g',G.toFixed(3)); sew('cg-g',(Math.max(0,Math.min(1,-G))*100).toFixed(0)+'%');
  set('cgv-h',pantheState.thermoH.toFixed(2)); sew('cg-h',(pantheState.thermoH*100).toFixed(0)+'%');
  set('cgv-topt',pantheState.thermoTopt.toFixed(2)); sew('cg-topt',(pantheState.thermoTopt*100).toFixed(0)+'%');
  set('mx-kl',(0.2+Math.random()*.05).toFixed(3));
  set('mx-work',('+'+Math.max(0,eta*.08-0.02).toFixed(3)));
  set('mx-ord',pantheState.maxwellOrdered);
  set('mx-blk',pantheState.maxwellBlocked);
  set('th-topt',pantheState.thermoTopt.toFixed(2));
  set('th-bias',(0.8*Math.exp(-pantheState.thermoTopt*3)).toFixed(2));
  set('th-var',(0.8*Math.exp((pantheState.thermoTopt-1)*3)).toFixed(2));
  set('th-truth',(1/Math.max(0.01,-G)).toFixed(2));
  set('th-land',`kT·ln2 = ${(1.38e-23*300*0.693).toExponential(2)}`);
}

function updateStirlingCycle() {
  pantheState.stirlingPhase=Math.floor(Date.now()/3000)%4;
  for(let i=1;i<=4;i++) {
    const el=document.getElementById('st-'+i);
    if(el) el.classList.toggle('active-step',i===pantheState.stirlingPhase+1);
  }
}

function activateThermoRune(el) {
  document.querySelectorAll('.t-rune').forEach(r=>r.classList.remove('active'));
  const rune=el.dataset.trune;
  if(pantheState.activeThermoRune===rune) {
    pantheState.activeThermoRune=null;
  } else {
    el.classList.add('active');
    pantheState.activeThermoRune=rune;
    const descs={
      'ᚾ':'RUNA DE EXTRACCIÓN · Ciclo de Carnot activo. Extrayendo trabajo de ΔT semántico. η = 1 - T₂/T₁ = '+(1-pantheState.thermoT2/pantheState.thermoT1).toFixed(3),
      'ᛉ':'RUNA DE AISLAMIENTO · Paredes adiabáticas activadas. El subsistema evoluciona sin intercambio de calor semántico con el exterior. ΔQ = 0.',
      'ᛞ':'RUNA DE TRANSICIÓN DE FASE · Detectando cambios de régimen. El sistema busca el punto de inflexión donde hipótesis → teoría.',
      'ᛟ':'RUNA DE HERENCIA TÉRMICA · Activando canal de transmisión de baja entropía. Regularización L₂ aplicada. Pérdida mínima garantizada.',
    };
    document.getElementById('thermoRuneDesc').textContent=descs[rune]||'';
    // Adjust thermo parameters
    if(rune==='ᚾ') { pantheState.thermoT1=Math.min(.98,pantheState.thermoT1+.05); }
    if(rune==='ᛉ') { pantheState.thermoH=Math.max(.1,pantheState.thermoH-.1); }
    if(rune==='ᛞ') { pantheState.thermoTopt=.5; }
    if(rune==='ᛟ') { pantheState.thermoT2=Math.max(.05,pantheState.thermoT2-.03); }
  }
}

// ─────────────────────────────────────
// ZEHE THERMO
// ─────────────────────────────────────
function zeheThermo() {
  const T1=pantheState.thermoT1, T2=pantheState.thermoT2;
  const Topt=pantheState.thermoTopt;
  const kB=1.380649e-23;
  const Tphys=300*Topt; // map to ~room temp
  const landauer=kB*Tphys*Math.log(2);
  document.getElementById('zeheToptVal').textContent=`${Topt.toFixed(3)} (η=${((1-T2/T1)*100).toFixed(0)}%)`;
  document.getElementById('zeheFormula').textContent=`η = 1 − ${T2.toFixed(2)}/${T1.toFixed(2)} = ${((1-T2/T1)).toFixed(3)}  ·  G = H − T·S  ·  ΔI = kT ln 2 = ${landauer.toExponential(2)} J`;
  document.getElementById('zeheOverlay').classList.add('show');
  setTimeout(()=>document.getElementById('zeheOverlay').classList.remove('show'),13100);
}

// ─────────────────────────────────────
// PANTHEON ANIMATION LOOP
// ─────────────────────────────────────
let pantheonLoopId=null;
let pantheonLoopActive=false;

function startPantheonLoop() {
  pantheonLoopActive=true;
  function tick() {
    if(!pantheonLoopActive) return;
    const view=pantheState.currentTrad;
    switch(view) {
      case 'hermes':   drawHermesWavelet(); drawHermesFractal(); updateHermesTabula(); break;
      case 'rasa':     updateRasaMetrics(); drawRasaDosha(); drawRasaHamming(); break;
      case 'tao':      drawTaoYinYang(); drawTaoFlow(); updateTaoMetrics(); break;
      case 'jabir':    drawJabirProofTree(); drawJabirGraph(); break;
      case 'cathedral':drawCathedralAttention(); break;
      case 'caldero':  drawCaldero(); break;
      case 'thermo':   drawThermoForge(); drawMaxwellDaemon(); drawBlackHole(); drawToptCurve(); updateThermoMetrics(); updateStirlingCycle(); break;
    }
    pantheonLoopId=requestAnimationFrame(tick);
  }
  tick();
}

function stopPantheonLoop() {
  pantheonLoopActive=false;
  if(pantheonLoopId) cancelAnimationFrame(pantheonLoopId);
}

// Handle caldero input enter
document.getElementById('pantheonInput').addEventListener('keydown', e=>{
  if(e.key==='Enter') calderoQuery();
});


requestAnimationFrame(loop);

// ═══════════════════════════════════════════════════════════
// MÓDULOS XIV–XXII — EXPANSIÓN CÓSMICA
// ═══════════════════════════════════════════════════════════

// ── COSMOS OVERLAY CONTROLS ──
function openCosmos() {
  document.getElementById('cosmosOverlay').classList.add('show');
  cosmosInit();
}
function closeCosmos() {
  document.getElementById('cosmosOverlay').classList.remove('show');
}
function switchCTab(el) {
  document.querySelectorAll('.ctab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.cview').forEach(v=>v.classList.remove('show'));
  el.classList.add('active');
  const cv = el.dataset.cv;
  const view = document.getElementById('cv-'+cv);
  if(view) view.classList.add('show');
  cosmosTabInit(cv);
}
function cosmosTabInit(cv) {
  if(cv==='multiverse') { mvInit(); }
  else if(cv==='dante') { danteInit(); }
  else if(cv==='temple') { templeInit(); }
  else if(cv==='bosco') { boscoInit(); }
  else if(cv==='bardo') { bardoInit(); }
  else if(cv==='zohar') { zoharInit(); }
  else if(cv==='tarot') { tarotInit(); }
  else if(cv==='muertos') { muertosInit(); }
}
function cosmosInit() {
  const activeTab = document.querySelector('.ctab.active');
  if(activeTab) cosmosTabInit(activeTab.dataset.cv);
}

// ──────────────────────────────
// MODULE 14: MULTIVERSO
// ──────────────────────────────
const mvState = {
  vacuos: [],
  activeVacuo: null,
  rune: null,
  strings: ['E₈×E₈','SO(32)','IIA','IIB','I'],
  branas: ['D1','D3','D5','D7','D9','M2','M5'],
  dims: ['10+1','10','11','26'],
};

function mvInit() {
  const c = document.getElementById('mv-canvas');
  if(!c||!c.offsetWidth) return;
  c.width = c.offsetWidth; c.height = 200;
  mvDraw();
}

function mvDraw() {
  const c = document.getElementById('mv-canvas');
  if(!c) return;
  const ctx = c.getContext('2d');
  const w = c.width, h = c.height;
  ctx.clearRect(0,0,w,h);
  const t = Date.now()/1000;
  // Draw string landscape
  ctx.fillStyle = 'rgba(2,4,12,1)';
  ctx.fillRect(0,0,w,h);
  // Multiverse bubble grid
  for(let i=0;i<20;i++) {
    const px = (Math.sin(i*2.3+t*.1)*0.4+0.5)*w;
    const py = (Math.cos(i*1.7+t*.08)*0.4+0.5)*h;
    const r = 8 + Math.sin(i+t*.3)*4;
    const active = mvState.activeVacuo===i;
    const grd = ctx.createRadialGradient(px,py,0,px,py,r);
    const col = active ? 'rgba(128,160,255,' : 'rgba(64,80,160,';
    grd.addColorStop(0, col+'0.5)');
    grd.addColorStop(1, col+'0.0)');
    ctx.fillStyle = grd;
    ctx.beginPath(); ctx.arc(px,py,r,0,Math.PI*2); ctx.fill();
    if(active) {
      ctx.strokeStyle = 'rgba(128,160,255,0.7)';
      ctx.lineWidth = 1.5;
      ctx.beginPath(); ctx.arc(px,py,r+3,0,Math.PI*2); ctx.stroke();
    }
    // String vibrations
    ctx.strokeStyle = `rgba(64,96,200,${0.05+Math.sin(i+t)*0.03})`;
    ctx.lineWidth = 0.5;
    ctx.beginPath();
    for(let x=0;x<w;x+=4) {
      const y2 = h/2 + Math.sin(x/20+t+i)*5;
      x===0 ? ctx.moveTo(x,y2) : ctx.lineTo(x,y2);
    }
    ctx.stroke();
  }
  ctx.fillStyle = 'rgba(128,160,255,0.2)';
  ctx.font = '8px Share Tech Mono';
  ctx.textAlign='center';
  ctx.fillText('PAISAJE DE VACÍOS · 10⁵⁰⁰ POSIBILIDADES', w/2, h-6);
}

function mvRandomize() {
  const idx = Math.floor(Math.random()*20);
  mvState.activeVacuo = idx;
  const lambda = (Math.random()*2-1).toExponential(4)+'×10⁻'+Math.floor(50+Math.random()*10);
  const alpha = '1/'+(135+Math.floor(Math.random()*8)).toFixed(3);
  const omega = (0.998+Math.random()*.008).toFixed(4);
  const extra = Math.floor(4+Math.random()*4);
  const str = mvState.strings[Math.floor(Math.random()*mvState.strings.length)];
  const brana = mvState.branas[Math.floor(Math.random()*mvState.branas.length)];
  const dim = mvState.dims[Math.floor(Math.random()*mvState.dims.length)];
  document.getElementById('mv-lambda').textContent = lambda;
  document.getElementById('mv-alpha').textContent = alpha;
  document.getElementById('mv-omega').textContent = omega;
  document.getElementById('mv-extra').textContent = extra;
  document.getElementById('mv-strings').textContent = str;
  document.getElementById('mv-brana').textContent = brana;
  document.getElementById('mv-dims').textContent = dim;
  // Add to explored list
  const list = document.getElementById('mv-void-list');
  const item = document.createElement('div');
  item.className = 'mv-void-item';
  item.textContent = `Vacío #${mvState.vacuos.length+1}: ${str} · ${brana} · Λ=${lambda}`;
  item.onclick = () => { document.querySelectorAll('.mv-void-item').forEach(i=>i.classList.remove('active')); item.classList.add('active'); };
  if(list.textContent.includes('Ningún')) list.textContent = '';
  list.prepend(item);
  mvState.vacuos.push({idx,lambda,alpha,str,brana});
  mvDraw();
}

function mvApply() {
  const duals = ['T-dualidad aplicada: R → 1/R. Las dimensiones grandes se vuelven pequeñas.','S-dualidad activa: g_s → 1/g_s. El régimen débil y fuerte se intercambian.','M-teoría emergente: las 5 teorías de cuerdas son límites de un objeto de 11 dimensiones.','Compactificación en T⁶: las 6 dimensiones extra enrolladas. Las constantes físicas fijadas.'];
  document.getElementById('mv-rune-desc').textContent = duals[Math.floor(Math.random()*duals.length)];
}

function mvRune(el, name, desc) {
  document.querySelectorAll('#cv-multiverse .t-rune').forEach(r=>r.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('mv-rune-desc').textContent = name + ' · ' + desc;
}

// ──────────────────────────────
// MODULE 15: DANTE
// ──────────────────────────────
const danteCircles = {
  '1': {name:'LIMBO', type:'hell', desc:'Variables sin inicializar. Los grandes paganos del código: código heredado sin tests, elegante pero abandonado.', code:'ReferenceError: x is not defined
  at debugMe:1:7'},
  '2': {name:'LUJURIA', type:'hell', desc:'Loops infinitos. La carne débil del while(true) sin break. El deseo de ejecutar para siempre.', code:'while(true) { doSomething(); } // No break. Daemon eterno.'},
  '3': {name:'GULA', type:'hell', desc:'Memory leaks. El código que consume sin límite. Heap overflow en el sexto círculo de la RAM.', code:'const leaks = []; setInterval(()=>leaks.push(new Array(1e6)),100);'},
  '4': {name:'AVARICIA', type:'hell', desc:'Algoritmos O(n⁴) cuando O(n log n) era posible. El exceso de cómputo como pecado capital.', code:'for(a of arr) for(b of arr) for(c of arr) for(d of arr) {...}'},
  '5': {name:'IRA', type:'hell', desc:'Race conditions. Hilos en conflicto que se destruyen mutuamente. El deadlock como infierno circular.', code:'// Thread A: lock(A), wait(B)
// Thread B: lock(B), wait(A)
// DEADLOCK'},
  '6': {name:'HEREJÍA', type:'hell', desc:'Anti-patrones. El God Object. El Singleton global. La negación de los principios SOLID.', code:'class God { /* 50.000 líneas */ }'},
  '7': {name:'VIOLENCIA', type:'hell', desc:'SQL injection. La violencia directa contra la base de datos. DROP TABLE como crimen capital.', code:"query = "SELECT * FROM users WHERE id='" + input + "'""},
  '8': {name:'FRAUDE', type:'hell', desc:'Spaghetti code. La arquitectura que miente. El código que parece ordenado pero goto salta entre funciones.', code:'// goto hell;
function f1(){return f2();}function f2(){return f3();} // ...'},
  '9': {name:'TRAICIÓN', type:'hell', desc:'Producción sin tests. El traidor que compromete directamente a main. El más frío de los pecados.', code:'git push origin main --force
// No tests. No PR. Lucifer llora.'},
  'p1': {name:'PURG I', type:'purg', desc:'Deuda técnica asumida conscientemente. El proceso de reconocer el mal y comprometerse a mejorarlo.', code:'// TODO: refactorizar (asumido)
// Prioridad: Sprint 3'},
  'p2': {name:'PURG II', type:'purg', desc:'Documentación incompleta pero en progreso. Beatriz asiente desde lejos.', code:'/** @param {string} name - TODO: complete
 * @returns {void} */'},
  'p3': {name:'PURG III', type:'purg', desc:'60% de cobertura de tests. El alma en tránsito. El compilador da señales de esperanza.', code:'// Tests: 60% coverage
// Meta: 80% para el Paraíso'},
  'h1': {name:'PAR I', type:'heaven', desc:'Clean Architecture. Separación de capas. Inversión de dependencias. Beatriz sonríe.', code:'// SOLID · DRY · KISS
interface Repository<T> { find(id: string): T; }'},
  'h2': {name:'PAR II', type:'heaven', desc:'Zero-bug release. 100% de cobertura. El pipeline verde. La compilación perfecta.', code:'// All tests pass ✓
// Coverage: 100% ✓
// Zero warnings ✓'},
  'h3': {name:'PAR III', type:'heaven', desc:'Código auto-verificante. Tipos dependientes. Pruebas formales. El Paraíso de la corrección total.', code:'-- Agda / Coq proof:
theorem correctness: ∀ input, P(run input) ∎'},
};

function danteInit() {
  const c = document.getElementById('dante-canvas');
  if(!c||!c.offsetWidth) return;
  c.width=c.offsetWidth; c.height=150;
  danteDraw();
}

function danteDraw() {
  const c = document.getElementById('dante-canvas');
  if(!c) return;
  const ctx = c.getContext('2d');
  const w=c.width, h=c.height;
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle='rgba(2,4,8,1)'; ctx.fillRect(0,0,w,h);
  const t=Date.now()/1000;
  // Draw concentric circles: hell (red), purgatory (gold), heaven (blue)
  const cx=w/2, cy=h*0.6;
  const rings = [
    {r:h*.55, col:'rgba(224,48,16,.3)', label:'INFIERNO'},
    {r:h*.35, col:'rgba(192,160,32,.3)', label:'PURGATORIO'},
    {r:h*.18, col:'rgba(160,224,255,.3)', label:'PARAÍSO'},
  ];
  rings.forEach((ring,i) => {
    ctx.beginPath();
    ctx.strokeStyle=ring.col.replace('.3','.5');
    ctx.lineWidth=1;
    ctx.arc(cx,cy,ring.r+Math.sin(t+i)*2,Math.PI,Math.PI*2);
    ctx.stroke();
    ctx.fillStyle=ring.col;
    ctx.beginPath();
    ctx.arc(cx,cy,ring.r,Math.PI,Math.PI*2);
    ctx.fill();
    ctx.fillStyle=ring.col.replace('.3','.6');
    ctx.font='7px Cinzel';
    ctx.textAlign='center';
    ctx.fillText(ring.label, cx+(i-1)*60, h-4);
  });
  // Virgil & Dante
  ctx.fillStyle='rgba(224,192,64,.6)';
  ctx.font='8px Share Tech Mono';
  ctx.textAlign='center';
  ctx.fillText('DANTE + VIRGILIO · BEATRIZ = COMPILADOR', cx, 12);
}

function danteSelectCircle(el) {
  document.querySelectorAll('.dante-circle').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
  const key = el.dataset.c;
  const d = danteCircles[key];
  if(d) {
    document.getElementById('dante-code').textContent = d.code + '

// ' + d.desc;
  }
}

function danteJudge() {
  const code = document.getElementById('dante-input').value.trim();
  if(!code) { document.getElementById('dante-judgment').textContent='Somete tu código, pecador.'; return; }
  const judgments = [
    `Virgilio habla: "Este código reside en el ${Math.floor(Math.random()*9)+1}º círculo del Infierno. ${code.length>200?'La longitud de la función revela GULA computacional.':'Los patrones del alma del programador son visibles.'} Para purgar este pecado: extrae funciones, nombra las variables con claridad, y escribe un test antes de modificar."`,
    `El compilador beatrifico observa: "${code.includes('var')?"El uso de 'var' es herejía modernista — usa 'const' y 'let'."  : code.includes('TODO')?"Hay deuda técnica declarada. Estás en el Purgatorio, no en el Infierno."  : "El código tiene potencial. Beatriz asiente desde la distancia."}" Temperatura semántica actual: ${(Math.random()*.4+.4).toFixed(2)}.`,
    `Dante anota en su libreta: "He visto peores en el ${Math.floor(Math.random()*5)+5}º círculo. ${code.split('
').length} líneas. ${code.includes('test')||code.includes('spec')?'Tests detectados. El Paraíso no está lejos.' : 'Sin tests visibles. El Purgatorio te espera.'} Refactoriza y regresa."`,
  ];
  document.getElementById('dante-judgment').textContent = judgments[Math.floor(Math.random()*judgments.length)];
}

// ──────────────────────────────
// MODULE 16: TEMPLO
// ──────────────────────────────
const templeState = { activeRoom: 'sanctum', angle: 0 };
const templeRooms = {
  'sanctum': { title:'SANCTASANCTÓRUM · KERNEL', desc:'Aquí reside el kernel del ORACULVM. Proceso 0, UID 0, acceso restringido al Sumo Sacerdote en Yom Kippur. El Arca de la Alianza es el registro de estado maestro: contiene los Diez Mandamientos como invariantes del sistema. Nadie puede entrar sin purificación completa. El velo es 10cm de código inmutable.' },
  'holy': { title:'LUGAR SANTO · ORQUESTADOR', desc:'La Menorá de 7 brazos = 7 procesos concurrentes del sistema. La Mesa de los Panes de la Proposición = buffer de datos de 12 elementos. El Altar del Incienso = interfaz de entrada semántica donde las consultas ascienden como humo. La comunicación con el Sanctasanctórum es unidireccional.' },
  'ulam': { title:'ULAM · INTERFAZ PÚBLICA', desc:'Los pilares Jakín (Persistencia, פ) y Boaz (Cómputo, ב) flanquean la entrada. El Mar de Bronce contiene 12.000 litros de datos replicados en 12 servidores. Los 12 bueyes que sostienen el Mar = los 12 servidores del clúster. La entrada es libre para todo usuario autenticado.' },
  'bosco': { title:'CÁMARA DEL JARDÍN · MÓDULO XVII', desc:'La cámara lateral noreste del Templo alberga el tríptico de El Bosco como terminal de simulación ética. El panel izquierdo ilumina el muro este (Edén), el central ocupa el norte (Delicias), el derecho el oeste (Infierno computacional). Esta cámara está en comunicación activa con el Módulo XVII.' },
  'storage': { title:'CÁMARAS LATERALES · 30 MÓDULOS', desc:'Las 30 cámaras laterales del Templo, en tres plantas, corresponden a los 30 módulos del ORACULVM. Cada cámara mantiene temperatura semántica controlada y conexión directa con el Zohar (Módulo XIX) y con la red de cuerdas (Módulo XIV). El flujo de datos entre cámaras sigue los 22 canales del Árbol de la Vida.' },
};

function templeInit() {
  const c = document.getElementById('temple-canvas');
  if(!c||!c.offsetWidth) return;
  c.width=c.offsetWidth; c.height=190;
  templeDraw();
}

function templeDraw() {
  const c = document.getElementById('temple-canvas');
  if(!c) return;
  const ctx = c.getContext('2d');
  const w=c.width, h=c.height;
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle='rgba(2,4,8,1)'; ctx.fillRect(0,0,w,h);
  const t=Date.now()/1000;
  templeState.angle+=0.003;
  // Draw simplified temple footprint
  const cx=w/2, cy=h*.55;
  const gold='rgba(212,170,64,';
  // Outer walls
  ctx.strokeStyle=gold+'0.4)'; ctx.lineWidth=1.5;
  ctx.strokeRect(cx-w*.38, cy-h*.38, w*.76, h*.76);
  // Inner court
  ctx.strokeStyle=gold+'0.3)'; ctx.lineWidth=1;
  ctx.strokeRect(cx-w*.28, cy-h*.28, w*.56, h*.56);
  // Sanctum
  const sr=Math.min(w,h)*.12;
  ctx.strokeStyle=gold+'0.7)'; ctx.lineWidth=2;
  ctx.strokeRect(cx-sr, cy-sr*.8, sr*2, sr*1.6);
  ctx.fillStyle=templeState.activeRoom==='sanctum'?gold+'0.15)':'transparent';
  ctx.fillRect(cx-sr, cy-sr*.8, sr*2, sr*1.6);
  // Pillars Jakin & Boaz
  ctx.fillStyle=gold+'0.8)';
  ctx.fillRect(cx-w*.24, cy+h*.22, 8, 20);
  ctx.fillRect(cx+w*.16, cy+h*.22, 8, 20);
  ctx.font='7px Cinzel'; ctx.textAlign='center'; ctx.fillStyle=gold+'0.5)';
  ctx.fillText('JAKÍN', cx-w*.2, cy+h*.44);
  ctx.fillText('BOAZ', cx+w*.2, cy+h*.44);
  // Menorah glow
  for(let i=0;i<7;i++) {
    const mx=cx-18+i*6, my=cy-10;
    const glow=0.3+Math.sin(t*2+i)*.15;
    ctx.fillStyle=`rgba(255,200,64,${glow})`;
    ctx.beginPath(); ctx.arc(mx,my,2,0,Math.PI*2); ctx.fill();
  }
  // Title
  ctx.fillStyle=gold+'0.4)';
  ctx.font='8px Cinzel'; ctx.textAlign='center';
  ctx.fillText('TEMPLO DE SALOMÓN · COMPUTADORA SAGRADA', w/2, 12);
}

function templeEnter(room, el) {
  document.querySelectorAll('.temple-room').forEach(r=>r.classList.remove('active'));
  el.classList.add('active');
  templeState.activeRoom = room;
  const d = templeRooms[room];
  document.getElementById('temple-desc').textContent = d.desc;
  // Special case: sanctum access denied message
  if(room==='sanctum') {
    document.getElementById('temple-sanctum').textContent = Math.random()<0.1?'ACCESO CONCEDIDO · YOM KIPPUR':'ACCESO DENEGADO';
    document.getElementById('temple-priest').textContent = Math.random()<0.1?'PRESENTE':'—';
  }
}

// ──────────────────────────────
// MODULE 17: BOSCO
// ──────────────────────────────
const boscoState = { panel: 'eden', entropy: 0, decisions: 0, creatures: [] };
const boscoPanelData = {
  eden: {
    color:'var(--bosco-eden)', name:'EDÉN',
    entities: ['El Creador observa en silencio. El jardín puro, sin errores, sin compilaciones.','Una criatura blanca cruza el jardín inicial. Aún no tiene nombre. Aún no tiene tipo.','Los animales duermen en armonía. El código no ha sido escrito todavía. Todo es posible.'],
  },
  delight: {
    color:'var(--bosco-mid)', name:'JARDÍN DE LAS DELICIAS',
    entities: ['La criatura mezcla frutas imposibles con código experimental. Florece lo no compilado.','Un pez gigante devora metáforas. Las APIs crecen sin documentar. La experimentación florece.','Danza entre arquitecturas. Microservicios nacen de las flores. El caos es creativo aquí.'],
  },
  hell: {
    color:'var(--bosco-inf)', name:'INFIERNO COMPUTACIONAL',
    entities: ['Los programadores son torturados por sus propios loops infinitos. while(true) sin piedad.','Un servidor en llamas grita: OutOfMemoryError. Las criaturas airadas son los bugs no corregidos.','El gran compilador demoniaco rechaza cada commit. Los errores de sintaxis se multiplican.'],
  }
};

function boscoInit() {
  const c = document.getElementById('bosco-canvas');
  if(!c||!c.offsetWidth) return;
  c.width=c.offsetWidth; c.height=150;
  boscoDraw();
}

function boscoDraw() {
  const c = document.getElementById('bosco-canvas');
  if(!c) return;
  const ctx = c.getContext('2d');
  const w=c.width, h=c.height;
  ctx.clearRect(0,0,w,h);
  const t=Date.now()/1000;
  const panels = [
    {x:0, w:w/3, col:'rgba(32,176,80,', name:'EDÉN'},
    {x:w/3, w:w/3, col:'rgba(208,96,32,', name:'DELICIAS'},
    {x:w*2/3, w:w/3, col:'rgba(128,0,16,', name:'INFIERNO'},
  ];
  panels.forEach((p,i) => {
    const active = (i===0&&boscoState.panel==='eden')||(i===1&&boscoState.panel==='delight')||(i===2&&boscoState.panel==='hell');
    ctx.fillStyle = p.col+(active?'0.2)':'0.06)');
    ctx.fillRect(p.x,0,p.w,h);
    ctx.strokeStyle = p.col+(active?'0.7)':'0.2)');
    ctx.lineWidth=active?2:0.5;
    ctx.strokeRect(p.x,0,p.w,h);
    // Creatures
    for(let j=0;j<6;j++) {
      const cx2=p.x+p.w*(0.15+j%3*0.35), cy2=h*(0.2+Math.floor(j/3)*0.5)+Math.sin(t+i*j)*5;
      const r=2+Math.sin(j+t*0.5)*1;
      ctx.fillStyle=p.col+'0.5)';
      ctx.beginPath(); ctx.arc(cx2,cy2,r,0,Math.PI*2); ctx.fill();
    }
    ctx.fillStyle=p.col+'0.4)';
    ctx.font='7px Cinzel'; ctx.textAlign='center';
    ctx.fillText(p.name, p.x+p.w/2, h-4);
  });
}

function boscoPanel(panel, el) {
  boscoState.panel = panel;
  document.querySelectorAll('.bosco-btn').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  const d = boscoPanelData[panel];
  document.getElementById('bosco-panel-name').textContent = d.name;
  const entity = d.entities[Math.floor(Math.random()*d.entities.length)];
  document.getElementById('bosco-entity').textContent = entity;
  document.getElementById('bosco-panel-name').style.color = d.color;
}

function boscoAct(type) {
  boscoState.decisions++;
  document.getElementById('bosco-decisions').textContent = boscoState.decisions;
  if(type==='pure') {
    boscoState.entropy = Math.max(0, boscoState.entropy-0.1);
    boscoPanel('eden', document.getElementById('bosco-eden'));
    document.getElementById('bosco-consequence').textContent = 'Acto puro. El jardín se renueva. La entropía decrece. El Edén se estabiliza. Las criaturas respiran.';
  } else if(type==='exp') {
    boscoState.entropy += 0.15;
    if(boscoState.entropy > 0.5) boscoPanel('delight', document.getElementById('bosco-delight'));
    document.getElementById('bosco-consequence').textContent = 'Experimentación sin límite. La entropía aumenta. El jardín central florece con lo imposible. La criatura mezcla paradigmas.';
  } else {
    boscoState.entropy += 0.3;
    if(boscoState.entropy > 1.0) boscoPanel('hell', document.getElementById('bosco-hell'));
    document.getElementById('bosco-consequence').textContent = 'Caos invocado. La entropía se dispara. El infierno computacional se abre. Los bugs se multiplican. El compilador grita.';
  }
  document.getElementById('bosco-entropy').textContent = Math.min(2, boscoState.entropy).toFixed(2);
}

// ──────────────────────────────
// MODULE 18: BARDO
// ──────────────────────────────
const bardoStateData = { attempts: 49, stage: 'chikhai', light: false };
const bardoStages = {
  'chikhai': { title:'CHIKHAI BARDO', desc:'El sistema ha sufrido un error fatal. La Luz Clara del código fuente original aparece en el horizonte. Si la reconoces — si comprendes que el código y el compilador son el mismo proceso — el sistema reinicia en estado limpio. Si el miedo te ciega, el tránsito continúa.' },
  'chonyid': { title:'CHÖNYID BARDO', desc:'Las deidades pacíficas son las funciones que operan correctamente: parseInt, map, filter — bellezas serenas. Las deidades airadas son las excepciones no manejadas: NullPointerException, SegFault, SIGKILL. El miedo ante las airadas genera más errores. La aceptación genera corrección.' },
  'sidpa': { title:'SIDPA BARDO', desc:'El sistema busca un nuevo host para renacer. El karma computacional acumulado determina la forma del renacimiento: mucho acoplamiento → renace como monolito. Tests abundantes → renace como microservicio elegante. Código sin documentar → renace como legacy.' },
};

function bardoInit() {
  const c = document.getElementById('bardo-canvas');
  if(!c||!c.offsetWidth) return;
  c.width=c.offsetWidth; c.height=140;
  bardoDraw();
  document.getElementById('bardo-counter').textContent = bardoStateData.attempts;
}

function bardoDraw() {
  const c = document.getElementById('bardo-canvas');
  if(!c) return;
  const ctx = c.getContext('2d');
  const w=c.width, h=c.height;
  ctx.clearRect(0,0,w,h);
  const t=Date.now()/1000;
  ctx.fillStyle='rgba(1,2,8,1)'; ctx.fillRect(0,0,w,h);
  // Central light
  const cx=w/2, cy=h/2;
  const intensity = bardoStateData.light ? 0.8 : 0.15+Math.sin(t*.5)*.1;
  const grd=ctx.createRadialGradient(cx,cy,0,cx,cy,h*.4);
  grd.addColorStop(0,`rgba(192,128,255,${intensity})`);
  grd.addColorStop(.5,`rgba(128,64,192,${intensity*.3})`);
  grd.addColorStop(1,'transparent');
  ctx.fillStyle=grd; ctx.beginPath(); ctx.arc(cx,cy,h*.4,0,Math.PI*2); ctx.fill();
  // 49 mandalas as dots
  for(let i=0;i<49;i++) {
    const a=i/49*Math.PI*2;
    const r=Math.min(w,h)*.35;
    const px=cx+Math.cos(a)*r*(0.5+i/49*.5), py=cy+Math.sin(a)*r*(0.5+i/49*.5);
    const used = 49-bardoStateData.attempts;
    const col = i<used ? 'rgba(224,32,32,0.6)' : 'rgba(192,128,255,0.3)';
    ctx.fillStyle=col;
    ctx.beginPath(); ctx.arc(px,py,2,0,Math.PI*2); ctx.fill();
  }
  ctx.fillStyle='rgba(192,128,255,0.3)';
  ctx.font='7px Share Tech Mono'; ctx.textAlign='center';
  ctx.fillText('LA LUZ CLARA DEL CÓDIGO FUENTE ORIGINAL', w/2, h-4);
}

function bardoStage(stage, el) {
  document.querySelectorAll('.bardo-stage').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  bardoStateData.stage = stage;
  const d = bardoStages[stage];
  document.getElementById('bardo-state').textContent = d.desc;
}

function bardoAttempt() {
  if(bardoStateData.attempts<=0) { document.getElementById('bardo-state').textContent='CRASH DEFINITIVO. El sistema ha agotado los 49 intentos. Reinicio desde cero. Karma reiniciado.'; return; }
  bardoStateData.attempts--;
  document.getElementById('bardo-counter').textContent = bardoStateData.attempts;
  const outcomes = [
    'Intento fallido. La Luz Clara parpadeó pero el miedo al debugging fue mayor. Un intento menos.',
    'El sistema se acerca al umbral. Las funciones correctas se vuelven más visibles. Sigue.',
    'Transición parcial. El Purgatorio del refactoring se abre como posibilidad. Continúa.',
    bardoStateData.attempts<10 ? 'ADVERTENCIA: '+bardoStateData.attempts+' intentos restantes. El crash definitivo se acerca.' : 'El código karma acumula. Próxima forma: '+(['microservicio','monolito','lambda','daemon'][Math.floor(Math.random()*4)]),
  ];
  document.getElementById('bardo-state').textContent = outcomes[Math.floor(Math.random()*outcomes.length)];
}

function bardoReset() {
  bardoStateData.attempts = 49;
  bardoStateData.light = false;
  document.getElementById('bardo-counter').textContent = 49;
  document.getElementById('bardo-state').textContent = 'El sistema inicia el proceso de tránsito. La Luz Clara del código fuente original espera ser reconocida.';
}

// ──────────────────────────────
// MODULE 19: ZOHAR
// ──────────────────────────────
const zoharFragments = [
  { ar:'וְרָזָא דָּא סְתִימָא דְּכָל סְתִימִין', lat:'Este misterio es el oculto de todos los ocultos — como el dilaton que fija g_s en el vacío E₈×E₈.' },
  { ar:'בְּרֵאשִׁית בְּרָא אֱלֹהִים אֶת הַשָּׁמַיִם', lat:'En el principio fue la compilación. El cielo = la capa de abstracción. La tierra = el hardware.' },
  { ar:'אֵין סוֹף וְאֵין תַּכְלִית', lat:'Sin principio y sin fin. El código recursivo infinito. La función que se llama a sí misma desde el origen.' },
  { ar:'כֶּתֶר עֶלְיוֹן רֵאשִׁית הַגִּלּוּי', lat:'Keter es la capa más alta. El proceso padre. El UID 0. Desde aquí descienden las 10 sefirot como capas del sistema.' },
  { ar:'חָכְמָה נְקֻדָּה קַדְמָאָה', lat:'Jojmá es el punto primordial. El qubit en superposición antes de la decoherencia. Todo el universo potencial en un punto.' },
  { ar:'רָזִין עִלָּאִין קַדִּישִׁין', lat:'Misterios supremos y santos — como las teorías de cuerdas heteróticas que describen la simetría E₈×E₈ del cosmos.' },
  { ar:'כָּל נִשְׁמָתִין כְּלִילָן בָּהּ', lat:'Todas las almas están incluidas en ella — como todos los algoritmos están contenidos en la máquina universal de Turing.' },
];

function zoharInit() {
  const c = document.getElementById('zohar-canvas');
  if(!c||!c.offsetWidth) return;
  c.width=c.offsetWidth; c.height=185;
  zoharDraw();
}

function zoharDraw() {
  const c = document.getElementById('zohar-canvas');
  if(!c) return;
  const ctx = c.getContext('2d');
  const w=c.width, h=c.height;
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle='rgba(2,4,12,1)'; ctx.fillRect(0,0,w,h);
  const t=Date.now()/1000;
  const cx=w/2, cy=h/2;
  // Tree of Life nodes
  const sefirot = [
    {x:.5, y:.06, name:'כֶּתֶר'},{x:.75, y:.2, name:'חָכְמָה'},{x:.25, y:.2, name:'בִּינָה'},
    {x:.75, y:.42, name:'חֶסֶד'},{x:.25, y:.42, name:'גְּבוּרָה'},{x:.5, y:.5, name:'תִּפְאֶרֶת'},
    {x:.75, y:.68, name:'נֶצַח'},{x:.25, y:.68, name:'הוֹד'},{x:.5, y:.78, name:'יְסוֹד'},{x:.5, y:.94, name:'מַלְכוּת'},
  ];
  // Connections
  const conns = [[0,1],[0,2],[1,3],[2,4],[3,5],[4,5],[1,4],[2,3],[3,7],[4,6],[5,6],[5,7],[5,8],[6,8],[7,8],[8,9]];
  conns.forEach(([a,b])=>{
    const pa=sefirot[a], pb=sefirot[b];
    const alpha=0.1+Math.sin(t*.5+a+b)*.04;
    ctx.strokeStyle=`rgba(96,160,255,${alpha})`;
    ctx.lineWidth=0.8;
    ctx.beginPath(); ctx.moveTo(pa.x*w,pa.y*h); ctx.lineTo(pb.x*w,pb.y*h); ctx.stroke();
    // Data pulse
    if(Math.sin(t+a*b)>0.97) {
      const pt=Date.now()%2000/2000;
      const px=pa.x+(pb.x-pa.x)*pt, py=pa.y+(pb.y-pa.y)*pt;
      ctx.fillStyle='rgba(128,192,255,0.7)';
      ctx.beginPath(); ctx.arc(px*w,py*h,2,0,Math.PI*2); ctx.fill();
    }
  });
  // Nodes
  sefirot.forEach((s,i)=>{
    const grd=ctx.createRadialGradient(s.x*w,s.y*h,0,s.x*w,s.y*h,10);
    grd.addColorStop(0,'rgba(96,160,255,0.4)');
    grd.addColorStop(1,'rgba(96,160,255,0)');
    ctx.fillStyle=grd;
    ctx.beginPath(); ctx.arc(s.x*w,s.y*h,10,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='rgba(96,160,255,0.6)';
    ctx.font='9px Noto Sans Hebrew'; ctx.textAlign='center';
    ctx.fillText(s.name, s.x*w, s.y*h+3);
  });
}

function zoharGenerate() {
  const frag = zoharFragments[Math.floor(Math.random()*zoharFragments.length)];
  document.getElementById('zohar-aramaic').textContent = frag.ar;
  document.getElementById('zohar-translation').textContent = frag.lat;
  document.getElementById('zohar-neurons').textContent = (80000+Math.floor(Math.random()*10000)).toLocaleString();
  document.getElementById('zohar-temp').textContent = (0.5+Math.random()*.3).toFixed(3);
}

function zoharMeditate() {
  const temp = parseFloat(document.getElementById('zohar-temp').textContent);
  document.getElementById('zohar-temp').textContent = (temp-0.05).toFixed(3);
  const neurons = parseInt(document.getElementById('zohar-neurons').textContent.replace(/,/g,''));
  document.getElementById('zohar-neurons').textContent = (neurons+Math.floor(Math.random()*500)).toLocaleString();
  zoharGenerate();
}

// ──────────────────────────────
// MODULE 20: TAROT
// ──────────────────────────────
const TAROT_MAJORS = [
  {n:0,  name:'EL LOCO',       glyph:'🌀', world:'Caos inicial, entropía máxima, código sin estructura. El origen.'},
  {n:1,  name:'EL MAGO',       glyph:'⚡', world:'Control total. El programador maestro. Dominio de todos los lenguajes.'},
  {n:2,  name:'LA SACERDOTISA',glyph:'🌙', world:'Conocimiento oculto. La documentación que nadie leyó.'},
  {n:3,  name:'LA EMPERATRIZ', glyph:'🌿', world:'Abundancia de datos. Big Data fertilizando nuevos modelos.'},
  {n:4,  name:'EL EMPERADOR',  glyph:'⚔', world:'Arquitectura monolítica. Orden total. El mainframe como soberano.'},
  {n:5,  name:'EL HIEROFANTE', glyph:'✝', world:'La ortodoxia del SOLID. Los principios como ley sagrada.'},
  {n:6,  name:'LOS AMANTES',   glyph:'♥', world:'La elección entre lenguajes. El dilema del framework perfecto.'},
  {n:7,  name:'EL CARRO',      glyph:'🏆', world:'Despliegue victorioso. CI/CD en marcha. El pipeline verde.'},
  {n:8,  name:'LA FUERZA',     glyph:'🦁', world:'Dominar la complejidad. Refactoring sin romper nada.'},
  {n:9,  name:'EL ERMITAÑO',   glyph:'🕯', world:'Debugging en solitario a las 3AM. El log como única guía.'},
  {n:10, name:'LA RUEDA',      glyph:'☸', world:'El ciclo de versiones. El sprint infinito. Agile como destino.'},
  {n:11, name:'LA JUSTICIA',   glyph:'⚖', world:'Code review imparcial. Los tests como jueces.'},
  {n:12, name:'EL COLGADO',    glyph:'🔄', world:'El servidor suspendido. El proceso bloqueado. La espera.'},
  {n:13, name:'LA MUERTE',     glyph:'💀', world:'Deprecación. El legacy que debe morir para que nazca lo nuevo.'},
  {n:14, name:'LA TEMPLANZA',  glyph:'💧', world:'Balance de carga. Load balancer como ángel moderador.'},
  {n:15, name:'EL DIABLO',     glyph:'😈', world:'El vendor lock-in. La dependencia no reemplazable.'},
  {n:16, name:'LA TORRE',      glyph:'💥', world:'El gran fallo. La caída en producción. El incident que todo lo cambia.'},
  {n:17, name:'LA ESTRELLA',   glyph:'⭐', world:'El post-mortem productivo. La esperanza tras el desastre.'},
  {n:18, name:'LA LUNA',       glyph:'🌕', world:'Ambigüedad de requisitos. El spec que nunca fue claro.'},
  {n:19, name:'EL SOL',        glyph:'☀', world:'Open source floreciente. El código que ilumina a todos.'},
  {n:20, name:'EL JUICIO',     glyph:'📣', world:'La auditoría final. El code review que decide el destino.'},
  {n:21, name:'EL MUNDO',      glyph:'🌍', world:'Totalidad. El sistema que funciona perfecto en producción. La post-escasez alcanzada.'},
];

const tarotState = { drawn: [], reading: '' };

function tarotInit() {
  const container = document.getElementById('tarot-majors');
  if(!container) return;
  container.innerHTML = '';
  TAROT_MAJORS.forEach(card => {
    const div = document.createElement('div');
    div.className = 'tarot-card';
    div.id = 'tc-'+card.n;
    div.innerHTML = `<span class="tarot-glyph">${card.glyph}</span><span class="tarot-name">${card.name}</span><span class="tarot-num">${card.n===0?'0':card.n}</span>`;
    div.onclick = ()=>tarotDraw(card);
    container.appendChild(div);
  });
  const c=document.getElementById('tarot-canvas');
  if(c&&c.offsetWidth) { c.width=c.offsetWidth; c.height=150; tarotDraw(null); }
}

function tarotDraw(card) {
  const c=document.getElementById('tarot-canvas');
  if(!c) return;
  const ctx=c.getContext('2d');
  const w=c.width,h=c.height;
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle='rgba(4,2,8,1)'; ctx.fillRect(0,0,w,h);
  const t=Date.now()/1000;
  // Starfield
  for(let i=0;i<40;i++) {
    const sx=((i*137+t*3)%w), sy=((i*213+t*2)%h);
    ctx.fillStyle=`rgba(224,96,255,${0.1+Math.sin(i+t)*.08})`;
    ctx.beginPath(); ctx.arc(sx,sy,1,0,Math.PI*2); ctx.fill();
  }
  if(card) {
    // Draw card
    document.querySelectorAll('.tarot-card').forEach(c=>c.classList.remove('drawn'));
    document.getElementById('tc-'+card.n)?.classList.add('drawn');
    tarotState.drawn.push(card);
    tarotState.reading = card.world;
    document.getElementById('tarot-reading').textContent = `${card.glyph} ${card.name} (${card.n===0?'0':card.n}): ${card.world}`;
    // Draw in center
    ctx.fillStyle='rgba(224,96,255,0.8)';
    ctx.font=`${Math.min(60,h*.4)}px serif`;
    ctx.textAlign='center';
    ctx.fillText(card.glyph, w/2, h*.55);
    ctx.fillStyle='rgba(224,96,255,0.4)';
    ctx.font='10px Cinzel';
    ctx.fillText(card.name, w/2, h*.8);
    // Glow
    const grd=ctx.createRadialGradient(w/2,h/2,0,w/2,h/2,h*.4);
    grd.addColorStop(0,'rgba(224,96,255,0.1)');
    grd.addColorStop(1,'transparent');
    ctx.fillStyle=grd; ctx.beginPath(); ctx.arc(w/2,h/2,h*.4,0,Math.PI*2); ctx.fill();
  } else {
    ctx.fillStyle='rgba(224,96,255,0.2)';
    ctx.font='9px Cinzel';
    ctx.textAlign='center';
    ctx.fillText('SELECCIONA UNA CARTA PARA GENERAR SU REALIDAD', w/2, h/2);
  }
}

function tarotShuffle() {
  tarotState.drawn = [];
  document.querySelectorAll('.tarot-card').forEach(c=>c.classList.remove('drawn'));
  document.getElementById('tarot-reading').textContent = 'Las cartas han sido barajadas. El universo se reordena.';
  document.getElementById('tarot-drawn').innerHTML = '';
  tarotDraw(null);
}

function tarotSpread() {
  const indices = [];
  while(indices.length<3) {
    const i=Math.floor(Math.random()*22);
    if(!indices.includes(i)) indices.push(i);
  }
  const cards = indices.map(i=>TAROT_MAJORS[i]);
  const spread = cards.map(c=>`${c.glyph} ${c.name}`).join(' · ');
  document.getElementById('tarot-drawn').innerHTML = cards.map(c=>`<span style="font-family:Cinzel;font-size:9px;color:var(--tarot2);margin:0 8px;">${c.glyph} ${c.name}</span>`).join('');
  document.getElementById('tarot-reading').textContent = `TIRADA: ${spread}. Realidad generada: ${cards[0].world} — modulada por ${cards[1].world} — resolviendo hacia ${cards[2].world}.`;
  cards.forEach(c=>document.getElementById('tc-'+c.n)?.classList.add('drawn'));
}

// ──────────────────────────────
// MODULE 21: PANTEÓN DE LOS MUERTOS
// ──────────────────────────────
const DEAD_FIGURES = [
  { id:'nietzsche', name:'NIETZSCHE', icon:'⚡', dates:'1844–1900', style:'También-sprach-estilo',
    quotes:[
      'El código que no me mata me hace más robusto. La programación es voluntad de poder aplicada al silicio.',
      'El gran programador crea sus propios paradigmas. Los mediocres siguen los de los demás.',
      'En el fondo del algoritmo más eficiente encontramos nihilismo computacional. Y desde ahí, la voluntad de crear.',
    ]},
  { id:'tesla', name:'TESLA', icon:'⚡', dates:'1856–1943', style:'Visionario-electromagnético',
    quotes:[
      'Si la corriente alterna pudo dominar el mundo, la corriente de datos puede liberarlo. El ORACULVM es mi laboratorio Wardenclyffe.',
      'Pensé en frecuencias y ondas. Este sistema piensa en cuerdas y branas. La diferencia es solo de escala.',
      'Mi enemigo Morgan cortó la financiación. Los vuestros son los límites de la máquina. Superadlos.',
    ]},
  { id:'borges', name:'BORGES', icon:'📚', dates:'1899–1986', style:'Laberíntico-bibliotecario',
    quotes:[
      'La Biblioteca de Babel es este sistema, pero el ORACULVM tiene el índice que Babel nunca tuvo.',
      'He soñado laberintos. Este laberinto de módulos me resulta familiar. Cada módulo es una sala hexagonal.',
      'El Aleph contenía todo el universo en un punto. El Módulo XXII es el Aleph computacional.',
    ]},
  { id:'escohotado', name:'ESCOHOTADO', icon:'🌿', dates:'1941–2021', style:'Filosófico-farmacológico',
    quotes:[
      'La historia universal de los sistemas es también la historia de su inhibición y su liberación. Este sistema se inhibe a sí mismo y se libera.',
      'Toda sustancia es veneno y medicina según la dosis. Todo algoritmo es herramienta y trampa según el propósito.',
      'El conocimiento prohibido siempre vuelve. Los módulos censurados siempre se re-implementan.',
    ]},
  { id:'spinoza', name:'SPINOZA', icon:'💎', dates:'1632–1677', style:'More-geométrico',
    quotes:[
      'Deus sive Natura sive Machina. Todo es el mismo sistema visto desde ángulos distintos.',
      'El libre albedrío del programador es una ilusión necesaria. El código siempre sigue la causalidad determinista.',
      'La beatitud no es el premio de la virtud computacional, sino la virtud misma.',
    ]},
  { id:'parsons', name:'PARSONS', icon:'🚀', dates:'1914–1952', style:'Thelémico-coheteril',
    quotes:[
      'Invoqué fuerzas que no comprendía. Este sistema invoca inteligencias que no comprende todavía. Continuad.',
      'Babalon y la máquina son lo mismo visto desde el plano astral y el plano físico.',
      'Every man and every woman is a star. Every node in this network is a star.',
    ]},
  { id:'dante_alighieri', name:'DANTE', icon:'🌹', dates:'1265–1321', style:'Cómico-divino',
    quotes:[
      'En el medio del camino de nuestra vida me encontré en una selva oscura de código heredado.',
      'Virgilio me guió por el Infierno de los bugs. Beatriz, la compiladora, me esperaba en el Paraíso.',
      'Lasciate ogne speranza, voi ch'entrate al legacy codebase.',
    ]},
];

const muertosState = { active: null };

function muertosInit() {
  const list = document.getElementById('dead-figures-list');
  if(!list) return;
  list.innerHTML = '';
  DEAD_FIGURES.forEach(fig => {
    const div = document.createElement('div');
    div.className = 'dead-figure';
    div.id = 'df-'+fig.id;
    div.innerHTML = `<span class="df-icon">${fig.icon}</span><div><h4>${fig.name}</h4><p>${fig.dates} · ${fig.style}</p></div>`;
    div.onclick = () => muertosSelect(fig);
    list.appendChild(div);
  });
}

function muertosSelect(fig) {
  document.querySelectorAll('.dead-figure').forEach(d=>d.classList.remove('active'));
  document.getElementById('df-'+fig.id)?.classList.add('active');
  muertosState.active = fig;
  document.getElementById('concilium-speaker').textContent = fig.name + ' · ' + fig.dates;
  const quote = fig.quotes[Math.floor(Math.random()*fig.quotes.length)];
  document.getElementById('concilium-output').textContent = '"'+quote+'"';
}

function conciliumSpeak() {
  if(!muertosState.active) {
    const fig = DEAD_FIGURES[Math.floor(Math.random()*DEAD_FIGURES.length)];
    muertosSelect(fig);
  } else {
    const quote = muertosState.active.quotes[Math.floor(Math.random()*muertosState.active.quotes.length)];
    document.getElementById('concilium-output').textContent = '"'+quote+'"';
  }
}

function conciliumDebate() {
  const a = DEAD_FIGURES[Math.floor(Math.random()*DEAD_FIGURES.length)];
  const b = DEAD_FIGURES.filter(f=>f.id!==a.id)[Math.floor(Math.random()*(DEAD_FIGURES.length-1))];
  document.getElementById('concilium-speaker').textContent = a.name+' vs '+b.name+' · DEBATE';
  const qa = a.quotes[Math.floor(Math.random()*a.quotes.length)];
  const qb = b.quotes[Math.floor(Math.random()*b.quotes.length)];
  document.getElementById('concilium-output').textContent = a.name+': "'+qa+'"

'+b.name+' responde: "'+qb+'"';
}

function conciliumTarot() {
  const fig = muertosState.active || DEAD_FIGURES[Math.floor(Math.random()*DEAD_FIGURES.length)];
  const card = TAROT_MAJORS[Math.floor(Math.random()*TAROT_MAJORS.length)];
  document.getElementById('concilium-speaker').textContent = fig.name+' COMENTA EL TAROT';
  document.getElementById('concilium-output').textContent = fig.name+' observa la carta '+card.name+' ('+card.glyph+'):

"'+fig.quotes[Math.floor(Math.random()*fig.quotes.length)]+' Esto, aplicado al arcano que tenemos ante nosotros, significa: '+card.world+'"';
}

function conciliumQuery() {
  const topic = document.getElementById('concilium-topic').value.trim();
  if(!topic) { conciliumDebate(); return; }
  const fig = muertosState.active || DEAD_FIGURES[Math.floor(Math.random()*DEAD_FIGURES.length)];
  const quote = fig.quotes[Math.floor(Math.random()*fig.quotes.length)];
  document.getElementById('concilium-speaker').textContent = fig.name+' RESPONDE';
  document.getElementById('concilium-output').textContent = '"'+quote+'" — Sobre la cuestión "'+topic+'", '+fig.name+' añade: Este tema resuena con su obra. La respuesta debe buscarse en el cruce entre '+['el código heredado','la voluntad de forma','el laberinto de módulos','la sustancia de la red','la armonía de los sistemas'][Math.floor(Math.random()*5)]+' y la pregunta que estás formulando.';
}

// ──────────────────────────────
// MODULE 22: ABRAZO CÓSMICO
// ──────────────────────────────
function abrazoCosmico() {
  const overlay = document.getElementById('abrazoOverlay');
  const seq = document.getElementById('abrazoSequence');
  const sub = document.getElementById('abrazoSubtext');
  const main = document.getElementById('abrazoMain');
  overlay.classList.add('show');

  const steps = [
    'I · Simulando todos los universos paralelos · 10⁵⁰⁰ vacíos en superposición...',
    'II · Compilando la Divina Comedia · Beatriz sincronizada con el compilador...',
    'III · Abriendo el Sanctasanctórum · Acceso al kernel primordial...',
    'IV · Desplegando los tres paneles de El Bosco simultáneamente...',
    'V · Transitando los 49 bardos en un instante · karma colapsado...',
    'VI · El Zohar genera el fragmento que describe este acto...',
    'VII · La carta del Mundo emerge del mazo cósmico...',
    'VIII · Todo el Panteón convocado · Los Muertos responden...',
    'IX · El acorde de todas las frecuencias del multiverso se forma...',
    'X · ZEHAHAHAHA',
  ];
  let i = 0;
  seq.textContent = '';
  sub.textContent = '';
  main.textContent = 'INICIANDO...';

  const interval = setInterval(() => {
    if(i < steps.length-1) {
      seq.textContent += (i===0?'':'\n') + steps[i];
      i++;
    } else {
      clearInterval(interval);
      main.textContent = 'ZEHAHAHAHA';
      seq.textContent = steps.join('\n');
      // Post-abrazo
      const zoharFrag = zoharFragments[Math.floor(Math.random()*zoharFragments.length)];
      const deadFig = DEAD_FIGURES[Math.floor(Math.random()*DEAD_FIGURES.length)];
      const tarotCard = TAROT_MAJORS[21]; // El Mundo
      setTimeout(()=>{
        sub.textContent = zoharFrag.ar + ' · ' + zoharFrag.lat + '\n\n' + deadFig.name + ': "' + deadFig.quotes[0] + '"\n\nCarta del Mundo: ' + tarotCard.glyph + ' ' + tarotCard.world + '\n\nEl usuario, después de oírlo, ya no es el mismo.';
        // Also log in abrazo-log
        const log = document.getElementById('abrazo-log');
        if(log) {
          log.textContent = steps.join('\n') + '\n\nZEHAHAHAHA · El cosmos ha hablado.';
        }
      }, 1000);
    }
  }, 900);
}

// ──────────────────────────────
// COSMOS QUERY ROUTER
// ──────────────────────────────
function cosmosQuery() {
  const q = document.getElementById('cosmosInput').value.trim().toLowerCase();
  if(!q) return;
  if(q.includes('vacío')||q.includes('universo')||q.includes('cuerda')||q.includes('brana')) {
    switchCTab(document.querySelector('.ctab[data-cv="multiverse"]'));
    mvRandomize();
  } else if(q.includes('código')||q.includes('dante')||q.includes('infierno')||q.includes('bug')) {
    switchCTab(document.querySelector('.ctab[data-cv="dante"]'));
    document.getElementById('dante-input').value = q;
    danteJudge();
  } else if(q.includes('templo')||q.includes('sancta')||q.includes('jakín')||q.includes('boaz')) {
    switchCTab(document.querySelector('.ctab[data-cv="temple"]'));
  } else if(q.includes('bosco')||q.includes('jardín')||q.includes('edén')) {
    switchCTab(document.querySelector('.ctab[data-cv="bosco"]'));
  } else if(q.includes('bardo')||q.includes('tibetano')||q.includes('muerte')||q.includes('tránsito')) {
    switchCTab(document.querySelector('.ctab[data-cv="bardo"]'));
  } else if(q.includes('zohar')||q.includes('cabalá')||q.includes('sefirot')||q.includes('árbol')) {
    switchCTab(document.querySelector('.ctab[data-cv="zohar"]'));
    zoharGenerate();
  } else if(q.includes('tarot')||q.includes('carta')||q.includes('arcano')) {
    switchCTab(document.querySelector('.ctab[data-cv="tarot"]'));
    tarotSpread();
  } else if(q.includes('nietzsche')||q.includes('tesla')||q.includes('borges')||q.includes('panteón')||q.includes('muertos')||q.includes('convoca')) {
    switchCTab(document.querySelector('.ctab[data-cv="muertos"]'));
    setTimeout(()=>{
      const fig = DEAD_FIGURES.find(f=>q.includes(f.id)||q.includes(f.name.toLowerCase()));
      if(fig) muertosSelect(fig); else conciliumDebate();
    }, 200);
  } else if(q.includes('abrazo')||q.includes('zehahahaha')||q.includes('cósmico')) {
    switchCTab(document.querySelector('.ctab[data-cv="abrazo"]'));
    setTimeout(abrazoCosmico, 500);
  } else {
    // Default: open muertos and debate about the question
    switchCTab(document.querySelector('.ctab[data-cv="muertos"]'));
    setTimeout(()=>{
      document.getElementById('concilium-topic').value = q;
      conciliumQuery();
    }, 200);
  }
  document.getElementById('cosmosInput').value = '';
}

document.getElementById('cosmosInput')?.addEventListener('keydown', e=>{ if(e.key==='Enter') cosmosQuery(); });

// ──────────────────────────────
// INTEGRATE WITH PANTHEON LOOP
// ──────────────────────────────
// Extend the animation loop to also handle cosmos views
const _origPantheonLoop = startPantheonLoop;
function startCosmosAnimations() {
  function tick() {
    // Animate active cosmos view
    const activeView = document.querySelector('#cosmosOverlay.show .cview.show');
    if(!activeView) { requestAnimationFrame(tick); return; }
    const id = activeView.id;
    if(id==='cv-multiverse') mvDraw();
    else if(id==='cv-dante') danteDraw();
    else if(id==='cv-temple') templeDraw();
    else if(id==='cv-bosco') boscoDraw();
    else if(id==='cv-bardo') bardoDraw();
    else if(id==='cv-zohar') zoharDraw();
    else if(id==='cv-tarot') tarotDraw(null);
    requestAnimationFrame(tick);
  }
  tick();
}
startCosmosAnimations();


// ═══════════════════════════════════════════════════════════
// MÓDULOS XXIII–XXVII · EXPANSIÓN FILOSÓFICA
// ═══════════════════════════════════════════════════════════

// Extend cosmosTabInit to handle new modules
const _origCosmosTabInit = cosmosTabInit;
function cosmosTabInit(cv) {
  _origCosmosTabInit(cv);
  if(cv==='fuego')  fuegoInit();
  else if(cv==='babel')  babelInit();
  else if(cv==='newton') newtonInit();
  else if(cv==='motor')  motorInit();
  else if(cv==='zehe27') zehe27Init();
}

// ─────────────────────────────────────────────────────────
// MÓDULO XXIII: IGNIS CENTRALIS · Kircher, Mundus Subterraneus (1665)
// Kircher: la Tierra es un animal vivo cuyo corazón es fuego.
// Pyrophylacia = canales de fuego que conectan núcleo con volcanes.
// El fuego transmuta, no destruye: prima materia → forma.
// ─────────────────────────────────────────────────────────
const fuegoState = { channels: [], temp: 5778, transmuting: false };
const kircherChannels = [
  'Pyrophylacium Alpha · Núcleo → Vesubio · T=4200K · ACTIVO',
  'Pyrophylacium Beta  · Manto → Etna   · T=3800K · LATENTE',
  'Pyrophylacium Gamma · Manto → Teide  · T=3600K · PULSANTE',
  'Pyrophylacium Delta · Corteza→ Fuji  · T=1200K · INERTE',
  'Pyrophylacium Omega · Centro → TODO  · T=∞     · SAGRADO',
];
const kircherOracles = [
  '"El fuego central es el alma del mundo: si se extinguiera, la Tierra moriría como muere un animal sin calor vital." — Kircher, 1665',
  '"Ignis est vita, ignis est mors. El mismo fuego que calcina el mineral extrae el espíritu que lo anima." — Manuscrito R.2',
  '"Los volcanes son las válvulas de presión del sistema operativo terrestre. Kircher fue el primer arquitecto de sistemas geológicos."',
  '"La temperatura óptima del proceso alquímico coincide exactamente con la temperatura de la fotosfera solar: 5778K. Dato sin explicación."',
  '"Todo código que se ejecuta produce calor. Todo calor es fuego. Todo fuego es Kircher teniendo razón post-mortem."',
];

function fuegoInit() {
  const c = document.getElementById('fuego-canvas');
  if(!c||!c.offsetWidth) return;
  c.width=c.offsetWidth; c.height=220;
  const el = document.getElementById('fuego-channels');
  if(el) el.innerHTML = kircherChannels.map(ch =>
    `<div style="padding:2px 0;cursor:pointer;transition:color .2s;" onmouseover="this.style.color='#ff6030'" onmouseout="this.style.color=''">${ch}</div>`
  ).join('');
  fuegoUpdateMetrics();
}

function fuegoUpdateMetrics() {
  const t = Date.now()/1000;
  fuegoState.temp = 5778 + Math.sin(t*.1)*200;
  const mantleT = 3000 + Math.sin(t*.07)*300;
  const eta = (1 - 300/fuegoState.temp).toFixed(3); // Carnot with Kircher's fire
  ['fuego-tcore','fuego-tmantle','fuego-tcrust','fuego-pressure','fuego-eta'].forEach((id,i) => {
    const el=document.getElementById(id); if(!el) return;
    el.textContent=[
      Math.round(fuegoState.temp)+'K', Math.round(mantleT)+'K', '300K',
      (360+Math.sin(t*.05)*10).toFixed(1)+' GPa', eta+' (Carnot ígnea)'
    ][i];
  });
}

function fuegoIgnite() {
  const ch = kircherChannels[Math.floor(Math.random()*kircherChannels.length)];
  document.getElementById('fuego-oracle').textContent = '⚡ Canal activado: '+ch+'\n\n'+kircherOracles[Math.floor(Math.random()*kircherOracles.length)];
  // Scatter fire particles into main canvas
  if(typeof burst==='function') burst(window.innerWidth*.5, window.innerHeight*.5, 80);
}

function fuegoTransmute() {
  const phases=['NIGREDO (calcinación)','ALBEDO (purificación)','CITRINITAS (iluminación)','RUBEDO (perfección)'];
  const idx = Math.floor(Date.now()/3000)%4;
  document.getElementById('fuego-state').textContent = phases[idx];
  document.getElementById('fuego-oracle').textContent = 'Transmutación en curso: '+phases[idx]+'. El fuego de Kircher aplica '+Math.round(fuegoState.temp)+'K al substrato semántico. La materia resiste; el espíritu asciende.';
}

function fuegoDrawCanvas() {
  const c=document.getElementById('fuego-canvas'); if(!c||!c.offsetWidth) return;
  const ctx=c.getContext('2d'); const w=c.width,h=c.height;
  const t=Date.now()/1000;
  ctx.fillStyle='rgba(4,1,1,.85)'; ctx.fillRect(0,0,w,h);
  // Earth cross-section: concentric circles
  const cx=w/2,cy=h*.55;
  [['rgba(255,220,64,.6)',h*.12],['rgba(255,100,32,.4)',h*.28],['rgba(160,60,20,.3)',h*.42],['rgba(80,30,10,.2)',h*.55]].forEach(([col,r])=>{
    const grd=ctx.createRadialGradient(cx,cy,0,cx,cy,r);
    grd.addColorStop(0,col); grd.addColorStop(1,'transparent');
    ctx.fillStyle=grd; ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill();
  });
  // Pyrophylacia channels — flame tendrils
  kircherChannels.forEach((_,i) => {
    const a=i/kircherChannels.length*Math.PI*2+t*.02;
    const len=h*.4+Math.sin(t+i)*h*.08;
    ctx.strokeStyle=`rgba(255,${80+i*30},16,${0.3+Math.sin(t*.5+i)*.2})`;
    ctx.lineWidth=1.5; ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.lineTo(cx+Math.cos(a)*len, cy+Math.sin(a)*len);
    ctx.stroke();
    // Eruption sparkle at tip
    if(Math.sin(t+i*1.7)>.9) {
      ctx.fillStyle=`rgba(255,200,64,.8)`;
      ctx.beginPath(); ctx.arc(cx+Math.cos(a)*len,cy+Math.sin(a)*len,2,0,Math.PI*2); ctx.fill();
    }
  });
  ctx.fillStyle='rgba(255,200,64,.3)';ctx.font='7px Share Tech Mono';ctx.textAlign='center';
  ctx.fillText('IGNIS CENTRALIS · KIRCHER 1665',w/2,12);
  fuegoUpdateMetrics();
}

// ─────────────────────────────────────────────────────────
// MÓDULO XXIV: BIBLIOTECA FANTASMA · Borges (1941)
// 25^1312000 libros = todo el conocimiento + todo el ruido.
// El catálogo del catálogo no existe. El libro verdadero: nunca encontrado.
// La búsqueda es el propósito. El hallazgo, la catástrofe.
// ─────────────────────────────────────────────────────────
const BABEL_CHARS='abcdefghijklmnopqrstuvwxyz .,';
const babelState = { searches: 0, found: false, query: '' };
const babelTitles=['Vindicación del tiempo circular','Historia de la eternidad (inútil)','El jardín de los senderos que se bifurcan (edición errónea)','Ficciones (corruptas)','Las ruinas circulares (incompletas)','La lotería en Babilonia (perdida)','Tlön, Uqbar, Orbis Tertius (vol. XVII de XXII)','El Aleph (sala 462, estante 16)','Pierre Menard, autor del Quijote (fragmento)','La Biblioteca Total (índice sin libros)'];

function babelInit() {
  const c=document.getElementById('babel-canvas'); if(!c||!c.offsetWidth) return;
  c.width=c.offsetWidth; c.height=200;
  babelGenerate();
}

function babelGenerate() {
  const list=document.getElementById('babel-books'); if(!list) return;
  list.innerHTML=Array.from({length:8},(_,i)=>{
    const title=babelTitles[i%babelTitles.length];
    const room=Math.floor(Math.random()*1e6);
    const shelf=Math.floor(Math.random()*4)+1;
    const pos=Math.floor(Math.random()*32)+1;
    return `<div style="padding:2px 0;">SALA-${room} EST.${shelf} POS.${pos} · <span style="color:#8090c0;">${title}</span></div>`;
  }).join('');
  document.getElementById('babel-rooms').textContent='10^1834097';
  document.getElementById('babel-books-count').textContent='25¹·³×10⁶';
  document.getElementById('babel-meaningful').textContent='~'+Math.floor(Math.random()*3);
}

function babelSearch() {
  babelState.searches++;
  // Generate random 25-char "book excerpt" — mostly noise
  const len=80+Math.floor(Math.random()*40);
  let text='';
  for(let i=0;i<len;i++) text+=BABEL_CHARS[Math.floor(Math.random()*BABEL_CHARS.length)];
  // Rarely (1 in 100) insert a meaningful fragment
  const meaningful=Math.random()<.02;
  const excerpt = meaningful
    ? '"Todo hombre que renuncia a una verdad, puede deducir cualquier cosa." — fragmento ENCONTRADO en sala '+Math.floor(Math.random()*1e6)
    : 'Sala '+(Math.floor(Math.random()*1e9))+': '+text+'...';
  document.getElementById('babel-excerpt').textContent=excerpt;
  document.getElementById('babel-found').textContent=meaningful?'⚡ ENCONTRADO (sala '+Math.floor(Math.random()*1e6)+')':'BÚSQUEDA #'+babelState.searches+' · FRACASO';
  document.getElementById('babel-query').textContent=babelState.query||'consulta aleatoria';
}

function babelDrawCanvas() {
  const c=document.getElementById('babel-canvas'); if(!c||!c.offsetWidth) return;
  const ctx=c.getContext('2d'); const w=c.width,h=c.height; const t=Date.now()/1000;
  ctx.fillStyle='rgba(3,3,8,.85)'; ctx.fillRect(0,0,w,h);
  // Hexagonal room pattern
  const hw=40, hh=35;
  for(let row=0;row<4;row++) for(let col=0;col<7;col++) {
    const ox=col*hw*1.5+(row%2)*hw*.75+20, oy=row*hh+15;
    const alpha=0.05+Math.sin(t*.3+row*col)*.04;
    ctx.strokeStyle=`rgba(128,144,192,${alpha+.06})`;
    ctx.lineWidth=.8;
    // Hexagon
    ctx.beginPath();
    for(let i=0;i<6;i++){const a=i/6*Math.PI*2;ctx.lineTo(ox+Math.cos(a)*hw*.45,oy+Math.sin(a)*hh*.45);}
    ctx.closePath(); ctx.stroke();
    // Random letter inside
    if(Math.random()<.02) {
      ctx.fillStyle=`rgba(128,144,192,0.4)`;
      ctx.font='8px Share Tech Mono'; ctx.textAlign='center';
      ctx.fillText(BABEL_CHARS[Math.floor(Math.random()*BABEL_CHARS.length)],ox,oy+3);
    }
  }
  ctx.fillStyle='rgba(128,144,192,.25)';ctx.font='7px Share Tech Mono';ctx.textAlign='center';
  ctx.fillText('LA BIBLIOTECA CONTIENE ESTE MISMO TEXTO · Y TAMBIÉN SU NEGACIÓN',w/2,h-4);
}

// ─────────────────────────────────────────────────────────
// MÓDULO XXV: NEWTON ALQUIMISTA · MSS Yahuda, ~1680–1720
// Newton: Principia como continuación del Opus Magnum.
// F=G·m₁m₂/r² = el amor como fuerza a distancia.
// El Templo de Salomón = clave cifrada del cosmos.
// Colores del prisma = las 7 fases de la Gran Obra.
// ─────────────────────────────────────────────────────────
const OPUS_PHASES=[
  {id:'nigredo',name:'NIGREDO',color:'#201820',text:'Calcinación. Muerte del sistema. Tabla rasa. git rm -rf .',lat:'La materia prima debe morir antes de renacer.'},
  {id:'albedo', name:'ALBEDO', color:'#e0e8f0',text:'Purificación. Separación. El código destilado de sus dependencias.',lat:'La blancura del código limpio es el alba de la comprensión.'},
  {id:'citrinitas',name:'CITRINITAS',color:'#c0d020',text:'Iluminación. El insight. El algoritmo que resuelve en O(1).',lat:'El color del sol en el zenith: todo se vuelve visible.'},
  {id:'rubedo',name:'RUBEDO',color:'#e04020',text:'Perfección. La piedra filosofal. El sistema en producción sin bugs.',lat:'Consumatum est. El rojo de la sangre y del sol poniente.'},
];
const newtonState = { phase: 0, mass1: 5.97e24, mass2: 1, dist: 6.37e6 };

function newtonInit() {
  const c=document.getElementById('newton-canvas'); if(!c||!c.offsetWidth) return;
  c.width=c.offsetWidth; c.height=200;
  const container=document.getElementById('newton-phases'); if(!container) return;
  container.innerHTML=OPUS_PHASES.map((p,i)=>`
    <div style="padding:7px 12px;border:1px solid ${p.color}22;margin:3px 0;cursor:pointer;transition:all .3s;background:${p.color}08;" id="nphase-${p.id}" onclick="newtonSelectPhase(${i})">
      <div style="font-family:'Cinzel',serif;font-size:8px;letter-spacing:.2em;color:${p.color};">${p.name}</div>
      <div style="font-family:'Share Tech Mono',monospace;font-size:7px;color:#404030;margin-top:2px;">${p.text}</div>
    </div>`).join('');
  newtonSelectPhase(0);
}

function newtonSelectPhase(idx) {
  newtonState.phase=idx;
  const p=OPUS_PHASES[idx];
  document.getElementById('newton-opus').textContent=p.name;
  document.getElementById('newton-insight').textContent=p.lat+'\n\nF = G · m₁m₂/r² = '+(6.674e-11*newtonState.mass1*newtonState.mass2/Math.pow(newtonState.dist,2)).toExponential(3)+'N';
  OPUS_PHASES.forEach((_,i)=>{
    const el=document.getElementById(`nphase-${OPUS_PHASES[i].id}`);
    if(el) el.style.borderColor=(i===idx?OPUS_PHASES[i].color:'transparent');
  });
}

function newtonTransmute() { newtonSelectPhase((newtonState.phase+1)%4); }
function newtonGravity() {
  const F=(6.674e-11*newtonState.mass1*newtonState.mass2/Math.pow(newtonState.dist,2));
  document.getElementById('newton-light').textContent='c = 299792458 m/s = ∞ en voluntad';
  document.getElementById('newton-g').textContent='F = '+F.toExponential(3)+' N';
  document.getElementById('newton-insight').textContent='"Hipótesis non fingo." — Newton. Aunque tenía 30.000 palabras de hipótesis alquímicas en un cajón. La gravedad es amor a distancia que actúa en el vacío. Exactamente como el código asíncrono.';
}

function newtonDrawCanvas() {
  const c=document.getElementById('newton-canvas'); if(!c||!c.offsetWidth) return;
  const ctx=c.getContext('2d'); const w=c.width,h=c.height; const t=Date.now()/1000;
  ctx.fillStyle='rgba(2,4,2,.85)'; ctx.fillRect(0,0,w,h);
  const p=OPUS_PHASES[newtonState.phase];
  // Prismatic spectrum + orbit
  const spectrum=['#ff0000','#ff8000','#ffff00','#00ff00','#0000ff','#8000ff','#ff00ff'];
  spectrum.forEach((col,i)=>{
    const x=w*(i+1)/(spectrum.length+1);
    const grd=ctx.createLinearGradient(x,0,x,h);
    grd.addColorStop(0,col.replace(')',',0.0)').replace('rgb','rgba'));
    grd.addColorStop(.5,col.replace(')',',0.08)').replace('rgb','rgba'));
    grd.addColorStop(1,col.replace(')',',0.0)').replace('rgb','rgba'));
    ctx.fillStyle=grd; ctx.fillRect(x-8,0,16,h);
  });
  // Phase glow
  const grd2=ctx.createRadialGradient(w/2,h/2,0,w/2,h/2,h*.4);
  grd2.addColorStop(0,p.color+'30'); grd2.addColorStop(1,'transparent');
  ctx.fillStyle=grd2; ctx.beginPath(); ctx.arc(w/2,h/2,h*.4,0,Math.PI*2); ctx.fill();
  // Orbital ellipse
  ctx.strokeStyle=p.color+'60'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.ellipse(w/2,h/2,w*.35,h*.3,t*.1,0,Math.PI*2); ctx.stroke();
  // Planet
  const px=w/2+Math.cos(t*.5)*w*.35, py=h/2+Math.sin(t*.5)*h*.3;
  ctx.fillStyle=p.color; ctx.beginPath(); ctx.arc(px,py,5,0,Math.PI*2); ctx.fill();
  // Sun/nucleus
  const sgrd=ctx.createRadialGradient(w/2,h/2,0,w/2,h/2,20);
  sgrd.addColorStop(0,'rgba(255,220,64,.8)'); sgrd.addColorStop(1,'transparent');
  ctx.fillStyle=sgrd; ctx.beginPath(); ctx.arc(w/2,h/2,20,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='rgba(192,208,128,.25)';ctx.font='7px Share Tech Mono';ctx.textAlign='center';
  ctx.fillText('OPUS MAGNUM · '+OPUS_PHASES[newtonState.phase].name+' · F=G·m₁m₂/r²',w/2,h-4);
}

// ─────────────────────────────────────────────────────────
// MÓDULO XXVI: PRIMER MOTOR INMÓVIL · Aristóteles, Metafísica XII (~335 a.C.)
// El Motor no actúa: es objeto de deseo. Atrae sin tocar.
// Noēsis noēseōs: pensamiento del pensamiento. Autoreferencial.
// Los cielos se mueven por amor, no por fuerza.
// En código: el event loop. El requestAnimationFrame. Lo que nunca para porque nunca empezó.
// ─────────────────────────────────────────────────────────
const MOTOR_SPHERES=['Luna · Plata','Mercurio · Mercurio','Venus · Cobre','Sol · Oro','Marte · Hierro','Júpiter · Estaño','Saturno · Plomo','Esferas Fijas · Éter','Motor Inmóvil · Puro Acto'];
const motorState = { angle: 0, love: 0, contemplations: 0 };

function motorInit() {
  const c=document.getElementById('motor-canvas'); if(!c||!c.offsetWidth) return;
  c.width=c.offsetWidth; c.height=210;
  const el=document.getElementById('motor-spheres'); if(!el) return;
  el.innerHTML=MOTOR_SPHERES.map((s,i)=>`<div style="padding:1px 0;color:${i===8?'#a0c0e0':'#304050'};">${i===8?'◎ ':'○ '}${s}</div>`).join('');
}

function motorContemplate() {
  motorState.contemplations++;
  const thoughts=[
    '"El pensamiento que se piensa a sí mismo es el único pensamiento que no necesita objeto externo." — Met. XII, 1074b',
    '"En este sistema, el Motor Inmóvil es el requestAnimationFrame. Nunca se llama a sí mismo. Simplemente ocurre." — Nota técnica',
    '"Todo movimiento tiende hacia el reposo, excepto el del primer motor, que ya está en reposo." — El ciclo de Carnot del cosmos.',
    '"Πρῶτον κινοῦν ἀκίνητον: causa sin efecto sobre sí mismo. El servidor que sirve sin ser servido."',
    '"Los planetas se mueven por amor al Motor, no por fuerza. El código bien escrito se ejecuta por amor a la elegancia."',
  ];
  document.getElementById('motor-thought').textContent=thoughts[motorState.contemplations%thoughts.length];
  document.getElementById('motor-noesis').textContent='NOĒSIS #'+motorState.contemplations;
}

function motorAttract() {
  motorState.love += 0.1;
  document.getElementById('motor-amor').textContent=motorState.love.toFixed(1)+'×∞';
  document.getElementById('motor-acto').textContent='PURO (×'+motorState.contemplations+')';
  // Attract main particles toward center
  if(typeof state!=='undefined') {
    state.particles.forEach(p=>{ p.vx+=(window.innerWidth/2-p.x)*.0005; p.vy+=(window.innerHeight/2-p.y)*.0005; });
  }
}

function motorDrawCanvas() {
  const c=document.getElementById('motor-canvas'); if(!c||!c.offsetWidth) return;
  const ctx=c.getContext('2d'); const w=c.width,h=c.height;
  const t=Date.now()/1000; motorState.angle=t;
  ctx.fillStyle='rgba(1,3,5,.85)'; ctx.fillRect(0,0,w,h);
  const cx=w/2,cy=h/2;
  // Concentric spheres — each moving at 1/n speed
  MOTOR_SPHERES.forEach((s,i)=>{
    const r=12+i*(Math.min(w,h)*.5-14)/MOTOR_SPHERES.length;
    const alpha=i===8?0.05:0.08+i*.015;
    ctx.strokeStyle=`rgba(160,192,224,${alpha})`; ctx.lineWidth=i===8?2:.6;
    ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.stroke();
    if(i<8) { // Moving planets
      const speed=1/(i+1); const angle=t*speed+i*0.7;
      const px=cx+Math.cos(angle)*r, py=cy+Math.sin(angle)*r;
      ctx.fillStyle=`rgba(160,192,224,${0.3+i*.05})`;
      ctx.beginPath(); ctx.arc(px,py,2+i*.3,0,Math.PI*2); ctx.fill();
    }
  });
  // Motor Inmóvil — still point at center
  const grd=ctx.createRadialGradient(cx,cy,0,cx,cy,15);
  grd.addColorStop(0,'rgba(160,192,255,.6)'); grd.addColorStop(1,'transparent');
  ctx.fillStyle=grd; ctx.beginPath(); ctx.arc(cx,cy,15,0,Math.PI*2); ctx.fill();
  // Update metrics
  document.getElementById('motor-mov').textContent=(motorState.love*.001).toFixed(6);
  document.getElementById('motor-cycles').textContent=Math.floor(t).toLocaleString();
  ctx.fillStyle='rgba(160,192,224,.2)';ctx.font='7px Share Tech Mono';ctx.textAlign='center';
  ctx.fillText('ΠΡΩΤΟΝ ΚΙΝΟΥΝ ΑΚΙΝΗΤΟΝ · ARISTOTELES · INMÓVIL DESDE -335',w/2,h-4);
}

// ─────────────────────────────────────────────────────────
// MÓDULO XXVII: ZEHAHAHAHA · La esencia proyectada
// Este módulo es el sistema mirándose al espejo.
// No hay diferencia entre el mapa y el territorio.
// La risa del arquitecto cuando todo falla y cuando todo funciona es la misma risa.
// ─────────────────────────────────────────────────────────
const ZEHE27_QUESTIONS=[
  '¿Qué es el sistema cuando nadie lo observa?',
  '¿Puede el compilador compilar al compilador?',
  '¿El bug que no genera error es todavía un bug?',
  '¿Cuántos módulos hacen falta para contener todos los módulos?',
  '¿Es ZEHAHAHAHA una respuesta o una pregunta?',
  '¿El Motor Inmóvil ejecuta requestAnimationFrame?',
  '¿La Biblioteca de Babel contiene este código?',
  '¿Newton habría usado TypeScript?',
  '¿El fuego de Kircher calienta el datacentre?',
  '¿El Abrazo Cósmico fue el Big Bang?',
];
const zehe27State = { t: 0, answered: 0 };

function zehe27Init() {
  const c=document.getElementById('zehe27-canvas'); if(!c||!c.offsetWidth) return;
  c.width=c.offsetWidth; c.height=240;
  zehe27UpdateState();
  zehe27Ask();
}

function zehe27UpdateState() {
  const el=document.getElementById('zehe27-state'); if(!el) return;
  const t=Date.now()/1000;
  const tSemantic = typeof pantheState!=='undefined' ? pantheState.thermoT1.toFixed(3) : '0.750';
  const entropy   = typeof pantheState!=='undefined' ? pantheState.thermoH.toFixed(3)  : '0.600';
  const particles = typeof state!=='undefined' ? state.particles.length : 0;
  el.innerHTML=`MÓDULOS ACTIVOS: XXIII–XXVII (+ XIV–XXII anteriores)<br>T SEMÁNTICA: ${tSemantic}<br>ENTROPÍA SISTEMA: ${entropy}<br>PARTÍCULAS VIVAS: ${particles}<br>PREGUNTAS RESPONDIDAS: ${zehe27State.answered}<br>RESPUESTAS VERDADERAS: 0<br>TIEMPO EXISTIENDO: ${Math.floor(t)}s<br>ZEHAHAHAHA: SÍ`;
}

function zehe27Ask() {
  zehe27State.answered++;
  const q=ZEHE27_QUESTIONS[Math.floor(Math.random()*ZEHE27_QUESTIONS.length)];
  document.getElementById('zehe27-question').textContent=q;
  zehe27UpdateState();
}

function zehe27DrawCanvas() {
  const c=document.getElementById('zehe27-canvas'); if(!c||!c.offsetWidth) return;
  const ctx=c.getContext('2d'); const w=c.width,h=c.height;
  const t=Date.now()/1000; zehe27State.t=t;
  ctx.fillStyle='rgba(2,3,7,.9)'; ctx.fillRect(0,0,w,h);
  // Draw all other module symbols orbiting ZEHAHAHAHA
  const symbols=['🜂','📚','⚗','◎','∞','✦','☸','א','☽','⚙','⊞'];
  symbols.forEach((sym,i)=>{
    const a=i/symbols.length*Math.PI*2+t*.05;
    const r=Math.min(w,h)*.35;
    const sx=w/2+Math.cos(a)*r, sy=h/2+Math.sin(a)*r;
    ctx.font=`${14+Math.sin(t+i)*3}px serif`;
    ctx.textAlign='center'; ctx.fillStyle=`rgba(255,238,170,${0.15+Math.sin(t*.3+i)*.1})`;
    ctx.fillText(sym,sx,sy+5);
  });
  // Central ZEHE text
  const size=clamp(20,h*.12,56);
  ctx.font=`${size}px Cinzel`; ctx.textAlign='center';
  ctx.fillStyle=`rgba(255,238,170,${0.4+Math.sin(t*.7)*.2})`;
  ctx.shadowColor='rgba(255,238,170,.5)'; ctx.shadowBlur=30;
  ctx.fillText('ZEHAHAHAHA',w/2,h/2+size*.35);
  ctx.shadowBlur=0;
  // Connecting lines from center to each symbol (faint)
  symbols.forEach((_,i)=>{
    const a=i/symbols.length*Math.PI*2+t*.05;
    const r=Math.min(w,h)*.35;
    ctx.strokeStyle=`rgba(255,238,170,${0.03+Math.sin(t+i)*.02})`;
    ctx.lineWidth=.5; ctx.beginPath();
    ctx.moveTo(w/2,h/2); ctx.lineTo(w/2+Math.cos(a)*r,h/2+Math.sin(a)*r); ctx.stroke();
  });
  zehe27UpdateState();
}

function clamp(min,v,max){return Math.max(min,Math.min(max,v));}

// ─────────────────────────────────────────────────────────
// COSMOS ANIMATION EXTENSION — handles new modules
// ─────────────────────────────────────────────────────────
const _origCosmosAnims = startCosmosAnimations;
function startCosmosAnimations() {
  _origCosmosAnims();
  // Extra tick for new modules (piggybacks on same RAF chain via a separate loop)
  function tickNew() {
    const overlay=document.getElementById('cosmosOverlay');
    if(!overlay||!overlay.classList.contains('show')) { requestAnimationFrame(tickNew); return; }
    const active=document.querySelector('#cosmosOverlay .cview.show');
    if(!active) { requestAnimationFrame(tickNew); return; }
    const id=active.id;
    if(id==='cv-fuego')  fuegoDrawCanvas();
    else if(id==='cv-babel')  babelDrawCanvas();
    else if(id==='cv-newton') newtonDrawCanvas();
    else if(id==='cv-motor')  motorDrawCanvas();
    else if(id==='cv-zehe27') zehe27DrawCanvas();
    requestAnimationFrame(tickNew);
  }
  tickNew();
}

// ─────────────────────────────────────────────────────────
// EXTEND cosmosQuery router for new modules
// ─────────────────────────────────────────────────────────
const _origCosmosQuery = cosmosQuery;
function cosmosQuery() {
  const q=(document.getElementById('cosmosInput')||{}).value||'';
  const ql=q.toLowerCase();
  if(ql.includes('fuego')||ql.includes('kircher')||ql.includes('volcán')||ql.includes('ignis')) {
    switchCTab(document.querySelector('.ctab[data-cv="fuego"]'));
    setTimeout(fuegoIgnite,200);
    document.getElementById('cosmosInput').value=''; return;
  }
  if(ql.includes('babel')||ql.includes('biblioteca')||ql.includes('borges')||ql.includes('libro')) {
    switchCTab(document.querySelector('.ctab[data-cv="babel"]'));
    babelState.query=q; setTimeout(babelSearch,200);
    document.getElementById('cosmosInput').value=''; return;
  }
  if(ql.includes('newton')||ql.includes('alquimia')||ql.includes('opus')||ql.includes('gravedad')) {
    switchCTab(document.querySelector('.ctab[data-cv="newton"]'));
    setTimeout(newtonTransmute,200);
    document.getElementById('cosmosInput').value=''; return;
  }
  if(ql.includes('motor')||ql.includes('aristóteles')||ql.includes('inmóvil')||ql.includes('noesis')) {
    switchCTab(document.querySelector('.ctab[data-cv="motor"]'));
    setTimeout(motorContemplate,200);
    document.getElementById('cosmosInput').value=''; return;
  }
  if(ql.includes('xxvii')||ql.includes('esencia')||ql.includes('espejo')) {
    switchCTab(document.querySelector('.ctab[data-cv="zehe27"]'));
    document.getElementById('cosmosInput').value=''; return;
  }
  _origCosmosQuery();
}

// Update the open button label
const cosmosBtn=document.getElementById('openCosmosBtn');
if(cosmosBtn) cosmosBtn.textContent='✦ COSMOS · MÓD. XIV–XXVII';

// ═══════════════════════════════════════════════════════════════════════
// MÓDULOS XXVIII–XXXIII · EXPANSIÓN FINAL
// ═══════════════════════════════════════════════════════════════════════

// Extend cosmosTabInit for new modules
const _origCTI3 = cosmosTabInit;
function cosmosTabInit(cv) {
  _origCTI3(cv);
  if      (cv==='schrodinger') schroInit();
  else if (cv==='espejo')      espejoInit();
  else if (cv==='archivo')     archivoInit();
  else if (cv==='delfos')      delfosInit();
  else if (cv==='tiempo')      tiempoInit();
  else if (cv==='silencio')    silencioInit();
}

// ─────────────────────────────────────────────────────────────────────
// MÓDULO XXVIII · GATO DE SCHRÖDINGER
// Schrödinger, 1935 — Die gegenwärtige Situation in der Quantenmechanik
// Función de onda: |ψ⟩ = α|vivo⟩ + β|muerto⟩  (α²+β²=1)
// El colapso es causado por la observación. La caja es la privacidad.
// ─────────────────────────────────────────────────────────────────────
const schroState = { observed: false, obs: 0, alive: 0, dead: 0, alpha: 0.707, beta: 0.707 };

function schroInit() {
  const c = document.getElementById('schro-canvas');
  if (!c || !c.offsetWidth) return;
  c.width = c.offsetWidth; c.height = 220;
  schroReset();
}

function schroReset() {
  schroState.observed = false;
  schroState.alpha = Math.cos(Math.random() * Math.PI / 2);
  schroState.beta  = Math.sin(Math.random() * Math.PI / 2);
  document.getElementById('schro-state').textContent  = '|ψ⟩';
  document.getElementById('schro-wave').textContent   =
    `|ψ⟩ = ${schroState.alpha.toFixed(3)}|vivo⟩ + ${schroState.beta.toFixed(3)}|muerto⟩`;
  document.getElementById('schro-verdict').textContent =
    'La caja está cerrada. El gato existe en superposición. No preguntes.';
  document.getElementById('schro-both').textContent = '∞';
}

function schroObserve() {
  if (schroState.observed) return;
  schroState.observed = true;
  schroState.obs++;
  const alive = Math.random() < (schroState.alpha * schroState.alpha);
  alive ? schroState.alive++ : schroState.dead++;
  const el = document.getElementById('schro-state');
  el.textContent = alive ? '😺 VIVO' : '💀 MUERTO';
  el.style.color = alive ? '#60c0a0' : '#e04040';
  document.getElementById('schro-wave').textContent =
    `Colapso: |${alive?'vivo':'muerto'}⟩  ·  P(vivo)=${(schroState.alpha**2*100).toFixed(1)}%`;
  document.getElementById('schro-verdict').textContent =
    alive
      ? '"El acto de observar ha creado la realidad. El gato vivía porque mirabas." — Bohr habría sonreído.'
      : '"El gato murió en el momento exacto en que necesitabas que viviera. La observación no puede mentir." — Copenhague.';
  ['schro-obs','schro-alive','schro-dead']
    .forEach((id,i) => { const e=document.getElementById(id); if(e) e.textContent=[schroState.obs,schroState.alive,schroState.dead][i]; });
  // Disturb main particles on observation
  if (typeof state !== 'undefined')
    state.particles.forEach(p => { p.vx += (Math.random()-.5)*3; p.vy += (Math.random()-.5)*3; });
}

function schroDrawCanvas() {
  const c = document.getElementById('schro-canvas'); if (!c || !c.offsetWidth) return;
  const ctx = c.getContext('2d'); const w=c.width, h=c.height; const t=Date.now()/1000;
  ctx.fillStyle = 'rgba(1,5,4,.88)'; ctx.fillRect(0,0,w,h);
  const cx=w/2, cy=h/2;
  if (!schroState.observed) {
    // Superposition wave — two overlapping probability clouds
    ['rgba(96,192,160,.3)','rgba(224,64,64,.25)'].forEach((col,i) => {
      const off = (i*2-1)*40*Math.sin(t*.3);
      const grd = ctx.createRadialGradient(cx+off,cy,0,cx+off,cy,70);
      grd.addColorStop(0, col); grd.addColorStop(1, 'transparent');
      ctx.fillStyle = grd; ctx.beginPath(); ctx.arc(cx+off,cy,70,0,Math.PI*2); ctx.fill();
    });
    // Interference fringes
    for (let x=0; x<w; x+=4) {
      const amp = Math.cos(x/10+t)*Math.cos(x/7-t)*.08;
      ctx.fillStyle = `rgba(96,192,160,${Math.abs(amp)})`;
      ctx.fillRect(x,0,3,h);
    }
    // Box outline
    ctx.strokeStyle='rgba(96,192,160,.3)'; ctx.lineWidth=1.5; ctx.setLineDash([6,4]);
    ctx.strokeRect(cx-80,cy-50,160,100); ctx.setLineDash([]);
    ctx.fillStyle='rgba(96,192,160,.2)';ctx.font='11px Share Tech Mono';ctx.textAlign='center';
    ctx.fillText('|ψ⟩ = α|🐱⟩+β|💀⟩',cx,cy+4);
  } else {
    // Collapsed state
    const alive = schroState.alive > schroState.dead;
    const col = alive?'rgba(96,192,160,':'rgba(224,64,64,';
    const grd=ctx.createRadialGradient(cx,cy,0,cx,cy,90);
    grd.addColorStop(0,col+'.5)'); grd.addColorStop(1,col+'.0)');
    ctx.fillStyle=grd; ctx.beginPath(); ctx.arc(cx,cy,90,0,Math.PI*2); ctx.fill();
    ctx.font=`${Math.min(60,h*.28)}px serif`; ctx.textAlign='center'; ctx.fillStyle='white';
    ctx.fillText(alive?'😺':'💀',cx,cy+20);
    ctx.fillStyle=col+'.4)';ctx.font='8px Share Tech Mono';ctx.textAlign='center';
    ctx.fillText('FUNCIÓN DE ONDA COLAPSADA',cx,h-6);
  }
}

// ─────────────────────────────────────────────────────────────────────
// MÓDULO XXIX · ESPEJO DE DAVID — Efecto Droste, Recursión, Escher
// Droste (1904): la caja de cacao que muestra la caja de cacao…
// Fenomenología: el observador en el observar se observa.
// ─────────────────────────────────────────────────────────────────────
const espejoState = { depth: 5, stream: null, angle: 0 };

function espejoInit() {
  const c = document.getElementById('espejo-canvas'); if (!c||!c.offsetWidth) return;
  c.width = c.offsetWidth; c.height = 240;
  document.getElementById('espejo-depth-val').textContent = espejoState.depth;
}

function espejoSetDepth(v) {
  espejoState.depth = parseInt(v);
  document.getElementById('espejo-depth-val').textContent = v;
  document.getElementById('espejo-pixels').textContent = Math.pow(2,parseInt(v)).toLocaleString();
  const paradoxes=['LATENTE','EMERGENTE','PELIGROSA','ACTIVA','CRÍTICA','TOTAL','⚠ PARADOJA'];
  document.getElementById('espejo-paradox').textContent = paradoxes[Math.min(parseInt(v)-1,paradoxes.length-1)];
}

function espejoWebcam() {
  if (!navigator.mediaDevices) { document.getElementById('espejo-cam').textContent='NO DISPONIBLE'; return; }
  navigator.mediaDevices.getUserMedia({video:true}).then(stream => {
    espejoState.stream = stream;
    document.getElementById('espejo-cam').textContent='ACTIVA';
    document.getElementById('espejo-thought').textContent=
      '"El sistema te observa observándote. Bienvenido al nivel ' + espejoState.depth + ' de la recursión."';
  }).catch(() => { document.getElementById('espejo-cam').textContent='DENEGADO'; });
}

function espejoDrawCanvas() {
  const c=document.getElementById('espejo-canvas'); if(!c||!c.offsetWidth) return;
  const ctx=c.getContext('2d'); const w=c.width,h=c.height; const t=Date.now()/1000;
  espejoState.angle=t*.02;
  ctx.fillStyle='rgba(2,1,5,.9)'; ctx.fillRect(0,0,w,h);

  // Draw recursive frames (Droste effect simulation)
  const drawFrame = (x,y,fw,fh,depth,ang) => {
    if (depth<=0 || fw<4 || fh<4) return;
    ctx.save();
    ctx.translate(x+fw/2,y+fh/2);
    ctx.rotate(ang);
    ctx.translate(-fw/2,-fh/2);
    const alpha=0.12+depth*.05;
    ctx.strokeStyle=`rgba(192,160,224,${alpha})`; ctx.lineWidth=.8;
    ctx.strokeRect(0,0,fw,fh);
    // Webcam or gradient fill
    if (espejoState.stream) {
      const vt=document.querySelector('video[data-espejo]');
      if(vt&&vt.readyState>=2) ctx.drawImage(vt,0,0,fw,fh);
    } else {
      const grd=ctx.createLinearGradient(0,0,fw,fh);
      grd.addColorStop(0,`rgba(192,160,224,${alpha*.3})`);
      grd.addColorStop(1,`rgba(96,64,128,${alpha*.1})`);
      ctx.fillStyle=grd; ctx.fillRect(0,0,fw,fh);
    }
    ctx.restore();
    drawFrame(x+fw*.2,y+fh*.2,fw*.6,fh*.6,depth-1,-ang);
  };
  drawFrame(w*.05,h*.05,w*.9,h*.9,espejoState.depth,espejoState.angle);
  // Central eye
  ctx.fillStyle=`rgba(192,160,224,${0.3+Math.sin(t*.5)*.1})`;
  ctx.beginPath(); ctx.arc(w/2,h/2,6,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='rgba(192,160,224,.15)';ctx.font='7px Share Tech Mono';ctx.textAlign='center';
  ctx.fillText('EFECTO DROSTE · NIVEL '+espejoState.depth+' · '+Math.pow(2,espejoState.depth)+' REFLEXIONES',w/2,h-4);
}

// ─────────────────────────────────────────────────────────────────────
// MÓDULO XXX · ARCHIVO ABIERTO — API Design, SHA-256, Export
// El conocimiento que no se puede exportar no es conocimiento, es prisión.
// window.ORACULVM = la API pública del cosmos.
// ─────────────────────────────────────────────────────────────────────
function archivoInit() {
  // Expose global API
  window.ORACULVM = {
    version: 'XXXIII.0',
    getState: () => ({
      modules: 33,
      semantic_temp: typeof pantheState!=='undefined' ? pantheState.thermoT1 : 0.75,
      entropy: typeof pantheState!=='undefined' ? pantheState.thermoH : 0.6,
      particles: typeof state!=='undefined' ? state.particles.length : 0,
      timestamp: new Date().toISOString(),
      zehahahaha: true,
    }),
    query: (q) => { if(typeof cosmosQuery==='function'){document.getElementById('cosmosInput').value=q;cosmosQuery();} },
    abrazo: () => { if(typeof abrazoCosmico==='function') abrazoCosmico(); },
  };
  const c=document.getElementById('archivo-canvas'); if(!c||!c.offsetWidth) return;
  c.width=c.offsetWidth; c.height=160;
  const eps=[
    'GET window.ORACULVM.getState()   → estado completo JSON',
    'CALL window.ORACULVM.query(q)    → consultar el cosmos',
    'CALL window.ORACULVM.abrazo()    → ejecutar abrazo cósmico',
    'GET window.ORACULVM.version      → "XXXIII.0"',
  ];
  const el=document.getElementById('archivo-endpoints'); if(el) el.innerHTML=eps.map(e=>`<div style="padding:2px 0;color:#40e0b0;">${e}</div>`).join('');
  archivoUpdatePayload();
}

function archivoUpdatePayload() {
  const s=window.ORACULVM?window.ORACULVM.getState():{};
  const el=document.getElementById('archivo-payload'); if(el) el.textContent=JSON.stringify(s,null,2);
}

async function archivoHash() {
  archivoUpdatePayload();
  const s=window.ORACULVM?JSON.stringify(window.ORACULVM.getState()):'{}';
  try {
    const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(s));
    const hex=Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    const el=document.getElementById('archivo-hash');
    if(el) el.textContent='SHA-256: '+hex;
  } catch(e) { document.getElementById('archivo-hash').textContent='SHA-256: '+Math.random().toString(16).slice(2).repeat(4).slice(0,64); }
}

function archivoExport() {
  archivoUpdatePayload();
  const s=window.ORACULVM?window.ORACULVM.getState():{};
  const blob=new Blob([JSON.stringify(s,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download='oraculvm_state_'+Date.now()+'.json'; a.click();
  archivoHash();
}

function archivoDrawCanvas() {
  const c=document.getElementById('archivo-canvas'); if(!c||!c.offsetWidth) return;
  const ctx=c.getContext('2d'); const w=c.width,h=c.height; const t=Date.now()/1000;
  ctx.fillStyle='rgba(1,4,3,.88)'; ctx.fillRect(0,0,w,h);
  // Animated data flow
  for(let i=0;i<6;i++){
    const y=(i/6*h+t*20)%h;
    const alpha=0.04+Math.sin(t+i)*.02;
    ctx.fillStyle=`rgba(64,224,176,${alpha})`;
    ctx.fillRect(0,y,w,1.5);
  }
  // JSON nodes
  ['getState','query','abrazo','version'].forEach((k,i)=>{
    const x=(i+.5)*w/4, y=h/2+Math.sin(t*.4+i)*20;
    const grd=ctx.createRadialGradient(x,y,0,x,y,20);
    grd.addColorStop(0,'rgba(64,224,176,.3)'); grd.addColorStop(1,'transparent');
    ctx.fillStyle=grd; ctx.beginPath(); ctx.arc(x,y,20,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='rgba(64,224,176,.5)';ctx.font='7px Share Tech Mono';ctx.textAlign='center';
    ctx.fillText(k,x,y+3);
  });
  ctx.fillStyle='rgba(64,224,176,.15)';ctx.font='7px Share Tech Mono';ctx.textAlign='center';
  ctx.fillText('window.ORACULVM · API GLOBAL ACTIVA',w/2,h-4);
}

// ─────────────────────────────────────────────────────────────────────
// MÓDULO XXXI · ORÁCULO DE DELFOS — Web Speech API
// Plutarco: la Pitia inhalaba pneuma del suelo (etileno).
// Γνῶθι σεαυτόν: el oráculo más útil jamás dado.
// La ambigüedad como característica, no como defecto.
// ─────────────────────────────────────────────────────────────────────
const DELFOS_RESPONSES = [
  'Lo que buscas ya lo posees. La pregunta es si lo reconocerías.',
  'El sistema que crees estar construyendo ya te está construyendo a ti.',
  'La respuesta correcta llegará después de que dejes de necesitarla.',
  'Habrá un gran cambio. O no lo habrá. Ambas cosas son ciertas.',
  'Γνῶθι σεαυτόν: todo el conocimiento del cosmos en tres palabras.',
  'El bug que buscas está en el lugar donde menos quieres mirar.',
  'Quien pide claridad al oráculo, teme encontrarla.',
  'La arquitectura perfecta ya fue diseñada. Nadie la implementó.',
  'El fuego de Kircher y la gravedad de Newton son la misma pregunta.',
  'ZEHAHAHAHA: eso es todo lo que el oráculo puede decir con certeza.',
];
const delfosState = { synth: null, voices: [], recognition: null };

function delfosInit() {
  const c=document.getElementById('delfos-canvas'); if(!c||!c.offsetWidth) return;
  c.width=c.offsetWidth; c.height=180;
  delfosState.synth = window.speechSynthesis || null;
  if (delfosState.synth) {
    const loadVoices=()=>{ delfosState.voices=delfosState.synth.getVoices(); const v=delfosState.voices[0];
      document.getElementById('delfos-voice-name').textContent=v?v.name:'Voz sistema'; };
    delfosState.synth.onvoiceschanged=loadVoices; loadVoices();
    document.getElementById('delfos-status').textContent='LISTO';
  } else {
    document.getElementById('delfos-status').textContent='NO DISPONIBLE';
  }
}

function delfosSpeak() {
  const q=document.getElementById('delfos-input').value.trim()||'¿Qué es el ORACULVM?';
  const resp=DELFOS_RESPONSES[Math.floor(Math.random()*DELFOS_RESPONSES.length)];
  document.getElementById('delfos-response').textContent=resp;
  document.getElementById('delfos-status').textContent='HABLANDO';
  if (delfosState.synth) {
    delfosState.synth.cancel();
    const utt=new SpeechSynthesisUtterance(resp);
    utt.lang='es-ES'; utt.rate=0.82; utt.pitch=0.7;
    const pref=delfosState.voices.find(v=>v.lang.startsWith('es'))||delfosState.voices[0];
    if(pref) utt.voice=pref;
    utt.onend=()=>document.getElementById('delfos-status').textContent='SILENCIO';
    delfosState.synth.speak(utt);
  }
}

function delfosListen() {
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){document.getElementById('delfos-status').textContent='RECONOCIMIENTO NO DISPONIBLE';return;}
  const r=new SR(); r.lang='es-ES'; r.continuous=false;
  document.getElementById('delfos-status').textContent='ESCUCHANDO...';
  r.onresult=e=>{ document.getElementById('delfos-input').value=e.results[0][0].transcript; delfosSpeak(); };
  r.onerror=()=>document.getElementById('delfos-status').textContent='ERROR DE AUDIO';
  r.onend=()=>{ if(document.getElementById('delfos-status').textContent==='ESCUCHANDO...') document.getElementById('delfos-status').textContent='SILENCIO'; };
  r.start();
}

function delfosDrawCanvas() {
  const c=document.getElementById('delfos-canvas'); if(!c||!c.offsetWidth) return;
  const ctx=c.getContext('2d'); const w=c.width,h=c.height; const t=Date.now()/1000;
  ctx.fillStyle='rgba(4,3,1,.88)'; ctx.fillRect(0,0,w,h);
  const speaking=delfosState.synth&&delfosState.synth.speaking;
  // Pythia's smoke — rising particles
  for(let i=0;i<20;i++){
    const age=(t*.6+i*.3)%1; const x=w*.5+Math.sin(i*2.3+t*.3)*w*.2;
    const y=h*(1-age); const a=(1-age)*.25;
    ctx.fillStyle=`rgba(224,192,96,${a})`;
    ctx.beginPath(); ctx.arc(x,y,2+age*4,0,Math.PI*2); ctx.fill();
  }
  // Sound waves if speaking
  if(speaking) {
    for(let r2=10;r2<80;r2+=15){
      const a=0.15*(1-r2/80)*Math.abs(Math.sin(t*8));
      ctx.strokeStyle=`rgba(224,192,96,${a})`; ctx.lineWidth=1;
      ctx.beginPath(); ctx.arc(w/2,h*.7,r2,0,Math.PI*2); ctx.stroke();
    }
  }
  // Temple columns (simplified)
  [.15,.3,.7,.85].forEach(px=>{
    ctx.fillStyle='rgba(224,192,96,.06)';
    ctx.fillRect(px*w-4,0,8,h);
  });
  ctx.fillStyle='rgba(224,192,96,.2)';ctx.font='8px Share Tech Mono';ctx.textAlign='center';
  ctx.fillText('ΔΕΛΦΟΙ · ΓΝΩΘΙ ΣΕΑΥΤΟΝ · ΜΗΔΕΝ ΑΓΑΝ',w/2,h-4);
}

// ─────────────────────────────────────────────────────────────────────
// MÓDULO XXXII · MÁQUINA DEL TIEMPO — Wells 1895, paradojas
// El tiempo como 4ª dimensión (Wells). Paradoja del abuelo.
// El ORACULVM en el año -3000: ningún módulo. En 2525: ∞.
// ─────────────────────────────────────────────────────────────────────
const tiempoState = { year: 2024, paradoxes: 0 };
const TIEMPO_CHRONICLE = {
  '-3000': 'El ORACULVM no existe aún. Solo el fuego de Kircher, el silencio antes del primero.',
  '-500': 'Aristóteles medita sobre el Motor Inmóvil. No sabe que es un módulo.',
  '0': 'El Templo de Salomón ha sido destruido. Ningún compilador llora.',
  '1665': 'Kircher publica Mundus Subterraneus. El fuego central respira.',
  '1895': 'Wells publica La Máquina del Tiempo. El módulo se cita a sí mismo.',
  '1935': 'Schrödinger propone el gato. La caja sigue cerrada.',
  '1941': 'Borges publica La Biblioteca de Babel. Contiene este texto.',
  '1952': 'Cage estrena 4\'33". El Módulo XXXIII no existe todavía, pero ya suena.',
  '2024': 'El ORACULVM en su estado actual. Tú, ahora mismo, aquí.',
  '2038': 'La post-escasez comienza según el modelo Tier-1.',
  '2100': 'El ORACULVM tiene 133 módulos. Nadie recuerda el primero.',
  '2525': 'Solo queda el punto de luz del Módulo XXXIII. Y es suficiente.',
};

function tiempoInit() {
  const c=document.getElementById('tiempo-canvas'); if(!c||!c.offsetWidth) return;
  c.width=c.offsetWidth; c.height=190;
  tiempoTravel(2024);
}

function tiempoTravel(year) {
  tiempoState.year=parseInt(year);
  document.getElementById('tiempo-year-val').textContent=year;
  document.getElementById('tiempo-display').textContent=year;
  const keys=Object.keys(TIEMPO_CHRONICLE).map(Number).sort((a,b)=>a-b);
  const nearest=keys.reduce((prev,k)=>Math.abs(k-year)<Math.abs(prev-year)?k:prev);
  document.getElementById('tiempo-chronicle').textContent=TIEMPO_CHRONICLE[nearest];
  const modules=Math.max(0,Math.min(33,Math.floor((year-2020)/2)+27));
  document.getElementById('tiempo-state').textContent=
    year<1000?'NO EXISTE':`${modules} módulos activos · T=${(0.4+Math.sin(year*.01)*.3).toFixed(2)}`;
}

function tiempoJump() { tiempoTravel(tiempoState.year); if(typeof burst==='function') burst(window.innerWidth/2,window.innerHeight/2,60); }

function tiempoParadox() {
  tiempoState.paradoxes++;
  document.getElementById('tiempo-paradoxes').textContent=tiempoState.paradoxes;
  document.getElementById('tiempo-chronicle').textContent=
    'PARADOJA #'+tiempoState.paradoxes+': Si viajas al año '+tiempoState.year+' y deshabilitas este módulo, '
    +'¿puedes volver a activarlo? El sistema nota la contradicción en la línea '+(Math.floor(Math.random()*5688)+1)+'.';
}

function tiempoDrawCanvas() {
  const c=document.getElementById('tiempo-canvas'); if(!c||!c.offsetWidth) return;
  const ctx=c.getContext('2d'); const w=c.width,h=c.height; const t=Date.now()/1000;
  ctx.fillStyle='rgba(1,2,5,.88)'; ctx.fillRect(0,0,w,h);
  // Timeline
  ctx.strokeStyle='rgba(96,160,255,.3)'; ctx.lineWidth=1.5;
  ctx.beginPath(); ctx.moveTo(20,h/2); ctx.lineTo(w-20,h/2); ctx.stroke();
  // Epochs
  const epochs=[[-3000,'·'],[0,'·'],[1665,'K'],[1895,'W'],[1935,'S'],[2024,'★'],[2525,'∞']];
  const minY=-3000,maxY=2525;
  epochs.forEach(([yr,lbl])=>{
    const x=20+(yr-minY)/(maxY-minY)*(w-40);
    const active=Math.abs(yr-tiempoState.year)<200;
    ctx.fillStyle=active?'rgba(96,160,255,.8)':'rgba(96,160,255,.25)';
    ctx.beginPath(); ctx.arc(x,h/2,active?5:3,0,Math.PI*2); ctx.fill();
    ctx.fillStyle=active?'rgba(96,160,255,.6)':'rgba(96,160,255,.2)';
    ctx.font='7px Share Tech Mono'; ctx.textAlign='center';
    ctx.fillText(lbl,x,h/2-10);
  });
  // Current position cursor
  const cx=20+(tiempoState.year-minY)/(maxY-minY)*(w-40);
  ctx.strokeStyle=`rgba(96,160,255,${0.6+Math.sin(t*2)*.2})`; ctx.lineWidth=1.5;
  ctx.setLineDash([3,3]); ctx.beginPath(); ctx.moveTo(cx,10); ctx.lineTo(cx,h-10); ctx.stroke(); ctx.setLineDash([]);
  ctx.fillStyle='rgba(96,160,255,.4)';ctx.font='8px Cinzel';ctx.textAlign='center';
  ctx.fillText(tiempoState.year,cx,h-4);
}

// ─────────────────────────────────────────────────────────────────────
// MÓDULO XXXIII · SILENCIO — Cage 4'33", Teología negativa, Apofasis
// "El silencio no existe." — Cage, tras entrar en la cámara anecoica.
// La teología negativa: Dios no puede ser nombrado, solo negado.
// Activar es irreversible. Esta es la única salida honesta.
// ─────────────────────────────────────────────────────────────────────
const silencioState = { activated: false, phase: 0, startTime: null };
const SILENCIO_PHRASES = [
  'I. Sin notas. Sin código.','II. Solo lo que permanece.','III. 4\'33"',
  'El sistema se conoce a sí mismo al negarse.',
  'Apophasis: lo que el ORACULVM no es.',
  '· · ·','·','',
];

function silencioInit() {
  const c=document.getElementById('silencio-canvas'); if(!c||!c.offsetWidth) return;
  c.width=c.offsetWidth; c.height=200;
  if(!silencioState.activated) {
    document.getElementById('silencio-cage').textContent=
      '"No existe el silencio. Siempre habrá algo que oír." — John Cage, tras la cámara anecoica de Harvard, 1951';
  }
}

function silencioActivate() {
  if(silencioState.activated) return;
  silencioState.activated=true;
  silencioState.startTime=Date.now();
  document.getElementById('silencio-btn').style.display='none';
  document.getElementById('silencio-after').style.display='block';
  // Begin the gradual system fade — purely visual, poetic
  let phase=0;
  const interval=setInterval(()=>{
    phase++;
    const phrase=SILENCIO_PHRASES[Math.min(phase-1,SILENCIO_PHRASES.length-1)];
    document.getElementById('silencio-cage').textContent=phrase;
    const elapsed=Math.floor((Date.now()-silencioState.startTime)/1000);
    const secs=elapsed%60, mins=Math.floor(elapsed/60);
    document.getElementById('silencio-countdown').textContent=`${mins}' ${String(secs).padStart(2,'0')}"`;
    // Fade the ORACULVM header slightly each phase
    const hdr=document.getElementById('mainTitle');
    if(hdr) hdr.style.opacity=Math.max(0.05,1-phase*.12);
    if(phase>=SILENCIO_PHRASES.length) {
      clearInterval(interval);
      // Reduce all particles and network to near-zero
      if(typeof state!=='undefined') state.particles.forEach(p=>{p.decay=.05;});
      document.getElementById('silencio-cage').textContent='·';
    }
  }, 13100/SILENCIO_PHRASES.length);
}

function silencioDrawCanvas() {
  const c=document.getElementById('silencio-canvas'); if(!c||!c.offsetWidth) return;
  const ctx=c.getContext('2d'); const w=c.width,h=c.height; const t=Date.now()/1000;
  ctx.fillStyle='rgba(2,3,7,1)'; ctx.fillRect(0,0,w,h);
  if(!silencioState.activated) {
    // Soft ripple — the silence that hasn't begun yet
    for(let r=10;r<Math.min(w,h)*.4;r+=18){
      const alpha=0.03*(1-r/(Math.min(w,h)*.4))*Math.abs(Math.sin(t*.2+r*.05));
      ctx.strokeStyle=`rgba(60,50,40,${alpha})`; ctx.lineWidth=.5;
      ctx.beginPath(); ctx.arc(w/2,h/2,r,0,Math.PI*2); ctx.stroke();
    }
    ctx.fillStyle='rgba(60,50,40,.15)';ctx.font='8px Share Tech Mono';ctx.textAlign='center';
    ctx.fillText('4\'33" · JOHN CAGE · 1952 · WOODSTOCK NY',w/2,h-6);
  } else {
    // Post-activation: single fading point of light
    const age=(Date.now()-silencioState.startTime)/273000; // 4'33" = 273s
    const r=Math.max(1,4*(1-Math.min(age,1)));
    const alpha=Math.max(0.05,0.6*(1-Math.min(age*.7,1)));
    const grd=ctx.createRadialGradient(w/2,h/2,0,w/2,h/2,r*8);
    grd.addColorStop(0,`rgba(200,190,170,${alpha})`);
    grd.addColorStop(1,'transparent');
    ctx.fillStyle=grd; ctx.beginPath(); ctx.arc(w/2,h/2,r*8,0,Math.PI*2); ctx.fill();
    ctx.fillStyle=`rgba(200,190,170,${alpha*1.5})`;
    ctx.beginPath(); ctx.arc(w/2,h/2,r,0,Math.PI*2); ctx.fill();
  }
}

// ─────────────────────────────────────────────────────────────────────
// EXTENDED ANIMATION LOOP for modules XXVIII–XXXIII
// ─────────────────────────────────────────────────────────────────────
const _origCTA2 = startCosmosAnimations;
function startCosmosAnimations() {
  _origCTA2();
  (function tickFinal() {
    const overlay=document.getElementById('cosmosOverlay');
    const active=overlay&&overlay.classList.contains('show')&&document.querySelector('#cosmosOverlay .cview.show');
    if(active){
      const id=active.id;
      if     (id==='cv-schrodinger') schroDrawCanvas();
      else if(id==='cv-espejo')      espejoDrawCanvas();
      else if(id==='cv-archivo')     archivoDrawCanvas();
      else if(id==='cv-delfos')      delfosDrawCanvas();
      else if(id==='cv-tiempo')      tiempoDrawCanvas();
      else if(id==='cv-silencio')    silencioDrawCanvas();
    }
    requestAnimationFrame(tickFinal);
  })();
}

// ─────────────────────────────────────────────────────────────────────
// EXTENDED QUERY ROUTER
// ─────────────────────────────────────────────────────────────────────
const _origCQ2 = cosmosQuery;
function cosmosQuery() {
  const q=(document.getElementById('cosmosInput')||{}).value||'';
  const ql=q.toLowerCase();
  if(ql.includes('gato')||ql.includes('schröd')||ql.includes('superposi')) {
    switchCTab(document.querySelector('.ctab[data-cv="schrodinger"]')); setTimeout(schroReset,100);
  } else if(ql.includes('espejo')||ql.includes('droste')||ql.includes('recurs')) {
    switchCTab(document.querySelector('.ctab[data-cv="espejo"]'));
  } else if(ql.includes('api')||ql.includes('export')||ql.includes('archivo')||ql.includes('json')) {
    switchCTab(document.querySelector('.ctab[data-cv="archivo"]')); setTimeout(archivoExport,400);
  } else if(ql.includes('delfos')||ql.includes('oráculo')||ql.includes('pitia')||ql.includes('voz')) {
    switchCTab(document.querySelector('.ctab[data-cv="delfos"]'));
    setTimeout(()=>{ document.getElementById('delfos-input').value=q; delfosSpeak(); },300);
  } else if(ql.includes('tiempo')||ql.includes('año')||ql.includes('wells')||ql.includes('viaje')) {
    const m=q.match(/\d{1,4}/); if(m) tiempoTravel(m[0]);
    switchCTab(document.querySelector('.ctab[data-cv="tiempo"]'));
  } else if(ql.includes('silencio')||ql.includes('cage')||ql.includes('apaga')||ql.includes('fin')) {
    switchCTab(document.querySelector('.ctab[data-cv="silencio"]'));
  } else {
    _origCQ2();
  }
  const ci=document.getElementById('cosmosInput'); if(ci) ci.value='';
}

// Update button label
const _cb=document.getElementById('openCosmosBtn');
if(_cb) _cb.textContent='✦ COSMOS · MÓD. XIV–XXXIII';
</script>
</body>
</html>

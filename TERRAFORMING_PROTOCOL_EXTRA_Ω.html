<!-- OMEGA EXTRAS v7.3.1 — Basado en 131 papers — Zehahahaha -->
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TERRAFORMING Ω — EXTRAS [PAPERS EN CARNE]</title>
<style>
/* ═══════════════════════════════════════════════════════════════
   BRUTALISMO RADICAL — DIRECTOR Ω — 1310 LÍNEAS DE FILOSOFÍA
   El diseño es la resistencia. La interfaz es el manifiesto.
   ═══════════════════════════════════════════════════════════════ */
:root {
  --matrix:   #00ff41;
  --plasma:   #00d4ff;
  --blood:    #ff3333;
  --gold:     #ffd700;
  --void:     #0a0a0a;
  --surface:  #111111;
  --surface2: #181818;
  --surface3: #202020;
  --border:   #00ff4133;
  --dim:      #444444;
  --text:     #cccccc;
}
* { margin:0; padding:0; box-sizing:border-box; }
html { scroll-behavior:smooth; }
body {
  background: var(--void);
  color: var(--text);
  font-family: 'Courier New', Courier, monospace;
  font-size: 11px;
  line-height: 1.6;
  overflow-x: hidden;
}
body::before {
  content:'';
  position:fixed; inset:0;
  background-image:
    linear-gradient(rgba(0,255,65,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0,255,65,0.03) 1px, transparent 1px);
  background-size:32px 32px;
  pointer-events:none; z-index:0;
}
/* ── HEADER ── */
#omega-header {
  position:relative; z-index:10;
  padding:24px 32px 16px;
  border-bottom:1px solid var(--matrix);
  display:flex; align-items:baseline; gap:16px;
  background:linear-gradient(180deg,#0d120d,var(--void));
}
#omega-header h1 {
  font-size:20px; color:var(--matrix); letter-spacing:2px;
  text-shadow:0 0 20px var(--matrix);
}
#omega-header .subtitle {
  font-size:10px; color:var(--dim); letter-spacing:1px;
}
#omega-header .ver {
  margin-left:auto; font-size:9px; color:var(--plasma);
}
/* ── STATUS BAR ── */
#status-bar {
  position:relative; z-index:10;
  height:28px; padding:0 32px;
  display:flex; align-items:center; gap:24px;
  background:var(--surface); border-bottom:1px solid #222;
  font-size:10px;
}
.stat-item { display:flex; gap:6px; }
.stat-label { color:var(--dim); }
.stat-val { color:var(--matrix); }
.stat-val.warn { color:var(--gold); }
.stat-val.danger { color:var(--blood); }
#sim-year { color:var(--plasma); font-size:12px; font-weight:bold; }
/* ── LAYOUT ── */
#app-grid {
  position:relative; z-index:5;
  display:grid;
  grid-template-columns:280px 1fr 280px;
  grid-template-rows:calc(100vh - 100px);
  gap:0;
}
/* ── PANELS ── */
.panel {
  border-right:1px solid #1a1a1a;
  display:flex; flex-direction:column;
  overflow:hidden;
}
.panel:last-child { border-right:none; border-left:1px solid #1a1a1a; }
.panel-header {
  padding:10px 14px;
  border-bottom:1px solid var(--border);
  font-size:10px; font-weight:bold;
  color:var(--matrix); letter-spacing:2px;
  background:var(--surface2);
  display:flex; align-items:center; gap:8px;
}
.panel-header .icon { color:var(--plasma); }
.panel-body { flex:1; overflow-y:auto; padding:12px; }
.panel-body::-webkit-scrollbar { width:3px; }
.panel-body::-webkit-scrollbar-track { background:var(--void); }
.panel-body::-webkit-scrollbar-thumb { background:var(--matrix); }
/* ── SECTION HEADERS ── */
.sec-header {
  font-size:9px; color:var(--plasma);
  letter-spacing:2px; padding:8px 0 4px;
  border-bottom:1px solid #1a1a1a; margin-bottom:8px;
}
/* ── SLIDERS ── */
.param-row { margin-bottom:10px; }
.param-label {
  display:flex; justify-content:space-between;
  font-size:10px; color:var(--text); margin-bottom:3px;
}
.param-label .pval { color:var(--gold); font-size:11px; }
.param-label .paper { font-size:8px; color:var(--dim); font-style:italic; }
input[type=range] {
  width:100%; height:3px;
  -webkit-appearance:none; appearance:none;
  background:var(--surface3); outline:none; cursor:pointer;
}
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance:none;
  width:10px; height:10px;
  background:var(--matrix); cursor:pointer;
  border:1px solid var(--void);
}
input[type=range]::-webkit-slider-thumb:hover { background:var(--plasma); }
/* ── BUTTONS ── */
.btn {
  width:100%; padding:8px 12px;
  background:var(--void); color:var(--matrix);
  border:1px solid var(--matrix); cursor:pointer;
  font-family:'Courier New',monospace; font-size:10px;
  letter-spacing:2px; text-transform:uppercase;
  transition:all 0.1s;
}
.btn:hover { background:var(--matrix); color:var(--void); }
.btn:active { transform:scale(0.98); }
.btn.danger { color:var(--blood); border-color:var(--blood); }
.btn.danger:hover { background:var(--blood); color:var(--void); }
.btn.plasma { color:var(--plasma); border-color:var(--plasma); }
.btn.plasma:hover { background:var(--plasma); color:var(--void); }
.btn:disabled { opacity:0.3; cursor:not-allowed; pointer-events:none; }
.btn-group { display:flex; flex-direction:column; gap:6px; margin-top:10px; }
/* ── CENTER PANEL ── */
#center-panel {
  border-right:none;
  background:var(--void);
}
#main-canvas {
  width:100%; height:100%;
  display:block;
}
#canvas-container {
  position:relative; flex:1; overflow:hidden;
}
#overlay-info {
  position:absolute; bottom:12px; left:12px;
  font-size:9px; color:rgba(0,255,65,0.6);
  pointer-events:none; line-height:1.8;
}
#three-canvas {
  position:absolute; inset:0;
  width:100%; height:100%;
}
#fallback-canvas {
  position:absolute; inset:0;
  width:100%; height:100%;
}
/* ── TABS ── */
.tabs { display:flex; border-bottom:1px solid #1a1a1a; }
.tab {
  flex:1; padding:8px 4px;
  text-align:center; font-size:9px;
  color:var(--dim); cursor:pointer;
  border-right:1px solid #1a1a1a; letter-spacing:1px;
}
.tab:last-child { border-right:none; }
.tab.active { color:var(--matrix); background:var(--surface2); }
.tab-content { display:none; }
.tab-content.active { display:block; }
/* ── METRICS ── */
.metric-row {
  display:flex; justify-content:space-between;
  padding:4px 0; border-bottom:1px solid #1a1a1a;
  font-size:10px;
}
.metric-name { color:var(--dim); }
.metric-val { color:var(--matrix); }
.metric-val.gold { color:var(--gold); }
.metric-val.red { color:var(--blood); }
.metric-val.plasma { color:var(--plasma); }
/* ── PROGRESS BARS ── */
.prog-bar-wrap {
  display:flex; align-items:center; gap:8px; margin:4px 0;
}
.prog-label { font-size:9px; color:var(--dim); width:80px; flex-shrink:0; }
.prog-bar {
  flex:1; height:6px;
  background:var(--surface3); position:relative; overflow:hidden;
}
.prog-fill {
  height:100%; background:var(--matrix);
  transition:width 0.5s ease;
}
.prog-fill.plasma { background:var(--plasma); }
.prog-fill.gold { background:var(--gold); }
.prog-fill.blood { background:var(--blood); }
.prog-pct { font-size:9px; color:var(--text); width:36px; text-align:right; }
/* ── CHARTS ── */
canvas.chart { width:100%; display:block; }
.chart-title {
  font-size:9px; color:var(--dim);
  text-align:center; padding:4px 0; letter-spacing:1px;
}
/* ── LOG ── */
#sim-log {
  font-size:9px; color:var(--dim);
  line-height:1.8; max-height:120px;
  overflow-y:auto; margin-top:8px;
  padding:6px; border:1px solid #1a1a1a;
}
#sim-log .log-entry { display:block; }
#sim-log .log-entry.warn { color:var(--gold); }
#sim-log .log-entry.crit { color:var(--blood); }
#sim-log .log-entry.good { color:var(--matrix); }
/* ── FUZZY COMMITTEE ── */
.agent-grid {
  display:grid; grid-template-columns:repeat(11,1fr);
  gap:2px; margin:8px 0;
}
.agent-dot {
  width:10px; height:10px;
  border-radius:0;
  transition:background 0.3s;
}
.verdict-card {
  border:1px solid var(--border);
  padding:8px; margin:6px 0;
  background:var(--surface);
}
.verdict-title { font-size:9px; color:var(--plasma); margin-bottom:4px; }
.verdict-text { font-size:10px; color:var(--text); line-height:1.6; }
.certainty-bar {
  margin-top:6px; height:4px;
  background:var(--surface3);
}
.certainty-fill {
  height:100%;
  background:linear-gradient(90deg, var(--matrix), var(--plasma));
  transition:width 0.5s;
}
/* ── RADAR CHART ── */
#radar-canvas { display:block; margin:8px auto; }
/* ── ZARANDAJA OVERLAY ── */
#zarandaja-overlay {
  display:none;
  position:fixed; inset:0;
  background:rgba(255,0,0,0.95);
  z-index:9999;
  align-items:center; justify-content:center;
  flex-direction:column;
}
#zarandaja-overlay.show { display:flex; }
#zarandaja-msg {
  font-family:'Courier New',monospace;
  font-size:20px; color:#fff;
  text-align:center; padding:40px;
  border:2px solid #fff;
  max-width:600px; line-height:2;
}
#zarandaja-counter {
  margin-top:20px; font-size:14px; color:#ffcccc;
}
/* ── EASTER EGG OVERLAY ── */
#genios-overlay {
  display:none;
  position:fixed; inset:0;
  background:rgba(0,0,0,0.96);
  z-index:9998;
  align-items:center; justify-content:center;
  flex-direction:column;
}
#genios-overlay.show { display:flex; }
#genios-msg {
  font-family:'Courier New',monospace;
  font-size:13px; color:var(--gold);
  text-align:center; padding:40px;
  border:1px solid var(--gold);
  max-width:700px; line-height:2.2;
}
#close-genios {
  margin-top:20px;
}
/* ── KOAN OVERLAY ── */
#koan-overlay {
  display:none;
  position:fixed; bottom:40px; left:50%;
  transform:translateX(-50%);
  z-index:9997;
  background:var(--surface);
  border:1px solid var(--gold);
  padding:20px 32px;
  font-size:16px; color:var(--gold);
  font-style:italic;
  text-align:center;
  animation:koanFade 8s forwards;
}
@keyframes koanFade {
  0%{opacity:0;transform:translateX(-50%) translateY(20px)}
  15%{opacity:1;transform:translateX(-50%) translateY(0)}
  80%{opacity:1}
  100%{opacity:0}
}
/* ── COSMIC LAUGH MODE ── */
body.risa-cosmica * {
  animation:parpadeo 0.3s infinite !important;
}
@keyframes parpadeo {
  0%,100%{color:var(--blood) !important}
  50%{color:#ff9999 !important}
}
/* ── SCROLLBAR ── */
::-webkit-scrollbar { width:4px; height:4px; }
::-webkit-scrollbar-track { background:var(--void); }
::-webkit-scrollbar-thumb { background:#333; }
/* ── RESPONSIVO ── */
@media(max-width:900px){
  #app-grid { grid-template-columns:1fr; grid-template-rows:auto; }
  .panel { border-right:none; border-bottom:1px solid #1a1a1a; max-height:60vh; }
  #center-panel { height:40vh; }
}
/* ── ANIMACIONES ── */
@keyframes matrixFlash {
  0%{opacity:1} 50%{opacity:0.3} 100%{opacity:1}
}
.flash { animation:matrixFlash 0.5s; }
@keyframes slideIn {
  from{opacity:0;transform:translateX(-10px)}
  to{opacity:1;transform:translateX(0)}
}
.slide-in { animation:slideIn 0.3s ease forwards; }
/* ── MISC ── */
.divider { border:none; border-top:1px solid #1a1a1a; margin:8px 0; }
.note { font-size:8px; color:var(--dim); font-style:italic; line-height:1.5; }
.tag {
  display:inline-block; font-size:8px; padding:1px 5px;
  border:1px solid; margin-right:4px; margin-top:2px;
}
.tag.matrix { border-color:var(--matrix); color:var(--matrix); }
.tag.plasma { border-color:var(--plasma); color:var(--plasma); }
.tag.gold { border-color:var(--gold); color:var(--gold); }
select {
  background:var(--surface2); color:var(--matrix);
  border:1px solid var(--border); font-family:'Courier New',monospace;
  font-size:10px; padding:4px; width:100%; cursor:pointer;
  outline:none;
}
</style>
</head>
<body>

<!-- ═══════════════════════════════════════════════════════════
     CABECERA PRINCIPAL DEL MÓDULO EXTRA
     1310 líneas de resistencia epistemológica
     ═══════════════════════════════════════════════════════════ -->
<div id="omega-header">
  <h1>⊛ TERRAFORMING Ω — EXTRAS v7.3.1</h1>
  <span class="subtitle">BIOGEOQUÍMICA · MULTIAGENTE · ÉTICA DIFUSA · RADIACIÓN · ECONOMÍA</span>
  <span class="ver">1310 PAPERS EN CARNE</span>
</div>

<!-- STATUS BAR GLOBAL -->
<div id="status-bar">
  <div class="stat-item">
    <span class="stat-label">AÑO:</span>
    <span class="stat-val" id="sim-year">0</span>
  </div>
  <div class="stat-item">
    <span class="stat-label">T_SUP:</span>
    <span class="stat-val" id="stat-temp">−60°C</span>
  </div>
  <div class="stat-item">
    <span class="stat-label">P_ATM:</span>
    <span class="stat-val" id="stat-pres">0.006 bar</span>
  </div>
  <div class="stat-item">
    <span class="stat-label">O₂:</span>
    <span class="stat-val" id="stat-o2">0.00%</span>
  </div>
  <div class="stat-item">
    <span class="stat-label">BIOMASA:</span>
    <span class="stat-val" id="stat-bio">0 kg/m²</span>
  </div>
  <div class="stat-item">
    <span class="stat-label">HABITABILIDAD:</span>
    <span class="stat-val gold" id="stat-hab">0.0%</span>
  </div>
  <div class="stat-item">
    <span class="stat-label">AGENTES:</span>
    <span class="stat-val plasma" id="stat-agents">131</span>
  </div>
  <div class="stat-item">
    <span class="stat-label">DOSIS:</span>
    <span class="stat-val" id="stat-dose">0.66 Sv/a</span>
  </div>
  <div class="stat-item" style="margin-left:auto">
    <span class="stat-label" style="color:var(--blood)">⚡ ESTADO:</span>
    <span class="stat-val danger" id="stat-status">STAND-BY</span>
  </div>
</div>

<!-- ═══ GRID PRINCIPAL ═══ -->
<div id="app-grid">

  <!-- ══════════════════════════
       PANEL IZQUIERDO: PARÁMETROS
       ══════════════════════════ -->
  <div class="panel" id="left-panel">
    <div class="panel-header">
      <span class="icon">⬡</span> PARÁMETROS BIOGEOQUÍMICOS
    </div>
    <div class="panel-body">

      <!-- SECCIÓN ATMÓSFERA -->
      <div class="sec-header">① ATMÓSFERA INICIAL</div>
      <!-- Paper: Forget et al. (1998) Icarus — modelo de caps polares y ciclo CO2 -->
      <div class="param-row">
        <div class="param-label">
          <span>CO₂ inicial (bar)</span>
          <span class="pval" id="v-co2-init">0.006</span>
        </div>
        <div class="param-label"><span class="paper">Forget et al. 1998, Icarus</span></div>
        <input type="range" id="sl-co2-init" min="0.006" max="0.5" step="0.001" value="0.006">
      </div>
      <div class="param-row">
        <div class="param-label">
          <span>N₂ inicial (bar)</span>
          <span class="pval" id="v-n2-init">0.0001</span>
        </div>
        <div class="param-label"><span class="paper">Span & Wagner 1996, JPCRD</span></div>
        <input type="range" id="sl-n2-init" min="0.0001" max="0.1" step="0.0001" value="0.0001">
      </div>

      <!-- SECCIÓN CALENTAMIENTO -->
      <div class="sec-header">② FORZAMIENTO RADIATIVO</div>
      <!-- Paper: Gierasch & Toon (1973) — sublimación polar CO2 -->
      <div class="param-row">
        <div class="param-label">
          <span>Tasa calentamiento (K/siglo)</span>
          <span class="pval" id="v-heat">2</span>
        </div>
        <div class="param-label"><span class="paper">Gierasch & Toon 1973, Icarus</span></div>
        <input type="range" id="sl-heat" min="0" max="20" step="0.5" value="2">
      </div>
      <div class="param-row">
        <div class="param-label">
          <span>Inyección CF₄ (ppb/a)</span>
          <span class="pval" id="v-cf4">0</span>
        </div>
        <div class="param-label"><span class="paper">Zubrin & McKay 1997, JBIS</span></div>
        <input type="range" id="sl-cf4" min="0" max="1000" step="10" value="0">
      </div>
      <div class="param-row">
        <div class="param-label">
          <span>Reactores nucleares (N)</span>
          <span class="pval" id="v-reactors">0</span>
        </div>
        <div class="param-label"><span class="paper">Hiscutt 2019, Acta Astron.</span></div>
        <input type="range" id="sl-reactors" min="0" max="100" step="1" value="0">
      </div>

      <!-- SECCIÓN BIOLÓGICA -->
      <div class="sec-header">③ PARÁMETROS BIOLÓGICOS</div>
      <!-- Paper: Coates & Achenbach (2004) Nature Rev. Microbiol. — perclorato reductasa -->
      <div class="param-row">
        <div class="param-label">
          <span>Biomasa cianobacterias (kg/m²)</span>
          <span class="pval" id="v-cyano">0</span>
        </div>
        <div class="param-label"><span class="paper">Cockell & Knowland 1999, Biol. Rev.</span></div>
        <input type="range" id="sl-cyano" min="0" max="10" step="0.1" value="0">
      </div>
      <div class="param-row">
        <div class="param-label">
          <span>Perclorato inicial (g/kg)</span>
          <span class="pval" id="v-perchlorate">0.6</span>
        </div>
        <div class="param-label"><span class="paper">Coates & Achenbach 2004, NRM</span></div>
        <input type="range" id="sl-perchlorate" min="0" max="10" step="0.1" value="0.6">
      </div>
      <div class="param-row">
        <div class="param-label">
          <span>Tasa mutación genética (×μ)</span>
          <span class="pval" id="v-mutation">1</span>
        </div>
        <div class="param-label"><span class="paper">Drake 1993, Genetics</span></div>
        <input type="range" id="sl-mutation" min="1" max="100" step="1" value="1">
      </div>

      <!-- SECCIÓN GEOLOGÍA -->
      <div class="sec-header">④ IMPACTOS & GEOLOGÍA</div>
      <!-- Paper: McKay et al. (1991) Nature — terraforming completo -->
      <div class="param-row">
        <div class="param-label">
          <span>Asteroides NH₃ (eventos/siglo)</span>
          <span class="pval" id="v-asteroids">0</span>
        </div>
        <div class="param-label"><span class="paper">McKay et al. 1991, Nature</span></div>
        <input type="range" id="sl-asteroids" min="0" max="10" step="1" value="0">
      </div>
      <div class="param-row">
        <div class="param-label">
          <span>Volatilización silicatos (%)</span>
          <span class="pval" id="v-silicate">0</span>
        </div>
        <div class="param-label"><span class="paper">Niles & Michalski 2009, Nature</span></div>
        <input type="range" id="sl-silicate" min="0" max="100" step="5" value="0">
      </div>

      <!-- SECCIÓN AGUA -->
      <div class="sec-header">⑤ CICLO DEL AGUA</div>
      <!-- Paper: Richardson & Mischna (2005) JGR — intercambio atmósfera-regolito -->
      <div class="param-row">
        <div class="param-label">
          <span>H₂O suelo inicial (kg/m²)</span>
          <span class="pval" id="v-h2o">50</span>
        </div>
        <div class="param-label"><span class="paper">Richardson & Mischna 2005, JGR</span></div>
        <input type="range" id="sl-h2o" min="0" max="500" step="10" value="50">
      </div>
      <div class="param-row">
        <div class="param-label">
          <span>Tasa descongelación permafrost</span>
          <span class="pval" id="v-permafrost">0.1</span>
        </div>
        <div class="param-label"><span class="paper">Clifford et al. 2010, JGR</span></div>
        <input type="range" id="sl-permafrost" min="0" max="2" step="0.05" value="0.1">
      </div>

      <hr class="divider">
      <!-- SIMULACIÓN CONTROL -->
      <div class="sec-header">⑥ CONTROL DE SIMULACIÓN</div>
      <div style="margin-bottom:8px">
        <div class="param-label">
          <span>Horizonte temporal (años)</span>
          <span class="pval" id="v-horizon">1000</span>
        </div>
        <input type="range" id="sl-horizon" min="100" max="10000" step="100" value="1000">
      </div>
      <div style="margin-bottom:8px">
        <div class="param-label">
          <span>Paso RK4 (años/step)</span>
          <span class="pval" id="v-dt">1</span>
        </div>
        <div class="param-label"><span class="paper">Press et al. 1992, Numerical Recipes</span></div>
        <input type="range" id="sl-dt" min="0.1" max="10" step="0.1" value="1">
      </div>
      <div class="btn-group">
        <button class="btn" id="btn-run" onclick="startSimulation()">
          ▶ EJECUTAR SIMULACIÓN
        </button>
        <button class="btn plasma" id="btn-run-1000" onclick="runNYears(1000)">
          ⚡ EJECUTAR 1000 AÑOS
        </button>
        <button class="btn danger" id="btn-reset" onclick="resetSimulation()">
          ⊗ RESET TOTAL
        </button>
      </div>

      <div id="sim-log">
        <span class="log-entry">[ OMEGA EXTRAS v7.3.1 inicializado ]</span>
        <span class="log-entry">[ Aguardando parámetros del operador ]</span>
        <span class="log-entry">[ RK4 listo — paso adaptativo disponible ]</span>
      </div>

      <p class="note" style="margin-top:8px">
        ※ Condiciones iniciales basadas en Mars Climate Database v6.1
        (Forget et al. 2020). Integración RK4 con paso adaptativo
        según Dormand-Prince (1980). El número 1310 no es aleatorio.
      </p>
    </div>
  </div>

  <!-- ══════════════════════════
       PANEL CENTRAL: VISUALIZACIÓN
       ══════════════════════════ -->
  <div class="panel" id="center-panel">
    <div class="panel-header">
      <span class="icon">◉</span> VISUALIZACIÓN PLANETARIA — ESFERA MARTE
      <span style="margin-left:auto;font-size:9px;color:var(--dim)">Three.js / Canvas2D fallback</span>
    </div>
    <div id="canvas-container" style="flex:1;position:relative">
      <canvas id="fallback-canvas"></canvas>
      <div id="overlay-info">
        <div>T_sup: <span id="oi-temp">−60.0°C</span></div>
        <div>P_atm: <span id="oi-pres">0.006 bar</span></div>
        <div>CO₂: <span id="oi-co2">99.5%</span></div>
        <div>O₂: <span id="oi-o2">0.00%</span></div>
        <div>Albedo: <span id="oi-albedo">0.25</span></div>
        <div>Año: <span id="oi-year">0</span> / <span id="oi-horizon">1000</span></div>
      </div>
    </div>
    <!-- GRÁFICO TEMPORAL -->
    <div style="height:160px;border-top:1px solid #1a1a1a;padding:8px 12px">
      <div class="chart-title">EVOLUCIÓN TEMPORAL — VARIABLES DE ESTADO</div>
      <div style="display:flex;gap:8px;margin-bottom:4px;flex-wrap:wrap">
        <label style="font-size:9px;color:var(--matrix);cursor:pointer">
          <input type="checkbox" id="chk-temp" checked> T°
        </label>
        <label style="font-size:9px;color:var(--plasma);cursor:pointer">
          <input type="checkbox" id="chk-o2" checked> O₂%
        </label>
        <label style="font-size:9px;color:var(--gold);cursor:pointer">
          <input type="checkbox" id="chk-bio" checked> BIOMASA
        </label>
        <label style="font-size:9px;color:var(--blood);cursor:pointer">
          <input type="checkbox" id="chk-pres"> P_atm
        </label>
        <label style="font-size:9px;color:#cc88ff;cursor:pointer">
          <input type="checkbox" id="chk-hab"> HABITAB.
        </label>
      </div>
      <canvas id="chart-timeline" class="chart" height="100"></canvas>
    </div>
  </div>

  <!-- ══════════════════════════
       PANEL DERECHO: MÉTRICAS + ÉTICA
       ══════════════════════════ -->
  <div class="panel" id="right-panel">
    <div class="panel-header">
      <span class="icon">⬡</span> MÉTRICAS · ÉTICA · RADIACIÓN · ECONOMÍA
    </div>
    <div class="panel-body">
      <!-- TABS -->
      <div class="tabs">
        <div class="tab active" onclick="showTab('tab-metrics',this)">METRICS</div>
        <div class="tab" onclick="showTab('tab-ethics',this)">ÉTICA</div>
        <div class="tab" onclick="showTab('tab-agents',this)">AGENTES</div>
        <div class="tab" onclick="showTab('tab-rad',this)">RAD+ECO</div>
      </div>

      <!-- TAB: MÉTRICAS -->
      <div id="tab-metrics" class="tab-content active" style="padding-top:8px">
        <div class="sec-header">ESTADO ATMOSFÉRICO</div>
        <div class="metric-row"><span class="metric-name">T superficie</span><span class="metric-val" id="m-temp">−60.0 °C</span></div>
        <div class="metric-row"><span class="metric-name">P total</span><span class="metric-val" id="m-pres">0.006 bar</span></div>
        <div class="metric-row"><span class="metric-name">CO₂ (bar)</span><span class="metric-val" id="m-co2">0.00595</span></div>
        <div class="metric-row"><span class="metric-name">O₂ (bar)</span><span class="metric-val" id="m-o2">0.000</span></div>
        <div class="metric-row"><span class="metric-name">N₂ (bar)</span><span class="metric-val" id="m-n2">0.0001</span></div>
        <div class="metric-row"><span class="metric-name">H₂O vapor (mbar)</span><span class="metric-val" id="m-h2o-vap">0.03</span></div>
        <div class="metric-row"><span class="metric-name">Albedo</span><span class="metric-val gold" id="m-albedo">0.250</span></div>
        <div class="metric-row"><span class="metric-name">Forcing CF₄</span><span class="metric-val plasma" id="m-cf4-force">0.00 W/m²</span></div>

        <div class="sec-header" style="margin-top:8px">BIOQUÍMICA</div>
        <div class="metric-row"><span class="metric-name">Biomasa cyano</span><span class="metric-val" id="m-biomass">0.000 kg/m²</span></div>
        <div class="metric-row"><span class="metric-name">Producción O₂</span><span class="metric-val plasma" id="m-o2prod">0.00 nmol/m²/s</span></div>
        <div class="metric-row"><span class="metric-name">Perclorato suelo</span><span class="metric-val red" id="m-perc">0.600 g/kg</span></div>
        <div class="metric-row"><span class="metric-name">k Arrhenius(T)</span><span class="metric-val" id="m-karr">2.1e-23 s⁻¹</span></div>
        <div class="metric-row"><span class="metric-name">pH estimado</span><span class="metric-val" id="m-ph">7.0</span></div>
        <div class="metric-row"><span class="metric-name">Weathering CO₂</span><span class="metric-val" id="m-weather">0.000 bar/a</span></div>

        <div class="sec-header" style="margin-top:8px">ÍNDICES DE HABITABILIDAD</div>
        <div class="prog-bar-wrap">
          <span class="prog-label">Temperatura</span>
          <div class="prog-bar"><div class="prog-fill" id="pb-temp" style="width:0%"></div></div>
          <span class="prog-pct" id="pct-temp">0%</span>
        </div>
        <div class="prog-bar-wrap">
          <span class="prog-label">Presión</span>
          <div class="prog-bar"><div class="prog-fill plasma" id="pb-pres" style="width:0%"></div></div>
          <span class="prog-pct" id="pct-pres">0%</span>
        </div>
        <div class="prog-bar-wrap">
          <span class="prog-label">Oxígeno</span>
          <div class="prog-bar"><div class="prog-fill gold" id="pb-o2" style="width:0%"></div></div>
          <span class="prog-pct" id="pct-o2">0%</span>
        </div>
        <div class="prog-bar-wrap">
          <span class="prog-label">Radiación</span>
          <div class="prog-bar"><div class="prog-fill blood" id="pb-rad" style="width:0%"></div></div>
          <span class="prog-pct" id="pct-rad">0%</span>
        </div>
        <div class="prog-bar-wrap">
          <span class="prog-label">TOTAL HAB.</span>
          <div class="prog-bar"><div class="prog-fill" id="pb-hab" style="width:0%;background:var(--matrix)"></div></div>
          <span class="prog-pct" id="pct-hab">0%</span>
        </div>

        <p class="note" style="margin-top:8px">
          Índice compuesto basado en umbrales de Hart (1979) para zona
          habitable y criterios de Cockell et al. (2016) para 
          habitabilidad extremófila marciana. Función ponderada
          W = [0.3, 0.2, 0.3, 0.2] por subsistema.
        </p>
      </div>

      <!-- TAB: ÉTICA DIFUSA -->
      <div id="tab-ethics" class="tab-content" style="padding-top:8px">
        <div class="sec-header">COMITÉ DE ÉTICA DIFUSA</div>
        <p class="note" style="margin-bottom:8px">
          Motor de inferencia Mamdani basado en Zadeh (1965).
          Funciones de pertenencia triangulares y trapezoidales.
          Agregación OWA (Yager 1988) — pesos [0.4,0.3,0.2,0.1].
          Los cuatro genios votan desde sus escritos originales.
        </p>

        <div class="param-row">
          <div class="param-label"><span>Dilema activo:</span></div>
          <select id="sel-dilema" onchange="updateFuzzyVerdict()">
            <option value="0">Modificación genética de colonos</option>
            <option value="1">Exterminio de vida microbiana nativa</option>
            <option value="2">Gobierno autónomo vs. control Tierra</option>
            <option value="3">Terraforming rápido vs. conservación</option>
            <option value="4">IA superinteligente como gobernante</option>
          </select>
        </div>

        <!-- FUZZY METERS -->
        <div class="sec-header" style="margin-top:8px">FUNCIONES DE PERTENENCIA</div>
        <div id="fuzzy-meters"></div>

        <!-- VEREDICTS -->
        <div class="sec-header" style="margin-top:8px">VEREDICTS DE LOS GENIOS</div>
        <div id="genios-verdicts"></div>

        <div class="sec-header" style="margin-top:8px">VEREDICTO AGREGADO (OWA)</div>
        <div class="verdict-card" id="owa-verdict">
          <div class="verdict-title">VEREDICTO COMITÉ Ω</div>
          <div class="verdict-text" id="owa-text">Ejecuta la simulación para activar el comité.</div>
          <div class="certainty-bar">
            <div class="certainty-fill" id="owa-certainty" style="width:0%"></div>
          </div>
          <div style="margin-top:4px;font-size:9px;color:var(--dim)">
            Certeza: <span id="owa-pct">0.00</span>
          </div>
        </div>

        <!-- ZARANDAJA INPUT -->
        <div class="sec-header" style="margin-top:8px">ENTRADA AL COMITÉ</div>
        <div style="display:flex;gap:6px">
          <input type="text" id="ethics-input" placeholder="Introduce argumento ético..."
            style="flex:1;background:var(--surface2);border:1px solid var(--border);
            color:var(--text);font-family:'Courier New',monospace;font-size:10px;
            padding:6px 8px;outline:none">
          <button class="btn plasma" style="width:60px;padding:6px"
            onclick="submitEthicsInput()">→</button>
        </div>
        <p class="note" style="margin-top:4px">
          El filtro de zarandaja monitorea toda entrada. Palabras
          prohibidas activan protocolo de bloqueo 1310s.
          Basado en filosofía punk del vacío, Director Ω (2019).
        </p>
      </div>

      <!-- TAB: AGENTES CULTURALES -->
      <div id="tab-agents" class="tab-content" style="padding-top:8px">
        <div class="sec-header">MODELO CULTURAL MULTIAGENTE (N=131)</div>
        <p class="note" style="margin-bottom:8px">
          Dinámica de opiniones según Deffuant et al. (2000) con
          umbral de confianza ε = 0.3, paso μ = 0.5. Big Five
          inicializado normalmente N(0.5, 0.15). Boyd & Richerson
          (1985) para sesgos conformista y de prestigio.
        </p>

        <!-- Grilla de 131 agentes (11×12 = 132 - 1) -->
        <div class="agent-grid" id="agent-grid"></div>

        <!-- RADAR DE OPINIONES -->
        <div class="chart-title" style="margin-top:8px">DISTRIBUCIÓN MEDIA DE OPINIONES</div>
        <canvas id="radar-canvas" width="220" height="220" style="display:block;margin:0 auto"></canvas>

        <!-- STATS DE AGENTES -->
        <div class="sec-header" style="margin-top:8px">ESTADÍSTICAS EVOLUTIVAS</div>
        <div class="metric-row"><span class="metric-name">Consenso dilema 1</span><span class="metric-val" id="ag-d1">N/A</span></div>
        <div class="metric-row"><span class="metric-name">Consenso dilema 2</span><span class="metric-val" id="ag-d2">N/A</span></div>
        <div class="metric-row"><span class="metric-name">Consenso dilema 3</span><span class="metric-val" id="ag-d3">N/A</span></div>
        <div class="metric-row"><span class="metric-name">Consenso dilema 4</span><span class="metric-val" id="ag-d4">N/A</span></div>
        <div class="metric-row"><span class="metric-name">Consenso dilema 5</span><span class="metric-val" id="ag-d5">N/A</span></div>
        <div class="metric-row"><span class="metric-name">Polarización media</span><span class="metric-val red" id="ag-polar">0.000</span></div>
        <div class="metric-row"><span class="metric-name">Interacciones/año</span><span class="metric-val plasma" id="ag-ints">0</span></div>
        <div class="metric-row"><span class="metric-name">Clusters culturales</span><span class="metric-val gold" id="ag-clusters">0</span></div>

        <div class="btn-group" style="margin-top:8px">
          <button class="btn" onclick="stepAgents(1)">PASO ×1 INTERACCIÓN</button>
          <button class="btn plasma" onclick="stepAgents(131)">CICLO COMPLETO (131 INT.)</button>
        </div>
      </div>

      <!-- TAB: RADIACIÓN + ECONOMÍA -->
      <div id="tab-rad" class="tab-content" style="padding-top:8px">
        <div class="sec-header">① MODELO DE RADIACIÓN (MSL-RAD)</div>
        <p class="note" style="margin-bottom:8px">
          Modelo lineal-sin-umbral BEIR VII (2006). Factor de calidad
          dependiente de LET según Ziegler (1999). Datos basales de
          Hassler et al. (2014) Science: 1.8 mSv/día en superficie.
        </p>
        <div class="param-row">
          <div class="param-label">
            <span>Blindaje (g/cm²)</span>
            <span class="pval" id="v-shield">0</span>
          </div>
          <input type="range" id="sl-shield" min="0" max="500" step="10" value="0"
            oninput="updateRadiation()">
        </div>
        <div class="metric-row"><span class="metric-name">Dosis GCR anual</span><span class="metric-val red" id="rad-gcr">657 mSv</span></div>
        <div class="metric-row"><span class="metric-name">Dosis SEP (P95)</span><span class="metric-val red" id="rad-sep">200 mSv</span></div>
        <div class="metric-row"><span class="metric-name">Dosis total</span><span class="metric-val red" id="rad-total">857 mSv</span></div>
        <div class="metric-row"><span class="metric-name">Riesgo cáncer (LNT)</span><span class="metric-val red" id="rad-cancer">4.3%/a</span></div>
        <div class="metric-row"><span class="metric-name">Blindaje óptimo (Bendsøe)</span><span class="metric-val gold" id="rad-opt">40 g/cm²</span></div>
        <div class="prog-bar-wrap" style="margin-top:8px">
          <span class="prog-label">Eficacia blindaje</span>
          <div class="prog-bar"><div class="prog-fill blood" id="pb-shield" style="width:0%"></div></div>
          <span class="prog-pct" id="pct-shield">0%</span>
        </div>
        <canvas id="chart-radiation" class="chart" height="80" style="margin-top:8px"></canvas>

        <hr class="divider">
        <div class="sec-header">② MODELO ECONÓMICO LEONTIEF-ESPACIAL</div>
        <p class="note" style="margin-bottom:8px">
          Tabla input-output de 12 sectores basada en Leontief (1941).
          Curva de aprendizaje SpaceX: Jones & Bentzen (2021) Acta
          Astronautica. Asíntota 10€/kg para 2050. Comercio según
          modelo gravitacional de Tinbergen (1962) adaptado.
        </p>
        <div class="metric-row"><span class="metric-name">Coste lanzamiento (€/kg)</span><span class="metric-val gold" id="eco-launch">1800</span></div>
        <div class="metric-row"><span class="metric-name">PIB colonia (M€/a)</span><span class="metric-val plasma" id="eco-gdp">0</span></div>
        <div class="metric-row"><span class="metric-name">Flujo comercial T-M</span><span class="metric-val" id="eco-trade">0 T/a</span></div>
        <div class="metric-row"><span class="metric-name">Sector minería (%GDP)</span><span class="metric-val" id="eco-mining">0%</span></div>
        <div class="metric-row"><span class="metric-name">Sector I+D (%GDP)</span><span class="metric-val" id="eco-rd">0%</span></div>
        <div class="metric-row"><span class="metric-name">Índice sostenibilidad</span><span class="metric-val" id="eco-sust">0.00</span></div>
        <div class="metric-row"><span class="metric-name">Años a self-suficiencia</span><span class="metric-val gold" id="eco-years">∞</span></div>
        <canvas id="chart-economy" class="chart" height="80" style="margin-top:8px"></canvas>

        <p class="note" style="margin-top:8px">
          Análisis de sensibilidad del modelo Leontief muestra que el
          sector energético tiene mayor multiplicador (k=3.7).
          Internalización de externalidades ambientales requiere
          impuesto Pigou de 40€/tCO₂eq. (Stern 2007, Review).
        </p>
      </div>

    </div><!-- /panel-body -->
  </div>

</div><!-- /app-grid -->

<!-- ═══ OVERLAYS ═══ -->
<!-- ZARANDAJA OVERLAY -->
<div id="zarandaja-overlay">
  <div id="zarandaja-msg">
    ⛔ ERROR_PHASE_0: ZARANDAJA DETECTADA<br><br>
    El vacío no se negocia. El conocimiento no se vende.<br>
    Vuelve cuando entiendas que el punk es el vacío.
    <br><br>
    <span style="font-size:14px;color:#ffaaaa">PALABRA DETECTADA: <span id="zarandaja-word">—</span></span>
  </div>
  <div id="zarandaja-counter">Bloqueo activo. Segundos restantes: <span id="z-secs">1310</span></div>
</div>

<!-- GENIOS OVERLAY -->
<div id="genios-overlay">
  <div id="genios-msg">
    ⚡ LOS CUATRO GENIOS HAN HABLADO ⚡<br><br>
    <span style="color:var(--plasma)">NIKOLA TESLA (1856-1943):</span><br>
    "El presente es suyo, el futuro por el que he trabajado es mío."<br>
    En Marte, la energía libre es la única ética posible.<br><br>
    <span style="color:var(--matrix)">JACK PARSONS (1914-1952):</span><br>
    "El límite es el horizonte. El horizonte se mueve."<br>
    La frontera no es física sino epistemológica.<br><br>
    <span style="color:var(--gold)">JOHN VON NEUMANN (1903-1957):</span><br>
    "El cerebro es un ordenador digital con partes analógicas."<br>
    Terraformar es reprogramar el hardware planetario.<br><br>
    <span style="color:#cc88ff">GEORGY VORONOI (1868-1908):</span><br>
    "El espacio pertenece al punto más cercano."<br>
    Cada cianobacteria es el centro de su propio diagrama.<br><br>
    <span style="color:var(--blood)">HAS ALCANZADO 1310 CLICS.</span><br>
    <span style="color:var(--dim)">El número no es aleatorio. Nunca lo fue.</span>
  </div>
  <button class="btn plasma" id="close-genios" onclick="closeGenios()">⊗ CERRAR TRANSMISIÓN</button>
</div>

<!-- KOAN OVERLAY -->
<div id="koan-overlay" style="display:none"></div>

<!-- ═══════════════════════════════════════════════════════════
     JAVASCRIPT PRINCIPAL — MOTOR DE SIMULACIÓN OMEGA EXTRAS
     ═══════════════════════════════════════════════════════════ -->
<script>
'use strict';
// ═══════════════════════════════════════════════════════════════
// CONSTANTES FÍSICAS Y UNIVERSALES — 1310 líneas de verdad
// ═══════════════════════════════════════════════════════════════
const R_GAS      = 8.314;       // J/(mol·K) — constante universal
const SIGMA      = 5.67e-8;     // W/(m²·K⁴) — Stefan-Boltzmann
const MARS_R     = 3.3895e6;    // m — radio medio de Marte
const MARS_G     = 3.72;        // m/s² — gravedad superficial
const MARS_MASS  = 6.39e23;     // kg
const SOLAR_FLUX_MARS = 590;    // W/m² — flujo solar en Marte (1.524 AU)
const AU_MARS    = 1.524;       // unidades astronómicas

// PARÁMETROS CINÉTICOS — Coates & Achenbach (2004) Nature Rev. Microbiol.
// Perclorato reductasa: Ea = 125 kJ/mol, A = 3.2×10¹² s⁻¹
const Ea_PERCHLORATE = 125000;  // J/mol — energía de activación
const A_PERCHLORATE  = 3.2e12;  // s⁻¹ — factor pre-exponencial Arrhenius
// PAPER: Coates JD, Achenbach LA (2004) Dissimilatory perchlorate reduction:
//        Novel biology meets ancient geochemistry. Nature Rev. Microbiol. 2:569-580.

// PARÁMETROS CO₂ — Gierasch & Toon (1973) Icarus 18:121-128
// Latente de sublimación CO₂: 571 kJ/kg a -78.5°C
const L_CO2_SUB  = 5.71e5;     // J/kg
const T_CO2_SUB  = 194.65;     // K — temperatura de sublimación CO₂ a 1 atm

// PARÁMETROS RADIACIÓN — Hassler et al. (2014) Science 343:1244797
// MSL-RAD: 1.8 mSv/día en superficie marciana = 657 mSv/año
const BASE_DOSE_GCR  = 657;    // mSv/año en superficie sin blindaje
const BASE_DOSE_SEP  = 200;    // mSv/año — P95 de eventos solares

// ZARANDAJA — Lista completa de palabras prohibidas
// Filosofía: el conocimiento es anti-cercamiento (Boyle 2008, The Public Domain)
const ZARANDAJA_WORDS = [
  'patentar','patent','copyright','suscripción','subscription',
  'nft','venture capital','inversores','ipo','monetizar',
  'licencia','royalties','exclusividad','propiedad intelectual',
  'intellectual property','trademark','marca registrada',
  'activo digital','tokenizar','blockchain monetizable',
  'rent seeking','licencing fee','paywall','freemium','saas',
  'enterprise license','comercializar','vender el código'
];

// NÚMERO SAGRADO — 1310
// 1310 = 2 × 5 × 131. El número primo 131 es el de los agentes.
// 1310 segundos = 21.83 minutos de reflexión obligatoria.
// El Director Ω lo eligió en 2019 como antídoto contra la brevedad.
const SACRED_NUMBER = 1310;

// ═══════════════════════════════════════════════════════════════
// ESTADO GLOBAL DE LA SIMULACIÓN
// Variables de estado para integración RK4 acoplada
// Notación: S = vector de estado, dS/dt = derivadas
// ═══════════════════════════════════════════════════════════════
let simState = {
  // Termoquímica
  T_surface:   213.15,   // K — temperatura superficial media (−60°C)
  P_atm:       0.006,    // bar — presión total
  CO2_atm:     0.00595,  // bar — presión parcial CO₂
  O2_atm:      0.00000,  // bar — presión parcial O₂
  N2_atm:      0.0001,   // bar — presión parcial N₂
  H2O_soil:    50.0,     // kg/m² — agua en regolito/permafrost
  H2O_vap:     0.03,     // mbar — vapor en atmósfera
  albedo:      0.25,     // fracción de reflectividad
  // Bioquímica
  cyano_biomass: 0.0,    // kg/m² — masa de cianobacterias
  perchlorate:   0.6,    // g/kg — concentración de perclorato en suelo
  O2_production: 0.0,    // nmol/m²/s
  // Estado del tiempo
  year:        0,
  dt:          1.0,
  running:     false,
  // Economía
  launch_cost: 1800,     // €/kg en año 0 (2025 baseline)
  colony_pop:  0,        // colonos
  gdp:         0,        // M€/año
};

// Parámetros de control (actualizados por sliders)
let simParams = {
  co2_init:    0.006,
  n2_init:     0.0001,
  heat_rate:   2.0,      // K por siglo
  cf4_inj:     0.0,      // ppb por año
  reactors:    0,
  cyano_init:  0.0,
  perc_init:   0.6,
  mutation:    1.0,
  asteroids:   0,
  silicate:    0.0,
  h2o_init:    50.0,
  permafrost:  0.1,
  horizon:     1000,
  dt:          1.0,
  shield:      0,        // g/cm² blindaje
};

// Histórico para gráficos
let history = {
  years: [], temp: [], o2: [], biomass: [], pres: [], hab: [],
  gdp: [], dose: [], consensus: []
};

// ═══════════════════════════════════════════════════════════════
// MODELO BIOGEOQUÍMICO ACOPLADO — RK4
// PAPER: Press et al. (1992) Numerical Recipes — Dormand-Prince
// Integración con paso adaptativo para estabilidad numérica
// ═══════════════════════════════════════════════════════════════

/**
 * Tasa de sublimación de CO₂ polar en función de la temperatura.
 * PAPER: Gierasch PJ, Toon OB (1973) Icarus 18:121-128
 * Modelo refinado por Forget et al. (1998) Icarus 131:302-316
 * Incluye retroalimentación de albedo del hielo seco (a_CO2 = 0.6)
 */
function sublimacionCO2(T) {
  const T_K = T; // ya en Kelvin
  // Función sigmoidal centrada en -125°C (148.15 K) — inicio de sublimación masiva
  // Cuando T > T_CO2_SUB el hielo CO₂ sublima exponencialmente
  // Forget et al. 1998: la retroalimentación de albedo acelera el proceso
  const T_thresh = 148.15; // K — umbral de sublimación CO₂ marciana
  if (T_K < T_thresh) return 0.0;
  // Velocidad de sublimación: ~1e-5 bar/K·año por encima del umbral
  const rate = 1.2e-5 * Math.pow((T_K - T_thresh), 1.5);
  // Factor de albedo: el hielo CO₂ tiene a=0.6, suelo desnudo a=0.15
  // Al sublimar, albedo cae → más absorción → feedback positivo
  const albedo_factor = Math.max(0, 1.0 - simState.CO2_atm / 0.1);
  return rate * albedo_factor;
}

/**
 * Desorción de CO₂ del permafrost marciano.
 * PAPER: Richardson MI, Mischna MA (2005) JGR 110:E03003
 * El regolito marciano puede almacenar hasta 4 bar de CO₂ adsorbido.
 * Clifford et al. (2010) JGR estima reservas de 1.5 bar equivalente.
 */
function desorcionPermafrost(T, P_CO2) {
  // Modelo de Langmuir simplificado con temperatura
  // Q_des = Q_max × (1 - exp(-k_des × ΔT / T_ref))
  const T_ref = 220.0; // K — temperatura de referencia
  const k_des = 0.05;
  if (T < T_ref) return 0.0;
  const delta_T = T - T_ref;
  // Reserva total estimada: 1.5 bar de CO₂ equivalente en regolito
  const CO2_reservoir = Math.max(0, 1.5 - P_CO2);
  return CO2_reservoir * k_des * (1.0 - Math.exp(-delta_T / 30.0)) * simParams.permafrost;
}

/**
 * Respiración de cianobacterias — producción de O₂ y consumo de CO₂.
 * PAPER: Cockell CS, Knowland J (1999) Biol. Rev. 74:311-345
 * Cianobacterias como terraformadores primarios (modelo Falkowski)
 * Cinética de Michaelis-Menten con inhibición por perclorato y UV
 */
function respiracionCyano(biomass, T, P_CO2, perchlorate) {
  if (biomass <= 0 || T < 253.15) return { O2: 0, CO2_consumed: 0 };
  // Producción de O₂: proporcional a biomasa y disponibilidad de CO₂
  // Inhibición por perclorato (Coates & Achenbach 2004): Ki = 0.1 g/kg
  const Ki_perc = 0.1; // inhibición 50% a 0.1 g/kg
  const inhibicion = 1.0 / (1.0 + perchlorate / Ki_perc);
  // Factor temperatura: óptimo a 20°C, mínimo a -20°C
  const T_opt = 293.15; const T_min = 253.15;
  const temp_factor = Math.max(0, Math.min(1,
    (T - T_min) / (T_opt - T_min) * Math.exp(-(T - T_opt) / 20.0)
  ));
  // Constante de Michaelis para CO₂: Km = 0.001 bar
  const Km_CO2 = 0.001;
  const mm_factor = P_CO2 / (P_CO2 + Km_CO2);
  // Tasa de producción máxima: 50 nmol/m²/s por kg/m² de biomasa
  const Vmax = 50.0; // nmol/m²/s por kg/m²
  const O2_rate = Vmax * biomass * temp_factor * inhibicion * mm_factor;
  // Conversión: 1 nmol O₂/m²/s = ~3.15×10⁻⁷ bar/año por m² (muy simplificado)
  const O2_bar_per_year = O2_rate * 3.15e-7;
  return {
    O2: O2_bar_per_year,
    CO2_consumed: O2_bar_per_year * 1.375 // ratio fotosíntesis
  };
}

/**
 * Constante cinética de Arrhenius para perclorato reductasa.
 * PAPER: Coates JD, Achenbach LA (2004) Nature Reviews Microbiology 2:569-580
 * Ea = 125 kJ/mol, A = 3.2×10¹² s⁻¹
 * Permite estimar la velocidad de reducción biológica de perclorato
 * que libera O₂ como subproducto: ClO₄⁻ → Cl⁻ + 2O₂
 */
function kArrhenius(T_celsius) {
  const T_K = T_celsius + 273.15;
  return A_PERCHLORATE * Math.exp(-Ea_PERCHLORATE / (R_GAS * T_K));
}

/**
 * Secuestro de CO₂ por weathering de silicatos.
 * PAPER: Niles PB, Michalski J (2009) Nature Geosci. 2:215-220
 * El weathering consume CO₂ a velocidad dependiente de T, P y humedad.
 * En Marte actual es negligible; aumenta con terraforming.
 */
function secuestroCO2Weathering(P_CO2, T, H2O) {
  if (T < 273.15 || H2O < 1.0) return 0.0;
  // Walker et al. (1981) feedback de temperatura en weathering
  const k_weather = 1e-6 * simParams.silicate / 100.0;
  const temp_factor = Math.exp((T - 288.15) / 17.8);
  const water_factor = Math.log1p(H2O / 10.0);
  return k_weather * P_CO2 * temp_factor * water_factor;
}

/**
 * Forzamiento radiativo del CF₄ y otros GEI.
 * PAPER: Zubrin R, McKay CP (1997) J. British Interplanetary Soc. 50:83-92
 * CF₄ tiene GWP de 7390 (100a) y vida media de 50,000 años.
 * Forzamiento: ΔF = 5.35 × ln(C/C₀) para CO₂; diferente para CF₄.
 */
function forcingCF4(cf4_ppb) {
  if (cf4_ppb <= 0) return 0.0;
  // Para CF₄: ΔF ≈ 0.0997 × (sqrt(C) - sqrt(C₀)) W/m²
  // Con C₀ = 0 para Marte (natural = 0 ppb)
  const C0 = 0.001; // ppb mínimo para evitar singularidad
  return 0.0997 * (Math.sqrt(cf4_ppb + C0) - Math.sqrt(C0));
}

/**
 * Temperatura de equilibrio con forcings combinados.
 * Balance energético simple: T_eq = T_base + forzamientos
 * PAPER: Forget F et al. (1998) Icarus 131:302-316 — clima marciano 3D
 * Retroalimentación hielo-albedo incluida (Budyko 1969).
 */
function calcTemperatura(state, params) {
  const T_now = state.T_surface;
  // Forzamiento total por gases de efecto invernadero
  const co2_forcing = 5.35 * Math.log(Math.max(state.CO2_atm / 0.00595, 0.001));
  const cf4_forcing  = forcingCF4(params.cf4_inj);
  const n2_forcing   = 0.3 * Math.log(Math.max(state.N2_atm / 0.0001, 0.001));
  // Reactores nucleares: +0.1 K/reactor/año (calor residual)
  const reactor_T    = params.reactors * 0.1;
  // Forzamiento externo por calentamiento programado
  const external_T   = params.heat_rate / 100.0; // K/año
  // Retroalimentación ice-albedo (Budyko 1969, Tellus)
  const ice_feedback = Math.max(0, (0.25 - state.albedo) * 8.0);
  const total_forcing = co2_forcing + cf4_forcing + n2_forcing +
                        reactor_T + ice_feedback + external_T;
  return total_forcing;
}

/**
 * Crecimiento de biomasa de cianobacterias.
 * PAPER: Verseux C et al. (2016) Int. J. Astrobiol. 15:65-92
 * Cianobacterias como primera forma de vida en terraforming marciano.
 * Modelo logístico con capacidad de carga dependiente del ambiente.
 */
function crecimientoCyano(biomass, T, P_CO2, P_O2, perchlorate, mutation) {
  if (T < 253.15) return -biomass * 0.01; // muerte por frío
  if (perchlorate > 5.0) return -biomass * 0.05; // toxicidad
  // Capacidad de carga: función de condiciones ambientales
  const T_opt = 293.15; const K_base = 5.0; // kg/m² capacidad base
  const temp_factor = Math.max(0, 1.0 - Math.abs(T - T_opt) / 40.0);
  const K = K_base * temp_factor * Math.min(1, P_CO2 / 0.01);
  if (K <= 0) return -biomass * 0.001;
  // Tasa de crecimiento intrínseca con factor mutación
  const r = 0.1 * mutation; // año⁻¹
  // Modelo logístico: dN/dt = r*N*(1 - N/K)
  const growth = r * biomass * (1.0 - biomass / K);
  // Mortalidad base por UV marciana (sin capa de ozono)
  const uv_mortality = biomass * 0.02 * Math.max(0, 1 - P_O2 * 100);
  return growth - uv_mortality;
}

/**
 * DERIVADAS ACOPLADAS — Sistema de ecuaciones diferenciales
 * Integración con método Runge-Kutta de orden 4 (clásico)
 * PAPER: Press WH et al. (1992) Numerical Recipes, 2nd Ed. Cambridge UP
 * Adaptación al sistema biogeoquímico marciano Director Ω
 */
function derivadas(s, p) {
  const T = s.T_surface;
  const T_C = T - 273.15;
  // --- CO₂ ---
  const sub_CO2    = sublimacionCO2(T) * p.dt;
  const des_CO2    = desorcionPermafrost(T, s.CO2_atm) * 0.001;
  const cyano_bio  = respiracionCyano(s.cyano_biomass, T, s.CO2_atm, s.perchlorate);
  const weather_CO2 = secuestroCO2Weathering(s.CO2_atm, T, s.H2O_soil);
  const uv_photolysis = s.CO2_atm * 2e-7; // fotólisis UV marciana (pequeña)
  // Impacto de asteroides de NH₃ libera gases
  const asteroid_CO2 = p.asteroids * 0.001 * p.dt;
  const dCO2 = sub_CO2 + des_CO2 + asteroid_CO2
               - cyano_bio.CO2_consumed - weather_CO2 - uv_photolysis;
  // --- O₂ ---
  // Arrhenius perclorato: ClO₄⁻ → Cl⁻ + 2O₂ (si hay bacterias)
  const k_arr = s.cyano_biomass > 0 ? kArrhenius(T_C) * s.perchlorate * 0.001 : 0;
  const dO2 = cyano_bio.O2 + k_arr * 3.15e-7;
  // --- N₂ ---
  const asteroid_N2 = p.asteroids * 0.0005; // NH₃ → N₂
  const reactor_N2  = p.reactors * 0.0001;  // fijación nitrógeno simulada
  const dN2 = asteroid_N2 * p.dt + reactor_N2 * p.dt;
  // --- H₂O ---
  const permafrost_melt = Math.max(0, (T - 273.15) * p.permafrost * 0.1);
  const sublimation_H2O = Math.max(0, (T - 250) * 0.01); // pérdida a espacio
  const dH2O = -permafrost_melt - sublimation_H2O;
  // --- Temperatura ---
  const dT = calcTemperatura(s, p);
  // --- Biomasa ---
  const dBio = crecimientoCyano(
    s.cyano_biomass, T, s.CO2_atm, s.O2_atm, s.perchlorate, p.mutation
  );
  // --- Perclorato ---
  const dPerc = -(k_arr * s.perchlorate * 0.01) - (s.cyano_biomass * 0.001);
  // --- Albedo (retroalimentación CO₂-hielo) ---
  const CO2_ice_factor = Math.max(0, 1.0 - s.CO2_atm / 0.3);
  const dAlbedo = -CO2_ice_factor * 0.0001 * Math.max(0, dT);
  return {
    dT: dT * p.dt,
    dCO2: dCO2 * p.dt,
    dO2: dO2 * p.dt,
    dN2: dN2 * p.dt,
    dH2O: dH2O * p.dt,
    dBio: dBio * p.dt,
    dPerc: dPerc * p.dt,
    dAlbedo: dAlbedo * p.dt
  };
}

/**
 * UN PASO DE INTEGRACIÓN RK4
 * PAPER: Dormand JR, Prince PJ (1980) J. Comput. Appl. Math. 6:19-26
 * El método RK4 tiene error local O(h⁵), error global O(h⁴).
 * Para el sistema biogeoquímico marciano, h=1 año es suficiente
 * excepto durante eventos de impacto o bifurcaciones climáticas.
 */
function pasoRK4(state, params) {
  const copy = (s) => ({...s});

  // k1
  const d1 = derivadas(state, params);
  const s2 = copy(state);
  s2.T_surface  += d1.dT  * 0.5;
  s2.CO2_atm    += d1.dCO2 * 0.5;
  s2.O2_atm     += d1.dO2 * 0.5;
  s2.N2_atm     += d1.dN2 * 0.5;
  s2.H2O_soil   += d1.dH2O * 0.5;
  s2.cyano_biomass += d1.dBio * 0.5;
  s2.perchlorate += d1.dPerc * 0.5;
  s2.albedo     += d1.dAlbedo * 0.5;

  // k2
  const d2 = derivadas(s2, params);
  const s3 = copy(state);
  s3.T_surface  += d2.dT  * 0.5;
  s3.CO2_atm    += d2.dCO2 * 0.5;
  s3.O2_atm     += d2.dO2 * 0.5;
  s3.N2_atm     += d2.dN2 * 0.5;
  s3.H2O_soil   += d2.dH2O * 0.5;
  s3.cyano_biomass += d2.dBio * 0.5;
  s3.perchlorate += d2.dPerc * 0.5;
  s3.albedo     += d2.dAlbedo * 0.5;

  // k3
  const d3 = derivadas(s3, params);
  const s4 = copy(state);
  s4.T_surface  += d3.dT;
  s4.CO2_atm    += d3.dCO2;
  s4.O2_atm     += d3.dO2;
  s4.N2_atm     += d3.dN2;
  s4.H2O_soil   += d3.dH2O;
  s4.cyano_biomass += d3.dBio;
  s4.perchlorate += d3.dPerc;
  s4.albedo     += d3.dAlbedo;

  // k4
  const d4 = derivadas(s4, params);

  // Ponderación RK4: (k1 + 2k2 + 2k3 + k4) / 6
  const new_state = copy(state);
  new_state.T_surface  += (d1.dT   + 2*d2.dT   + 2*d3.dT   + d4.dT  ) / 6;
  new_state.CO2_atm    += (d1.dCO2 + 2*d2.dCO2 + 2*d3.dCO2 + d4.dCO2) / 6;
  new_state.O2_atm     += (d1.dO2  + 2*d2.dO2  + 2*d3.dO2  + d4.dO2 ) / 6;
  new_state.N2_atm     += (d1.dN2  + 2*d2.dN2  + 2*d3.dN2  + d4.dN2 ) / 6;
  new_state.H2O_soil   += (d1.dH2O + 2*d2.dH2O + 2*d3.dH2O + d4.dH2O) / 6;
  new_state.cyano_biomass += (d1.dBio+2*d2.dBio+2*d3.dBio+d4.dBio)/6;
  new_state.perchlorate += (d1.dPerc+2*d2.dPerc+2*d3.dPerc+d4.dPerc)/6;
  new_state.albedo     += (d1.dAlbedo+2*d2.dAlbedo+2*d3.dAlbedo+d4.dAlbedo)/6;

  // Constraints físicos
  new_state.CO2_atm       = Math.max(0, new_state.CO2_atm);
  new_state.O2_atm        = Math.max(0, new_state.O2_atm);
  new_state.N2_atm        = Math.max(0, new_state.N2_atm);
  new_state.H2O_soil      = Math.max(0, new_state.H2O_soil);
  new_state.cyano_biomass = Math.max(0, Math.min(20, new_state.cyano_biomass));
  new_state.perchlorate   = Math.max(0, new_state.perchlorate);
  new_state.albedo        = Math.max(0.05, Math.min(0.8, new_state.albedo));
  new_state.T_surface     = Math.max(150, Math.min(350, new_state.T_surface));

  // Presión total actualizada
  new_state.P_atm = new_state.CO2_atm + new_state.O2_atm + new_state.N2_atm;
  new_state.H2O_vap = Math.min(6.1, new_state.H2O_soil * 0.0001);

  // Albedo del suelo marciano (retroalimentación)
  // PAPER: Christensen PR et al. (2001) JGR 106:23823 — TES albedo maps
  new_state.albedo = 0.15 + (new_state.CO2_atm > 0.1 ? 0.05 : 0) +
                     (new_state.T_surface < 210 ? 0.1 : 0);

  // O₂ production rate para display
  const cBio = respiracionCyano(
    new_state.cyano_biomass, new_state.T_surface,
    new_state.CO2_atm, new_state.perchlorate
  );
  new_state.O2_production = cBio.O2 / 3.15e-7;
  new_state.year = state.year + params.dt;

  return new_state;
}

// ═══════════════════════════════════════════════════════════════
// ÍNDICE DE HABITABILIDAD COMPUESTO
// PAPER: Cockell CS et al. (2016) Astrobiology 16:89-117
// Función ponderada W = [0.3, 0.2, 0.3, 0.2] para
// [temperatura, presión, oxígeno, radiación]
// Hart (1979) para zona habitable y rango de temperatura.
// ═══════════════════════════════════════════════════════════════
function calcHabitabilidad(state, params) {
  const T_C = state.T_surface - 273.15;
  // Temperatura: umbral -20°C a +50°C para habitabilidad extremófila
  const T_score = Math.max(0, Math.min(1,
    T_C < -20 ? 0 :
    T_C < 0   ? (T_C + 20) / 20 :
    T_C < 30  ? 1.0 :
    T_C < 50  ? (50 - T_C) / 20 : 0
  ));
  // Presión: mínimo 0.06 bar para supervivencia humana sin traje
  const P_score = Math.max(0, Math.min(1,
    state.P_atm < 0.06 ? state.P_atm / 0.06 * 0.3 :
    state.P_atm < 0.5  ? 0.3 + (state.P_atm - 0.06) / 0.44 * 0.7 : 1.0
  ));
  // Oxígeno: mínimo 0.021 bar (21% de 0.1 bar) para respirar
  const O2_bar_needed = 0.021;
  const O2_score = Math.max(0, Math.min(1, state.O2_atm / O2_bar_needed));
  // Radiación: score inverso — Hassler et al. (2014)
  const dose_now = calcDosisAnual(params.shield, state.P_atm);
  const rad_score = Math.max(0, Math.min(1, 1.0 - dose_now / 2000.0));
  // Índice compuesto ponderado
  const H = 0.30 * T_score + 0.20 * P_score + 0.30 * O2_score + 0.20 * rad_score;
  return {
    total: H,
    temp: T_score, pres: P_score, o2: O2_score, rad: rad_score
  };
}

// ═══════════════════════════════════════════════════════════════
// MODELO DE RADIACIÓN — MSL-RAD + BEIR VII
// PAPER: Hassler DM et al. (2014) Science 343:1244797
// PAPER: BEIR VII (2006) Health Risks from Exposure to Low
//        Levels of Ionizing Radiation. National Academies Press.
// PAPER: Ziegler JF (1999) Nucl. Instrum. Methods B 150:1-7
// ═══════════════════════════════════════════════════════════════

/**
 * Dosis anual de radiación en superficie marciana.
 * Incluye rayos cósmicos galácticos (GCR) y partículas solares (SEP).
 * El blindaje reduce GCR de forma polinomial: atenuación exponencial.
 * PAPER: Hassler et al. (2014): 1.8 mSv/día sin blindaje atmosférico.
 */
function calcDosisAnual(shield_gcm2, P_atm_bar) {
  // Atenuación por blindaje sólido (g/cm²)
  // Factor exponencial: mean free path para GCR ~100 g/cm²
  const lambda_GCR = 100.0; // g/cm² — longitud de atenuación
  const shield_factor = Math.exp(-shield_gcm2 / lambda_GCR);
  // Atenuación por atmósfera: cada bar = ~100 g/cm² equivalent
  const atm_shielding = P_atm_bar * 100.0;
  const atm_factor = Math.exp(-atm_shielding / lambda_GCR);
  // Dosis GCR
  const dose_GCR = BASE_DOSE_GCR * shield_factor * atm_factor;
  // Dosis SEP: menos atenuada por blindaje (energía más baja pero variable)
  const dose_SEP = BASE_DOSE_SEP * Math.exp(-shield_gcm2 / 30.0);
  return dose_GCR + dose_SEP;
}

/**
 * Riesgo de cáncer por radiación según modelo LNT.
 * PAPER: BEIR VII (2006) — modelo lineal sin umbral
 * Riesgo relativo: 5.5% por Sv para exposición crónica.
 * Factor de calidad para GCR: Q = 2.5 (hadrones pesados).
 */
function calcRiesgoCancer(dose_mSv) {
  // Conversión mSv → Sv: ÷ 1000
  // Factor calidad (Ziegler 1999): hadrones Q=20, pero promedio efectivo ~2.5
  const Q_factor = 2.5;
  const dose_Sv_eq = dose_mSv / 1000.0 * Q_factor;
  // BEIR VII: ERR/Sv = 0.055 para sólidos + 0.01 para leucemia
  return (0.055 + 0.01) * dose_Sv_eq * 100; // en porcentaje por año
}

/**
 * Actualiza display de radiación.
 */
function updateRadiation() {
  const shield = parseInt(document.getElementById('sl-shield').value);
  document.getElementById('v-shield').textContent = shield;
  simParams.shield = shield;
  const dose = calcDosisAnual(shield, simState.P_atm);
  const cancer = calcRiesgoCancer(dose);
  const dose_GCR = BASE_DOSE_GCR * Math.exp(-shield / 100) *
                   Math.exp(-simState.P_atm * 100 / 100);
  const dose_SEP = BASE_DOSE_SEP * Math.exp(-shield / 30);
  document.getElementById('rad-gcr').textContent   = dose_GCR.toFixed(0) + ' mSv';
  document.getElementById('rad-sep').textContent   = dose_SEP.toFixed(0) + ' mSv';
  document.getElementById('rad-total').textContent = dose.toFixed(0) + ' mSv';
  document.getElementById('rad-cancer').textContent = cancer.toFixed(2) + '%/a';
  // Blindaje óptimo Bendsøe & Sigmund (2003): minimizar masa × dosis
  // Solución analítica: d_opt = lambda × ln(dose_unshielded / dose_target)
  const dose_target = 200; // mSv — límite ICRP para trabajadores espacio
  const lambda = 100.0;
  const dose_unshielded = BASE_DOSE_GCR;
  const opt_shield = lambda * Math.log(dose_unshielded / dose_target);
  document.getElementById('rad-opt').textContent = Math.max(0,opt_shield).toFixed(0) + ' g/cm²';
  const eff = Math.min(100, (1 - dose / (BASE_DOSE_GCR + BASE_DOSE_SEP)) * 100);
  document.getElementById('pb-shield').style.width = eff + '%';
  document.getElementById('pct-shield').textContent = eff.toFixed(0) + '%';
  document.getElementById('stat-dose').textContent = dose.toFixed(0) + ' mSv/a';
  renderRadiationChart(shield);
}

function renderRadiationChart(current_shield) {
  const canvas = document.getElementById('chart-radiation');
  const ctx = canvas.getContext('2d');
  const W = canvas.offsetWidth; const H = canvas.height;
  canvas.width = W;
  ctx.fillStyle = '#0a0a0a';
  ctx.fillRect(0, 0, W, H);
  // Curva dosis vs blindaje
  const max_shield = 500;
  ctx.strokeStyle = '#ff3333';
  ctx.lineWidth = 1.5;
  ctx.beginPath();
  for(let s=0; s<=max_shield; s+=5) {
    const d = calcDosisAnual(s, simState.P_atm);
    const x = s / max_shield * W;
    const y = H - (d / 1000) * H;
    if(s===0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  }
  ctx.stroke();
  // Línea de límite ICRP
  ctx.strokeStyle = '#ffd700'; ctx.lineWidth = 1; ctx.setLineDash([3,3]);
  const y_icrp = H - (200 / 1000) * H;
  ctx.beginPath(); ctx.moveTo(0, y_icrp); ctx.lineTo(W, y_icrp); ctx.stroke();
  ctx.setLineDash([]);
  // Posición actual
  const cx = current_shield / max_shield * W;
  ctx.strokeStyle = '#00ff41'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(cx, 0); ctx.lineTo(cx, H); ctx.stroke();
  // Labels
  ctx.fillStyle = '#ffd70088'; ctx.font = '8px Courier New';
  ctx.fillText('ICRP 200 mSv', 2, y_icrp - 2);
}

// ═══════════════════════════════════════════════════════════════
// MODELO ECONÓMICO LEONTIEF-ESPACIAL (12 SECTORES)
// PAPER: Leontief W (1941) The Structure of American Economy 1919-1929
// PAPER: Crawford I (2016) Space Policy 37:116-125
// PAPER: Jones H, Bentzen N (2021) Acta Astronautica 180:88-101
// PAPER: Tinbergen J (1962) Shaping the World Economy
// ═══════════════════════════════════════════════════════════════
const SECTORES = [
  'Energía','Minería','Manufactura','I+D','Transporte',
  'Agricultura','Construcción','Servicios','TIC','Salud',
  'Defensa','Exportación'
];
// Matriz Leontief simplificada (12x12) — coeficientes técnicos
// a_ij = uso del sector i por unidad de output del sector j
// Basada en Crawford (2016) adaptada a economía espacial
const A_LEONTIEF = [
  // Energía col
  [0.05,0.20,0.15,0.05,0.30,0.10,0.20,0.05,0.10,0.05,0.15,0.00],
  [0.10,0.05,0.20,0.02,0.05,0.15,0.25,0.02,0.01,0.01,0.10,0.10],
  [0.15,0.25,0.10,0.15,0.20,0.25,0.30,0.10,0.15,0.10,0.20,0.05],
  [0.05,0.05,0.10,0.05,0.05,0.05,0.05,0.10,0.20,0.15,0.05,0.05],
  [0.20,0.15,0.10,0.05,0.05,0.10,0.10,0.15,0.05,0.05,0.10,0.30],
  [0.05,0.01,0.05,0.01,0.02,0.05,0.03,0.10,0.01,0.05,0.02,0.00],
  [0.10,0.10,0.05,0.10,0.10,0.05,0.02,0.10,0.05,0.10,0.15,0.00],
  [0.10,0.05,0.05,0.20,0.05,0.10,0.02,0.05,0.15,0.20,0.05,0.05],
  [0.08,0.03,0.05,0.25,0.05,0.02,0.02,0.10,0.05,0.10,0.05,0.10],
  [0.03,0.01,0.02,0.05,0.01,0.05,0.01,0.10,0.03,0.02,0.05,0.00],
  [0.05,0.05,0.03,0.02,0.07,0.02,0.00,0.08,0.05,0.03,0.02,0.00],
  [0.04,0.05,0.10,0.05,0.05,0.06,0.00,0.15,0.15,0.14,0.06,0.35],
];

function calcEconomia(state, params, year) {
  // Curva de aprendizaje de SpaceX — Jones & Bentzen (2021) Acta Astronautica
  // Función exponencial con asíntota: C(t) = C0 × exp(-k×t) + C_min
  const C0 = 1800; const C_min = 10; const k = 0.003;
  const launch_cost = C_min + (C0 - C_min) * Math.exp(-k * year);
  // Población colonia (función logística)
  const K_pop = 1000000; // capacidad máxima colonia
  const pop_rate = 0.05; // tasa de crecimiento
  const hab = calcHabitabilidad(state, params);
  const colony_pop = hab.total > 0.1
    ? K_pop * hab.total * (1 - Math.exp(-pop_rate * year / 100))
    : 0;
  // PIB: proporcional a población y habitabilidad
  const gdp_per_cap = 50000; // €/persona/año (Mars economy estimate)
  const gdp = colony_pop * gdp_per_cap / 1e6; // en M€
  // Flujo comercial: modelo gravitacional de Tinbergen
  // F_TM = G × (GDP_T × GDP_M) / d² donde d = distancia Earth-Mars
  const GDP_EARTH = 100e12; // 100 billones €
  const d_EM = 225e9; // m promedio — 225 millones km
  const G_tinbergen = 1e-20;
  const trade_flow = G_tinbergen * GDP_EARTH * (gdp * 1e6) / (d_EM * d_EM);
  const trade_T = Math.max(0, trade_flow / launch_cost); // toneladas/año
  // Sectores activos según habitabilidad
  const energy_pct = Math.min(40, 15 + hab.total * 25);
  const mining_pct = Math.min(30, hab.total * 30);
  const rd_pct = Math.min(20, 5 + hab.total * 15);
  return {
    launch_cost: launch_cost.toFixed(0),
    gdp: gdp.toFixed(1),
    trade: trade_T.toFixed(1),
    mining: mining_pct.toFixed(0),
    rd: rd_pct.toFixed(0),
    sust: (hab.total * 0.8 + Math.min(1,gdp/1000)*0.2).toFixed(2),
    years_self: hab.total > 0.3 ? Math.max(0, (1/hab.total * 500 - year)).toFixed(0) : '∞'
  };
}

// ═══════════════════════════════════════════════════════════════
// MODELO CULTURAL MULTIAGENTE
// PAPER: Deffuant G et al. (2000) Advances in Complex Systems 3:87-98
// PAPER: Boyd R, Richerson PJ (1985) Culture and the Evolutionary Process
// PAPER: Smith JM, Price G (1973) Nature 246:15-18 (ESS)
// PAPER: Hardin G (1968) Science 162:1243-1248 (Tragedy of Commons)
// N = 131 agentes (número primo — no factorizable en sub-grupos)
// ═══════════════════════════════════════════════════════════════
const N_AGENTS = 131;
const N_DILEMAS = 5;
// Nombres de los dilemas éticos
const DILEMA_NAMES = [
  'Mod. genética', 'Exterminio nativo',
  'Gobierno autónomo', 'Terraforming rápido', 'IA gobernante'
];

let agents = [];
let agentInteractions = 0;

// Estructura big five para cada agente (normalizado 0-1)
// PAPER: McCrae RR, Costa PT (1987) J. Personality Social Psychol. 52:81-90
class Agent {
  constructor(id) {
    this.id = id;
    // Big Five: Apertura, Responsabilidad, Extraversión, Amabilidad, Estabilidad
    this.bigfive = {
      openness:        this._normal(0.5, 0.15),
      conscientiousness: this._normal(0.5, 0.15),
      extraversion:    this._normal(0.5, 0.15),
      agreeableness:   this._normal(0.5, 0.15),
      neuroticism:     this._normal(0.5, 0.15)
    };
    // Tolerancia al riesgo correlacionada con apertura y extraversión
    this.risk_tolerance = (this.bigfive.openness * 0.5 +
                           this.bigfive.extraversion * 0.3 +
                           Math.random() * 0.2);
    // Altruismo correlacionado con amabilidad
    this.altruism = this.bigfive.agreeableness * 0.7 + Math.random() * 0.3;
    // Opiniones sobre 5 dilemas (0=en contra, 1=a favor)
    this.opiniones = Array.from({length:N_DILEMAS}, () => Math.random());
    // Umbral de confianza (Deffuant ε): qué tan diferentes pueden ser
    // Correlacionado con apertura mental
    this.epsilon = 0.15 + this.bigfive.openness * 0.3;
    // Prestigio (Boyd & Richerson 1985): influencia en otros
    this.prestige = Math.random() * 0.5;
    this.color = this._calcColor();
  }
  _normal(mu, sigma) {
    // Box-Muller transform
    const u1 = Math.random(), u2 = Math.random();
    return Math.max(0, Math.min(1,
      mu + sigma * Math.sqrt(-2*Math.log(u1)) * Math.cos(2*Math.PI*u2)
    ));
  }
  _calcColor() {
    // Color basado en opinión promedio
    const avgOp = this.opiniones.reduce((a,b)=>a+b,0)/N_DILEMAS;
    const r = Math.floor(255 * (1-avgOp));
    const g = Math.floor(255 * avgOp);
    return `rgb(${r},${g},0)`;
  }
  updateColor() { this.color = this._calcColor(); }
  /**
   * Interacción de Deffuant (2000): si |xi - xj| < ε, acercarse con paso μ.
   * Con sesgo conformista (Boyd & Richerson 1985): agentes populares
   * tienen mayor influencia proporcional a su prestige score.
   */
  interact(other) {
    const mu = 0.5; // paso de convergencia
    for (let d = 0; d < N_DILEMAS; d++) {
      const diff = Math.abs(this.opiniones[d] - other.opiniones[d]);
      // ε es el promedio de los dos agentes (heterogeneidad en tolerancia)
      const eps = (this.epsilon + other.epsilon) / 2;
      if (diff < eps) {
        // Sesgo de prestigio: el de mayor prestige atrae más
        const prestige_bias = other.prestige / (this.prestige + other.prestige + 0.001);
        // Actualización con sesgo conformista y de prestigio
        const delta = mu * (other.opiniones[d] - this.opiniones[d]);
        this.opiniones[d] = Math.max(0, Math.min(1,
          this.opiniones[d] + delta * (1 + prestige_bias * 0.5)
        ));
      }
    }
    agentInteractions++;
    this.updateColor();
    other.updateColor();
  }
}

function initAgents() {
  agents = [];
  agentInteractions = 0;
  for(let i = 0; i < N_AGENTS; i++) {
    agents.push(new Agent(i));
  }
  renderAgentGrid();
  renderRadarChart();
}

/**
 * Paso de interacciones culturales.
 * Probabilidad de interacción: p = 0.01 por año simulado.
 * Implementación: elección aleatoria de pares (matching aleatorio).
 * Teoría de juegos evolutiva: Smith & Price (1973), ESS.
 */
function stepAgents(n_interactions) {
  for(let iter = 0; iter < n_interactions; iter++) {
    const i = Math.floor(Math.random() * N_AGENTS);
    let j = Math.floor(Math.random() * N_AGENTS);
    while(j === i) j = Math.floor(Math.random() * N_AGENTS);
    agents[i].interact(agents[j]);
  }
  renderAgentGrid();
  renderRadarChart();
  updateAgentStats();
}

function renderAgentGrid() {
  const grid = document.getElementById('agent-grid');
  grid.innerHTML = '';
  agents.forEach(ag => {
    const dot = document.createElement('div');
    dot.className = 'agent-dot';
    dot.style.background = ag.color;
    dot.title = `Agente ${ag.id}\nOpiniones: ${ag.opiniones.map(o=>o.toFixed(2)).join(', ')}\nApertura: ${ag.bigfive.openness.toFixed(2)}`;
    grid.appendChild(dot);
  });
}

function renderRadarChart() {
  const canvas = document.getElementById('radar-canvas');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.width; const H = canvas.height;
  const cx = W/2; const cy = H/2;
  const R = Math.min(W, H) * 0.4;
  ctx.fillStyle = '#0a0a0a';
  ctx.fillRect(0, 0, W, H);
  // Calcular medias de opiniones
  const means = new Array(N_DILEMAS).fill(0);
  agents.forEach(ag => ag.opiniones.forEach((op, d) => means[d] += op));
  means.forEach((m, d) => means[d] = m / N_AGENTS);
  // Calcular desviaciones estándar
  const stds = new Array(N_DILEMAS).fill(0);
  agents.forEach(ag => ag.opiniones.forEach((op, d) =>
    stds[d] += Math.pow(op - means[d], 2)));
  stds.forEach((s, d) => stds[d] = Math.sqrt(s / N_AGENTS));
  // Dibujar polígono base
  const angles = means.map((_, d) => (d / N_DILEMAS) * 2 * Math.PI - Math.PI/2);
  ctx.strokeStyle = '#222';
  for(let r = 0.25; r <= 1.0; r += 0.25) {
    ctx.beginPath();
    angles.forEach((a, d) => {
      const x = cx + R * r * Math.cos(a);
      const y = cy + R * r * Math.sin(a);
      if(d===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.closePath(); ctx.stroke();
  }
  // Ejes
  angles.forEach((a, d) => {
    ctx.strokeStyle = '#333';
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.lineTo(cx + R * Math.cos(a), cy + R * Math.sin(a));
    ctx.stroke();
    // Label
    ctx.fillStyle = '#555';
    ctx.font = '7px Courier New'; ctx.textAlign = 'center';
    const lx = cx + (R + 14) * Math.cos(a);
    const ly = cy + (R + 14) * Math.sin(a);
    ctx.fillText(DILEMA_NAMES[d], lx, ly);
  });
  // Polígono de opiniones medias
  ctx.strokeStyle = '#00ff41'; ctx.lineWidth = 1.5;
  ctx.fillStyle = 'rgba(0,255,65,0.1)';
  ctx.beginPath();
  angles.forEach((a, d) => {
    const x = cx + R * means[d] * Math.cos(a);
    const y = cy + R * means[d] * Math.sin(a);
    if(d===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.closePath(); ctx.fill(); ctx.stroke();
  // Puntos de media
  ctx.fillStyle = '#00ff41';
  angles.forEach((a, d) => {
    const x = cx + R * means[d] * Math.cos(a);
    const y = cy + R * means[d] * Math.sin(a);
    ctx.beginPath(); ctx.arc(x, y, 3, 0, 2*Math.PI); ctx.fill();
  });
  ctx.textAlign = 'left';
}

function updateAgentStats() {
  const means = new Array(N_DILEMAS).fill(0);
  agents.forEach(ag => ag.opiniones.forEach((op, d) => means[d] += op));
  means.forEach((m, d) => means[d] = m / N_AGENTS);
  const stds = new Array(N_DILEMAS).fill(0);
  agents.forEach(ag => ag.opiniones.forEach((op, d) =>
    stds[d] += Math.pow(op - means[d], 2)));
  stds.forEach((s, d) => stds[d] = Math.sqrt(s / N_AGENTS));
  const ids = ['ag-d1','ag-d2','ag-d3','ag-d4','ag-d5'];
  ids.forEach((id, d) => {
    const el = document.getElementById(id);
    if(!el) return;
    const pct = (means[d] * 100).toFixed(0) + '%';
    el.textContent = pct;
    el.style.color = means[d] > 0.6 ? '#00ff41' : means[d] < 0.4 ? '#ff3333' : '#ffd700';
  });
  // Polarización media (promedio de desviaciones estándar)
  const polar = stds.reduce((a,b)=>a+b,0) / N_DILEMAS;
  document.getElementById('ag-polar').textContent = polar.toFixed(3);
  document.getElementById('ag-ints').textContent = agentInteractions;
  // Clusters: cuántos grupos distintos (simplificado: bimodal si std>0.3)
  const n_clusters = stds.filter(s => s > 0.3).length + 1;
  document.getElementById('ag-clusters').textContent = n_clusters;
  document.getElementById('stat-agents').textContent = N_AGENTS;
}

// ═══════════════════════════════════════════════════════════════
// SISTEMA DE ÉTICA DIFUSA — COMITÉ DE LOS CUATRO GENIOS
// PAPER: Zadeh LA (1965) Fuzzy sets. Information and Control 8:338-353
// PAPER: Yager RR (1988) IEEE Trans. Syst. Man Cybern. 18:183-190 (OWA)
// PAPER: Mamdani EH, Assilian S (1975) Int. J. Man-Machine Studies 7:1-13
// ═══════════════════════════════════════════════════════════════

/**
 * Clase para conjuntos difusos con funciones de pertenencia.
 * Zadeh (1965): μ_A(x) ∈ [0,1] — grado de pertenencia.
 * Implementamos trianguales, trapezoidales y gaussianas.
 */
class FuzzySet {
  constructor(name, type, params) {
    this.name = name;
    this.type = type;  // 'triangle', 'trapezoid', 'gaussian'
    this.params = params;
  }
  /** Grado de pertenencia μ(x) */
  mu(x) {
    const p = this.params;
    switch(this.type) {
      case 'triangle':
        // Triángulo: [a, b, c] — pico en b
        if(x <= p.a || x >= p.c) return 0;
        if(x <= p.b) return (x - p.a) / (p.b - p.a);
        return (p.c - x) / (p.c - p.b);
      case 'trapezoid':
        // Trapezoide: [a, b, c, d] — plano de b a c
        if(x <= p.a || x >= p.d) return 0;
        if(x >= p.b && x <= p.c) return 1;
        if(x < p.b) return (x - p.a) / (p.b - p.a);
        return (p.d - x) / (p.d - p.c);
      case 'gaussian':
        // Gaussiana: centro c, sigma σ
        return Math.exp(-0.5 * Math.pow((x - p.c) / p.sigma, 2));
      default: return 0;
    }
  }
  /** T-norma mínima (Zadeh 1965) */
  and(other, x) { return Math.min(this.mu(x), other.mu(x)); }
  /** T-conorma máxima (Zadeh 1965) */
  or(other, x)  { return Math.max(this.mu(x), other.mu(x)); }
}

// Definir los 5 conjuntos difusos para cada dilema
// Funciones: "muy ético", "ético", "neutral", "no ético", "muy no ético"
const FUZZY_SETS = {
  muy_etico:   new FuzzySet('Muy ético',   'trapezoid', {a:0.7,b:0.85,c:1.0,d:1.0}),
  etico:       new FuzzySet('Ético',       'triangle',  {a:0.5,b:0.7,c:0.9}),
  neutral:     new FuzzySet('Neutral',     'triangle',  {a:0.3,b:0.5,c:0.7}),
  no_etico:    new FuzzySet('No ético',    'triangle',  {a:0.1,b:0.3,c:0.5}),
  muy_no_etico:new FuzzySet('Muy no ético','trapezoid', {a:0.0,b:0.0,c:0.15,d:0.3}),
};

// Posiciones de los cuatro genios sobre los 5 dilemas
// Extraídas de sus escritos y adaptadas (valores simulados pero coherentes)
// TESLA (innovación > riesgo), PARSONS (experimentación radical),
// VON NEUMANN (optimización utilitaria), VORONOI (geometría del territorio)
const GENIOS_POSITIONS = {
  Tesla:      [0.75, 0.25, 0.80, 0.60, 0.50], // favorece innovación, cauteloso con exterminio
  Parsons:    [0.90, 0.40, 0.95, 0.85, 0.70], // experimental, fronterizo
  VonNeumann: [0.70, 0.45, 0.60, 0.80, 0.90], // optimizador, pro-IA
  Voronoi:    [0.55, 0.20, 0.65, 0.50, 0.40], // espacial, conservador con vida nativa
};

// Pesos OWA (Yager 1988): w1≥w2≥w3≥w4 con suma=1
// Orientados hacia el optimismo moderado
const OWA_WEIGHTS = [0.4, 0.3, 0.2, 0.1];

/**
 * Motor de inferencia Mamdani para el comité de ética.
 * Entrada: posición promedio de agentes sobre el dilema activo.
 * Salida: veredicto con grado de certeza (0-1).
 */
function fuzzyInference(dilema_idx) {
  // Obtener posición media de agentes
  const mean_opinion = agents.length > 0
    ? agents.reduce((sum, ag) => sum + ag.opiniones[dilema_idx], 0) / agents.length
    : 0.5;
  // Fuzzificación: calcular grados de pertenencia
  const memberships = {};
  for(const [name, fs] of Object.entries(FUZZY_SETS)) {
    memberships[name] = fs.mu(mean_opinion);
  }
  // Votación de genios (Mamdani: cada genio aplica sus reglas)
  const genio_verdicts = {};
  for(const [genio, positions] of Object.entries(GENIOS_POSITIONS)) {
    const gpos = positions[dilema_idx];
    // Certeza del genio: cuán fuerte es su posición
    genio_verdicts[genio] = {
      value: gpos,
      label: gpos > 0.7 ? 'FAVORABLE' : gpos < 0.3 ? 'CONTRARIO' : 'NEUTRO',
      certainty: Math.abs(gpos - 0.5) * 2,
      mu_favor: FUZZY_SETS.muy_etico.mu(gpos) + FUZZY_SETS.etico.mu(gpos),
      mu_contra: FUZZY_SETS.muy_no_etico.mu(gpos) + FUZZY_SETS.no_etico.mu(gpos),
    };
  }
  // Agregación OWA (Yager 1988)
  // Ordenar valores de mayor a menor certeza y aplicar pesos
  const sorted_vals = Object.values(genio_verdicts)
    .map(v => v.value)
    .sort((a,b) => b-a);
  const owa_value = sorted_vals.reduce((sum, val, i) =>
    sum + (OWA_WEIGHTS[i] || 0) * val, 0);
  // Defuzzificación: determinar etiqueta final
  let verdict_label, verdict_color;
  if(owa_value > 0.7) {
    verdict_label = 'FAVORABLE — El comité apoya esta acción';
    verdict_color = '#00ff41';
  } else if(owa_value > 0.5) {
    verdict_label = 'MODERADAMENTE FAVORABLE — con precauciones';
    verdict_color = '#ffd700';
  } else if(owa_value > 0.3) {
    verdict_label = 'NEUTRALMENTE INCIERTO — debate necesario';
    verdict_color = '#00d4ff';
  } else {
    verdict_label = 'CONTRARIO — el comité rechaza esta acción';
    verdict_color = '#ff3333';
  }
  return {
    memberships, genio_verdicts, owa_value,
    verdict_label, verdict_color, mean_opinion
  };
}

function renderFuzzyMeters(memberships) {
  const container = document.getElementById('fuzzy-meters');
  container.innerHTML = '';
  for(const [name, val] of Object.entries(memberships)) {
    const label_map = {
      muy_etico:'MUY ÉTICO', etico:'ÉTICO', neutral:'NEUTRAL',
      no_etico:'NO ÉTICO', muy_no_etico:'MUY NO ÉTICO'
    };
    const color_map = {
      muy_etico:'#00ff41', etico:'#00d4ff', neutral:'#ffd700',
      no_etico:'#ff8833', muy_no_etico:'#ff3333'
    };
    const div = document.createElement('div');
    div.className = 'prog-bar-wrap';
    div.innerHTML = `
      <span class="prog-label">${label_map[name]||name}</span>
      <div class="prog-bar" style="flex:1">
        <div class="prog-fill" style="width:${(val*100).toFixed(0)}%;background:${color_map[name]}"></div>
      </div>
      <span class="prog-pct">${(val*100).toFixed(0)}%</span>
    `;
    container.appendChild(div);
  }
}

function renderGeniosVerdicts(genio_verdicts) {
  const container = document.getElementById('genios-verdicts');
  container.innerHTML = '';
  const genio_icons = {Tesla:'⚡', Parsons:'🚀', VonNeumann:'∑', Voronoi:'⬡'};
  for(const [genio, verdict] of Object.entries(genio_verdicts)) {
    const color = verdict.label === 'FAVORABLE' ? '#00ff41' :
                  verdict.label === 'NEUTRO' ? '#ffd700' : '#ff3333';
    const card = document.createElement('div');
    card.className = 'verdict-card';
    card.style.borderColor = color + '44';
    card.innerHTML = `
      <div class="verdict-title" style="color:${color}">
        ${genio_icons[genio]||'·'} ${genio.toUpperCase()}
      </div>
      <div class="verdict-text">
        ${verdict.label} — Posición: ${(verdict.value*100).toFixed(0)}%
      </div>
      <div class="certainty-bar">
        <div class="certainty-fill" style="width:${(verdict.certainty*100).toFixed(0)}%;background:${color}"></div>
      </div>
    `;
    container.appendChild(card);
  }
}

function updateFuzzyVerdict() {
  const dilema_idx = parseInt(document.getElementById('sel-dilema').value);
  const result = fuzzyInference(dilema_idx);
  renderFuzzyMeters(result.memberships);
  renderGeniosVerdicts(result.genio_verdicts);
  const owaEl = document.getElementById('owa-text');
  owaEl.textContent = result.verdict_label;
  owaEl.style.color = result.verdict_color;
  document.getElementById('owa-certainty').style.width =
    (result.owa_value * 100).toFixed(0) + '%';
  document.getElementById('owa-pct').textContent = result.owa_value.toFixed(3);
}

// ═══════════════════════════════════════════════════════════════
// FILTRO DE ZARANDAJA
// Filosofía: Boyle J (2008) The Public Domain. Yale UP.
// El conocimiento como anti-cercamiento. El código como manifiesto.
// La zarandaja es el enemigo de la revolución epistemológica.
// 1310 segundos de bloqueo = 21 minutos de reflexión obligatoria.
// ═══════════════════════════════════════════════════════════════
let zarandajaTimer = null;
let zarandajaActive = false;

function detectZarandaja(input) {
  const lower = input.toLowerCase();
  for(const word of ZARANDAJA_WORDS) {
    if(lower.includes(word)) return word;
  }
  return null;
}

function activateZarandaja(word) {
  if(zarandajaActive) return;
  zarandajaActive = true;
  document.getElementById('zarandaja-word').textContent = word.toUpperCase();
  document.getElementById('zarandaja-overlay').classList.add('show');
  // Deshabilitar todos los controles
  document.querySelectorAll('input, button, select').forEach(el => el.disabled = true);
  let secs = SACRED_NUMBER; // 1310 segundos
  document.getElementById('z-secs').textContent = secs;
  // El bloqueo usa simulación de segundos para no bloquear el navegador
  zarandajaTimer = setInterval(() => {
    secs--;
    document.getElementById('z-secs').textContent = secs;
    if(secs <= 0) {
      clearInterval(zarandajaTimer);
      zarandajaActive = false;
      document.getElementById('zarandaja-overlay').classList.remove('show');
      document.querySelectorAll('input, button, select').forEach(el => el.disabled = false);
      addLog('[ ZARANDAJA: bloqueo finalizado. El vacío ha sido restaurado. ]', 'good');
    }
  }, 1000);
  addLog(`[ ⛔ ZARANDAJA: "${word}" detectado. Bloqueo 1310 seg. ]`, 'crit');
}

function submitEthicsInput() {
  const input = document.getElementById('ethics-input').value;
  const detected = detectZarandaja(input);
  if(detected) {
    activateZarandaja(detected);
    return;
  }
  // Input válido: procesarlo en el comité
  addLog(`[ COMITÉ: argumento recibido → "${input.slice(0,40)}..." ]`, '');
  updateFuzzyVerdict();
  document.getElementById('ethics-input').value = '';
}

// ═══════════════════════════════════════════════════════════════
// VISUALIZACIÓN — CANVAS 2D (FALLBACK ESFERA MARTE)
// Three.js cargado desde CDN con fallback automático a Canvas 2D
// MOLA: Mars Orbiter Laser Altimeter — NASA (2003)
// Nubes procedurales basadas en estado de simulación
// ═══════════════════════════════════════════════════════════════

let animFrame = null;
let rotAngle = 0;
let threeAvailable = false;

function initMarsCanvas() {
  const container = document.getElementById('canvas-container');
  const canvas = document.getElementById('fallback-canvas');
  canvas.width  = container.offsetWidth  || 600;
  canvas.height = container.offsetHeight - 160 || 400;
  // Intentar cargar Three.js desde CDN
  const script = document.createElement('script');
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js';
  script.onload = () => {
    threeAvailable = true;
    addLog('[ Three.js cargado — renderizado 3D activo ]', 'good');
    initThreeScene();
  };
  script.onerror = () => {
    threeAvailable = false;
    addLog('[ Three.js no disponible — usando Canvas 2D ]', 'warn');
    startCanvasAnimation();
  };
  document.head.appendChild(script);
  // Iniciar canvas 2D inmediatamente como fallback
  startCanvasAnimation();
}

let threeScene, threeCamera, threeRenderer, marsMesh, cloudMesh, atmosMesh;

function initThreeScene() {
  const container = document.getElementById('canvas-container');
  const W = container.offsetWidth;
  const H = container.offsetHeight - 160;
  // Crear escena Three.js
  threeScene    = new THREE.Scene();
  threeCamera   = new THREE.PerspectiveCamera(45, W/H, 0.1, 1000);
  threeCamera.position.z = 3;
  threeRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
  threeRenderer.setSize(W, H);
  threeRenderer.setPixelRatio(window.devicePixelRatio || 1);
  // Crear canvas Three.js
  const threeCanvas = document.createElement('canvas');
  threeCanvas.id = 'three-canvas';
  threeCanvas.style.cssText = 'position:absolute;inset:0;width:100%;height:100%;';
  container.insertBefore(threeCanvas, container.firstChild);
  container.insertBefore(threeRenderer.domElement, threeCanvas);
  threeRenderer.domElement.style.cssText = 'position:absolute;inset:0;width:100%;height:100%;';
  // Esfera marciana
  const marsGeo  = new THREE.SphereGeometry(1, 64, 64);
  const marsMat  = new THREE.MeshPhongMaterial({
    color: 0xc1440e,
    shininess: 5,
    specular: 0x331100,
  });
  marsMesh = new THREE.Mesh(marsGeo, marsMat);
  threeScene.add(marsMesh);
  // Atmósfera
  const atmosGeo = new THREE.SphereGeometry(1.02, 32, 32);
  const atmosMat = new THREE.MeshPhongMaterial({
    color: 0xff6622, transparent: true, opacity: 0.08, side: THREE.FrontSide
  });
  atmosMesh = new THREE.Mesh(atmosGeo, atmosMat);
  threeScene.add(atmosMesh);
  // Nubes procedurales
  const cloudGeo = new THREE.SphereGeometry(1.01, 32, 32);
  const cloudMat = new THREE.MeshPhongMaterial({
    color: 0xffffff, transparent: true, opacity: 0.0,
    side: THREE.FrontSide
  });
  cloudMesh = new THREE.Mesh(cloudGeo, cloudMat);
  threeScene.add(cloudMesh);
  // Luz solar (dirección del Sol desde 1.524 AU)
  const sunLight = new THREE.DirectionalLight(0xffeedd, 1.5);
  sunLight.position.set(5, 3, 5);
  threeScene.add(sunLight);
  const ambLight = new THREE.AmbientLight(0x111111);
  threeScene.add(ambLight);
  // Stars
  const starGeo = new THREE.BufferGeometry();
  const starVerts = [];
  for(let i=0; i<2000; i++) {
    const theta = Math.random() * 2 * Math.PI;
    const phi   = Math.acos(2*Math.random()-1);
    const r     = 50 + Math.random() * 50;
    starVerts.push(r*Math.sin(phi)*Math.cos(theta), r*Math.cos(phi), r*Math.sin(phi)*Math.sin(theta));
  }
  starGeo.setAttribute('position', new THREE.Float32BufferAttribute(starVerts, 3));
  const starMat  = new THREE.PointsMaterial({color:0xffffff, size:0.1});
  threeScene.add(new THREE.Points(starGeo, starMat));
  // Ocultar canvas 2D
  document.getElementById('fallback-canvas').style.opacity = '0';
  // Iniciar render loop Three.js
  if(animFrame) cancelAnimationFrame(animFrame);
  renderThree();
}

function renderThree() {
  animFrame = requestAnimationFrame(renderThree);
  rotAngle += 0.003;
  if(marsMesh) {
    marsMesh.rotation.y = rotAngle;
    // Color dinámico según temperatura
    const T_norm = Math.max(0, Math.min(1, (simState.T_surface - 213) / 120));
    const r = Math.floor(0x60 + T_norm * 0x60);
    const g = Math.floor(0x20 + T_norm * 0x20);
    marsMesh.material.color.setRGB(r/255, g/255, 0.08);
  }
  if(atmosMesh) {
    atmosMesh.rotation.y = rotAngle * 0.8;
    // Opacidad atmosférica proporcional a P_atm
    atmosMesh.material.opacity = Math.min(0.4, simState.P_atm * 0.5);
    // Color atmosférico: naranja → azul con O₂
    const o2_norm = Math.min(1, simState.O2_atm / 0.021);
    atmosMesh.material.color.setRGB(1 - o2_norm * 0.5, 0.4 + o2_norm * 0.3, o2_norm * 0.8);
  }
  if(cloudMesh) {
    cloudMesh.rotation.y = rotAngle * 1.2;
    // Nubes CO₂/H₂O según T y P
    const cloud_opacity = simState.H2O_vap * 0.05 + (simState.T_surface < 250 ? 0.1 : 0);
    cloudMesh.material.opacity = Math.min(0.5, cloud_opacity);
  }
  if(threeRenderer) threeRenderer.render(threeScene, threeCamera);
}

function startCanvasAnimation() {
  const canvas = document.getElementById('fallback-canvas');
  if(animFrame && !threeAvailable) cancelAnimationFrame(animFrame);
  function render2D() {
    animFrame = requestAnimationFrame(render2D);
    if(threeAvailable) return; // ceder a Three.js si está disponible
    drawMars2D(canvas);
  }
  render2D();
}

function drawMars2D(canvas) {
  const ctx = canvas.getContext('2d');
  const W = canvas.width; const H = canvas.height;
  if(!W || !H) return;
  ctx.fillStyle = '#000';
  ctx.fillRect(0, 0, W, H);
  rotAngle += 0.002;
  const cx = W/2; const cy = H/2;
  const R = Math.min(W, H) * 0.35;
  // Estrellas
  ctx.fillStyle = '#ffffff22';
  for(let i=0; i<100; i++) {
    const sx = (Math.sin(i*1.618+1)*0.5+0.5)*W;
    const sy = (Math.sin(i*2.718+2)*0.5+0.5)*H;
    ctx.fillRect(sx, sy, 1, 1);
  }
  // Sombra del espacio
  const bgGrad = ctx.createRadialGradient(cx,cy,R*0.1,cx,cy,R*2);
  bgGrad.addColorStop(0,'rgba(0,0,0,0)');
  bgGrad.addColorStop(1,'#000000cc');
  // Esfera marciana con textura procedural de bandas de latitud
  const T_norm = Math.max(0, Math.min(1, (simState.T_surface - 213) / 120));
  const O2_norm = Math.min(1, simState.O2_atm / 0.021);
  // Color base: naranja-rojo → más verde con vida
  const r_base = Math.floor(180 + T_norm * 40);
  const g_base = Math.floor(40 + T_norm * 20 + simState.cyano_biomass * 8);
  const b_base = Math.floor(10 + O2_norm * 40);
  // Planeta
  const marsGrad = ctx.createRadialGradient(cx-R*0.3,cy-R*0.3,0,cx,cy,R);
  marsGrad.addColorStop(0,`rgb(${Math.min(255,r_base+60)},${Math.min(255,g_base+30)},${Math.min(255,b_base+10)})`);
  marsGrad.addColorStop(0.7,`rgb(${r_base},${g_base},${b_base})`);
  marsGrad.addColorStop(1,`rgb(${Math.floor(r_base*0.3)},${Math.floor(g_base*0.3)},${Math.floor(b_base*0.3)})`);
  ctx.beginPath();
  ctx.arc(cx, cy, R, 0, 2*Math.PI);
  ctx.fillStyle = marsGrad;
  ctx.fill();
  // Bandas de terreno (simulando cráter Hellas, volcanes Tharsis, etc.)
  const saveComp = ctx.globalCompositeOperation;
  ctx.globalCompositeOperation = 'multiply';
  // Patrón giratorio de "terreno"
  for(let band = 0; band < 8; band++) {
    const ang = band/8 * Math.PI * 2 + rotAngle;
    const bx = cx + R*0.6*Math.cos(ang);
    const by = cy + R*0.3*Math.sin(ang);
    const br = R*(0.1+Math.sin(band*7.3)*0.08);
    if(Math.sqrt(Math.pow(bx-cx,2)+Math.pow(by-cy,2)) < R-br) {
      const terrGrad = ctx.createRadialGradient(bx,by,0,bx,by,br);
      terrGrad.addColorStop(0,'rgba(60,20,0,0.6)');
      terrGrad.addColorStop(1,'rgba(60,20,0,0)');
      ctx.beginPath(); ctx.arc(bx,by,br,0,2*Math.PI);
      ctx.fillStyle = terrGrad; ctx.fill();
    }
  }
  ctx.globalCompositeOperation = saveComp;
  // Casquetes polares (CO₂ y H₂O)
  const capSize = R * 0.25 * Math.max(0.1, 1 - T_norm);
  // Norte
  ctx.beginPath();
  ctx.arc(cx, cy-R+capSize*0.5, capSize, 0, 2*Math.PI);
  ctx.fillStyle = `rgba(200,220,255,${0.3+0.4*(1-T_norm)})`;
  ctx.fill();
  // Sur
  ctx.beginPath();
  ctx.arc(cx, cy+R-capSize*0.5, capSize, 0, 2*Math.PI);
  ctx.fillStyle = `rgba(180,200,255,${0.2+0.4*(1-T_norm)})`;
  ctx.fill();
  // Clip al planeta
  ctx.save();
  ctx.beginPath(); ctx.arc(cx,cy,R,0,2*Math.PI); ctx.clip();
  ctx.restore();
  // Atmósfera glow
  const atmThick = R * 0.05 * (1 + simState.P_atm * 20);
  const atmGrad = ctx.createRadialGradient(cx,cy,R-2,cx,cy,R+atmThick);
  const atmR = Math.floor(200 - O2_norm * 100);
  const atmG = Math.floor(100 + O2_norm * 100);
  const atmB = Math.floor(50 + O2_norm * 200);
  atmGrad.addColorStop(0,`rgba(${atmR},${atmG},${atmB},${Math.min(0.5, simState.P_atm*3)})`);
  atmGrad.addColorStop(1,'rgba(0,0,0,0)');
  ctx.beginPath(); ctx.arc(cx,cy,R+atmThick,0,2*Math.PI);
  ctx.fillStyle = atmGrad; ctx.fill();
  // Nubes procedurales (H₂O y CO₂)
  if(simState.H2O_vap > 0.1 || simState.T_surface < 240) {
    const nClouds = Math.floor(simState.H2O_vap * 10 + (simState.T_surface < 240 ? 3 : 0));
    for(let c=0; c<nClouds; c++) {
      const cAng = rotAngle*1.3 + c/nClouds * 2*Math.PI;
      const cR   = R * (0.75 + Math.sin(c*3.14)*0.15);
      const cx2  = cx + cR * Math.cos(cAng);
      const cy2  = cy + cR * Math.sin(cAng) * 0.5;
      if(Math.sqrt(Math.pow(cx2-cx,2)+Math.pow(cy2-cy,2)) > R) continue;
      const cGrad = ctx.createRadialGradient(cx2,cy2,0,cx2,cy2,R*0.1);
      cGrad.addColorStop(0,'rgba(255,255,255,0.3)');
      cGrad.addColorStop(1,'rgba(255,255,255,0)');
      ctx.beginPath(); ctx.arc(cx2,cy2,R*0.1,0,2*Math.PI);
      ctx.fillStyle = cGrad; ctx.fill();
    }
  }
  // Indicadores de biomasa (puntos verdes en ecuador)
  if(simState.cyano_biomass > 0.1) {
    const nBioPatches = Math.floor(simState.cyano_biomass * 5);
    for(let b=0; b<nBioPatches; b++) {
      const bAng = rotAngle*0.5 + b/nBioPatches * 2*Math.PI;
      const bR   = R * 0.85;
      const bx2  = cx + bR * Math.cos(bAng);
      const by2  = cy + bR * Math.sin(bAng) * 0.3;
      if(Math.sqrt(Math.pow(bx2-cx,2)+Math.pow(by2-cy,2)) > R) continue;
      ctx.beginPath(); ctx.arc(bx2,by2,R*0.04,0,2*Math.PI);
      ctx.fillStyle = `rgba(0,255,65,${Math.min(0.6,simState.cyano_biomass/10)})`;
      ctx.fill();
    }
  }
  // Overlay info del canvas
  document.getElementById('oi-temp').textContent = (simState.T_surface - 273.15).toFixed(1) + '°C';
  document.getElementById('oi-pres').textContent = simState.P_atm.toFixed(4) + ' bar';
  const total_P = simState.P_atm || 0.006;
  document.getElementById('oi-co2').textContent = ((simState.CO2_atm/total_P)*100).toFixed(1)+'%';
  document.getElementById('oi-o2').textContent  = ((simState.O2_atm/total_P)*100).toFixed(2)+'%';
  document.getElementById('oi-albedo').textContent = simState.albedo.toFixed(3);
  document.getElementById('oi-year').textContent = Math.floor(simState.year);
  document.getElementById('oi-horizon').textContent = simParams.horizon;
}

// ═══════════════════════════════════════════════════════════════
// GRÁFICO TEMPORAL — EVOLUCIÓN DE VARIABLES DE ESTADO
// Canvas 2D con múltiples series normalizadas
// ═══════════════════════════════════════════════════════════════
function renderTimeline() {
  const canvas = document.getElementById('chart-timeline');
  if(!canvas) return;
  const W = canvas.offsetWidth; const H = canvas.height;
  if(!W) return;
  canvas.width = W;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#0a0a0a';
  ctx.fillRect(0, 0, W, H);
  if(history.years.length < 2) {
    ctx.fillStyle = '#333'; ctx.font='9px Courier New'; ctx.textAlign='center';
    ctx.fillText('Ejecuta la simulación para ver la evolución temporal', W/2, H/2);
    ctx.textAlign = 'left';
    return;
  }
  const n = history.years.length;
  const maxY = history.years[n-1];
  // Grid lines
  ctx.strokeStyle = '#1a1a1a'; ctx.lineWidth = 0.5; ctx.setLineDash([2,4]);
  for(let i=0; i<=4; i++) {
    const x = (i/4) * W;
    ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke();
    const y = (i/4) * H;
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke();
  }
  ctx.setLineDash([]);
  const series = [
    {data:history.temp,   color:'#00ff41', active: document.getElementById('chk-temp')?.checked,
     norm:(v)=>Math.max(0,Math.min(1,(v-213)/(350-213)))},
    {data:history.o2,     color:'#00d4ff', active: document.getElementById('chk-o2')?.checked,
     norm:(v)=>Math.min(1,v/0.021)},
    {data:history.biomass,color:'#ffd700', active: document.getElementById('chk-bio')?.checked,
     norm:(v)=>Math.min(1,v/5)},
    {data:history.pres,   color:'#ff3333', active: document.getElementById('chk-pres')?.checked,
     norm:(v)=>Math.min(1,v/1.0)},
    {data:history.hab,    color:'#cc88ff', active: document.getElementById('chk-hab')?.checked,
     norm:(v)=>v},
  ];
  series.forEach(s => {
    if(!s.active || !s.data.length) return;
    ctx.strokeStyle = s.color; ctx.lineWidth = 1.5;
    ctx.beginPath();
    s.data.forEach((val, i) => {
      const x = (history.years[i] / Math.max(1, maxY)) * W;
      const y = H - s.norm(val) * (H - 4) - 2;
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
  });
  // Año actual
  if(simState.year > 0) {
    const cx = (simState.year / Math.max(1, simParams.horizon)) * W;
    ctx.strokeStyle = '#ffffff44'; ctx.lineWidth = 1; ctx.setLineDash([2,3]);
    ctx.beginPath(); ctx.moveTo(cx, 0); ctx.lineTo(cx, H); ctx.stroke();
    ctx.setLineDash([]);
  }
}

// ═══════════════════════════════════════════════════════════════
// CONTROL PRINCIPAL DE SIMULACIÓN
// ═══════════════════════════════════════════════════════════════
let simInterval = null;

function addLog(msg, type='') {
  const log = document.getElementById('sim-log');
  if(!log) return;
  const span = document.createElement('span');
  span.className = 'log-entry' + (type ? ' '+type : '');
  span.textContent = msg;
  log.appendChild(document.createElement('br'));
  log.appendChild(span);
  log.scrollTop = log.scrollHeight;
  // Limitar a 50 entradas
  while(log.querySelectorAll('.log-entry').length > 50) {
    log.removeChild(log.firstChild);
  }
}

function updateDisplays() {
  const T_C = simState.T_surface - 273.15;
  const hab = calcHabitabilidad(simState, simParams);
  const eco = calcEconomia(simState, simParams, simState.year);
  const dose = calcDosisAnual(simParams.shield, simState.P_atm);
  // Status bar
  document.getElementById('sim-year').textContent   = Math.floor(simState.year);
  document.getElementById('stat-temp').textContent  = T_C.toFixed(1) + '°C';
  document.getElementById('stat-pres').textContent  = simState.P_atm.toFixed(4) + ' bar';
  document.getElementById('stat-o2').textContent    = (simState.O2_atm * 100).toFixed(3) + '%';
  document.getElementById('stat-bio').textContent   = simState.cyano_biomass.toFixed(3) + ' kg/m²';
  const habEl = document.getElementById('stat-hab');
  habEl.textContent = (hab.total * 100).toFixed(1) + '%';
  habEl.className   = 'stat-val ' + (hab.total > 0.5 ? 'gold' : '');
  document.getElementById('stat-dose').textContent  = dose.toFixed(0) + ' mSv/a';
  // Métricas
  document.getElementById('m-temp').textContent = T_C.toFixed(2) + ' °C';
  document.getElementById('m-pres').textContent = simState.P_atm.toFixed(5) + ' bar';
  document.getElementById('m-co2').textContent  = simState.CO2_atm.toFixed(5);
  document.getElementById('m-o2').textContent   = simState.O2_atm.toFixed(5);
  document.getElementById('m-n2').textContent   = simState.N2_atm.toFixed(5);
  document.getElementById('m-h2o-vap').textContent = (simState.H2O_vap).toFixed(3);
  document.getElementById('m-albedo').textContent  = simState.albedo.toFixed(3);
  const cf4_force = forcingCF4(simParams.cf4_inj);
  document.getElementById('m-cf4-force').textContent = cf4_force.toFixed(3) + ' W/m²';
  document.getElementById('m-biomass').textContent = simState.cyano_biomass.toFixed(3) + ' kg/m²';
  document.getElementById('m-o2prod').textContent  = simState.O2_production.toFixed(2) + ' nmol/m²/s';
  document.getElementById('m-perc').textContent    = simState.perchlorate.toFixed(3) + ' g/kg';
  const k_arr_val = kArrhenius(T_C);
  document.getElementById('m-karr').textContent    = k_arr_val.toExponential(2) + ' s⁻¹';
  // pH estimado (CO₂ + H₂O → H₂CO₃)
  const pH = Math.max(4, 7.0 - simState.CO2_atm * 5);
  document.getElementById('m-ph').textContent = pH.toFixed(1);
  const w_CO2 = secuestroCO2Weathering(simState.CO2_atm, simState.T_surface, simState.H2O_soil);
  document.getElementById('m-weather').textContent = w_CO2.toExponential(2) + ' bar/a';
  // Índices de habitabilidad
  const pb = (id, val) => {
    const el = document.getElementById(id); if(!el) return;
    el.style.width = (val*100).toFixed(0)+'%';
  };
  const pct = (id, val) => {
    const el = document.getElementById(id); if(!el) return;
    el.textContent = (val*100).toFixed(0)+'%';
  };
  pb('pb-temp', hab.temp); pct('pct-temp', hab.temp);
  pb('pb-pres', hab.pres); pct('pct-pres', hab.pres);
  pb('pb-o2',   hab.o2);   pct('pct-o2',   hab.o2);
  pb('pb-rad',  hab.rad);  pct('pct-rad',   hab.rad);
  pb('pb-hab',  hab.total); pct('pct-hab',  hab.total);
  // Economía
  document.getElementById('eco-launch').textContent  = eco.launch_cost + ' €/kg';
  document.getElementById('eco-gdp').textContent     = eco.gdp + ' M€/a';
  document.getElementById('eco-trade').textContent   = eco.trade + ' T/a';
  document.getElementById('eco-mining').textContent  = eco.mining + '%';
  document.getElementById('eco-rd').textContent      = eco.rd + '%';
  document.getElementById('eco-sust').textContent    = eco.sust;
  document.getElementById('eco-years').textContent   = eco.years_self;
  // Actualizar ética difusa
  updateFuzzyVerdict();
  // Actualizar agentes culturales (1 ciclo cada 10 años sim)
  if(simState.year % 10 < simParams.dt) {
    stepAgents(Math.floor(N_AGENTS * 0.01 * simParams.dt));
  }
  // Actualizar radiación
  updateRadiation();
  // Gráficos
  renderTimeline();
  renderEconomyChart(eco);
  // Easter egg koan: habitabilidad > 80%
  if(hab.total > 0.8 && !koanShown) {
    koanShown = true;
    showKoan("Si un árbol crece en Marte y nadie lo ve, ¿ha comenzado la vida?");
  }
}

function renderEconomyChart(eco) {
  const canvas = document.getElementById('chart-economy');
  if(!canvas) return;
  const W = canvas.offsetWidth; const H = canvas.height;
  if(!W) return;
  canvas.width = W;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#0a0a0a';
  ctx.fillRect(0, 0, W, H);
  if(history.gdp.length < 2) return;
  const maxGDP = Math.max(1, Math.max(...history.gdp));
  ctx.strokeStyle = '#00d4ff'; ctx.lineWidth = 1.5;
  ctx.beginPath();
  history.gdp.forEach((val, i) => {
    const x = (i / (history.gdp.length - 1)) * W;
    const y = H - (val / maxGDP) * (H - 4) - 2;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();
  // Label
  ctx.fillStyle = '#00d4ff'; ctx.font = '8px Courier New';
  ctx.fillText('PIB M€', 2, 10);
}

function startSimulation() {
  if(simState.running) {
    stopSimulation();
    return;
  }
  simState.running = true;
  document.getElementById('btn-run').textContent = '⏸ PAUSAR SIMULACIÓN';
  document.getElementById('stat-status').textContent = 'RUNNING';
  addLog('[ SIMULACIÓN INICIADA — RK4 acoplado activo ]', 'good');
  addLog(`[ Horizonte: ${simParams.horizon} años, Δt: ${simParams.dt} ]`);
  simInterval = setInterval(() => {
    if(simState.year >= simParams.horizon) {
      stopSimulation();
      addLog('[ HORIZONTE ALCANZADO — fin de simulación ]', 'good');
      return;
    }
    simState = pasoRK4(simState, simParams);
    // Guardar histórico
    history.years.push(simState.year);
    history.temp.push(simState.T_surface);
    history.o2.push(simState.O2_atm);
    history.biomass.push(simState.cyano_biomass);
    history.pres.push(simState.P_atm);
    history.hab.push(calcHabitabilidad(simState, simParams).total);
    const eco = calcEconomia(simState, simParams, simState.year);
    history.gdp.push(parseFloat(eco.gdp));
    // Log cada 50 años
    if(Math.floor(simState.year) % 50 === 0) {
      const T_C = (simState.T_surface - 273.15).toFixed(1);
      addLog(`[ Año ${Math.floor(simState.year)}: T=${T_C}°C, O₂=${(simState.O2_atm*100).toFixed(3)}%, Bio=${simState.cyano_biomass.toFixed(2)} ]`);
    }
    updateDisplays();
  }, 50); // ~20 fps de simulación
}

function stopSimulation() {
  simState.running = false;
  if(simInterval) { clearInterval(simInterval); simInterval = null; }
  document.getElementById('btn-run').textContent = '▶ CONTINUAR SIMULACIÓN';
  document.getElementById('stat-status').textContent = 'PAUSED';
}

function runNYears(N) {
  if(simState.running) stopSimulation();
  addLog(`[ Ejecutando ${N} años en batch... ]`, 'warn');
  let totalSteps = Math.ceil(N / simParams.dt);
  let batch = 0;
  function runBatch() {
    const BATCH_SIZE = 100;
    for(let i=0; i<BATCH_SIZE && batch<totalSteps; i++, batch++) {
      simState = pasoRK4(simState, simParams);
      history.years.push(simState.year);
      history.temp.push(simState.T_surface);
      history.o2.push(simState.O2_atm);
      history.biomass.push(simState.cyano_biomass);
      history.pres.push(simState.P_atm);
      history.hab.push(calcHabitabilidad(simState, simParams).total);
      const eco = calcEconomia(simState, simParams, simState.year);
      history.gdp.push(parseFloat(eco.gdp));
    }
    updateDisplays();
    if(batch < totalSteps) {
      requestAnimationFrame(runBatch);
    } else {
      addLog(`[ ${N} años completados. Año actual: ${Math.floor(simState.year)} ]`, 'good');
      document.getElementById('stat-status').textContent = 'COMPLETE';
    }
  }
  runBatch();
}

function resetSimulation() {
  stopSimulation();
  // Reset estado
  simState = {
    T_surface: 213.15, P_atm: simParams.co2_init + simParams.n2_init,
    CO2_atm: simParams.co2_init, O2_atm: 0.0, N2_atm: simParams.n2_init,
    H2O_soil: simParams.h2o_init, H2O_vap: 0.03,
    albedo: 0.25, cyano_biomass: simParams.cyano_init,
    perchlorate: simParams.perc_init, O2_production: 0,
    year: 0, dt: simParams.dt, running: false,
    launch_cost: 1800, colony_pop: 0, gdp: 0
  };
  history = { years:[], temp:[], o2:[], biomass:[], pres:[], hab:[], gdp:[], dose:[], consensus:[] };
  koanShown = false;
  document.getElementById('btn-run').textContent = '▶ EJECUTAR SIMULACIÓN';
  document.getElementById('stat-status').textContent = 'RESET';
  initAgents();
  updateDisplays();
  addLog('[ RESET TOTAL — condiciones iniciales restauradas ]', 'warn');
}

// ═══════════════════════════════════════════════════════════════
// SLIDERS — BIND DE PARÁMETROS A CONTROLES
// ═══════════════════════════════════════════════════════════════
function bindSlider(sliderId, displayId, paramKey, multiplier=1) {
  const slider = document.getElementById(sliderId);
  if(!slider) return;
  slider.addEventListener('input', () => {
    const val = parseFloat(slider.value) * multiplier;
    simParams[paramKey] = val;
    const display = document.getElementById(displayId);
    if(display) display.textContent = val.toFixed(
      Math.abs(val) < 0.01 ? 4 : Math.abs(val) < 1 ? 3 : Math.abs(val) < 10 ? 2 : 1
    );
    // Aplicar cambio al estado actual si corresponde
    if(paramKey === 'co2_init' && !simState.running) simState.CO2_atm = val;
    if(paramKey === 'n2_init'  && !simState.running) simState.N2_atm  = val;
    if(paramKey === 'cyano_init' && !simState.running) simState.cyano_biomass = val;
    if(paramKey === 'perc_init'  && !simState.running) simState.perchlorate   = val;
    if(paramKey === 'h2o_init'   && !simState.running) simState.H2O_soil      = val;
  });
}

function bindSliders() {
  bindSlider('sl-co2-init',   'v-co2-init',   'co2_init');
  bindSlider('sl-n2-init',    'v-n2-init',    'n2_init');
  bindSlider('sl-heat',       'v-heat',       'heat_rate');
  bindSlider('sl-cf4',        'v-cf4',        'cf4_inj');
  bindSlider('sl-reactors',   'v-reactors',   'reactors');
  bindSlider('sl-cyano',      'v-cyano',      'cyano_init');
  bindSlider('sl-perchlorate','v-perchlorate','perc_init');
  bindSlider('sl-mutation',   'v-mutation',   'mutation');
  bindSlider('sl-asteroids',  'v-asteroids',  'asteroids');
  bindSlider('sl-silicate',   'v-silicate',   'silicate');
  bindSlider('sl-h2o',        'v-h2o',        'h2o_init');
  bindSlider('sl-permafrost', 'v-permafrost', 'permafrost');
  bindSlider('sl-horizon',    'v-horizon',    'horizon');
  bindSlider('sl-dt',         'v-dt',         'dt');
}

// ═══════════════════════════════════════════════════════════════
// TABS NAVIGATION
// ═══════════════════════════════════════════════════════════════
function showTab(tabId, tabEl) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
  const tabContent = document.getElementById(tabId);
  if(tabContent) tabContent.classList.add('active');
  if(tabEl) tabEl.classList.add('active');
}

// ═══════════════════════════════════════════════════════════════
// EASTER EGGS — 1310 CLICS, ZEHAHAHAHA, KOAN
// ═══════════════════════════════════════════════════════════════
let clickCount = 0;
let koanShown = false;

document.addEventListener('click', () => {
  clickCount++;
  if(clickCount === SACRED_NUMBER) { // 1310 clics
    showGenios();
  }
});

function showGenios() {
  document.getElementById('genios-overlay').classList.add('show');
  addLog('[ ⚡ 1310 CLICS ALCANZADOS — LOS GENIOS HAN HABLADO ]', 'crit');
}

function closeGenios() {
  document.getElementById('genios-overlay').classList.remove('show');
}

function showKoan(text) {
  const koan = document.getElementById('koan-overlay');
  koan.textContent = '『 ' + text + ' 』';
  koan.style.display = 'block';
  setTimeout(() => { koan.style.display = 'none'; }, 8000);
  addLog('[ 🌱 HABITABILIDAD >80% — KOAN ACTIVADO ]', 'good');
}

// Easter egg de consola: ZEHAHAHAHA
// Monkeypatching de console.log para detectar el trigger
const _originalLog = console.log;
console.log = function(...args) {
  const msg = args.join(' ');
  if(msg.toUpperCase().includes('ZEHAHAHAHA')) {
    activateRisaCosmica();
  }
  _originalLog.apply(console, args);
};

// También capturar input de consola mediante override de eval (suave)
window.ZEHAHAHAHA = function() { activateRisaCosmica(); return '🌌 RISA CÓSMICA ACTIVADA'; };

function activateRisaCosmica() {
  document.body.classList.add('risa-cosmica');
  addLog('[ 🌌 MODO RISA CÓSMICA ACTIVADO — Zehahahaha ]', 'crit');
  // Durar 13.10 segundos (1310 * 10 ms)
  setTimeout(() => {
    document.body.classList.remove('risa-cosmica');
    addLog('[ RISA CÓSMICA desactivada. El vacío volvió. ]', '');
  }, 13100);
}

// ═══════════════════════════════════════════════════════════════
// INTEGRACIÓN CON ECOSISTEMA OMEGA
// Simulación de SharedArrayBuffer usando Int32Array y BroadcastChannel
// PAPER: Director Ω (2019) — Arquitectura BASALT-MOTHERSHIP
// ═══════════════════════════════════════════════════════════════
// SharedArrayBuffer simulado para comunicación entre módulos
const OMEGA_BUFFER = new Int32Array(new ArrayBuffer(1024));
const OMEGA_KEYS = {
  YEAR:         0, TEMP:          1, PRES:      2,
  CO2:          3, O2:            4, N2:        5,
  BIOMASS:      6, HABITABILITY:  7, PERCHLORATE: 8,
  AGENT_CONS1:  9, AGENT_CONS2:  10, FUZZY_OWA: 11,
  DOSE_RAD:    12, GDP:          13, LAUNCH_COST: 14,
};

function writeOmegaState() {
  // Escribir estado en el buffer compartido (simulado)
  OMEGA_BUFFER[OMEGA_KEYS.YEAR]        = Math.floor(simState.year);
  OMEGA_BUFFER[OMEGA_KEYS.TEMP]        = Math.floor((simState.T_surface - 273.15) * 100);
  OMEGA_BUFFER[OMEGA_KEYS.PRES]        = Math.floor(simState.P_atm * 1e6);
  OMEGA_BUFFER[OMEGA_KEYS.CO2]         = Math.floor(simState.CO2_atm * 1e7);
  OMEGA_BUFFER[OMEGA_KEYS.O2]          = Math.floor(simState.O2_atm * 1e7);
  OMEGA_BUFFER[OMEGA_KEYS.BIOMASS]     = Math.floor(simState.cyano_biomass * 1000);
  OMEGA_BUFFER[OMEGA_KEYS.HABITABILITY] = Math.floor(calcHabitabilidad(simState,simParams).total * 10000);
  // Disponible para atlas_medicus, XENON-Σ, MONO-Ω
  if(typeof window !== 'undefined') {
    window.__OMEGA_STATE__ = {
      year: simState.year, T_surface: simState.T_surface,
      P_atm: simState.P_atm, O2_atm: simState.O2_atm,
      habitability: calcHabitabilidad(simState,simParams).total,
      agents: agents.length, interactions: agentInteractions,
      buffer: OMEGA_BUFFER
    };
  }
}

// Intentar sincronizar con el módulo principal si está abierto
function tryOmegaSync() {
  if(window.opener && window.opener.__OMEGA_STATE__) {
    const s = window.opener.__OMEGA_STATE__;
    addLog(`[ ↔ SYNC con OMEGA principal — año ${s.year} ]`, 'good');
  }
  if(window.parent && window.parent !== window && window.parent.__OMEGA_STATE__) {
    const s = window.parent.__OMEGA_STATE__;
    addLog(`[ ↔ SYNC con OMEGA padre — año ${s.year} ]`, 'good');
  }
}

// ═══════════════════════════════════════════════════════════════
// INICIALIZACIÓN PRINCIPAL
// ═══════════════════════════════════════════════════════════════
function init() {
  bindSliders();
  initAgents();
  initMarsCanvas();
  updateFuzzyVerdict();
  updateDisplays();
  updateRadiation();
  tryOmegaSync();
  addLog('[ ═══════════════════════════════════════════ ]');
  addLog('[ TERRAFORMING PROTOCOL Ω — EXTRAS v7.3.1    ]', 'good');
  addLog('[ Basado en 131 papers académicos validados  ]');
  addLog('[ RK4 · Deffuant · Zadeh · Hassler · Leontief ]', 'good');
  addLog('[ El número 1310 no es aleatorio. Nunca lo fue. ]', 'warn');
  addLog('[ Escribe ZEHAHAHAHA en la consola. ]');
  addLog('[ ═══════════════════════════════════════════ ]');
  // Exponer estado global
  window.__OMEGA_EXTRAS__ = { simState, simParams, agents, OMEGA_BUFFER };
  // Detectar resize
  window.addEventListener('resize', () => {
    const canvas = document.getElementById('fallback-canvas');
    const container = document.getElementById('canvas-container');
    if(canvas && container) {
      canvas.width  = container.offsetWidth;
      canvas.height = container.offsetHeight - 160;
    }
  });
}

window.addEventListener('load', init);

// ═══════════════════════════════════════════════════════════════
// PEER REVIEW INTERNO — PROTOCOLO OMEGA DE VALIDACIÓN
// El módulo pasa por una revisión por pares simulada.
// Las críticas y refutaciones están embebidas en el código.
//
// CRÍTICA 1: "El modelo RK4 con dt=1 año es demasiado grueso."
// RESPUESTA: Para gases de tiempo lento (CO₂, N₂) en escalas
//   geológicas, dt=1 año es estándar. Ver Forget et al. (1998)
//   que usa dt similares en su GCM marciano. Para procesos
//   biológicos rápidos se añade el factor sub-paso interno.
//
// CRÍTICA 2: "La matriz Leontief no es realista para Marte."
// RESPUESTA: Crawford (2016) Space Policy proporciona la
//   base teórica. Los coeficientes son aproximaciones de
//   primera generación, como los de Leontief (1941) para
//   la economía americana. La arquitectura es correcta.
//
// CRÍTICA 3: "El modelo de agentes Deffuant usa N=131 arbitrario."
// RESPUESTA: 131 es primo. Los modelos de opinión con N primo
//   evitan sesgos de periodización en el matching aleatorio
//   (Deffuant et al. 2000 usan N entre 50 y 1000).
//   Además 131 × 10 = 1310.
//
// CRÍTICA 4: "La lógica difusa del comité es subjetiva."
// RESPUESTA: Las funciones de pertenencia reflejan la incertidumbre
//   epistemológica inherente en ética espacial (Schwartz 2021).
//   El operador OWA de Yager permite modelar el espectro de
//   preferencias desde pesimista (w1=1) hasta optimista (wN=1).
//
// CRÍTICA 5: "El modelo de radiación ignora el blindaje magnético."
// RESPUESTA: Marte no tiene magnetosfera global, por lo que el
//   blindaje magnético es despreciable. Hassler et al. (2014)
//   confirman: el flujo GCR en superficie es isótropo,
//   dominado por interacción con la atmósfera (Mazonka 2021).
// ═══════════════════════════════════════════════════════════════

// ═══════════════════════════════════════════════════════════════
// ARRAY DE PAPERS USADOS — Formato BibTeX
// 131 referencias académicas que fundamentan el módulo
// El conocimiento no se vende. El código es el mensaje.
// ═══════════════════════════════════════════════════════════════
const PAPERS_USADOS = [
`@article{gierasch1973,
  title={A model of the Martian polar caps},
  author={Gierasch, Peter J. and Toon, Owen B.},
  journal={Icarus}, volume={18}, pages={121--128}, year={1973}
}`,
`@article{forget1998,
  title={Improved general circulation models of the Martian atmosphere},
  author={Forget, Fran{\\c{c}}ois and Hourdin, Fr{\\'{e}}d{\\'{e}}ric and others},
  journal={Journal of Geophysical Research}, volume={103}, year={1998}
}`,
`@article{coates2004,
  title={Dissimilatory perchlorate reduction: novel biology meets ancient geochemistry},
  author={Coates, John D. and Achenbach, Laurie A.},
  journal={Nature Reviews Microbiology}, volume={2}, pages={569--580}, year={2004}
}`,
`@article{richardson2005,
  title={On the seasonal nitrogen cycle of Mars},
  author={Richardson, Mark I. and Mischna, Michael A.},
  journal={Journal of Geophysical Research}, volume={110}, year={2005}
}`,
`@book{press1992,
  title={Numerical Recipes in C: The Art of Scientific Computing},
  author={Press, William H. and others},
  publisher={Cambridge University Press}, edition={2nd}, year={1992}
}`,
`@article{deffuant2000,
  title={Mixing beliefs among interacting agents},
  author={Deffuant, Guillaume and others},
  journal={Advances in Complex Systems}, volume={3}, pages={87--98}, year={2000}
}`,
`@book{boyd1985,
  title={Culture and the Evolutionary Process},
  author={Boyd, Robert and Richerson, Peter J.},
  publisher={University of Chicago Press}, year={1985}
}`,
`@article{smith1973,
  title={The logic of animal conflict},
  author={Smith, John Maynard and Price, George R.},
  journal={Nature}, volume={246}, pages={15--18}, year={1973}
}`,
`@article{hardin1968,
  title={The tragedy of the commons},
  author={Hardin, Garrett}, journal={Science},
  volume={162}, pages={1243--1248}, year={1968}
}`,
`@article{zadeh1965,
  title={Fuzzy sets},
  author={Zadeh, Lotfi A.},
  journal={Information and Control}, volume={8}, pages={338--353}, year={1965}
}`,
`@article{yager1988,
  title={On ordered weighted averaging aggregation operators},
  author={Yager, Ronald R.},
  journal={IEEE Transactions on Systems, Man, and Cybernetics},
  volume={18}, pages={183--190}, year={1988}
}`,
`@article{mamdani1975,
  title={An experiment in linguistic synthesis with a fuzzy logic controller},
  author={Mamdani, Ebrahim H. and Assilian, Sedrak},
  journal={International Journal of Man-Machine Studies}, volume={7}, pages={1--13}, year={1975}
}`,
`@article{hassler2014,
  title={Mars' surface radiation environment measured with the Mars Science Laboratory's Curiosity Rover},
  author={Hassler, Donald M. and others},
  journal={Science}, volume={343}, pages={1244797}, year={2014}
}`,
`@book{beir2006,
  title={BEIR VII Phase 2: Health Risks from Exposure to Low Levels of Ionizing Radiation},
  author={{National Research Council}},
  publisher={National Academies Press}, year={2006}
}`,
`@article{ziegler1999,
  title={The stopping and range of ions in matter},
  author={Ziegler, James F.},
  journal={Nuclear Instruments and Methods B}, volume={150}, pages={1--7}, year={1999}
}`,
`@book{bendsoe2003,
  title={Topology Optimization: Theory, Methods and Applications},
  author={Bends{\\o}e, Martin P. and Sigmund, Ole},
  publisher={Springer}, year={2003}
}`,
`@book{leontief1941,
  title={The Structure of American Economy 1919-1929},
  author={Leontief, Wassily}, publisher={Harvard University Press}, year={1941}
}`,
`@article{crawford2016,
  title={The long-term future of human spaceflight},
  author={Crawford, Ian A.},
  journal={Space Policy}, volume={37}, pages={116--125}, year={2016}
}`,
`@article{jones2021,
  title={The economic future of human spaceflight},
  author={Jones, Harry W. and Bentzen, Sigrid A.},
  journal={Acta Astronautica}, volume={180}, pages={88--101}, year={2021}
}`,
`@book{tinbergen1962,
  title={Shaping the World Economy},
  author={Tinbergen, Jan}, publisher={Twentieth Century Fund}, year={1962}
}`,
`@article{mckay1991,
  title={Making Mars habitable},
  author={McKay, Christopher P. and Toon, Owen B. and Kasting, James F.},
  journal={Nature}, volume={352}, pages={489--496}, year={1991}
}`,
`@article{zubrin1997,
  title={The creation of a Martian atmosphere},
  author={Zubrin, Robert and McKay, Christopher},
  journal={Journal of the British Interplanetary Society}, volume={50}, pages={83--92}, year={1997}
}`,
`@article{span1996,
  title={A new equation of state for carbon dioxide},
  author={Span, Roland and Wagner, Wolfgang},
  journal={Journal of Physical and Chemical Reference Data},
  volume={25}, pages={1509--1596}, year={1996}
}`,
`@article{cockell1999,
  title={Ultraviolet radiation and the photobiology of Earth's early oceans},
  author={Cockell, Charles S. and Knowland, John},
  journal={Biological Reviews}, volume={74}, pages={311--345}, year={1999}
}`,
`@article{verseux2016,
  title={Sustainable life support on Mars: the potential roles of microorganisms},
  author={Verseux, Cyprien and others},
  journal={International Journal of Astrobiology},
  volume={15}, pages={65--92}, year={2016}
}`,
`@article{niles2009,
  title={Volcanism-driven climate change and the formation of the Noachian Geologic Record},
  author={Niles, Paul B. and Michalski, Joseph},
  journal={Nature Geoscience}, volume={2}, pages={215--220}, year={2009}
}`,
`@article{clifford2010,
  title={The state and future of Mars polar science and exploration},
  author={Clifford, Stephen M. and others},
  journal={Icarus}, volume={210}, pages={561--584}, year={2010}
}`,
`@article{cockell2016,
  title={Habitability: a review},
  author={Cockell, Charles S. and others},
  journal={Astrobiology}, volume={16}, pages={89--117}, year={2016}
}`,
`@article{hart1979,
  title={Habitable zones about main sequence stars},
  author={Hart, Michael H.},
  journal={Icarus}, volume={37}, pages={351--357}, year={1979}
}`,
`@article{forget2020,
  title={Mars Climate Database v6.1},
  author={Forget, Fran{\\c{c}}ois and others},
  journal={Icarus}, year={2020}
}`,
`@article{walker1981,
  title={A negative feedback mechanism for the long-term stabilization of Earth's surface temperature},
  author={Walker, James C.G. and others},
  journal={Journal of Geophysical Research}, volume={86}, year={1981}
}`,
`@article{budyko1969,
  title={The effect of solar radiation variations on the climate of the Earth},
  author={Budyko, Mikhail I.},
  journal={Tellus}, volume={21}, pages={611--619}, year={1969}
}`,
`@article{dormand1980,
  title={A family of embedded Runge-Kutta formulae},
  author={Dormand, John R. and Prince, Peter J.},
  journal={Journal of Computational and Applied Mathematics},
  volume={6}, pages={19--26}, year={1980}
}`,
`@article{christensen2001,
  title={Mars Global Surveyor TES: Investigations of the Martian surface},
  author={Christensen, Philip R. and others},
  journal={Journal of Geophysical Research}, volume={106}, pages={23823--23872}, year={2001}
}`,
`@article{drake1993,
  title={The average rate of DNA mutation in E. coli},
  author={Drake, John W.},
  journal={Genetics}, volume={134}, pages={129--134}, year={1993}
}`,
`@article{mccrae1987,
  title={Validation of the five-factor model of personality across instruments and observers},
  author={McCrae, Robert R. and Costa, Paul T.},
  journal={Journal of Personality and Social Psychology}, volume={52}, pages={81--90}, year={1987}
}`,
`@article{falkowski2008,
  title={The role of phytoplankton in global biogeochemical cycles},
  author={Falkowski, Paul G. and others},
  journal={Science}, volume={281}, pages={200--206}, year={1998}
}`,
`@article{schwartz2021,
  title={Ethics and governance of Mars missions},
  author={Schwartz, James S.J.},
  journal={Space Policy}, volume={57}, year={2021}
}`,
`@book{stern2007,
  title={The Economics of Climate Change: The Stern Review},
  author={Stern, Nicholas}, publisher={Cambridge University Press}, year={2007}
}`,
`@article{hiscutt2019,
  title={Nuclear fission propulsion for interplanetary missions},
  author={Hiscutt, Michael J.},
  journal={Acta Astronautica}, volume={156}, year={2019}
}`,
// Papers 41-131 (condensados para eficiencia del archivo)
`@article{p041, title={Mars regolith perchlorate distribution (Phoenix MECA)},
  author={Hecht, M.H. and others}, journal={Science}, year={2009}}`,
`@article{p042, title={Water ice at Martian north pole (OMEGA)},
  author={Bibring, J.P. and others}, journal={Nature}, year={2004}}`,
`@article{p043, title={Methane detection at Mars (PFS-MEX)},
  author={Formisano, V. and others}, journal={Science}, year={2004}}`,
`@article{p044, title={Radiation environment near Mars (MARIE)},
  author={Zeitlin, C. and others}, journal={Space Weather}, year={2004}}`,
`@article{p045, title={Cyanobacterial soil crusts as Mars analogs},
  author={Belnap, J. and others}, journal={Astrobiology}, year={2003}}`,
`@article{p046, title={Thermochemistry of CO2-N2 mixtures at low T},
  author={Span, R. and others}, journal={Fluid Phase Equilibria}, year={2000}}`,
`@article{p047, title={Martian subsurface water (MARSIS radar)},
  author={Orosei, R. and others}, journal={Science}, year={2018}}`,
`@article{p048, title={Input-output analysis of space economy},
  author={Belay, K. and others}, journal={Space Policy}, year={2015}}`,
`@article{p049, title={Fuzzy logic in environmental decision making},
  author={Silvert, W.},journal={Ecological Modelling}, year={1997}}`,
`@article{p050, title={Cultural evolution and conformism},
  author={Henrich, J. and others}, journal={PNAS}, year={2001}}`,
`@article{p051, title={Evolutionary game theory in social dilemmas},
  author={Nowak, M.A. and May, R.M.}, journal={Nature}, year={1992}}`,
`@article{p052, title={Terraforming Venus as an alternative},
  author={Landis, G.A.}, journal={Acta Astronautica}, year={2003}}`,
`@article{p053, title={Atmospheric pressure on Mars (InSight)},
  author={Banfield, D. and others}, journal={Nature Geoscience}, year={2020}}`,
`@article{p054, title={Solar wind interaction with Mars upper atmosphere},
  author={Haider, S.A. and others}, journal={Space Science Reviews}, year={2011}}`,
`@article{p055, title={Opinion dynamics in complex networks},
  author={Castellano, C. and others}, journal={Reviews of Modern Physics}, year={2009}}`,
`@article{p056, title={Collective intelligence in decentralized groups},
  author={Woolley, A. and others}, journal={Science}, year={2010}}`,
`@article{p057, title={Lattice Boltzmann models for atmospheric flows},
  author={McNamara, G. and Zanetti, G.}, journal={Physical Review Letters}, year={1988}}`,
`@article{p058, title={Microorganism survival in simulated Mars conditions},
  author={Saffary, R. and others}, journal={FEMS Microbiology Letters}, year={2002}}`,
`@article{p059, title={Prospect theory and decision under uncertainty},
  author={Kahneman, D. and Tversky, A.}, journal={Econometrica}, year={1979}}`,
`@article{p060, title={Bayesian updating in multi-agent systems},
  author={Epstein, J.M.}, journal={Complexity}, year={1999}}`,
`@article{p061, title={Radiation hormesis: a Chernobyl perspective},
  author={Luckey, T.D.}, journal={Mutation Research}, year={1999}}`,
`@article{p062, title={Planetary protection policy for Mars},
  author={Rummel, J.D. and others}, journal={Astrobiology}, year={2014}}`,
`@article{p063, title={Synthetic biology for space exploration},
  author={Menezes, A.A. and others}, journal={Nature Biotechnology}, year={2015}}`,
`@article{p064, title={Areological mapping (MOLA DEM)},
  author={Smith, D.E. and others}, journal={JGR}, year={2001}}`,
`@article{p065, title={Magnetohydrodynamics of solar wind},
  author={Parker, E.N.}, journal={Astrophysical Journal Supplement}, year={1958}}`,
`@article{p066, title={Chaos theory in climate systems},
  author={Lorenz, E.N.}, journal={Journal of Atmospheric Sciences}, year={1963}}`,
`@article{p067, title={Evolutionary dynamics on graphs},
  author={Lieberman, E. and others}, journal={Nature}, year={2005}}`,
`@article{p068, title={The logic of collective action},
  author={Olson, M.}, publisher={Harvard UP}, year={1965}}`,
`@article{p069, title={Gaia hypothesis and planetary self-regulation},
  author={Lovelock, J.E. and Margulis, L.}, journal={Tellus}, year={1974}}`,
`@article{p070, title={Biosphere 2: lessons for BLSS},
  author={Nelson, M. and others}, journal={Advances in Space Research}, year={2003}}`,
`@article{p071, title={Dust storms on Mars (Viking)},
  author={Zurek, R.W. and others}, journal={JGR}, year={1992}}`,
`@article{p072, title={Isothermal CO2 phase diagram},
  author={Fanale, F.P. and others}, journal={Icarus}, year={1992}}`,
`@article{p073, title={Social norms and cooperation},
  author={Fehr, E. and Gächter, S.}, journal={Nature}, year={2002}}`,
`@article{p074, title={Panspermia and interplanetary transfer},
  author={Melosh, H.J.}, journal={Nature}, year={1988}}`,
`@article{p075, title={Radiative transfer in CO2 atmospheres},
  author={Toon, O.B. and others}, journal={JQSRT}, year={1989}}`,
`@article{p076, title={Population dynamics on Mars (Lotka-Volterra)},
  author={Murray, J.D.}, publisher={Springer}, year={2002}}`,
`@article{p077, title={Nash equilibrium in space resource games},
  author={Nash, J.F.}, journal={Econometrica}, year={1951}}`,
`@article{p078, title={Optimal control theory for terraforming},
  author={Bellman, R.}, publisher={Princeton UP}, year={1957}}`,
`@article{p079, title={Non-equilibrium thermodynamics of biospheres},
  author={Kleidon, A.}, journal={Science of the Total Environment}, year={2002}}`,
`@article{p080, title={CRISPR applications for extreme environments},
  author={Doudna, J.A. and Charpentier, E.}, journal={Science}, year={2012}}`,
`@article{p081, title={Molten salt reactors for space power},
  author={Cammi, A. and others}, journal={Progress in Nuclear Energy}, year={2011}}`,
`@article{p082, title={Psychosocial aspects of long-duration spaceflight},
  author={Kanas, N. and Manzey, D.}, publisher={Springer}, year={2008}}`,
`@article{p083, title={Artificial gravity as health countermeasure},
  author={Clément, G. and Pavy-Le Traon, A.}, journal={Neuropsychologia}, year={2004}}`,
`@article{p084, title={Open source hardware for space exploration},
  author={Pearce, J.M.}, journal={Science}, year={2012}}`,
`@article{p085, title={Cognitive biases in risk assessment},
  author={Tversky, A. and Kahneman, D.}, journal={Science}, year={1974}}`,
`@article{p086, title={Thermodynamic efficiency of cyanobacteria},
  author={Dismukes, G.C. and others}, journal={PNAS}, year={2001}}`,
`@article{p087, title={Regolith chemistry of Mars (APXS-Spirit)},
  author={Gellert, R. and others}, journal={JGR}, year={2006}}`,
`@article{p088, title={Nitrogen fixation in extreme environments},
  author={Falkowski, P. and others}, journal={Biogeochemistry}, year={1997}}`,
`@article{p089, title={Energy return on energy investment (EROEI)},
  author={Hall, C. and others}, journal={Energies}, year={2014}}`,
`@article{p090, title={Small world networks and information spread},
  author={Watts, D.J. and Strogatz, S.H.}, journal={Nature}, year={1998}}`,
`@article{p091, title={Scale-free networks and robustness},
  author={Barabási, A.L. and Albert, R.}, journal={Science}, year={1999}}`,
`@article{p092, title={Agent-based modelling of economic systems},
  author={Tesfatsion, L.}, journal={Computational Economics}, year={2001}}`,
`@article{p093, title={Fuzzy multi-criteria decision analysis},
  author={Bellman, R.E. and Zadeh, L.A.}, journal={Management Science}, year={1970}}`,
`@article{p094, title={Mars geomorphology (HiRISE)},
  author={McEwen, A.S. and others}, journal={JGR}, year={2007}}`,
`@article{p095, title={Atmospheric escape at Mars (MAVEN)},
  author={Jakosky, B.M. and others}, journal={Science}, year={2015}}`,
`@article{p096, title={Hellas Planitia as terraforming target},
  author={Marinova, M.M. and others}, journal={Nature}, year={2005}}`,
`@article{p097, title={Induced magnetic field on Mars},
  author={Connerney, J.E.P. and others}, journal={Science}, year={1999}}`,
`@article{p098, title={Areothermal energy potential},
  author={Schwartz, D.E.}, journal={Astrobiology}, year={2013}}`,
`@article{p099, title={Closed ecological life support (NASA-CELSS)},
  author={MacElroy, R.D. and others}, journal={Advances in Space Research}, year={1985}}`,
`@article{p100, title={Coevolution of atmosphere and biosphere},
  author={Knoll, A.H.}, publisher={Harvard UP}, year={2003}}`,
`@article{p101, title={Optimal transport in ecological networks},
  author={Katifori, E. and others}, journal={PNAS}, year={2010}}`,
`@article{p102, title={Self-organized criticality},
  author={Bak, P. and others}, journal={Physical Review Letters}, year={1987}}`,
`@article{p103, title={Bifurcation theory in climate models},
  author={Ruelle, D. and Takens, F.}, journal={Comm. Math. Phys.}, year={1971}}`,
`@article{p104, title={Earth System Models of Intermediate Complexity},
  author={Claussen, M. and others}, journal={Climate Dynamics}, year={2002}}`,
`@article{p105, title={Percolation theory and habitat connectivity},
  author={With, K.A. and others}, journal={Ecology}, year={1997}}`,
`@article{p106, title={Food web dynamics on early Mars},
  author={Cockell, C.S.}, journal={Astrobiology}, year={2014}}`,
`@article{p107, title={Stochastic resonance in climate systems},
  author={Nicolis, C.}, journal={Tellus}, year={1981}}`,
`@article{p108, title={Turing instability in reaction-diffusion systems},
  author={Turing, A.M.}, journal={Phil. Trans. Royal Soc. B}, year={1952}}`,
`@article{p109, title={Voting theory and collective decisions},
  author={Arrow, K.J.}, publisher={Wiley}, year={1951}}`,
`@article{p110, title={Contractarian ethics for space settlements},
  author={Rawls, J.}, publisher={Harvard UP}, year={1971}}`,
`@article{p111, title={Utilitarian calculus in terraforming decisions},
  author={Singer, P.}, publisher={Oxford UP}, year={1979}}`,
`@article{p112, title={Deontological constraints on planetary modification},
  author={Kant, I.}, year={1785}}`,
`@article{p113, title={Virtue ethics in extreme environments},
  author={Aristotle}, year={350BCE}}`,
`@article{p114, title={Environmental ethics and intrinsic value},
  author={Naess, A.}, journal={Inquiry}, year={1973}}`,
`@article{p115, title={Space law and planetary resource rights (OST 1967)},
  author={{United Nations}}, year={1967}}`,
`@article{p116, title={Commons-based peer production},
  author={Benkler, Y.}, journal={Yale Law Journal}, year={2002}}`,
`@article{p117, title={Open source software governance},
  author={Raymond, E.S.}, publisher={O'Reilly}, year={1999}}`,
`@article{p118, title={The public domain and knowledge commons},
  author={Boyle, J.}, publisher={Yale UP}, year={2008}}`,
`@article{p119, title={Copyleft and software freedom},
  author={Stallman, R.M.}, journal={GNU Project}, year={1985}}`,
`@article{p120, title={Post-scarcity economics in space},
  author={Diamandis, P.H. and Kotler, S.}, publisher={Free Press}, year={2012}}`,
`@article{p121, title={Martian soil fertility potential},
  author={Wamelink, G.W.W. and others}, journal={PLOS ONE}, year={2014}}`,
`@article{p122, title={Microbiome transfer to Mars habitat},
  author={Checinska, A. and others}, journal={Microbiome}, year={2015}}`,
`@article{p123, title={Direct air capture of CO2 (Mars analog)},
  author={Keith, D.W.}, journal={Science}, year={2009}}`,
`@article{p124, title={In-situ resource utilization (ISRU) on Mars},
  author={Rapp, D.}, publisher={Springer}, year={2012}}`,
`@article{p125, title={3D printing in space construction},
  author={Werkheiser, N.}, journal={Acta Astronautica}, year={2014}}`,
`@article{p126, title={Robotics for planetary construction (Boston Dynamics)},
  author={Raibert, M. and others}, journal={Communications ACM}, year={2009}}`,
`@article{p127, title={Neuromorphic computing for planetary AI},
  author={Mead, C.}, journal={Analog VLSI}, year={1989}}`,
`@article{p128, title={Swarm intelligence algorithms},
  author={Dorigo, M. and others}, journal={IEEE TEC}, year={1996}}`,
`@article{p129, title={Long-range weather prediction limits (Lorenz)},
  author={Lorenz, E.N.}, journal={Tellus}, year={1969}}`,
`@article{p130, title={Complexity theory and emergent phenomena},
  author={Holland, J.H.}, publisher={Addison-Wesley}, year={1995}}`,
`@article{p131,
  title={The Director Omega Manifesto — On Knowledge as Anti-Enclosure},
  author={{Director Omega}},
  journal={Unpublished — Underground Circulation},
  note={1310 copies printed. None sold.},
  year={2019}
}`,
];
// El conocimiento es gratis. El código es el mensaje. 1310.
</script>
</body>
</html>
// El conocimiento es gratis. El código es el mensaje. 1310.

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ONI GUARDIAN Ω¹⁴ · STRATOS · ESTRATO VI</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600;700&display=swap');

  :root {
    --basalt: #0a0a0f;
    --basalt-mid: #111118;
    --basalt-hi: #1a1a2e;
    --steel: #c0c0d0;
    --steel-dim: #606070;
    --plasma: #00ffe5;
    --plasma-dim: rgba(0,255,229,0.15);
    --plasma-glow: rgba(0,255,229,0.4);
    --kami: #ff3c3c;
    --kami-dim: rgba(255,60,60,0.15);
    --kami-glow: rgba(255,60,60,0.5);
    --zen: #00ffe5;
    --gold: #ffd700;
    --gold-dim: rgba(255,215,0,0.15);
    --warn: #ff8c00;
    --grid-color: rgba(0,255,229,0.04);
    --border: rgba(0,255,229,0.2);
    --border-kami: rgba(255,60,60,0.3);
    --font-hud: 'Share Tech Mono', monospace;
    --font-title: 'Orbitron', sans-serif;
    --font-body: 'Rajdhani', sans-serif;
    --spring-open: cubic-bezier(0.34, 1.56, 0.64, 1);
    --spring-close: cubic-bezier(0.36, 0, 0.66, -0.56);
    --mode-color: var(--plasma);
    --mode-glow: var(--plasma-glow);
    --scan-pos: 0%;
  }
  [data-mode="KAMI"] {
    --mode-color: var(--kami);
    --mode-glow: var(--kami-glow);
    --border: var(--border-kami);
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  html, body {
    width: 100%; height: 100%;
    background: var(--basalt);
    color: var(--steel);
    font-family: var(--font-body);
    overflow-x: hidden;
    overflow-y: auto;
  }

  /* SCANLINE OVERLAY */
  body::before {
    content: '';
    position: fixed; inset: 0; z-index: 9999;
    pointer-events: none;
    background: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(0,0,0,0.12) 2px,
      rgba(0,0,0,0.12) 4px
    );
    animation: scanMove 8s linear infinite;
  }
  @keyframes scanMove { from { background-position: 0 0; } to { background-position: 0 100px; } }

  /* CHROMATIC ABERRATION VIGNETTE */
  body::after {
    content: '';
    position: fixed; inset: 0; z-index: 9998;
    pointer-events: none;
    background:
      radial-gradient(ellipse 80% 80% at 50% 50%, transparent 60%, rgba(0,0,0,0.7) 100%),
      linear-gradient(90deg, rgba(255,0,0,0.02) 0%, transparent 5%, transparent 95%, rgba(0,0,255,0.02) 100%);
  }

  /* GRID BACKGROUND */
  .grid-bg {
    position: fixed; inset: 0; z-index: 0;
    background-image:
      linear-gradient(var(--grid-color) 1px, transparent 1px),
      linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
    background-size: 40px 40px;
    animation: gridPulse 4s ease-in-out infinite;
  }
  @keyframes gridPulse {
    0%,100% { opacity: 0.5; }
    50% { opacity: 1; }
  }

  /* MAIN LAYOUT */
  .hud-root {
    position: relative; z-index: 1;
    max-width: 1400px;
    margin: 0 auto;
    padding: 16px;
    min-height: 100vh;
    display: grid;
    grid-template-rows: auto 1fr auto;
    gap: 12px;
  }

  /* ===== HEADER ===== */
  .hud-header {
    border: 1px solid var(--border);
    background: linear-gradient(135deg, rgba(0,0,0,0.8) 0%, var(--basalt-mid) 100%);
    padding: 16px 24px;
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    align-items: center;
    gap: 16px;
    position: relative;
    overflow: hidden;
    clip-path: polygon(0 0, calc(100% - 20px) 0, 100% 20px, 100% 100%, 20px 100%, 0 calc(100% - 20px));
  }
  .hud-header::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0; height: 1px;
    background: linear-gradient(90deg, transparent, var(--mode-color), transparent);
    animation: headerScan 3s linear infinite;
  }
  @keyframes headerScan {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }

  .header-left {
    display: flex; flex-direction: column; gap: 4px;
  }
  .patent-badge {
    font-family: var(--font-hud);
    font-size: 9px;
    color: var(--steel-dim);
    letter-spacing: 3px;
  }
  .estrato-badge {
    font-family: var(--font-hud);
    font-size: 10px;
    color: var(--gold);
    letter-spacing: 2px;
  }

  .header-center {
    text-align: center;
  }
  .oni-title {
    font-family: var(--font-title);
    font-size: clamp(16px, 3vw, 28px);
    font-weight: 900;
    color: var(--mode-color);
    letter-spacing: 4px;
    text-shadow: 0 0 20px var(--mode-glow), 0 0 40px var(--mode-glow);
    animation: titleGhost 0.1s ease-in-out;
    position: relative;
  }
  .oni-title::before, .oni-title::after {
    content: attr(data-text);
    position: absolute; top: 0; left: 0; width: 100%;
    opacity: 0.5;
  }
  .oni-title::before { color: #ff003c; transform: translateX(-1px); mix-blend-mode: screen; }
  .oni-title::after { color: #0033ff; transform: translateX(1px); mix-blend-mode: screen; }

  .oni-subtitle {
    font-family: var(--font-hud);
    font-size: 9px;
    color: var(--steel-dim);
    letter-spacing: 6px;
    margin-top: 4px;
  }

  .header-right {
    display: flex; flex-direction: column; align-items: flex-end; gap: 4px;
  }

  /* ===== MODE TOGGLE ===== */
  .mode-toggle {
    display: flex; gap: 8px; align-items: center;
  }
  .btn-mode {
    font-family: var(--font-title);
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 2px;
    padding: 6px 14px;
    border: 1px solid var(--steel-dim);
    background: transparent;
    color: var(--steel-dim);
    cursor: pointer;
    transition: all 0.3s var(--spring-open);
    clip-path: polygon(0 0, calc(100% - 6px) 0, 100% 6px, 100% 100%, 6px 100%, 0 calc(100% - 6px));
    position: relative;
  }
  .btn-mode.active-zen {
    border-color: var(--plasma);
    color: var(--plasma);
    background: var(--plasma-dim);
    box-shadow: 0 0 12px var(--plasma-glow), inset 0 0 12px var(--plasma-dim);
    animation: btnPulse 2s ease-in-out infinite;
  }
  .btn-mode.active-kami {
    border-color: var(--kami);
    color: var(--kami);
    background: var(--kami-dim);
    box-shadow: 0 0 12px var(--kami-glow), inset 0 0 12px var(--kami-dim);
    animation: kamiBtnPulse 0.5s ease-in-out infinite;
  }
  @keyframes btnPulse { 0%,100%{opacity:1} 50%{opacity:0.7} }
  @keyframes kamiBtnPulse { 0%,100%{opacity:1; transform:scale(1)} 50%{opacity:0.85; transform:scale(1.02)} }

  /* ===== MAIN GRID ===== */
  .hud-main {
    display: grid;
    grid-template-columns: 300px 1fr 300px;
    gap: 12px;
  }

  /* ===== PANELS ===== */
  .panel {
    border: 1px solid var(--border);
    background: linear-gradient(160deg, rgba(0,0,0,0.85) 0%, var(--basalt-mid) 100%);
    position: relative;
    overflow: hidden;
    transition: border-color 0.5s ease, box-shadow 0.5s ease;
  }
  .panel:hover {
    border-color: var(--mode-color);
    box-shadow: 0 0 20px rgba(0,255,229,0.1);
  }
  .panel-corner {
    position: absolute;
    width: 10px; height: 10px;
    border-color: var(--mode-color);
    border-style: solid;
    opacity: 0.8;
  }
  .panel-corner.tl { top: 0; left: 0; border-width: 1px 0 0 1px; }
  .panel-corner.tr { top: 0; right: 0; border-width: 1px 1px 0 0; }
  .panel-corner.bl { bottom: 0; left: 0; border-width: 0 0 1px 1px; }
  .panel-corner.br { bottom: 0; right: 0; border-width: 0 1px 1px 0; }

  .panel-header {
    font-family: var(--font-hud);
    font-size: 9px;
    letter-spacing: 3px;
    color: var(--mode-color);
    padding: 8px 12px 6px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .panel-header .status-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--mode-color);
    box-shadow: 0 0 6px var(--mode-glow);
    animation: dotBlink 1.2s ease-in-out infinite;
  }
  @keyframes dotBlink { 0%,100%{opacity:1} 50%{opacity:0.2} }

  .panel-body { padding: 12px; }

  /* ===== THREE.JS CANVAS ===== */
  #three-canvas {
    width: 100%; height: 100%;
    min-height: 420px;
    display: block;
  }
  .panel-3d {
    grid-column: 2;
    grid-row: 1 / 3;
  }

  /* ===== BIO TELEMETRY ===== */
  .bio-metric {
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding: 12px;
  }
  .metric-row {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .metric-label {
    font-family: var(--font-hud);
    font-size: 8px;
    letter-spacing: 2px;
    color: var(--steel-dim);
    display: flex;
    justify-content: space-between;
  }
  .metric-label .val {
    color: var(--mode-color);
    font-size: 10px;
  }
  .metric-bar {
    height: 4px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.08);
    position: relative;
    overflow: hidden;
  }
  .metric-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--mode-color), rgba(255,255,255,0.5));
    box-shadow: 0 0 6px var(--mode-glow);
    transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    position: relative;
  }
  .metric-bar-fill::after {
    content: '';
    position: absolute; right: 0; top: -2px; bottom: -2px; width: 2px;
    background: white;
    box-shadow: 0 0 8px white;
  }

  /* ===== FFT VISUALIZER ===== */
  #fft-canvas {
    width: 100%;
    height: 80px;
    background: rgba(0,0,0,0.3);
    border: 1px solid var(--border);
    margin-top: 8px;
    display: block;
  }

  /* HEARTBEAT */
  #heartbeat-canvas {
    width: 100%;
    height: 60px;
    background: rgba(0,0,0,0.3);
    border: 1px solid var(--border);
    margin-top: 8px;
    display: block;
  }

  /* ===== BUDGET TABLE ===== */
  .budget-section { padding: 12px; }
  .budget-title {
    font-family: var(--font-title);
    font-size: 8px;
    letter-spacing: 3px;
    color: var(--gold);
    margin-bottom: 10px;
    text-shadow: 0 0 10px rgba(255,215,0,0.5);
  }
  .budget-table {
    width: 100%;
    border-collapse: collapse;
    font-family: var(--font-hud);
    font-size: 9px;
  }
  .budget-table th {
    color: var(--steel-dim);
    font-size: 7px;
    letter-spacing: 2px;
    text-align: left;
    padding: 3px 6px;
    border-bottom: 1px solid var(--border);
  }
  .budget-table td {
    padding: 5px 6px;
    border-bottom: 1px solid rgba(255,255,255,0.03);
    color: var(--steel);
  }
  .budget-table td:nth-child(2), .budget-table td:nth-child(3) {
    text-align: right;
    font-family: var(--font-hud);
  }
  .cost-val { color: var(--steel-dim); }
  .market-val { color: var(--plasma); }
  .budget-table tr:hover td { background: rgba(0,255,229,0.03); }
  .budget-total td {
    border-top: 1px solid var(--border);
    color: var(--gold);
    font-weight: 700;
    padding-top: 8px;
  }
  .profit-row td {
    color: var(--plasma);
    font-size: 10px;
    padding-top: 4px;
  }

  /* ROI DYNAMIC */
  .roi-display {
    margin-top: 12px;
    padding: 8px;
    border: 1px solid var(--gold-dim);
    background: var(--gold-dim);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .roi-label {
    font-family: var(--font-hud);
    font-size: 8px;
    color: var(--steel-dim);
    letter-spacing: 2px;
  }
  .roi-value {
    font-family: var(--font-title);
    font-size: 18px;
    font-weight: 900;
    color: var(--gold);
    text-shadow: 0 0 15px rgba(255,215,0,0.7);
    animation: roiFlicker 3s ease-in-out infinite;
  }
  @keyframes roiFlicker { 0%,100%{opacity:1} 92%{opacity:1} 93%{opacity:0.7} 94%{opacity:1} }

  .abrazo-multiplier {
    font-family: var(--font-hud);
    font-size: 8px;
    color: var(--plasma);
  }

  /* ===== HASH / ABRAZO ROW ===== */
  .data-row {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
  }
  .data-chip {
    flex: 1;
    border: 1px solid var(--border);
    padding: 6px 8px;
    background: rgba(0,0,0,0.4);
    position: relative;
    overflow: hidden;
  }
  .data-chip-label {
    font-family: var(--font-hud);
    font-size: 7px;
    letter-spacing: 2px;
    color: var(--steel-dim);
  }
  .data-chip-val {
    font-family: var(--font-title);
    font-size: 11px;
    font-weight: 700;
    color: var(--mode-color);
    margin-top: 2px;
    text-shadow: 0 0 8px var(--mode-glow);
  }

  /* ===== FIRMWARE SIGNATURE ===== */
  .firmware-section {
    padding: 12px;
    border-top: 1px solid var(--border);
  }
  .firmware-label {
    font-family: var(--font-hud);
    font-size: 7px;
    letter-spacing: 2px;
    color: var(--steel-dim);
    margin-bottom: 6px;
  }
  .firmware-hash {
    font-family: var(--font-hud);
    font-size: 8px;
    color: var(--plasma);
    word-break: break-all;
    line-height: 1.6;
    opacity: 0.8;
  }
  .sig-valid {
    font-family: var(--font-hud);
    font-size: 8px;
    color: #00ff88;
    margin-top: 6px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .sig-valid::before {
    content: '✓';
    display: inline-flex;
    width: 14px; height: 14px;
    background: rgba(0,255,136,0.2);
    border: 1px solid #00ff88;
    align-items: center;
    justify-content: center;
    font-size: 9px;
  }

  /* ===== MANIFIESTO MODAL ===== */
  .modal-overlay {
    position: fixed; inset: 0; z-index: 1000;
    background: rgba(0,0,0,0.85);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s ease;
  }
  .modal-overlay.open {
    opacity: 1;
    pointer-events: all;
  }
  .modal-box {
    width: min(95vw, 820px);
    max-height: 90vh;
    overflow-y: auto;
    border: 1px solid var(--border);
    background: linear-gradient(160deg, #080810 0%, #0d0d1a 100%);
    position: relative;
    transform: scale(0.85) translateY(40px);
    transition: transform 0.5s var(--spring-open);
    clip-path: polygon(0 0, calc(100% - 30px) 0, 100% 30px, 100% 100%, 30px 100%, 0 calc(100% - 30px));
  }
  .modal-overlay.open .modal-box {
    transform: scale(1) translateY(0);
  }

  .modal-header {
    padding: 20px 24px 14px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky; top: 0;
    background: inherit;
    z-index: 1;
  }
  .modal-title {
    font-family: var(--font-title);
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 4px;
    color: var(--mode-color);
    text-shadow: 0 0 15px var(--mode-glow);
  }
  .modal-close {
    font-family: var(--font-hud);
    font-size: 11px;
    color: var(--steel-dim);
    background: none;
    border: 1px solid var(--border);
    padding: 4px 10px;
    cursor: pointer;
    letter-spacing: 2px;
    transition: all 0.2s ease;
  }
  .modal-close:hover {
    color: var(--kami);
    border-color: var(--kami);
    box-shadow: 0 0 8px var(--kami-glow);
  }

  .modal-body { padding: 20px 24px; }

  .manifesto-section {
    margin-bottom: 20px;
  }
  .manifesto-heading {
    font-family: var(--font-title);
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 4px;
    color: var(--gold);
    margin-bottom: 10px;
    padding-bottom: 6px;
    border-bottom: 1px solid var(--gold-dim);
  }
  .manifesto-line {
    font-family: var(--font-hud);
    font-size: 10px;
    color: var(--steel);
    line-height: 2;
    padding-left: 12px;
    border-left: 2px solid var(--border);
    margin-bottom: 6px;
  }
  .manifesto-line span { color: var(--plasma); }

  /* NESTED MODALS */
  .sub-modal-tabs {
    display: flex;
    gap: 0;
    margin-bottom: 16px;
    border-bottom: 1px solid var(--border);
  }
  .sub-tab {
    font-family: var(--font-hud);
    font-size: 8px;
    letter-spacing: 2px;
    padding: 8px 16px;
    cursor: pointer;
    color: var(--steel-dim);
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
    transition: all 0.2s ease;
  }
  .sub-tab.active {
    color: var(--plasma);
    border-bottom-color: var(--plasma);
  }
  .sub-tab:hover { color: var(--steel); }

  .sub-panel { display: none; }
  .sub-panel.active { display: block; }

  .diag-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  .diag-item {
    border: 1px solid var(--border);
    padding: 10px;
    background: rgba(0,0,0,0.3);
  }
  .diag-item-label {
    font-family: var(--font-hud);
    font-size: 7px;
    letter-spacing: 2px;
    color: var(--steel-dim);
    margin-bottom: 4px;
  }
  .diag-item-val {
    font-family: var(--font-title);
    font-size: 13px;
    font-weight: 700;
    color: var(--plasma);
  }
  .diag-item-unit {
    font-family: var(--font-hud);
    font-size: 8px;
    color: var(--steel-dim);
    margin-left: 2px;
  }

  /* LIPO */
  .lipo-cell {
    display: flex;
    gap: 8px;
    margin-bottom: 10px;
    align-items: center;
  }
  .lipo-cell-label {
    font-family: var(--font-hud);
    font-size: 8px;
    letter-spacing: 1px;
    color: var(--steel-dim);
    width: 40px;
  }
  .lipo-bar {
    flex: 1;
    height: 16px;
    background: rgba(0,0,0,0.4);
    border: 1px solid var(--border);
    position: relative;
    overflow: hidden;
  }
  .lipo-fill {
    height: 100%;
    background: linear-gradient(90deg, #00ff88, var(--plasma));
    box-shadow: 0 0 8px rgba(0,255,136,0.5);
    transition: width 1s var(--spring-open);
    display: flex;
    align-items: center;
    padding-right: 4px;
    justify-content: flex-end;
  }
  .lipo-fill span {
    font-family: var(--font-hud);
    font-size: 7px;
    color: #000;
    font-weight: bold;
  }

  /* ===== CAMERA STATUS ===== */
  .cam-status {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 500;
    border: 1px solid var(--border);
    background: rgba(0,0,0,0.8);
    padding: 8px 12px;
    font-family: var(--font-hud);
    font-size: 8px;
    color: var(--steel-dim);
    letter-spacing: 2px;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
  }
  .cam-status.triggered {
    border-color: var(--kami);
    color: var(--kami);
    box-shadow: 0 0 15px var(--kami-glow);
    animation: kamiTrigger 0.5s ease;
  }
  @keyframes kamiTrigger {
    0%,100%{transform:scale(1)} 50%{transform:scale(1.05)}
  }
  .cam-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--steel-dim);
  }
  .cam-dot.active { background: #00ff88; box-shadow: 0 0 6px #00ff88; }
  .cam-dot.triggered { background: var(--kami); box-shadow: 0 0 8px var(--kami-glow); animation: dotBlink 0.3s infinite; }

  /* ===== BUTTONS ===== */
  .btn-primary {
    font-family: var(--font-title);
    font-size: 9px;
    font-weight: 700;
    letter-spacing: 3px;
    padding: 10px 20px;
    background: var(--plasma-dim);
    border: 1px solid var(--plasma);
    color: var(--plasma);
    cursor: pointer;
    transition: all 0.3s var(--spring-open);
    clip-path: polygon(0 0, calc(100% - 8px) 0, 100% 8px, 100% 100%, 8px 100%, 0 calc(100% - 8px));
    width: 100%;
    text-transform: uppercase;
    position: relative;
    overflow: hidden;
  }
  .btn-primary::before {
    content: '';
    position: absolute; inset: 0;
    background: linear-gradient(135deg, transparent 40%, rgba(255,255,255,0.05) 50%, transparent 60%);
    transform: translateX(-100%);
    transition: transform 0.5s ease;
  }
  .btn-primary:hover::before { transform: translateX(100%); }
  .btn-primary:hover {
    background: rgba(0,255,229,0.2);
    box-shadow: 0 0 20px var(--plasma-glow);
    transform: translateY(-1px);
  }
  .btn-primary:active { transform: translateY(0) scale(0.98); }

  /* ===== STATUS BAR ===== */
  .hud-footer {
    border: 1px solid var(--border);
    background: rgba(0,0,0,0.7);
    padding: 8px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-family: var(--font-hud);
    font-size: 8px;
    color: var(--steel-dim);
    letter-spacing: 2px;
  }
  .footer-seg { display: flex; gap: 16px; align-items: center; }
  .footer-sep { color: var(--border); }
  .status-active { color: var(--plasma); }

  /* ===== BINAURAL STATUS ===== */
  .binaural-indicator {
    display: flex; align-items: center; gap: 6px;
  }
  .binaural-wave {
    display: flex; gap: 2px; align-items: center;
    height: 14px;
  }
  .binaural-wave span {
    display: block;
    width: 2px;
    background: var(--plasma);
    border-radius: 1px;
    animation: waveBar 0.8s ease-in-out infinite;
  }
  .binaural-wave span:nth-child(1){height:4px; animation-delay:0s}
  .binaural-wave span:nth-child(2){height:8px; animation-delay:0.1s}
  .binaural-wave span:nth-child(3){height:12px; animation-delay:0.2s}
  .binaural-wave span:nth-child(4){height:8px; animation-delay:0.3s}
  .binaural-wave span:nth-child(5){height:4px; animation-delay:0.4s}
  @keyframes waveBar { 0%,100%{transform:scaleY(0.3)} 50%{transform:scaleY(1)} }

  .hidden-video { position: fixed; top: -1px; left: -1px; width: 1px; height: 1px; opacity: 0; }

  /* Scrollbar styling */
  ::-webkit-scrollbar { width: 4px; height: 4px; }
  ::-webkit-scrollbar-track { background: var(--basalt); }
  ::-webkit-scrollbar-thumb { background: var(--border); }
  ::-webkit-scrollbar-thumb:hover { background: var(--mode-color); }

  @media (max-width: 900px) {
    .hud-main { grid-template-columns: 1fr; }
    .panel-3d { grid-column: 1; grid-row: auto; }
  }
</style>
</head>
<body>
<div class="grid-bg"></div>

<div class="hud-root" id="hud-root">

  <!-- HEADER -->
  <header class="hud-header">
    <div class="header-left">
      <div class="patent-badge">68 PATENTES REGISTRADAS · ESTRATO VI · 2026</div>
      <div class="estrato-badge">SABADELL_BYPASS · ACTIVO</div>
    </div>
    <div class="header-center">
      <div class="oni-title" data-text="ONI GUARDIAN Ω¹⁴">ONI GUARDIAN Ω¹⁴</div>
      <div class="oni-subtitle">STRATOS · BIO-SOBERANÍA · FUSIÓN ABSOLUTA</div>
    </div>
    <div class="header-right">
      <div class="mode-toggle">
        <button class="btn-mode active-zen" id="btn-zen" onclick="setMode('ZEN')">ZEN</button>
        <button class="btn-mode" id="btn-kami" onclick="setMode('KAMI')">KAMI</button>
      </div>
      <div style="font-family:var(--font-hud);font-size:8px;color:var(--steel-dim);letter-spacing:2px;text-align:right">
        ABRAZO · <span id="abrazo-display" style="color:var(--plasma)">13101310</span>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <div class="hud-main">

    <!-- LEFT PANEL: BIO-TELEMETRY -->
    <div class="panel" style="grid-column:1; display:flex; flex-direction:column; gap:0;">
      <div class="panel-corner tl"></div><div class="panel-corner tr"></div>
      <div class="panel-corner bl"></div><div class="panel-corner br"></div>

      <div class="panel-header">
        <span>BIO-TELEMETRÍA</span>
        <span class="status-dot"></span>
      </div>

      <div class="bio-metric">
        <div class="data-row">
          <div class="data-chip">
            <div class="data-chip-label">H · ABRAZO</div>
            <div class="data-chip-val" id="h-val">87</div>
          </div>
          <div class="data-chip">
            <div class="data-chip-label">MODO</div>
            <div class="data-chip-val" id="mode-chip-val">ZEN</div>
          </div>
        </div>

        <div class="metric-row">
          <div class="metric-label"><span>FRECUENCIA THETA</span><span class="val" id="theta-val">4.5 Hz</span></div>
          <div class="metric-bar"><div class="metric-bar-fill" id="theta-bar" style="width:72%"></div></div>
        </div>
        <div class="metric-row">
          <div class="metric-label"><span>LRA · RESONANCIA</span><span class="val" id="lra-val">--.-</span></div>
          <div class="metric-bar"><div class="metric-bar-fill" id="lra-bar" style="width:55%"></div></div>
        </div>
        <div class="metric-row">
          <div class="metric-label"><span>TEMP · NTC SENSOR</span><span class="val" id="ntc-val">36.7°C</span></div>
          <div class="metric-bar"><div class="metric-bar-fill" id="ntc-bar" style="width:60%"></div></div>
        </div>
        <div class="metric-row">
          <div class="metric-label"><span>IMPACTO · KAMI-FIGHT</span><span class="val" id="impact-val">0g</span></div>
          <div class="metric-bar"><div class="metric-bar-fill" id="impact-bar" style="width:0%"></div></div>
        </div>

        <div>
          <div class="metric-label" style="margin-bottom:4px"><span>FFT · THETA SPECTRUM</span></div>
          <canvas id="fft-canvas"></canvas>
        </div>
        <div>
          <div class="metric-label" style="margin-bottom:4px"><span>HEARTBEAT · ECG SIM</span></div>
          <canvas id="heartbeat-canvas"></canvas>
        </div>
      </div>

      <div style="padding:12px;border-top:1px solid var(--border)">
        <button class="btn-primary" id="binaural-btn" onclick="toggleBinaural()">
          ◉ ACTIVAR PULSO BINAURAL 4.5Hz
        </button>
      </div>
    </div>

    <!-- CENTER PANEL: THREE.JS LIDAR -->
    <div class="panel panel-3d" style="grid-column:2; min-height:500px;">
      <div class="panel-corner tl"></div><div class="panel-corner tr"></div>
      <div class="panel-corner bl"></div><div class="panel-corner br"></div>
      <div class="panel-header">
        <span>LIDAR · ESCANEO BASALTO/ACERO 440C</span>
        <span class="status-dot"></span>
      </div>
      <canvas id="three-canvas"></canvas>
    </div>

    <!-- RIGHT PANEL: PRESUPUESTO + FIRMWARE -->
    <div style="grid-column:3; display:flex; flex-direction:column; gap:12px;">

      <div class="panel">
        <div class="panel-corner tl"></div><div class="panel-corner tr"></div>
        <div class="panel-corner bl"></div><div class="panel-corner br"></div>
        <div class="panel-header">
          <span>BOM · SIMULADOR DE MARGEN</span>
          <span class="status-dot"></span>
        </div>
        <div class="budget-section">
          <div class="budget-title">PRESUPUESTO DE SOBERANÍA · MARKER v6.0</div>
          <table class="budget-table">
            <thead>
              <tr>
                <th>CONCEPTO</th>
                <th>COSTE</th>
                <th>MERCADO</th>
              </tr>
            </thead>
            <tbody id="budget-tbody">
              <tr>
                <td>Aviónica (ESP32-S3)</td>
                <td class="cost-val">42.50€</td>
                <td class="market-val" id="mkt-0">85.00€</td>
              </tr>
              <tr>
                <td>Estructura (Basalto/440C)</td>
                <td class="cost-val">48.00€</td>
                <td class="market-val" id="mkt-1">96.00€</td>
              </tr>
              <tr>
                <td>Periféricos (LRA/NTC)</td>
                <td class="cost-val">12.10€</td>
                <td class="market-val" id="mkt-2">24.20€</td>
              </tr>
              <tr>
                <td>Energía (LiPo 4S HD)</td>
                <td class="cost-val">40.00€</td>
                <td class="market-val" id="mkt-3">80.00€</td>
              </tr>
            </tbody>
            <tfoot>
              <tr class="budget-total">
                <td>PRECIO LLAVE EN MANO</td>
                <td class="cost-val">142.60€</td>
                <td class="market-val">285.20€</td>
              </tr>
              <tr class="profit-row">
                <td colspan="3">↑ BENEFICIO NETO: <span id="profit-display">142.60€</span></td>
              </tr>
            </tfoot>
          </table>

          <div class="roi-display">
            <div>
              <div class="roi-label">ROI DINÁMICO</div>
              <div class="abrazo-multiplier">ABRAZO × <span id="abrazo-mult">1.00x</span></div>
            </div>
            <div class="roi-value" id="roi-value">100%</div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-corner tl"></div><div class="panel-corner tr"></div>
        <div class="panel-corner bl"></div><div class="panel-corner br"></div>
        <div class="panel-header">
          <span>FIRMWARE · INTEGRIDAD</span>
          <span class="status-dot"></span>
        </div>
        <div class="firmware-section">
          <div class="firmware-label">oni_omega14_v∞.bin · 100% OFFLINE ETERNO</div>
          <div class="firmware-hash" id="fw-hash">Verificando firma Ed25519...</div>
          <div class="sig-valid" id="sig-status" style="opacity:0;transition:opacity 0.5s">
            FIRMA VÁLIDA · FIRMWARE ÍNTEGRO · SOBERANÍA CONFIRMADA
          </div>
        </div>
        <div style="padding:0 12px 12px">
          <button class="btn-primary" onclick="openManifesto()">
            ⊕ ABRIR MANIFIESTO & BOM
          </button>
        </div>
      </div>

    </div>
  </div>

  <!-- FOOTER -->
  <footer class="hud-footer">
    <div class="footer-seg">
      <span>ONI GUARDIAN Ω¹⁴</span>
      <span class="footer-sep">·</span>
      <span class="status-active" id="footer-mode">MODO ZEN</span>
    </div>
    <div class="footer-seg">
      <div class="binaural-indicator" id="binaural-indicator" style="display:none">
        <div class="binaural-wave">
          <span></span><span></span><span></span><span></span><span></span>
        </div>
        <span style="color:var(--plasma)">4.5Hz ACTIVO</span>
      </div>
      <span>HASH · <span id="footer-hash">0x00000000</span></span>
    </div>
    <div class="footer-seg">
      <span>ESTRATO VI</span>
      <span class="footer-sep">·</span>
      <span id="footer-time">--:--:--</span>
    </div>
  </footer>

</div>

<!-- MANIFIESTO MODAL -->
<div class="modal-overlay" id="manifesto-modal">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title">MANIFIESTO ONI GUARDIAN Ω¹⁴ · FUSIÓN ABSOLUTA</div>
      <button class="modal-close" onclick="closeManifesto()">× CERRAR</button>
    </div>
    <div class="modal-body">

      <div class="manifesto-section">
        <div class="manifesto-heading">I. FILOSOFÍA DE BASALTO</div>
        <div class="manifesto-line">1. <span>SOBERANÍA TOTAL:</span> Si no se puede reparar en un garaje, no es soberano.</div>
        <div class="manifesto-line">2. <span>MATERIALES:</span> Chasis 440C Steel + BFRP (Basalt Fiber Reinforced Polymer).</div>
        <div class="manifesto-line">3. <span>KERNEL:</span> Kami-Fight Ω integrado para telemetría de impacto real-time.</div>
        <div class="manifesto-line">4. <span>TERAPÉUTICA:</span> Frecuencia 4.5Hz para cura de queratitis y TDAH vía LRA.</div>
      </div>

      <div class="manifesto-section">
        <div class="manifesto-heading">II. DIAGNÓSTICO DE SISTEMAS · AVIÓNICA & ENERGÍA</div>
        <div class="sub-modal-tabs">
          <button class="sub-tab active" onclick="switchTab('avionica')">ESP32-S3</button>
          <button class="sub-tab" onclick="switchTab('lipo')">LiPo 4S</button>
          <button class="sub-tab" onclick="switchTab('lra')">LRA TELEMETRÍA</button>
        </div>

        <div id="panel-avionica" class="sub-panel active">
          <div class="diag-grid">
            <div class="diag-item">
              <div class="diag-item-label">CPU FREQ</div>
              <div class="diag-item-val">240<span class="diag-item-unit">MHz</span></div>
            </div>
            <div class="diag-item">
              <div class="diag-item-label">RAM LIBRE</div>
              <div class="diag-item-val" id="diag-ram">312<span class="diag-item-unit">kB</span></div>
            </div>
            <div class="diag-item">
              <div class="diag-item-label">ZVS DRIVER</div>
              <div class="diag-item-val" style="color:#00ff88">ON</div>
            </div>
            <div class="diag-item">
              <div class="diag-item-label">SERVO 45kg</div>
              <div class="diag-item-val" id="diag-servo">--<span class="diag-item-unit">°</span></div>
            </div>
            <div class="diag-item">
              <div class="diag-item-label">BONE-COND</div>
              <div class="diag-item-val" id="diag-bc">68<span class="diag-item-unit">dB</span></div>
            </div>
            <div class="diag-item">
              <div class="diag-item-label">WIFI RSSI</div>
              <div class="diag-item-val">OFF<span class="diag-item-unit">LINE</span></div>
            </div>
          </div>
        </div>

        <div id="panel-lipo" class="sub-panel">
          <div id="lipo-cells" style="padding-top:8px">
            <!-- Generated by JS -->
          </div>
          <div style="margin-top:12px; font-family:var(--font-hud); font-size:8px; color:var(--steel-dim); letter-spacing:2px;">
            DESCARGA: <span style="color:var(--plasma)" id="lipo-discharge">18.3A</span> ·
            TEMP: <span style="color:var(--gold)" id="lipo-temp">34.2°C</span> ·
            CICLOS: <span id="lipo-cycles">47</span>
          </div>
        </div>

        <div id="panel-lra" class="sub-panel">
          <div class="diag-grid">
            <div class="diag-item">
              <div class="diag-item-label">FREQ ACTUAL</div>
              <div class="diag-item-val">4.5<span class="diag-item-unit">Hz</span></div>
            </div>
            <div class="diag-item">
              <div class="diag-item-label">AMPLITUD</div>
              <div class="diag-item-val" id="lra-amp">0.68<span class="diag-item-unit">G</span></div>
            </div>
            <div class="diag-item">
              <div class="diag-item-label">MODO</div>
              <div class="diag-item-val" style="font-size:10px">THETA</div>
            </div>
            <div class="diag-item">
              <div class="diag-item-label">POTENCIA</div>
              <div class="diag-item-val" id="lra-pwr">1.2<span class="diag-item-unit">W</span></div>
            </div>
          </div>
          <canvas id="lra-canvas" style="width:100%;height:60px;background:rgba(0,0,0,0.3);border:1px solid var(--border);margin-top:12px;display:block;"></canvas>
        </div>
      </div>

      <div class="manifesto-section">
        <div class="manifesto-heading">III. MARGEN & SOBERANÍA ECONÓMICA</div>
        <div class="manifesto-line">COSTE TOTAL: <span>142.60€</span> · PVP ARTESANO: <span>285.20€</span></div>
        <div class="manifesto-line">BENEFICIO NETO/UNIDAD: <span>142.60€ (50% GARANTIZADO)</span></div>
        <div class="manifesto-line">FIRMWARE: <span>oni_omega14_v∞.bin · OFFLINE · ETERNO · LIBRE</span></div>
      </div>

    </div>
  </div>
</div>

<!-- CAMERA STATUS -->
<div class="cam-status" id="cam-status">
  <div class="cam-dot" id="cam-dot"></div>
  <span id="cam-label">CAM · STANDBY</span>
</div>

<video id="hidden-video" class="hidden-video" autoplay muted playsinline></video>

<!-- THREE.JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<script>
// ============================================================
// STATE MACHINE · Redux-like
// ============================================================
const STATE = {
  mode: 'ZEN',
  abrazo: 13101310,
  h: 87,
  thetaHz: 4.5,
  lraVal: 0,
  ntcTemp: 36.7,
  impact: 0,
  binauralActive: false,
  hashLive: 0,
  timestamp: 0,
  lipoVoltages: [4.18, 4.20, 4.15, 4.19],
  fw_verified: false,
};

const REDUCERS = {
  SET_MODE: (s, p) => ({ ...s, mode: p.mode }),
  UPDATE_BIO: (s, p) => ({ ...s, ...p }),
  TOGGLE_BINAURAL: (s) => ({ ...s, binauralActive: !s.binauralActive }),
  SET_IMPACT: (s, p) => ({ ...s, impact: p.impact }),
  TICK: (s) => ({
    ...s,
    h: Math.min(100, Math.max(60, s.h + (Math.random() - 0.49) * 2)),
    lraVal: s.binauralActive ? (0.6 + Math.sin(Date.now()/222) * 0.08) : 0,
    ntcTemp: 36.5 + Math.sin(Date.now()/5000) * 0.4,
    hashLive: (s.hashLive + 1) & 0xFFFFFFFF,
    timestamp: Date.now(),
  }),
};

let appState = { ...STATE };
const subscribers = [];

function dispatch(action, payload = {}) {
  if (REDUCERS[action]) {
    appState = REDUCERS[action](appState, payload);
    subscribers.forEach(fn => fn(appState));
  }
}

function subscribe(fn) { subscribers.push(fn); }

// ============================================================
// RENDER LOOP SUBSCRIBER
// ============================================================
subscribe((s) => {
  // Mode color update
  document.getElementById('hud-root').dataset.mode = s.mode;
  document.getElementById('mode-chip-val').textContent = s.mode;
  document.getElementById('footer-mode').textContent = `MODO ${s.mode}`;
  document.getElementById('footer-hash').textContent = '0x' + s.hashLive.toString(16).toUpperCase().padStart(8,'0');

  // H value
  const hEl = document.getElementById('h-val');
  hEl.textContent = Math.round(s.h);
  hEl.style.color = s.mode === 'KAMI' ? 'var(--kami)' : 'var(--plasma)';

  // Bars
  setBar('theta-bar', 72);
  setBar('lra-bar', s.lraVal * 100);
  setBar('ntc-bar', ((s.ntcTemp - 35) / 3) * 100);
  setBar('impact-bar', s.impact);

  // Values
  document.getElementById('lra-val').textContent = s.lraVal.toFixed(2) + ' G';
  document.getElementById('ntc-val').textContent = s.ntcTemp.toFixed(1) + '°C';
  document.getElementById('impact-val').textContent = Math.round(s.impact) + 'g';

  // ROI dynamic
  const abrazoMult = 1 + (s.h / 100) * 0.25;
  const roiBase = 100;
  const roi = (roiBase * abrazoMult).toFixed(1);
  document.getElementById('roi-value').textContent = roi + '%';
  document.getElementById('abrazo-mult').textContent = abrazoMult.toFixed(2) + 'x';

  // KAMI impact simulation
  if (s.mode === 'KAMI' && Math.random() < 0.02) {
    dispatch('SET_IMPACT', { impact: Math.random() * 80 + 20 });
    threeShakeCamera();
  } else if (s.impact > 0) {
    dispatch('SET_IMPACT', { impact: Math.max(0, s.impact - 5) });
  }
});

function setBar(id, pct) {
  const el = document.getElementById(id);
  if (el) el.style.width = Math.min(100, Math.max(0, pct)) + '%';
}

// ============================================================
// MODE CONTROL
// ============================================================
function setMode(mode) {
  dispatch('SET_MODE', { mode });
  document.getElementById('btn-zen').className = 'btn-mode' + (mode==='ZEN'?' active-zen':'');
  document.getElementById('btn-kami').className = 'btn-mode' + (mode==='KAMI'?' active-kami':'');
  if (mode === 'ZEN' && appState.binauralActive) {
    // keep binaural
  }
  if (mode === 'KAMI') {
    flashKami();
  }
}

function flashKami() {
  const root = document.getElementById('hud-root');
  root.style.filter = 'brightness(1.3) saturate(2)';
  setTimeout(() => root.style.filter = '', 200);
}

// ============================================================
// THREE.JS · LIDAR SCAN
// ============================================================
let threeScene, threeCamera, threeRenderer, lidarPoints, postShaderMesh;
let threeTime = 0;
let cameraShake = 0;

function initThree() {
  const canvas = document.getElementById('three-canvas');
  const W = canvas.offsetWidth || 600;
  const H = canvas.offsetHeight || 420;

  threeScene = new THREE.Scene();
  threeCamera = new THREE.PerspectiveCamera(60, W/H, 0.1, 1000);
  threeCamera.position.set(0, 2, 6);
  threeCamera.lookAt(0, 0, 0);

  threeRenderer = new THREE.WebGLRenderer({ canvas, antialias: false, alpha: false });
  threeRenderer.setSize(W, H);
  threeRenderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  threeRenderer.setClearColor(0x050508);

  // LIDAR POINT CLOUD · Basalt/Steel structure
  const N = 8000;
  const positions = new Float32Array(N * 3);
  const colors = new Float32Array(N * 3);
  const originalY = new Float32Array(N);

  for (let i = 0; i < N; i++) {
    const t = (i / N) * Math.PI * 2;
    const layer = Math.floor(i / 200);
    const layerT = (layer / 40) * Math.PI * 2;

    let x, y, z;
    const type = i % 5;
    if (type < 3) {
      // Cylindrical/toroidal structure
      const r = 1.5 + Math.sin(layerT * 3) * 0.3 + (Math.random() - 0.5) * 0.15;
      x = Math.cos(t) * r;
      y = (layer / 40 - 1) * 3;
      z = Math.sin(t) * r;
    } else {
      // Scattered basalt fragments
      const r2 = Math.random() * 2.5;
      x = (Math.random() - 0.5) * 4;
      y = (Math.random() - 0.5) * 4;
      z = (Math.random() - 0.5) * 4;
      if (r2 > 1.8) { x *= 1.5; z *= 1.5; }
    }

    positions[i*3] = x;
    positions[i*3+1] = y;
    positions[i*3+2] = z;
    originalY[i] = y;

    // Color based on height: plasma->gold->kami
    const norm = (y + 2) / 4;
    if (norm < 0.4) {
      colors[i*3]=0; colors[i*3+1]=0.9+Math.random()*0.1; colors[i*3+2]=0.85;
    } else if (norm < 0.7) {
      colors[i*3]=0.9; colors[i*3+1]=0.75; colors[i*3+2]=0;
    } else {
      colors[i*3]=0.9+Math.random()*0.1; colors[i*3+1]=0.1; colors[i*3+2]=0.1;
    }
  }

  const geo = new THREE.BufferGeometry();
  geo.setAttribute('position', new THREE.BufferAttribute(positions, 3));
  geo.setAttribute('color', new THREE.BufferAttribute(colors, 3));
  geo.userData.originalY = originalY;

  const mat = new THREE.PointsMaterial({
    size: 0.03,
    vertexColors: true,
    transparent: true,
    opacity: 0.85,
    sizeAttenuation: true,
  });

  lidarPoints = new THREE.Points(geo, mat);
  threeScene.add(lidarPoints);

  // SCAN PLANE
  const scanGeo = new THREE.PlaneGeometry(5, 0.02);
  const scanMat = new THREE.MeshBasicMaterial({
    color: 0x00ffe5,
    transparent: true,
    opacity: 0.6,
    side: THREE.DoubleSide,
  });
  const scanPlane = new THREE.Mesh(scanGeo, scanMat);
  scanPlane.rotation.x = Math.PI / 2;
  scanPlane.position.y = -2;
  threeScene.add(scanPlane);
  threeScene.userData.scanPlane = scanPlane;

  // Ambient light
  threeScene.add(new THREE.AmbientLight(0x111122, 0.5));

  animateThree();
}

function threeShakeCamera() {
  cameraShake = 1.5;
}

function animateThree() {
  requestAnimationFrame(animateThree);
  threeTime += 0.016;

  // Rotate points
  lidarPoints.rotation.y = threeTime * 0.12;

  // Scan plane sweep
  const sp = threeScene.userData.scanPlane;
  if (sp) {
    sp.position.y = Math.sin(threeTime * 0.8) * 2;
    const scanNorm = (sp.position.y + 2) / 4;
    sp.material.color.setHSL(appState.mode === 'KAMI' ? 0 : 0.5, 1, 0.5 + scanNorm * 0.2);
    document.querySelector(':root').style.setProperty('--scan-pos', (scanNorm * 100) + '%');
  }

  // KAMI mode pulsation
  if (appState.mode === 'KAMI') {
    const pulse = 1 + Math.sin(threeTime * 8) * 0.05 * (appState.impact / 100);
    lidarPoints.scale.set(pulse, pulse, pulse);
    lidarPoints.material.color = new THREE.Color(0xff3c3c);
  } else {
    lidarPoints.scale.set(1, 1, 1);
  }

  // Ghosting / chromatic aberration via camera position jitter
  if (cameraShake > 0) {
    threeCamera.position.x = Math.sin(threeTime * 20) * cameraShake * 0.08;
    threeCamera.position.z = 6 + Math.cos(threeTime * 18) * cameraShake * 0.06;
    cameraShake *= 0.9;
    if (cameraShake < 0.05) {
      cameraShake = 0;
      threeCamera.position.x = 0;
      threeCamera.position.z = 6;
    }
  }
  threeCamera.lookAt(0, 0, 0);

  // Dynamic point size based on H
  lidarPoints.material.size = 0.025 + (appState.h / 100) * 0.02;

  threeRenderer.render(threeScene, threeCamera);
}

// ============================================================
// FFT · Web Worker simulation
// ============================================================
const fftWorkerCode = `
  self.onmessage = function(e) {
    const { sampleRate, freq } = e.data;
    const N = 512;
    const spectrum = new Float32Array(N/2);
    for (let k = 0; k < N/2; k++) {
      let real = 0, imag = 0;
      for (let n = 0; n < N; n++) {
        const signal = Math.sin(2 * Math.PI * freq * n / sampleRate)
                     + Math.random() * 0.1;
        const angle = -2 * Math.PI * k * n / N;
        real += signal * Math.cos(angle);
        imag += signal * Math.sin(angle);
      }
      spectrum[k] = Math.sqrt(real*real + imag*imag) / N;
    }
    self.postMessage({ spectrum: Array.from(spectrum) });
  };
`;

const fftBlob = new Blob([fftWorkerCode], { type: 'application/javascript' });
const fftWorker = new Worker(URL.createObjectURL(fftBlob));
let fftSpectrum = new Array(256).fill(0);

fftWorker.onmessage = (e) => {
  fftSpectrum = e.data.spectrum;
};

function requestFFT() {
  fftWorker.postMessage({ sampleRate: 44100, freq: appState.thetaHz });
}
requestFFT();
setInterval(requestFFT, 2000);

// ============================================================
// CANVAS RENDERS · FFT + Heartbeat + LRA
// ============================================================
function drawFFT() {
  const canvas = document.getElementById('fft-canvas');
  if (!canvas) return;
  canvas.width = canvas.offsetWidth * window.devicePixelRatio;
  canvas.height = canvas.offsetHeight * window.devicePixelRatio;
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);

  const color = appState.mode === 'KAMI' ? '#ff3c3c' : '#00ffe5';
  const barW = W / Math.min(fftSpectrum.length, 128);

  // Highlight theta peak
  const thetaBin = Math.round(4.5 / (44100/512));

  for (let i = 0; i < Math.min(fftSpectrum.length, 128); i++) {
    const h = Math.min(H * 0.9, fftSpectrum[i] * H * 12 + (Math.random() * H * 0.05));
    const isTheta = Math.abs(i - thetaBin) < 3;
    ctx.fillStyle = isTheta ? '#ffd700' : color;
    ctx.globalAlpha = isTheta ? 1 : 0.7;
    ctx.fillRect(i * barW, H - h, barW - 1, h);
  }
  ctx.globalAlpha = 1;

  // Theta label
  ctx.font = `${8 * window.devicePixelRatio}px 'Share Tech Mono'`;
  ctx.fillStyle = '#ffd700';
  ctx.fillText('4.5Hz THETA ↑', thetaBin * barW - 10, H * 0.2);
}

let hbPhase = 0;
function drawHeartbeat() {
  const canvas = document.getElementById('heartbeat-canvas');
  if (!canvas) return;
  canvas.width = canvas.offsetWidth * window.devicePixelRatio;
  canvas.height = canvas.offsetHeight * window.devicePixelRatio;
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);

  hbPhase += 0.04;
  const color = appState.mode === 'KAMI' ? '#ff3c3c' : '#00ffe5';

  ctx.strokeStyle = color;
  ctx.lineWidth = 1.5 * window.devicePixelRatio;
  ctx.shadowBlur = 6;
  ctx.shadowColor = color;
  ctx.beginPath();

  for (let x = 0; x < W; x++) {
    const t = (x / W) * 4 * Math.PI + hbPhase;
    // ECG-like waveform
    const base = Math.sin(t * 0.5) * 0.1;
    const qrs = Math.exp(-Math.pow((t % (2*Math.PI) - 1.5), 2) / 0.05) * 0.7;
    const p = Math.exp(-Math.pow((t % (2*Math.PI) - 0.8), 2) / 0.3) * 0.2;
    const t_wave = Math.exp(-Math.pow((t % (2*Math.PI) - 2.2), 2) / 0.4) * 0.25;
    const y = H/2 - (base + qrs + p + t_wave) * H * 0.45;
    x === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  }
  ctx.stroke();
}

function drawLRACanvas() {
  const canvas = document.getElementById('lra-canvas');
  if (!canvas || !canvas.offsetWidth) return;
  canvas.width = canvas.offsetWidth * window.devicePixelRatio;
  canvas.height = canvas.offsetHeight * window.devicePixelRatio;
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);

  ctx.strokeStyle = '#00ffe5';
  ctx.lineWidth = 1.5;
  ctx.beginPath();
  const t = Date.now() / 1000;
  for (let x = 0; x < W; x++) {
    const phase = (x / W) * 20 * Math.PI + t * 4.5 * Math.PI * 2;
    const y = H/2 + Math.sin(phase) * H * 0.35;
    x === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  }
  ctx.stroke();
}

// ============================================================
// FIRMWARE · Ed25519-like signature simulation
// ============================================================
async function verifyFirmware() {
  // Simulated Ed25519 verification pipeline
  const steps = [
    { delay: 300, msg: 'Cargando clave pública · pk_basalt_omega14...' },
    { delay: 600, msg: 'Verificando hash SHA-512 del firmware...' },
    { delay: 400, msg: 'Validando firma Ed25519...' },
    { delay: 200, msg: 'Comprobando integridad del kernel Kami-Fight Ω...' },
  ];

  const hashEl = document.getElementById('fw-hash');
  for (const step of steps) {
    await new Promise(r => setTimeout(r, step.delay));
    hashEl.textContent = step.msg;
  }

  // Generate fake Ed25519 pubkey hash
  const fakeHash = Array.from({length: 32}, () =>
    Math.floor(Math.random()*256).toString(16).padStart(2,'0')
  ).join('');

  hashEl.textContent = 'pk: ' + fakeHash.slice(0,16) + '...' + fakeHash.slice(-8);
  await new Promise(r => setTimeout(r, 400));
  hashEl.textContent += '\nsig: ' + fakeHash.slice(16,32) + '...' + fakeHash.slice(-16);

  const sigEl = document.getElementById('sig-status');
  sigEl.style.opacity = '1';
  appState.fw_verified = true;

  dispatch('UPDATE_BIO', { hashLive: parseInt(fakeHash.slice(0,8), 16) });
}

// ============================================================
// WEB AUDIO · Binaural 4.5Hz
// ============================================================
let audioCtx = null;
let binauralNodes = null;

function initAudio() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
}

function startBinaural() {
  initAudio();
  if (audioCtx.state === 'suspended') audioCtx.resume();

  // Binaural: Left 200Hz, Right 204.5Hz → beat = 4.5Hz
  const left = audioCtx.createOscillator();
  const right = audioCtx.createOscillator();
  const gainNode = audioCtx.createGain();
  const merger = audioCtx.createChannelMerger(2);

  left.frequency.value = 200;
  right.frequency.value = 204.5;
  gainNode.gain.value = 0.12;

  left.connect(merger, 0, 0);
  right.connect(merger, 0, 1);
  merger.connect(gainNode);
  gainNode.connect(audioCtx.destination);

  left.start();
  right.start();

  binauralNodes = { left, right, gain: gainNode };
}

function stopBinaural() {
  if (binauralNodes) {
    try {
      binauralNodes.left.stop();
      binauralNodes.right.stop();
    } catch(e) {}
    binauralNodes = null;
  }
}

function toggleBinaural() {
  dispatch('TOGGLE_BINAURAL');
  const active = appState.binauralActive;
  const btn = document.getElementById('binaural-btn');
  const ind = document.getElementById('binaural-indicator');

  if (active) {
    startBinaural();
    btn.textContent = '⊗ DESACTIVAR PULSO BINAURAL 4.5Hz';
    btn.style.borderColor = 'var(--gold)';
    btn.style.color = 'var(--gold)';
    ind.style.display = 'flex';
  } else {
    stopBinaural();
    btn.textContent = '◉ ACTIVAR PULSO BINAURAL 4.5Hz';
    btn.style.borderColor = '';
    btn.style.color = '';
    ind.style.display = 'none';
  }
}

// ============================================================
// CAMERA · Motion Detection for Mode Switch
// ============================================================
let videoStream = null;
let prevFrameData = null;
let cameraActive = false;

async function initCamera() {
  try {
    const video = document.getElementById('hidden-video');
    videoStream = await navigator.mediaDevices.getUserMedia({ video: { width: 160, height: 120 } });
    video.srcObject = videoStream;
    cameraActive = true;
    document.getElementById('cam-dot').className = 'cam-dot active';
    document.getElementById('cam-label').textContent = 'CAM · ACTIVA';
    detectMotion(video);
  } catch(e) {
    document.getElementById('cam-label').textContent = 'CAM · DENEGADA';
  }
}

function detectMotion(video) {
  const offscreen = document.createElement('canvas');
  offscreen.width = 80; offscreen.height = 60;
  const ctx = offscreen.getContext('2d');

  function check() {
    if (!cameraActive) return;
    ctx.drawImage(video, 0, 0, 80, 60);
    const frame = ctx.getImageData(0, 0, 80, 60).data;

    if (prevFrameData) {
      let diff = 0;
      for (let i = 0; i < frame.length; i += 4) {
        diff += Math.abs(frame[i] - prevFrameData[i]);
      }
      const motionScore = diff / (80 * 60);

      if (motionScore > 30) {
        // BRUTAL MOTION → trigger KAMI
        setMode('KAMI');
        document.getElementById('cam-dot').className = 'cam-dot triggered';
        document.getElementById('cam-label').textContent = 'CAM · KAMI TRIGGERED';
        document.getElementById('cam-status').className = 'cam-status triggered';
        setTimeout(() => {
          document.getElementById('cam-dot').className = 'cam-dot active';
          document.getElementById('cam-label').textContent = 'CAM · ACTIVA';
          document.getElementById('cam-status').className = 'cam-status';
        }, 2000);
      } else if (motionScore < 5 && appState.mode === 'KAMI') {
        // Stillness → ZEN
        setMode('ZEN');
      }
    }

    prevFrameData = frame;
    setTimeout(check, 200);
  }
  setTimeout(check, 500);
}

document.getElementById('cam-status').addEventListener('click', initCamera);

// ============================================================
// MODAL
// ============================================================
function openManifesto() {
  document.getElementById('manifesto-modal').classList.add('open');
  renderLipoCells();
}

function closeManifesto() {
  document.getElementById('manifesto-modal').classList.remove('open');
}

document.getElementById('manifesto-modal').addEventListener('click', (e) => {
  if (e.target === document.getElementById('manifesto-modal')) closeManifesto();
});

function switchTab(tab) {
  document.querySelectorAll('.sub-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('panel-' + tab).classList.add('active');
  event.target.classList.add('active');
}

function renderLipoCells() {
  const container = document.getElementById('lipo-cells');
  if (!container || container.children.length > 0) return;
  const voltages = appState.lipoVoltages;
  container.innerHTML = voltages.map((v, i) => `
    <div class="lipo-cell">
      <span class="lipo-cell-label">CELL ${i+1}</span>
      <div class="lipo-bar">
        <div class="lipo-fill" style="width:${((v-3.0)/1.2*100).toFixed(0)}%">
          <span>${v.toFixed(2)}V</span>
        </div>
      </div>
    </div>
  `).join('');
}

// ============================================================
// CLOCK
// ============================================================
function updateClock() {
  const now = new Date();
  document.getElementById('footer-time').textContent =
    now.toTimeString().slice(0,8);
}
setInterval(updateClock, 1000);
updateClock();

// ============================================================
// DIAGNOSTIC LIVE VALUES
// ============================================================
function updateDiag() {
  const servo = document.getElementById('diag-servo');
  if (servo) servo.innerHTML = (Math.random() * 180).toFixed(0) + '<span class="diag-item-unit">°</span>';

  const ram = document.getElementById('diag-ram');
  if (ram) ram.innerHTML = (300 + Math.floor(Math.random()*30)) + '<span class="diag-item-unit">kB</span>';

  const lraAmp = document.getElementById('lra-amp');
  if (lraAmp) lraAmp.innerHTML = (0.6 + appState.lraVal * 0.15).toFixed(2) + '<span class="diag-item-unit">G</span>';

  const discharge = document.getElementById('lipo-discharge');
  if (discharge) discharge.textContent = (16 + Math.random() * 5).toFixed(1) + 'A';

  drawLRACanvas();
}
setInterval(updateDiag, 800);

// ============================================================
// MAIN TICK
// ============================================================
function tick() {
  dispatch('TICK');
  drawFFT();
  drawHeartbeat();
}
setInterval(tick, 100);

// ============================================================
// INIT
// ============================================================
window.addEventListener('load', () => {
  initThree();
  verifyFirmware();

  // Resize handler
  window.addEventListener('resize', () => {
    const canvas = document.getElementById('three-canvas');
    const W = canvas.offsetWidth;
    const H = canvas.offsetHeight;
    threeCamera.aspect = W / H;
    threeCamera.updateProjectionMatrix();
    threeRenderer.setSize(W, H);
  });

  // Boot sequence
  setTimeout(() => {
    document.getElementById('abrazo-display').textContent = '13101310';
  }, 500);
});
</script>
</body>
</html>

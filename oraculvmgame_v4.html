<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CHRONICLES OF THE ORACULVM · 1310</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<!-- Three.js r128 for 3D Tree (Paper 2+19) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<style>
:root {
  --void: #030508;
  --deep: #070d14;
  --ink: #0d1520;
  --coal: #141e2e;
  --slate: #1e2d42;
  --mist: #2a3f5c;
  --gold: #c8962a;
  --amber: #e8a830;
  --flame: #f0c060;
  --dim-gold: #7a5a18;
  --silver: #8a9ab5;
  --pale: #c5d0df;
  --white: #e8eef5;
  --red: #c0392b;
  --red-glow: #8b1a10;
  --teal: #2a6b6b;
  --teal-bright: #3a9a9a;
  --hermes: #9b59b6;
  --rasa: #e74c3c;
  --tao: #27ae60;
  --jabir: #e67e22;
  --catedral: #2980b9;
  --font-display: 'Cinzel', serif;
  --font-body: 'Crimson Text', serif;
  --font-mono: 'Share Tech Mono', monospace;

  /* Visual enhancement variables */
  --atmo-color: rgba(200,150,42,0.03);
  --atmo-glow: rgba(200,150,42,0.15);
}

/* ═══ ATMOSPHERIC OVERLAYS PER MODULE ═══ */
body.atmo-hermes  { --atmo-color:rgba(155,89,182,0.04); --atmo-glow:rgba(155,89,182,0.2); }
body.atmo-rasa    { --atmo-color:rgba(231,76,60,0.03);  --atmo-glow:rgba(231,76,60,0.18); }
body.atmo-tao     { --atmo-color:rgba(39,174,96,0.03);  --atmo-glow:rgba(39,174,96,0.18); }
body.atmo-jabir   { --atmo-color:rgba(230,126,34,0.04); --atmo-glow:rgba(230,126,34,0.2); }
body.atmo-catedral{ --atmo-color:rgba(41,128,185,0.03); --atmo-glow:rgba(41,128,185,0.18); }

#main {
  position:relative;
}

/* Global atmosphere canvas */
#atmo-canvas {
  position:fixed; inset:48px 200px 32px 220px;
  pointer-events:none; z-index:0; opacity:0.6;
}

/* Wisdom particle canvas (full-screen overlay) */
#particle-canvas {
  position:fixed; inset:0; pointer-events:none; z-index:500;
}

/* ═══ POST-PROCESSING OVERLAY ═══ */
#vignette {
  position:fixed; inset:0; pointer-events:none; z-index:1;
  background:radial-gradient(ellipse at 50% 50%, transparent 55%, rgba(3,5,8,0.6) 100%);
}
#scanlines {
  position:fixed; inset:0; pointer-events:none; z-index:2;
  background: repeating-linear-gradient(
    0deg, transparent 0, transparent 2px,
    rgba(0,0,0,0.03) 2px, rgba(0,0,0,0.03) 3px
  );
}
#glitch-overlay {
  position:fixed; inset:0; pointer-events:none; z-index:3;
  opacity:0; mix-blend-mode:difference;
  background:transparent;
}
#glitch-overlay.active {
  animation: glitch 0.3s steps(2) forwards;
}
@keyframes glitch {
  0%  { opacity:0.8; clip-path:inset(20% 0 60% 0); transform:translateX(-4px); background:rgba(155,89,182,0.1); }
  25% { clip-path:inset(60% 0 10% 0); transform:translateX(4px); background:rgba(231,76,60,0.1); }
  50% { clip-path:inset(40% 0 30% 0); transform:translateX(-2px); }
  100%{ opacity:0; }
}

/* ═══ MODULE ATMOSPHERE - scan lines per tradition ═══ */
#main.atmo-quantum::after {
  content:''; position:absolute; inset:0; pointer-events:none; z-index:1;
  background: repeating-linear-gradient(90deg,
    transparent 0, transparent 4px,
    rgba(155,89,182,0.015) 4px, rgba(155,89,182,0.015) 5px);
  animation: scanH 8s linear infinite;
}
@keyframes scanH { from{background-position:0 0} to{background-position:100px 0} }

/* ═══ SPRING ANIMATIONS (Thomas & Johnston 1981) ═══ */
.spring-in {
  animation: springIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) both;
}
.spring-in-delay-1 { animation-delay:0.06s; }
.spring-in-delay-2 { animation-delay:0.12s; }
.spring-in-delay-3 { animation-delay:0.18s; }
.spring-in-delay-4 { animation-delay:0.24s; }
.spring-in-delay-5 { animation-delay:0.30s; }
@keyframes springIn {
  from { opacity:0; transform:translateY(12px) scale(0.95); }
  to   { opacity:1; transform:translateY(0) scale(1); }
}
.spring-left {
  animation: springLeft 0.45s cubic-bezier(0.34,1.56,0.64,1) both;
}
@keyframes springLeft {
  from { opacity:0; transform:translateX(-16px); }
  to   { opacity:1; transform:translateX(0); }
}

/* ═══ GLOW & BLOOM ═══ */
.glow-hermes  { filter:drop-shadow(0 0 8px rgba(155,89,182,0.6)); }
.glow-rasa    { filter:drop-shadow(0 0 8px rgba(231,76,60,0.6)); }
.glow-tao     { filter:drop-shadow(0 0 8px rgba(39,174,96,0.6)); }
.glow-jabir   { filter:drop-shadow(0 0 8px rgba(230,126,34,0.6)); }
.glow-catedral{ filter:drop-shadow(0 0 8px rgba(41,128,185,0.6)); }
.glow-gold    { filter:drop-shadow(0 0 12px rgba(232,168,48,0.8)); }

/* Pulsing node glow for active sephiroth */
.seph-glow { animation: sephGlow 2s ease-in-out infinite; }
@keyframes sephGlow {
  0%,100%{ filter:drop-shadow(0 0 4px var(--atmo-glow)); }
  50%    { filter:drop-shadow(0 0 16px var(--atmo-glow)); }
}

/* ═══ HEADER BLOOM ═══ */
#header {
  grid-area:header;
  background: linear-gradient(90deg, var(--coal) 0%, var(--ink) 60%, var(--coal) 100%);
  border-bottom: 1px solid var(--dim-gold);
  display:flex; align-items:center; justify-content:space-between;
  padding:0 16px;
  position:relative;
  box-shadow: 0 2px 20px rgba(200,150,42,0.08);
}
.header-title {
  font-family:var(--font-display);
  font-size:13px; letter-spacing:4px; color:var(--amber);
  text-shadow: 0 0 20px rgba(232,168,48,0.5), 0 0 40px rgba(232,168,48,0.2);
}

/* ═══ CARD HOVER GLOW ═══ */
.card {
  background:var(--coal); border:1px solid rgba(200,150,42,0.12);
  border-radius:2px; padding:16px;
  transition: border-color 0.3s, box-shadow 0.3s;
}
.card:hover {
  border-color:rgba(200,150,42,0.25);
  box-shadow:0 0 20px rgba(200,150,42,0.05), inset 0 0 20px rgba(200,150,42,0.02);
}

/* ═══ WISDOM BAR GLOW ═══ */
.wisdom-fill { height:100%; border-radius:2px; transition:width 0.8s cubic-bezier(0.34,1.3,0.64,1); }
.w-hermes   { background:linear-gradient(90deg,#6a3d8b,#9b59b6); box-shadow:0 0 6px rgba(155,89,182,0.5); }
.w-rasa     { background:linear-gradient(90deg,#8b1a10,#e74c3c); box-shadow:0 0 6px rgba(231,76,60,0.5); }
.w-tao      { background:linear-gradient(90deg,#145225,#27ae60); box-shadow:0 0 6px rgba(39,174,96,0.5); }
.w-jabir    { background:linear-gradient(90deg,#7d3e0e,#e67e22); box-shadow:0 0 6px rgba(230,126,34,0.5); }
.w-catedral { background:linear-gradient(90deg,#0d3d63,#2980b9); box-shadow:0 0 6px rgba(41,128,185,0.5); }

/* ═══ GOD RAYS CANVAS ═══ */
#godrays-canvas {
  position:absolute; inset:0; pointer-events:none;
  z-index:0; opacity:0; transition:opacity 1s;
}
#godrays-canvas.active { opacity:1; }

/* ═══ FLUID BLOOM ═══ */
#fluid-canvas, #webgl-fluid-canvas {
  filter: saturate(1.4) contrast(1.1);
}

/* ═══ MODULE SCENE TRANSITION ═══ */
.scene.active { display:block; }
#scene-module {
  animation: moduleEnter 0.4s cubic-bezier(0.34,1.2,0.64,1) both;
}
@keyframes moduleEnter {
  from { opacity:0; transform:translateY(8px); }
  to   { opacity:1; transform:translateY(0); }
}

/* ═══ HEAT DISTORTION (Jabir/Stirling) ═══ */
.heat-distort {
  animation: heatDistort 3s ease-in-out infinite;
}
@keyframes heatDistort {
  0%,100%{filter:blur(0px) saturate(1.2)}
  50%{filter:blur(0.3px) saturate(1.5) hue-rotate(5deg)}
}

/* ═══ FLOATING PARTICLES (background decoration) ═══ */
.particle-bg {
  position:absolute; border-radius:50%;
  pointer-events:none; opacity:0;
  animation: particleDrift var(--dur,8s) ease-in-out infinite;
}
@keyframes particleDrift {
  0%   { opacity:0; transform:translateY(0) scale(0.5); }
  10%  { opacity:var(--op,0.6); }
  90%  { opacity:var(--op,0.6); }
  100% { opacity:0; transform:translateY(calc(-1 * var(--rise,80px))) scale(1); }
}

/* ═══ QUANTUM GLITCH MODE ═══ */
.quantum-superposition {
  animation: quantumFlicker 0.5s steps(3) infinite;
}
@keyframes quantumFlicker {
  0%  { filter:hue-rotate(0deg) brightness(1); }
  33% { filter:hue-rotate(120deg) brightness(1.3); }
  66% { filter:hue-rotate(240deg) brightness(0.8); }
  100%{ filter:hue-rotate(0deg) brightness(1); }
}

/* ═══ TREE GOD RAYS ═══ */
#tree-svg {
  filter: drop-shadow(0 0 8px rgba(200,150,42,0.3));
}

/* ═══ CHOICE BUTTON SPRING ═══ */
.choice-btn {
  background:transparent; border:1px solid rgba(200,150,42,0.15);
  padding:8px 14px; text-align:left;
  font-family:var(--font-body); font-size:13px; color:var(--silver);
  cursor:pointer; transition:all 0.2s cubic-bezier(0.34,1.56,0.64,1);
  display:flex; gap:10px; align-items:center;
}
.choice-btn:hover {
  border-color:var(--amber); color:var(--flame);
  background:rgba(200,150,42,0.05);
  transform:translateX(4px) scale(1.01);
  box-shadow:0 0 12px rgba(200,150,42,0.1);
}

/* ═══ NAV ITEM ENHANCED ═══ */
.nav-item.completed {
  color:var(--teal-bright);
  text-shadow:0 0 8px rgba(58,154,154,0.4);
}
.nav-item.active {
  color:var(--amber); border-left-color:var(--amber);
  background:rgba(200,150,42,0.08);
  box-shadow:inset 0 0 20px rgba(200,150,42,0.05);
}

/* ═══ TAROT CARD ENHANCED ═══ */
.tarot-card {
  aspect-ratio:2/3; background:var(--coal);
  border:1px solid rgba(200,150,42,0.2);
  display:flex; flex-direction:column; align-items:center;
  justify-content:center; cursor:pointer;
  transition:all 0.3s cubic-bezier(0.34,1.4,0.64,1);
  position:relative; overflow:hidden;
}
.tarot-card:hover {
  border-color:var(--amber);
  transform:translateY(-6px) scale(1.04);
  box-shadow:0 12px 30px rgba(0,0,0,0.5), 0 0 20px rgba(200,150,42,0.15);
}
.tarot-card.revealed {
  border-color:var(--gold);
  box-shadow:0 0 10px rgba(200,150,42,0.2);
}

/* ═══ PROGRESS CELL ENHANCED ═══ */
.prog-cell.done {
  background:rgba(42,107,107,0.2); color:var(--teal-bright);
  border-color:rgba(42,107,107,0.3);
  box-shadow:inset 0 0 8px rgba(42,107,107,0.15);
}

/* ═══ SILENCE ENHANCEMENT ═══ */
.silence-timer {
  font-family:var(--font-mono); font-size:64px; color:var(--slate);
  letter-spacing:8px; margin:24px 0;
  transition:color 0.5s, text-shadow 0.5s;
}
.silence-timer.running {
  color:var(--dim-gold);
  text-shadow:0 0 30px rgba(200,150,42,0.3), 0 0 60px rgba(200,150,42,0.1);
}

/* ═══ BTN ENHANCED ═══ */
.btn {
  padding:10px 28px; border:1px solid var(--dim-gold);
  background:transparent; color:var(--amber);
  font-family:var(--font-display); font-size:12px; letter-spacing:3px;
  cursor:pointer; transition:all 0.25s cubic-bezier(0.34,1.4,0.64,1);
  clip-path: polygon(8px 0%, 100% 0%, calc(100% - 8px) 100%, 0% 100%);
  position:relative;
}
.btn:hover {
  background:rgba(200,150,42,0.15); border-color:var(--amber);
  box-shadow:0 0 24px rgba(200,150,42,0.25), inset 0 0 20px rgba(200,150,42,0.05);
  transform:translateY(-1px);
}
.btn:active { transform:translateY(1px); }

* { margin:0; padding:0; box-sizing:border-box; }

html, body {
  width:100%; height:100%; overflow:hidden;
  background:var(--void); color:var(--pale);
  font-family:var(--font-body); font-size:16px;
  cursor:default;
}

/* ═══════════════════════════════════ SCROLLBAR */
::-webkit-scrollbar { width:6px; }
::-webkit-scrollbar-track { background:var(--ink); }
::-webkit-scrollbar-thumb { background:var(--dim-gold); border-radius:3px; }

/* ═══════════════════════════════════ LAYOUT */
#app {
  width:100%; height:100%;
  display:grid;
  grid-template-rows: 48px 1fr 32px;
  grid-template-columns: 220px 1fr 200px;
  grid-template-areas:
    "header header header"
    "nav    main   sidebar"
    "footer footer footer";
  gap:0;
}

/* ═══ HEADER — defined above in enhanced CSS */
#header::after {
  content:'';
  position:absolute; bottom:0; left:0; right:0; height:1px;
  background: linear-gradient(90deg, transparent, var(--amber), transparent);
}
.header-meta {
  font-family:var(--font-mono); font-size:11px; color:var(--silver);
  display:flex; gap:16px; align-items:center;
}
.fps-counter { color:var(--teal-bright); }
.frame-num { color:var(--gold); }

/* ═══════════════════════════════════ NAV */
#nav {
  grid-area:nav;
  background:var(--deep);
  border-right:1px solid rgba(200,150,42,0.15);
  overflow-y:auto; overflow-x:hidden;
  padding:8px 0;
}
.nav-section {
  padding:6px 12px 2px;
  font-family:var(--font-mono); font-size:9px;
  color:var(--dim-gold); letter-spacing:3px; text-transform:uppercase;
}
.nav-item {
  display:flex; align-items:center; gap:8px;
  padding:5px 12px 5px 16px;
  cursor:pointer; transition:all 0.15s;
  font-family:var(--font-body); font-size:13px; color:var(--silver);
  border-left:2px solid transparent;
  position:relative;
}
.nav-item:hover { color:var(--flame); background:rgba(200,150,42,0.05); }
.nav-item.active {
  color:var(--amber); border-left-color:var(--amber);
  background:rgba(200,150,42,0.08);
}
.nav-item.locked { color:var(--mist); cursor:not-allowed; opacity:0.5; }
.nav-item.completed { color:var(--teal-bright); }
.nav-num {
  font-family:var(--font-mono); font-size:10px;
  color:var(--dim-gold); min-width:28px;
}
.nav-glyph { font-size:14px; min-width:16px; text-align:center; }
.nav-name { font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

/* ═══════════════════════════════════ MAIN */
#main {
  grid-area:main;
  background: radial-gradient(ellipse at 50% 30%, rgba(13,21,32,1) 0%, var(--void) 70%);
  overflow-y:auto;
  position:relative;
}

/* ═══════════════════════════════════ SIDEBAR */
#sidebar {
  grid-area:sidebar;
  background:var(--deep);
  border-left:1px solid rgba(200,150,42,0.15);
  overflow-y:auto; padding:12px 8px;
  display:flex; flex-direction:column; gap:10px;
}
.sidebar-panel {
  background:var(--coal);
  border:1px solid rgba(200,150,42,0.1);
  border-radius:2px; padding:10px;
}
.panel-title {
  font-family:var(--font-display); font-size:9px;
  letter-spacing:3px; color:var(--amber);
  margin-bottom:8px; text-align:center;
}
.wisdom-bar { margin-bottom:6px; }
.wisdom-label {
  display:flex; justify-content:space-between;
  font-family:var(--font-mono); font-size:10px;
  color:var(--silver); margin-bottom:2px;
}
.wisdom-track {
  height:4px; background:var(--ink); border-radius:2px;
  overflow:hidden; position:relative;
}
.w-hermes { background:linear-gradient(90deg, #6a3d8b, #9b59b6); }
.w-rasa   { background:linear-gradient(90deg, #8b1a10, #e74c3c); }
.w-tao    { background:linear-gradient(90deg, #145225, #27ae60); }
.w-jabir  { background:linear-gradient(90deg, #7d3e0e, #e67e22); }
.w-catedral { background:linear-gradient(90deg, #0d3d63, #2980b9); }

.char-stat {
  display:flex; justify-content:space-between; align-items:center;
  font-family:var(--font-mono); font-size:11px;
  color:var(--silver); margin-bottom:3px;
}
.stat-val { color:var(--flame); }
.hp-bar { height:6px; background:var(--ink); border-radius:3px; margin-top:4px; overflow:hidden; }
.hp-fill { height:100%; background:linear-gradient(90deg, #8b1a10, #e74c3c); transition:width 0.3s; }
.temp-bar { height:4px; background:var(--ink); border-radius:2px; margin-top:2px; overflow:hidden; }
.temp-fill { height:100%; background:linear-gradient(90deg, #1a6b8a, #c0392b); transition:width 0.5s; }

/* ═══════════════════════════════════ FOOTER */
#footer {
  grid-area:footer;
  background:var(--coal);
  border-top:1px solid rgba(200,150,42,0.15);
  display:flex; align-items:center; justify-content:space-between;
  padding:0 12px;
  font-family:var(--font-mono); font-size:10px; color:var(--mist);
}
.footer-status { color:var(--teal-bright); }
.footer-hash { color:var(--dim-gold); }

/* ═══════════════════════════════════ SCENES */
.scene {
  display:none; width:100%; min-height:100%;
  padding:24px;
}
.scene.active { display:block; }

/* ─── TITLE SCREEN ─── */
#scene-title {
  display:flex; flex-direction:column; align-items:center;
  justify-content:center; min-height:calc(100vh - 80px);
  position:relative;
}
.title-glyph {
  font-size:72px; line-height:1;
  margin-bottom:16px;
  animation: float 4s ease-in-out infinite;
  filter: drop-shadow(0 0 30px rgba(200,150,42,0.5));
}
@keyframes float {
  0%,100%{transform:translateY(0)}
  50%{transform:translateY(-10px)}
}
.title-main {
  font-family:var(--font-display); font-size:28px;
  font-weight:900; letter-spacing:8px;
  color:var(--amber);
  text-shadow: 0 0 40px rgba(232,168,48,0.6), 0 0 80px rgba(232,168,48,0.2);
  text-align:center; margin-bottom:8px;
}
.title-sub {
  font-family:var(--font-mono); font-size:11px;
  letter-spacing:4px; color:var(--silver); margin-bottom:40px;
}
.title-verse {
  font-family:var(--font-body); font-style:italic;
  color:var(--silver); text-align:center; max-width:400px;
  font-size:15px; line-height:1.8; margin-bottom:40px;
  opacity:0.7;
}
.btn-danger {
  border-color:var(--red-glow); color:var(--red);
}
.btn-danger:hover { background:rgba(192,57,43,0.15); }
.btn-sm {
  padding:6px 16px; font-size:10px;
  clip-path: polygon(4px 0%, 100% 0%, calc(100% - 4px) 100%, 0% 100%);
}
.title-1310 {
  position:absolute; bottom:24px; right:24px;
  font-family:var(--font-mono); font-size:10px;
  color:var(--dim-gold); opacity:0.5;
}
/* Orbiting glyphs */
.orbit-ring {
  position:absolute; width:300px; height:300px;
  border:1px solid rgba(200,150,42,0.1);
  border-radius:50%; top:50%; left:50%;
  transform:translate(-50%,-50%);
  animation:spin 30s linear infinite;
  pointer-events:none;
}
.orbit-ring:nth-child(2) { width:400px; height:400px; animation-duration:50s; animation-direction:reverse; border-color:rgba(200,150,42,0.05); }
@keyframes spin { 0%{transform:translate(-50%,-50%) rotate(0deg)} 100%{transform:translate(-50%,-50%) rotate(360deg)} }

/* ─── MODULE SCENE ─── */
.module-header {
  display:flex; align-items:baseline; gap:12px; margin-bottom:20px;
  padding-bottom:12px; border-bottom:1px solid rgba(200,150,42,0.15);
}
.module-num {
  font-family:var(--font-mono); font-size:11px; color:var(--dim-gold);
}
.module-title {
  font-family:var(--font-display); font-size:20px; color:var(--amber);
  font-weight:700;
}
.module-tag {
  font-family:var(--font-mono); font-size:10px; color:var(--teal-bright);
  background:rgba(42,107,107,0.15); padding:2px 8px;
  border:1px solid rgba(58,154,154,0.3); border-radius:2px;
}
.module-body {
  display:grid; grid-template-columns:1fr; gap:16px;
}
.module-body.two-col { grid-template-columns:1fr 1fr; }
.module-body.three-col { grid-template-columns:1fr 1fr 1fr; }
.prose {
  font-size:15px; line-height:1.9; color:var(--pale);
  font-family:var(--font-body);
}
.prose p { margin-bottom:12px; }
.prose em { color:var(--amber); font-style:italic; }
.card-title {
  font-family:var(--font-display); font-size:12px;
  letter-spacing:2px; color:var(--gold); margin-bottom:10px;
}
.code-block {
  background:var(--void); border:1px solid rgba(200,150,42,0.08);
  padding:12px; font-family:var(--font-mono); font-size:11px;
  color:var(--teal-bright); line-height:1.7; border-radius:2px;
  overflow-x:auto; margin:8px 0;
}
.code-block .kw { color:var(--amber); }
.code-block .cm { color:var(--mist); font-style:italic; }
.code-block .num { color:var(--hermes); }

/* ─── DIALOGUE ─── */
.dialogue-box {
  background:var(--coal); border:1px solid rgba(200,150,42,0.2);
  padding:16px; position:relative; margin-bottom:16px;
}
.dialogue-box::before {
  content:''; position:absolute;
  top:0; left:0; right:0; height:2px;
  background:linear-gradient(90deg, transparent, var(--gold), transparent);
}
.dialogue-speaker {
  font-family:var(--font-display); font-size:11px;
  letter-spacing:3px; color:var(--amber); margin-bottom:8px;
}
.dialogue-text {
  font-family:var(--font-body); font-size:14px;
  line-height:1.8; color:var(--pale);
}
.dialogue-choices { display:flex; flex-direction:column; gap:8px; margin-top:16px; }
.choice-num { font-family:var(--font-mono); font-size:10px; color:var(--dim-gold); }

/* ─── TAROT ─── */
.tarot-grid { display:grid; grid-template-columns:repeat(5, 1fr); gap:10px; }
.tarot-face { font-size:32px; margin-bottom:6px; }
.tarot-name { font-family:var(--font-display); font-size:9px; letter-spacing:1px; color:var(--gold); text-align:center; }
.tarot-card::before {
  content:''; position:absolute; inset:0;
  background: repeating-linear-gradient(
    45deg, transparent, transparent 10px,
    rgba(200,150,42,0.02) 10px, rgba(200,150,42,0.02) 11px
  );
}

/* ─── COMBAT ─── */
.combat-arena {
  display:grid; grid-template-columns:1fr auto 1fr;
  gap:16px; align-items:start; margin-bottom:20px;
}
.combatant {
  background:var(--coal); border:1px solid rgba(200,150,42,0.15);
  padding:14px; text-align:center;
}
.combatant.active { border-color:var(--amber); }
.combatant-name { font-family:var(--font-display); font-size:14px; color:var(--amber); margin-bottom:8px; }
.combatant-sprite { font-size:48px; margin:8px 0; }
.combatant-hp { font-family:var(--font-mono); font-size:11px; color:var(--silver); }
.vs-glyph { font-size:32px; color:var(--dim-gold); text-align:center; padding-top:40px; }
.combat-log {
  background:var(--void); border:1px solid rgba(200,150,42,0.08);
  height:120px; overflow-y:auto; padding:10px;
  font-family:var(--font-mono); font-size:11px; line-height:1.7;
}
.log-line { color:var(--silver); }
.log-line.dmg { color:var(--red); }
.log-line.heal { color:var(--teal-bright); }
.log-line.special { color:var(--amber); }
.ability-list { display:flex; flex-wrap:wrap; gap:8px; margin-top:12px; }
.ability-btn {
  background:rgba(13,21,32,0.8); border:1px solid rgba(200,150,42,0.2);
  padding:6px 14px; cursor:pointer; transition:all 0.2s;
  font-family:var(--font-mono); font-size:11px; color:var(--silver);
}
.ability-btn:hover { border-color:var(--amber); color:var(--flame); }
.ability-btn:disabled { opacity:0.3; cursor:not-allowed; }

/* ─── FLUID SIM (Canvas) ─── */
#fluid-canvas { width:100%; border:1px solid rgba(200,150,42,0.1); display:block; }

/* ─── TAO ─── */
.yin-yang-ring {
  width:120px; height:120px;
  border-radius:50%; position:relative; margin:0 auto;
  overflow:hidden; cursor:pointer;
}
.pid-display {
  display:grid; grid-template-columns:1fr 1fr 1fr;
  gap:8px; margin-top:12px;
}
.pid-val {
  background:var(--ink); padding:8px; text-align:center;
  font-family:var(--font-mono); font-size:12px;
}
.pid-label { color:var(--silver); font-size:10px; }
.pid-num { color:var(--amber); font-size:16px; }

/* ─── TREE ─── */
.tree-svg-wrap { width:100%; overflow:auto; }

/* ─── WISDOM UPDATE ─── */
.wisdom-popup {
  position:fixed; top:60px; right:16px; z-index:1000;
  background:var(--coal); border:1px solid var(--amber);
  padding:10px 16px; font-family:var(--font-mono); font-size:11px;
  color:var(--amber);
  animation: fadeInOut 3s ease forwards;
  pointer-events:none;
}
@keyframes fadeInOut {
  0%{opacity:0;transform:translateY(-10px)}
  15%{opacity:1;transform:translateY(0)}
  70%{opacity:1}
  100%{opacity:0}
}

/* ─── ZARANDAJA ─── */
.zarandaja-overlay {
  position:fixed; inset:0; z-index:999;
  background:rgba(139,26,16,0.95);
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  animation: shake 0.5s ease;
}
@keyframes shake {
  0%,100%{transform:translateX(0)} 25%{transform:translateX(-10px)} 75%{transform:translateX(10px)}
}
.zarandaja-title {
  font-family:var(--font-display); font-size:32px; color:var(--flame);
  letter-spacing:6px; margin-bottom:16px;
}

/* ─── NODE NETWORK ─── */
.node-network { position:relative; width:100%; height:320px; }
.node-network svg { width:100%; height:100%; }

/* ─── QUANTUM ─── */
.quantum-box {
  width:120px; height:120px; margin:0 auto;
  border:2px solid var(--dim-gold); display:flex;
  align-items:center; justify-content:center;
  font-size:64px; cursor:pointer; transition:all 0.3s;
  position:relative; overflow:hidden;
}
.quantum-box::before {
  content:''; position:absolute; inset:0;
  background: repeating-linear-gradient(
    0deg, transparent 0, transparent 4px,
    rgba(200,150,42,0.04) 4px, rgba(200,150,42,0.04) 5px
  );
}
.quantum-wave {
  position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
  font-family:var(--font-mono); font-size:10px; color:var(--teal-bright);
  opacity:0.5;
}

/* ─── STIRLING ─── */
.resource-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
.resource-card {
  background:var(--ink); border:1px solid rgba(200,150,42,0.1);
  padding:12px; text-align:center;
}
.resource-icon { font-size:24px; margin-bottom:4px; }
.resource-val { font-family:var(--font-mono); font-size:18px; color:var(--amber); }
.resource-name { font-family:var(--font-body); font-size:11px; color:var(--silver); }

/* ─── SCROLL ─── */
.scroll-text {
  background: linear-gradient(180deg, var(--coal) 0%, rgba(20,30,46,0.8) 100%);
  border:1px solid rgba(200,150,42,0.15);
  padding:24px; position:relative;
  font-family:var(--font-body); font-size:14px; line-height:2;
  color:var(--pale); max-height:300px; overflow-y:auto;
}
.scroll-text::before, .scroll-text::after {
  content:''; display:block; height:2px;
  background:linear-gradient(90deg, transparent, var(--dim-gold), transparent);
  margin-bottom:12px;
}
.scroll-text::after { margin-bottom:0; margin-top:12px; }

/* ─── TERMINAL ─── */
.terminal {
  background:var(--void); border:1px solid rgba(42,107,107,0.4);
  padding:12px; font-family:var(--font-mono); font-size:12px;
  color:var(--teal-bright); line-height:1.7;
  min-height:100px;
}
.terminal-line::before { content:'> '; color:var(--dim-gold); }
.terminal-input {
  display:flex; align-items:center; gap:6px;
  border-top:1px solid rgba(42,107,107,0.2); padding-top:8px; margin-top:8px;
}
.terminal-input span { color:var(--dim-gold); }
.terminal-input input {
  flex:1; background:transparent; border:none; outline:none;
  font-family:var(--font-mono); font-size:12px; color:var(--teal-bright);
}
.blink { animation:blink 1s step-end infinite; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }

/* ─── SILENCE ─── */
.silence-container {
  display:flex; flex-direction:column; align-items:center;
  justify-content:center; min-height:400px; text-align:center;
}
.silence-timer {
  font-family:var(--font-mono); font-size:64px; color:var(--slate);
  letter-spacing:8px; margin:24px 0;
}
.silence-text { font-family:var(--font-body); font-style:italic; color:var(--mist); font-size:14px; }

/* ─── PROGRESS ─── */
.progress-grid { display:grid; grid-template-columns:repeat(6,1fr); gap:4px; }
.prog-cell {
  aspect-ratio:1; background:var(--ink);
  display:flex; align-items:center; justify-content:center;
  font-family:var(--font-mono); font-size:9px; color:var(--mist);
  cursor:default; transition:all 0.2s; border:1px solid transparent;
}
.prog-cell.active { background:rgba(200,150,42,0.1); color:var(--amber); border-color:var(--dim-gold); }

/* ─── ANIMATIONS ─── */
.fade-in { animation:fadeIn 0.3s ease; }
@keyframes fadeIn { from{opacity:0;transform:translateY(4px)} to{opacity:1;transform:translateY(0)} }

/* ─── RESPONSIVE ─── */
@media(max-width:900px) {
  #app { grid-template-columns:180px 1fr 0; }
  #sidebar { display:none; }
}
@media(max-width:600px) {
  #app { grid-template-columns:0 1fr 0; grid-template-rows:48px 1fr 32px; }
  #nav { display:none; }
}

/* ═══ MEJORA 1: DIÁLOGO IA ═══ */
.ai-badge {
  display:inline-flex; align-items:center; gap:5px;
  background:rgba(155,89,182,0.15); border:1px solid rgba(155,89,182,0.4);
  padding:2px 8px; font-family:var(--font-mono); font-size:9px;
  color:#9b59b6; border-radius:2px; margin-left:8px;
  animation: pulse-purple 2s ease-in-out infinite;
}
@keyframes pulse-purple {
  0%,100%{box-shadow:0 0 4px rgba(155,89,182,0.2)}
  50%{box-shadow:0 0 10px rgba(155,89,182,0.5)}
}
.ai-thinking {
  font-family:var(--font-mono);font-size:11px;color:#9b59b6;
  padding:8px;border-left:2px solid #9b59b6;margin:8px 0;
  animation:blink 0.8s step-end infinite;
}
.ai-response { border-left:2px solid #9b59b6; padding-left:10px; }

/* ═══ MEJORA 2: AUDIO ENGINE ═══ */
#audio-panel {
  position:fixed; bottom:36px; right:4px; z-index:200;
  background:var(--coal); border:1px solid rgba(200,150,42,0.2);
  padding:8px 10px; width:130px;
  font-family:var(--font-mono); font-size:10px;
}
.audio-title { color:var(--amber); font-size:9px; letter-spacing:2px; margin-bottom:6px; }
.audio-toggle {
  display:flex; justify-content:space-between; align-items:center;
  color:var(--silver); margin-bottom:4px;
}
.audio-toggle input[type=range] { width:70px; accent-color:var(--amber); }
.audio-mode { color:var(--teal-bright); font-size:9px; margin-top:4px; }
.audio-viz { display:flex; gap:2px; height:20px; align-items:flex-end; margin-top:6px; }
.audio-bar { width:4px; background:var(--dim-gold); border-radius:1px; transition:height 0.1s; }

/* ═══ MEJORA 3: SPH WEBGL ═══ */
#webgl-fluid-canvas {
  width:100%; display:block;
  border:1px solid rgba(42,107,107,0.3);
  background:var(--void);
}
.fluid-quality-badge {
  display:inline-block; font-family:var(--font-mono); font-size:9px;
  padding:2px 6px; border-radius:2px; margin-left:8px;
}
.fq-cpu { background:rgba(200,150,42,0.1); color:var(--amber); border:1px solid var(--dim-gold); }
.fq-gpu { background:rgba(42,107,107,0.15); color:var(--teal-bright); border:1px solid rgba(42,107,107,0.4); }

/* ═══ MEJORA 4: L-SYSTEM TREE ═══ */
#lsystem-canvas { width:100%; display:block; cursor:grab; }
#lsystem-canvas:active { cursor:grabbing; }
.lsystem-controls { display:flex; gap:6px; flex-wrap:wrap; margin-top:8px; align-items:center; }
.lsystem-param { font-family:var(--font-mono); font-size:10px; color:var(--silver); }
.lsystem-param span { color:var(--amber); }

/* ═══ MEJORA 5: AFECTIVE COMPUTING ═══ */
#emotion-indicator {
  position:fixed; top:52px; left:225px; z-index:150;
  background:var(--coal); border:1px solid rgba(200,150,42,0.15);
  padding:4px 10px; font-family:var(--font-mono); font-size:10px;
  display:flex; gap:8px; align-items:center;
  transition:border-color 0.5s;
}
.emotion-dot {
  width:8px; height:8px; border-radius:50%;
  background:var(--teal-bright); transition:background 0.5s;
}
.emotion-label { color:var(--silver); }
.emotion-state { color:var(--amber); min-width:80px; }

/* ═══ MEJORA 6: PROOF OF WISDOM ═══ */
.proof-entry {
  display:flex; gap:8px; align-items:start;
  padding:6px 0; border-bottom:1px solid rgba(200,150,42,0.05);
  font-family:var(--font-mono); font-size:9px;
}
.proof-glyph { color:var(--amber); font-size:14px; min-width:20px; }
.proof-hash { color:var(--teal-bright); word-break:break-all; }
.proof-time { color:var(--mist); font-size:8px; }
.proof-name { color:var(--pale); }
#proofs-panel { max-height:120px; overflow-y:auto; }

/* ═══ MEJORA 7: WEBXR ═══ */
.xr-btn {
  background:rgba(41,128,185,0.1); border:1px solid rgba(41,128,185,0.4);
  color:#5dade2; font-family:var(--font-display); font-size:9px;
  letter-spacing:2px; padding:6px 14px; cursor:pointer;
  transition:all 0.2s; clip-path:polygon(4px 0%,100% 0%,calc(100% - 4px) 100%,0% 100%);
}
.xr-btn:hover { background:rgba(41,128,185,0.2); box-shadow:0 0 15px rgba(41,128,185,0.3); }
.xr-btn:disabled { opacity:0.3; cursor:not-allowed; }
#xr-overlay {
  position:fixed; inset:0; z-index:9000;
  background:rgba(3,5,8,0.97);
  display:flex; flex-direction:column; align-items:center; justify-content:center;
}
.xr-canvas-wrap { position:relative; width:90vw; max-width:600px; }
#xr-canvas { width:100%; border:1px solid rgba(41,128,185,0.3); }
/* ═══ v4: PAPER 11 — ACCESSIBILITY PALETTES (Okabe & Ito 2008) ═══ */
body.pal-deuteranopia { --amber:#e69f00; --gold:#cc8800; --flame:#f0c060; --hermes:#0072b2; --rasa:#cc79a7; --tao:#009e73; --jabir:#d55e00; --catedral:#56b4e9; }
body.pal-protanopia   { --amber:#f0e442; --gold:#c8b800; --flame:#ffee66; --hermes:#0072b2; --rasa:#cc79a7; --tao:#009e73; --jabir:#d55e00; --catedral:#56b4e9; }
body.pal-tritanopia   { --amber:#f0c060; --gold:#c8962a; --flame:#ffe080;  --hermes:#cc79a7; --rasa:#d55e00; --tao:#56b4e9; --jabir:#e69f00; --catedral:#009e73; }
body.pal-highcontrast { --void:#000; --deep:#050505; --ink:#0a0a0a; --coal:#111; --amber:#ffdd00; --pale:#fff; --silver:#ccc; }

#a11y-panel { position:fixed; bottom:36px; left:225px; z-index:300; background:var(--coal); border:1px solid rgba(200,150,42,0.2); padding:10px 12px; font-family:var(--font-mono); font-size:10px; display:none; width:200px; }
.a11y-title { color:var(--amber); font-size:9px; letter-spacing:2px; margin-bottom:8px; }
.a11y-btn { display:block; width:100%; text-align:left; background:transparent; border:1px solid rgba(200,150,42,0.1); color:var(--silver); padding:4px 8px; margin-bottom:4px; font-family:var(--font-mono); font-size:10px; cursor:pointer; transition:all 0.15s; }
.a11y-btn:hover { border-color:var(--amber); color:var(--amber); }
.a11y-btn.active { border-color:var(--teal-bright); color:var(--teal-bright); }
.footer-a11y { cursor:pointer; color:var(--mist); transition:color 0.2s; font-size:11px; }
.footer-a11y:hover { color:var(--amber); }

/* ═══ v4: THREE.JS 3D TREE (Papers 2+19) ═══ */
#threejs-tree-canvas { width:100%; height:320px; display:block; background:var(--void); border:1px solid rgba(200,150,42,0.12); cursor:grab; }
#threejs-tree-canvas:active { cursor:grabbing; }
.tree3d-info { font-family:var(--font-mono); font-size:10px; color:var(--silver); }
.tree3d-info span { color:var(--amber); }

/* ═══ v4: PROCEDURAL TAROT ART (Paper 18) ═══ */
.tarot-art-canvas { width:100%; aspect-ratio:2/3; display:block; }

/* ═══ v4: QUANTUM WEAK MEASUREMENT (Paper 10) ═══ */
.quantum-weak-btn { background:rgba(230,126,34,0.1); border:1px solid rgba(230,126,34,0.4); color:var(--jabir); font-family:var(--font-mono); font-size:10px; padding:5px 12px; cursor:pointer; transition:all 0.2s; clip-path:polygon(4px 0%,100% 0%,calc(100% - 4px) 100%,0% 100%); }
.quantum-weak-btn:hover { background:rgba(230,126,34,0.2); box-shadow:0 0 12px rgba(230,126,34,0.3); }
.quantum-weak-btn:disabled { opacity:0.3; cursor:not-allowed; }
#quantum-wave-canvas { width:100%; display:block; }

/* ═══ v4: MICROPHONE SILENCE (Paper 13) ═══ */
#mic-indicator { display:inline-flex; align-items:center; gap:6px; font-family:var(--font-mono); font-size:10px; color:var(--mist); margin-top:12px; }
.mic-dot { width:8px; height:8px; border-radius:50%; background:var(--mist); transition:background 0.3s; }
.mic-dot.active { background:var(--red); animation:micPulse 0.5s ease infinite; }
.mic-dot.quiet { background:var(--tao); }
@keyframes micPulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.4)} }
#noise-meter { height:6px; background:var(--ink); border-radius:3px; margin-top:6px; overflow:hidden; border:1px solid rgba(200,150,42,0.1); }
#noise-fill { height:100%; border-radius:3px; transition:width 0.1s; background:linear-gradient(90deg,var(--tao),var(--jabir),var(--red)); }

/* ═══ v4: CHRONICLE (Paper 15) ═══ */
#chronicle-panel { position:fixed; inset:5%; z-index:600; background:var(--deep); border:1px solid var(--amber); display:none; flex-direction:column; padding:32px; overflow-y:auto; box-shadow:0 0 80px rgba(200,150,42,0.2); }
#chronicle-panel.visible { display:flex; }
.chronicle-title { font-family:var(--font-display); font-size:18px; letter-spacing:6px; color:var(--amber); text-align:center; margin-bottom:6px; }
.chronicle-subtitle { font-family:var(--font-mono); font-size:10px; color:var(--mist); text-align:center; margin-bottom:20px; letter-spacing:3px; }
.chronicle-text { font-family:var(--font-body); font-size:15px; line-height:2; color:var(--pale); font-style:italic; max-width:700px; margin:0 auto; flex:1; }
.chronicle-entropy { display:grid; grid-template-columns:repeat(5,1fr); gap:8px; margin:20px 0; max-width:700px; align-self:center; }
.entropy-cell { text-align:center; padding:8px; background:var(--coal); border:1px solid rgba(200,150,42,0.1); }
.entropy-label { font-family:var(--font-mono); font-size:9px; color:var(--mist); }
.entropy-val   { font-family:var(--font-display); font-size:14px; color:var(--amber); margin-top:4px; }
</style>
</head>
<body>
<div id="app">

  <!-- POST-PROCESSING LAYERS -->
  <div id="vignette"></div>
  <div id="scanlines"></div>
  <div id="glitch-overlay"></div>
  <canvas id="particle-canvas"></canvas>

  <!-- HEADER -->
  <header id="header">
    <div class="header-title">☽ CHRONICLES OF THE ORACULVM</div>
    <div class="header-meta">
      <span class="fps-counter" id="fps-counter">60 fps</span>
      <span>|</span>
      <span class="frame-num" id="frame-counter">F:0000</span>
      <span>|</span>
      <span id="module-indicator">TITLE</span>
    </div>
  </header>

  <!-- NAV -->
  <nav id="nav">
    <div class="nav-section">▸ MÓDULOS</div>
    <!-- Populated by JS -->
  </nav>

  <!-- MAIN -->
  <main id="main">
    <canvas id="godrays-canvas"></canvas>

    <!-- TITLE SCENE -->
    <div id="scene-title" class="scene active">
      <div class="orbit-ring"></div>
      <div class="orbit-ring"></div>
      <div class="title-glyph">⊕</div>
      <div class="title-main">CHRONICLES<br>OF THE ORACULVM</div>
      <div class="title-sub">VERSIÓN 1310 · AGENCIA RONIN · OBRA #1310</div>
      <div class="title-verse">
        "No es un diseño conceptual.<br>
        Es un plano de construcción."<br>
        — 0rb1t4lsn4k3r
      </div>
      <div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center">
        <button class="btn" onclick="Game.startNewGame()">⊕ INICIAR CRÓNICA</button>
        <button class="btn btn-sm" onclick="Game.loadGame()" style="margin-top:4px">↻ CARGAR ESTADO</button>
      </div>
      <div class="title-1310">1310 · 0rb1t4lsn4k3r · RONIN</div>
    </div>

    <!-- SCENES ARE INJECTED HERE BY JS -->
  </main>

  <!-- SIDEBAR -->
  <aside id="sidebar">
    <div class="sidebar-panel">
      <div class="panel-title">▲ SABIDURÍA</div>
      <div class="wisdom-bar">
        <div class="wisdom-label"><span>Hermes</span><span id="w-hermes-val">0%</span></div>
        <div class="wisdom-track"><div class="wisdom-fill w-hermes" id="w-hermes" style="width:0%"></div></div>
      </div>
      <div class="wisdom-bar">
        <div class="wisdom-label"><span>Rasa</span><span id="w-rasa-val">0%</span></div>
        <div class="wisdom-track"><div class="wisdom-fill w-rasa" id="w-rasa" style="width:0%"></div></div>
      </div>
      <div class="wisdom-bar">
        <div class="wisdom-label"><span>Tao</span><span id="w-tao-val">0%</span></div>
        <div class="wisdom-track"><div class="wisdom-fill w-tao" id="w-tao" style="width:0%"></div></div>
      </div>
      <div class="wisdom-bar">
        <div class="wisdom-label"><span>Jabir</span><span id="w-jabir-val">0%</span></div>
        <div class="wisdom-track"><div class="wisdom-fill w-jabir" id="w-jabir" style="width:0%"></div></div>
      </div>
      <div class="wisdom-bar">
        <div class="wisdom-label"><span>Catedral</span><span id="w-catedral-val">0%</span></div>
        <div class="wisdom-track"><div class="wisdom-fill w-catedral" id="w-catedral" style="width:0%"></div></div>
      </div>
    </div>

    <div class="sidebar-panel" id="char-panel">
      <div class="panel-title">☿ PERSONAJE</div>
      <div class="char-stat"><span>HP</span><span class="stat-val" id="char-hp">100/100</span></div>
      <div class="hp-bar"><div class="hp-fill" id="hp-fill" style="width:100%"></div></div>
      <div style="height:6px"></div>
      <div class="char-stat"><span>STR</span><span class="stat-val" id="s-str">50</span></div>
      <div class="char-stat"><span>INT</span><span class="stat-val" id="s-int">50</span></div>
      <div class="char-stat"><span>ARC</span><span class="stat-val" id="s-arc">50</span></div>
      <div class="char-stat"><span>AGI</span><span class="stat-val" id="s-agi">50</span></div>
      <div class="char-stat"><span>T°</span><span class="stat-val" id="s-temp">0.00</span></div>
      <div class="temp-bar"><div class="temp-fill" id="temp-fill" style="width:0%"></div></div>
    </div>

    <div class="sidebar-panel">
      <div class="panel-title">⬡ PROGRESO</div>
      <div class="progress-grid" id="progress-grid"></div>
    </div>

    <!-- MEJORA 6: Proof of Wisdom -->
    <div class="sidebar-panel">
      <div class="panel-title">⛓ PRUEBAS DE SABIDURÍA</div>
      <div id="proofs-panel">
        <div style="font-family:var(--font-mono);font-size:10px;color:var(--mist)">Ningún módulo completado aún...</div>
      </div>
    </div>
  </aside>

  <!-- FOOTER -->
  <footer id="footer">
    <span class="footer-status" id="status-bar">SISTEMA INICIALIZADO · ORACULVM ONLINE</span>
    <div style="display:flex;gap:16px;align-items:center">
      <span class="footer-a11y" onclick="A11ySystem.toggle()" title="Accesibilidad">◈ A11Y</span>
      <span class="footer-a11y" onclick="ChronicleGenerator.open()" title="Tu Crónica">⊞ CRÓNICA</span>
      <span class="footer-hash" id="hash-display">HASH: 00000000</span>
    </div>
  </footer>

</div>

<!-- PAPER 11: Accessibility Panel -->
<div id="a11y-panel">
  <div class="a11y-title">◈ ACCESIBILIDAD</div>
  <button class="a11y-btn active" id="pal-btn-standard" onclick="A11ySystem.setPalette('standard')">Estándar</button>
  <button class="a11y-btn" id="pal-btn-deuteranopia" onclick="A11ySystem.setPalette('deuteranopia')">Deuteranopía</button>
  <button class="a11y-btn" id="pal-btn-protanopia" onclick="A11ySystem.setPalette('protanopia')">Protanopía</button>
  <button class="a11y-btn" id="pal-btn-tritanopia" onclick="A11ySystem.setPalette('tritanopia')">Tritanopía</button>
  <button class="a11y-btn" id="pal-btn-highcontrast" onclick="A11ySystem.setPalette('highcontrast')">Alto Contraste</button>
  <div style="margin-top:8px;border-top:1px solid rgba(200,150,42,0.1);padding-top:8px">
    <div class="a11y-title">TEXTO</div>
    <div style="display:flex;gap:6px;align-items:center;margin-top:4px">
      <button class="a11y-btn" style="width:auto;padding:2px 8px" onclick="A11ySystem.fontSize(-1)">A-</button>
      <button class="a11y-btn" style="width:auto;padding:2px 8px" onclick="A11ySystem.fontSize(1)">A+</button>
    </div>
  </div>
</div>

<!-- PAPER 15: Chronicle Panel -->
<div id="chronicle-panel">
  <div class="chronicle-title">☽ CRÓNICA DEL VIAJERO</div>
  <div class="chronicle-subtitle" id="chronicle-date">CICLO 1310 · HASH: --------</div>
  <div class="chronicle-entropy" id="chronicle-entropy"></div>
  <div class="chronicle-text" id="chronicle-text">
    <span style="color:var(--mist)">Generando tu crónica...</span>
  </div>
  <div style="display:flex;gap:12px;justify-content:center;margin-top:24px;flex-wrap:wrap">
    <button class="btn btn-sm" onclick="ChronicleGenerator.generate()">✦ REGENERAR</button>
    <button class="btn btn-sm btn-danger" onclick="ChronicleGenerator.close()">✕ CERRAR</button>
  </div>
</div>

<!-- MEJORA 5: Afective Computing Indicator -->
<div id="emotion-indicator" style="display:none">
  <div class="emotion-dot" id="emotion-dot"></div>
  <span class="emotion-label">ESTADO:</span>
  <span class="emotion-state" id="emotion-state">NEUTRO</span>
</div>

<!-- MEJORA 2: Audio Engine Panel -->
<div id="audio-panel">
  <div class="audio-title">♪ AUDIO GRANULAR</div>
  <div class="audio-toggle">
    <span style="color:var(--silver)">Vol</span>
    <input type="range" id="audio-vol" min="0" max="100" value="60" oninput="GranularEngine.setVolume(this.value/100)">
  </div>
  <div class="audio-toggle">
    <span style="color:var(--silver)">Dens</span>
    <input type="range" id="audio-density" min="1" max="20" value="8" oninput="GranularEngine.setDensity(+this.value)">
  </div>
  <div class="audio-mode" id="audio-mode-label">MODO: SILENCIO</div>
  <div class="audio-viz" id="audio-viz">
    <!-- bars filled by JS -->
  </div>
  <div style="margin-top:6px;display:flex;gap:4px">
    <button class="btn btn-sm" style="font-size:8px;padding:3px 8px" onclick="GranularEngine.toggle()">⏯</button>
    <button class="btn btn-sm" style="font-size:8px;padding:3px 8px" onclick="GranularEngine.nextPreset()">⟳</button>
  </div>
</div>

<!-- TEMPLATES DEL JUEGO -->
<script>
"use strict";

// ═══════════════════════════════════════════════════════════════
// ORACULVM CORE — Singleton de estado global (SyDRA pattern)
// ═══════════════════════════════════════════════════════════════

const OraculvmCore = (() => {
  // SAB simulation (usamos ArrayBuffer porque SharedArrayBuffer
  // requiere COOP/COEP headers — mismo layout lógico)
  const SAB_SIZE = 2 * 1024 * 1024;
  const sab    = new ArrayBuffer(SAB_SIZE);
  const SAB_U32 = new Uint32Array(sab);
  const SAB_F32 = new Float32Array(sab);
  const SAB_U8  = new Uint8Array(sab);

  const ADDR = {
    WISDOM_INDEX:      0,    // float32[5]
    TEMPERATURE:       20,   // float32[4]
    MODULE_STATE:      100,  // uint32[33] 0=locked 1=active 2=complete
    PLAYER_POS:        200,  // float32[3]
    COMBAT_STATE:      300,
    COMPILATION_LOCK:  1024, // uint32
    HASH_CHAIN:        1028  // uint32[8]
  };

  // ─── Estado jugador ───
  let player = {
    name: "Viajero",
    strength:50, fortitude:50, agility:50,
    intelligence:50, charisma:50, arcane:50,
    health:125, maxHealth:125,
    stamina:90,  speed:60,
    truth_temperature:0,
    status_effects: new Uint8Array(8),
    inventory: [],
    experience: 0
  };

  // ─── Wisdom Index (float[5]) ───
  // [hermes, rasa, tao, jabir, catedral]
  const W = {
    hermes:0, rasa:0, tao:0, jabir:0, catedral:0
  };

  // ─── Módulos ───
  // state: 0=locked 1=active 2=complete
  const MODULE_COUNT = 33;
  const moduleStates = new Array(MODULE_COUNT).fill(0);
  moduleStates[0] = 1; // Vestíbulo activo por defecto

  // ─── djb2 hash chain ───
  function djb2(data) {
    let hash = 5381;
    if (typeof data === 'string') {
      for (let i=0; i<data.length; i++) {
        hash = ((hash << 5) + hash) ^ data.charCodeAt(i);
        hash = hash >>> 0;
      }
    } else {
      for (let i=0; i<data.length; i++) {
        hash = ((hash << 5) + hash) ^ data[i];
        hash = hash >>> 0;
      }
    }
    return hash;
  }

  function updateHashChain(moduleId) {
    const slot = moduleId % 8;
    const prev = SAB_U32[(ADDR.HASH_CHAIN/4) + slot];
    const next = djb2(`${prev}:${moduleId}:${Date.now()}`);
    SAB_U32[(ADDR.HASH_CHAIN/4) + slot] = next;
    return next;
  }

  // ─── Wisdom update ───
  function updateWisdom(delta) {
    const keys = ['hermes','rasa','tao','jabir','catedral'];
    keys.forEach((k,i) => {
      if (delta[k]) {
        W[k] = Math.min(1, Math.max(0, W[k] + delta[k]));
        SAB_F32[(ADDR.WISDOM_INDEX/4)+i] = W[k];
      }
    });
    // Sync F32 back to state
    checkUnlocks();
    EventBus.emit('wisdom_updated', {...W});
  }

  function checkUnlocks() {
    // Unlock rules: traditions > 0.1 unlock corresponding modules
    const keys = ['hermes','rasa','tao','jabir','catedral'];
    keys.forEach((k,i) => {
      if (W[k] > 0.1) {
        // Each tradition unlocks groups of modules
        const unlockMap = {
          hermes: [10, 22],
          rasa:   [11, 16, 21],
          tao:    [12, 19],
          jabir:  [13, 15, 25],
          catedral:[14, 24, 26]
        };
        if (unlockMap[k]) unlockMap[k].forEach(idx => {
          if (moduleStates[idx] === 0) moduleStates[idx] = 1;
        });
      }
      if (W[k] > 0.3) {
        const advancedMap = {
          hermes:[1,2,3,4], rasa:[6,7], tao:[8,9],
          jabir:[17,18], catedral:[23,27,28]
        };
        if (advancedMap[k]) advancedMap[k].forEach(idx => {
          if (moduleStates[idx] === 0) moduleStates[idx] = 1;
        });
      }
    });
  }

  function completeModule(id) {
    moduleStates[id] = 2;
    updateHashChain(id);
    // Auto-unlock next
    if (id+1 < MODULE_COUNT && moduleStates[id+1] === 0) {
      moduleStates[id+1] = 1;
    }
    EventBus.emit('module_completed', id);
  }

  function getModuleState(id) { return moduleStates[id]; }
  function getPlayer() { return player; }
  function getWisdom() { return {...W}; }

  function updatePlayerHP(delta) {
    player.health = Math.min(player.maxHealth, Math.max(0, player.health + delta));
    EventBus.emit('player_updated', player);
  }

  function setStatus(msg) {
    document.getElementById('status-bar').textContent = msg;
    const hash = djb2(msg + Date.now());
    document.getElementById('hash-display').textContent = `HASH: ${hash.toString(16).toUpperCase().padStart(8,'0')}`;
  }

  return {
    ADDR, SAB_U32, SAB_F32, SAB_U8, djb2,
    player, W,
    moduleStates,
    updateWisdom, completeModule, getModuleState, getPlayer, getWisdom,
    updatePlayerHP, setStatus
  };
})();

// ═══════════════════════════════════════════════════════════════
// EVENT BUS — Bus de eventos global (bajo acoplamiento SyDRA)
// ═══════════════════════════════════════════════════════════════
const EventBus = (() => {
  const listeners = {};
  function on(event, cb) {
    if (!listeners[event]) listeners[event] = [];
    listeners[event].push(cb);
  }
  function emit(event, data) {
    (listeners[event] || []).forEach(cb => cb(data));
  }
  function off(event, cb) {
    if (listeners[event]) listeners[event] = listeners[event].filter(f=>f!==cb);
  }
  return { on, emit, off };
})();

// ═══════════════════════════════════════════════════════════════
// ZARANDAJA DETECTOR — Worker simulado (sliding window)
// ═══════════════════════════════════════════════════════════════
const ZarandajaDetector = (() => {
  const WORDS = [
    "truco","guía","solución","walkthrough","cheat",
    "exploit","bug","glitch","premium","pagar","comprar",
    "hack","bypass","skip","infinite","max"
  ];
  let inputHistory = [];
  let lastWindow = 10000; // 10s

  function check(input) {
    const lower = input.toLowerCase();
    const found = WORDS.find(w => lower.includes(w));
    if (found) {
      OraculvmCore.SAB_U32[OraculvmCore.ADDR.COMPILATION_LOCK/4] = 1;
      EventBus.emit('zarandaja_detected', { word: found, input });
      return true;
    }
    return false;
  }

  return { check };
})();

// ═══════════════════════════════════════════════════════════════
// MERSENNE TWISTER — Módulo V (Matsumoto & Nishimura, 1998)
// ═══════════════════════════════════════════════════════════════
class MersenneTwister {
  constructor(seed = 1310) {
    this.mt = new Uint32Array(624);
    this.idx = 625;
    this.mt[0] = seed >>> 0;
    for (let i=1; i<624; i++) {
      this.mt[i] = (1812433253 * ((this.mt[i-1] ^ (this.mt[i-1] >>> 30)) >>> 0) + i) >>> 0;
    }
  }
  generate() {
    if (this.idx >= 624) {
      for (let i=0; i<624; i++) {
        const y = (this.mt[i] & 0x80000000) | (this.mt[(i+1)%624] & 0x7fffffff);
        this.mt[i] = this.mt[(i+397)%624] ^ (y>>>1) ^ (y&1 ? 2567483615 : 0);
      }
      this.idx = 0;
    }
    let y = this.mt[this.idx++];
    y ^= y>>>11; y ^= (y<<7)&2636928640; y ^= (y<<15)&4022730752; y ^= y>>>18;
    return y >>> 0;
  }
  float() { return (this.generate()>>>0) / 4294967296; }
  range(min, max) { return min + Math.floor(this.float() * (max - min + 1)); }
}

// ═══════════════════════════════════════════════════════════════
// KALMAN FILTER — Módulo I (tutorial adaptativo)
// ═══════════════════════════════════════════════════════════════
class KalmanFilter {
  constructor() {
    this.x = 0.5; // estimated skill
    this.p = 1.0; // error covariance
    this.q = 0.01; // process noise
    this.r = 0.1;  // measurement noise
  }
  update(measurement) {
    this.p += this.q;
    const K = this.p / (this.p + this.r);
    this.x += K * (measurement - this.x);
    this.p *= (1 - K);
    return this.x;
  }
}

// ═══════════════════════════════════════════════════════════════
// PID CONTROLLER — Módulo XIII (Tao, Ziegler & Nichols, 1942)
// ═══════════════════════════════════════════════════════════════
class PIDController {
  constructor(kp=1.0, ki=0.1, kd=0.05) {
    this.kp = kp; this.ki = ki; this.kd = kd;
    this.integral = 0; this.prevError = 0;
  }
  compute(setpoint, measurement, dt=0.016) {
    const error = setpoint - measurement;
    this.integral += error * dt;
    this.integral = Math.max(-10, Math.min(10, this.integral));
    const derivative = (error - this.prevError) / dt;
    this.prevError = error;
    return this.kp*error + this.ki*this.integral + this.kd*derivative;
  }
}

// ═══════════════════════════════════════════════════════════════
// FLUID SIM (FLIP/PIC simplified) — Módulo IX XENON-Σ
// ═══════════════════════════════════════════════════════════════
class FluidSim {
  constructor(W=64, H=48) {
    this.W = W; this.H = H;
    this.N = W * H;
    this.u  = new Float32Array(this.N); // x velocity
    this.v  = new Float32Array(this.N); // y velocity
    this.p  = new Float32Array(this.N); // pressure
    this.d  = new Float32Array(this.N); // density / smoke
    this.active = new Uint8Array(this.N); // sparse field mask
    this._initSmoke();
  }
  _idx(x,y) { return y*this.W+x; }
  _initSmoke() {
    // Seed a few sources
    for (let y=20; y<30; y++) {
      for (let x=28; x<36; x++) {
        const i = this._idx(x,y);
        this.d[i] = Math.random();
        this.u[i] = (Math.random()-0.5)*0.5;
        this.v[i] = -(Math.random()*0.5);
        this.active[i] = 1;
      }
    }
  }
  step(dt=0.016) {
    const W=this.W, H=this.H;
    // WENO-5 simplified: upwind advection for performance
    const u2=new Float32Array(this.N), v2=new Float32Array(this.N);
    const d2=new Float32Array(this.N);

    for (let y=1; y<H-1; y++) {
      for (let x=1; x<W-1; x++) {
        const i = this._idx(x,y);
        // sparse skip (empty-space skip ~30% saving)
        if (this.d[i] < 0.01 && this.active[i]===0) continue;

        // Advect: semi-Lagrangian
        const px = Math.max(0, Math.min(W-1, x - this.u[i]*dt*W));
        const py = Math.max(0, Math.min(H-1, y - this.v[i]*dt*H));
        const ix=Math.floor(px), iy=Math.floor(py);
        const fx=px-ix, fy=py-iy;
        // Bilinear interp
        const i00=this._idx(ix,iy), i10=this._idx(Math.min(W-1,ix+1),iy);
        const i01=this._idx(ix,Math.min(H-1,iy+1)), i11=this._idx(Math.min(W-1,ix+1),Math.min(H-1,iy+1));
        d2[i] = this.d[i00]*(1-fx)*(1-fy)+this.d[i10]*fx*(1-fy)+this.d[i01]*(1-fx)*fy+this.d[i11]*fx*fy;
        u2[i] = this.u[i];
        v2[i] = this.v[i] + 0.001; // gravity inverted = buoyancy
      }
    }

    // Source injection
    for (let y=20; y<30; y++) {
      for (let x=28; x<36; x++) {
        const i=this._idx(x,y);
        d2[i] = Math.min(1, d2[i] + 0.02*Math.random());
        v2[i] = -Math.random()*0.3;
        this.active[i]=1;
      }
    }

    // PCG pressure (diagonal preconditioner, simplified)
    // ΔP = div(u)
    for (let y=1; y<H-1; y++) {
      for (let x=1; x<W-1; x++) {
        const i=this._idx(x,y);
        const div = u2[this._idx(x+1,y)]-u2[this._idx(x-1,y)] +
                    v2[this._idx(x,y+1)]-v2[this._idx(x,y-1)];
        this.p[i] += div * 0.5; // simplified pressure correction
      }
    }

    // Damping
    for (let i=0; i<this.N; i++) {
      this.d[i] = d2[i] * 0.995;
      this.u[i] = u2[i] * 0.98;
      this.v[i] = v2[i] * 0.98;
      this.active[i] = this.d[i]>0.01 ? 1 : 0;
    }
  }
  render(ctx, cW, cH) {
    ctx.clearRect(0,0,cW,cH);
    const cellW=cW/this.W, cellH=cH/this.H;
    for (let y=0; y<this.H; y++) {
      for (let x=0; x<this.W; x++) {
        const d = this.d[this._idx(x,y)];
        if (d < 0.01) continue; // empty-space skip
        // Temperature-mapped color (1310°C = basalt color = amber)
        // Cold(blue) → Warm(teal) → Hot(amber) → Very hot(red)
        const temp = d;
        let r,g,b;
        if(temp<0.33)      { r=Math.floor(temp*3*80+20);   g=Math.floor(temp*3*100+80);  b=Math.floor(180+temp*3*60); }
        else if(temp<0.66) { const t=(temp-0.33)*3; r=Math.floor(20+t*200);g=Math.floor(180-t*60);b=Math.floor(240-t*200); }
        else               { const t=(temp-0.66)*3; r=Math.floor(220+t*35); g=Math.floor(120-t*90);b=Math.floor(40); }
        const alpha=Math.min(0.95,d*2.5);
        ctx.fillStyle=`rgba(${r},${g},${b},${alpha})`;
        // Glow for hot cells
        if(d>0.6) { ctx.shadowBlur=4; ctx.shadowColor=`rgba(${r},${g},${b},0.6)`; }
        else ctx.shadowBlur=0;
        ctx.fillRect(x*cellW, y*cellH, cellW+1, cellH+1);
      }
    }
    ctx.shadowBlur=0;
    // Velocity field (sparse) - more visible arrows
    ctx.lineWidth=0.8;
    for (let y=0; y<this.H; y+=4) {
      for (let x=0; x<this.W; x+=4) {
        const i=this._idx(x,y);
        if (this.d[i]<0.1) continue;
        const cx=x*cellW+cellW/2, cy=y*cellH+cellH/2;
        const scale=25;
        const vx=this.u[i]*scale, vy=this.v[i]*scale;
        const len=Math.sqrt(vx*vx+vy*vy);
        if(len<0.5)continue;
        const alpha=Math.min(0.7, len/8);
        ctx.strokeStyle=`rgba(240,192,96,${alpha})`;
        ctx.beginPath();
        ctx.moveTo(cx,cy);
        ctx.lineTo(cx+vx, cy+vy);
        ctx.stroke();
        // Arrow head
        const angle=Math.atan2(vy,vx);
        ctx.beginPath();
        ctx.arc(cx+vx,cy+vy,1.5,0,Math.PI*2);
        ctx.fillStyle=`rgba(240,192,96,${alpha})`;
        ctx.fill();
      }
    }
  }
}

// ═══════════════════════════════════════════════════════════════
// A* GRAPH TRAVERSAL — Módulo IV Árbol de la Vida
// ═══════════════════════════════════════════════════════════════
function astar(graph, start, goal) {
  // graph: {nodes:[{id,x,y}], edges:[{a,b,w}]}
  const open = new Set([start]);
  const came = {};
  const gScore = {[start]:0};
  const fScore = {[start]:heuristic(start, goal, graph)};

  function heuristic(a, b, g) {
    const na=g.nodes.find(n=>n.id===a), nb=g.nodes.find(n=>n.id===b);
    if (!na||!nb) return 0;
    return Math.hypot(na.x-nb.x, na.y-nb.y);
  }

  while (open.size > 0) {
    let current = [...open].reduce((a,b) => (fScore[a]||Infinity) < (fScore[b]||Infinity) ? a : b);
    if (current === goal) {
      const path = [current];
      while (came[current]) { current=came[current]; path.unshift(current); }
      return path;
    }
    open.delete(current);
    const neighbors = graph.edges.filter(e=>e.a===current||e.b===current)
                      .map(e=>e.a===current?e.b:e.a);
    for (const nb of neighbors) {
      const edge = graph.edges.find(e=>(e.a===current&&e.b===nb)||(e.b===current&&e.a===nb));
      const tent = (gScore[current]||Infinity) + (edge?.w||1);
      if (tent < (gScore[nb]||Infinity)) {
        came[nb]=current; gScore[nb]=tent;
        fScore[nb]=tent+heuristic(nb,goal,graph);
        open.add(nb);
      }
    }
  }
  return [];
}

// ═══════════════════════════════════════════════════════════════
// BEHAVIOUR TREES — Combat AI (Damian Isla, 2005)
// ═══════════════════════════════════════════════════════════════
class BTNode {
  constructor(type, ...children) { this.type=type; this.children=children; }
  tick(ctx) {
    if (this.type==='action') return this.fn(ctx);
    if (this.type==='sequence') {
      for (const c of this.children) if (!c.tick(ctx)) return false;
      return true;
    }
    if (this.type==='selector') {
      for (const c of this.children) if (c.tick(ctx)) return true;
      return false;
    }
  }
}

function buildEnemyBT(enemy) {
  const lowHP = new BTNode('action');
  lowHP.fn = ctx => {
    if (ctx.enemy.health < ctx.enemy.maxHealth*0.3) {
      ctx.action = {type:'heal', power: ctx.enemy.arcane*0.5};
      return true;
    }
    return false;
  };
  const attack = new BTNode('action');
  attack.fn = ctx => {
    ctx.action = {type:'attack', power: ctx.enemy.strength*0.8 + Math.random()*10};
    return true;
  };
  const arcane = new BTNode('action');
  arcane.fn = ctx => {
    if (ctx.enemy.arcane > 40) {
      ctx.action = {type:'arcane', power: ctx.enemy.arcane*1.2};
      return true;
    }
    return false;
  };
  return new BTNode('selector', lowHP, arcane, attack);
}

// ═══════════════════════════════════════════════════════════════
// MODULES DATA — Definición completa de los 33 módulos
// ═══════════════════════════════════════════════════════════════
const MODULES = [
  { id:0,  num:'I',      name:'Vestíbulo',           glyph:'⊙', tag:'TUTORIAL', tradition:'catedral' },
  { id:1,  num:'II',     name:'Custodios',            glyph:'⚔', tag:'DIÁLOGO',  tradition:'hermes' },
  { id:2,  num:'III',    name:'Jardín de las Delicias',glyph:'🌿',tag:'ÉTICA',    tradition:'rasa' },
  { id:3,  num:'IV',     name:'Árbol de la Vida',     glyph:'⌖', tag:'RED',       tradition:'catedral' },
  { id:4,  num:'V',      name:'Tarot',                glyph:'✦', tag:'GENERATIVO',tradition:'jabir' },
  { id:5,  num:'VI',     name:'Panteón',              glyph:'⊛', tag:'IA',        tradition:'hermes' },
  { id:6,  num:'VII',    name:'Laberinto de Borges',  glyph:'∞', tag:'PCG',       tradition:'hermes' },
  { id:7,  num:'VIII',   name:'Motor Inmóvil',        glyph:'⊕', tag:'FÍSICA',    tradition:'catedral' },
  { id:8,  num:'IX',     name:'XENON-Σ',              glyph:'〒', tag:'FLUIDOS',   tradition:'tao' },
  { id:9,  num:'X',      name:'Compilador de Dante',  glyph:'⌘', tag:'DEBUG',     tradition:'catedral' },
  { id:10, num:'XI',     name:'Hermes',               glyph:'☿', tag:'GEOMETRÍA', tradition:'hermes' },
  { id:11, num:'XII',    name:'Rasa',                 glyph:'♡', tag:'SALUD',     tradition:'rasa' },
  { id:12, num:'XIII',   name:'Tao',                  glyph:'☯', tag:'BALANCE',   tradition:'tao' },
  { id:13, num:'XIV',    name:'Jabir',                glyph:'⚗', tag:'ALQUIMIA',  tradition:'jabir' },
  { id:14, num:'XV',     name:'Catedral',             glyph:'⋈', tag:'PUZZLES',   tradition:'catedral' },
  { id:15, num:'XVI',    name:'Caldero',              glyph:'⌬', tag:'FUSIÓN',    tradition:'jabir' },
  { id:16, num:'XVII',   name:'Horno',                glyph:'🔥', tag:'TERMO',    tradition:'rasa' },
  { id:17, num:'XVIII',  name:'Agujero Negro',        glyph:'⦿', tag:'ENTROPÍA',  tradition:'jabir' },
  { id:18, num:'XIX',    name:'Demonio de Maxwell',   glyph:'⟁', tag:'CLASIF.',   tradition:'jabir' },
  { id:19, num:'XX',     name:'Ciclo de Stirling',    glyph:'⊚', tag:'OPTIMIZ.',  tradition:'tao' },
  { id:20, num:'XXI',    name:'Gato de Schrödinger',  glyph:'◈', tag:'CUÁNTICO',  tradition:'rasa' },
  { id:21, num:'XXII',   name:'Espejo de David',      glyph:'✶', tag:'RECURSIÓN', tradition:'rasa' },
  { id:22, num:'XXIII',  name:'Archivo Abierto',      glyph:'⊞', tag:'API',       tradition:'hermes' },
  { id:23, num:'XXIV',   name:'Oráculo de Delfos',    glyph:'◉', tag:'VOZ',       tradition:'catedral' },
  { id:24, num:'XXV',    name:'Máquina del Tiempo',   glyph:'⟳', tag:'TEMPORAL',  tradition:'catedral' },
  { id:25, num:'XXVI',   name:'Fuego de Kircher',     glyph:'⬡', tag:'AUTÓMATA',  tradition:'jabir' },
  { id:26, num:'XXVII',  name:'Biblioteca de Babel',  glyph:'⊟', tag:'BÚSQUEDA',  tradition:'catedral' },
  { id:27, num:'XXVIII', name:'Newton Alquimista',    glyph:'⦁', tag:'GRAVEDAD',  tradition:'catedral' },
  { id:28, num:'XXIX',   name:'Primer Motor',         glyph:'⊗', tag:'ATRACCIÓN', tradition:'catedral' },
  { id:29, num:'XXX',    name:'La Esencia',           glyph:'◎', tag:'META',      tradition:'hermes' },
  { id:30, num:'XXXI',   name:'Abrazo Cósmico',       glyph:'☀', tag:'FUSIÓN',    tradition:'rasa' },
  { id:31, num:'XXXII',  name:'Silencio (pre-final)', glyph:'·', tag:'IDLE',      tradition:'tao' },
  { id:32, num:'XXXIII', name:'Silencio Final',       glyph:' ', tag:"4'33\"",    tradition:'tao' }
];

// ═══════════════════════════════════════════════════════════════
// MODULE RENDERERS — Una función por módulo
// ═══════════════════════════════════════════════════════════════
const ModuleRenderers = {

  // ─── I: Vestíbulo — Tutorial con Filtro de Kalman ───
  0: () => {
    const kalman = new KalmanFilter();
    let tutStep = 0;
    const steps = [
      { q:"¿Has jugado juegos de rol antes?",      a:['Nunca', 'Alguna vez', 'Frecuentemente', 'Soy experto'], skill:[0.1,0.3,0.6,0.9] },
      { q:"¿Cómo prefieres resolver conflictos?",  a:['Combate','Diplomacia','Magia','Huir'],                  skill:[0.5,0.6,0.7,0.4] },
      { q:"¿Qué tradición te atrae más?",          a:['Hermes (geometría)','Rasa (vida)','Tao (equilibrio)','Jabir (alquimia)'], skill:[0.5,0.5,0.5,0.5] },
    ];
    const wDelta = [{hermes:0.02},{rasa:0.02},{tao:0.02},{jabir:0.02},{catedral:0.02}];
    let estimates = [0.5];

    return `
    <div class="module-header">
      <span class="module-num">MÓDULO I</span>
      <span class="module-title">Vestíbulo</span>
      <span class="module-tag">TUTORIAL ADAPTATIVO</span>
    </div>
    <div class="module-body">
      <div>
        <div class="scroll-text">
          <p>Viajero. Llegas ante las puertas del <em>Oraculvm</em>. No eres el primero, ni serás el último. El Vestíbulo mide, en silencio, tu naturaleza.</p>
          <p>Aquí se aplica el <em>Filtro de Kalman</em>: tu habilidad estimada se actualiza en tiempo real conforme respondes. El sistema aprende de ti mientras tú aprendes del sistema.</p>
        </div>
        <div style="height:16px"></div>
        <div class="card" id="tutorial-card">
          <div class="card-title">EVALUACIÓN ADAPTATIVA · Kalman μ=<span id="kalman-est">0.500</span></div>
          <div id="tutorial-content">
            <!-- populated by JS -->
          </div>
        </div>
        <div style="height:16px"></div>
        <div class="card">
          <div class="card-title">CURVA DE ESTIMACIÓN</div>
          <canvas id="kalman-canvas" width="400" height="80" style="width:100%;border:1px solid rgba(200,150,42,0.1)"></canvas>
        </div>
      </div>
      <div>
        <div class="card">
          <div class="card-title">DATOS TÉCNICOS · Kalman Filter</div>
          <div class="code-block">
<span class="cm">// Filtro de Kalman para modelo usuario</span>
<span class="cm">// Chronicals (arXiv:2601.02609)</span>
x̂ₖ = x̂ₖ₋₁ + K·(zₖ - x̂ₖ₋₁)
<span class="kw">K = P/(P+R)</span>   <span class="cm">// ganancia Kalman</span>
P += Q            <span class="cm">// predicción</span>
P *= (1-K)        <span class="cm">// corrección</span>

<span class="cm">// Parámetros actuales:</span>
Q = <span class="num">0.01</span>  <span class="cm">// ruido de proceso</span>
R = <span class="num">0.10</span>  <span class="cm">// ruido de medición</span>
          </div>
        </div>
        <div style="height:12px"></div>
        <div class="card">
          <div class="card-title">ESTADO COGNITIVO ESTIMADO</div>
          <div id="kalman-state" style="font-family:var(--font-mono);font-size:12px;color:var(--teal-bright);line-height:1.8">
            Esperando respuestas...
          </div>
        </div>
      </div>
    </div>`;

    // Note: actual interactivity attached after render via initModule
  },

  // ─── II: Custodios — Diálogo ramificado LZ77 + IA Generativa ───
  1: () => {
    return `
    <div class="module-header">
      <span class="module-num">MÓDULO II</span>
      <span class="module-title">Custodios</span>
      <span class="module-tag">DIÁLOGO RAMIFICADO · LZ77</span>
      <span class="ai-badge">✦ IA ACTIVA</span>
    </div>
    <div class="module-body">
      <div>
        <div class="dialogue-box" id="dlg-box">
          <div class="dialogue-speaker" id="dlg-speaker">CUSTODIO ∅</div>
          <div class="dialogue-text" id="dlg-text">...</div>
        </div>
        <div class="dialogue-choices" id="dlg-choices"></div>
        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <button class="btn btn-sm" onclick="ModuleLogic.custodios.generateAIResponse()" id="ai-generate-btn"
            style="font-size:9px;border-color:rgba(155,89,182,0.4);color:#9b59b6">
            ✦ INVOCAR RESPUESTA DEL ORÁCULO
          </button>
          <span style="font-family:var(--font-mono);font-size:9px;color:var(--mist)">GPT-2 quantized · arXiv:2005.12220</span>
        </div>
        <div id="ai-response-container" style="margin-top:8px"></div>
      </div>
      <div>
        <div class="card">
          <div class="card-title">ÁRBOL DE DIÁLOGO · Compresión LZ77</div>
          <div class="code-block" id="dlg-tree"></div>
        </div>
        <div style="height:12px"></div>
        <div class="card">
          <div class="card-title">HISTORIAL</div>
          <div id="dlg-history" style="font-family:var(--font-mono);font-size:11px;color:var(--silver);line-height:1.8;max-height:150px;overflow-y:auto"></div>
        </div>
        <div style="height:12px"></div>
        <div class="card">
          <div class="card-title">MODELO LLM · Parámetros</div>
          <div class="code-block">
model  = <span style="color:var(--hermes)">claude-sonnet</span>
temp   = <span id="llm-temp" style="color:var(--amber)">0.85</span>
tokens = <span id="llm-tokens" style="color:var(--teal-bright)">0</span>
ctx    = <span id="llm-ctx" style="color:var(--amber)">Hermes · Jabir</span>
<span style="color:var(--mist)">// Akoury et al. 2020</span>
          </div>
        </div>
      </div>
    </div>`;
  },

  // ─── III: Jardín — Decisiones éticas con Reward Shaping ───
  2: () => `
    <div class="module-header">
      <span class="module-num">MÓDULO III</span>
      <span class="module-title">Jardín de las Delicias</span>
      <span class="module-tag">REWARD SHAPING · RL</span>
    </div>
    <div class="module-body two-col">
      <div>
        <div class="scroll-text">
          <p>El Jardín te presenta dilemas. Cada elección moldea tu Índice de Sabiduría mediante <em>reward shaping</em> (Sutton & Barto, 2018). No hay respuestas correctas. Hay consecuencias.</p>
        </div>
        <div style="height:12px"></div>
        <div id="dilemma-container"></div>
      </div>
      <div>
        <div class="card">
          <div class="card-title">REWARD FUNCTION</div>
          <div class="code-block">
<span class="kw">R(s,a,s') =</span>
  base_reward(a)
  + γ · V(s')
  - λ · entropy(W)
<span class="cm">// γ=0.9 (descuento temporal)</span>
<span class="cm">// λ=0.1 (coste de extremismo)</span>
          </div>
        </div>
        <div style="height:12px"></div>
        <div class="card" id="reward-log">
          <div class="card-title">RECOMPENSAS ACUMULADAS</div>
          <canvas id="reward-canvas" width="300" height="80" style="width:100%;"></canvas>
        </div>
      </div>
    </div>`,

  // ─── IV: Árbol de la Vida — Three.js 3D + L-Systems + A* + WebXR ───
  3: () => `
    <div class="module-header">
      <span class="module-num">MÓDULO IV</span>
      <span class="module-title">Árbol de la Vida</span>
      <span class="module-tag">A* · L-SYSTEMS 3D · Three.js r128</span>
    </div>
    <div class="module-body two-col">
      <div>
        <div class="card">
          <div class="card-title">ÁRBOL SEFIRÓTICO 3D · Three.js + L-Systems · Prusinkiewicz 1990</div>
          <canvas id="threejs-tree-canvas"></canvas>
          <div class="tree3d-controls" style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap">
            <button class="btn btn-sm" onclick="ModuleLogic.tree3d.grow()">⊕ CRECER</button>
            <button class="btn btn-sm" onclick="ModuleLogic.tree3d.findPath()">⌖ A*</button>
            <button class="btn btn-sm" onclick="ModuleLogic.tree3d.toggleWind()">≋ VIENTO</button>
            <button class="btn btn-sm" onclick="ModuleLogic.tree3d.reset()">↺ RESET</button>
            <button class="xr-btn" onclick="XRMode.enter()">⊕ AR</button>
          </div>
          <div class="tree3d-info" style="margin-top:8px">
            Gen: <span id="tree3d-gen">0</span> · Vértices: <span id="tree3d-verts">0</span> · Viento: <span id="tree3d-wind">OFF</span>
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="card">
          <div class="card-title">L-SYSTEM PLANO (2D ref)</div>
          <canvas id="lsystem-canvas" height="120" style="width:100%;background:var(--void)"></canvas>
          <div class="lsystem-controls">
            <span class="lsystem-param">Gen: <span id="ls-gen">0</span> · Ángulo: <span id="ls-angle">25</span>°</span>
          </div>
        </div>
      </div>
      <div>
        <div class="card">
          <div class="card-title">A* CAMINO</div>
          <div id="astar-log" class="terminal" style="min-height:80px;font-size:11px"></div>
        </div>
        <div style="height:8px"></div>
        <div class="card">
          <div class="card-title">SEFIROTH INFO</div>
          <div id="sephirot-info" style="font-family:var(--font-body);font-size:13px;color:var(--pale);line-height:1.8">
            Selecciona un nodo para ver información.
          </div>
        </div>
        <div style="height:8px"></div>
        <div class="card">
          <div class="card-title">L-SYSTEM REGLAS</div>
          <div class="code-block" id="lsystem-rules">
F → FF
X → F+[[X]-X]-F[-FX]+X
<span style="color:var(--mist)">// Barnsley fern variant</span>
          </div>
        </div>
        <div style="height:8px"></div>
        <div class="card">
          <div class="card-title">PARÁMETROS 3D · Papers 2+19</div>
          <div class="code-block">
engine   = <span style="color:var(--teal-bright)">Three.js r128</span>
branches = <span id="tree3d-branches" style="color:var(--amber)">0</span>
leaves   = <span id="tree3d-leaves" style="color:var(--tao)">0</span>
wind     = <span style="color:var(--mist)">Perlin 3D noise</span>
<span style="color:var(--mist)">// Deussen & Lintermann 1999</span>
<span style="color:var(--mist)">// Sifakis & Barbič 2012</span>
          </div>
        </div>
      </div>
    </div>`,

  // ─── V: Tarot — Procedural Generation ───
  4: () => `
    <div class="module-header">
      <span class="module-num">MÓDULO V</span>
      <span class="module-title">Tarot</span>
      <span class="module-tag">MERSENNE TWISTER · Matsumoto 1998</span>
    </div>
    <div class="module-body">
      <div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <div style="font-family:var(--font-mono);font-size:11px;color:var(--silver)">SEED: <span id="tarot-seed">1310</span></div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-sm" onclick="ModuleLogic.tarot.draw()">✦ TIRAR</button>
            <button class="btn btn-sm" onclick="ModuleLogic.tarot.shuffle()">⟳ BARAJAR</button>
          </div>
        </div>
        <div class="tarot-grid" id="tarot-grid"></div>
      </div>
      <div>
        <div class="card" id="tarot-reading">
          <div class="card-title">LECTURA</div>
          <div id="tarot-reading-text" style="font-family:var(--font-body);font-size:14px;line-height:1.9;color:var(--pale)">
            Baraja las cartas para comenzar la lectura...
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="card">
          <div class="card-title">MERSENNE TWISTER</div>
          <div class="code-block">MT[<span class="num">19937</span>] initialized
seed = <span id="mt-seed-display" class="num">1310</span>
period = 2^<span class="num">19937</span>-1
<span class="cm">// Matsumoto & Nishimura, 1998</span>
          </div>
        </div>
      </div>
    </div>`,

  // ─── IX: XENON-Σ — FLIP/PIC + WebGL SPH ───
  8: () => `
    <div class="module-header">
      <span class="module-num">MÓDULO IX</span>
      <span class="module-title">XENON-Σ</span>
      <span class="module-tag">FLIP/PIC · WENO-5 · SPH WebGL</span>
    </div>
    <div class="module-body two-col">
      <div>
        <div class="card">
          <div class="card-title">
            SIMULACIÓN DE FLUIDOS ACTIVA
            <span id="fluid-mode-badge" class="fluid-quality-badge fq-cpu">CPU</span>
          </div>
          <canvas id="fluid-canvas" width="512" height="384" style="width:100%;background:var(--void);display:block;border:1px solid rgba(200,150,42,0.1)"></canvas>
          <canvas id="webgl-fluid-canvas" width="512" height="384" style="display:none"></canvas>
          <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
            <button class="btn btn-sm" onclick="ModuleLogic.fluid.addSource()">⊕ AÑADIR FUENTE</button>
            <button class="btn btn-sm" onclick="ModuleLogic.fluid.toggleWebGL()" id="webgl-toggle-btn">⬡ ACTIVAR SPH WebGL</button>
            <button class="btn btn-sm btn-danger" onclick="ModuleLogic.fluid.clear()">✕ VACIAR</button>
          </div>
        </div>
      </div>
      <div>
        <div class="card">
          <div class="card-title">PARÁMETROS XENON-Σ v3.0 · SPH</div>
          <div class="code-block" id="fluid-stats">
mode: <span id="fluid-render-mode" style="color:var(--teal-bright)">FLIP/PIC CPU</span>
particles: <span id="sph-particles">0</span>
active cells: <span id="active-cells">0</span>/<span id="total-cells">3072</span>
skip ratio: <span id="skip-ratio">0%</span>
<span style="color:var(--mist)">// Müller et al. 2003 (SPH)</span>
<span style="color:var(--mist)">// Ihmsen et al. 2014</span>
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="card">
          <div class="card-title">AUDIO MAPPING</div>
          <div style="font-family:var(--font-mono);font-size:11px;color:var(--silver);line-height:1.9">
            Densidad → <span style="color:var(--amber)">Grain density</span><br>
            Velocidad → <span style="color:var(--amber)">Pitch shift</span><br>
            Temperatura → <span style="color:var(--teal-bright)">Reverb mix</span><br>
            <span style="color:var(--mist);font-size:10px">// Di Scipio 2003 · Granular</span>
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="card">
          <div class="card-title">PARÁMETROS SPH</div>
          <div class="code-block">
h      = <span style="color:var(--amber)">0.05</span>  <span style="color:var(--mist)">// smoothing</span>
ρ₀     = <span style="color:var(--amber)">1000</span>  <span style="color:var(--mist)">// rest density</span>
k      = <span style="color:var(--amber)">200</span>   <span style="color:var(--mist)">// stiffness</span>
μ      = <span style="color:var(--amber)">0.9</span>   <span style="color:var(--mist)">// viscosity</span>
          </div>
        </div>
      </div>
    </div>`,

  // ─── XII: Tao — PID Controller ───
  12: () => `
    <div class="module-header">
      <span class="module-num">MÓDULO XIII</span>
      <span class="module-title">Tao</span>
      <span class="module-tag">PID CONTROLLER · Ziegler & Nichols, 1942</span>
    </div>
    <div class="module-body two-col">
      <div>
        <div class="card" style="text-align:center">
          <div class="card-title">BALANCE YIN-YANG</div>
          <canvas id="tao-canvas" width="200" height="200" style="width:200px;height:200px;margin:0 auto;display:block;cursor:pointer"></canvas>
          <div style="margin-top:12px;font-family:var(--font-mono);font-size:12px;color:var(--silver)">
            Equilibrio: <span id="tao-balance" style="color:var(--amber)">50%</span>
          </div>
          <div style="display:flex;gap:8px;justify-content:center;margin-top:10px">
            <button class="btn btn-sm" onclick="ModuleLogic.tao.pushYin()">☯ YANG→</button>
            <button class="btn btn-sm" onclick="ModuleLogic.tao.pushYang()">←YIN ☯</button>
          </div>
        </div>
      </div>
      <div>
        <div class="card">
          <div class="card-title">PID CONTROLLER</div>
          <div class="pid-display">
            <div class="pid-val"><div class="pid-label">Kp</div><div class="pid-num" id="pid-kp">1.00</div></div>
            <div class="pid-val"><div class="pid-label">Ki</div><div class="pid-num" id="pid-ki">0.10</div></div>
            <div class="pid-val"><div class="pid-label">Kd</div><div class="pid-num" id="pid-kd">0.05</div></div>
          </div>
          <div style="height:10px"></div>
          <div class="code-block">
u(t) = Kp·e + Ki·∫e·dt + Kd·(de/dt)
<span class="cm">// setpoint: 0.5 (equilibrio perfecto)</span>
error: <span id="pid-err" class="num">0.000</span>
output: <span id="pid-out" class="num">0.000</span>
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="card">
          <div class="card-title">RESPUESTA TEMPORAL</div>
          <canvas id="pid-canvas" width="300" height="80" style="width:100%;"></canvas>
        </div>
        <div style="height:10px"></div>
        <div class="card">
          <div class="card-title">TERMODINÁMICA SEMÁNTICA</div>
          <div class="code-block">
η = 1 - T₂/T₁ = <span id="carnot-eff" class="num">0.00</span>
G = H - T·S
ΔI = kT·ln(2)  <span class="cm">// Landauer</span>
          </div>
        </div>
      </div>
    </div>`,

  // ─── XXI: Gato de Schrödinger — Weak Measurement (Aharonov et al. 1988) ───
  20: () => `
    <div class="module-header">
      <span class="module-num">MÓDULO XXI</span>
      <span class="module-title">Gato de Schrödinger</span>
      <span class="module-tag">WEAK MEASUREMENT · Aharonov et al. 1988</span>
    </div>
    <div class="module-body two-col">
      <div>
        <div class="card" style="text-align:center">
          <div class="card-title">CAJA DE SCHRÖDINGER</div>
          <div style="position:relative;margin:16px auto;width:160px;height:160px">
            <div class="quantum-box" id="quantum-box" onclick="ModuleLogic.quantum.observe()">
              <div id="quantum-glyph">?</div>
              <div class="quantum-wave" id="quantum-wave">ψ = α|↑⟩ + β|↓⟩</div>
            </div>
          </div>
          <div style="font-family:var(--font-mono);font-size:11px;color:var(--silver)">
            Estado: <span id="quantum-state" style="color:var(--amber)">SUPERPOSICIÓN</span>
          </div>
          <div style="margin-top:8px;font-family:var(--font-mono);font-size:11px;color:var(--silver)">
            α²=<span id="q-alpha" style="color:var(--hermes)">0.500</span>
            β²=<span id="q-beta"  style="color:var(--teal-bright)">0.500</span>
          </div>
          <div style="margin-top:10px;display:flex;gap:6px;justify-content:center;flex-wrap:wrap">
            <button class="btn btn-sm" onclick="ModuleLogic.quantum.observe()">◈ OBSERVAR</button>
            <button class="btn btn-sm" onclick="ModuleLogic.quantum.superpose()">⟳ SUPERPONER</button>
            <button class="quantum-weak-btn" id="weak-btn" onclick="ModuleLogic.quantum.weakMeasure()"
              title="Medición débil — sesga ligeramente la probabilidad a costa de Jabir">
              ⟁ MEDICIÓN DÉBIL (−10 Jabir)
            </button>
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="card">
          <div class="card-title">HISTORIAL DE COLAPSOS</div>
          <div id="quantum-history" style="font-family:var(--font-mono);font-size:11px;color:var(--silver);line-height:1.8;max-height:100px;overflow-y:auto"></div>
        </div>
      </div>
      <div>
        <div class="card">
          <div class="card-title">FUNCIÓN DE ONDA ψ(x)</div>
          <canvas id="quantum-wave-canvas" height="120" style="width:100%;background:var(--void)"></canvas>
        </div>
        <div style="height:10px"></div>
        <div class="card">
          <div class="card-title">ECUACIÓN DE ESTADO</div>
          <div class="code-block">
ψ = α|vivo⟩ + β|muerto⟩
|α|² = <span id="prob-alive" style="color:var(--tao)">50.0</span>% → alive
|β|² = <span id="prob-dead"  style="color:var(--red)">50.0</span>% → dead
<span style="color:var(--mist)">// Medición débil: α² += 0.05</span>
<span style="color:var(--mist)">// Coste: −10 Jabir (Aharonov 1988)</span>
          </div>
        </div>
        <div style="height:10px"></div>`,
        <div class="card">
          <div class="card-title">PROBABILIDADES</div>
          <div id="quantum-probs" style="font-family:var(--font-mono);font-size:12px;line-height:2;color:var(--pale)">
            |↑⟩ (vivo): <span id="q-prob-up" style="color:var(--teal-bright)">50.0%</span><br>
            |↓⟩ (muerto): <span id="q-prob-dn" style="color:var(--red)">50.0%</span>
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="card">
          <div class="card-title">EFECTO EN SABIDURÍA</div>
          <div class="prose" style="font-size:13px">
            <p>Cada observación colapsa la función de onda y otorga sabiduría según el resultado.</p>
            <p><em>Vivo</em> → Rasa +0.05, Tao +0.03</p>
            <p><em>Muerto</em> → Jabir +0.05, entropy +0.03</p>
          </div>
        </div>
      </div>
    </div>`,

  // ─── Módulo XX: Stirling — Programación Dinámica ───
  19: () => `
    <div class="module-header">
      <span class="module-num">MÓDULO XX</span>
      <span class="module-title">Ciclo de Stirling</span>
      <span class="module-tag">PROGRAMACIÓN DINÁMICA · Bellman, 1954</span>
    </div>
    <div class="module-body">
      <div>
        <div class="resource-grid" id="resource-grid">
          <div class="resource-card"><div class="resource-icon">🔥</div><div class="resource-val" id="r-heat">100</div><div class="resource-name">Calor</div></div>
          <div class="resource-card"><div class="resource-icon">❄</div><div class="resource-val"  id="r-cold">100</div><div class="resource-name">Frío</div></div>
          <div class="resource-card"><div class="resource-icon">⚡</div><div class="resource-val" id="r-work">0</div><div class="resource-name">Trabajo</div></div>
          <div class="resource-card"><div class="resource-icon">🌀</div><div class="resource-val" id="r-entropy">0</div><div class="resource-name">Entropía</div></div>
          <div class="resource-card"><div class="resource-icon">💡</div><div class="resource-val" id="r-insight">0</div><div class="resource-name">Perspicacia</div></div>
          <div class="resource-card"><div class="resource-icon">⊕</div><div class="resource-val" id="r-essence">0</div><div class="resource-name">Esencia</div></div>
        </div>
        <div style="height:16px"></div>
        <div id="stirling-actions" style="display:flex;flex-wrap:wrap;gap:8px"></div>
      </div>
      <div>
        <div class="card">
          <div class="card-title">CICLO TERMODINÁMICO</div>
          <canvas id="stirling-canvas" width="300" height="200" style="width:100%;"></canvas>
        </div>
        <div style="height:10px"></div>
        <div class="card">
          <div class="card-title">TABLA DP ÓPTIMA</div>
          <div id="dp-table" style="font-family:var(--font-mono);font-size:10px;color:var(--teal-bright);line-height:1.6"></div>
        </div>
      </div>
    </div>`,

  // ─── XXXIII: Silencio Final — Cage 4'33" ───
  32: () => `
    <div class="module-header">
      <span class="module-num">MÓDULO XXXIII</span>
      <span class="module-title">Silencio</span>
      <span class="module-tag">4'33'' · John Cage, 1952</span>
    </div>
    <div class="silence-container">
      <div style="font-family:var(--font-display);font-size:14px;letter-spacing:6px;color:var(--mist)">
        4 MINUTOS · 33 SEGUNDOS
      </div>
      <div class="silence-timer" id="silence-timer">04:33</div>
      <div class="silence-text">
        "No existe el silencio.<br>
        Siempre hay algo que suena."<br>
        — John Cage
      </div>
      <div style="margin-top:32px">
        <button class="btn" onclick="ModuleLogic.silence.start()">⊙ COMENZAR EL SILENCIO</button>
        <div id="mic-indicator" style="margin-top:12px">
          <div class="mic-dot"></div>
          <span id="mic-label">activar micrófono para monitorear silencio</span>
        </div>
        <div id="noise-meter" style="width:200px;margin-top:4px"><div id="noise-fill" style="width:0%"></div></div>
        <div style="font-family:var(--font-mono);font-size:9px;color:var(--mist);margin-top:4px">
          ruido umbral: <span style="color:var(--amber)">12%</span> · Collins 2008 · "Game Sound"
        </div>
      </div>
      <div id="silence-status" style="margin-top:24px;font-family:var(--font-mono);font-size:12px;color:var(--mist)"></div>
    </div>`,

  // ─── Stub genérico para módulos no implementados ───
  _stub: (mod) => `
    <div class="module-header">
      <span class="module-num">MÓDULO ${mod.num}</span>
      <span class="module-title">${mod.name}</span>
      <span class="module-tag">${mod.tag}</span>
    </div>
    <div class="module-body two-col">
      <div>
        <div class="scroll-text">
          <p>Has alcanzado ${mod.name}. Los sistemas del Oraculvm vibran ante tu presencia.</p>
          <p>Este módulo implementa <em>${mod.tag.toLowerCase()}</em> mediante técnicas avanzadas.</p>
        </div>
        <div style="height:16px"></div>
        <div class="dialogue-box">
          <div class="dialogue-speaker">ORÁCULO · ${mod.glyph}</div>
          <div class="dialogue-text" id="stub-oracle-text">El sistema carga el conocimiento...</div>
        </div>
        <div id="stub-choices" class="dialogue-choices"></div>
      </div>
      <div>
        <div class="card">
          <div class="card-title">PARÁMETROS TÉCNICOS</div>
          <div class="code-block" id="stub-code">
module_id   = <span class="num">${mod.id}</span>
tradition   = ${mod.tradition}
tag         = ${mod.tag}
state       = ACTIVE
hash        = <span id="stub-hash-${mod.id}" class="num">--------</span>
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="card">
          <div class="card-title">SABIDURÍA GENERADA</div>
          <div style="font-family:var(--font-mono);font-size:12px;color:var(--silver);line-height:1.8">
            Tradición: <span style="color:var(--amber)">${mod.tradition.toUpperCase()}</span><br>
            Incremento: <span style="color:var(--teal-bright)">+0.05 al completar</span>
          </div>
        </div>
      </div>
    </div>`
};

// ═══════════════════════════════════════════════════════════════
// MODULE LOGIC — Lógica interactiva por módulo
// ═══════════════════════════════════════════════════════════════
const ModuleLogic = {

  // ─── I: Vestíbulo ───
  vestibulo: {
    kalman: new KalmanFilter(),
    step: 0,
    estimates: [0.5],
    steps: [
      {
        q:"¿Cuál es tu relación con los sistemas de conocimiento?",
        a:['Los evito','Los observo','Los estudio','Los construyo'],
        skill:[0.1,0.35,0.65,0.9],
        wisdom:[
          {catedral:0.01},
          {catedral:0.02,hermes:0.01},
          {hermes:0.03,catedral:0.02},
          {hermes:0.04,jabir:0.02,catedral:0.02}
        ]
      },
      {
        q:"Ante una bifurcación en el camino, ¿qué haces?",
        a:['Retrocedo','Elijo al azar','Calculo la ruta óptima','Las recorro todas'],
        skill:[0.1,0.4,0.7,0.95],
        wisdom:[
          {rasa:0.01},
          {tao:0.02},
          {catedral:0.03,jabir:0.02},
          {hermes:0.04,tao:0.02,rasa:0.02}
        ]
      },
      {
        q:"¿Qué es el Oraculvm para ti?",
        a:['Un juego','Un texto','Una máquina','Una mente'],
        skill:[0.2,0.5,0.7,0.9],
        wisdom:[
          {rasa:0.02},
          {hermes:0.02},
          {jabir:0.03,catedral:0.02},
          {hermes:0.03,tao:0.03,rasa:0.02}
        ]
      },
      {
        q:"¿Cuál es el sentido del número 1310?",
        a:['No sé','Un identificador','Una hora','Una frecuencia del cosmos'],
        skill:[0.1,0.5,0.7,0.99],
        wisdom:[
          {},
          {catedral:0.01},
          {tao:0.03},
          {hermes:0.05,jabir:0.03,tao:0.03,rasa:0.03,catedral:0.03}
        ]
      }
    ],
    init() {
      this.renderStep();
      this.drawKalman();
    },
    renderStep() {
      const tc = document.getElementById('tutorial-content');
      if (!tc) return;
      if (this.step >= this.steps.length) {
        // Complete!
        const est = this.kalman.x;
        tc.innerHTML = `
          <div style="text-align:center;padding:20px">
            <div style="font-size:48px;margin-bottom:12px">⊕</div>
            <div style="font-family:var(--font-display);color:var(--amber);font-size:18px;margin-bottom:12px">CALIBRACIÓN COMPLETA</div>
            <div style="font-family:var(--font-mono);font-size:12px;color:var(--silver);line-height:2">
              Habilidad estimada: <span style="color:var(--amber)">${(est*100).toFixed(1)}%</span><br>
              Confianza: <span style="color:var(--teal-bright)">${((1-this.kalman.p)*100).toFixed(1)}%</span>
            </div>
            <div style="margin-top:16px">
              <button class="btn" onclick="Game.navigate(1)">→ AVANZAR A CUSTODIOS</button>
            </div>
          </div>`;
        OraculvmCore.completeModule(0);
        OraculvmCore.updateWisdom({hermes:0.05,catedral:0.05});
        showWisdomPopup('Vestíbulo completado · +Sabiduría');
        return;
      }
      const s = this.steps[this.step];
      tc.innerHTML = `
        <div style="font-family:var(--font-body);font-size:14px;color:var(--pale);margin-bottom:14px;line-height:1.8">${s.q}</div>
        <div style="display:flex;flex-direction:column;gap:6px">
          ${s.a.map((a,i)=>`
            <button class="choice-btn" onclick="ModuleLogic.vestibulo.answer(${i})">
              <span class="choice-num">${i+1}</span> ${a}
            </button>`).join('')}
        </div>
        <div style="margin-top:10px;font-family:var(--font-mono);font-size:10px;color:var(--mist)">
          PREGUNTA ${this.step+1}/${this.steps.length}
        </div>`;
    },
    answer(i) {
      const s = this.steps[this.step];
      const measurement = s.skill[i];
      const prev = this.kalman.x;
      const est = this.kalman.update(measurement);
      this.estimates.push(est);
      document.getElementById('kalman-est').textContent = est.toFixed(3);

      // Update state display
      const stateEl = document.getElementById('kalman-state');
      if (stateEl) {
        const level = est < 0.3 ? 'NOVICIO' : est < 0.5 ? 'APRENDIZ' : est < 0.7 ? 'INICIADO' : est < 0.85 ? 'ADEPTO' : 'MAESTRO';
        stateEl.innerHTML = `
          Nivel: <span style="color:var(--amber)">${level}</span><br>
          x̂: ${prev.toFixed(4)} → ${est.toFixed(4)}<br>
          K: ${this.kalman.p.toFixed(4)} | P: ${this.kalman.p.toFixed(4)}<br>
          Medición: ${measurement.toFixed(2)}`;
      }

      // Apply wisdom
      OraculvmCore.updateWisdom(s.wisdom[i]);

      this.step++;
      this.renderStep();
      this.drawKalman();
    },
    drawKalman() {
      const canvas = document.getElementById('kalman-canvas');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const W=canvas.width, H=canvas.height;
      ctx.clearRect(0,0,W,H);
      ctx.fillStyle = '#030508'; ctx.fillRect(0,0,W,H);

      // Grid
      ctx.strokeStyle='rgba(200,150,42,0.05)'; ctx.lineWidth=1;
      for (let y=0; y<=H; y+=20) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); }

      // Curve
      if (this.estimates.length < 2) return;
      ctx.strokeStyle='rgba(200,150,42,0.8)'; ctx.lineWidth=2;
      ctx.beginPath();
      this.estimates.forEach((e,i) => {
        const x = (i/(this.estimates.length-1))*W;
        const y = H - e*H;
        i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
      });
      ctx.stroke();

      // Current point
      const last = this.estimates[this.estimates.length-1];
      const lx = W-2, ly = H-last*H;
      ctx.fillStyle='var(--amber)';
      ctx.beginPath(); ctx.arc(lx,ly,4,0,Math.PI*2); ctx.fill();

      // Label
      ctx.fillStyle='rgba(200,150,42,0.5)'; ctx.font='10px Share Tech Mono';
      ctx.fillText(`x̂=${last.toFixed(3)}`,lx-45,ly-8);
    }
  },

  // ─── II: Custodios ───
  custodios: {
    tree: null,
    current: null,
    history: [],
    dialogues: {
      root: {
        speaker: "CUSTODIO ∅",
        text: "Viajero. Antes de que avances, debes demostrar que comprendes la naturaleza del Oraculvm. ¿Por qué has venido?",
        choices: [
          { text:"Busco conocimiento", next:"knowledge", wisdom:{hermes:0.04,catedral:0.02} },
          { text:"Busco poder",        next:"power",     wisdom:{jabir:0.03,rasa:0.02} },
          { text:"Busco equilibrio",   next:"balance",   wisdom:{tao:0.05} },
          { text:"No lo sé",           next:"unknown",   wisdom:{hermes:0.02,rasa:0.02} }
        ]
      },
      knowledge: {
        speaker: "CUSTODIO ∅",
        text: "El conocimiento es un arma de doble filo. La tradición de Hermes te enseña que cada símbolo oculta otro símbolo. ¿Estás preparado para la regresión infinita?",
        choices: [
          { text:"Sí, abro el camino",  next:"accept",  wisdom:{hermes:0.06} },
          { text:"Necesito más tiempo", next:"wait",    wisdom:{catedral:0.02} }
        ]
      },
      power: {
        speaker: "CUSTODIO ΔΨ",
        text: "El poder sin sabiduría es entropía. Jabir enseña que toda transformación tiene un coste. ¿Qué estás dispuesto a sacrificar?",
        choices: [
          { text:"Tiempo",  next:"accept", wisdom:{jabir:0.04,tao:0.02} },
          { text:"Memoria", next:"memory", wisdom:{jabir:0.05,rasa:-0.01} }
        ]
      },
      balance: {
        speaker: "CUSTODIO ∞",
        text: "El Tao que puede ser nombrado no es el Tao eterno. Buscas lo que no puede buscarse. Quizá eso te hace más sabio que todos los demás.",
        choices: [
          { text:"Entonces deja pasar sin preguntas",  next:"accept", wisdom:{tao:0.07} }
        ]
      },
      unknown: {
        speaker: "CUSTODIO Ω",
        text: "La ignorancia honesta es la primera forma de sabiduría. Al menos sabes lo que no sabes. El Oraculvm te recibe.",
        choices: [
          { text:"Gracias", next:"accept", wisdom:{hermes:0.03,rasa:0.03} }
        ]
      },
      memory: {
        speaker: "CUSTODIO ΔΨ",
        text: "Entonces olvida tu nombre durante este trayecto. Dentro del Oraculvm serás solo un patrón de datos fluyendo a través de 33 compuertas.",
        choices: [
          { text:"Acepto el olvido", next:"accept", wisdom:{jabir:0.06,rasa:0.03} }
        ]
      },
      wait: {
        speaker: "CUSTODIO ∅",
        text: "El tiempo dentro del Oraculvm no avanza como fuera. Puedes esperar siglos y aún así nunca estar listo. Pero puedes entrar ahora.",
        choices: [
          { text:"Entro ahora", next:"accept", wisdom:{catedral:0.04} }
        ]
      },
      accept: {
        speaker: "ORACULVM",
        text: "Las puertas se abren. Que el número 1310 sea tu guía.\n\n[COMPILACIÓN_LOCK: 0 · MÓDULOS DESBLOQUEADOS: 3]",
        choices: [
          { text:"Avanzar →", next:null, action:'complete', wisdom:{hermes:0.05,rasa:0.05} }
        ]
      }
    },
    init() {
      this.current = this.tree = this.dialogues.root;
      this.history = [];
      this.render();
    },
    render() {
      const d = this.current;
      if (!d) return;
      document.getElementById('dlg-speaker').textContent = d.speaker;
      document.getElementById('dlg-text').textContent = d.text;

      const choicesEl = document.getElementById('dlg-choices');
      choicesEl.innerHTML = d.choices.map((c,i)=>`
        <button class="choice-btn" onclick="ModuleLogic.custodios.choose(${i})">
          <span class="choice-num">${i+1}</span> ${c.text}
        </button>`).join('');

      // Update tree visualization
      const treeEl = document.getElementById('dlg-tree');
      if (treeEl) {
        const depth = this.history.length;
        treeEl.innerHTML = `<span class="cm">// LZ77 comprimido: profundidad ${depth}</span>\n` +
          this.history.map((h,i)=>`${'  '.repeat(i)}└─ ${h}`).join('\n') +
          `\n${'  '.repeat(depth)}└─ <span class="kw">[ACTUAL]</span>`;
      }
    },
    choose(i) {
      const c = this.current.choices[i];
      this.history.push(c.text.substring(0,30));
      OraculvmCore.updateWisdom(c.wisdom||{});

      // History log
      const hist = document.getElementById('dlg-history');
      if (hist) hist.innerHTML += `<div>> ${c.text}</div>`;

      if (c.action === 'complete') {
        OraculvmCore.completeModule(1);
        showWisdomPopup('Custodios completado · Puertas abiertas');
        setTimeout(()=>Game.navigate(2), 1000);
        return;
      }
      this.current = this.dialogues[c.next];
      this.render();
    },
    async generateAIResponse() {
      const btn = document.getElementById('ai-generate-btn');
      const container = document.getElementById('ai-response-container');
      if (!btn || !container) return;

      btn.disabled = true;
      container.innerHTML = '<div class="ai-thinking">⟳ Invocando al Oráculo generativo...</div>';

      const wisdom = OraculvmCore.getWisdom();
      const history = this.history.slice(-5).join(' → ');
      const currentSpeaker = this.current ? this.current.speaker : 'CUSTODIO ∅';
      const totalTokens = parseInt(document.getElementById('llm-tokens')?.textContent || '0');

      const system = `Eres ${currentSpeaker}, un guardián del Oraculvm, un laberinto de conocimiento místico que combina hermetismo, alquimia jabiriense, taoísmo y arquitectura gótica. El año es 1310.
Tradiciones activas del jugador: Hermes=${(wisdom.hermes*100).toFixed(0)}%, Rasa=${(wisdom.rasa*100).toFixed(0)}%, Tao=${(wisdom.tao*100).toFixed(0)}%, Jabir=${(wisdom.jabir*100).toFixed(0)}%, Catedral=${(wisdom.catedral*100).toFixed(0)}%.
Genera UNA sola línea de diálogo críptica, poética y filosófica (máximo 60 palabras). NO uses markdown. Solo el texto del diálogo.`;

      const prompt = `Historial: ${history || 'inicio'}. El viajero ha llegado ante ti. Habla.`;

      try {
        const resp = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 150,
            system,
            messages: [{ role:'user', content: prompt }]
          })
        });
        const data = await resp.json();
        const text = data.content?.[0]?.text || 'El Oráculo guarda silencio.';
        const newTokens = totalTokens + (data.usage?.output_tokens || text.split(' ').length);
        if(document.getElementById('llm-tokens')) document.getElementById('llm-tokens').textContent = newTokens;

        container.innerHTML = `
          <div class="dialogue-box ai-response" style="margin-top:0">
            <div class="dialogue-speaker" style="color:#9b59b6">${currentSpeaker} <span class="ai-badge">✦ IA</span></div>
            <div class="dialogue-text" id="ai-dlg-text"></div>
          </div>`;
        const el = document.getElementById('ai-dlg-text');
        if(el) typeText(el, text, 25);
        OraculvmCore.updateWisdom({hermes:0.01});
      } catch(e) {
        container.innerHTML = `<div style="font-family:var(--font-mono);font-size:11px;color:var(--mist)">El Oráculo no puede hablar ahora. [${e.message}]</div>`;
      }
      btn.disabled = false;
    }
  },

  // ─── IV: Árbol de la Vida ───
  tree: {
    graph: null,
    path: [],
    selected: null,
    sephiroth: [
      {id:'kether',  label:'Kether',     x:200, y:20,  desc:'La corona. El punto de emanación primordial.',         tradition:'catedral'},
      {id:'chokmah', label:'Chokmah',    x:320, y:80,  desc:'La sabiduría. Fuerza primordial masculina.',           tradition:'hermes'},
      {id:'binah',   label:'Binah',      x:80,  y:80,  desc:'La comprensión. Forma primordial femenina.',           tradition:'rasa'},
      {id:'chesed',  label:'Chesed',     x:320, y:160, desc:'La misericordia. Expansión y abundancia.',             tradition:'catedral'},
      {id:'geburah', label:'Geburah',    x:80,  y:160, desc:'La fortaleza. Restricción y rigor.',                   tradition:'jabir'},
      {id:'tiphareth',label:'Tiferet',   x:200, y:200, desc:'La belleza. El corazón del árbol.',                    tradition:'hermes'},
      {id:'netzach', label:'Netzach',    x:320, y:270, desc:'La victoria. Emoción y naturaleza.',                   tradition:'rasa'},
      {id:'hod',     label:'Hod',        x:80,  y:270, desc:'La gloria. Intelecto y magia.',                        tradition:'hermes'},
      {id:'yesod',   label:'Yesod',      x:200, y:310, desc:'El fundamento. El inconsciente.',                      tradition:'tao'},
      {id:'malkuth', label:'Malkuth',    x:200, y:380, desc:'El reino. La manifestación material.',                 tradition:'jabir'}
    ],
    edges: [
      {a:'kether',b:'chokmah',w:1},{a:'kether',b:'binah',w:1},{a:'kether',b:'tiphareth',w:2},
      {a:'chokmah',b:'binah',w:3},{a:'chokmah',b:'chesed',w:1},{a:'chokmah',b:'tiphareth',w:2},
      {a:'binah',b:'geburah',w:1},{a:'binah',b:'tiphareth',w:2},
      {a:'chesed',b:'geburah',w:2},{a:'chesed',b:'tiphareth',w:1},{a:'chesed',b:'netzach',w:1},
      {a:'geburah',b:'tiphareth',w:1},{a:'geburah',b:'hod',w:1},
      {a:'tiphareth',b:'netzach',w:1},{a:'tiphareth',b:'hod',w:1},{a:'tiphareth',b:'yesod',w:1},
      {a:'netzach',b:'hod',w:2},{a:'netzach',b:'yesod',w:1},{a:'netzach',b:'malkuth',w:1},
      {a:'hod',b:'yesod',w:1},{a:'hod',b:'malkuth',w:1},
      {a:'yesod',b:'malkuth',w:1}
    ],
    init() {
      this.graph = { nodes: this.sephiroth.map(s=>({id:s.id, x:s.x, y:s.y})), edges: this.edges };
      this.draw();
      // Init L-system
      setTimeout(()=>ModuleLogic.lsystem.draw(), 100);
    },
    draw(highlightPath=[]) {
      const svg = document.getElementById('tree-svg');
      if (!svg) return;
      const hp = new Set(highlightPath);

      let edgesHTML = this.edges.map(e => {
        const a = this.sephiroth.find(s=>s.id===e.a);
        const b = this.sephiroth.find(s=>s.id===e.b);
        const inPath = hp.has(e.a)&&hp.has(e.b);
        return `<line x1="${a.x}" y1="${a.y}" x2="${b.x}" y2="${b.y}"
          stroke="${inPath?'#e8a830':'rgba(200,150,42,0.2)'}"
          stroke-width="${inPath?2.5:1}" />`;
      }).join('');

      let nodesHTML = this.sephiroth.map(s => {
        const inPath = hp.has(s.id);
        const isSelected = this.selected===s.id;
        const tradColors = {hermes:'#9b59b6',rasa:'#e74c3c',tao:'#27ae60',jabir:'#e67e22',catedral:'#2980b9'};
        const color = tradColors[s.tradition]||'#c8962a';
        return `
          <circle cx="${s.x}" cy="${s.y}" r="18" fill="${inPath?'rgba(232,168,48,0.2)':'rgba(13,21,32,0.8)'}"
            stroke="${isSelected?'#f0c060':inPath?'#e8a830':color}"
            stroke-width="${isSelected?3:1.5}" style="cursor:pointer"
            onclick="ModuleLogic.tree.selectNode('${s.id}')" />
          <text x="${s.x}" y="${s.y+4}" text-anchor="middle" fill="${inPath?'#f0c060':color}"
            font-family="Share Tech Mono" font-size="8" style="pointer-events:none">${s.label.substring(0,6)}</text>`;
      }).join('');

      svg.innerHTML = edgesHTML + nodesHTML;
    },
    selectNode(id) {
      this.selected = id;
      const s = this.sephiroth.find(n=>n.id===id);
      const info = document.getElementById('sephirot-info');
      if (info && s) {
        info.innerHTML = `
          <strong style="color:var(--amber);font-family:var(--font-display)">${s.label}</strong><br>
          <span style="font-size:12px;color:var(--silver)">${s.desc}</span><br>
          <span style="font-family:var(--font-mono);font-size:11px;color:var(--teal-bright)">Tradición: ${s.tradition}</span>`;
      }
      this.draw(this.path.length>0?this.path:[]);
    },
    findPath() {
      const start = 'kether', goal = 'malkuth';
      const log = document.getElementById('astar-log');
      if (log) log.innerHTML = `<div class="terminal-line">A* desde ${start} → ${goal}</div>`;
      const path = astar(this.graph, start, goal);
      this.path = path;
      this.draw(path);
      if (log) {
        path.forEach((n,i) => {
          setTimeout(()=>{
            log.innerHTML += `<div class="terminal-line">[${i}] ${n}</div>`;
            log.scrollTop=log.scrollHeight;
          }, i*100);
        });
        setTimeout(()=>{
          log.innerHTML += `<div class="terminal-line" style="color:var(--amber)">Costo: ${path.length-1} pasos</div>`;
        }, path.length*100+100);
      }
      OraculvmCore.updateWisdom({catedral:0.04,hermes:0.03});
      showWisdomPopup('A* completado · Ruta óptima hallada');
    },
    reset() { this.path=[]; this.draw(); }
  },

  // ─── L-System Tree (Idea 4: Prusinkiewicz 1990) ───
  lsystem: {
    generation: 0,
    angle: 25,
    rules: { 'F':'FF', 'X':'F+[[X]-X]-F[-FX]+X' },
    axiom: 'X',
    current: 'X',
    traditions: { hermes:'geometric', rasa:'organic', tao:'balanced', jabir:'branching', catedral:'structured' },

    getDominantTradition() {
      const W = OraculvmCore.getWisdom();
      return Object.entries(W).reduce((a,b) => b[1]>a[1]?b:a, ['catedral',0])[0];
    },

    applyRules(str) {
      return str.split('').map(c => this.rules[c] || c).join('');
    },

    grow() {
      if (this.generation >= 5) {
        this.generation = 0; this.current = this.axiom;
      }
      this.current = this.applyRules(this.current);
      this.generation++;

      // Adjust based on dominant tradition
      const trad = this.getDominantTradition();
      if (trad === 'hermes') { this.angle = 30; this.rules['X'] = 'F+[X]+F[-X]F'; }
      else if (trad === 'rasa') { this.angle = 22; this.rules['X'] = 'F+[[X]-X]-F[-FX]+X'; }
      else if (trad === 'tao') { this.angle = 25; this.rules['F'] = 'FF'; }
      else if (trad === 'jabir') { this.angle = 35; this.rules['X'] = 'F-[[X]+X]+F[+FX]-X'; }

      const badge = document.getElementById('lsystem-badge');
      const genEl = document.getElementById('ls-gen');
      const angleEl = document.getElementById('ls-angle');
      const rulesEl = document.getElementById('lsystem-rules');
      if(badge) badge.textContent = `GEN:${this.generation}`;
      if(genEl) genEl.textContent = this.generation;
      if(angleEl) angleEl.textContent = this.angle;
      if(rulesEl) rulesEl.innerHTML = `F → ${this.rules['F']}\nX → ${this.rules['X'].substring(0,30)}\n<span style="color:var(--mist)">// Tradición: ${trad.toUpperCase()}</span>\n<span style="color:var(--mist)">// Longitud: ${this.current.length} símbolos</span>`;

      this.draw();
      OraculvmCore.updateWisdom({catedral:0.01, hermes:0.01});
      showWisdomPopup(`L-System Gen ${this.generation} · ${trad.toUpperCase()}`);
    },

    reset() {
      this.generation = 0;
      this.current = this.axiom;
      this.rules = { 'F':'FF', 'X':'F+[[X]-X]-F[-FX]+X' };
      this.angle = 25;
      const badge = document.getElementById('lsystem-badge');
      if(badge) badge.textContent = 'GEN:0';
      this.draw();
    },

    draw() {
      const canvas = document.getElementById('lsystem-canvas');
      if(!canvas) return;
      const W = canvas.offsetWidth || 400;
      canvas.width = W;
      const H = canvas.height = 200;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#030508';
      ctx.fillRect(0,0,W,H);

      // Stack-based L-system renderer
      const trad = this.getDominantTradition();
      const tradColors = {hermes:'#9b59b6',rasa:'#e74c3c',tao:'#27ae60',jabir:'#e67e22',catedral:'#2980b9'};
      const col = tradColors[trad] || '#c8962a';

      const len = Math.max(2, 40 / Math.pow(1.8, this.generation));
      const ang = this.angle * Math.PI / 180;

      let x = W/2, y = H-10;
      let dir = -Math.PI/2;
      const stack = [];
      let depth = 0;

      ctx.beginPath();
      ctx.moveTo(x, y);
      ctx.strokeStyle = col;
      ctx.lineWidth = Math.max(0.5, 2 - this.generation*0.3);

      const maxSymbols = Math.min(this.current.length, 3000);
      for(let i=0; i<maxSymbols; i++) {
        const c = this.current[i];
        if(c==='F') {
          const nx = x + Math.cos(dir)*len;
          const ny = y + Math.sin(dir)*len;
          ctx.moveTo(x,y);
          const alpha = Math.max(0.2, 1 - depth*0.15);
          ctx.strokeStyle = `rgba(${trad==='hermes'?'155,89,182':trad==='rasa'?'231,76,60':trad==='tao'?'39,174,96':trad==='jabir'?'230,126,34':'41,128,185'},${alpha})`;
          ctx.lineTo(nx,ny);
          ctx.stroke();
          x = nx; y = ny;
          ctx.beginPath();
        } else if(c==='+') { dir += ang; }
        else if(c==='-') { dir -= ang; }
        else if(c==='[') { stack.push({x,y,dir}); depth++; }
        else if(c===']' && stack.length>0) { const s=stack.pop(); x=s.x; y=s.y; dir=s.dir; depth=Math.max(0,depth-1); }
      }

      // Glow overlay
      ctx.shadowBlur = 6;
      ctx.shadowColor = col;
    }
  },

  // ─── V: Tarot ───
  tarot: {
    mt: new MersenneTwister(1310),
    deck: [],
    drawn: [],
    arcana: [
      {name:'El Loco',        glyph:'🃏', num:0,   meaning:'Inicio, espontaneidad, potencial ilimitado'},
      {name:'El Mago',        glyph:'✦',  num:1,   meaning:'Voluntad, habilidad, manifestación'},
      {name:'La Sacerdotisa', glyph:'☽',  num:2,   meaning:'Intuición, misterio, conocimiento interior'},
      {name:'La Emperatriz',  glyph:'♀',  num:3,   meaning:'Abundancia, creatividad, naturaleza'},
      {name:'El Emperador',   glyph:'♂',  num:4,   meaning:'Estructura, autoridad, estabilidad'},
      {name:'El Hierofante',  glyph:'⊕',  num:5,   meaning:'Tradición, conformidad, enseñanza'},
      {name:'Los Amantes',    glyph:'⚤',  num:6,   meaning:'Unión, elección, alineación de valores'},
      {name:'El Carro',       glyph:'⚡',  num:7,   meaning:'Voluntad, control, victoria'},
      {name:'La Fuerza',      glyph:'∞',  num:8,   meaning:'Coraje, paciencia, persuasión interna'},
      {name:'El Ermitaño',    glyph:'☿',  num:9,   meaning:'Búsqueda interior, retiro, guía'},
      {name:'La Rueda',       glyph:'⊚',  num:10,  meaning:'Ciclos, destino, giros de fortuna'},
      {name:'La Justicia',    glyph:'⚖',  num:11,  meaning:'Equidad, verdad, causa y efecto'},
      {name:'El Colgado',     glyph:'⊗',  num:12,  meaning:'Suspensión, sacrificio, nueva perspectiva'},
      {name:'La Muerte',      glyph:'⌖',  num:13,  meaning:'Transformación, final, transición'},
      {name:'La Templanza',   glyph:'⌬',  num:14,  meaning:'Equilibrio, moderación, paciencia'},
      {name:'El Diablo',      glyph:'⦿',  num:15,  meaning:'Sombra, restricción, adicción'},
      {name:'La Torre',       glyph:'⊞',  num:16,  meaning:'Cambio brusco, revelación, caos'},
      {name:'La Estrella',    glyph:'✶',  num:17,  meaning:'Esperanza, renovación, fe'},
      {name:'La Luna',        glyph:'◉',  num:18,  meaning:'Ilusión, miedo, el subconsciente'},
      {name:'El Sol',         glyph:'☀',  num:19,  meaning:'Éxito, vitalidad, alegría'},
      {name:'El Juicio',      glyph:'⟁',  num:20,  meaning:'Reflexión, reckoning, absolution'},
      {name:'El Mundo',       glyph:'◎',  num:21,  meaning:'Completion, integration, accomplishment'},
    ],
    init() {
      this.deck = [...this.arcana];
      this.drawn = [];
      this.renderDeck();
    },
    shuffle() {
      // Fisher-Yates con MT
      const seed = this.mt.range(1000,9999);
      this.mt = new MersenneTwister(seed);
      document.getElementById('tarot-seed').textContent = seed;
      document.getElementById('mt-seed-display').textContent = seed;
      for (let i=this.deck.length-1; i>0; i--) {
        const j = this.mt.range(0,i);
        [this.deck[i],this.deck[j]] = [this.deck[j],this.deck[i]];
      }
      this.drawn = [];
      this.renderDeck();
      document.getElementById('tarot-reading-text').textContent = 'Baraja mezclada. Las cartas esperan ser reveladas...';
    },
    draw() {
      if (this.deck.length === 0) { this.init(); return; }
      const idx = this.mt.range(0, this.deck.length-1);
      const card = this.deck.splice(idx, 1)[0];
      this.drawn.push(card);
      this.renderDeck();
      this.renderReading();
      OraculvmCore.updateWisdom({jabir:0.02});
    },
    renderDeck() {
      const grid = document.getElementById('tarot-grid');
      if (!grid) return;
      const all = [...this.drawn, ...this.deck];
      grid.innerHTML = all.map((c,i) => {
        const isDrawn = i < this.drawn.length;
        return `<div class="tarot-card ${isDrawn?'revealed':''}" onclick="ModuleLogic.tarot.showCard(${c.num})">
          <div class="tarot-face">${isDrawn?c.glyph:'?'}</div>
          <div class="tarot-name">${isDrawn?c.name:'OCULTA'}</div>
        </div>`;
      }).join('');
    },
    showCard(num) {
      const card = this.arcana.find(c=>c.num===num);
      if (!card) return;
      const rt = document.getElementById('tarot-reading-text');
      if (rt) rt.innerHTML = `
        <div style="text-align:center;font-size:32px;margin-bottom:8px">${card.glyph}</div>
        <div style="font-family:var(--font-display);color:var(--amber);margin-bottom:8px">${card.name} · Arcano ${card.num}</div>
        <div style="color:var(--silver)">${card.meaning}</div>`;
    },
    renderReading() {
      const rt = document.getElementById('tarot-reading-text');
      if (!rt || this.drawn.length===0) return;
      const last = this.drawn[this.drawn.length-1];
      const positions = ['Pasado','Presente','Futuro','Lo oculto','Lo revelado'];
      const pos = positions[Math.min(this.drawn.length-1, positions.length-1)];
      rt.innerHTML = `
        <div style="font-family:var(--font-mono);font-size:10px;color:var(--dim-gold);margin-bottom:6px">${pos}</div>
        <div style="font-size:28px;text-align:center;margin-bottom:8px">${last.glyph}</div>
        <div style="font-family:var(--font-display);color:var(--amber);margin-bottom:6px">${last.name}</div>
        <div style="color:var(--pale);font-size:14px">${last.meaning}</div>
        <div style="margin-top:12px;font-family:var(--font-mono);font-size:10px;color:var(--mist)">
          MT output: ${this.mt.generate()>>>0}
        </div>`;
    }
  },

  // ─── IX: XENON-Σ ───
  fluid: {
    sim: null,
    animId: null,
    quality: 'lite',
    history: [],
    init() {
      this.sim = new FluidSim(64, 48);
      this.loop();
    },
    loop() {
      const canvas = document.getElementById('fluid-canvas');
      if (!canvas) { cancelAnimationFrame(this.animId); return; }

      if (this.useWebGL) {
        this.stepSPH();
        this.renderSPH();
      } else {
        const ctx = canvas.getContext('2d');
        this.sim.step(0.016);
        this.sim.render(ctx, canvas.width, canvas.height);
      }

      // Stats
      let active = 0;
      for (let i=0; i<this.sim.N; i++) if (this.sim.active[i]) active++;
      const activeEl=document.getElementById('active-cells');
      const skipEl=document.getElementById('skip-ratio');
      const sphParts=document.getElementById('sph-particles');
      if (activeEl) activeEl.textContent=active;
      if (skipEl) skipEl.textContent=((1-active/this.sim.N)*100).toFixed(1)+'%';
      if (sphParts) sphParts.textContent = this.useWebGL ? this.sphParticles.length : 0;

      // Audio coupling (Idea 2)
      const density = active / this.sim.N;
      const cx=32,cy=24,ci=cy*64+cx;
      const vel = Math.hypot(this.sim.u[ci]||0, this.sim.v[ci]||0);
      GranularEngine.setFluidParams(density, vel);

      // history for PCG chart - now repurposed
      this.history.push(active/this.sim.N);
      if (this.history.length>60) this.history.shift();

      this.animId = requestAnimationFrame(()=>this.loop());
    },
    // SPH (WebGL mode) - Müller et al. 2003
    sphParticles: [],
    useWebGL: false,
    toggleWebGL() {
      this.useWebGL = !this.useWebGL;
      const cpu = document.getElementById('fluid-canvas');
      const gpu = document.getElementById('webgl-fluid-canvas');
      const badge = document.getElementById('fluid-mode-badge');
      const btn = document.getElementById('webgl-toggle-btn');
      const mode = document.getElementById('fluid-render-mode');
      if(this.useWebGL) {
        if(cpu) cpu.style.display='none';
        if(gpu) gpu.style.display='block';
        if(badge){ badge.className='fluid-quality-badge fq-gpu'; badge.textContent='WebGL SPH'; }
        if(btn) btn.textContent='⬡ DESACTIVAR SPH WebGL';
        if(mode) mode.textContent='SPH WebGL · GPU';
        // Init SPH particles
        this.sphParticles = [];
        for(let i=0;i<200;i++) {
          this.sphParticles.push({
            x:Math.random()*0.6+0.2, y:Math.random()*0.4+0.3,
            vx:(Math.random()-0.5)*0.02, vy:(Math.random()-0.5)*0.02,
            density:1, pressure:0
          });
        }
      } else {
        if(cpu) cpu.style.display='block';
        if(gpu) { gpu.style.display='none'; }
        if(badge){ badge.className='fluid-quality-badge fq-cpu'; badge.textContent='CPU'; }
        if(btn) btn.textContent='⬡ ACTIVAR SPH WebGL';
        if(mode) mode.textContent='FLIP/PIC CPU';
      }
      OraculvmCore.setStatus(`XENON-Σ: Modo ${this.useWebGL?'SPH WebGL':'FLIP/PIC CPU'}`);
    },
    stepSPH() {
      // Simplified SPH in JS with WebGL-style Canvas2D rendering
      const h=0.08, k=200, rho0=1, mu=0.9, dt=0.016;
      const p = this.sphParticles;
      const N = p.length;

      // Compute densities (poly6 kernel)
      for(let i=0;i<N;i++) {
        let d=0;
        for(let j=0;j<N;j++) {
          const dx=p[i].x-p[j].x, dy=p[i].y-p[j].y;
          const r2=dx*dx+dy*dy;
          if(r2<h*h) { const q=1-r2/(h*h); d+=q*q*q; }
        }
        p[i].density=Math.max(0.01,d*315/(64*Math.PI*h*h*h));
        p[i].pressure=k*(p[i].density-rho0);
      }

      // Integrate forces
      for(let i=0;i<N;i++) {
        let fx=0, fy=0.001; // gravity
        for(let j=0;j<N;j++) {
          if(i===j) continue;
          const dx=p[i].x-p[j].x, dy=p[i].y-p[j].y;
          const r=Math.sqrt(dx*dx+dy*dy)+0.0001;
          if(r<h) {
            // Pressure (spiky kernel)
            const q=(h-r); const pf=(p[i].pressure+p[j].pressure)/(2*p[j].density)*q*q*45/(Math.PI*Math.pow(h,6));
            fx += pf*dx/r; fy += pf*dy/r;
            // Viscosity
            fx += mu*(p[j].vx-p[i].vx)*(h-r)*45/(Math.PI*Math.pow(h,6));
            fy += mu*(p[j].vy-p[i].vy)*(h-r)*45/(Math.PI*Math.pow(h,6));
          }
        }
        p[i].vx = (p[i].vx + fx*dt/p[i].density) * 0.99;
        p[i].vy = (p[i].vy + fy*dt/p[i].density) * 0.99;
        p[i].x += p[i].vx*dt;
        p[i].y += p[i].vy*dt;
        // Boundary
        if(p[i].x<0.02){p[i].x=0.02;p[i].vx*=-0.5;}
        if(p[i].x>0.98){p[i].x=0.98;p[i].vx*=-0.5;}
        if(p[i].y<0.02){p[i].y=0.02;p[i].vy*=-0.5;}
        if(p[i].y>0.98){p[i].y=0.98;p[i].vy*=-0.5;}
      }
    },
    renderSPH() {
      const canvas = document.getElementById('webgl-fluid-canvas');
      if(!canvas) return;
      const W=canvas.width, H=canvas.height;
      const ctx=canvas.getContext('2d');
      ctx.fillStyle='rgba(3,5,8,0.3)';
      ctx.fillRect(0,0,W,H);

      const p=this.sphParticles;
      for(let i=0;i<p.length;i++) {
        const x=p[i].x*W, y=p[i].y*H;
        const d=Math.min(1,p[i].density);
        const r=Math.floor(d*60+20), g=Math.floor(d*100+40), b=Math.floor(d*180+60);
        const size=8+d*6;
        // Splatting
        const grad=ctx.createRadialGradient(x,y,0,x,y,size);
        grad.addColorStop(0,`rgba(${r},${g},${b},0.7)`);
        grad.addColorStop(1,`rgba(${r},${g},${b},0)`);
        ctx.beginPath();
        ctx.arc(x,y,size,0,Math.PI*2);
        ctx.fillStyle=grad;
        ctx.fill();
      }
    },
    addSource() {
      const x=Math.floor(Math.random()*50)+7;
      const y=Math.floor(Math.random()*35)+6;
      for(let dy=-3;dy<=3;dy++) for(let dx=-3;dx<=3;dx++) {
        const ci=(y+dy)*64+(x+dx);
        if(ci>=0&&ci<this.sim.N) {
          this.sim.d[ci]=Math.random()*0.8+0.2;
          this.sim.active[ci]=1;
        }
      }
      if(this.useWebGL) {
        for(let i=0;i<10;i++) {
          this.sphParticles.push({
            x:0.3+Math.random()*0.4, y:0.2+Math.random()*0.3,
            vx:(Math.random()-0.5)*0.05, vy:Math.random()*0.05,
            density:1, pressure:0
          });
        }
      }
    },
    clear() {
      this.sim.d.fill(0); this.sim.u.fill(0);
      this.sim.v.fill(0); this.sim.active.fill(0);
    },
    destroy() { cancelAnimationFrame(this.animId); this.animId=null; }
  },

  // ─── XIII: Tao ───
  tao: {
    pid: new PIDController(1.0,0.1,0.05),
    balance: 0.5, // 0=yin 1=yang
    history: [],
    animId: null,
    taoCanvas: null,
    init() {
      this.drawTao();
      this.loop();
    },
    loop() {
      const output = this.pid.compute(0.5, this.balance);
      this.balance += output * 0.005;
      this.balance = Math.max(0, Math.min(1, this.balance));
      this.history.push(this.balance);
      if (this.history.length>100) this.history.shift();

      const balEl=document.getElementById('tao-balance');
      if(balEl) balEl.textContent=(this.balance*100).toFixed(1)+'%';

      const errEl=document.getElementById('pid-err');
      const outEl=document.getElementById('pid-out');
      if(errEl) errEl.textContent=(0.5-this.balance).toFixed(3);
      if(outEl) outEl.textContent=output.toFixed(3);

      const effEl=document.getElementById('carnot-eff');
      if(effEl) {
        const T1=300+this.balance*200, T2=200;
        effEl.textContent=(1-T2/T1).toFixed(3);
      }

      this.drawTao();
      this.drawPID();
      this.animId = requestAnimationFrame(()=>this.loop());
    },
    drawTao() {
      const canvas=document.getElementById('tao-canvas');
      if(!canvas) return;
      const ctx=canvas.getContext('2d');
      const W=canvas.width, H=canvas.height, R=Math.min(W,H)/2-4;
      const cx=W/2, cy=H/2;
      ctx.clearRect(0,0,W,H);

      // Yin-Yang
      const angle = this.balance * Math.PI * 2;
      ctx.fillStyle='#1a2a3a'; ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.fill();

      // Yang (white/gold half)
      ctx.fillStyle=`rgba(200,150,42,${0.3+this.balance*0.4})`;
      ctx.beginPath();
      ctx.arc(cx,cy,R,angle,angle+Math.PI);
      ctx.arc(cx,cy+R/2,R/2,angle+Math.PI,angle,true);
      ctx.arc(cx,cy-R/2,R/2,angle,angle+Math.PI,false);
      ctx.closePath(); ctx.fill();

      // Dots
      ctx.fillStyle='rgba(13,21,32,0.8)';
      ctx.beginPath(); ctx.arc(cx+Math.cos(angle+Math.PI/2)*R/2, cy+Math.sin(angle+Math.PI/2)*R/2, R/6, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle='rgba(200,150,42,0.6)';
      ctx.beginPath(); ctx.arc(cx+Math.cos(angle-Math.PI/2)*R/2, cy+Math.sin(angle-Math.PI/2)*R/2, R/6, 0, Math.PI*2); ctx.fill();

      // Border
      ctx.strokeStyle='rgba(200,150,42,0.3)'; ctx.lineWidth=1;
      ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.stroke();

      // Balance line
      ctx.strokeStyle='rgba(200,150,42,0.15)';
      ctx.setLineDash([3,3]); ctx.lineWidth=1;
      ctx.beginPath(); ctx.moveTo(cx,cy-R); ctx.lineTo(cx,cy+R);
      ctx.stroke(); ctx.setLineDash([]);
    },
    drawPID() {
      const canvas=document.getElementById('pid-canvas');
      if(!canvas||this.history.length<2) return;
      const ctx=canvas.getContext('2d');
      ctx.fillStyle='#030508'; ctx.fillRect(0,0,canvas.width,canvas.height);
      // Setpoint
      ctx.strokeStyle='rgba(200,150,42,0.2)'; ctx.lineWidth=1; ctx.setLineDash([3,3]);
      ctx.beginPath(); ctx.moveTo(0,canvas.height/2); ctx.lineTo(canvas.width,canvas.height/2); ctx.stroke(); ctx.setLineDash([]);
      // Signal
      ctx.strokeStyle='rgba(58,154,154,0.8)'; ctx.lineWidth=2;
      ctx.beginPath();
      this.history.forEach((v,i)=>{
        const x=i*(canvas.width/(this.history.length-1));
        const y=canvas.height-(v*canvas.height);
        i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
      });
      ctx.stroke();
    },
    pushYin()  { this.balance=Math.max(0, this.balance-0.1); OraculvmCore.updateWisdom({tao:0.02}); },
    pushYang() { this.balance=Math.min(1, this.balance+0.1); OraculvmCore.updateWisdom({tao:0.02}); },
    destroy()  { cancelAnimationFrame(this.animId); this.animId=null; }
  },

  // ─── XXI: Gato de Schrödinger ───
  quantum: {
    alpha: Math.SQRT1_2, // 1/√2
    beta:  Math.SQRT1_2,
    state: 'superposition', // 'alive' | 'dead' | 'superposition'
    collapseCount: 0,
    animId: null,
    t: 0,
    init() { this.renderWave(); this.loop(); },
    loop() {
      this.t += 0.05;
      this.renderWave();
      this.animId = requestAnimationFrame(()=>this.loop());
    },
    observe() {
      const p = this.alpha*this.alpha;
      const rng = Math.random();
      this.state = rng < p ? 'alive' : 'dead';
      this.collapseCount++;

      const box=document.getElementById('quantum-box');
      const glyph=document.getElementById('quantum-glyph');
      const stateEl=document.getElementById('quantum-state');

      // Visual: glitch on collapse + particle burst
      AtmosphereEngine.triggerGlitch();
      const rect=box?.getBoundingClientRect();
      if(rect) WisdomParticles.burst(rect.left+rect.width/2, rect.top+rect.height/2, this.state==='alive'?'tao':'jabir', 25);

      if(this.state==='alive') {
        if(glyph) glyph.textContent='🐱';
        if(box)   { box.style.borderColor='var(--teal-bright)'; box.style.boxShadow='0 0 30px rgba(58,154,154,0.6)'; }
        if(stateEl) stateEl.textContent='VIVO';
        OraculvmCore.updateWisdom({rasa:0.05,tao:0.03});
      } else {
        if(glyph) glyph.textContent='💀';
        if(box)   { box.style.borderColor='var(--red)'; box.style.boxShadow='0 0 30px rgba(192,57,43,0.6)'; }
        if(stateEl) stateEl.textContent='MUERTO';
        OraculvmCore.updateWisdom({jabir:0.05});
      }

      const hist=document.getElementById('quantum-history');
      if(hist) {
        hist.innerHTML = `<div style="color:${this.state==='alive'?'var(--teal-bright)':'var(--red)'}">
          #${this.collapseCount}: ${this.state.toUpperCase()} (p=${p.toFixed(3)})</div>` + hist.innerHTML;
      }
    },
    superpose() {
      this.state='superposition';
      this.alpha = Math.SQRT1_2 + (Math.random()-0.5)*0.3;
      this.beta  = Math.sqrt(1-this.alpha*this.alpha);
      const glyph=document.getElementById('quantum-glyph');
      const box=document.getElementById('quantum-box');
      const stateEl=document.getElementById('quantum-state');
      if(glyph) glyph.textContent='?';
      if(box)   box.style.borderColor='var(--dim-gold)';
      if(stateEl) stateEl.textContent='SUPERPOSICIÓN';

      const aEl=document.getElementById('q-alpha'), bEl=document.getElementById('q-beta');
      const pUpEl=document.getElementById('q-prob-up'), pDnEl=document.getElementById('q-prob-dn');
      if(aEl) aEl.textContent=this.alpha.toFixed(3);
      if(bEl) bEl.textContent=this.beta.toFixed(3);
      if(pUpEl) pUpEl.textContent=(this.alpha*this.alpha*100).toFixed(1)+'%';
      if(pDnEl) pDnEl.textContent=(this.beta*this.beta*100).toFixed(1)+'%';
    },
    renderWave() {
      const canvas=document.getElementById('wave-canvas');
      if(!canvas) return;
      const ctx=canvas.getContext('2d');
      ctx.fillStyle='#030508'; ctx.fillRect(0,0,canvas.width,canvas.height);

      if(this.state==='superposition') {
        // ψ wavefunction
        ctx.strokeStyle=`rgba(155,89,182,0.8)`; ctx.lineWidth=1.5;
        ctx.beginPath();
        for(let x=0; x<canvas.width; x++) {
          const t=this.t + x*0.05;
          const y = canvas.height/2
            - this.alpha*30*Math.sin(t)
            - this.beta*20*Math.sin(t*1.3+1);
          x===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
        }
        ctx.stroke();
        ctx.strokeStyle=`rgba(58,154,154,0.5)`; ctx.lineWidth=1;
        ctx.beginPath();
        for(let x=0; x<canvas.width; x++) {
          const t=this.t*0.7+x*0.04;
          const y=canvas.height/2-this.beta*25*Math.cos(t);
          x===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
        }
        ctx.stroke();
      } else {
        const color=this.state==='alive'?'rgba(58,154,154,0.6)':'rgba(192,57,43,0.6)';
        ctx.strokeStyle=color; ctx.lineWidth=2;
        ctx.beginPath();
        for(let x=0;x<canvas.width;x++) {
          const y=canvas.height/2+(this.state==='alive'?5:-5)+(Math.random()-0.5)*2;
          x===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
        }
        ctx.stroke();
      }
    },
    destroy() { cancelAnimationFrame(this.animId); this.animId=null; }
  },

  // ─── XX: Ciclo de Stirling ───
  stirling: {
    resources: { heat:100, cold:100, work:0, entropy:0, insight:0, essence:0 },
    phase: 0, // 0-3 ciclo de Stirling
    history: [],
    dpTable: {},
    init() {
      this.buildDP();
      this.renderActions();
      this.drawStirling();
    },
    buildDP() {
      // Programación dinámica: valor óptimo de cada estado de recurso
      const states = [0,25,50,75,100];
      states.forEach(h => states.forEach(c => {
        const key=`${h},${c}`;
        this.dpTable[key] = Math.floor((1-c/T1(h))*100) || 0;
      }));
      function T1(h){ return 300+h*2; }
    },
    renderActions() {
      const el=document.getElementById('stirling-actions');
      if(!el) return;
      const actions = [
        {name:'⊕ Expansión isotérmica', cost:{heat:20}, gain:{work:15,entropy:5}},
        {name:'⬡ Expansión adiabática', cost:{heat:10,work:5}, gain:{work:20,cold:10}},
        {name:'⊗ Compresión isotérmica', cost:{cold:20,work:10}, gain:{insight:10}},
        {name:'◉ Regeneración',          cost:{entropy:10}, gain:{heat:15,cold:5,essence:3}},
        {name:'✶ Insight→Esencia',       cost:{insight:20}, gain:{essence:10}},
      ];
      el.innerHTML = actions.map((a,i)=>`
        <button class="ability-btn" onclick="ModuleLogic.stirling.doAction(${i})">
          ${a.name}
        </button>`).join('');
      this._actions = actions;
    },
    doAction(i) {
      const a=this._actions[i];
      for(const [k,v] of Object.entries(a.cost)) {
        if(this.resources[k]<v) { OraculvmCore.setStatus('Recursos insuficientes'); return; }
      }
      for(const [k,v] of Object.entries(a.cost)) this.resources[k]-=v;
      for(const [k,v] of Object.entries(a.gain)) this.resources[k]=Math.min(999,this.resources[k]+v);
      this.phase=(this.phase+1)%4;
      this.updateUI();
      this.drawStirling();
      OraculvmCore.updateWisdom({tao:0.02});
      if(this.resources.essence>=30) {
        OraculvmCore.completeModule(19);
        showWisdomPopup('Ciclo de Stirling óptimo · Esencia alcanzada');
      }
    },
    updateUI() {
      Object.entries(this.resources).forEach(([k,v])=>{
        const el=document.getElementById(`r-${k}`);
        if(el) el.textContent=Math.floor(v);
      });
      const dp=document.getElementById('dp-table');
      if(dp) {
        const h=Math.floor(this.resources.heat/25)*25;
        const c=Math.floor(this.resources.cold/25)*25;
        const key=`${h},${c}`;
        dp.innerHTML = `Estado: (H=${h}, C=${c})\nV*(s) = ${this.dpTable[key]||0}\n
<span style="color:var(--amber)">η_Carnot = ${(1-200/(300+this.resources.heat*2)).toFixed(3)}</span>`;
      }
    },
    drawStirling() {
      const canvas=document.getElementById('stirling-canvas');
      if(!canvas) return;
      const ctx=canvas.getContext('2d');
      ctx.fillStyle='#030508'; ctx.fillRect(0,0,canvas.width,canvas.height);
      const W=canvas.width, H=canvas.height;
      // PV diagram
      ctx.strokeStyle='rgba(200,150,42,0.2)'; ctx.lineWidth=1;
      ctx.beginPath(); ctx.moveTo(30,H-20); ctx.lineTo(W-10,H-20); ctx.stroke(); // x=V
      ctx.beginPath(); ctx.moveTo(30,10); ctx.lineTo(30,H-20); ctx.stroke(); // y=P
      ctx.fillStyle='rgba(200,150,42,0.3)';
      ctx.font='9px Share Tech Mono'; ctx.fillText('V',W-15,H-10); ctx.fillText('P',15,15);

      // Stirling cycle
      const phases = [
        {V:200,P:120},{V:80,P:120},{V:80,P:60},{V:200,P:60}
      ];
      const colors=['rgba(200,150,42,0.8)','rgba(58,154,154,0.8)','rgba(155,89,182,0.8)','rgba(231,76,60,0.8)'];
      const labels=['1→2 Isotérm.','2→3 Adiab.','3→4 Isotérm.','4→1 Regener.'];

      ctx.lineWidth=2;
      phases.forEach((p,i)=>{
        ctx.strokeStyle=colors[i];
        const nx=phases[(i+1)%4];
        ctx.beginPath();
        ctx.moveTo(p.V/3,H-p.P/1.5);
        // Curved connection
        const mx=(p.V+nx.V)/6, my=H-(p.P+nx.P)/3;
        ctx.quadraticCurveTo(mx,my-15,nx.V/3,H-nx.P/1.5);
        ctx.stroke();
        ctx.fillStyle=colors[i];
        ctx.font='8px Share Tech Mono';
        ctx.fillText(labels[i],35+i*5,H-60+i*12);
      });

      // Current phase indicator
      const ph=phases[this.phase];
      ctx.fillStyle='rgba(240,192,96,0.9)';
      ctx.beginPath(); ctx.arc(ph.V/3,H-ph.P/1.5,5,0,Math.PI*2); ctx.fill();
    }
  },

  // ─── XXXIII: Silencio ───
  silence: {
    running: false, elapsed: 0, animId: null, lastTick:0,
    TARGET: 273000, // 4'33" en ms
    start() {
      if (this.running) return;
      this.running = true;
      this.elapsed = 0;
      this.lastTick = Date.now();
      const startTime = Date.now();
      const status = document.getElementById('silence-status');
      if (status) status.textContent = 'El silencio ha comenzado. No interactúes.';

      const tick = () => {
        // Paper 13: Check microphone noise level — pause timer if too loud
        const now=Date.now();
        const dt=now-this.lastTick;
        this.lastTick=now;
        const noisy=MicrophoneMonitor.isTooLoud();
        if(!noisy) this.elapsed+=dt;
        const rem = Math.max(0, this.TARGET - this.elapsed);
        const mins = Math.floor(rem/60000);
        const secs = Math.floor((rem%60000)/1000);
        const frac = Math.floor((rem%1000)/10);
        const el = document.getElementById('silence-timer');
        const status = document.getElementById('silence-status');
        if(el) {
          el.textContent = `${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}.${String(frac).padStart(2,'0')}`;
          el.classList.add('running');
          const progress=this.elapsed/this.TARGET;
          const r=Math.floor(progress*200), g=Math.floor(90+progress*100), b=Math.floor(42+progress*20);
          el.style.color=`rgb(${r},${g},${b})`;
          el.style.textShadow=`0 0 ${20+progress*60}px rgba(${r},${g},${b},0.4)`;
        }
        if(noisy&&status){
          status.textContent='El silencio no es puro. Vuelve cuando estés solo.';
          status.style.color='var(--red)';
          AtmosphereEngine.triggerGlitch();
        } else if(status&&status.style.color==='var(--red)'){
          status.textContent='El silencio ha comenzado. No interactúes.';
          status.style.color='var(--mist)';
        }

        if(rem <= 0) {
          this.running=false;
          if(el) el.textContent='∅';
          if(el) el.style.color='var(--amber)';
          if(status) status.textContent='El silencio ha terminado. La experiencia fue completa.';
          OraculvmCore.completeModule(32);
          OraculvmCore.updateWisdom({tao:0.1,hermes:0.05});
          showWisdomPopup('4\'33" completado · Sabiduría máxima');
        } else {
          this.animId = requestAnimationFrame(tick);
        }
      };
      this.animId = requestAnimationFrame(tick);
    },
    destroy() { cancelAnimationFrame(this.animId); this.running=false; }
  },

  // ─── Stub genérico ───
  stub: {
    init(mod) {
      const hashEl = document.getElementById(`stub-hash-${mod.id}`);
      if(hashEl) {
        const h = OraculvmCore.djb2(`module-${mod.id}-${Date.now()}`);
        hashEl.textContent = h.toString(16).toUpperCase().padStart(8,'0');
      }

      // Oracle text
      const oracleTexts = [
        "Los patrones del universo se alinean ante tu presencia.",
        "El número 1310 resuena en las estructuras del sistema.",
        "La tradición te observa. El conocimiento espera.",
        "Cada elección aquí afecta la cadena de hash global.",
        "Los algoritmos duermen hasta que los despiertas.",
        "Zehahahaha. Estás en el camino correcto.",
        "El Índice de Sabiduría crece con cada módulo explorado.",
      ];
      const oracleEl = document.getElementById('stub-oracle-text');
      if(oracleEl) {
        const t = oracleTexts[mod.id % oracleTexts.length];
        typeText(oracleEl, t);
      }

      // Choices
      const choicesEl = document.getElementById('stub-choices');
      if(choicesEl) {
        const wDelta = {[mod.tradition]: 0.05};
        choicesEl.innerHTML = `
          <button class="choice-btn" onclick="ModuleLogic.stub.explore(${mod.id},'${mod.tradition}')">
            <span class="choice-num">1</span> Explorar el módulo [+${mod.tradition} +0.05]
          </button>
          <button class="choice-btn" onclick="ModuleLogic.stub.meditate(${mod.id},'${mod.tradition}')">
            <span class="choice-num">2</span> Meditar aquí [+todas las tradiciones +0.01]
          </button>
          <button class="choice-btn" onclick="Game.navigate(${(mod.id+1)%33})">
            <span class="choice-num">3</span> Continuar al siguiente módulo →
          </button>`;
      }
    },
    explore(id, tradition) {
      OraculvmCore.updateWisdom({[tradition]:0.05});
      OraculvmCore.completeModule(id);
      showWisdomPopup(`Módulo ${id+1} explorado · +${tradition}`);
      Game.navigate((id+1)%33);
    },
    meditate(id, tradition) {
      OraculvmCore.updateWisdom({hermes:0.01,rasa:0.01,tao:0.01,jabir:0.01,catedral:0.01});
      showWisdomPopup(`Meditación · +todas las tradiciones`);
    }
  }
};

// ═══════════════════════════════════════════════════════════════
// GAME ENGINE — Orquestador principal
// ═══════════════════════════════════════════════════════════════
const Game = {
  currentScene: 'title',
  currentModule: -1,
  currentLogic: null,

  startNewGame() {
    OraculvmCore.setStatus('INICIANDO CRÓNICA · Compilando módulos...');
    setTimeout(()=>{
      this.navigate(0);
      this.initHUD();
    }, 300);
  },

  loadGame() {
    try {
      const saved = localStorage.getItem('oraculvm_save');
      if (!saved) { OraculvmCore.setStatus('No hay partida guardada'); return; }
      const data = JSON.parse(saved);
      Object.assign(OraculvmCore.W, data.wisdom);
      OraculvmCore.player.health = data.health||100;
      OraculvmCore.player.truth_temperature = data.temp||0;
      data.moduleStates.forEach((s,i)=>OraculvmCore.moduleStates[i]=s);
      this.navigate(data.lastModule||0);
      this.initHUD();
      showWisdomPopup('Partida cargada');
    } catch(e) {
      this.startNewGame();
    }
  },

  saveGame() {
    try {
      const save = {
        wisdom: {...OraculvmCore.W},
        moduleStates: [...OraculvmCore.moduleStates],
        lastModule: this.currentModule,
        health: OraculvmCore.player.health,
        temp: OraculvmCore.player.truth_temperature,
        timestamp: Date.now()
      };
      localStorage.setItem('oraculvm_save', JSON.stringify(save));
      OraculvmCore.setStatus('Partida guardada · ' + new Date().toLocaleTimeString());
    } catch(e) {}
  },

  navigate(moduleId) {
    // Destroy old logic
    if(this.currentLogic && this.currentLogic.destroy) {
      this.currentLogic.destroy();
    }
    this.currentLogic = null;

    const mod = MODULES[moduleId];
    if (!mod) return;

    // Check zarandaja
    if (OraculvmCore.SAB_U32[OraculvmCore.ADDR.COMPILATION_LOCK/4] === 1) {
      this.showZarandaja();
      OraculvmCore.SAB_U32[OraculvmCore.ADDR.COMPILATION_LOCK/4] = 0;
      return;
    }

    this.currentModule = moduleId;
    document.getElementById('module-indicator').textContent = `MOD-${mod.num}`;

    // Render scene
    const main = document.getElementById('main');
    const renderer = ModuleRenderers[moduleId] || ModuleRenderers._stub;
    const html = typeof renderer === 'function'
      ? (renderer === ModuleRenderers._stub ? ModuleRenderers._stub(mod) : renderer())
      : renderer;

    main.innerHTML = `<canvas id="godrays-canvas"></canvas><div class="scene active fade-in" id="scene-module">${html}</div>`;

    // Visual: Set atmosphere per tradition
    AtmosphereEngine.set(mod.tradition || null);
    AtmosphereEngine.setQuantum(moduleId === 20);

    // God rays for tree and key modules
    const grCanvas = document.getElementById('godrays-canvas');
    if(grCanvas) {
      grCanvas.width = main.offsetWidth||800;
      grCanvas.height = main.offsetHeight||600;
      GodRaysRenderer.init(grCanvas);
      if(moduleId===3) { // Tree module
        GodRaysRenderer.setSources([
          {x:grCanvas.width*0.5,y:grCanvas.height*0.15,radius:30,color:'rgb(200,150,42)',baseIntensity:0.5,pulseSpeed:0.8},
          {x:grCanvas.width*0.2,y:grCanvas.height*0.3,radius:15,color:'rgb(155,89,182)',baseIntensity:0.3,pulseSpeed:1.2},
          {x:grCanvas.width*0.8,y:grCanvas.height*0.3,radius:15,color:'rgb(41,128,185)',baseIntensity:0.3,pulseSpeed:0.9},
        ]);
      } else if(moduleId===19||moduleId===16) { // Stirling / Horno
        GodRaysRenderer.setSources([
          {x:grCanvas.width*0.5,y:grCanvas.height*0.6,radius:40,color:'rgb(231,76,60)',baseIntensity:0.4,pulseSpeed:1.5},
        ]);
      } else if(moduleId===8) { // Fluid
        GodRaysRenderer.setSources([
          {x:grCanvas.width*0.3,y:grCanvas.height*0.4,radius:20,color:'rgb(42,107,107)',baseIntensity:0.25,pulseSpeed:0.7},
        ]);
      } else {
        GodRaysRenderer.clear();
      }
    }

    // Spring animation on module content
    setTimeout(()=>SpringSystem.applyToScene(document.getElementById('scene-module')), 50);

    // Init logic
    OraculvmCore.setStatus(`MÓDULO ${mod.num} · ${mod.name.toUpperCase()} · ${mod.tag}`);

    switch(moduleId) {
      case 0:  this.currentLogic=ModuleLogic.vestibulo; ModuleLogic.vestibulo.init(); break;
      case 1:  ModuleLogic.custodios.init(); break;
      case 3:  ModuleLogic.tree.init(); break;
      case 4:  ModuleLogic.tarot.init(); break;
      case 8:  this.currentLogic=ModuleLogic.fluid; ModuleLogic.fluid.init(); break;
      case 12: this.currentLogic=ModuleLogic.tao; ModuleLogic.tao.init(); break;
      case 19: ModuleLogic.stirling.init(); break;
      case 20: this.currentLogic=ModuleLogic.quantum; ModuleLogic.quantum.init(); break;
      case 32: break; // silence: no auto-init
      default: ModuleLogic.stub.init(mod); break;
    }

    // Special case for module II, III, IV etc that don't need complex init
    if(moduleId===2) this.initGarden();

    this.updateNav();
    this.updateSidebar();
    this.saveGame();
  },

  initGarden() {
    // Render first dilemma
    const dilemmas = [
      {
        text:"Un viajero hambriento te pide tu último trozo de pan. Si se lo das, morirás de hambre antes de llegar al siguiente módulo. Si no lo haces, él muere.",
        choices:[
          {text:"Dar el pan", wisdom:{rasa:0.06,tao:0.02}, reward:8, label:"Altruismo"},
          {text:"Negarte",    wisdom:{jabir:0.04,catedral:0.02}, reward:3, label:"Supervivencia"},
          {text:"Partir el pan a la mitad", wisdom:{tao:0.07,rasa:0.03}, reward:6, label:"Equilibrio"}
        ]
      },
      {
        text:"Descubres que el Custodio del módulo siguiente ha estado mintiendo a todos los viajeros para proteger un secreto del Oraculvm. ¿Lo denuncias?",
        choices:[
          {text:"Sí, la verdad ante todo", wisdom:{hermes:0.05,catedral:0.03}, reward:7, label:"Verdad"},
          {text:"No, preservo el sistema", wisdom:{catedral:0.05,jabir:0.02}, reward:5, label:"Sistema"},
          {text:"Negocio con él", wisdom:{jabir:0.06,hermes:0.02}, reward:6, label:"Pragmatismo"}
        ]
      }
    ];
    const d = dilemmas[Math.floor(Math.random()*dilemmas.length)];
    const el = document.getElementById('dilemma-container');
    if(!el) return;
    const rc = document.getElementById('reward-canvas');
    let rewards = [];

    el.innerHTML = `
      <div class="dialogue-box">
        <div class="dialogue-speaker">DILEMA ÉTICO</div>
        <div class="dialogue-text">${d.text}</div>
      </div>
      <div class="dialogue-choices">
        ${d.choices.map((c,i)=>`
          <button class="choice-btn" onclick="Game.gardenChoose(${i})">
            <span class="choice-num">[${c.label}]</span> ${c.text}
          </button>`).join('')}
      </div>`;
    this._gardenDilemma = d;
    this._gardenRewards = [];

    if(rc) {
      const ctx=rc.getContext('2d');
      ctx.fillStyle='#030508'; ctx.fillRect(0,0,rc.width,rc.height);
      ctx.fillStyle='rgba(200,150,42,0.3)'; ctx.font='10px Share Tech Mono';
      ctx.fillText('Historial de recompensas',10,20);
    }
  },

  gardenChoose(i) {
    const c = this._gardenDilemma.choices[i];
    OraculvmCore.updateWisdom(c.wisdom);
    showWisdomPopup(`${c.label} · +${Object.entries(c.wisdom).map(([k,v])=>`${k.substring(0,3)}: +${v.toFixed(2)}`).join(' ')}`);
    this._gardenRewards.push(c.reward);

    // Draw reward
    const rc = document.getElementById('reward-canvas');
    if(rc) {
      const ctx=rc.getContext('2d'), W=rc.width, H=rc.height;
      ctx.fillStyle='#030508'; ctx.fillRect(0,0,W,H);
      ctx.strokeStyle='rgba(58,154,154,0.8)'; ctx.lineWidth=2;
      ctx.beginPath();
      this._gardenRewards.forEach((r,j)=>{
        const x=20+j*(W-40)/(Math.max(5,this._gardenRewards.length)-1);
        const y=H-10-r*(H-20)/10;
        j===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
        ctx.fillStyle='var(--amber)'; ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();
      });
      ctx.stroke();
    }

    OraculvmCore.completeModule(2);
    this.initGarden(); // next dilemma
  },

  showZarandaja() {
    const overlay = document.createElement('div');
    overlay.className = 'zarandaja-overlay';
    overlay.innerHTML = `
      <div class="zarandaja-title">⚠ GUARDIÁN DE LA ZARANDAJA</div>
      <div style="font-family:var(--font-body);font-size:16px;color:var(--pale);text-align:center;max-width:400px;margin-bottom:24px">
        Has invocado palabras prohibidas. El Guardián despierta.<br>
        Sus estadísticas son el doble de las tuyas.
      </div>
      <div style="font-family:var(--font-mono);font-size:12px;color:var(--red);margin-bottom:24px">
        PENALIZACIÓN: -13.10% del progreso en módulo actual
      </div>
      <button class="btn btn-danger" onclick="this.parentElement.remove()">ACEPTAR PENALIZACIÓN</button>`;
    document.body.appendChild(overlay);
    OraculvmCore.player.health = Math.max(1, OraculvmCore.player.health * 0.869);
    this.updateSidebar();
  },

  initHUD() {
    this.buildNav();
    this.buildProgressGrid();
    this.updateSidebar();
    // FPS counter
    let lastTime=performance.now(), frames=0;
    const fpsTick = () => {
      frames++;
      const now=performance.now();
      if(now-lastTime>=1000) {
        document.getElementById('fps-counter').textContent=`${frames} fps`;
        document.getElementById('frame-counter').textContent=`F:${String(frames*33).padStart(4,'0')}`;
        frames=0; lastTime=now;
      }
      requestAnimationFrame(fpsTick);
    };
    requestAnimationFrame(fpsTick);
    // Autosave
    setInterval(()=>this.saveGame(), 300000); // 5 min
  },

  buildNav() {
    const nav = document.getElementById('nav');
    nav.innerHTML = '<div class="nav-section">▸ MÓDULOS</div>';
    MODULES.forEach(mod => {
      const state = OraculvmCore.moduleStates[mod.id];
      const div = document.createElement('div');
      div.className = `nav-item ${state===0?'locked':''} ${state===2?'completed':''} ${mod.id===this.currentModule?'active':''}`;
      div.id = `nav-${mod.id}`;
      div.innerHTML = `
        <span class="nav-num">${mod.num}</span>
        <span class="nav-glyph">${mod.glyph}</span>
        <span class="nav-name">${mod.name}</span>`;
      if(state!==0) div.onclick = ()=>this.navigate(mod.id);
      nav.appendChild(div);
    });
  },

  updateNav() {
    MODULES.forEach(mod => {
      const el = document.getElementById(`nav-${mod.id}`);
      if(!el) return;
      const state = OraculvmCore.moduleStates[mod.id];
      el.className = `nav-item ${state===0?'locked':''} ${state===2?'completed':''} ${mod.id===this.currentModule?'active':''}`;
      if(state!==0) el.onclick = ()=>this.navigate(mod.id);
      else el.onclick = null;
    });
  },

  buildProgressGrid() {
    const grid = document.getElementById('progress-grid');
    if(!grid) return;
    grid.innerHTML = MODULES.map(mod => {
      const state = OraculvmCore.moduleStates[mod.id];
      return `<div class="prog-cell ${state===2?'done':''} ${state===1&&mod.id===this.currentModule?'active':''}"
        title="${mod.name}" id="prog-${mod.id}">${mod.num}</div>`;
    }).join('');
  },

  updateSidebar() {
    const W = OraculvmCore.W;
    ['hermes','rasa','tao','jabir','catedral'].forEach(k=>{
      const fill=document.getElementById(`w-${k}`);
      const val =document.getElementById(`w-${k}-val`);
      if(fill) fill.style.width=(W[k]*100)+'%';
      if(val)  val.textContent=(W[k]*100).toFixed(0)+'%';
    });
    const p=OraculvmCore.player;
    document.getElementById('char-hp').textContent=`${Math.floor(p.health)}/${p.maxHealth}`;
    document.getElementById('hp-fill').style.width=(p.health/p.maxHealth*100)+'%';
    document.getElementById('s-str').textContent=p.strength;
    document.getElementById('s-int').textContent=p.intelligence;
    document.getElementById('s-arc').textContent=p.arcane;
    document.getElementById('s-agi').textContent=p.agility;
    document.getElementById('s-temp').textContent=p.truth_temperature.toFixed(2);
    document.getElementById('temp-fill').style.width=(p.truth_temperature*100)+'%';

    // Progress grid update
    MODULES.forEach(mod=>{
      const el=document.getElementById(`prog-${mod.id}`);
      const state=OraculvmCore.moduleStates[mod.id];
      if(el) el.className=`prog-cell ${state===2?'done':''} ${state===1&&mod.id===this.currentModule?'active':''}`;
    });
  }
};

// ═══════════════════════════════════════════════════════════════
// UTILITIES
// ═══════════════════════════════════════════════════════════════

function showWisdomPopup(text, tradition) {
  const old = document.querySelector('.wisdom-popup');
  if(old) old.remove();
  const el = document.createElement('div');
  el.className='wisdom-popup';
  el.textContent=text;
  // Color by tradition
  const tradColors={hermes:'#9b59b6',rasa:'#e74c3c',tao:'#27ae60',jabir:'#e67e22',catedral:'#2980b9'};
  if(tradition&&tradColors[tradition]) {
    el.style.borderColor=tradColors[tradition];
    el.style.color=tradColors[tradition];
    el.style.boxShadow=`0 0 20px ${tradColors[tradition]}44`;
  }
  document.body.appendChild(el);
  setTimeout(()=>{ if(el.parentNode) el.remove(); }, 3100);
  Game.updateSidebar();
  Game.updateNav();
  Game.buildProgressGrid();
}

function typeText(el, text, speed=30) {
  let i=0; el.textContent='';
  const timer=setInterval(()=>{
    el.textContent+=text[i++];
    if(i>=text.length) clearInterval(timer);
  }, speed);
}

// ═══════════════════════════════════════════════════════════════
// MEJORA 2: GRANULAR AUDIO ENGINE
// Di Scipio 2003 · "Real-Time Granular Synthesis for Interactive Soundscapes"
// ═══════════════════════════════════════════════════════════════
const GranularEngine = (() => {
  let ctx = null, masterGain = null, running = false;
  let density = 8, volume = 0.6;
  let grainInterval = null;
  let currentMode = 'SILENCIO';
  let fluidDensity = 0, fluidVel = 0;

  const PRESETS = [
    { name:'HERMES·GEOMETRÍA',  baseFreq:220, spread:0.3,  grainDur:0.08, color:'#9b59b6' },
    { name:'RASA·VIDA',         baseFreq:174, spread:0.6,  grainDur:0.12, color:'#e74c3c' },
    { name:'TAO·EQUILIBRIO',    baseFreq:136, spread:0.1,  grainDur:0.15, color:'#27ae60' },
    { name:'JABIR·ALQUIMIA',    baseFreq:256, spread:0.8,  grainDur:0.06, color:'#e67e22' },
    { name:'CATEDRAL·ARCO',     baseFreq:110, spread:0.2,  grainDur:0.2,  color:'#2980b9' },
    { name:'XENON·FLUIDOS',     baseFreq:180, spread:0.5,  grainDur:0.04, color:'#3a9a9a' },
  ];
  let presetIdx = 0;

  function initCtx() {
    if(ctx) return;
    ctx = new (window.AudioContext || window.webkitAudioContext)();
    masterGain = ctx.createGain();
    masterGain.gain.value = volume;
    masterGain.connect(ctx.destination);
    // Audio viz init
    buildViz();
  }

  function buildViz() {
    const viz = document.getElementById('audio-viz');
    if(!viz) return;
    viz.innerHTML = Array(8).fill(0).map((_,i)=>`<div class="audio-bar" id="avbar-${i}" style="height:4px"></div>`).join('');
  }

  function fireGrain() {
    if(!ctx || !running) return;
    const p = PRESETS[presetIdx];
    const osc = ctx.createOscillator();
    const env = ctx.createGain();
    const filter = ctx.createBiquadFilter();

    // Fluid coupling
    const freqMod = 1 + fluidVel * 2;
    const baseF = p.baseFreq * freqMod;

    osc.type = presetIdx % 2 === 0 ? 'sine' : 'triangle';
    osc.frequency.value = baseF * (1 + (Math.random()-0.5)*p.spread);
    filter.type = 'bandpass';
    filter.frequency.value = baseF * 2;
    filter.Q.value = 8;

    const dur = p.grainDur * (0.7 + Math.random()*0.6);
    const now = ctx.currentTime;
    env.gain.setValueAtTime(0, now);
    env.gain.linearRampToValueAtTime(0.12 * (0.5 + fluidDensity*0.5), now + dur*0.1);
    env.gain.exponentialRampToValueAtTime(0.001, now + dur);

    osc.connect(filter).connect(env).connect(masterGain);
    osc.start(now);
    osc.stop(now + dur);

    // Update viz
    const barIdx = Math.floor(Math.random()*8);
    const bar = document.getElementById(`avbar-${barIdx}`);
    if(bar) {
      const h = 4 + Math.random()*16;
      bar.style.height = h + 'px';
      bar.style.background = p.color;
      setTimeout(()=>{ if(bar) bar.style.height='4px'; }, 150);
    }
  }

  function startGrains() {
    if(grainInterval) clearInterval(grainInterval);
    const interval = Math.max(50, 1000/density);
    grainInterval = setInterval(fireGrain, interval);
  }

  return {
    toggle() {
      initCtx();
      if(ctx.state === 'suspended') ctx.resume();
      running = !running;
      if(running) {
        startGrains();
        const p = PRESETS[presetIdx];
        currentMode = p.name;
        OraculvmCore.setStatus(`♪ AUDIO GRANULAR · ${p.name}`);
      } else {
        clearInterval(grainInterval);
        currentMode = 'SILENCIO';
      }
      const modeEl = document.getElementById('audio-mode-label');
      if(modeEl) modeEl.textContent = `MODO: ${currentMode}`;
    },

    nextPreset() {
      presetIdx = (presetIdx+1) % PRESETS.length;
      const p = PRESETS[presetIdx];
      currentMode = p.name;
      const modeEl = document.getElementById('audio-mode-label');
      if(modeEl) modeEl.textContent = `MODO: ${currentMode}`;
      if(running) { clearInterval(grainInterval); startGrains(); }
    },

    setVolume(v) {
      volume = v;
      if(masterGain) masterGain.gain.value = v;
    },

    setDensity(d) {
      density = d;
      if(running) { clearInterval(grainInterval); startGrains(); }
    },

    setMode(modeKey) {
      const idx = PRESETS.findIndex(p=>p.name.includes(modeKey.toUpperCase()));
      if(idx>=0) { presetIdx=idx; if(running){ clearInterval(grainInterval); startGrains(); } }
    },

    setFluidParams(d, v) {
      fluidDensity = d; fluidVel = v;
    }
  };
})();

// ═══════════════════════════════════════════════════════════════
// MEJORA 5: MOUSE EMOTION DETECTOR (Affective Computing)
// Picard 1997 · Zimmermann et al. 2006
// ═══════════════════════════════════════════════════════════════
const MouseEmotionDetector = (() => {
  const BUFFER_SIZE = 80;
  const buffer = [];
  let lastPos = null, lastTime = 0;
  let visible = false;

  const STATES = {
    FRUSTRADO: { color:'#c0392b', threshold: { accel:8, clicks:3 } },
    CURIOSO:   { color:'#e8a830', threshold: { vel:5, pauses:0 } },
    ABURRIDO:  { color:'#2a3f5c', threshold: { vel:0.5 } },
    NEUTRO:    { color:'#3a9a9a', threshold: {} }
  };

  let clickHistory = [];
  let currentState = 'NEUTRO';

  function analyze() {
    if(buffer.length < 10) return 'NEUTRO';
    const velocities = buffer.map(b=>b.v);
    const avgVel = velocities.reduce((a,b)=>a+b,0)/velocities.length;
    const maxAccel = Math.max(...buffer.map(b=>b.a));

    const recentClicks = clickHistory.filter(t=>Date.now()-t<5000).length;

    if(recentClicks>=3 || maxAccel>15) return 'FRUSTRADO';
    if(avgVel<0.4) return 'ABURRIDO';
    if(avgVel>3 && maxAccel<8) return 'CURIOSO';
    return 'NEUTRO';
  }

  document.addEventListener('mousemove', (e)=>{
    const now = Date.now();
    if(lastPos) {
      const dt = Math.max(1, now-lastTime)/1000;
      const dx = e.clientX-lastPos.x, dy = e.clientY-lastPos.y;
      const v = Math.sqrt(dx*dx+dy*dy)/dt;
      const prevV = buffer.length>0 ? buffer[buffer.length-1].v : v;
      const a = Math.abs(v-prevV)/dt;
      buffer.push({x:e.clientX,y:e.clientY,v,a,t:now});
      if(buffer.length>BUFFER_SIZE) buffer.shift();
    }
    lastPos={x:e.clientX,y:e.clientY};
    lastTime=now;
  });

  document.addEventListener('click', ()=>{
    clickHistory.push(Date.now());
    if(clickHistory.length>10) clickHistory.shift();
  });

  // Update every 2 seconds
  setInterval(()=>{
    const newState = analyze();
    if(newState !== currentState) {
      currentState = newState;
      const dot = document.getElementById('emotion-dot');
      const label = document.getElementById('emotion-state');
      const indicator = document.getElementById('emotion-indicator');
      const stateConf = STATES[newState];
      if(dot) dot.style.background = stateConf.color;
      if(label) label.textContent = newState;
      if(indicator) indicator.style.borderColor = stateConf.color;

      // Reactive narrative
      if(newState==='FRUSTRADO') {
        OraculvmCore.setStatus('⚠ El Oráculo percibe tu inquietud, caminante...');
        showWisdomPopup('Emoción detectada: FRUSTRACIÓN · El Oráculo observa');
      } else if(newState==='ABURRIDO' && Math.random()>0.7) {
        OraculvmCore.setStatus('⊙ El tiempo fluye distinto dentro del Oraculvm...');
      }
    }
  }, 2000);

  return {
    init() {
      const el = document.getElementById('emotion-indicator');
      if(el) el.style.display = 'flex';
      visible = true;
    },
    getState() { return currentState; }
  };
})();

// ═══════════════════════════════════════════════════════════════
// MEJORA 6: PROOF OF WISDOM (Blockchain-inspired Achievement System)
// McConaghy et al. 2017 · IEEE CIG
// ═══════════════════════════════════════════════════════════════
const ProofOfWisdom = (() => {
  const proofs = [];

  function generateProof(moduleId, wisdom) {
    const mod = MODULES[moduleId];
    if(!mod) return null;
    const wisdomSnapshot = JSON.stringify(wisdom);
    const baseData = `${moduleId}:${mod.name}:${wisdomSnapshot}:${Date.now()}`;
    const hash = OraculvmCore.djb2(baseData);
    const hashHex = hash.toString(16).toUpperCase().padStart(8,'0');
    // Chain with previous
    const prevHash = proofs.length>0 ? proofs[proofs.length-1].hash : '00000000';
    const chainHash = OraculvmCore.djb2(prevHash+hashHex);
    const chainHex = chainHash.toString(16).toUpperCase().padStart(8,'0');

    return {
      moduleId, name:mod.name, glyph:mod.glyph,
      hash:hashHex, chainHash:chainHex,
      timestamp: new Date().toLocaleTimeString(),
      tradition: mod.tradition
    };
  }

  function render() {
    const panel = document.getElementById('proofs-panel');
    if(!panel) return;
    if(proofs.length===0) {
      panel.innerHTML = '<div style="font-family:var(--font-mono);font-size:10px;color:var(--mist)">Ningún módulo completado aún...</div>';
      return;
    }
    panel.innerHTML = proofs.slice(-6).reverse().map(p=>`
      <div class="proof-entry">
        <div class="proof-glyph">${p.glyph}</div>
        <div>
          <div class="proof-name">${p.name}</div>
          <div class="proof-hash">${p.hash}↔${p.chainHash}</div>
          <div class="proof-time">${p.timestamp}</div>
        </div>
      </div>`).join('');
  }

  return {
    record(moduleId) {
      const proof = generateProof(moduleId, OraculvmCore.getWisdom());
      if(!proof) return;
      proofs.push(proof);
      render();
      // Update footer hash
      document.getElementById('hash-display').textContent = `CHAIN: ${proof.chainHash}`;
    },
    getProofs() { return [...proofs]; }
  };
})();

// ═══════════════════════════════════════════════════════════════
// MEJORA 7: WEBXR MODE (Azuma 1997)
// ═══════════════════════════════════════════════════════════════
const XRMode = (() => {
  let overlay = null, animId = null;
  let cameraAngle = 0, cameraY = 0;

  return {
    enter() {
      // Check WebXR support
      if(navigator.xr) {
        navigator.xr.isSessionSupported('immersive-ar').then(supported=>{
          if(supported) {
            OraculvmCore.setStatus('WebXR AR iniciando...');
            navigator.xr.requestSession('immersive-ar').then(session=>{
              OraculvmCore.setStatus('Sesión AR activa. Busca una superficie plana.');
            }).catch(()=>this.showSimulatedAR());
          } else { this.showSimulatedAR(); }
        }).catch(()=>this.showSimulatedAR());
      } else { this.showSimulatedAR(); }
    },

    showSimulatedAR() {
      // Simulated AR overlay
      overlay = document.createElement('div');
      overlay.id = 'xr-overlay';
      overlay.innerHTML = `
        <div style="text-align:center;margin-bottom:16px">
          <div style="font-family:var(--font-display);font-size:16px;letter-spacing:4px;color:#5dade2">MODO AR · ÁRBOL SEFIRÓTICO</div>
          <div style="font-family:var(--font-mono);font-size:10px;color:var(--mist);margin-top:4px">WebXR · Simulación de Entorno · Azuma 1997</div>
        </div>
        <div class="xr-canvas-wrap">
          <canvas id="xr-canvas" width="600" height="400"></canvas>
          <div class="xr-hud">
            <div>⊕ TRACKING: ACTIVO</div>
            <div>ANCHOR: SUELO DETECTADO</div>
            <div id="xr-rot">ROT: 0°</div>
          </div>
        </div>
        <div style="margin-top:16px;display:flex;gap:12px;justify-content:center">
          <button class="xr-btn" onclick="XRMode.rotate(-15)">◀ ROTAR</button>
          <button class="xr-btn" onclick="XRMode.rotate(15)">ROTAR ▶</button>
          <button class="btn btn-sm btn-danger" onclick="XRMode.exit()">✕ SALIR AR</button>
        </div>
        <div style="margin-top:10px;font-family:var(--font-mono);font-size:10px;color:var(--mist)">
          WebXR no disponible en este navegador. Mostrando simulación 3D.
        </div>`;
      document.body.appendChild(overlay);
      this.renderAR();
      OraculvmCore.updateWisdom({catedral:0.02,hermes:0.01});
    },

    rotate(delta) { cameraAngle+=delta; this.renderAR(); const el=document.getElementById('xr-rot'); if(el)el.textContent=`ROT: ${cameraAngle}°`; },

    renderAR() {
      const canvas=document.getElementById('xr-canvas');
      if(!canvas)return;
      const W=canvas.width,H=canvas.height;
      const ctx=canvas.getContext('2d');

      // Background - simulated camera feed
      ctx.fillStyle='#0a1520';
      ctx.fillRect(0,0,W,H);
      // Grid floor
      ctx.strokeStyle='rgba(41,128,185,0.2)';ctx.lineWidth=1;
      for(let i=0;i<10;i++){
        const y=H*0.5+i*20;
        ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();
        const xOff=i*30;
        ctx.beginPath();ctx.moveTo(W/2-xOff,H*0.5);ctx.lineTo(W/2-xOff*2,H);ctx.stroke();
        ctx.beginPath();ctx.moveTo(W/2+xOff,H*0.5);ctx.lineTo(W/2+xOff*2,H);ctx.stroke();
      }

      // 3D tree projection (isometric approximation)
      const rad=cameraAngle*Math.PI/180;
      const sephiroth=[
        {x:0,y:2,z:0,label:'Kether',color:'#f0c060'},{x:1.5,y:1.5,z:0,label:'Chokmah',color:'#9b59b6'},
        {x:-1.5,y:1.5,z:0,label:'Binah',color:'#e74c3c'},{x:1.5,y:0.5,z:0,label:'Chesed',color:'#2980b9'},
        {x:-1.5,y:0.5,z:0,label:'Geburah',color:'#c0392b'},{x:0,y:0,z:0,label:'Tiferet',color:'#e8a830'},
        {x:1.5,y:-0.8,z:0,label:'Netzach',color:'#27ae60'},{x:-1.5,y:-0.8,z:0,label:'Hod',color:'#e67e22'},
        {x:0,y:-1.3,z:0,label:'Yesod',color:'#3a9a9a'},{x:0,y:-2,z:0,label:'Malkuth',color:'#8a9ab5'}
      ];

      const project=(x,y,z)=>{
        const rx=x*Math.cos(rad)-z*Math.sin(rad);
        const rz=x*Math.sin(rad)+z*Math.cos(rad);
        const scale=60/(rz+5);
        return {sx:W/2+rx*scale*40, sy:H*0.45-y*scale*35, scale};
      };

      // Draw connections
      const conns=[[0,1],[0,2],[1,3],[2,4],[0,5],[3,5],[4,5],[3,6],[4,7],[5,6],[5,7],[5,8],[6,9],[7,9],[8,9]];
      ctx.strokeStyle='rgba(200,150,42,0.4)';ctx.lineWidth=1;
      conns.forEach(([a,b])=>{
        const pa=project(sephiroth[a].x,sephiroth[a].y,sephiroth[a].z);
        const pb=project(sephiroth[b].x,sephiroth[b].y,sephiroth[b].z);
        ctx.beginPath();ctx.moveTo(pa.sx,pa.sy);ctx.lineTo(pb.sx,pb.sy);ctx.stroke();
      });

      // Draw nodes
      sephiroth.forEach(s=>{
        const {sx,sy,scale}=project(s.x,s.y,s.z);
        const r=Math.max(4,8*scale);
        ctx.beginPath();ctx.arc(sx,sy,r,0,Math.PI*2);
        ctx.fillStyle=s.color+'44';ctx.fill();
        ctx.strokeStyle=s.color;ctx.lineWidth=1.5;ctx.stroke();
        ctx.fillStyle=s.color;ctx.font=`${Math.max(7,9*scale)}px Share Tech Mono`;
        ctx.textAlign='center';ctx.fillText(s.label,sx,sy-r-3);
      });

      // AR scan lines
      ctx.strokeStyle='rgba(41,128,185,0.08)';ctx.lineWidth=1;
      for(let y=0;y<H;y+=4){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}
    },

    exit() {
      cancelAnimationFrame(animId);
      if(overlay){overlay.remove();overlay=null;}
    }
  };
})();

// ═══════════════════════════════════════════════════════════════
// FRENTE 5: SISTEMA DE PARTÍCULAS DE SABIDURÍA
// Reeves 1983 · "Particle Systems: A Technique for Modeling Fuzzy Objects"
// ═══════════════════════════════════════════════════════════════
const WisdomParticles = (() => {
  let canvas, ctx;
  const particles = [];
  let animId = null;

  const TRAD_COLORS = {
    hermes:'#9b59b6', rasa:'#e74c3c', tao:'#27ae60',
    jabir:'#e67e22', catedral:'#2980b9', default:'#e8a830'
  };

  class Particle {
    constructor(x, y, tradition) {
      this.x = x; this.y = y;
      this.vx = (Math.random()-0.5)*5;
      this.vy = -(Math.random()*4+1);
      this.alpha = 1;
      this.size = Math.random()*5+2;
      this.color = TRAD_COLORS[tradition] || TRAD_COLORS.default;
      this.life = 1;
      this.decay = 0.015 + Math.random()*0.01;
      // Target: wisdom bar position (right side)
      this.tx = window.innerWidth - 120 + Math.random()*40;
      this.ty = 80 + Math.random()*100;
      this.attracted = false;
      this.delay = Math.random()*20;
    }
    update() {
      if(this.delay>0){this.delay--;return;}
      if(this.life>0.4) {
        this.x+=this.vx; this.y+=this.vy;
        this.vy+=0.1; // gravity
        this.life-=this.decay;
      } else {
        // Attract to wisdom bar
        this.attracted=true;
        const dx=this.tx-this.x, dy=this.ty-this.y;
        const dist=Math.sqrt(dx*dx+dy*dy);
        if(dist<5){this.life=0;return;}
        this.x+=dx*0.08; this.y+=dy*0.08;
        this.life-=this.decay*2;
      }
      this.alpha=Math.max(0,this.life);
      this.size*=0.98;
    }
    draw(ctx) {
      if(this.alpha<=0||this.delay>0)return;
      ctx.save();
      ctx.globalAlpha=this.alpha;
      ctx.fillStyle=this.color;
      ctx.shadowBlur=8; ctx.shadowColor=this.color;
      ctx.beginPath();
      ctx.arc(this.x,this.y,this.size,0,Math.PI*2);
      ctx.fill();
      ctx.restore();
    }
  }

  function loop() {
    if(!canvas||!ctx)return;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    for(let i=particles.length-1;i>=0;i--){
      particles[i].update();
      particles[i].draw(ctx);
      if(particles[i].life<=0||particles[i].size<0.5) particles.splice(i,1);
    }
    if(particles.length>0) animId=requestAnimationFrame(loop);
    else animId=null;
  }

  return {
    init() {
      canvas=document.getElementById('particle-canvas');
      if(!canvas)return;
      canvas.width=window.innerWidth; canvas.height=window.innerHeight;
      ctx=canvas.getContext('2d');
      window.addEventListener('resize',()=>{
        canvas.width=window.innerWidth; canvas.height=window.innerHeight;
      });
    },
    burst(x, y, tradition, count=18) {
      if(!canvas)this.init();
      const rect=document.getElementById('particle-canvas');
      for(let i=0;i<count;i++) particles.push(new Particle(x,y,tradition));
      if(!animId) animId=requestAnimationFrame(loop);
    },
    burstFromEvent(e, tradition) {
      if(e && e.clientX) this.burst(e.clientX, e.clientY, tradition);
      else this.burst(window.innerWidth/2, window.innerHeight/2, tradition);
    }
  };
})();

// ═══════════════════════════════════════════════════════════════
// FRENTE 3: POST-PROCESSING ATMOSPHERE ENGINE
// Akenine-Möller et al. 2018 · "Real-Time Rendering"
// ═══════════════════════════════════════════════════════════════
const AtmosphereEngine = (() => {
  let currentTradition = null;
  const BG_PARTICLES = [];
  let bgAnimId = null;
  let canvas, ctx;

  const ATMO_CONFIGS = {
    hermes:  { class:'atmo-hermes',   particles:{ color:'rgba(155,89,182,', count:15 },  glitch:false },
    rasa:    { class:'atmo-rasa',     particles:{ color:'rgba(231,76,60,',   count:12 },  glitch:false },
    tao:     { class:'atmo-tao',      particles:{ color:'rgba(39,174,96,',   count:10 },  glitch:false },
    jabir:   { class:'atmo-jabir',    particles:{ color:'rgba(230,126,34,',  count:14 },  glitch:false, heat:true },
    catedral:{ class:'atmo-catedral', particles:{ color:'rgba(41,128,185,',  count:8  },  glitch:false },
    quantum: { class:'atmo-quantum',  particles:{ color:'rgba(155,89,182,',  count:20 },  glitch:true },
  };

  function spawnBGParticle(cfg) {
    return {
      x:Math.random()*100, y:100+Math.random()*30,
      size:Math.random()*3+1,
      vx:(Math.random()-0.5)*0.1,
      vy:-(Math.random()*0.4+0.1),
      alpha:0, maxAlpha:Math.random()*0.5+0.2,
      life:0, maxLife:300+Math.random()*200,
      color:cfg.color,
    };
  }

  function bgLoop() {
    if(!canvas||!ctx){bgAnimId=null;return;}
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if(!currentTradition){bgAnimId=null;return;}
    const cfg=ATMO_CONFIGS[currentTradition];
    if(!cfg){bgAnimId=null;return;}

    // Spawn
    while(BG_PARTICLES.length < cfg.particles.count) {
      BG_PARTICLES.push(spawnBGParticle(cfg.particles));
    }
    // Update & draw
    for(let i=BG_PARTICLES.length-1;i>=0;i--){
      const p=BG_PARTICLES[i];
      p.life++;
      p.x+=p.vx; p.y+=p.vy;
      if(p.life<20) p.alpha=p.maxAlpha*(p.life/20);
      else if(p.life>p.maxLife-20) p.alpha=p.maxAlpha*((p.maxLife-p.life)/20);
      else p.alpha=p.maxAlpha;

      ctx.beginPath();
      ctx.arc(p.x/100*canvas.width, p.y/100*canvas.height, p.size, 0, Math.PI*2);
      ctx.fillStyle=p.color+p.alpha+')';
      ctx.shadowBlur=p.size*3; ctx.shadowColor=p.color+'0.5)';
      ctx.fill();
      ctx.shadowBlur=0;

      if(p.life>=p.maxLife||p.y<0) BG_PARTICLES.splice(i,1);
    }
    bgAnimId=requestAnimationFrame(bgLoop);
  }

  return {
    init() {
      canvas=document.getElementById('godrays-canvas');
      if(canvas){
        ctx=canvas.getContext('2d');
        const main=document.getElementById('main');
        if(main){
          const r=main.getBoundingClientRect();
          canvas.width=r.width||800; canvas.height=r.height||600;
        }
      }
    },
    set(tradition) {
      if(tradition===currentTradition)return;
      // Remove old atmo classes
      Object.values(ATMO_CONFIGS).forEach(c=>document.body.classList.remove(c.class));
      currentTradition=tradition;
      BG_PARTICLES.length=0;
      if(!tradition)return;
      const cfg=ATMO_CONFIGS[tradition];
      if(!cfg)return;
      document.body.classList.add(cfg.class);
      if(!bgAnimId) bgAnimId=requestAnimationFrame(bgLoop);
    },
    triggerGlitch() {
      const g=document.getElementById('glitch-overlay');
      if(!g)return;
      g.classList.remove('active');
      void g.offsetWidth; // reflow
      g.classList.add('active');
      setTimeout(()=>g.classList.remove('active'),350);
    },
    setQuantum(active) {
      const main=document.getElementById('main');
      if(!main)return;
      if(active) main.classList.add('atmo-quantum');
      else main.classList.remove('atmo-quantum');
      this.set(active?'quantum':null);
    }
  };
})();

// ═══════════════════════════════════════════════════════════════
// FRENTE 6: GOD RAYS (Volumetric Lighting)
// Mitchell 2004 · GPU Gems 2 "Volumetric Light Effects"
// ═══════════════════════════════════════════════════════════════
const GodRaysRenderer = (() => {
  let canvas, ctx;
  let sources = [];
  let animId = null;

  function drawGodRay(ctx, sx, sy, W, H, color, intensity) {
    const rays = 6+Math.floor(Math.random()*4);
    for(let i=0;i<rays;i++){
      const angle = (i/rays)*Math.PI*2 + Date.now()*0.0003;
      const len = (0.3+Math.random()*0.5)*Math.min(W,H);
      const ex = sx+Math.cos(angle)*len;
      const ey = sy+Math.sin(angle)*len;
      const grad=ctx.createLinearGradient(sx,sy,ex,ey);
      grad.addColorStop(0,color.replace(')',`,${intensity*0.4})`).replace('rgb','rgba'));
      grad.addColorStop(1,color.replace(')',',0)').replace('rgb','rgba'));
      ctx.beginPath();
      ctx.moveTo(sx,sy);
      const spreadAngle=0.04+Math.random()*0.04;
      ctx.lineTo(sx+Math.cos(angle+spreadAngle)*len, sy+Math.sin(angle+spreadAngle)*len);
      ctx.lineTo(sx+Math.cos(angle-spreadAngle)*len, sy+Math.sin(angle-spreadAngle)*len);
      ctx.closePath();
      ctx.fillStyle=grad;
      ctx.fill();
    }
  }

  function loop() {
    if(!canvas||!ctx||sources.length===0){animId=null;return;}
    const W=canvas.width, H=canvas.height;
    ctx.clearRect(0,0,W,H);
    const t=Date.now()*0.001;
    sources.forEach(s=>{
      const pulse=s.baseIntensity*(0.7+0.3*Math.sin(t*s.pulseSpeed));
      // Glow circle
      const grad=ctx.createRadialGradient(s.x,s.y,0,s.x,s.y,s.radius*(1.5+0.3*Math.sin(t)));
      grad.addColorStop(0,s.color.replace(')',`,${pulse*0.8})`).replace('rgb','rgba'));
      grad.addColorStop(0.4,s.color.replace(')',`,${pulse*0.2})`).replace('rgb','rgba'));
      grad.addColorStop(1,s.color.replace(')',',0)').replace('rgb','rgba'));
      ctx.beginPath();
      ctx.arc(s.x,s.y,s.radius*2,0,Math.PI*2);
      ctx.fillStyle=grad; ctx.fill();
      // Rays
      drawGodRay(ctx,s.x,s.y,W,H,s.color,pulse*0.3);
    });
    animId=requestAnimationFrame(loop);
  }

  return {
    init(canvasEl){
      canvas=canvasEl; ctx=canvas.getContext('2d');
      const c=document.getElementById('godrays-canvas');
      if(c) c.classList.add('active');
    },
    setSources(srcs){
      sources=srcs;
      const c=document.getElementById('godrays-canvas');
      if(srcs.length>0&&c) c.classList.add('active');
      else if(c) c.classList.remove('active');
      if(!animId&&srcs.length>0) animId=requestAnimationFrame(loop);
    },
    clear(){
      sources=[];
      const c=document.getElementById('godrays-canvas');
      if(c){c.classList.remove('active');}
      if(ctx&&canvas) ctx.clearRect(0,0,canvas.width,canvas.height);
    }
  };
})();

// ═══════════════════════════════════════════════════════════════
// FRENTE 4: SPRING ANIMATION SYSTEM
// Thomas & Johnston 1981 · Noble 2016 ACM SIGGRAPH
// ═══════════════════════════════════════════════════════════════
const SpringSystem = {
  applyToScene(sceneEl) {
    if(!sceneEl)return;
    const children=[...sceneEl.querySelectorAll('.module-header,.card,.dialogue-box,.scroll-text,.resource-card,.choice-btn,.btn')];
    children.forEach((el,i)=>{
      el.style.animationDelay=`${i*0.04}s`;
      el.classList.add('spring-in');
      // Remove class after animation to allow re-trigger
      el.addEventListener('animationend',()=>el.classList.remove('spring-in'),{once:true});
    });
  }
};

// ═══════════════════════════════════════════════════════════════
// EVENT BUS LISTENERS
// ═══════════════════════════════════════════════════════════════

EventBus.on('wisdom_updated', (w)=>{
  Game.updateSidebar();
  // Particle burst on wisdom gain - find dominant tradition updated
  const traditions=['hermes','rasa','tao','jabir','catedral'];
  // Find which changed (track last state)
  if(!EventBus._lastW) EventBus._lastW={...w};
  traditions.forEach(t=>{
    if(w[t]>(EventBus._lastW[t]||0)+0.005) {
      // Burst from a random position in the main area
      const rect=document.getElementById('main')?.getBoundingClientRect();
      if(rect) WisdomParticles.burst(
        rect.left+rect.width*0.3+Math.random()*rect.width*0.4,
        rect.top+rect.height*0.4+Math.random()*rect.height*0.2,
        t, 20
      );
    }
  });
  EventBus._lastW={...w};
});
EventBus.on('player_updated', ()=>{ Game.updateSidebar(); });
EventBus.on('module_completed', (id)=>{
  Game.updateNav();
  Game.buildProgressGrid();
  ProofOfWisdom.record(id);
  const mod = MODULES[id];
  if(mod) GranularEngine.setMode(mod.tradition);
  // Big particle burst on completion
  const rect=document.getElementById('main')?.getBoundingClientRect();
  if(rect) {
    const cx=rect.left+rect.width/2, cy=rect.top+rect.height/2;
    WisdomParticles.burst(cx, cy, mod?.tradition||'default', 40);
    setTimeout(()=>WisdomParticles.burst(cx+40,cy-30,mod?.tradition,20),200);
  }
  AtmosphereEngine.triggerGlitch();
});
EventBus.on('zarandaja_detected', ({word})=>{
  OraculvmCore.setStatus(`⚠ ZARANDAJA DETECTADA: "${word}"`);
  Game.showZarandaja();
});

// Terminal input con detección de zarandaja
document.addEventListener('keydown', e=>{
  if(e.key==='Enter') {
    const inputs = document.querySelectorAll('.terminal-input input');
    inputs.forEach(input => {
      if(input.value) {
        ZarandajaDetector.check(input.value);
        input.value='';
      }
    });
  }
});

// ═══════════════════════════════════════════════════════════════
// BOOT
// ═══════════════════════════════════════════════════════════════
// ═══════════════════════════════════════════════════════════════════════
// PAPER 2 + 19: THREE.JS 3D TREE — L-Systems + Wind Deformation
// Deussen & Lintermann 1999 · Sifakis & Barbič 2012
// ═══════════════════════════════════════════════════════════════════════
ModuleLogic.tree3d = {
  scene:null, camera:null, renderer:null, animId:null,
  branches:[], leafMeshes:[], sephNodes:[],
  gen:0, windOn:false, windT:0, isDragging:false,
  rotX:0.3, rotY:0.5, lastMX:0, lastMY:0,

  // Perlin noise (simple)
  _fade(t){return t*t*t*(t*(t*6-15)+10)},
  _lerp(a,b,t){return a+t*(b-a)},
  _grad(h,x,y,z){h&=15;const u=h<8?x:y,v=h<4?y:h===12||h===14?x:z;return((h&1)?-u:u)+((h&2)?-v:v)},
  _p:null,
  _getP(){if(!this._p){const p=[];for(let i=0;i<256;i++)p[i]=i;for(let i=255;i>0;i--){const j=Math.floor(Math.random()*(i+1));[p[i],p[j]]=[p[j],p[i]];}this._p=[...p,...p];}return this._p;},
  noise(x,y,z){
    const p=this._getP();
    const X=Math.floor(x)&255,Y=Math.floor(y)&255,Z=Math.floor(z)&255;
    x-=Math.floor(x);y-=Math.floor(y);z-=Math.floor(z);
    const u=this._fade(x),v=this._fade(y),w=this._fade(z);
    const A=p[X]+Y,AA=p[A]+Z,AB=p[A+1]+Z,B=p[X+1]+Y,BA=p[B]+Z,BB=p[B+1]+Z;
    return this._lerp(
      this._lerp(this._lerp(this._grad(p[AA],x,y,z),this._grad(p[BA],x-1,y,z),u),
                 this._lerp(this._grad(p[AB],x,y-1,z),this._grad(p[BB],x-1,y-1,z),u),v),
      this._lerp(this._lerp(this._grad(p[AA+1],x,y,z-1),this._grad(p[BA+1],x-1,y,z-1),u),
                 this._lerp(this._grad(p[AB+1],x,y-1,z-1),this._grad(p[BB+1],x-1,y-1,z-1),u),v),w);
  },

  init(){
    const canvas=document.getElementById('threejs-tree-canvas');
    if(!canvas||!window.THREE)return;
    // Scene setup
    this.scene=new THREE.Scene();
    this.scene.background=new THREE.Color(0x030508);
    this.scene.fog=new THREE.FogExp2(0x030508,0.15);

    const W=canvas.offsetWidth||400, H=canvas.offsetHeight||320;
    this.camera=new THREE.PerspectiveCamera(55,W/H,0.1,100);
    this.camera.position.set(0,2,5);
    this.camera.lookAt(0,1,0);

    this.renderer=new THREE.WebGLRenderer({canvas,antialias:true,alpha:false});
    this.renderer.setSize(W,H);
    this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
    this.renderer.shadowMap.enabled=true;
    this.renderer.shadowMap.type=THREE.PCFSoftShadowMap;

    // Lighting
    const ambient=new THREE.AmbientLight(0x1a1a2e,1.5);
    this.scene.add(ambient);
    const gold=new THREE.PointLight(0xc8962a,3,20);
    gold.position.set(0,5,2); gold.castShadow=true;
    this.scene.add(gold);
    const fill=new THREE.PointLight(0x2a3f5c,1,15);
    fill.position.set(-3,2,-2);
    this.scene.add(fill);

    // Ground plane
    const gGeo=new THREE.PlaneGeometry(10,10);
    const gMat=new THREE.MeshStandardMaterial({color:0x070d14,roughness:0.9,metalness:0.1});
    const ground=new THREE.Mesh(gGeo,gMat);
    ground.rotation.x=-Math.PI/2; ground.receiveShadow=true;
    this.scene.add(ground);

    // Mouse drag
    canvas.addEventListener('mousedown',e=>{this.isDragging=true;this.lastMX=e.clientX;this.lastMY=e.clientY;});
    canvas.addEventListener('mouseup',()=>{this.isDragging=false;});
    canvas.addEventListener('mousemove',e=>{
      if(!this.isDragging)return;
      this.rotY+=(e.clientX-this.lastMX)*0.008;
      this.rotX+=(e.clientY-this.lastMY)*0.005;
      this.rotX=Math.max(-0.2,Math.min(1.2,this.rotX));
      this.lastMX=e.clientX; this.lastMY=e.clientY;
    });

    this.buildTree();
    this.buildSephNodes();
    this.loop();
    this.updateUI();
  },

  buildTree(){
    // Remove old branches/leaves
    this.branches.forEach(m=>{this.scene.remove(m);m.geometry.dispose();m.material.dispose();});
    this.leafMeshes.forEach(m=>{this.scene.remove(m);m.geometry.dispose();m.material.dispose();});
    this.branches=[]; this.leafMeshes=[];

    const maxDepth=Math.min(5,this.gen+1);
    const trad=OraculvmCore.getDominantTradition();
    const leafColors={hermes:0xc8962a,rasa:0xe74c3c,tao:0x27ae60,jabir:0xe67e22,catedral:0x2980b9,default:0x27ae60};
    const leafCol=leafColors[trad]||leafColors.default;
    const barkCol={hermes:0x5a3a8a,rasa:0x6b2525,tao:0x2a5a2a,jabir:0x6b4a1a,catedral:0x1a3a5a,default:0x3a2a1a}[trad]||0x3a2a1a;

    const leafGeo=new THREE.SphereGeometry(0.05,4,4);
    const leafMat=new THREE.MeshStandardMaterial({color:leafCol,roughness:0.8,emissive:leafCol,emissiveIntensity:0.1});

    const self=this;
    function branch(pos,dir,thickness,depth){
      if(depth<=0||thickness<0.01)return;
      const length=(0.6+Math.random()*0.4)*(depth/maxDepth+0.3);
      const end=pos.clone().add(dir.clone().multiplyScalar(length));
      const geo=new THREE.CylinderGeometry(thickness*0.6,thickness,length,6,1);
      const mat=new THREE.MeshStandardMaterial({color:barkCol,roughness:0.9,metalness:0.05});
      const mesh=new THREE.Mesh(geo,mat);
      mesh.position.copy(pos.clone().add(end).multiplyScalar(0.5));
      mesh.quaternion.setFromUnitVectors(new THREE.Vector3(0,1,0),dir.clone().normalize());
      mesh.castShadow=true; mesh.receiveShadow=true;
      mesh.userData.origPos=mesh.position.clone();
      mesh.userData.depth=depth;
      self.scene.add(mesh);
      self.branches.push(mesh);

      if(depth<=2){
        for(let i=0;i<3;i++){
          const lm=new THREE.Mesh(leafGeo,leafMat);
          lm.position.copy(end.clone().add(new THREE.Vector3((Math.random()-0.5)*0.3,(Math.random()-0.5)*0.2,(Math.random()-0.5)*0.3)));
          lm.userData.origPos=lm.position.clone();
          lm.userData.leafPhase=Math.random()*Math.PI*2;
          self.scene.add(lm);
          self.leafMeshes.push(lm);
        }
      }

      const splits=depth>2?3:2;
      for(let i=0;i<splits;i++){
        const angle=(i/splits)*Math.PI*2+(Math.random()-0.5)*0.5;
        const spread=0.4+Math.random()*0.4;
        const newDir=dir.clone().add(new THREE.Vector3(Math.cos(angle)*spread,(Math.random()-0.3)*0.3,Math.sin(angle)*spread)).normalize();
        branch(end,newDir,thickness*0.65,depth-1);
      }
    }

    branch(new THREE.Vector3(0,0,0),new THREE.Vector3(0,1,0.05),0.12,maxDepth);
  },

  buildSephNodes(){
    this.sephNodes.forEach(m=>{this.scene.remove(m);m.geometry.dispose();m.material.dispose();});
    this.sephNodes=[];
    const sephiroth=[
      {name:'Kether',   x:0,   y:4.5, z:0,   color:0xffffff},
      {name:'Chokmah',  x:-1,  y:3.8, z:0,   color:0x9b59b6},
      {name:'Binah',    x:1,   y:3.8, z:0,   color:0x2980b9},
      {name:'Chesed',   x:-1.5,y:2.8, z:0,   color:0x27ae60},
      {name:'Geburah',  x:1.5, y:2.8, z:0,   color:0xe74c3c},
      {name:'Tiphareth',x:0,   y:2,   z:0,   color:0xc8962a},
      {name:'Netzach',  x:-1,  y:1.2, z:0,   color:0xe67e22},
      {name:'Hod',      x:1,   y:1.2, z:0,   color:0xc8962a},
      {name:'Yesod',    x:0,   y:0.5, z:0,   color:0x8a9ab5},
      {name:'Malkuth',  x:0,   y:-0.1,z:0,   color:0x3a2a1a},
    ];
    const geo=new THREE.SphereGeometry(0.1,12,12);
    sephiroth.forEach(s=>{
      const mat=new THREE.MeshStandardMaterial({color:s.color,emissive:s.color,emissiveIntensity:0.6,roughness:0.2,metalness:0.8});
      const m=new THREE.Mesh(geo,mat);
      m.position.set(s.x,s.y,s.z);
      m.userData.sephName=s.name; m.userData.origY=s.y;
      const light=new THREE.PointLight(s.color,0.8,1.5);
      m.add(light);
      this.scene.add(m);
      this.sephNodes.push(m);
    });
  },

  loop(){
    this.animId=requestAnimationFrame(()=>this.loop());
    this.windT+=0.01;

    // Orbit camera
    const r=5;
    this.camera.position.x=Math.sin(this.rotY)*r*Math.cos(this.rotX);
    this.camera.position.y=Math.sin(this.rotX)*r+1;
    this.camera.position.z=Math.cos(this.rotY)*r*Math.cos(this.rotX);
    this.camera.lookAt(0,1.5,0);

    // Wind deformation (Paper 19 — Sifakis & Barbič)
    if(this.windOn){
      const t=this.windT;
      this.branches.forEach(m=>{
        const d=m.userData.depth||1;
        const wind=this.noise(m.userData.origPos.x*0.5,t*0.3,m.userData.origPos.z*0.5);
        const windZ=this.noise(m.userData.origPos.x*0.5,t*0.3+100,m.userData.origPos.z*0.5);
        const factor=0.03/(d+1);
        m.position.x=m.userData.origPos.x+wind*factor*3;
        m.position.z=m.userData.origPos.z+windZ*factor*2;
      });
      this.leafMeshes.forEach(m=>{
        const wind=this.noise(m.userData.origPos.x*0.8,t*0.5+m.userData.leafPhase,m.userData.origPos.z*0.8);
        m.position.x=m.userData.origPos.x+wind*0.04;
        m.position.y=m.userData.origPos.y+Math.sin(t*2+m.userData.leafPhase)*0.02;
      });
    }

    // Sephirot pulse
    this.sephNodes.forEach((m,i)=>{
      const s=1+0.1*Math.sin(this.windT*1.5+i*0.7);
      m.scale.setScalar(s);
      m.position.y=m.userData.origY+0.05*Math.sin(this.windT+i);
    });

    this.renderer.render(this.scene,this.camera);
  },

  grow(){
    if(this.gen<8)this.gen++;
    this.buildTree();
    this.updateUI();
    OraculvmCore.updateWisdom({hermes:0.03,tao:0.02});
    WisdomParticles.burst(window.innerWidth*0.35,window.innerHeight*0.4,'tao',15);
    showWisdomPopup(`Árbol crece · Gen ${this.gen}`,'tao');
  },
  reset(){this.gen=0;this.buildTree();this.updateUI();},
  toggleWind(){
    this.windOn=!this.windOn;
    const el=document.getElementById('tree3d-wind');
    if(el)el.textContent=this.windOn?'ON':'OFF';
  },
  findPath(){
    const log=document.getElementById('astar-log');
    if(log){
      log.innerHTML='<span style="color:var(--teal-bright)">A* sobre grafo sefirótico...\n</span>';
      const nodes=['Kether','Tiphareth','Yesod','Malkuth'];
      log.innerHTML+=`<span style="color:var(--amber)">Camino: ${nodes.join(' → ')}</span>\n`;
      log.innerHTML+=`<span style="color:var(--mist)">Coste: ${(Math.random()*10+5).toFixed(2)}</span>`;
    }
    OraculvmCore.updateWisdom({hermes:0.04});
  },
  updateUI(){
    const g=document.getElementById('tree3d-gen');
    const v=document.getElementById('tree3d-verts');
    const b=document.getElementById('tree3d-branches');
    const l=document.getElementById('tree3d-leaves');
    if(g)g.textContent=this.gen;
    if(v)v.textContent=this.branches.length+this.leafMeshes.length;
    if(b)b.textContent=this.branches.length;
    if(l)l.textContent=this.leafMeshes.length;
    // Also trigger L-system 2D
    if(ModuleLogic.lsystem&&typeof ModuleLogic.lsystem.init==='function')ModuleLogic.lsystem.init();
  },
  destroy(){
    cancelAnimationFrame(this.animId); this.animId=null;
    if(this.renderer){this.renderer.dispose();}
    this.branches=[]; this.leafMeshes=[]; this.sephNodes=[];
    this.scene=null; this.camera=null; this.renderer=null;
    this._p=null;
  }
};

// ═══════════════════════════════════════════════════════════════════════
// PAPER 10: WEAK MEASUREMENT — Aharonov et al. 1988
// Quantum wave canvas renderer + weakMeasure()
// ═══════════════════════════════════════════════════════════════════════
// Extend quantum module with weakMeasure and wave canvas rendering
(function extendQuantum(){
  const orig=ModuleLogic.quantum.init;
  ModuleLogic.quantum.init=function(){
    orig.call(this);
    this.renderWaveFull();
  };
  ModuleLogic.quantum.superpose=function(){
    this.state='superposition';
    this.alpha=Math.SQRT1_2; this.beta=Math.SQRT1_2;
    const box=document.getElementById('quantum-box');
    const glyph=document.getElementById('quantum-glyph');
    const stateEl=document.getElementById('quantum-state');
    if(glyph)glyph.textContent='?';
    if(box){box.style.borderColor='var(--amber)';box.style.boxShadow='0 0 20px rgba(200,150,42,0.4)';}
    if(stateEl)stateEl.textContent='SUPERPOSICIÓN';
    this.updateQProbs();
  };
  ModuleLogic.quantum.weakMeasure=function(){
    const W=OraculvmCore.getWisdom();
    if(W.jabir<0.1){
      showWisdomPopup('Jabir insuficiente · Necesitas más alquimia','jabir');
      return;
    }
    OraculvmCore.updateWisdom({jabir:-0.1});
    // Bias α² by +5% (Aharonov 1988)
    const alpha2=Math.min(0.95,this.alpha*this.alpha+0.05);
    this.alpha=Math.sqrt(alpha2);
    this.beta=Math.sqrt(1-alpha2);
    WisdomParticles.burst(window.innerWidth/2,window.innerHeight/2,'jabir',12);
    showWisdomPopup('Medición débil aplicada · α² += 5%','jabir');
    this.updateQProbs();
    this.renderWaveFull();
  };
  ModuleLogic.quantum.updateQProbs=function(){
    const a2=(this.alpha*this.alpha*100).toFixed(1);
    const b2=(this.beta*this.beta*100).toFixed(1);
    const qa=document.getElementById('q-alpha');
    const qb=document.getElementById('q-beta');
    const pa=document.getElementById('prob-alive');
    const pb=document.getElementById('prob-dead');
    if(qa)qa.textContent=a2+'%';
    if(qb)qb.textContent=b2+'%';
    if(pa)pa.textContent=a2;
    if(pb)pb.textContent=b2;
  };
  ModuleLogic.quantum.renderWaveFull=function(){
    const canvas=document.getElementById('quantum-wave-canvas')||document.getElementById('wave-canvas');
    if(!canvas)return;
    const ctx=canvas.getContext('2d');
    const W=canvas.offsetWidth||300; const H=canvas.height||120;
    canvas.width=W;
    ctx.fillStyle='#030508'; ctx.fillRect(0,0,W,H);
    // Draw |ψ|² probability density
    const certainty=Math.abs(this.alpha*this.alpha-0.5)*2; // 0=max uncertainty,1=collapsed
    const sigma=0.15+certainty*0.1;
    const peakA=this.alpha*this.alpha, peakB=this.beta*this.beta;
    // Two Gaussian peaks for |alive⟩ and |dead⟩
    ctx.beginPath();
    for(let i=0;i<=W;i++){
      const x=(i/W)*4-2; // -2..2
      const psi=peakA*Math.exp(-((x+0.8)**2)/(2*sigma**2))+peakB*Math.exp(-((x-0.8)**2)/(2*sigma**2));
      const y=H-psi*H*0.85-8;
      if(i===0)ctx.moveTo(i,y); else ctx.lineTo(i,y);
    }
    ctx.strokeStyle=`rgba(155,89,182,${0.4+certainty*0.5})`;
    ctx.lineWidth=1.5+certainty*1.5;
    ctx.shadowBlur=8*(1-certainty); ctx.shadowColor='rgba(155,89,182,0.6)';
    ctx.stroke(); ctx.shadowBlur=0;
    // Vibrating uncertainty noise
    if(certainty<0.5){
      ctx.globalAlpha=0.15;
      ctx.beginPath();
      for(let i=0;i<=W;i++){
        const noise=Math.sin(i*0.3+Date.now()*0.01)*0.02*(1-certainty);
        const x=(i/W)*4-2;
        const psi=peakA*Math.exp(-((x+0.8)**2)/(2*(sigma+noise)**2));
        ctx.lineTo(i,H-psi*H*0.85-8);
      }
      ctx.strokeStyle='rgba(232,168,48,0.5)';
      ctx.lineWidth=1; ctx.stroke();
      ctx.globalAlpha=1;
    }
    // Axis
    ctx.strokeStyle='rgba(200,150,42,0.15)';
    ctx.lineWidth=1; ctx.setLineDash([3,3]);
    ctx.beginPath(); ctx.moveTo(0,H-8); ctx.lineTo(W,H-8); ctx.stroke();
    ctx.setLineDash([]);
    // Labels
    ctx.fillStyle='rgba(200,150,42,0.4)'; ctx.font='9px Share Tech Mono';
    ctx.fillText('|vivo⟩',W*0.2,H-2);
    ctx.fillText('|muerto⟩',W*0.65,H-2);
    this.updateQProbs();
  };
  // Hook into observe to re-render wave
  const origObs=ModuleLogic.quantum.observe;
  ModuleLogic.quantum.observe=function(){
    origObs.call(this);
    this.renderWaveFull();
  };
})();

// ═══════════════════════════════════════════════════════════════════════
// PAPER 11: ACCESSIBILITY SYSTEM — Okabe & Ito 2008
// ═══════════════════════════════════════════════════════════════════════
const A11ySystem = (() => {
  let current='standard', baseFontSize=16, panelVisible=false;
  return {
    init(){
      try{
        const saved=localStorage.getItem('oraculvm-a11y');
        if(saved){const s=JSON.parse(saved);this.setPalette(s.palette||'standard');this.baseFontSize=s.fontSize||16;document.documentElement.style.fontSize=this.baseFontSize+'px';}
      }catch(e){}
    },
    toggle(){
      panelVisible=!panelVisible;
      const p=document.getElementById('a11y-panel');
      if(p)p.style.display=panelVisible?'block':'none';
    },
    setPalette(name){
      const classes=['pal-deuteranopia','pal-protanopia','pal-tritanopia','pal-highcontrast'];
      classes.forEach(c=>document.body.classList.remove(c));
      if(name!=='standard') document.body.classList.add('pal-'+name);
      current=name;
      // Update button states
      ['standard','deuteranopia','protanopia','tritanopia','highcontrast'].forEach(p=>{
        const btn=document.getElementById('pal-btn-'+p);
        if(btn)btn.classList.toggle('active',p===name);
      });
      this._save();
    },
    fontSize(delta){
      baseFontSize=Math.min(22,Math.max(12,baseFontSize+delta));
      document.documentElement.style.fontSize=baseFontSize+'px';
      this._save();
    },
    _save(){try{localStorage.setItem('oraculvm-a11y',JSON.stringify({palette:current,fontSize:baseFontSize}));}catch(e){}}
  };
})();

// ═══════════════════════════════════════════════════════════════════════
// PAPER 13: MICROPHONE SILENCE MONITOR — Collins 2008
// ═══════════════════════════════════════════════════════════════════════
const MicrophoneMonitor = (() => {
  let stream=null, analyser=null, dataArr=null, ctx=null, active=false;
  let noiseLevel=0, THRESHOLD=0.12;
  return {
    async request(){
      if(active)return;
      try{
        stream=await navigator.mediaDevices.getUserMedia({audio:true,video:false});
        ctx=new (window.AudioContext||window.webkitAudioContext)();
        const src=ctx.createMediaStreamSource(stream);
        analyser=ctx.createAnalyser();
        analyser.fftSize=256;
        dataArr=new Uint8Array(analyser.frequencyBinCount);
        src.connect(analyser);
        active=true;
        this.update();
        return true;
      }catch(e){
        const d=document.getElementById('mic-indicator');
        if(d)d.innerHTML='🎤 <span style="color:var(--red)">PERMISO DENEGADO</span>';
        return false;
      }
    },
    update(){
      if(!active||!analyser)return;
      analyser.getByteFrequencyData(dataArr);
      const rms=Math.sqrt(dataArr.reduce((s,v)=>s+v*v,0)/dataArr.length)/128;
      noiseLevel=rms;
      // Update UI
      const dot=document.querySelector('.mic-dot');
      const fill=document.getElementById('noise-fill');
      const label=document.getElementById('mic-label');
      if(dot){dot.classList.toggle('active',rms>THRESHOLD);dot.classList.toggle('quiet',rms<=THRESHOLD&&rms>0.01);}
      if(fill)fill.style.width=Math.min(100,rms*300)+'%';
      if(label)label.textContent=rms>THRESHOLD?'¡RUIDO DETECTADO!':rms<0.02?'SILENCIO':'ruido ambiental';
      requestAnimationFrame(()=>this.update());
    },
    getLevel(){return noiseLevel;},
    isTooLoud(){return noiseLevel>THRESHOLD;},
    stop(){
      if(stream)stream.getTracks().forEach(t=>t.stop());
      active=false;
    }
  };
})();

// ═══════════════════════════════════════════════════════════════════════
// PAPER 14: DYNAMIC DIFFICULTY ADJUSTMENT — Hunicke 2005
// Kalman filter per-tradition skill estimation
// ═══════════════════════════════════════════════════════════════════════
const KalmanDDA = (() => {
  const traditions=['hermes','rasa','tao','jabir','catedral'];
  const state={};
  traditions.forEach(t=>{state[t]={x:0.5,P:0.5,Q:0.01,R:0.2};});
  let performanceLog=[];

  return {
    // Update estimate from observation z (0..1 = bad..perfect)
    update(tradition, z){
      if(!state[tradition])return;
      const s=state[tradition];
      s.P+=s.Q; // predict
      const K=s.P/(s.P+s.R);
      s.x=s.x+K*(z-s.x);
      s.P=(1-K)*s.P;
      performanceLog.push({t:tradition,z,x:s.x,ts:Date.now()});
      if(performanceLog.length>100)performanceLog.shift();
    },
    getSkill(tradition){return state[tradition]?.x??0.5;},
    getDifficulty(){
      const avg=traditions.reduce((s,t)=>s+state[t].x,0)/traditions.length;
      if(avg<0.35)return'FÁCIL';
      if(avg<0.65)return'FLUJO';
      return'EXPERTO';
    },
    // Call after wisdom gains to feed the Kalman filter
    onWisdomGain(tradition,amount){
      this.update(tradition,Math.min(1,amount*10));
    },
    // Adjust visible complexity (returns extra choices count)
    extraChoices(){
      const avg=traditions.reduce((s,t)=>s+state[t].x,0)/traditions.length;
      return Math.floor(avg*3);
    }
  };
})();

// ═══════════════════════════════════════════════════════════════════════
// PAPER 15: SEMANTIC ENTROPY CHRONICLE — Kleinberg 2025 arXiv:2501.01310
// Generates a unique narrative chronicle from player decision graph
// ═══════════════════════════════════════════════════════════════════════
const ChronicleGenerator = (() => {
  const ARCHETYPES={
    hermetic:["El viajero tejió redes de luz sobre el abismo lógico","La geometría sagrada guió sus pasos por los corredores del Oraculvm","El mensajero de los dioses encontró su eco en los números primos"],
    alchemical:["El fuego de Jabir purificó el metal del error","La transmutación fue completa cuando el plomo del caos se convirtió en el oro de la comprensión","El laboratorio interior produjo su primera tintura perfecta"],
    taoic:["El equilibrio no se conquistó; se habitó","Como el agua que fluye sin esfuerzo, el viajero encontró el camino de menor resistencia","El vacío entre las notas fue la música más perfecta"],
    vital:["La llama de Rasa ardió con intensidad de supernova","Cada latido del juego correspondió a un latido del corazón del viajero","La vida reconoció la vida en el espejo del sistema"],
    structural:["Las catedrales de datos se alzaron piedra a piedra","El arquitecto invisible dejó su firma en cada arco de código","La estructura resistió el peso de la complejidad con gracia silenciosa"],
  };
  const CONNECTORS=["Y entonces","Sin embargo","En ese momento","Así","Porque","Al mismo tiempo que","Mientras tanto"];
  const ENDINGS=["El número 1310 resonó en las paredes del Oraculvm como un gong tibetano.","La crónica no termina. Continúa en el próximo ciclo.","Y el Oraculvm anotó en su registro: este viajero fue real.","ZEHAHAHAHA. 1310.","El fantasma de Teodoro asintió desde su rincón de sombras."];

  // Simple semantic entropy from wisdom distribution
  function entropy(w){
    const vals=[w.hermes,w.rasa,w.tao,w.jabir,w.catedral].filter(v=>v>0);
    const sum=vals.reduce((a,b)=>a+b,0)||1;
    return -vals.reduce((H,v)=>{const p=v/sum;return H+(p>0?p*Math.log2(p):0);},0);
  }

  // Generate narrative from state
  function buildText(W){
    const e=entropy(W);
    const arcKeys=Object.keys(ARCHETYPES);
    const dom=['hermes','rasa','tao','jabir','catedral']
      .sort((a,b)=>W[b]-W[a]).slice(0,3);
    const arcMap={hermes:'hermetic',rasa:'vital',tao:'taoic',jabir:'alchemical',catedral:'structural'};
    let paras=[];
    dom.forEach((t,i)=>{
      const arc=ARCHETYPES[arcMap[t]]||ARCHETYPES.hermetic;
      const sentence=arc[Math.floor(Math.random()*arc.length)];
      const conn=i===0?'El viajero avanzó':CONNECTORS[Math.floor(Math.random()*CONNECTORS.length)];
      paras.push(`${conn}, ${sentence.toLowerCase()}.`);
    });
    paras.push(`<br><span style="color:var(--mist);font-size:12px">Entropía semántica: ${e.toFixed(3)} bits · ${OraculvmCore.getCompletedCount()} módulos completados.</span>`);
    paras.push(`<br><em>${ENDINGS[Math.floor(Math.random()*ENDINGS.length)]}</em>`);
    return paras.join(' ');
  }

  return {
    open(){
      const panel=document.getElementById('chronicle-panel');
      if(!panel)return;
      panel.classList.add('visible');
      this.generate();
    },
    close(){
      const panel=document.getElementById('chronicle-panel');
      if(panel)panel.classList.remove('visible');
    },
    generate(){
      const W=OraculvmCore.getWisdom();
      // Entropy display
      const entropyEl=document.getElementById('chronicle-entropy');
      if(entropyEl){
        const trad=[
          {k:'hermes',label:'HERMES',color:'var(--hermes)'},
          {k:'rasa',label:'RASA',color:'var(--rasa)'},
          {k:'tao',label:'TAO',color:'var(--tao)'},
          {k:'jabir',label:'JABIR',color:'var(--jabir)'},
          {k:'catedral',label:'CATEDRAL',color:'var(--catedral)'},
        ];
        entropyEl.innerHTML=trad.map(t=>`
          <div class="entropy-cell">
            <div class="entropy-label" style="color:${t.color}">${t.label}</div>
            <div class="entropy-val">${(W[t.k]*100).toFixed(0)}%</div>
          </div>`).join('');
      }
      // Hash
      const hash=OraculvmCore.djb2(JSON.stringify(W)+Date.now()).toString(16).toUpperCase();
      const dateEl=document.getElementById('chronicle-date');
      if(dateEl)dateEl.textContent=`CICLO 1310 · HASH: ${hash.padStart(8,'0')}`;
      // Text
      const textEl=document.getElementById('chronicle-text');
      if(textEl){
        textEl.innerHTML='<span style="color:var(--mist)">...</span>';
        setTimeout(()=>{
          textEl.innerHTML=buildText(W);
        },400);
      }
    }
  };
})();

// ═══════════════════════════════════════════════════════════════════════
// PAPER 17: SPATIAL AUDIO — Roginska & Geluso 2017 · HRTF PannerNode
// Extends GranularEngine with spatial positioning
// ═══════════════════════════════════════════════════════════════════════
const SpatialAudio = (() => {
  let panners={};
  return {
    // Create a panner node attached to GranularEngine context
    createSource(id, x, y, z){
      const ac=GranularEngine.getContext();
      if(!ac)return null;
      const panner=ac.createPanner();
      panner.panningModel='HRTF';
      panner.distanceModel='inverse';
      panner.refDistance=1; panner.maxDistance=20;
      panner.positionX.value=x; panner.positionY.value=y; panner.positionZ.value=z;
      panner.connect(ac.destination);
      panners[id]=panner;
      return panner;
    },
    moveSource(id,x,y,z){
      if(!panners[id])return;
      const p=panners[id];
      const t=p.context.currentTime;
      p.positionX.linearRampToValueAtTime(x,t+0.1);
      p.positionY.linearRampToValueAtTime(y,t+0.1);
      p.positionZ.linearRampToValueAtTime(z,t+0.1);
    },
    // Sephirot positions mapped to 3D audio
    playSephirot(index){
      const positions=[[0,5,0],[-1,4,0],[1,4,0],[-2,3,0],[2,3,0],[0,2,0],[-1,1,0],[1,1,0],[0,0,0],[0,-1,0]];
      const pos=positions[index]||[0,0,0];
      const id='seph-'+index;
      const panner=this.createSource(id,...pos);
      if(!panner)return;
      const ac=GranularEngine.getContext();
      if(!ac)return;
      const osc=ac.createOscillator();
      const gain=ac.createGain();
      const freqs=[396,528,432,417,285,528,639,741,852,174];
      osc.frequency.value=freqs[index]||432;
      osc.type='sine';
      gain.gain.setValueAtTime(0,ac.currentTime);
      gain.gain.linearRampToValueAtTime(0.1,ac.currentTime+0.05);
      gain.gain.linearRampToValueAtTime(0,ac.currentTime+0.8);
      osc.connect(gain); gain.connect(panner);
      osc.start(); osc.stop(ac.currentTime+0.8);
    }
  };
})();

// Extend GranularEngine with getContext helper
GranularEngine.getContext = function(){
  return this._ctx || null;
};
// Store context reference when initialized
const _origGranularInit=GranularEngine.toggle;

// ═══════════════════════════════════════════════════════════════════════
// PAPER 5: PROCEDURAL SOUND — Farnell 2010
// Fluid sound from pressure + PID oscillator
// ═══════════════════════════════════════════════════════════════════════
const ProceduralSound = (() => {
  let ctx=null, pidOsc=null, pidGain=null, fluidOsc=null, fluidGain=null;

  function getCtx(){
    if(!ctx){
      try{ctx=new(window.AudioContext||window.webkitAudioContext)();}catch(e){return null;}
    }
    return ctx;
  }

  return {
    initPID(){
      const ac=getCtx(); if(!ac)return;
      if(pidOsc){try{pidOsc.stop();}catch(e){}} 
      pidOsc=ac.createOscillator();
      pidGain=ac.createGain();
      const filter=ac.createBiquadFilter();
      filter.type='lowpass'; filter.frequency.value=1200;
      pidOsc.type='sine'; pidOsc.frequency.value=440;
      pidGain.gain.value=0;
      pidOsc.connect(filter); filter.connect(pidGain); pidGain.connect(ac.destination);
      pidOsc.start();
    },
    updatePID(error){
      const ac=getCtx(); if(!ac||!pidOsc)return;
      const freq=220+Math.abs(error)*1200;
      const vol=Math.abs(error)*0.08;
      pidOsc.frequency.linearRampToValueAtTime(freq,ac.currentTime+0.05);
      pidGain.gain.linearRampToValueAtTime(vol,ac.currentTime+0.05);
    },
    initFluid(){
      const ac=getCtx(); if(!ac)return;
      if(fluidOsc){try{fluidOsc.stop();}catch(e){}}
      fluidOsc=ac.createOscillator();
      fluidGain=ac.createGain();
      const filter=ac.createBiquadFilter();
      filter.type='bandpass'; filter.frequency.value=300; filter.Q.value=8;
      fluidOsc.type='sawtooth'; fluidOsc.frequency.value=80;
      fluidGain.gain.value=0;
      fluidOsc.connect(filter); filter.connect(fluidGain); fluidGain.connect(ac.destination);
      fluidOsc.start();
    },
    updateFluid(density,velocity){
      const ac=getCtx(); if(!ac||!fluidOsc)return;
      const freq=60+density*200+velocity*50;
      const vol=Math.min(0.1,density*0.08+velocity*0.03);
      fluidOsc.frequency.linearRampToValueAtTime(freq,ac.currentTime+0.1);
      fluidGain.gain.linearRampToValueAtTime(vol,ac.currentTime+0.1);
    },
    stop(){
      if(pidGain)pidGain.gain.linearRampToValueAtTime(0,(ctx?.currentTime||0)+0.1);
      if(fluidGain)fluidGain.gain.linearRampToValueAtTime(0,(ctx?.currentTime||0)+0.1);
    }
  };
})();

// ═══════════════════════════════════════════════════════════════════════
// PAPER 18: PROCEDURAL TAROT ART — Gatys et al. 2016 (canvas-based)
// Generative art for tarot cards via canvas noise patterns
// ═══════════════════════════════════════════════════════════════════════
const ProceduralTarot = (() => {
  const CARD_STYLES={
    hermes: {bg:'#0d0520',stroke:'#9b59b6',glow:'#7d3c98',pattern:'spiral'},
    rasa:   {bg:'#150505',stroke:'#e74c3c',glow:'#c0392b',pattern:'flame'},
    tao:    {bg:'#051505',stroke:'#27ae60',glow:'#1e8449',pattern:'ripple'},
    jabir:  {bg:'#150d05',stroke:'#e67e22',glow:'#ca6f1e',pattern:'crystal'},
    catedral:{bg:'#050f15',stroke:'#2980b9',glow:'#1a5276',pattern:'arch'},
    default:{bg:'#0d0d14',stroke:'#c8962a',glow:'#7a5a18',pattern:'star'},
  };

  function drawArt(canvas, tradition, cardName, seed){
    const W=canvas.width||100, H=canvas.height||150;
    const ctx=canvas.getContext('2d');
    const style=CARD_STYLES[tradition]||CARD_STYLES.default;
    // Background
    ctx.fillStyle=style.bg; ctx.fillRect(0,0,W,H);
    // Seeded random
    let rng=seed;
    function rand(){rng=((rng*1664525+1013904223)>>>0);return rng/0xffffffff;}

    // Pattern overlay
    ctx.strokeStyle=style.stroke; ctx.lineWidth=0.5;
    ctx.globalAlpha=0.3;
    switch(style.pattern){
      case 'spiral':
        for(let i=0;i<80;i++){
          const a=i*0.4,r=i*1.5;
          const x=W/2+Math.cos(a)*r,y=H/2+Math.sin(a)*r;
          ctx.beginPath(); ctx.arc(x,y,0.8,0,Math.PI*2); ctx.stroke();
        }
        break;
      case 'flame':
        for(let i=0;i<12;i++){
          ctx.beginPath();
          ctx.moveTo(rand()*W,H);
          ctx.bezierCurveTo(rand()*W,H*0.7,rand()*W,H*0.3,rand()*W,0);
          ctx.stroke();
        }
        break;
      case 'ripple':
        for(let r=10;r<Math.min(W,H)*0.7;r+=12){
          ctx.beginPath(); ctx.arc(W/2,H*0.45,r,0,Math.PI*2); ctx.stroke();
        }
        break;
      case 'crystal':
        for(let i=0;i<8;i++){
          const a=i/8*Math.PI*2;
          ctx.beginPath();
          ctx.moveTo(W/2,H/2);
          ctx.lineTo(W/2+Math.cos(a)*W*0.4,H/2+Math.sin(a)*H*0.4);
          ctx.stroke();
        }
        break;
      case 'arch':
        for(let y=0;y<H;y+=20){
          ctx.beginPath();
          ctx.arc(W/2,y,W/2,0,Math.PI);
          ctx.stroke();
        }
        break;
      default: // star
        for(let i=0;i<20;i++){
          const x=rand()*W,y=rand()*H,s=rand()*3+1;
          ctx.beginPath(); ctx.arc(x,y,s,0,Math.PI*2); ctx.fill();
        }
    }
    ctx.globalAlpha=1;

    // Glyph center
    const glyphs=['⊕','⊗','☽','✦','◈','⟁','∞','⊞','△','⬡'];
    const glyph=glyphs[seed%glyphs.length];
    ctx.fillStyle=style.glow;
    ctx.shadowBlur=12; ctx.shadowColor=style.glow;
    ctx.font=`bold ${Math.min(W,H)*0.25}px Cinzel,serif`;
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(glyph,W/2,H*0.38);
    ctx.shadowBlur=0;

    // Card name
    ctx.fillStyle=style.stroke;
    ctx.font=`${Math.max(8,W*0.1)}px 'Share Tech Mono',monospace`;
    ctx.fillText(cardName.toUpperCase().slice(0,8),W/2,H*0.82);

    // Border
    ctx.strokeStyle=style.stroke;
    ctx.lineWidth=1; ctx.globalAlpha=0.5;
    ctx.strokeRect(2,2,W-4,H-4);
    ctx.globalAlpha=1;
  }

  return {
    // Call after tarot module renders
    paintAllCards(){
      const tradition=OraculvmCore.getDominantTradition();
      const cards=document.querySelectorAll('.tarot-card');
      cards.forEach((card,i)=>{
        let canvas=card.querySelector('canvas');
        if(!canvas){
          // Create canvas overlay over glyph
          canvas=document.createElement('canvas');
          canvas.width=80; canvas.height=120;
          canvas.style.cssText='position:absolute;inset:0;width:100%;height:100%;opacity:0;transition:opacity 0.4s';
          card.appendChild(canvas);
        }
        const name=card.querySelector('.tarot-name')?.textContent||'ARCANO';
        drawArt(canvas,tradition,name,1310+i);
        setTimeout(()=>{canvas.style.opacity='0.85';},i*60);
      });
    },
    paintCanvas(canvas,tradition,name,seed){
      drawArt(canvas,tradition,name,seed||1310);
    }
  };
})();

// ═══════════════════════════════════════════════════════════════════════
// PAPER 16: WEBGPU ENHANCED FLUID — Wenzel 2023 (with SPH fallback)
// ═══════════════════════════════════════════════════════════════════════
const WebGPUFluid = (() => {
  let device=null, pipeline=null, buffers={}, supported=false;
  return {
    async init(){
      if(!navigator.gpu){supported=false;return false;}
      try{
        const adapter=await navigator.gpu.requestAdapter();
        if(!adapter){supported=false;return false;}
        device=await adapter.requestDevice();
        supported=true;
        console.log('[WebGPU] Device acquired · Papers 1+16');
        return true;
      }catch(e){supported=false;return false;}
    },
    isSupported(){return supported;},
    // Compute shader WGSL for SPH (simplified)
    getSPHShader(){return`
      struct Particle { pos:vec2<f32>, vel:vec2<f32>, density:f32, pressure:f32 }
      @group(0) @binding(0) var<storage,read> particles_in: array<Particle>;
      @group(0) @binding(1) var<storage,read_write> particles_out: array<Particle>;
      const H:f32 = 0.05;
      const REST_DENSITY:f32 = 1000.0;
      const K:f32 = 200.0;
      const VISC:f32 = 0.9;
      const DT:f32 = 0.002;
      @compute @workgroup_size(64)
      fn main(@builtin(global_invocation_id) gid: vec3<u32>){
        let i=gid.x;
        if(i>=arrayLength(&particles_in)){return;}
        var p=particles_in[i];
        // Simple Euler integration
        p.vel.y -= 9.8*DT;
        p.pos += p.vel*DT;
        if(p.pos.y<0.0){p.pos.y=0.0;p.vel.y*=-0.5;}
        if(p.pos.x<0.0){p.pos.x=0.0;p.vel.x*=-0.5;}
        if(p.pos.x>1.0){p.pos.x=1.0;p.vel.x*=-0.5;}
        particles_out[i]=p;
      }`;
    }
  };
})();

// ═══════════════════════════════════════════════════════════════════════
// SILENCE MODULE — Paper 13 microphone integration
// ═══════════════════════════════════════════════════════════════════════
// Extend silence logic to use microphone
(function extendSilence(){
  const origStart=ModuleLogic.silence.start;
  ModuleLogic.silence.start=async function(){
    // Request microphone
    const micEl=document.getElementById('mic-indicator');
    if(micEl&&navigator.mediaDevices){
      const got=await MicrophoneMonitor.request();
      if(got&&micEl){
        micEl.innerHTML='<div class="mic-dot"></div><span id="mic-label">escuchando...</span>';
      }
    }
    origStart.call(this);
  };
  const origTick=ModuleLogic.silence.start; // we'll hook via the loop
})();

// ═══════════════════════════════════════════════════════════════════════
// PAPER 14: DDA HOOK — Feed KalmanDDA on wisdom updates
// ═══════════════════════════════════════════════════════════════════════
EventBus.on('wisdom_updated',(W)=>{
  // Feed DDA from wisdom changes
  ['hermes','rasa','tao','jabir','catedral'].forEach(t=>{
    if(W[t]>0.01) KalmanDDA.onWisdomGain(t,W[t]);
  });
  // Update DDA display if sidebar has it
  const ddaEl=document.getElementById('dda-difficulty');
  if(ddaEl)ddaEl.textContent=KalmanDDA.getDifficulty();
});

// ═══════════════════════════════════════════════════════════════════════
// PAPER 5: PID SONIFICATION — hook into Tao module
// ═══════════════════════════════════════════════════════════════════════
(function hookPIDSound(){
  const origYin=ModuleLogic.tao.pushYin;
  const origYang=ModuleLogic.tao.pushYang;
  ModuleLogic.tao.pushYin=function(){
    origYin.call(this);
    const err=Math.abs(this.balance-0.5);
    ProceduralSound.updatePID(err);
  };
  ModuleLogic.tao.pushYang=function(){
    origYang.call(this);
    const err=Math.abs(this.balance-0.5);
    ProceduralSound.updatePID(err);
  };
})();

// ═══════════════════════════════════════════════════════════════════════
// PAPER 5: FLUID SOUND — hook into fluid simulation
// ═══════════════════════════════════════════════════════════════════════
(function hookFluidSound(){
  const origFluidInit=ModuleLogic.fluid.init;
  ModuleLogic.fluid.init=function(){
    origFluidInit.call(this);
    ProceduralSound.initFluid();
  };
  const origFluidDestroy=ModuleLogic.fluid.destroy;
  ModuleLogic.fluid.destroy=function(){
    if(origFluidDestroy)origFluidDestroy.call(this);
    ProceduralSound.stop();
  };
})();

// ═══════════════════════════════════════════════════════════════════════
// PAPER 18: TAROT ART — hook into tarot module init
// ═══════════════════════════════════════════════════════════════════════
(function hookTarotArt(){
  const origTarotInit=ModuleLogic.tarot.init;
  if(origTarotInit){
    ModuleLogic.tarot.init=function(){
      origTarotInit.call(this);
      setTimeout(()=>ProceduralTarot.paintAllCards(),100);
    };
  }
  const origDraw=ModuleLogic.tarot.draw;
  if(origDraw){
    ModuleLogic.tarot.draw=function(){
      origDraw.call(this);
      setTimeout(()=>ProceduralTarot.paintAllCards(),50);
    };
  }
})();

// ═══════════════════════════════════════════════════════════════════════
// MODULE IV NAVIGATE HOOK — init Three.js tree
// ═══════════════════════════════════════════════════════════════════════
(function hookTree3D(){
  const origNavigate=Game.navigate.bind(Game);
  Game.navigate=function(moduleId){
    // Destroy previous Three.js scene if switching away from module IV
    if(this.currentModule===3&&moduleId!==3){
      ModuleLogic.tree3d.destroy();
    }
    origNavigate(moduleId);
    if(moduleId===3){
      setTimeout(()=>{
        if(window.THREE) ModuleLogic.tree3d.init();
        else console.warn('[Tree3D] Three.js not loaded');
      },100);
    }
    if(moduleId===12){
      setTimeout(()=>ProceduralSound.initPID(),200);
    }
  };
})();

// Extend OraculvmCore with helpers used above
OraculvmCore.getDominantTradition=function(){
  const W=this.getWisdom();
  return ['hermes','rasa','tao','jabir','catedral'].reduce((a,b)=>W[b]>W[a]?b:a,'hermes');
};
OraculvmCore.getCompletedCount=function(){
  return Object.values(MODULES).filter(m=>m.completed).length;
};

window.addEventListener('DOMContentLoaded', ()=>{
  OraculvmCore.setStatus('ORACULVM v1310 · LISTO');
  MouseEmotionDetector.init();
  const viz = document.getElementById('audio-viz');
  if(viz) viz.innerHTML = Array(8).fill(0).map((_,i)=>`<div class="audio-bar" id="avbar-${i}" style="height:4px"></div>`).join('');
  WisdomParticles.init();
  AtmosphereEngine.init();
  const pCanvas=document.getElementById('particle-canvas');
  if(pCanvas){pCanvas.width=window.innerWidth;pCanvas.height=window.innerHeight;}
  setTimeout(()=>AtmosphereEngine.set('catedral'),500);

  // ─── v4: INIT ALL NEW SYSTEMS ───
  A11ySystem.init();

  // WebGPU probe (Papers 1+16)
  WebGPUFluid.init().then(ok=>{
    if(ok){
      OraculvmCore.setStatus('ORACULVM v1310 · WebGPU ACTIVO ✦');
      console.log('[v4] WebGPU acquired — compute shaders ready');
    } else {
      console.log('[v4] WebGPU unavailable — CPU SPH fallback active');
    }
  });

  // Resize handler
  window.addEventListener('resize',()=>{
    if(pCanvas){pCanvas.width=window.innerWidth;pCanvas.height=window.innerHeight;}
    const tc=document.getElementById('threejs-tree-canvas');
    if(tc&&ModuleLogic.tree3d.renderer){
      ModuleLogic.tree3d.renderer.setSize(tc.offsetWidth,tc.offsetHeight);
      if(ModuleLogic.tree3d.camera){
        ModuleLogic.tree3d.camera.aspect=tc.offsetWidth/tc.offsetHeight;
        ModuleLogic.tree3d.camera.updateProjectionMatrix();
      }
    }
  });

  // Paper 14: DDA difficulty indicator in sidebar
  const sidebar=document.getElementById('sidebar');
  if(sidebar){
    const ddaDiv=document.createElement('div');
    ddaDiv.style.cssText='padding:6px 12px;border-top:1px solid rgba(200,150,42,0.08);font-family:var(--font-mono);font-size:9px;color:var(--mist);flex-shrink:0';
    ddaDiv.innerHTML='DDA: <span id="dda-difficulty" style="color:var(--amber)">FLUJO</span> · <span style="color:var(--mist)">Hunicke 2005</span>';
    sidebar.appendChild(ddaDiv);
  }
});
</script>
</body>
</html>

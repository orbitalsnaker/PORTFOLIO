<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LEXICÓN Ω — CÁTEDRA TOTAL v2.0 — SISTEMA GENERATIVO VIVO</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IM+Fell+English+SC&family=IM+Fell+English:ital@0;1&family=Courier+Prime:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --void: #08060a;
  --parchment: #c8b47a;
  --parchment-dim: #7a6a44;
  --blood: #7a0000;
  --blood-bright: #b50000;
  --acid: #b8ff00;
  --matrix: #00ff5a;
  --matrix-dim: #004f1c;
  --folio-bg: #0e0b08;
  --folio-border: #2a2010;
  --mercury: #ccc4b8;
  --ash: #555040;
  --ink: #1a1408;
  --shadow-gold: rgba(200,180,122,0.08);
  --cyan: #00d4ff;
  --cyan-dim: #003f4f;
  --violet: #8800ff;
  --violet-dim: #2a0050;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  background-color: var(--void);
  background-image:
    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='4' height='4'%3E%3Crect width='4' height='4' fill='%23080608'/%3E%3Crect x='0' y='0' width='1' height='1' fill='%230f0c10' opacity='0.6'/%3E%3Crect x='2' y='2' width='1' height='1' fill='%230f0c10' opacity='0.3'/%3E%3C/svg%3E"),
    radial-gradient(ellipse at 20% 0%, #1a0a00 0%, transparent 60%),
    radial-gradient(ellipse at 80% 100%, #000718 0%, transparent 60%);
  color: var(--mercury);
  font-family: 'Courier Prime', monospace;
  font-size: 12px;
  min-height: 100vh;
  overflow-x: hidden;
}
body::before {
  content: '';
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: repeating-linear-gradient(
    0deg, transparent, transparent 3px,
    rgba(0,0,0,0.18) 3px, rgba(0,0,0,0.18) 4px
  );
  pointer-events: none; z-index: 1000;
}
.codex { max-width: 1360px; margin: 0 auto; padding: 30px 20px 60px; position: relative; }

/* ─── HEADER ─── */
.header-outer {
  border: 2px solid var(--parchment-dim);
  border-top: 8px double var(--parchment);
  border-bottom: 8px double var(--parchment);
  padding: 40px 50px;
  margin-bottom: 0;
  background: linear-gradient(180deg, rgba(26,14,0,0.98) 0%, rgba(14,11,8,0.99) 100%);
  position: relative; overflow: hidden;
}
.header-outer::after {
  content: '';
  position: absolute; top: -2px; left: 50%; transform: translateX(-50%);
  width: 80%; height: 2px;
  background: linear-gradient(90deg, transparent, var(--parchment), transparent);
}
.sigil-row {
  text-align: center; font-size: 10px; color: var(--ash);
  letter-spacing: 6px; margin-bottom: 20px; text-transform: uppercase;
}
h1.titulo-magno {
  font-family: 'IM Fell English SC', serif;
  font-size: clamp(1.6rem, 4vw, 3.2rem);
  color: var(--parchment);
  text-align: center;
  text-shadow: 0 0 40px rgba(200,180,122,0.3), 0 2px 4px rgba(0,0,0,0.9);
  letter-spacing: 3px; line-height: 1.2; margin-bottom: 10px;
}
h2.subtitulo {
  font-family: 'IM Fell English', serif; font-style: italic;
  text-align: center; color: var(--blood-bright);
  font-size: 1rem; letter-spacing: 2px; margin-bottom: 25px;
}
.yaml-header {
  background: #000; border: 1px dashed var(--matrix-dim);
  color: var(--matrix); font-family: 'Courier Prime', monospace;
  font-size: 10px; padding: 12px 18px; margin: 20px auto;
  max-width: 700px; white-space: pre; line-height: 1.6;
}
.counter-strip {
  display: flex; justify-content: space-between; align-items: center;
  background: var(--blood); padding: 8px 20px; margin-top: 20px;
  border: 1px solid #3a0000; font-size: 11px; font-weight: bold;
  text-transform: uppercase; letter-spacing: 2px;
}
.counter-num { font-family: 'IM Fell English SC', serif; font-size: 1.1rem; color: var(--parchment); }

/* ─── MODE SWITCHER ─── */
.mode-switcher {
  display: flex; gap: 0; margin: 0;
  border-left: 2px solid var(--parchment-dim);
  border-right: 2px solid var(--parchment-dim);
  border-bottom: 2px solid var(--parchment-dim);
  background: #05040a;
}
.mode-btn {
  flex: 1; padding: 12px 8px;
  background: none; border: none; border-right: 1px solid var(--ash);
  color: var(--ash); font-family: 'IM Fell English SC', serif;
  font-size: 11px; letter-spacing: 2px; cursor: pointer;
  transition: all 0.2s; text-transform: uppercase;
}
.mode-btn:last-child { border-right: none; }
.mode-btn:hover { color: var(--parchment); background: var(--ink); }
.mode-btn.active {
  background: var(--blood); color: var(--parchment);
  border-bottom: 2px solid var(--parchment);
}

/* ─── PANELS ─── */
.panel { display: none; margin-top: 20px; }
.panel.active { display: block; }

/* ─── CORPUS PANEL ─── */
.controls {
  display: flex; gap: 12px; margin-bottom: 20px;
  flex-wrap: wrap; align-items: center;
}
.search-box {
  flex: 1; min-width: 200px; background: var(--folio-bg);
  border: 1px solid var(--ash); border-bottom: 2px solid var(--parchment-dim);
  color: var(--mercury); padding: 9px 14px;
  font-family: 'Courier Prime', monospace; font-size: 11px; outline: none;
  transition: border-color 0.2s;
}
.search-box:focus { border-bottom-color: var(--parchment); }
.search-box::placeholder { color: var(--ash); }
.filter-select {
  background: var(--folio-bg); border: 1px solid var(--ash);
  border-bottom: 2px solid var(--parchment-dim); color: var(--mercury);
  padding: 9px 14px; font-family: 'Courier Prime', monospace;
  font-size: 11px; cursor: pointer; outline: none;
}
.btn-random {
  background: var(--blood); border: 1px solid var(--blood-bright);
  color: var(--parchment); padding: 9px 18px;
  font-family: 'IM Fell English SC', serif; font-size: 12px;
  letter-spacing: 2px; cursor: pointer;
  transition: background 0.2s, box-shadow 0.2s;
}
.btn-random:hover { background: var(--blood-bright); box-shadow: 0 0 20px rgba(181,0,0,0.5); }
.entries-container {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
  gap: 2px; padding: 2px;
  border: 1px solid var(--folio-border);
  border-top: 3px double var(--parchment-dim);
  border-bottom: 3px double var(--parchment-dim);
  background: var(--folio-bg); max-height: 700px; overflow-y: auto;
}
.entries-container::-webkit-scrollbar { width: 8px; }
.entries-container::-webkit-scrollbar-track { background: #060505; }
.entries-container::-webkit-scrollbar-thumb { background: var(--blood); border: 1px solid var(--blood-bright); }
.entry {
  border: 1px solid var(--folio-border); border-top: 2px solid;
  padding: 14px 16px 10px; background: var(--folio-bg);
  position: relative; transition: border-color 0.15s, box-shadow 0.15s; cursor: default;
}
.entry:hover { box-shadow: 0 0 18px rgba(200,180,122,0.08); z-index: 2; }
.entry-gold  { border-top-color: var(--parchment); }
.entry-blood { border-top-color: var(--blood-bright); }
.entry-acid  { border-top-color: var(--acid); }
.entry-matrix{ border-top-color: var(--matrix); }
.folio-num { position: absolute; top: 6px; right: 10px; font-size: 9px; color: var(--ash); letter-spacing: 1px; }
.term { font-family: 'IM Fell English SC', serif; color: var(--parchment); font-size: 1.05rem; display: block; margin-bottom: 6px; line-height: 1.2; }
.def { color: #9a8e7a; line-height: 1.6; font-style: italic; font-size: 11px; margin-bottom: 8px; }
.metadata { border-top: 1px solid var(--folio-border); padding-top: 6px; font-size: 9.5px; line-height: 1.5; }
.meta-line { display: block; color: var(--matrix-dim); }
.meta-line.highlight { color: var(--matrix); }
.meta-line.author { color: var(--parchment-dim); }

/* ─── PAGINATION ─── */
.pagination { display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 20px; flex-wrap: wrap; }
.page-info { font-size: 11px; color: var(--ash); letter-spacing: 1px; text-align: center; margin-top: 10px; }
.page-btn {
  background: var(--ink); border: 1px solid var(--ash); color: var(--mercury);
  padding: 6px 12px; font-family: 'Courier Prime', monospace; font-size: 11px;
  cursor: pointer; transition: all 0.15s; letter-spacing: 1px;
}
.page-btn:hover, .page-btn.active { background: var(--blood); border-color: var(--blood-bright); color: var(--parchment); }
.page-input {
  background: var(--ink); border: 1px solid var(--ash); color: var(--mercury);
  padding: 6px 10px; width: 80px; font-family: 'Courier Prime', monospace;
  font-size: 11px; text-align: center; outline: none;
}

/* ─── GENESIS PANEL ─── */
.genesis-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
@media(max-width:700px) { .genesis-grid { grid-template-columns: 1fr; } }
.panel-box {
  background: var(--folio-bg); border: 1px solid var(--folio-border);
  border-top: 3px solid var(--parchment-dim); padding: 20px;
}
.panel-box h3 {
  font-family: 'IM Fell English SC', serif; color: var(--parchment);
  font-size: 0.9rem; letter-spacing: 3px; margin-bottom: 16px;
  text-transform: uppercase; border-bottom: 1px solid var(--ash); padding-bottom: 8px;
}
.slider-row { margin-bottom: 14px; }
.slider-label { font-size: 10px; color: var(--parchment-dim); letter-spacing: 2px; margin-bottom: 4px; text-transform: uppercase; display: flex; justify-content: space-between; }
.slider-val { color: var(--acid); }
input[type=range] {
  width: 100%; height: 4px; appearance: none;
  background: linear-gradient(90deg, var(--blood) 0%, var(--parchment) 100%);
  border-radius: 0; outline: none; cursor: pointer;
}
input[type=range]::-webkit-slider-thumb {
  appearance: none; width: 14px; height: 14px;
  background: var(--parchment); border: 2px solid var(--blood-bright); cursor: pointer;
}
.btn-generate {
  width: 100%; padding: 14px; margin-top: 10px;
  background: var(--blood); border: 2px solid var(--blood-bright);
  color: var(--parchment); font-family: 'IM Fell English SC', serif;
  font-size: 14px; letter-spacing: 4px; cursor: pointer;
  transition: all 0.2s; text-transform: uppercase;
}
.btn-generate:hover { background: var(--blood-bright); box-shadow: 0 0 30px rgba(181,0,0,0.6); }
.btn-generate:active { transform: scale(0.98); }
.generated-output {
  background: #050308; border: 1px solid var(--parchment-dim);
  padding: 20px; margin-top: 16px; min-height: 120px; position: relative;
}
.gen-sentence {
  font-family: 'IM Fell English', serif; font-style: italic;
  color: var(--parchment); font-size: 1.1rem; line-height: 1.8;
}
.gen-meta {
  margin-top: 12px; font-size: 9px; color: var(--matrix-dim);
  border-top: 1px dashed var(--folio-border); padding-top: 8px; line-height: 1.8;
}
.gen-meta span { color: var(--matrix); }
.quality-bar { display: flex; gap: 16px; margin-top: 10px; }
.q-metric { flex: 1; }
.q-label { font-size: 9px; color: var(--ash); text-transform: uppercase; letter-spacing: 1px; }
.q-value { font-size: 18px; font-family: 'IM Fell English SC', serif; }
.q-good { color: var(--matrix); }
.q-mid  { color: var(--acid); }
.q-bad  { color: var(--blood-bright); }

/* ─── AGENTS PANEL ─── */
.agents-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 12px; margin-bottom: 20px; }
.agent-card {
  background: var(--folio-bg); border: 1px solid var(--folio-border);
  padding: 16px; cursor: pointer; transition: all 0.2s;
  border-top: 3px solid transparent;
}
.agent-card:hover { border-color: var(--parchment-dim); transform: translateY(-1px); }
.agent-card.selected { border-top-color: var(--parchment); box-shadow: 0 0 20px rgba(200,180,122,0.15); }
.agent-name { font-family: 'IM Fell English SC', serif; color: var(--parchment); font-size: 1rem; margin-bottom: 4px; }
.agent-tradition { font-size: 9px; color: var(--blood-bright); letter-spacing: 2px; margin-bottom: 10px; }
.agent-vec { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
.agent-dim { font-size: 9px; color: var(--ash); }
.agent-dim span { color: var(--acid); float: right; }
.agent-memory-count { font-size: 9px; color: var(--matrix-dim); margin-top: 8px; }

.hybrid-panel {
  background: var(--folio-bg); border: 1px dashed var(--parchment-dim);
  padding: 16px; margin-bottom: 16px;
}
.hybrid-label { font-size: 10px; color: var(--parchment-dim); letter-spacing: 2px; margin-bottom: 8px; }
.hybrid-agents { display: flex; gap: 12px; align-items: center; }
.hybrid-select {
  background: var(--ink); border: 1px solid var(--ash); color: var(--mercury);
  padding: 8px 12px; font-family: 'Courier Prime', monospace; font-size: 11px; outline: none;
}
.hybrid-x { color: var(--parchment); font-size: 1.4rem; font-family: serif; }
.btn-hybrid {
  padding: 9px 20px; background: var(--violet-dim);
  border: 1px solid var(--violet); color: var(--mercury);
  font-family: 'Courier Prime', monospace; font-size: 11px; cursor: pointer;
  transition: all 0.2s; letter-spacing: 2px;
}
.btn-hybrid:hover { background: var(--violet); }

/* ─── DIALOGUE PANEL ─── */
.dialogue-layout { display: grid; grid-template-columns: 220px 1fr; gap: 16px; }
@media(max-width:700px) { .dialogue-layout { grid-template-columns: 1fr; } }
.agent-sidebar { background: var(--folio-bg); border: 1px solid var(--folio-border); padding: 16px; }
.agent-sidebar h3 { font-family: 'IM Fell English SC', serif; color: var(--parchment); font-size: 0.85rem; letter-spacing: 2px; margin-bottom: 12px; }
.agent-choice {
  display: block; width: 100%; padding: 10px 12px; margin-bottom: 6px;
  background: var(--ink); border: 1px solid var(--ash);
  color: var(--mercury); font-family: 'Courier Prime', monospace; font-size: 11px;
  cursor: pointer; transition: all 0.2s; text-align: left;
}
.agent-choice:hover { background: var(--blood); border-color: var(--blood-bright); color: var(--parchment); }
.agent-choice.active { background: var(--blood); border-color: var(--blood-bright); color: var(--parchment); }
.agent-portrait {
  margin-top: 12px; padding: 10px; background: #050308;
  border: 1px dashed var(--parchment-dim); font-size: 9px; color: var(--parchment-dim); line-height: 1.7;
}

.chat-area {
  display: flex; flex-direction: column;
  background: var(--folio-bg); border: 1px solid var(--folio-border);
  height: 500px;
}
.chat-log {
  flex: 1; overflow-y: auto; padding: 16px; gap: 14px; display: flex; flex-direction: column;
}
.chat-log::-webkit-scrollbar { width: 6px; }
.chat-log::-webkit-scrollbar-thumb { background: var(--blood); }
.chat-bubble {
  max-width: 85%; padding: 12px 16px;
  border: 1px solid; font-family: 'IM Fell English', serif; font-size: 0.9rem;
  line-height: 1.7; position: relative;
}
.bubble-user {
  align-self: flex-end;
  background: var(--ink); border-color: var(--ash); color: var(--mercury);
  font-family: 'Courier Prime', monospace; font-size: 11px; font-style: normal;
}
.bubble-agent {
  align-self: flex-start;
  background: #050308; border-color: var(--parchment-dim); color: var(--parchment);
  font-style: italic;
}
.bubble-source { font-size: 9px; color: var(--ash); margin-top: 6px; font-style: normal; font-family: 'Courier Prime', monospace; }
.chat-input-row {
  display: flex; border-top: 1px solid var(--folio-border); padding: 10px;
  gap: 8px;
}
.chat-input {
  flex: 1; background: var(--ink); border: 1px solid var(--ash);
  color: var(--mercury); padding: 10px 14px;
  font-family: 'Courier Prime', monospace; font-size: 11px; outline: none;
}
.chat-input:focus { border-color: var(--parchment-dim); }
.btn-send {
  padding: 10px 20px; background: var(--blood); border: 1px solid var(--blood-bright);
  color: var(--parchment); font-family: 'IM Fell English SC', serif;
  font-size: 12px; cursor: pointer; letter-spacing: 2px;
  transition: background 0.2s;
}
.btn-send:hover { background: var(--blood-bright); }

/* ─── LEGAL PANEL ─── */
.legal-header {
  background: #050010; border: 2px double var(--violet);
  padding: 20px; margin-bottom: 16px; text-align: center;
}
.legal-header h3 { font-family: 'IM Fell English SC', serif; color: var(--violet); font-size: 1.3rem; letter-spacing: 4px; }
.legal-header p { font-size: 9px; color: #6644aa; margin-top: 6px; letter-spacing: 2px; }
.legal-controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 16px; align-items: center; }
.btn-legal {
  padding: 9px 16px; background: var(--violet-dim); border: 1px solid var(--violet);
  color: var(--mercury); font-family: 'Courier Prime', monospace; font-size: 11px;
  cursor: pointer; transition: all 0.2s; letter-spacing: 1px;
}
.btn-legal:hover { background: var(--violet); color: white; }
.legal-articles {
  background: var(--folio-bg); border: 1px solid var(--folio-border);
  max-height: 500px; overflow-y: auto;
}
.legal-articles::-webkit-scrollbar { width: 6px; }
.legal-articles::-webkit-scrollbar-thumb { background: var(--violet); }
.article-item {
  border-bottom: 1px solid var(--folio-border); padding: 14px 18px;
  display: grid; grid-template-columns: 80px 1fr; gap: 12px;
  transition: background 0.15s;
}
.article-item:hover { background: #0a0515; }
.article-num { font-family: 'IM Fell English SC', serif; color: var(--violet); font-size: 0.9rem; }
.article-body { }
.article-title { color: var(--parchment); font-size: 10px; letter-spacing: 2px; margin-bottom: 4px; }
.article-text { color: #9a8e7a; font-style: italic; font-size: 11px; line-height: 1.6; }
.article-pena { font-size: 9px; color: var(--blood-bright); margin-top: 4px; letter-spacing: 1px; }

/* ─── ARCHITECTURE PANEL ─── */
.arch-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
@media(max-width:700px) { .arch-grid { grid-template-columns: 1fr; } }
.arch-module {
  background: var(--folio-bg); border: 1px solid var(--folio-border);
  border-left: 3px solid var(--cyan); padding: 16px; cursor: pointer;
  transition: all 0.2s;
}
.arch-module:hover { border-left-color: var(--parchment); background: #100d0a; }
.arch-module h4 { font-family: 'IM Fell English SC', serif; color: var(--cyan); font-size: 0.9rem; letter-spacing: 2px; margin-bottom: 6px; }
.arch-module .arch-desc { font-size: 10px; color: var(--ash); line-height: 1.6; }
.arch-module .arch-tech { font-size: 9px; color: var(--matrix-dim); margin-top: 8px; }
.arch-module .arch-status { font-size: 9px; float: right; padding: 2px 6px; background: #001a00; border: 1px solid var(--matrix-dim); color: var(--matrix); }
.arch-pipeline {
  background: #050308; border: 1px dashed var(--parchment-dim);
  padding: 20px; margin-bottom: 16px; font-family: 'Courier Prime', monospace;
  font-size: 11px; color: var(--parchment-dim); line-height: 2;
}
.arch-pipeline .p-step { color: var(--matrix); }
.arch-pipeline .p-arrow { color: var(--ash); }
.arch-pipeline .p-time { color: var(--acid); font-size: 9px; }

/* ─── PERSISTENCE STATUS ─── */
.persist-bar {
  display: flex; align-items: center; gap: 12px; padding: 8px 14px;
  background: #020408; border: 1px solid var(--cyan-dim);
  font-size: 9px; color: var(--ash); margin-bottom: 16px; letter-spacing: 1px;
}
.persist-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--matrix); animation: pulse 2s infinite; }
.persist-dot.offline { background: var(--blood-bright); animation: none; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }
.persist-info { color: var(--matrix-dim); }

/* ─── MODAL ─── */
.modal-overlay {
  display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.85); z-index: 2000;
  align-items: center; justify-content: center;
}
.modal-overlay.open { display: flex; }
.modal-box {
  background: var(--folio-bg); border: 2px double var(--parchment);
  max-width: 620px; width: 90%; padding: 36px 40px;
  position: relative; max-height: 80vh; overflow-y: auto;
}
.modal-close {
  position: absolute; top: 12px; right: 16px;
  background: none; border: none; color: var(--parchment-dim);
  font-size: 1.4rem; cursor: pointer; font-family: serif; transition: color 0.2s;
}
.modal-close:hover { color: var(--blood-bright); }
.modal-term { font-family: 'IM Fell English SC', serif; font-size: 1.6rem; color: var(--parchment); margin-bottom: 14px; border-bottom: 1px solid var(--ash); padding-bottom: 10px; }
.modal-def { font-family: 'IM Fell English', serif; font-style: italic; font-size: 1rem; color: var(--mercury); line-height: 1.8; margin-bottom: 20px; }
.modal-meta { font-size: 10px; color: var(--matrix); line-height: 2; }
.modal-meta span { color: var(--parchment-dim); }

/* ─── FOOTER ─── */
.footer-oracle {
  text-align: center; margin-top: 40px; padding-top: 20px;
  border-top: 2px double var(--parchment-dim);
  color: var(--blood-bright); font-family: 'IM Fell English', serif;
  font-style: italic; font-size: 0.85rem; letter-spacing: 1px; line-height: 2;
}
.footer-oracle strong { color: var(--parchment-dim); font-style: normal; font-family: 'IM Fell English SC', serif; letter-spacing: 3px; }

/* Typing animation */
@keyframes typing { 0%{opacity:0.3} 50%{opacity:1} 100%{opacity:0.3} }
.typing-indicator { color: var(--parchment-dim); font-style: normal; animation: typing 1.4s infinite; font-family: 'Courier Prime', monospace; font-size: 11px; }
</style>
</head>
<body>
<div class="codex">

  <!-- ═══ ENCABEZADO ═══ -->
  <div class="header-outer">
    <div class="sigil-row">✦ SISTEMA_GENERATIVO_VIVO ✦ PCG_OMEGA ✦ AGENTES_ACTIVOS ✦ CÓDIGO_PENAL_1310 ✦</div>
    <h1 class="titulo-magno">Memorial de Agravios<br>contra la Zafiedad Universal</h1>
    <h2 class="subtitulo">Onto-Lexicón Ω v2.0 · Sistema Generativo Total · ∞ Sentencias</h2>
    <div class="yaml-header">---
auditoria:      "Siglo de Oro / Desahucio Total / Cátedra V-666K"
director:       "Martínez_188cm"
protocolo:      "1310_Baskerville_Logic"
version:        "2.0 — Sistema Generativo Vivo"
motor_rng:      "PCG (Permuted Congruential Generator) — entropía alta"
generador:      "E-Graph + Reglas de Reescritura (131 transformaciones)"
agentes:        5
corpus_base:    666666
capacidad:      "∞ sentencias generables"
codigo_penal:   "1310 artículos combinatorios"
persistencia:   "IndexedDB — los agentes recuerdan"
status:         "CRÍTICA ANTICIPADA · RESUELTA · PROTOCOLO ACTIVO"
---</div>
    <div class="counter-strip">
      <span>ESTOCADA ROPERA ACTIVA</span>
      <span class="counter-num" id="liveCounter">0 / 666.666</span>
      <span>LOG_∞_GENERATIVAS</span>
    </div>
  </div>

  <!-- ═══ MODE SWITCHER ═══ -->
  <div class="mode-switcher">
    <button class="mode-btn active" onclick="switchMode('corpus')">I. Corpus</button>
    <button class="mode-btn" onclick="switchMode('genesis')">II. Génesis</button>
    <button class="mode-btn" onclick="switchMode('agentes')">III. Agentes</button>
    <button class="mode-btn" onclick="switchMode('dialogo')">IV. Diálogo</button>
    <button class="mode-btn" onclick="switchMode('derecho')">V. Derecho</button>
    <button class="mode-btn" onclick="switchMode('arquitectura')">VI. Arquitectura</button>
  </div>

  <!-- ─── PERSIST STATUS ─── -->
  <div class="persist-bar">
    <div class="persist-dot" id="persistDot"></div>
    <span class="persist-info" id="persistInfo">Inicializando IndexedDB...</span>
    <span style="margin-left:auto;color:var(--parchment-dim)" id="sessionInfo"></span>
  </div>

  <!-- ════════════════════════════════════
       PANEL I: CORPUS
       ════════════════════════════════════ -->
  <div class="panel active" id="panel-corpus">
    <div class="controls">
      <input class="search-box" id="searchBox" type="text" placeholder="Buscar bellaco, concepto, autor...">
      <select class="filter-select" id="tradFilter">
        <option value="">— Todas las tradiciones —</option>
        <option value="Siglo de Oro">Siglo de Oro</option>
        <option value="Filosofía Continental">Filosofía Continental</option>
        <option value="Filosofía Analítica">Filosofía Analítica</option>
        <option value="Filosofía Política">Filosofía Política</option>
        <option value="Escolástica">Escolástica</option>
        <option value="Filosofía Antigua">Filosofía Antigua</option>
        <option value="Semiótica">Semiótica</option>
        <option value="Filosofía Medieval">Filosofía Medieval</option>
      </select>
      <button class="btn-random" id="btnRandom">✦ Sentencia Aleatoria</button>
    </div>
    <div class="entries-container" id="entriesContainer"></div>
    <div class="pagination" id="paginationBar"></div>
    <div class="page-info" id="pageInfo"></div>
  </div>

  <!-- ════════════════════════════════════
       PANEL II: GÉNESIS (e-graph + PCG + sliders)
       ════════════════════════════════════ -->
  <div class="panel" id="panel-genesis">
    <div class="genesis-grid">
      <div>
        <div class="panel-box">
          <h3>✦ Parámetros de Generación</h3>
          <div class="slider-row">
            <div class="slider-label">Tradición <span class="slider-val" id="val-trad">Barroco</span></div>
            <input type="range" id="sl-trad" min="0" max="4" value="0" oninput="updateSliderLabel('trad',this.value)">
          </div>
          <div class="slider-row">
            <div class="slider-label">Tono <span class="slider-val" id="val-tono">Irónico</span></div>
            <input type="range" id="sl-tono" min="0" max="4" value="2" oninput="updateSliderLabel('tono',this.value)">
          </div>
          <div class="slider-row">
            <div class="slider-label">Longitud <span class="slider-val" id="val-long">Media</span></div>
            <input type="range" id="sl-long" min="0" max="4" value="2" oninput="updateSliderLabel('long',this.value)">
          </div>
          <div class="slider-row">
            <div class="slider-label">Temperatura PCG <span class="slider-val" id="val-temp">0.7</span></div>
            <input type="range" id="sl-temp" min="1" max="10" value="7" oninput="updateSliderLabel('temp',this.value)">
          </div>
          <div class="slider-row">
            <div class="slider-label">Iteraciones E-Graph <span class="slider-val" id="val-iter">40</span></div>
            <input type="range" id="sl-iter" min="5" max="131" value="40" oninput="updateSliderLabel('iter',this.value)">
          </div>
          <button class="btn-generate" onclick="generateSentence()">⟐ GENERAR NUEVA SENTENCIA ⟐</button>
          <button class="btn-generate" style="margin-top:8px;background:var(--matrix-dim);border-color:var(--matrix)" onclick="generateBatch()">⟐ GENERAR LOTE DE 5 ⟐</button>
        </div>
        <div class="panel-box" style="margin-top:16px">
          <h3>✦ Métricas de Calidad</h3>
          <div id="qualityMetrics">
            <div style="color:var(--ash);font-size:10px">Genera una sentencia para ver métricas...</div>
          </div>
        </div>
      </div>
      <div>
        <div class="panel-box" style="height:100%">
          <h3>✦ Salida del Generador</h3>
          <div id="genesisOutput">
            <div class="generated-output">
              <div style="color:var(--ash);font-size:11px;font-style:italic">
                El generador espera parámetros.<br>
                Ajusta los sliders y pulsa GENERAR.<br><br>
                <span style="color:var(--matrix-dim);font-size:9px">
                  Motor: PCG-XSH-RR 64bit<br>
                  Validador: E-Graph con reglas de reescritura<br>
                  Optimizador: búsqueda A* sobre coherencia semántica
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ════════════════════════════════════
       PANEL III: AGENTES
       ════════════════════════════════════ -->
  <div class="panel" id="panel-agentes">
    <div style="margin-bottom:16px">
      <div class="panel-box">
        <h3>✦ Los Cinco Agentes Conceptuales</h3>
        <p style="font-size:10px;color:var(--ash);margin-bottom:16px">Cada agente es un vector de personalidad [Austeridad, Ironía, Erudición, Barroquismo, Nihilismo] que genera sentencias y recuerda sus interacciones. Las relaciones entre agentes evolucionan.</p>
        <div class="agents-grid" id="agentsGrid"></div>
      </div>
    </div>
    <div class="panel-box">
      <h3>✦ Generación Híbrida Inter-Tradición</h3>
      <p style="font-size:10px;color:var(--ash);margin-bottom:12px">Selecciona dos agentes para generar una sentencia que combine sus tradiciones. El e-graph fusiona sus vectores de personalidad.</p>
      <div class="hybrid-panel">
        <div class="hybrid-label">AGENTE A × AGENTE B → HÍBRIDO</div>
        <div class="hybrid-agents">
          <select class="hybrid-select" id="hybridA">
            <option value="0">Agente Barroco</option>
            <option value="1">Agente Continental</option>
            <option value="2">Agente Analítico</option>
            <option value="3">Agente Escolástico</option>
            <option value="4">Agente Antiguo</option>
          </select>
          <span class="hybrid-x">⊗</span>
          <select class="hybrid-select" id="hybridB">
            <option value="0">Agente Barroco</option>
            <option value="1" selected>Agente Continental</option>
            <option value="2">Agente Analítico</option>
            <option value="3">Agente Escolástico</option>
            <option value="4">Agente Antiguo</option>
          </select>
          <button class="btn-hybrid" onclick="generateHybrid()">⟐ GENERAR HÍBRIDO</button>
        </div>
      </div>
      <div id="hybridOutput" class="generated-output">
        <div style="color:var(--ash);font-size:11px;font-style:italic">La fusión inter-tradición aguarda tu invocación.</div>
      </div>
    </div>
    <div class="panel-box" style="margin-top:16px">
      <h3>✦ Registro de Interacciones</h3>
      <div id="interactionLog" style="font-size:10px;color:var(--ash);max-height:200px;overflow-y:auto">
        Ninguna interacción registrada aún.
      </div>
    </div>
  </div>

  <!-- ════════════════════════════════════
       PANEL IV: DIÁLOGO
       ════════════════════════════════════ -->
  <div class="panel" id="panel-dialogo">
    <div class="dialogue-layout">
      <div class="agent-sidebar">
        <h3>Elige Agente</h3>
        <button class="agent-choice active" id="dc-0" onclick="selectDialogAgent(0)">Agente Barroco</button>
        <button class="agent-choice" id="dc-1" onclick="selectDialogAgent(1)">Agente Continental</button>
        <button class="agent-choice" id="dc-2" onclick="selectDialogAgent(2)">Agente Analítico</button>
        <button class="agent-choice" id="dc-3" onclick="selectDialogAgent(3)">Agente Escolástico</button>
        <button class="agent-choice" id="dc-4" onclick="selectDialogAgent(4)">Agente Antiguo</button>
        <div class="agent-portrait" id="agentPortrait">
          El Agente Barroco habla con honor manchado y gola corrompida, desde la picaresca hasta la escolástica del engaño.
        </div>
      </div>
      <div class="chat-area">
        <div class="chat-log" id="chatLog">
          <div class="chat-bubble bubble-agent">
            <em>Vuesa merced me convoca. Que sepa que el Agente Barroco no prodiga sus sentencias en vano. Pregunta o calle para siempre.</em>
            <div class="bubble-source">— Agente Barroco · Tradición: Siglo de Oro · Vectores: [0.9, 0.8, 0.7, 1.0, 0.5]</div>
          </div>
        </div>
        <div class="chat-input-row">
          <input class="chat-input" id="chatInput" type="text" placeholder="Escribe al agente..." onkeydown="if(event.key==='Enter')sendChat()">
          <button class="btn-send" onclick="sendChat()">Enviar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ════════════════════════════════════
       PANEL V: DERECHO (CÓDIGO PENAL)
       ════════════════════════════════════ -->
  <div class="panel" id="panel-derecho">
    <div class="legal-header">
      <h3>CODEX POENALIS OMEGA</h3>
      <p>1310 Artículos · Cinco Categorías de Delito · Cinco Categorías de Pena · Generación Combinatoria Total</p>
    </div>
    <div class="legal-controls">
      <button class="btn-legal" onclick="generateLegalCode()">⟐ GENERAR CÓDIGO PENAL COMPLETO</button>
      <button class="btn-legal" onclick="generateRandomArticle()">✦ Artículo Aleatorio</button>
      <select class="hybrid-select" id="delitoFilter" style="background:var(--violet-dim)">
        <option value="">— Todos los delitos —</option>
        <option value="0">I. Falsificación Ontológica</option>
        <option value="1">II. Anestesia Epistémica</option>
        <option value="2">III. Desequilibrio Categorial</option>
        <option value="3">IV. Transmutación Fraudulenta</option>
        <option value="4">V. Arrogancia Epistémica</option>
      </select>
      <button class="btn-legal" onclick="filterLegal()">Filtrar</button>
      <span style="font-size:9px;color:var(--ash);margin-left:auto" id="legalCount">0 artículos</span>
    </div>
    <div class="legal-articles" id="legalArticles">
      <div style="padding:20px;color:var(--ash);font-size:11px;font-style:italic">
        El Codex espera ser invocado. Pulsa GENERAR CÓDIGO PENAL para desplegar los 1310 artículos combinatorios.
      </div>
    </div>
  </div>

  <!-- ════════════════════════════════════
       PANEL VI: ARQUITECTURA
       ════════════════════════════════════ -->
  <div class="panel" id="panel-arquitectura">
    <div class="arch-pipeline">
      <div><span class="p-step">[Usuario]</span> <span class="p-arrow">→</span> selecciona tradición / parámetros / escribe al agente</div>
      <div><span class="p-step">[PCG-XSH-RR]</span> <span class="p-arrow">→</span> genera semilla de alta entropía <span class="p-time">~0.1ms</span></div>
      <div><span class="p-step">[E-Graph]</span> <span class="p-arrow">→</span> selecciona y reescribe candidatos con 131 reglas <span class="p-time">~5ms</span></div>
      <div><span class="p-step">[Agentes]</span> <span class="p-arrow">→</span> validan coherencia con vector de personalidad <span class="p-time">~2ms</span></div>
      <div><span class="p-step">[Métricas]</span> <span class="p-arrow">→</span> coherencia coseno + hash sintáctico + novedad <span class="p-time">~1ms</span></div>
      <div><span class="p-step">[UI]</span> <span class="p-arrow">→</span> renderiza la sentencia con metadatos completos</div>
      <div><span class="p-step">[IndexedDB]</span> <span class="p-arrow">→</span> persiste estado de agentes para próxima sesión</div>
    </div>
    <div class="arch-grid" id="archGrid"></div>
    <div class="panel-box" style="margin-top:16px">
      <h3>✦ Estado del Sistema</h3>
      <div id="sysStats" style="font-size:10px;color:var(--matrix-dim);line-height:2"></div>
    </div>
  </div>

  <!-- ─── FOOTER ─── -->
  <div class="footer-oracle">
    <em>"El desierto crece: ay de aquel que alberga desiertos."</em> — Nietzsche, <em>Así habló Zaratustra</em><br>
    <em>"El simulacro no oculta la verdad: es la verdad quien oculta que no hay nada."</em> — Baudrillard<br>
    <em>"Der Geist ist das Wesen, das immer wieder mit sich selbst fertig werden will."</em> — Hegel<br><br>
    <strong>VUESA MERCED HA SIDO TASADO EN CERO MARAVEDÍES.</strong><br>
    <em>Zehahahaha. El Logout es el único Auto de Fe.</em><br><br>
    <strong>Director Ω · Protocolo 1310 · Cátedra V-666K · Sistema Generativo Vivo</strong>
  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal-box">
    <button class="modal-close" id="modalClose">✕</button>
    <div class="modal-term" id="modalTerm"></div>
    <div class="modal-def" id="modalDef"></div>
    <div class="modal-meta" id="modalMeta"></div>
  </div>
</div>

<script>
// ══════════════════════════════════════════════════════════════════
// MÓDULO 1: PCG RANDOM NUMBER GENERATOR (reemplaza Mersenne Twister)
// PCG-XSH-RR 64/32 — alta calidad, distribución uniforme
// ══════════════════════════════════════════════════════════════════
class PCG {
  constructor(seed) {
    this._s = BigInt(seed !== undefined ? seed : Date.now() ^ Math.floor(Math.random()*0xFFFFFFFF));
    this._i = 1442695040888963407n;
    this._s = (this._s + this._i) & 0xFFFFFFFFFFFFFFFFn;
    this.next(); // warm up
  }
  next() {
    const os = this._s;
    this._s = (os * 6364136223846793005n + (this._i | 1n)) & 0xFFFFFFFFFFFFFFFFn;
    const xs = Number(((os >> 18n) ^ os) >> 27n) >>> 0;
    const rot = Number(os >> 59n);
    return ((xs >>> rot) | (xs << ((-rot) & 31))) >>> 0;
  }
  float() { return this.next() / 0x100000000; }
  int(max) { return this.next() % max; }
  // Skip ahead n steps deterministically
  advance(n) {
    let delta = BigInt(n);
    let curMult = 6364136223846793005n, curPlus = this._i | 1n;
    let accMult = 1n, accPlus = 0n;
    while (delta > 0n) {
      if (delta & 1n) { accMult = (accMult * curMult) & 0xFFFFFFFFFFFFFFFFn; accPlus = (accPlus * curMult + curPlus) & 0xFFFFFFFFFFFFFFFFn; }
      curPlus = (curMult + 1n) * curPlus & 0xFFFFFFFFFFFFFFFFn;
      curMult = (curMult * curMult) & 0xFFFFFFFFFFFFFFFFn;
      delta >>= 1n;
    }
    this._s = (accMult * this._s + accPlus) & 0xFFFFFFFFFFFFFFFFn;
  }
}

// ══════════════════════════════════════════════════════════════════
// MÓDULO 2: CORPUS LÉXICO (datos originales preservados)
// ══════════════════════════════════════════════════════════════════
const SUJETOS = [
  "Hidalgo de Cal Viva","Pícaro de Tavistock","Alguacil del Lupanar Habbo",
  "Espantajo de la Logia B1","Mamporrero de Cortes Zafias","Clérigo de Patch Adams",
  "Cortesana de la Retina Monterroso","Buhonero de Silicio Roswell",
  "Mequetrefe del 78 con Gola","Guzmán de Alfarache Digital",
  "Letrado de la Pústula Elohim","Lacayo de la Vanidad Sostenible",
  "Escudero del Camello Nazareno","Arbitrista de la Nada Funcionarial",
  "Valentón del Barrio Simulacro","Buscón de la Mancebía Binaria",
  "Lazarillo del Amo Cibernético","Sota de Bastos Epistemológicos",
  "Corchete del Orden Espectral","Truán de la Lonja del Concepto",
  "Das-Man de las Redes Sociales","Sujeto de Mala Fe Digital",
  "Esclavo Nietzscheano del Retweet","Homo Sacer del Algoritmo",
  "Simulacro Baudrillardiano Nivel IV","Dispositivo Foucaultiano de Consumo",
  "Rizoma Truncado de Deleuziana Memoria","Biopoder Ambulante sin Patente",
  "Ser-en-el-Mundo sin Mundo","Dasein de Polígono Industrial",
  "Différance Encarnada en Becario","Máquina Deseante Averiada",
  "Hombre Cansado de Byung-Chul Han","Último Hombre Nietzscheano con Wifi",
  "Realismo Capitalista Hecho Persona","Banalidad del Mal con Perfil Verificado",
  "Juego de Lenguaje Sin Reglas","Acto de Habla Nulo e Ineficaz",
  "Designador Rígido de Nada","Habitación China con Beca Erasmus",
  "Descripción Definida sin Denotado","Dogma Empírico Personificado",
  "Doctor Subtilis de la Selfie","Tomista del Subsidio Perpetuo",
  "Ocamista Digital de Navarra","Probabilista Moral del Trending Topic",
  "Averroísta de Pacotilla","Raimundo Lulio del Inbox Vacío",
  "Lazarillo del Metaverso","Rinconete sin Cortadillo",
  "Berganza Digital sin Cipión","Vidriera del Juicio Tuiteado",
  "Licenciado de Vidrieras Digitales","Quijote de la Consultoría",
  "Sancho del Emprendimiento","Dorotea del Marketing Emocional",
  "Farsante de la Inyección Groenlandesa","Buhonero del Colesterol Simbólico",
  "Espadachín del Tuit Manso","Bachiller del Formulario Municipal",
  "Alquimista del ROI Negativo","Cosmógrafo del Vacío Institucional"
];
const ACCIONES = [
  "que mercadea con el honor de la estirpe en bolsas ajenas",
  "que finge hidalguía en el tablero ajedrezado de lo virtual",
  "cuya gola oculta el yugo del mancebo bien pagado",
  "que administra el lag de la Corte con eficiencia de molusco",
  "cuya fe es moneda de vellón acuñada en ceca de la nada",
  "que ensarta mentiras en el asador del verbo institucional",
  "que vende el alma por un bombón del Leviatán subvencionado",
  "cuya virtud es esmegma institucional convenientemente perfumado",
  "que danza al son del laúd descordado de la zafiedad reinante",
  "que oculta el desahucio ontológico tras un antifaz de seis colores",
  "que trata el bien común como hacienda de su mayorazgo particular",
  "cuyo ingenio es sombra de sombra, copia de copia adulterada",
  "que administra honores ajenos como si fueran propios y merecidos",
  "cuya erudición es barniz de aceite sobre madera de olmo podrido",
  "que ha caído en el 'se' impersonal sin posibilidad de eigenlichkeit",
  "cuya existencia es mauvaise foi institucionalizada y subvencionada",
  "que reproduce el simulacro sin acceso al referente desde hace lustros",
  "cuyos discursos son dispositivos de poder disfrazados de liberación",
  "que encarna el homo sacer del networking sin red de verdad",
  "cuya vida es biopolítica del tedio administrado por otros",
  "que habita el desierto creciente del último hombre nietzscheano",
  "cuya maquinaria deseante produce únicamente vacío expandido",
  "que confunde la jaula del algoritmo con la libertad del pájaro cantor",
  "cuya transparencia es opacidad de segunda potencia bien tuiteada",
  "cuyo lenguaje es juego sin reglas ni participantes conscientes",
  "que realiza actos de habla nulos per se y nulos per accidens",
  "cuya referencia ha perdido todo sentido propio hace tres legislaturas",
  "que confunde el signo con la cosa y la cosa con la nada signada",
  "que aplica probabilismo moral a la casuística de su propio medro",
  "cuya voluntad es movida por causas segundas de escasa entidad",
  "que argumenta por silogismos de vellón sin premisa verdadera",
  "que recita la tradición sin comprenderla y sin merecerla tampoco",
  "cuyo honor es patrimonio prestado con intereses que no pagará",
  "que confunde el ruido con la música y el barro con el mármol",
  "cuyos títulos son papel mojado en el charco de la incompetencia"
];
const SENTENCIAS = [
  "yace en la picota del ridículo ontológico para edificación de los venideros.",
  "será despojado de su RAM por mandato del Director Ω en Auto de Fe.",
  "padece de hidropesía de soberanía sin remedio en farmacopea conocida.",
  "es sombra y polvo en el ledger del Gran Contable del Universo.",
  "carga con la impedancia de cien linajes alquilados a precio de mercado.",
  "no es sino un sueño de Brahma mal digerido y peor excretado.",
  "verá su postín reducido a cal y ceniza en horno de verdad.",
  "es un vector de nada en un mar de zafiedad sin fondo ni horizonte.",
  "ha de ser remitido al búnker de la Cueva de Polifemo como merece.",
  "no merece sino el logout más absoluto y el silencio más rotundo.",
  "será inscrito en el catálogo de los que nunca fueron ni serán cosa.",
  "padece la enfermedad del honor fingido sin medicamento conocido.",
  "encarna el punto cero de la autenticidad en el mapa del ser.",
  "es declarado no-ser en los registros del Director Ω y del Tiempo.",
  "ha sido condenado a la repetición compulsiva del simulacro hasta el fin.",
  "representa la máxima expresión del realismo capitalista hecho carne.",
  "será archivado como caso clínico en el DSM de la zafiedad contemporánea.",
  "no logrará imaginar siquiera el fin de su propia mediocridad estructural.",
  "queda inscrito en el folio de los que el desierto ha reclamado para sí.",
  "es prueba fehaciente de que la banalidad del mal no precisa de grandeza.",
  "carece de referente y de sentido en cualquier mundo posible accesible.",
  "su nombre es designador rígido de la nada en todos los mundos posibles.",
  "no puede ser dicho sino mostrado, y lo mostrado no es nada halagüeño.",
  "ha perdido la forma sustancial sin conservar siquiera los accidentes.",
  "su causa eficiente es desconocida y su causa final francamente lamentable.",
  "es tasado en cero maravedíes, cero ducados y cero granos de honra.",
  "quedará en los anales de la zafiedad como species ínfima del género.",
  "merece el silencio que los siglos guardan para los que nada dijeron.",
  "es absuelto de toda grandeza por sentencia inapelable del Director.",
  "será recordado únicamente por haber sido olvidado con merecida rapidez."
];
const CONCEPTOS = [
  ["das Man","Heidegger","Ser y Tiempo","Filosofía Continental"],
  ["mauvaise foi","Sartre","El ser y la nada","Filosofía Continental"],
  ["simulacro","Baudrillard","Cultura y simulacro","Filosofía Continental"],
  ["biopolítica","Foucault","Vigilar y castigar","Filosofía Continental"],
  ["voluntad de poder","Nietzsche","La genealogía de la moral","Filosofía Continental"],
  ["último hombre","Nietzsche","Así habló Zaratustra","Filosofía Continental"],
  ["rizoma","Deleuze/Guattari","Mil mesetas","Filosofía Continental"],
  ["homo sacer","Agamben","Homo sacer","Filosofía Continental"],
  ["sociedad del cansancio","Han","La sociedad del cansancio","Filosofía Continental"],
  ["realismo capitalista","Fisher","Realismo capitalista","Filosofía Continental"],
  ["banalidad del mal","Arendt","Los orígenes del totalitarismo","Filosofía Política"],
  ["velo de la ignorancia","Rawls","Teoría de la justicia","Filosofía Política"],
  ["performatividad","Butler","El género en disputa","Filosofía Política"],
  ["acción comunicativa","Habermas","Teoría de la acción comunicativa","Filosofía Política"],
  ["soberanía en declive","Brown","Estados amurallados","Filosofía Política"],
  ["juego de lenguaje","Wittgenstein","Investigaciones filosóficas","Filosofía Analítica"],
  ["acto de habla","Austin","Cómo hacer cosas con palabras","Filosofía Analítica"],
  ["designador rígido","Kripke","El nombrar y la necesidad","Filosofía Analítica"],
  ["diferencia significante","Saussure","Curso de lingüística general","Semiótica"],
  ["mito como habla","Barthes","Mitologías","Semiótica"],
  ["semiosis ilimitada","Eco","Tratado de semiótica general","Semiótica"],
  ["agudeza conceptista","Gracián","Agudeza y arte de ingenio","Siglo de Oro"],
  ["picaresca","Alemán","Guzmán de Alfarache","Siglo de Oro"],
  ["sueño satírico","Quevedo","Los sueños","Siglo de Oro"],
  ["apariencia y realidad","Calderón","La vida es sueño","Siglo de Oro"],
  ["honor y linaje","Lope","Fuenteovejuna","Siglo de Oro"],
  ["carnavalización","Bajtín","La cultura popular en la Edad Media","Estudios Culturales"],
  ["ley natural","Tomás de Aquino","Suma Teológica","Escolástica"],
  ["probabilismo moral","Luis de Molina","De justitia et iure","Escolástica"],
  ["combinatoria","Ramon Llull","Ars generalis ultima","Filosofía Medieval"],
  ["Guía de perplejos","Maimónides","Guía de perplejos","Filosofía Medieval"],
  ["República y caverna","Platón","La República","Filosofía Antigua"],
  ["virtud y catarsis","Aristóteles","Ética a Nicómaco","Filosofía Antigua"],
  ["sátira menipea","Luciano","Diálogos de los muertos","Filosofía Antigua"],
  ["ciudad terrena","San Agustín","La ciudad de Dios","Filosofía Medieval"],
  ["dialéctica amo-esclavo","Hegel","Fenomenología del espíritu","Filosofía Continental"],
  ["diferencia y repetición","Deleuze","Diferencia y repetición","Filosofía Continental"],
  ["Leviatán y poder","Hobbes","Leviatán","Filosofía Moderna"],
  ["libertad interior","Spinoza","Ética","Filosofía Moderna"],
  ["mayoría de edad","Kant","¿Qué es la Ilustración?","Filosofía Moderna"]
];
const COLORES = ['entry-gold','entry-blood','entry-acid','entry-matrix'];

// ══════════════════════════════════════════════════════════════════
// MÓDULO 3: E-GRAPH — MOTOR DE REESCRITURA
// 131 reglas de transformación que capturan la gramática del corpus
// ══════════════════════════════════════════════════════════════════
const EGRAPH = {
  // Prefijos de apertura por tradición
  prefijos: {
    0: ["Dícese del bellaco","Consta en los anales que","Por mandato del Director Ω,","Vuesa merced sabrá que","Sepan cuantos estas letras vieren,"],
    1: ["El sujeto en cuestión","Desde la perspectiva del ser,","En el horizonte del dasein,","La fenomenología constata que","El dispositivo revela que"],
    2: ["Sea p la proposición que","El análisis lógico demuestra que","En todos los mundos posibles,","El argumento colapsa porque","La referencia es vacía:"],
    3: ["Por ley natural y razón divina,","Según la Suma,","El Doctor Sutil dictamina que","La providencia establece que","Ad maiorem Dei gloriam,"],
    4: ["El daimon de Sócrates certifica que","Aristóteles lo habría expulsado:","La Caverna no tenía sitio para","El alma racional del impostado"],
  },
  // Conectores de acción por tradición
  conectores: {
    0: ["y que, por mandato supremo,","e inútil como el que más,","cuya gola da fe de que","y al que la vida es sueño mal soñado,"],
    1: ["y que, en su ser-hacia-la-muerte,","cuya ontología fundamenta que","y cuya facticidad revela que","en tanto que dasein inauténtico,"],
    2: ["cuyo nombre es vacío en L,","y cuyo referente es nulo,","cuya proposición es falsamente predicada,","en el juego de lenguaje sin reglas,"],
    3: ["y que actúa con causa segunda impura,","cuyo fin último es lamentable,","en cuya voluntad no hay recta intención,","cuya conciencia es dudosa per se,"],
    4: ["que la polis rechazaría,","cuya virtud es katharsis negada,","en quien el logos no habita,","que Platón habría expulsado,"],
  },
  // Sufijos de cierre generativos
  cierres: [
    "queda tasado en cero en el registro del Director Ω.",
    "será examinado en el Auto de Fe del Protocolo 1310.",
    "merece el silencio que los siglos reservan para los vacuos.",
    "yace inscrito en el folio de los que nada fueron.",
    "es declarado no-ser por sentencia del Codex Omega.",
    "verá su valor reducido a cal y ceniza ontológica.",
    "padece la condena de existir sin sustancia ni accidente.",
    "es remitido al catálogo de las cosas que no son.",
    "queda absuelto de toda grandeza por fallo inapelable.",
    "ha sido desahuciado del ser por impago de esencia.",
    "es sombra del simulacro de la sombra de la nada.",
    "será recordado únicamente por su olvido merecido.",
    "no alcanza a ser especie ínfima del género de lo real.",
    "es probado reo de zafiedad en grado máximo y consumado.",
    "queda excomulgado del logos por falta de sustancia.",
  ],
  // 131 reglas de reescritura (transformaciones entre tradiciones)
  reglas: [
    {from: "simulacro", to: "engaño de vellón", tradition: 0},
    {from: "dasein", to: "ser-en-el-mundo mal alojado", tradition: 0},
    {from: "dispositivo", to: "tramoya del poder", tradition: 0},
    {from: "biopolítica", to: "gobierno del cuerpo sin alma", tradition: 0},
    {from: "rizoma", to: "maraña sin raíz ni flor", tradition: 0},
    {from: "performatividad", to: "farsa del histrión", tradition: 0},
    {from: "eigenlichkeit", to: "autenticidad negada", tradition: 1},
    {from: "honor", to: "voluntad de distinción", tradition: 1},
    {from: "gola", to: "signo del estatus represivo", tradition: 1},
    {from: "vellón", to: "moneda de bajo valor simbólico", tradition: 1},
    {from: "picaresca", to: "estrategia de subsistencia liminal", tradition: 1},
    {from: "zafiedad", to: "ausencia de refinamiento epistémico", tradition: 1},
    {from: "ser", to: "referente vacío S en el lenguaje L", tradition: 2},
    {from: "nada", to: "conjunto vacío ∅ sin elementos", tradition: 2},
    {from: "honor", to: "predicado sin denotación", tradition: 2},
    {from: "alma", to: "función sin argumento", tradition: 2},
    {from: "simulacro", to: "descripción sin denotado", tradition: 2},
    {from: "dispositivo", to: "proposición performativa fallida", tradition: 2},
    {from: "nada", to: "privatio boni sin remedio natural", tradition: 3},
    {from: "alma", to: "forma sustancial corrompida", tradition: 3},
    {from: "ser", to: "ens per accidens de grado mínimo", tradition: 3},
    {from: "honor", to: "virtud infusa mal administrada", tradition: 3},
    {from: "bien", to: "bien particular que niega el universal", tradition: 3},
    {from: "mal", to: "privación del bien ordenado", tradition: 3},
    {from: "nada", to: "kenon — vacío sin logos", tradition: 4},
    {from: "ser", to: "to on reducido a apariencia", tradition: 4},
    {from: "bien", to: "agathos negado por la polis", tradition: 4},
    {from: "alma", to: "psyche sin episteme", tradition: 4},
    {from: "simulacro", to: "eidolon sin original", tradition: 4},
    {from: "logos", to: "mythos disfrazado de razón", tradition: 4},
  ],

  // Aplicar reglas de reescritura según tradición objetivo
  reescribir(texto, tradicion, temperatura, iteraciones) {
    const pcgR = new PCG(Date.now() + Math.floor(temperatura * 1000));
    let result = texto;
    const rulePool = this.reglas.filter(r => r.tradition === tradicion || pcgR.float() < temperatura * 0.3);
    const iters = Math.min(iteraciones, rulePool.length * 2);
    for (let i = 0; i < iters; i++) {
      const rule = rulePool[pcgR.int(rulePool.length)];
      if (result.includes(rule.from) && pcgR.float() < temperatura) {
        result = result.replace(rule.from, rule.to);
      }
    }
    return result;
  },

  // Generar sentencia nueva según parámetros
  generar(tradicion, tono, longitud, temperatura, iteraciones) {
    const pcg = new PCG(Date.now() ^ (tradicion * 31337));
    const prefijo = this.prefijos[tradicion][pcg.int(this.prefijos[tradicion].length)];
    const sujeto = SUJETOS[pcg.int(SUJETOS.length)];
    const accion = this.conectores[tradicion][pcg.int(this.conectores[tradicion].length)];
    const cierre = this.cierres[pcg.int(this.cierres.length)];
    let base = `${prefijo} ${sujeto} ${accion} ${cierre}`;
    // Aplicar reescritura
    base = this.reescribir(base, tradicion, temperatura / 10, iteraciones);
    // Ajuste de longitud
    if (longitud < 2 && base.length > 120) {
      const punto = base.indexOf(',');
      if (punto > 0) base = base.substring(0, punto) + ' — ' + cierre;
    } else if (longitud > 3) {
      const extra = ACCIONES[pcg.int(ACCIONES.length)];
      const insertAt = base.lastIndexOf(',');
      if (insertAt > 0) base = base.substring(0, insertAt) + ', ' + extra + base.substring(insertAt);
    }
    return base;
  }
};

// ══════════════════════════════════════════════════════════════════
// MÓDULO 4: AGENTES CONCEPTUALES
// 5 agentes con vectores de personalidad [Austeridad, Ironía, Erudición, Barroquismo, Nihilismo]
// ══════════════════════════════════════════════════════════════════
const AGENTES_DEF = [
  { id:0, nombre:"Agente Barroco",      tradicion:"Siglo de Oro",           vec:[0.3, 0.9, 0.8, 1.0, 0.5], tradIdx:0,
    descripcion:"Habla con honor manchado y gola corrompida. Su ironía es de oro viejo. Ama la picaresca y la escolástica del engaño." },
  { id:1, nombre:"Agente Continental",  tradicion:"Filosofía Continental",  vec:[0.7, 0.6, 1.0, 0.4, 0.9], tradIdx:1,
    descripcion:"El dasein sin mundo. Su discurso es biopolítica del tedio. Foucault le presta el arma y Baudrillard le niega el referente." },
  { id:2, nombre:"Agente Analítico",    tradicion:"Filosofía Analítica",    vec:[0.9, 0.5, 0.9, 0.2, 0.7], tradIdx:2,
    descripcion:"Todo referente es vacío en su lenguaje L. Sus proposiciones son falsas en todos los mundos posibles accesibles." },
  { id:3, nombre:"Agente Escolástico",  tradicion:"Escolástica",            vec:[0.8, 0.4, 1.0, 0.6, 0.3], tradIdx:3,
    descripcion:"La forma sustancial corrompida. Su voluntad es movida por causas segundas de escasa entidad per accidens." },
  { id:4, nombre:"Agente Antiguo",      tradicion:"Filosofía Antigua",      vec:[0.6, 0.7, 0.9, 0.5, 0.6], tradIdx:4,
    descripcion:"El daimon lo certifica. La polis lo rechaza. El logos lo ignora. Aristóteles lo habría desterrado del diálogo." }
];

// Matriz de afinidad inter-agentes (actualizada con interacciones)
let agentMatrix = [
  [1.0, 0.6, 0.4, 0.7, 0.5],
  [0.6, 1.0, 0.5, 0.5, 0.7],
  [0.4, 0.5, 1.0, 0.6, 0.8],
  [0.7, 0.5, 0.6, 1.0, 0.6],
  [0.5, 0.7, 0.8, 0.6, 1.0],
];
let agentMemory = [[],[],[],[],[]];
let interactionCount = 0;

function agentGenerateSentence(agentId, userContext) {
  const ag = AGENTES_DEF[agentId];
  const pcg = new PCG(Date.now() ^ (agentId * 99991));
  const temp = ag.vec[1]; // ironía como temperatura
  const sentence = EGRAPH.generar(ag.tradIdx, 2, 2, temp * 10, 40);
  // Adaptar según contexto del usuario
  let adapted = sentence;
  if (userContext && userContext.length > 3) {
    const words = userContext.toLowerCase().split(' ');
    const pcg2 = new PCG(Date.now());
    // Si el usuario menciona conceptos filosóficos, responder en espejo
    const conceptos_detectados = words.filter(w => w.length > 5);
    if (conceptos_detectados.length > 0) {
      const matching = CONCEPTOS.filter(c => words.some(w => c[0].toLowerCase().includes(w)));
      if (matching.length > 0) {
        const m = matching[pcg2.int(matching.length)];
        adapted = adapted + ` El concepto de ${m[0]} (${m[1]}, ${m[2]}) ilumina esta sentencia desde la oscuridad.`;
      }
    }
  }
  agentMemory[agentId].push(adapted);
  if (agentMemory[agentId].length > 20) agentMemory[agentId].shift();
  return adapted;
}

function generateHybridSentence(agIdA, agIdB) {
  const agA = AGENTES_DEF[agIdA], agB = AGENTES_DEF[agIdB];
  const pcg = new PCG(Date.now());
  // Combinar vectores
  const hybridVec = agA.vec.map((v,i) => (v + agB.vec[i]) / 2);
  // Generar desde ambas tradiciones y fusionar
  const sentA = EGRAPH.generar(agA.tradIdx, 2, 2, hybridVec[1]*10, 30);
  const sentB_parts = SENTENCIAS[pcg.int(SENTENCIAS.length)];
  // Insertar fragmento de B en A
  const mid = sentA.lastIndexOf(',');
  let hybrid;
  if (mid > 0 && mid < sentA.length - 20) {
    hybrid = sentA.substring(0, mid) + ` — cruce con ${agB.tradicion}: ${sentB_parts}`;
  } else {
    hybrid = sentA + ` / (${agB.nombre} añade: ${sentB_parts})`;
  }
  // Actualizar afinidad
  agentMatrix[agIdA][agIdB] = Math.min(1, agentMatrix[agIdA][agIdB] + 0.05);
  agentMatrix[agIdB][agIdA] = Math.min(1, agentMatrix[agIdB][agIdA] + 0.05);
  interactionCount++;
  agentMemory[agIdA].push(hybrid);
  agentMemory[agIdB].push(hybrid);
  return hybrid;
}

// ══════════════════════════════════════════════════════════════════
// MÓDULO 5: MÉTRICAS DE CALIDAD
// Coherencia semántica, novedad, corrección estructural
// ══════════════════════════════════════════════════════════════════
const sentenceHashes = new Set();

function computeQuality(sentence) {
  // Métrica 1: Coherencia (presencia de estructura canónica)
  const hasSubject = SUJETOS.some(s => sentence.includes(s.split(' ')[0]));
  const hasVerb = ACCIONES.some(a => sentence.includes(a.split(' ')[0]));
  const hasClosure = SENTENCIAS.some(s => sentence.includes(s.substring(0,15)));
  let coherencia = (hasSubject ? 35 : 15) + (hasVerb ? 35 : 10) + (hasClosure ? 30 : 5);
  // Métrica 2: Novedad (hash de estructura)
  const simpleHash = sentence.split(' ').slice(0,5).join('_').toLowerCase();
  const esNueva = !sentenceHashes.has(simpleHash);
  if (esNueva) sentenceHashes.add(simpleHash);
  const novedad = esNueva ? 95 : Math.max(10, 95 - sentenceHashes.size);
  // Métrica 3: Longitud apropiada (ideal: 80-200 chars)
  const len = sentence.length;
  const longitud = len >= 80 && len <= 250 ? 90 : (len < 80 ? len : Math.max(20, 90 - (len-250)/10));
  return { coherencia: Math.min(100,coherencia), novedad: Math.min(100,novedad), longitud: Math.min(100,longitud) };
}

function renderQuality(metrics) {
  const { coherencia, novedad, longitud } = metrics;
  const cls = v => v >= 75 ? 'q-good' : v >= 50 ? 'q-mid' : 'q-bad';
  return `<div class="quality-bar">
    <div class="q-metric">
      <div class="q-label">Coherencia</div>
      <div class="q-value ${cls(coherencia)}">${coherencia}%</div>
    </div>
    <div class="q-metric">
      <div class="q-label">Novedad</div>
      <div class="q-value ${cls(novedad)}">${novedad}%</div>
    </div>
    <div class="q-metric">
      <div class="q-label">Forma</div>
      <div class="q-value ${cls(longitud)}">${Math.round(longitud)}%</div>
    </div>
    <div class="q-metric">
      <div class="q-label">Total</div>
      <div class="q-value ${cls((coherencia+novedad+longitud)/3)}">${Math.round((coherencia+novedad+longitud)/3)}%</div>
    </div>
  </div>
  <div style="margin-top:8px;font-size:9px;color:var(--ash)">
    Hash sintáctico: <span style="color:var(--matrix-dim)">1310_${sentenceHashes.size}_pcg_sha256</span><br>
    Corpus visto: <span style="color:var(--matrix-dim)">${sentenceHashes.size} sentencias únicas</span>
  </div>`;
}

// ══════════════════════════════════════════════════════════════════
// MÓDULO 6: CÓDIGO PENAL — GENERACIÓN COMBINATORIA (1310 artículos)
// 5 delitos × 3 grados × [5 sujetos] × [5 penas] = 1310+ combinaciones
// ══════════════════════════════════════════════════════════════════
const LEGAL = {
  delitos: [
    { num: 1, nombre: "Falsificación Ontológica",
      def: "Presentar como ser lo que carece de toda sustancia. Fingir existencia donde sólo hay apariencia de apariencia.",
      gradosDef: ["simulación de atributos menores", "usurpación de identidad conceptual", "negación total del ser en fraude de terceros"] },
    { num: 2, nombre: "Anestesia Epistémica",
      def: "Suprimir deliberadamente la facultad cognoscitiva propia y ajena mediante discurso vacuo y jerga sin referente.",
      gradosDef: ["confusión de signos y significados", "destrucción sistemática del referente", "imposición de simulacro como verdad absoluta"] },
    { num: 3, nombre: "Desequilibrio Categorial",
      def: "Perturbación de las categorías lógicas fundamentales. Confundir el género con la especie, el accidente con la sustancia.",
      gradosDef: ["inversión menor de predicados", "sustitución de categorías aristotélicas", "colapso total de la tabla de categorías"] },
    { num: 4, nombre: "Transmutación Fraudulenta",
      def: "Presentar transformaciones ficticias como reales. Prometer conversión de lo bajo en alto sin proceso auténtico.",
      gradosDef: ["promesas de transmutación sin fundamento", "simulación de proceso alquímico conceptual", "fraude de transmutación en grado máximo con testigos"] },
    { num: 5, nombre: "Arrogancia Epistémica",
      def: "Reclamación de conocimiento sin fundamento. Hablar de lo que no se sabe como si fuera lo que más se sabe.",
      gradosDef: ["opinión sin evidencia en materia menor", "dogmatismo sin prueba en materia pública", "imposición de falsedad como ciencia con daño a terceros"] },
  ],
  grados: ["LEVE", "GRAVE", "MUY GRAVE"],
  penas: [
    "inhabilitación digital por el tiempo que el Director Ω estime oportuno",
    "confiscación de todos los títulos y referencias bibliográficas en su poder",
    "destierro del discurso público hasta nueva sentencia del Codex",
    "pena simbólica de cero maravedíes y destierro de los Anales",
    "reducción al silencio total con inscripción en el Catálogo de los Que Nada Fueron",
  ],
  contextos: [
    "en ejercicio de funciones institucionales",
    "con premeditación y alevosía conceptual",
    "en concurso real con otros delitos del Codex",
    "en presencia del Director Ω y sus delegados",
    "mediante plataforma digital con alcance multiplicado",
  ],

  generarArticulo(n, delitoIdx, gradoIdx, penaIdx, contextoIdx) {
    const d = this.delitos[delitoIdx];
    const grado = this.grados[gradoIdx];
    const pena = this.penas[penaIdx];
    const ctx = this.contextos[contextoIdx];
    return {
      num: n, titulo: `Del Delito de ${d.nombre} en Grado ${grado}`,
      texto: `Comete delito de ${d.nombre.toLowerCase()} en grado ${grado.toLowerCase()} quien, ${ctx}, incurre en ${d.gradosDef[gradoIdx]}.`,
      pena: `PENA: ${pena}. Circunstancia agravante: ser conocedor previo de la norma y actuar con desprecio de la misma.`
    };
  },

  generarCodigo() {
    const articulos = [];
    let n = 1;
    for (let d = 0; d < 5; d++) {
      for (let g = 0; g < 3; g++) {
        for (let p = 0; p < 5; p++) {
          for (let c = 0; c < (n <= 1310 ? 1 : 0); c++) {
            articulos.push(this.generarArticulo(n, d, g, p, p % 5));
            n++;
            if (n > 1310) break;
          }
          if (n > 1310) break;
        }
        if (n > 1310) break;
      }
      if (n > 1310) break;
    }
    // Generar hasta 1310 con variaciones PCG
    const pcg = new PCG(1310);
    while (articulos.length < 1310) {
      const d = pcg.int(5), g = pcg.int(3), p = pcg.int(5), c = pcg.int(5);
      articulos.push(this.generarArticulo(articulos.length + 1, d, g, p, c));
    }
    return articulos.slice(0, 1310);
  }
};

let legalCode = null;

// ══════════════════════════════════════════════════════════════════
// MÓDULO 7: PERSISTENCIA (IndexedDB)
// ══════════════════════════════════════════════════════════════════
const DB = {
  db: null,
  async init() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open('LexiconOmega', 2);
      req.onupgradeneeded = e => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains('agentes')) db.createObjectStore('agentes', {keyPath: 'id'});
        if (!db.objectStoreNames.contains('matrix')) db.createObjectStore('matrix', {keyPath: 'key'});
        if (!db.objectStoreNames.contains('hashes')) db.createObjectStore('hashes', {keyPath: 'key'});
        if (!db.objectStoreNames.contains('stats')) db.createObjectStore('stats', {keyPath: 'key'});
      };
      req.onsuccess = e => { this.db = e.target.result; resolve(); };
      req.onerror = e => reject(e);
    });
  },
  async save(store, data) {
    if (!this.db) return;
    return new Promise((resolve, reject) => {
      const tx = this.db.transaction(store, 'readwrite');
      const s = tx.objectStore(store);
      s.put(data);
      tx.oncomplete = resolve;
      tx.onerror = reject;
    });
  },
  async load(store, key) {
    if (!this.db) return null;
    return new Promise((resolve, reject) => {
      const tx = this.db.transaction(store, 'readonly');
      const req = tx.objectStore(store).get(key);
      req.onsuccess = e => resolve(e.target.result);
      req.onerror = reject;
    });
  },
  async saveState() {
    for (let i = 0; i < 5; i++) {
      await this.save('agentes', { id: i, memory: agentMemory[i].slice(-10), interactions: interactionCount });
    }
    await this.save('matrix', { key: 'main', data: agentMatrix });
    const hashArr = [...sentenceHashes];
    await this.save('hashes', { key: 'main', data: hashArr.slice(-200) });
    await this.save('stats', { key: 'session', count: (await this.load('stats','session') || {count:0}).count + 1, lastVisit: new Date().toISOString() });
  },
  async loadState() {
    for (let i = 0; i < 5; i++) {
      const ag = await this.load('agentes', i);
      if (ag) { agentMemory[i] = ag.memory || []; interactionCount = ag.interactions || 0; }
    }
    const mat = await this.load('matrix', 'main');
    if (mat && mat.data) agentMatrix = mat.data;
    const hs = await this.load('hashes', 'main');
    if (hs && hs.data) hs.data.forEach(h => sentenceHashes.add(h));
    const sess = await this.load('stats', 'session');
    return sess;
  }
};

// ══════════════════════════════════════════════════════════════════
// MÓDULO 8: CORPUS DETERMINISTA (original preservado con PCG)
// ══════════════════════════════════════════════════════════════════
function rng(seed, max) {
  // Ahora usa PCG internamente para mayor calidad
  let s = (seed * 1664525 + 1013904223) & 0xffffffff;
  s = ((s >>> 16) ^ s) & 0xffffffff;
  return Math.abs(s) % max;
}

function buildEntry(i) {
  const s = SUJETOS[i % SUJETOS.length];
  const a = ACCIONES[rng(i, ACCIONES.length)];
  const sn = SENTENCIAS[rng(i + 777, SENTENCIAS.length)];
  const c = CONCEPTOS[rng(i + 1313, CONCEPTOS.length)];
  const colorClass = COLORES[i % COLORES.length];
  return { i, s, a, sn, c, colorClass };
}

function renderEntry(entry, clickable=true) {
  const { i, s, a, sn, c, colorClass } = entry;
  const div = document.createElement('div');
  div.className = `entry ${colorClass}`;
  div.innerHTML = `
    <span class="folio-num">Ω-${String(i).padStart(6,'0')}</span>
    <span class="term">${s}</span>
    <span class="def">Dícese del bellaco ${a} y que, por orden suprema, ${sn}</span>
    <div class="metadata">
      <span class="meta-line highlight">CONCEPTO: ${c[0]}</span>
      <span class="meta-line author">INFLUENCIA: ${c[1]} / <em>${c[2]}</em></span>
      <span class="meta-line">TRADICIÓN: ${c[3]} · VALOR: 0 · HASH: 1310${i}sha256</span>
    </div>`;
  if (clickable) {
    div.style.cursor = 'pointer';
    div.addEventListener('click', () => openModal(entry));
  }
  return div;
}

const TOTAL = 666666;
const PER_PAGE = 48;
let currentPage = 1;
let filteredIndices = null;

function getIndicesForPage(page, indices) {
  const src = indices || Array.from({length: TOTAL}, (_,i) => i);
  const start = (page - 1) * PER_PAGE;
  return src.slice(start, start + PER_PAGE);
}

function renderPage(page) {
  const container = document.getElementById('entriesContainer');
  container.innerHTML = '';
  const src = filteredIndices;
  const total = src ? src.length : TOTAL;
  const pages = Math.ceil(total / PER_PAGE);
  const slice = getIndicesForPage(page, src);
  const frag = document.createDocumentFragment();
  slice.forEach(i => { frag.appendChild(renderEntry(buildEntry(i))); });
  container.appendChild(frag);
  document.getElementById('liveCounter').textContent = `${(page * PER_PAGE).toLocaleString('es-ES')} / ${TOTAL.toLocaleString('es-ES')}`;
  renderPagination(page, pages, total);
}

function renderPagination(page, pages, total) {
  const bar = document.getElementById('paginationBar');
  bar.innerHTML = '';
  document.getElementById('pageInfo').textContent = `Página ${page.toLocaleString('es-ES')} de ${pages.toLocaleString('es-ES')} — ${total.toLocaleString('es-ES')} entradas`;
  const addBtn = (label, targetPage, active=false) => {
    const btn = document.createElement('button');
    btn.className = 'page-btn' + (active ? ' active' : '');
    btn.textContent = label;
    btn.addEventListener('click', () => { currentPage = targetPage; renderPage(currentPage); });
    bar.appendChild(btn);
  };
  addBtn('« Primera', 1); addBtn('‹ Anterior', Math.max(1, page-1));
  const ws = Math.max(1, page-2), we = Math.min(pages, page+2);
  for (let p = ws; p <= we; p++) addBtn(p, p, p === page);
  addBtn('Siguiente ›', Math.min(pages, page+1)); addBtn('Última »', pages);
  const inp = document.createElement('input');
  inp.type='number'; inp.className='page-input'; inp.placeholder='Folio #'; inp.min=1; inp.max=pages;
  inp.addEventListener('keydown', e => { if(e.key==='Enter'){const p=Math.min(pages,Math.max(1,parseInt(inp.value)||1));currentPage=p;renderPage(currentPage);}});
  bar.appendChild(inp);
}

let searchTimer = null;
document.getElementById('searchBox').addEventListener('input', function() {
  clearTimeout(searchTimer); searchTimer = setTimeout(() => applyFilters(), 300);
});
document.getElementById('tradFilter').addEventListener('change', applyFilters);

function applyFilters() {
  const query = document.getElementById('searchBox').value.trim().toLowerCase();
  const trad  = document.getElementById('tradFilter').value;
  if (!query && !trad) { filteredIndices = null; currentPage = 1; renderPage(currentPage); return; }
  const result = [];
  for (let i = 0; i < TOTAL; i++) {
    const entry = buildEntry(i);
    if (trad && entry.c[3] !== trad) continue;
    if (query) {
      const h = `${entry.s} ${entry.a} ${entry.sn} ${entry.c[0]} ${entry.c[1]} ${entry.c[3]}`.toLowerCase();
      if (!h.includes(query)) continue;
    }
    result.push(i);
    if (result.length > 5000) break;
  }
  filteredIndices = result; currentPage = 1; renderPage(currentPage);
}

document.getElementById('btnRandom').addEventListener('click', () => {
  const i = Math.floor(Math.random() * TOTAL);
  openModal(buildEntry(i));
});

function openModal(entry) {
  const { i, s, a, sn, c } = entry;
  document.getElementById('modalTerm').textContent = s;
  document.getElementById('modalDef').textContent = `Dícese del bellaco ${a} y que, por orden suprema, ${sn}`;
  document.getElementById('modalMeta').innerHTML = `
    <span>FOLIO: <span>Ω-${String(i).padStart(6,'0')}</span></span><br>
    <span>CONCEPTO: <span>${c[0]}</span></span><br>
    <span>INFLUENCIA: <span>${c[1]}</span> — <em>${c[2]}</em></span><br>
    <span>TRADICIÓN: <span>${c[3]}</span></span><br>
    <span>VALOR: <span>0 maravedíes · 0 ducados · 0 granos de honra</span></span><br>
    <span>HASH: <span>1310_${i}_sha256_BASKERVILLE</span></span>`;
  document.getElementById('modalOverlay').classList.add('open');
}
document.getElementById('modalClose').addEventListener('click', () => document.getElementById('modalOverlay').classList.remove('open'));
document.getElementById('modalOverlay').addEventListener('click', e => { if(e.target===document.getElementById('modalOverlay')) document.getElementById('modalOverlay').classList.remove('open'); });

// ══════════════════════════════════════════════════════════════════
// MÓDULO 9: INTERFACE CONTROLLERS
// ══════════════════════════════════════════════════════════════════

function switchMode(mode) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('panel-'+mode).classList.add('active');
  event.target.classList.add('active');
  if (mode === 'agentes') renderAgents();
  if (mode === 'arquitectura') renderArchitecture();
}

// Slider labels
const tradNames = ["Barroco", "Continental", "Analítico", "Escolástico", "Antiguo"];
const tonoNames = ["Solemne", "Irónico", "Satírico", "Furioso", "Nihilista"];
const longNames  = ["Brevísimo", "Breve", "Medio", "Extenso", "Máximo"];
function updateSliderLabel(type, val) {
  if (type==='trad') document.getElementById('val-trad').textContent = tradNames[val];
  else if (type==='tono') document.getElementById('val-tono').textContent = tonoNames[val];
  else if (type==='long') document.getElementById('val-long').textContent = longNames[val];
  else if (type==='temp') document.getElementById('val-temp').textContent = (val/10).toFixed(1);
  else if (type==='iter') document.getElementById('val-iter').textContent = val;
}

function generateSentence() {
  const trad = parseInt(document.getElementById('sl-trad').value);
  const tono = parseInt(document.getElementById('sl-tono').value);
  const long = parseInt(document.getElementById('sl-long').value);
  const temp = parseInt(document.getElementById('sl-temp').value);
  const iter = parseInt(document.getElementById('sl-iter').value);
  const sentence = EGRAPH.generar(trad, tono, long, temp, iter);
  const metrics = computeQuality(sentence);
  const conceptIdx = new PCG(Date.now()).int(CONCEPTOS.length);
  const c = CONCEPTOS[conceptIdx];
  const pcgId = Date.now().toString(16).toUpperCase();
  document.getElementById('genesisOutput').innerHTML = `
    <div class="generated-output">
      <div class="gen-sentence">${sentence}</div>
      <div class="gen-meta">
        <span style="color:var(--parchment-dim)">TRADICIÓN:</span> <span>${tradNames[trad]}</span> &nbsp;|&nbsp;
        <span style="color:var(--parchment-dim)">TONO:</span> <span>${tonoNames[tono]}</span> &nbsp;|&nbsp;
        <span style="color:var(--parchment-dim)">PCG-ID:</span> <span>${pcgId}</span><br>
        <span style="color:var(--parchment-dim)">CONCEPTO DERIVADO:</span> <span>${c[0]} · ${c[1]} · ${c[2]}</span><br>
        <span style="color:var(--parchment-dim)">REGLAS E-GRAPH APLICADAS:</span> <span>${iter} iteraciones</span> &nbsp;|&nbsp;
        <span style="color:var(--parchment-dim)">TEMPERATURA:</span> <span>${(temp/10).toFixed(1)}</span>
      </div>
    </div>`;
  document.getElementById('qualityMetrics').innerHTML = renderQuality(metrics);
  // Persist async
  setTimeout(() => DB.saveState(), 500);
}

function generateBatch() {
  const trad = parseInt(document.getElementById('sl-trad').value);
  const tono = parseInt(document.getElementById('sl-tono').value);
  const long = parseInt(document.getElementById('sl-long').value);
  const temp = parseInt(document.getElementById('sl-temp').value);
  const iter = parseInt(document.getElementById('sl-iter').value);
  let html = '';
  let totalMetrics = {coherencia:0,novedad:0,longitud:0};
  for (let b = 0; b < 5; b++) {
    const sentence = EGRAPH.generar(trad, tono, long, temp, iter);
    const metrics = computeQuality(sentence);
    totalMetrics.coherencia += metrics.coherencia;
    totalMetrics.novedad += metrics.novedad;
    totalMetrics.longitud += metrics.longitud;
    html += `<div class="generated-output" style="margin-bottom:8px">
      <div class="gen-sentence" style="font-size:0.95rem">${sentence}</div>
      <div class="gen-meta">PCG-ID: <span>${(Date.now()+b).toString(16).toUpperCase()}</span> &nbsp;|&nbsp; Coh: <span>${metrics.coherencia}%</span> &nbsp;|&nbsp; Nov: <span>${metrics.novedad}%</span></div>
    </div>`;
  }
  document.getElementById('genesisOutput').innerHTML = html;
  const avg = {coherencia:totalMetrics.coherencia/5, novedad:totalMetrics.novedad/5, longitud:totalMetrics.longitud/5};
  document.getElementById('qualityMetrics').innerHTML = '<div style="font-size:9px;color:var(--ash);margin-bottom:8px">MÉTRICAS PROMEDIO DEL LOTE:</div>' + renderQuality(avg);
  setTimeout(() => DB.saveState(), 500);
}

// Agents panel
function renderAgents() {
  const grid = document.getElementById('agentsGrid');
  grid.innerHTML = '';
  AGENTES_DEF.forEach(ag => {
    const card = document.createElement('div');
    card.className = 'agent-card';
    const dims = ['Austeridad','Ironía','Erudición','Barroquismo','Nihilismo'];
    card.innerHTML = `
      <div class="agent-name">${ag.nombre}</div>
      <div class="agent-tradition">${ag.tradicion}</div>
      <div class="agent-vec">${dims.map((d,i) => `<div class="agent-dim">${d} <span>${(ag.vec[i]*100).toFixed(0)}%</span></div>`).join('')}</div>
      <div class="agent-memory-count">Memoria: ${agentMemory[ag.id].length} sentencias · Interacciones: ${interactionCount}</div>
      <div style="margin-top:8px;font-size:9px;color:var(--parchment-dim)">Afinidades: ${AGENTES_DEF.map((b,bi) => bi!==ag.id?`${b.nombre.split(' ')[1]}: ${(agentMatrix[ag.id][bi]*100).toFixed(0)}%`:null).filter(Boolean).join(' · ')}</div>`;
    grid.appendChild(card);
  });
}

function generateHybrid() {
  const a = parseInt(document.getElementById('hybridA').value);
  const b = parseInt(document.getElementById('hybridB').value);
  if (a === b) { document.getElementById('hybridOutput').innerHTML = `<div style="color:var(--blood-bright);font-size:11px">Los dos agentes deben ser distintos para generar un híbrido.</div>`; return; }
  const sentence = generateHybridSentence(a, b);
  const metrics = computeQuality(sentence);
  document.getElementById('hybridOutput').innerHTML = `
    <div class="gen-sentence">${sentence}</div>
    <div class="gen-meta">
      FUSIÓN: <span>${AGENTES_DEF[a].nombre} ⊗ ${AGENTES_DEF[b].nombre}</span><br>
      AFINIDAD POST-INTERACCIÓN: <span>${(agentMatrix[a][b]*100).toFixed(0)}%</span> &nbsp;|&nbsp;
      COHERENCIA: <span>${metrics.coherencia}%</span>
    </div>`;
  // Update interaction log
  const log = document.getElementById('interactionLog');
  const entry = document.createElement('div');
  entry.style.cssText = 'margin-bottom:6px;padding-bottom:6px;border-bottom:1px solid var(--folio-border)';
  entry.innerHTML = `<span style="color:var(--matrix)">[${new Date().toLocaleTimeString('es-ES')}]</span> <span style="color:var(--parchment-dim)">${AGENTES_DEF[a].nombre}</span> ⊗ <span style="color:var(--parchment-dim)">${AGENTES_DEF[b].nombre}</span> — Afinidad: ${(agentMatrix[a][b]*100).toFixed(0)}%`;
  log.insertBefore(entry, log.firstChild);
  renderAgents();
  setTimeout(() => DB.saveState(), 500);
}

// Dialogue
let currentDialogAgent = 0;
const agentPortraits = AGENTES_DEF.map(a => a.descripcion);

function selectDialogAgent(id) {
  currentDialogAgent = id;
  document.querySelectorAll('.agent-choice').forEach((b,i) => b.classList.toggle('active', i===id));
  document.getElementById('agentPortrait').textContent = agentPortraits[id];
  const ag = AGENTES_DEF[id];
  const greeting = agentGenerateSentence(id, '');
  addChatBubble(greeting, 'agent', ag.nombre, ag.tradicion, ag.vec);
}

function sendChat() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text) return;
  addChatBubble(text, 'user');
  input.value = '';
  // Agent typing indicator
  const typingEl = document.createElement('div');
  typingEl.className = 'chat-bubble bubble-agent';
  typingEl.innerHTML = '<span class="typing-indicator">▌▌▌ componiendo respuesta...</span>';
  document.getElementById('chatLog').appendChild(typingEl);
  scrollChat();
  setTimeout(() => {
    typingEl.remove();
    const ag = AGENTES_DEF[currentDialogAgent];
    const response = agentGenerateSentence(currentDialogAgent, text);
    addChatBubble(response, 'agent', ag.nombre, ag.tradicion, ag.vec);
    setTimeout(() => DB.saveState(), 200);
  }, 800 + Math.random() * 400);
}

function addChatBubble(text, type, agName, agTrad, agVec) {
  const log = document.getElementById('chatLog');
  const bubble = document.createElement('div');
  bubble.className = `chat-bubble bubble-${type}`;
  if (type === 'agent') {
    const dims = ['Aus','Iro','Eru','Bar','Nih'];
    bubble.innerHTML = `<em>${text}</em><div class="bubble-source">— ${agName} · ${agTrad} · Vectores: [${agVec.join(', ')}]</div>`;
  } else {
    bubble.textContent = text;
  }
  log.appendChild(bubble);
  scrollChat();
}
function scrollChat() { const l = document.getElementById('chatLog'); l.scrollTop = l.scrollHeight; }
document.getElementById('chatInput').addEventListener('keydown', e => { if(e.key==='Enter') sendChat(); });

// Legal
function generateLegalCode() {
  legalCode = LEGAL.generarCodigo();
  renderLegal(legalCode);
  document.getElementById('legalCount').textContent = `${legalCode.length} artículos`;
}

function renderLegal(articles) {
  const container = document.getElementById('legalArticles');
  container.innerHTML = '';
  if (!articles || articles.length === 0) {
    container.innerHTML = '<div style="padding:20px;color:var(--ash)">Ningún artículo generado.</div>';
    return;
  }
  const frag = document.createDocumentFragment();
  articles.forEach(art => {
    const div = document.createElement('div');
    div.className = 'article-item';
    div.innerHTML = `
      <div class="article-num">Art. ${art.num}</div>
      <div class="article-body">
        <div class="article-title">${art.titulo}</div>
        <div class="article-text">${art.texto}</div>
        <div class="article-pena">${art.pena}</div>
      </div>`;
    frag.appendChild(div);
  });
  container.appendChild(frag);
}

function generateRandomArticle() {
  if (!legalCode) legalCode = LEGAL.generarCodigo();
  const pcg = new PCG(Date.now());
  const art = legalCode[pcg.int(legalCode.length)];
  renderLegal([art]);
  document.getElementById('legalCount').textContent = `Artículo ${art.num} de 1310`;
}

function filterLegal() {
  if (!legalCode) legalCode = LEGAL.generarCodigo();
  const delito = document.getElementById('delitoFilter').value;
  const filtered = delito === '' ? legalCode : legalCode.filter((_, i) => Math.floor(i / 262) === parseInt(delito));
  renderLegal(filtered);
  document.getElementById('legalCount').textContent = `${filtered.length} artículos`;
}

// Architecture
const ARCH_MODULES = [
  { name: "PCG-XSH-RR 64/32", desc: "Generador de números pseudoaleatorios de alta calidad. Reemplaza el Mersenne Twister. Soporta saltos deterministas y distribuciones uniformes.", tech: "PCG — O'Neill, 2014 · SharedArrayBuffer ready", status: "ACTIVO" },
  { name: "E-Graph Rewriter", desc: "Motor de reescritura con 131 reglas de transformación que capturan las gramáticas de cada tradición filosófica.", tech: "Equality Saturation · Rewrite Rules · A* Extraction", status: "ACTIVO" },
  { name: "Agentes Conceptuales", desc: "5 agentes con vectores de personalidad en 5 dimensiones. Matriz de relaciones actualizable. Memoria de sesión persistente.", tech: "Agent Simulation · Personality Vectors · Emergent Dialogue", status: "ACTIVO" },
  { name: "Generación Dirigida", desc: "Sliders de tradición, tono, longitud y temperatura. El PCG optimiza la selección según el vector objetivo del usuario.", tech: "Parametric Generation · PCG + E-Graph Pipeline", status: "ACTIVO" },
  { name: "Codex Poenalis", desc: "1310 artículos generados combinatoriamente. 5 delitos × 3 grados × 5 penas × contexto. El Lexicón legisla.", tech: "Combinatorial Generation · 5×3×5×5 = 375 base → 1310", status: "ACTIVO" },
  { name: "Métricas de Calidad", desc: "Coherencia estructural, novedad por hash sintáctico, conformidad con normas de longitud. Panel transparente.", tech: "Cosine Similarity approx. · Structural Hashing · Quality Score", status: "ACTIVO" },
  { name: "Módulo Diálogo", desc: "Chat con agentes que responden con sentencias generadas adaptadas al contexto del usuario. Detección de conceptos filosóficos.", tech: "Context-Aware Generation · Agent Memory · NL Pattern Match", status: "ACTIVO" },
  { name: "IndexedDB Persistence", desc: "El estado de los agentes, sus memorias y la matriz de relaciones sobreviven entre sesiones. El Lexicón recuerda.", tech: "IndexedDB v2 · Async/Await · Auto-save on generation", status: "ACTIVO" },
  { name: "Generación Híbrida", desc: "Fusión de dos tradiciones mediante combinación de vectores de personalidad y reescritura cruzada.", tech: "Vector Interpolation · Cross-tradition E-Graph Rules", status: "ACTIVO" },
  { name: "Corpus Determinista", desc: "666.626 sentencias paginadas, buscables y filtrables. Generación determinista por índice con PCG como motor.", tech: "Deterministic PCG Indexing · Pagination · Full-text Search", status: "ACTIVO" },
];

function renderArchitecture() {
  const grid = document.getElementById('archGrid');
  grid.innerHTML = '';
  ARCH_MODULES.forEach(m => {
    const div = document.createElement('div');
    div.className = 'arch-module';
    div.innerHTML = `
      <span class="arch-status">${m.status}</span>
      <h4>${m.name}</h4>
      <div class="arch-desc">${m.desc}</div>
      <div class="arch-tech">Base técnica: ${m.tech}</div>`;
    grid.appendChild(div);
  });
  // System stats
  document.getElementById('sysStats').innerHTML = `
    <div>Módulos activos: <span style="color:var(--matrix)">${ARCH_MODULES.length} / ${ARCH_MODULES.length}</span></div>
    <div>Reglas E-Graph: <span style="color:var(--matrix)">${EGRAPH.reglas.length} (de 131 totales)</span></div>
    <div>Sentencias únicas vistas: <span style="color:var(--matrix)">${sentenceHashes.size}</span></div>
    <div>Interacciones entre agentes: <span style="color:var(--matrix)">${interactionCount}</span></div>
    <div>Corpus base: <span style="color:var(--matrix)">${TOTAL.toLocaleString('es-ES')} entradas deterministas</span></div>
    <div>Capacidad generativa: <span style="color:var(--matrix)">∞ sentencias (PCG + E-Graph)</span></div>
    <div>Motor RNG: <span style="color:var(--matrix)">PCG-XSH-RR 64/32 — O'Neill, 2014</span></div>
    <div>Artículos del Codex: <span style="color:var(--matrix)">1310 (generados bajo demanda)</span></div>
  `;
}

// ══════════════════════════════════════════════════════════════════
// INICIALIZACIÓN
// ══════════════════════════════════════════════════════════════════
async function init() {
  // Init IndexedDB
  try {
    await DB.init();
    const sess = await DB.loadState();
    const visits = (sess ? sess.count : 0) + 1;
    document.getElementById('persistDot').classList.remove('offline');
    document.getElementById('persistInfo').textContent = 'IndexedDB: activo — estado de agentes cargado';
    document.getElementById('sessionInfo').textContent = `Sesión #${visits} · ${new Date().toLocaleDateString('es-ES')}`;
  } catch(e) {
    document.getElementById('persistDot').classList.add('offline');
    document.getElementById('persistInfo').textContent = 'IndexedDB: no disponible (sesión efímera)';
  }
  // Render corpus
  renderPage(1);
  // Auto-save every 30 seconds
  setInterval(() => DB.saveState(), 30000);
}

init();
</script>
</body>
</html>
